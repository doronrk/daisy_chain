var PCM=PCM||{};PCM.typeAhead=(function(j){var webAppPrefix="";var typeAhead;var highlight;var results=null;var jWindow;var currentIndex=null;var disableHover=null;var hideTimeout=null;var KEY_ARROW_UP=38;var KEY_ARROW_DOWN=40;var KEY_ARROW_LEFT=37;var KEY_ARROW_RIGHT=39;var KEY_ENTER=13;var KEY_ESCAPE=27;var ARROW_EASING="easeInOutQuart";var ARROW_SPEED=150;var SCROLL_SPEED=1000;var SCROLL_EASING="easeInOutQuart";var lastAjaxCall=null;var typeaheadDelayTimeout=null;var highlightedElement=null;var noImageUrl="/mall/widgetti/images/shared/noImage.gif";var typeaheadFocused=false;var queryDelay=10;var SCREEN_ADJUST_MULTIPLY=3;var HIDE_TIMEOUT_SPEED=200;var _opTypeAheadSearch="pcm.web.common.textBoxSearchTypeahead.typeAheadSearch";var searchInput;var keywordCount;var _pcmSearch={};var categoryFlag="cn";jQuery.fn.exists=function(){return this.length>0};var _initEvents=function(){var checkFocus=function(){if(!typeaheadFocused){_hideTypeAheadNoDelay()}};searchInput.blur(function(){setTimeout(function(){checkFocus()},300)});searchInput.focus(function(){var check=jQuery("#searchTextInput").val();if(check!==""){typeAhead.show()}});searchInput.keyup(function(e){_inputCustomTrim();if(e.which===KEY_ARROW_UP){_keyArrowUp()}else{if(e.which===KEY_ARROW_DOWN){if(typeAhead.is(":empty")){_abortGenerateTypeaheadContents();_generateTypeAheadContents()}else{if(results!=null){_keyArrowDown()}}}else{if(e.which===KEY_ENTER){_keyEnterResults()}else{if(e.which===KEY_ARROW_LEFT||e.which===KEY_ARROW_RIGHT){}else{if(e.which===KEY_ESCAPE){_hideTypeAhead()}else{_abortGenerateTypeaheadContents();typeaheadDelayTimeout=setTimeout(function(){_generateTypeAheadContents()},queryDelay)}}}}}});jQuery(".searchInput_autocomplete").bind("click",_goSearchFromHeader);jQuery(".searchInput_autocomplete").bind("keypress",_searchPressEnter);jQuery(".wSearch_btn").bind("click",_goSearchFromHeader)};var _inputCustomTrim=function(){var origVal=jQuery("#searchTextInput").val();var updatedText=origVal;updatedText=updatedText.replace(/^\s*/,"");updatedText=updatedText.replace(/\s+$/," ");if(origVal!==updatedText){jQuery("#searchTextInput").val(updatedText)}};var _trim=function(inText){inText=inText.replace(/^\s*/,"");inText=inText.replace(/\s*$/,"");return inText};var _abortGenerateTypeaheadContents=function(){if(lastAjaxCall){lastAjaxCall.abort();lastAjaxCall=null}if(typeaheadDelayTimeout){clearTimeout(typeaheadDelayTimeout)}};var _generateTypeAheadContents=function(data){if(searchInput.val().length==0){_hideTypeAhead();return}highlightedElement=null;var qSearch=searchInput.val();lastAjaxCall=j.ajax({dataType:"json",data:{op:_opTypeAheadSearch,q:qSearch,keywordCount:keywordCount},url:window.location.pathname,type:"POST",cache:false,success:function(data){console.log("ajax call successful.");if(data&&data.resultCount>0&&_trim(data.query)===_trim(qSearch)){var suggestions=data.suggestions;typeAhead.empty();typeAhead.append('<div class="highlight"></div>');typeAhead.append('<h3 class="first">Matching Keywords</h3>');typeAhead.append(_getKeywordContent(suggestions));typeAhead.append("<h3>Matching Brands</h3>");typeAhead.append(_getBrandContent(suggestions));typeAhead.append(_getSuggestionContent(suggestions));results=typeAhead.find("li > a");results.mouseenter(function(){_hoverResults(j(this))});highlight=typeAhead.find(".highlight");typeAhead.focusin(function(){typeaheadFocused=true});typeAhead.focusout(function(){typeaheadFocused=false});typeaheadDelayTimeout=null;_showTypeAhead()}else{console.log("empty result");_hideTypeAhead();console.log("empty result")}},error:function(jqXHR,textStatus,errorThrown){console.log(errorThrown)}})};var _getKeywordContent=function(suggestions){var html='<ul class="first-lvl">';var baseUrl=webAppPrefix+"/s?rch";baseUrl+="&removedLicenseFilter=false";baseUrl+="&includeLicenseFilter=true";baseUrl+="&includeImage=true";baseUrl+="&ssrc=box";baseUrl+="&q=";for(var i=0;i<suggestions.length;i++){var suggestion=suggestions[i];var encKeyword=encodeURIComponent(suggestion.keyword);html+="<li>";html+='    <a href="'+baseUrl+encKeyword+'">';html+='        <span class="txt">'+suggestion.keyword+"</span>";html+='        <span class="count">('+suggestion.count+")</span>";html+="    </a>";if(i==0&&suggestion.categories){var elements=suggestion.categories;html+='<ul class="second-lvl">';for(var k=0;k<elements.length;k++){var element=elements[k];var encElem=encodeURIComponent(element);html+="<li>";html+='    <a href="'+baseUrl+encKeyword+"&"+categoryFlag+"="+encElem+'">in&nbsp;';html+='        <span class="categories">'+element+"</span>";html+='        <span class="txt" style="display:none;">'+suggestion.keyword+"</span>";html+="    </a>";html+="</li>"}html+="</ul>"}html+="</li>"}html+="</ul>";return html};var _getBrandContent=function(suggestions){var html="";var firstSuggestion=suggestions[0];var baseUrl=webAppPrefix+"/s?rch";baseUrl+="&removedLicenseFilter=false";baseUrl+="&includeLicenseFilter=true";baseUrl+="&includeImage=true";baseUrl+="&ssrc=box";baseUrl+="&q=";if(firstSuggestion&&firstSuggestion.brands){var encKeyword=encodeURIComponent(firstSuggestion.keyword);html+='<ul class="second-lvl">';var elements=firstSuggestion.brands;for(var k=0;k<elements.length;k++){var element=elements[k];var encElem=encodeURIComponent(element);html+="<li>";html+='    <a href="'+baseUrl+encKeyword+"&man="+encElem+'">by&nbsp;';html+='        <span class="brands">'+element+"</span>";html+='        <span class="txt" style="display:none;">'+firstSuggestion.keyword+"</span>";html+="    </a>";html+="</li>"}html+="</ul>"}return html};var _getSuggestionContent=function(suggestions){var html="";var suggestion=suggestions[0];var elements=suggestion.products;var baseUrl=webAppPrefix+"/p/";html+="<h3>Suggestions for "+suggestion.keyword+"</h3>";html+='<ul class="suggest">';for(var k=0;k<elements.length;k++){var element=elements[k];var encElem=encodeURIComponent(element);html+="<li>";html+='    <a href="'+baseUrl+element.edp+'" title="'+element.name+'">';html+='        <span class="tbl">';html+='            <span class="tr">';html+='                <span class="td col-img"><img src="'+(element.imagePath==null?noImageUrl:element.imagePath)+'" width="67"></span>';html+='                <span class="td col-desc">';html+='                    <span class="offer">'+element.manufacturer+"</span>";html+='                    <span class="prod-title">'+element.name+'</span><span class="products" style="display:none;">'+element.edp+"</span>";html+="                </span>";html+="            </span>";html+-"        </span>";html+="    </a>";html+="</li>"}return html};var _setupStyle=function(){typeAhead.css({width:searchInput.outerWidth()+"px",top:searchInput.outerHeight()+"px"});searchInput=searchInput.find("input")};var _showTypeAhead=function(){typeAhead.show()};var _hideTypeAhead=function(){clearInterval(hideTimeout);hideTimeout=setTimeout(function(){typeAhead.hide()},HIDE_TIMEOUT_SPEED);typeAhead.hide()};var _hideTypeAheadNoDelay=function(){typeAhead.hide()};var _clearTypeAheadData=function(){results=null;currentIndex=null;typeAhead.empty()};var _animateHighlight=function(base,updateTextbox){highlight.stop().show();results.find(".prod-title").css({color:"#000"});if(typeof base.parent().parent().attr("class")!=="undefined"&&base.parent().parent().attr("class").indexOf("suggest")!==-1){highlight.hide();base.find(".prod-title").css({color:"#08c"})}else{highlight.velocity({height:base.outerHeight()+"px",width:"100%",top:base.position().top+"px"},ARROW_SPEED,ARROW_EASING)}if(updateTextbox){searchInput.val(base.find(".txt").text())}highlightedElement=base};var _adjustScreenView=function(base){if(typeAhead.outerHeight()>jWindow.height()){results.unbind();base.velocity("scroll",{duration:SCROLL_SPEED,easing:SCROLL_EASING,offset:-base.outerHeight()});clearTimeout(disableHover);disableHover=setTimeout(function(){results.mouseenter(function(){_hoverResults(j(this))})},SCROLL_SPEED)}};var _keyArrowUp=function(){if(currentIndex!==null){currentIndex--;if(currentIndex<0){currentIndex=results.length-1}}else{currentIndex=results.length-1}_animateHighlight(results.eq(currentIndex));_adjustScreenView(results.eq(currentIndex))};var _keyArrowDown=function(){if(currentIndex!==null){currentIndex++;if(currentIndex>=results.length){currentIndex=0}}else{currentIndex=0}_animateHighlight(results.eq(currentIndex));_adjustScreenView(results.eq(currentIndex))};var _keyEnterResults=function(){if(highlightedElement){document.location=jQuery(highlightedElement).attr("href")}else{_goSearchFromHeader(true)}_hideTypeAhead();searchInput.focus()};var _setFilters=function(highlightedElement){_clearSearchFilters();if(highlightedElement.find(".categories").exists()){_pcmSearch.setStn(highlightedElement.find(".categories").text())}else{if(highlightedElement.find(".brands").exists()){_pcmSearch.setMan(highlightedElement.find(".brands").text())}else{if(highlightedElement.find(".products").exists()){_pcmSearch.setDpNo(highlightedElement.find(".products").text())}}}};var _clearSearchFilters=function(){_pcmSearch.resetSrch();_pcmSearch.clearFilters();_pcmSearch.clearSearchFilters()};var _hoverResults=function(base,updateTextbox){_animateHighlight(base,updateTextbox);for(var i=0;i<results.length;i++){if(base.text()===results.eq(i).text()){currentIndex=i;break}}};var _goSearchFromHeader=function(inValue){_pcmSearch.goSearchFromHeader(inValue)};var _searchPressEnter=function(){_pcmSearch.searchPressEnter()};var _init=function(inWebAppPrefix,inSearchInput,typeaheadDiv,inKeywordCount,isIms,delay){webAppPrefix=inWebAppPrefix;searchInput=inSearchInput;typeAhead=typeaheadDiv;highlight=typeAhead.find(".highlight");jWindow=j(window);noImageUrl=webAppPrefix+noImageUrl;queryDelay=delay||10;keywordCount=inKeywordCount;_setupStyle();_initEvents();if(isIms===false){categoryFlag="stn"}};return{pcmSearch:_pcmSearch,init:_init}})(jQuery);