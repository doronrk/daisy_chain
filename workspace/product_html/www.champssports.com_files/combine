rbAdd("wishList.loggedin.message.friendReceiveEmailTitle", "Email Sent!"); rbAdd("cart.miniCart.message.itemCouldNotBeAddedToCart", "Item could not be added to cart:"); rbAdd("wishList.loggedin.label.recipientsEmail", "Recipient\'s Email"); rbAdd("cart.button.closeBtn", "Close"); rbAdd("cart.errorText.cartError", "<strong>Cart Error...</strong>"); rbAdd("wishList.shareWishList.button.close", "x close"); rbAdd("cart.errorText.outOfStockMessage", "We\'re sorry, but this item is currently out of stock and no longer available."); rbAdd("wishList.loggedin.label.recipientsName", "Recipient\'s Name"); rbAdd("wishList.loggedin.message.friendReceiveEmail", "Your friend will receive the email shortly."); // JavaScript Document

function wl_closenTarget(url) {
	window.parent.location.href= url;
	close_wl_dialog();
}

function addToWishlist(wlButtonMode) {

	var thisObj = $("#addToWishlist");
	
	if(wlButtonMode == 'skateboard') {
			if (doCoreMetrix)
			{
				cmCreateConversionEventTag('Skate Board', 1, 'Add to Wish List - SKB', 0);
				createCookie('AddToWishList', 'Skate Board|Add to Wish List - SKB' );
			}
			openWishListDialogForm(document.getElementById("skb_form"));
	} else {
		showBubble(thisObj);
		var errMsg = validateProduct();
		if (errMsg == "") {
			form_name = document.product_form;
			// alert(doCoreMetrix);
			if (doCoreMetrix)
			{
				cmCreateConversionEventTag(eval(form_name).sku.value, 1, eval(form_name).coreMetricsCategory.value, 0);
				createCookie('AddToWishList', eval(form_name).sku.value + '|'  + eval(form_name).coreMetricsCategory.value );
			}
			openWishListDialogForm(document.product_form);

			if(isTouchDevice()){
				$(document).bind("click touchend",close_wl_dialog);
			}
		}
	}

}

function QVaddToWishlist() {
	var errMsg = "";
	if (errMsg == "" && $("#ws_login_container").length == 0) {
		openQVWishListDialogForm();
	}
}
// used for PDP and skate board builder
function openWishListDialogForm(sourceForm) {
	var arguments = getFormValues(sourceForm);
	openWishListDialogForm_common(arguments);
}
// for quick view add to wish list
function openQVWishListDialogForm() {
	var arguments = $("#quickview_product_form").serialize();
	$("#quickview").bind("click touchend",close_wl_dialog);
	if (doCoreMetrix)
	{
		cmCreateConversionEventTag($("#quickview_product_form input[name='sku']").val(), 1, $("#quickview_product_form input[name='coreMetricsCategory']").val(), 0);
		createCookie('AddToWishList', $("#quickview_product_form input[name='sku']").val() + '|'  + $("#quickview_product_form input[name='coreMetricsCategory']").val() );
	}
	openWishListDialogForm_common(arguments);
}
// for move to wishlist from shopping cart.
function openCartWishListDialogForm(cartline_id) {
	var form_name = "document.shopping_cart_" + cartline_id;
	var arguments = getFormValues(eval(form_name));
	//alert(arguments);
	if (doCoreMetrix)
	{
		cmCreateConversionEventTag(eval(form_name).sku.value, 1, eval(form_name).coreMetricsCategory.value, 0);
		createCookie('AddToWishList', eval(form_name).sku.value + '|'  + eval(form_name).coreMetricsCategory.value );
	}
	// need different cart id than common open dialog
	var html = '<div id="ws_login_container"></div>';
	var html_shadow = '<div id="ws_login_container_shadow"><div><div></div></div></div>';
	
	$("body").prepend(html);
	$("body").prepend(html_shadow);
	
	target = $("#cart_addToWishlist_" + cartline_id + " a");
	var targetOffset = target.offset();
	var button_width = target.width();
	var button_height = target.height();
	
	var width = $("#ws_login_container").width();
	var height = $("#ws_login_container").height();
	
	var left = targetOffset.left;
	left -= (width - button_width) / 2;
	var top = targetOffset.top; 
	top -= height + 10;

	$("#ws_login_container").css({left: left, top: top});
	$("#ws_login_container_shadow").css({left: left + 6, top: top + 6, opacity: 0.5});
	$("#ws_login_container").load(loginTemplatePath + "?" + arguments, {secured: secured_dialog});
	
	$('#ws_login_container').click(function(e) {
		e.stopPropagation();
	});
	$(document).click(close_wl_dialog);	
	
}
// for PDP and skateboard and quickview -- add to wishlist
function openWishListDialogForm_common(arguments) {
	var html = '<div id="ws_login_container"></div>';
	var html_shadow = '<div id="ws_login_container_shadow"><div><div></div></div></div>';
	
	$("body").prepend(html);
	$("body").prepend(html_shadow);
	
	var targetOffset = $("#addToWishlist").offset();
	var button_width = $("#addToWishlist").width();
	var button_height = $("#addToWishlist").height();
	
	var width = $("#ws_login_container").width();
	var height = $("#ws_login_container").height();
	
	var left = targetOffset.left;
	left -= (width - button_width) / 2;
	var top = targetOffset.top;
	top -= height + 10;
	
	$("#ws_login_container").css({left: left, top: top});
	$("#ws_login_container_shadow").css({left: left + 6, top: top + 6, opacity: 0.5});
	if (typeof(bv_RR_enabled) != "undefined" && (bv_RR_enabled == true || bv_RR_enabled == false))
		arguments = arguments + "&bv_RR_enabled=" + bv_RR_enabled;
	if (typeof(bv_AA_enabled) != "undefined" && (bv_AA_enabled == true || bv_AA_enabled == false))
		arguments = arguments + "&bv_AA_enabled=" + bv_AA_enabled;
	if (typeof(bv_JS_enabled) != "undefined" && (bv_JS_enabled == true || bv_JS_enabled == false))
		arguments = arguments + "&bv_JS_enabled=" + bv_JS_enabled;
		
	$("#ws_login_container").load(loginTemplatePath + "?" + arguments, {secured: secured_dialog});
	
	$('#ws_login_container').click(function(e) {
		e.stopPropagation();
	});
	$(document).click(close_wl_dialog);	
}

// submit sign up for registration form from dialog
function toRegistration() {
	
	document.gotoRegistration.submit();
}


function close_wl_dialog() {
	if (window.parent == null) {
		$("#ws_login_container_shadow").remove();		
		$("#ws_login_container").remove();
	}
	else {
		window.parent.$("#ws_login_container_shadow").remove();		
		window.parent.$("#ws_login_container").remove();
	}
}
	
function resizeDialogBox(width, height) {
	$(document).ready(function() {

		var x = ($("#wl_iframe_id").width() - width) / 2;
		var y = $("#wl_iframe_id").height() - height;
		
		x = "+=" + x + "px";
		y = "+=" + y + "px";

		$("#ws_login_container_shadow").css({left: x, width: width, top: y, height: height});
		$("#ws_login_container_shadow div").css({width: width - 2, height: height - 2});
		$("#ws_login_container_shadow div div").css({width: width - 4, height: height - 4});		
		$("#ws_login_container").css({left: x, width: width, top: y, height: height});
		$("#wl_iframe_id").css({width: width, height: height});

		if ($("#ws_login_container").offset().left < 0) {
			$("#ws_login_container").css("left", "5px");
			$("#ws_login_container_shadow").css("left", "3px");
		}

		setTimeout("focusInput()", 300);
	});
}

function focusInput() {
	

	$("form input[type='text']:first",  "#wl_iframe_id").focus();
}

function conversionEventTagForIFrame (theEvent, stage, category) {
	cmCreateConversionEventTag(theEvent, stage, category, 0);	
}

function createCookieforIFrame (cookieName, cookieValue){
	createCookie(cookieName, cookieValue);
}

function eraseCookieForIFrame(cookieName) {
	eraseCookie(cookieName); 
}

// for move to wishlist from catalog quick order.
function openCatalogQuickOrderWishListDialogForm(index) {
	var arguments = "";
	var sku = "#sku_" + index;
	var size = "#size_" +index;
	var custprod_cd = "#custprod_cd_" + index;
	var qty = "#qty_" + index;
	var price = "#price_" + index;
	var tid = "#TID";
	var coreMetricsDo = "#coreMetricsDo";
	var coreMetricsCategory = "#coreMetricsCategory";
	var skuVal = $.trim($(sku).val());
	var sizeVal = escape($.trim($(size).val()));
	var custprod_cdVal = $.trim($(custprod_cd).val());
	var qtyVal = $.trim($(qty).val());
	var tidVal = $.trim($(tid).val());
	var priceVal = $.trim($(price).val());
	var doCMVal = $.trim($(coreMetricsDo).val());
	var cm_CategoryVal = $.trim($(coreMetricsCategory).val());
	var err = "";
	
	
	$(size).css("background-color", "white");
	$(qty).css("background-color", "white");
	if (sizeVal == -1) {
		err = err + "Select a size for product " + $.trim($(sku).val()) + "\n";
		$(size).css("background-color", "#FFCCCC");
	}
	if (qtyVal <= 0 || qtyVal == "" || qtyVal > 255) {
		err = err + "Enter valid quantity from 1 to 255 for product " + $.trim($(sku).val()) + "\n";
		$(qty).css("background-color", "#FFCCCC");
	}
	else if (isNaN(qtyVal)) {
		err = err + "Enter valid quantity for product " + $.trim($(sku).val()) + "\n";
		$(qty).css("background-color", "#FFCCCC");
	}
	
	if (err != "") {
		alert(err);
	}
	else {
		if (sizeVal == -1 || sizeVal == 0) {
			sizeVal = "";
		}
		arguments = "catalogquickorder=true&index=" + index + "&sku=" + skuVal + "&size=" + sizeVal + "&custprod_cd=" + custprod_cdVal + "&qty=" + qtyVal + "&TID=" + tidVal + "&price=" + priceVal + "&coreMetricsDo=" + doCMVal + "&coreMetricsCategory=" + escape(cm_CategoryVal);

		if (doCoreMetrix)
		{
			cmCreateConversionEventTag(skuVal, 1, cm_CategoryVal, 0);
			createCookie('AddToWishList', skuVal + '|'  + cm_CategoryVal );
		}
		
		// need different cart id than common open dialog
		var html = '<div id="ws_login_container"></div>';
		var html_shadow = '<div id="ws_login_container_shadow"><div><div></div></div></div>';
		
		$("body").prepend(html);
		$("body").prepend(html_shadow);
		
		target = $("#quickorder_wishlist_" + index + " a");
		var targetOffset = target.offset();
		var button_width = target.width();
		var button_height = target.height();
		
		var width = $("#ws_login_container").width();
		var height = $("#ws_login_container").height();
		
		var left = targetOffset.left;
		//left -= (width - button_width) / 2;
		var top = targetOffset.top; 
		//top -= height + 10;
	
		left += 120;
		top -=130;
		
		$("#ws_login_container").css({left: left, top: top});
		$("#ws_login_container_shadow").css({left: left + 6, top: top + 6, opacity: 0.5});
		$("#ws_login_container").load(loginTemplatePath + "?" + arguments, {secured: secured_dialog});
	}
		
	$('#ws_login_container').click(function(e) {
		e.stopPropagation();
	});
	$(document).click(close_wl_dialog);	
}

function close_wl_dialog_add_success(index, type) {
	//var lineitem = "#lineitem_" + index;
	//var quickorder_item = "#quickorder_item" + index;
	//$(lineitem).remove();
	//$(quickorder_item).val("");
	rearrangeitem(index, type);
	close_wl_dialog();
}
var global_moreYmalWidth = 600;
var miniAddToCart = function() {
	function attachMiniCartYMAL() {
		//$("#miniAddToCart_ymal").html('<p>Other shoppers also like these items:</p><table><tr></tr></table>');

		if(typeof(useMyBuyYMALS) != "undefined" && !MyBuysDisabledForHL) {
			if(useMyBuyYMALS) {   // if mybuys enabled
				$("#miniAddToCart_ymal").append("<iframe src='" + miniCartYmalsTemplate + "?secure=" + (location.protocol === 'https:') + "' id='miniCartYmals' scrolling='auto' marginwidth='0' marginheight='0' frameborder=0' style='border: medium none; overflow: hidden; width: 360px; height:301px' ></iframe>");
				//$("#miniAddToCart_ymal").append("<div id='more_ymal_minicartContainer'><img id='more_ymal_minicart' src='" + moreYmalsImage + "' /></div>");
				//$("#more_ymal_minicart").click(miniAddToCart.openAdditionalYMALs);
			} else {
				$("#miniAddToCart_ymal").append("<div id='legacyMiniCartYmalContainer'></div>");
				$("#legacyMiniCartYmalContainer").load(miniCartLegacyYMALTemplate +  "?secure=" + (location.protocol === 'https:') + "&sku=" + escape($("#minicart_addedSku").text()));

				
			}
		}
	}
	
	return {
		/*autoResizeYmals: function() {
			//alert( $("#miniCartYmals").contents().find("#mybuyspagezone1 table").height());
			winHeight = $("#miniCartYmals").contents().find("#mybuyspagezone1 table").height();
			$("#miniCartYmals").height(winHeight + 35);
			//		e.height = e.contentWindow.document.body.scrollHeight;

		
		,}*/
		openMiniAddToCart: function(formID, callback, secure) {
			miniAddToCart.closeMiniAddToCart();
			var IlatcField = '<input type="Hidden" name="inlineAddToCart" value="1">';
			$('#' + formID).append(IlatcField);
			var formData = $('#' + formID).serialize();
			
			
			appendURL = $("#rawURL").text().split("?",2)[1];
			if( typeof(appendURL) == "undefined") {
				appendURL = "";
			}
			
			if( typeof(orderSummaryTarget) == "undefined") {
				orderSummaryTarget = "#order_summary_content";
			}
			
			var current_order_summary = $(orderSummaryTarget).html();
			$(orderSummaryTarget).html("<strong>Adding item...</strong>");
			disableToCartButton();
			$.ajax({
				url: "/catalog/miniAddToCart.cfm?secure=" +  (location.protocol == 'https:' ? 1:0) + "&" + appendURL,
				type: "POST",
				data: formData,
				success: function(data, textStatus) {
					
					$("input[name='inlineAddToCart']").remove();	
					$("#pdpAddToCart_overlayBG").hide();
					$("#pdpAddToCartWrapper").hide();	
				
					revertOrderTotal=false;
					$('body').animate({scrollTop:0},"fast", "linear", function () {
						$("body").prepend('<div id="miniAddToCartWrapper"><div id="miniAddToCartWin"></div></div>');
						scroll(0,0);
						var miniAddToCartTargetObj = null;
						if (typeof(miniAddToCartTarget) == "undefined") {
							miniAddToCartTargetObj = $("#order_summary").parent();
						} else {
							miniAddToCartTargetObj = $(miniAddToCartTarget);
						}
	
						var XOffset = 0;
						if (typeof(miniAddToCartXOffset) != "undefined") {
							XOffset = miniAddToCartXOffset;
						}
						var offset = miniAddToCartTargetObj.offset();
						var target_width = miniAddToCartTargetObj.width();
						var target_height = miniAddToCartTargetObj.height();
						var miniAddToCart_width = $("#miniAddToCartWrapper").width() + 10;
						var left = offset.left + target_width - miniAddToCart_width + XOffset;
						var top = offset.top + target_height;
						$("#miniAddToCartWrapper").css({left: left, top: top});
						$("#miniAddToCartWin").css({top: "-400px"});
						$("#miniAddToCartWin").html(data);
						attachMiniCartYMAL();
						if (revertOrderTotal) {
							$(orderSummaryTarget).html(current_order_summary);
						}
						$("#miniAddToCartWin").animate({top: "-1px"}, 1000);
						$('#miniAddToCart').click(function(e) {
							e.stopPropagation();
						});
						$('#btnRemoveMaskPrice').click(function(e) {
							e.stopPropagation();
						});
						$('#inLineCartAdd .shipping_restriction_message a').click(function(e) {
							e.stopPropagation();
						});

						if(isTouchDevice()){
							$(document).bind("click touchend",miniAddToCart.closeMiniAddToCart);
						}
						
						if (typeof BORISEnabled != 'undefined' && BORISEnabled) {
							if ($('#pdp_storeNumber').length != 0) {
								$('#pdp_storeNumber').val(0);
								$('#pdp_fulfillmentType').val('SHIP_TO_HOME');
								$('#pdp_storeCostOfGoods').val(0);
							} else if ($('#qv_storeNumber').length != 0) {
								$('#qv_storeNumber').val(0);
								$('#qv_fulfillmentType').val('SHIP_TO_HOME');
								$('#qv_storeCostOfGoods').val(0);
							}
						}
						
						$(document).click(miniAddToCart.closeMiniAddToCart);
		
						if (typeof(callback) != "undefined")
							callback();
						//clearTimeout(showProcessingMessageTimer);
						setTimeout("enableToCartButton()", 1010);
					});
				
				},
				error: function(jqXHR, exception) {
				
					$('body').animate({scrollTop:0},"fast", "linear", function () {
						$("body").prepend('<div id="miniAddToCartWrapper"><div id="miniAddToCartWin"></div></div>');
						scroll(0,0);
						var miniAddToCartTargetObj = null;
						if (typeof(miniAddToCartTarget) == "undefined") {
							miniAddToCartTargetObj = $("#order_summary").parent();
						} else {
							miniAddToCartTargetObj = $(miniAddToCartTarget);
						}
						var XOffset = 0;
						if (typeof(miniAddToCartXOffset) != "undefined") {
							XOffset = miniAddToCartXOffset;
						}
						var offset = miniAddToCartTargetObj.offset();
						var target_width = miniAddToCartTargetObj.width();
						var target_height = miniAddToCartTargetObj.height();
						var miniAddToCart_width = $("#miniAddToCartWrapper").width() + 10;
						var left = offset.left + target_width - miniAddToCart_width + XOffset;
						var top = offset.top + target_height;
						$("#miniAddToCartWrapper").css({left: left, top: top});
						$("#miniAddToCartWin").css({top: "-400px"});
	
						$("#miniAddToCartWin").html("<div id=\"inLineCartAdd\"><div id=\"miniAddToCart_header\">" + RBM.cart.miniCart.message.itemCouldNotBeAddedToCart + "<a id=\"miniAddToCart_close\" href=\"javascript:miniAddToCart.closeMiniAddToCart({cmConversionEvent: \'Close Mini-Cart\'})\">" + RBM.cart.button.closeBtn + " <span class=\"x\">X</span></a></div><ul id=\"miniAddToCart_error\"><li><span class=\"error\">" + RBM.cart.errorText.outOfStockMessage + "</span></li></ul></div>");
						$(orderSummaryTarget).html(RBM.cart.errorText.cartError);
						
						$("#pdpAddToCart_overlayBG").hide();
						$("#pdpAddToCartWrapper").hide();
						$("#miniAddToCartWin").animate({top: "-1px"}, 1000);
									
						$('#miniAddToCart').click(function(e) {
							e.stopPropagation();
						});
						$(document).click(miniAddToCart.closeMiniAddToCart);
						
						if (typeof(callback) != "undefined")
							callback();
							
						//clearTimeout(showProcessingMessageTimer);
						enableToCartButton();
					});
				}
			});
		},
		closeMiniAddToCart: function(data) {
			// coremetrics
			if(typeof(data) != 'undefined' && typeof(data.cmConversionEvent) != 'undefined') {
				if(data.cmConversionEvent != 'Close Mini-Cart' && data.cmConversionEvent != 'Continue Shopping-Top' 
					&& data.cmConversionEvent != 'View Full Cart Button' && data.cmConversionEvent != 'View Full Cart'){
					cmCreateConversionEventTag(data.cmConversionEvent, 1, 'Mini-Cart', 0);
				}
				if (data.cmConversionEvent == 'Checkout' || data.cmConversionEvent == 'View Full Cart') {
					registerConversionEvent('Mini-Cart', data.cmConversionEvent);
				} else {
					cmCreateConversionEventTag(data.cmConversionEvent, 2, 'Mini-Cart', 0);
				}
			}
			
			$("#miniAddToCartWin").animate({top: "-400px"}, function() {
				$("#miniAddToCartWrapper").remove();			
			});
			
			
		},
		openAdditionalYMALs: function() {
			miniAddToCart.closeMiniAddToCart();
			
			$("body").prepend('<div id="moreYmalWindowWrapper"><div id="moreYmalWindow_top"><div id="moreYmalWindow_topRight">Great Product Recommendations Just for You!</div></div><div id="moreYmalWindow_middle"><div id="moreYmalWindow_middleRight"><div id="moreYmalWindowLoading"></div><div id="moreYmalWindowContent"></div><div style="clear: both"></div></div></div><div id="moreYmalWindow_bottom"><div id="moreYmalWindow_bottomRight"><a href="javascript:miniAddToCart.closeAdditionalYmals();"><span class="red">x</span> Close</a></div></div></div>');
			//$("#moreYmalWindowLoading").css("display", "block");	
			//center
			//$(document).click(miniAddToCart.closeAdditionalYmals);
			var bodyWidth = $("body").width();
			var leftOffset = (bodyWidth - global_moreYmalWidth) / 2;
			var topOffset = getViewpointTop() + ((getViewpointHeight() - $("#moreYmalWindow").height()) / 2);		
			$("#moreYmalWindow").css({ left: leftOffset, top: topOffset, width: global_moreYmalWidth });	
			$("#moreYmalWindow").hide();
			$("#moreYmalWindowContent").append("<iframe src='" + moreYmalsTemplate + "?secure=" +  (location.protocol == 'https:' ? 1:0) + "' id='miniCartExtendedYmals' marginwidth='0' marginheight='0' frameborder=0' scrolling='no' style='margin-left:20px; border: medium none; overflow: hidden; height: 400px; width: 580px;'></iframe>");
    	    var winH = $(window).height();  
        	var winW = $(window).width();  
	        $('#moreYmalWindowWrapper').css('top',  Math.max(0,winH/2-$('#moreYmalWindowWrapper').height()/2));  
	        $('#moreYmalWindowWrapper').css('left', Math.max(0,winW/2-$('#moreYmalWindowWrapper').width()/2));  
			$("#moreYmalWindowContent").show();
	
		},
		closeAdditionalYmals: function() {
			$("#moreYmalWindowWrapper").remove();
		},
		removeMaskedItem: function(formID) {	
			
			cmCreateConversionEventTag('Remove From Cart', 2, 'Mini-Cart', 0);
			
			if( typeof(orderSummaryTarget) == "undefined") {
				orderSummaryTarget = "#order_summary_content";
			}
			
			var current_order_summary = $(orderSummaryTarget).html();
			$(orderSummaryTarget).html("<strong>Removing item...</strong>");
			var formData = $('#' + formID).serialize();
			var secure = typeof securedRequest != 'undefined' && securedRequest ? 1 : 0;

			$.ajax({
				url: "/catalog/miniRemoveFromCart.cfm?secure="+secure,
				type: "POST",
				data: formData,
				success: function(data, textStatus) {
					$('body').append(data);
					//alert(data);
					//miniAddToCart.closeMiniAddToCart({cmConversionEvent: 'Remove From Cart'});
				},
				error: function( XMLHttpRequest,textStatus,errorThrown) {
						console.log(XMLHttpRequest);
				}
			});
		}
		
	}
}();

miniCartLogging = function() {

	return {
		//Login status
		 UNREGISTERED: 1
		,REGISTERED_AUTHENTICATED: 2
		,REGISTERED_RECOGNIZED: 3
		,LOYALTY_AUTHENTICATED: 4
		,LOYALTY_RECOGNIZED: 5
			
		//Page Actions	
		,ADD_TO_CART: 1
		
		//Page Errors
		,OUT_OF_STOCK: 1
		,INVENTORY_CHECK: 2
		,QUEUED: 3
		
		,setLoginStatus: function(newStatus) {
			this.loginStatus = newStatus;
		}
		,setPageAction: function(newAction) {
			this.pageAction = newAction;
		}	
		,setPageError: function(newError) {
			this.pageError = newError;
		}	
		// does coremetrics log
		,doCMLog: function() {
			categoryID = "";
			pageName = "";
			switch(this.loginStatus) {
				case this.UNREGISTERED:
					categoryID += "Unreg";
					pageName += "Unreg";
				  break;
				case this.REGISTERED_AUTHENTICATED:
					categoryID += "Reg Auth";
					pageName += "Reg Auth";
				  break;
				case this.REGISTERED_RECOGNIZED:
					categoryID += "Reg Recg";
					pageName += "Reg Recg";
				  break;
				case this.LOYALTY_AUTHENTICATED:
					categoryID += "Loy Auth";
					pageName += "Loy Auth";
				  break;
				case this.LOYALTY_RECOGNIZED:
					categoryID += "Loy Recg";
					pageName += "Loy Recg";
				  break;
			}
			categoryID += " MiniCart";
			pageName += " MiniCart";			
			// errors override
			if(this.pageError != undefined) {
				switch(this.pageError) {
					case this.OUT_OF_STOCK:
						categoryID += " OOS";
						pageName += ": Error: Item Out Of Stock";
						break;
					case this.INVENTORY_CHECK:
						categoryID += " Er Inv API";
						pageName += ": Error: Inventory Check Required";
						break;
					case this.QUEUED:
						categoryID += " Ckout Queue";
						pageName += ": Checkout Queue";
						break;
				}
				
			} else {
				switch(this.pageAction) {
					case this.ADD_TO_CART:
						categoryID += " Add";
						pageName += " View: Add to MiniCart";
						break;
				}
			}
			cmCreatePageviewTag(pageName, categoryID, null, null);
		}
		
	}
}







// Global var hold value to help decide that the TAF pop-up is already open.
var popUpOpened = 0;

function tellafriend(model_nbr, sku) {
		// if only the pop-up isn't open.
		if (popUpOpened != 1)
		{
			closeTellafriend();
			
			// hide select tag on ie6 because they will appear above zoom layer
			//if ($.browser.msie && $.browser.version < 7) $("select").hide();
			
			var documentWidth = $(document).width();
			var documentHeight = $(document).height();
			$("body").prepend('<div id="overlayBG" ></div>');
			$("#overlayBG").css({opacity: 0.6, left:0, position: "absolute", "z-index": 998, width: documentWidth, height: documentHeight,"background-color": "black" });
			var tellafriend_box = '<div id="tellafriend_box"><div id="tellafriend_content"></div><div id="tellafriend_close"><a href="javascript:closeTellafriend()" title="Close">x close</a></div></div>';
			$("body").prepend(tellafriend_box);
			var link = $("#tellafriend_link");
			var linkOffset = link.offset();
			var offsetTop = linkOffset.top - 160;
			var offsetTop = getViewpointTop() + ((getViewpointHeight() - 495) / 2);	
			var bodyWidth = $("body").width();
			var leftOffset = (bodyWidth - 350) / 2;
			$("#tellafriend_box").css({ width: link.width(), height: link.height(), left: linkOffset.left, top: offsetTop});
			$("#tellafriend_content").addClass("loading");
			var selectedSku = $("#pdp_selectedSKU").val();
			// alert(postCardURL);
			$("#tellafriend_box").animate({height: 485, width: 650, left: leftOffset}
				, 	"slow"
				,	function () {
					$("#tellafriend_content").load(
						postCardURL,				//#AKAMAIZED_ROOT#/shared/tellafriend/
						{model_nbr: model_nbr, sku: selectedSku, microsite: microsite},
						function (responseText, textStatus, XMLHttpRequest) {
							//alert(model_nbr); alert(sku);
							
							$("#tellafriend_content").removeClass("loading");
							if (textStatus != "success") {
								alert("There was a problem while loading the form. Please try back later.");
							}
							else {
								
							}
						}
					)				
				}
			);
		}
		// We get here after the pop-up has been opened the first time.
		if (popUpOpened != 1)
		{	popUpOpened = 1; }
	}
	
	function closeTellafriend() {
		var link = $("#tellafriend_link");
		var linkOffset = link.offset();
		// reset this flag so that the pop-up can be opened again.
		popUpOpened = 0;
		
		$("#postcard").remove();
		$("#tellafriend_sent").remove();
		
		$("#tellafriend_box").animate({height: link.height(), width: link.width(), left: linkOffset.left, top: linkOffset.top}
			,	function () {
				if ($.browser.msie && $.browser.version < 7) $("select").show();
				$("#overlayBG").remove();
				$("#tellafriend_box").remove();			
			}
		);
	}	
	
	function sendTellafriend() {
		var errMsg = "";
		
		if ($.trim($("#tellafriend_fromName").val()) == "") {
			errMsg = errMsg + "- Please enter Sender's Name.\n";
		}
		if ($.trim($("#tellafriend_fromEmail").val()) == "") {
			errMsg = errMsg + "- Please enter Sender's Email.\n";
		}
		else if (validate_email($("#tellafriend_fromEmail").val()) == false) {
			errMsg = errMsg + "- Sender's Email is not of valid format.\n";
		}
		if ($.trim($("#tellafriend_toName").val()) == ""){
			errMsg = errMsg + "- Please enter Recipient's Name.\n";
		}	
		if ($.trim($("#tellafriend_toEmail").val()) == "") {
			errMsg = errMsg + "- Please enter your Recipient's email.\n";
		}
		else if (validate_email($("#tellafriend_toEmail").val()) == false) {
			errMsg = errMsg + "- Recipient's email is not of valid format.\n";
		}
		if ($.trim($("#tellafriend_msg").val()).length > 1000) {
			errMsg = errMsg + "- You have exceeded the maximum message length of 1000 characters.\n";
		}	
		if (errMsg != "") {
			alert(errMsg);
			return;
		}
		
		var arguments = new Object();
		
		arguments.tellafriend_fromName 	= $("#tellafriend_fromName").val();
		arguments.tellafriend_fromEmail = $("#tellafriend_fromEmail").val();
		arguments.tellafriend_toName 	= $("#tellafriend_toName").val();
		arguments.tellafriend_toEmail 	= $("#tellafriend_toEmail").val();
		arguments.sku 					= $("#sku").val();
		arguments.model_nbr 			= $("#model_nbr").val();
		// arguments.image_path            = $("#imagePath").val();
		arguments.nm_model				= $("#nm_model").val();
		arguments.tellafriend_msg 		= $("#tellafriend_msg").val();
		if (document.getElementById("formfield1234567891") != null)
			{ arguments.formfield1234567891 = $("#formfield1234567891").val(); }
		if (document.getElementById("formfield1234567892") != null)
			{ arguments.formfield1234567892 = $("#formfield1234567892").val();	} 
		if (document.getElementById("formfield1234567893") != null)
			{ arguments.formfield1234567893 = $("#formfield1234567893").val(); }
		if (document.getElementById("formfield1234567894") != null)
			{ arguments.formfield1234567894 = $("#formfield1234567894").val(); }	
		if (document.getElementById("tellafriend_selfCopy") != null)
			{ 
				if (document.getElementById("tellafriend_selfCopy").checked == true)
				{ arguments.tellafriend_selfCopy = true; }	
			}		
		arguments.html = $("#postcard").html();
		
		$("#postcard").hide();
		$("#tellafriend_content").addClass("loading");
		$.post(mailSender   //#root#/tellafriend/tellafriendSender.cfm
			,	arguments
			,	function(data, textStatus) {
					//alert(data);
					var startPosition = data.indexOf('bxbxb') + 5;
					var endPosition   = startPosition + 2;
					//vaidateResponse 11 if true, 00 if false
					var validateResponse = data.substring(startPosition,endPosition);
					$("#tellafriend_content").removeClass("loading");
					if (textStatus == "success" && validateResponse == "11"){
						$("#tellafriend_content").prepend('<div id="tellafriend_sent"><h1>' + RBM.wishList.loggedin.message.friendReceiveEmailTitle + '</h1><div>' + RBM.wishList.loggedin.message.friendReceiveEmail + '</div></div>');
						if (doCoreMetrix) {
							cmCreatePageviewTag("Tell A Friend Sent Email", "Tell A Friend: Successful email");
						}
					} else {
						alert("There was problem sending the e-mail. Please try back again later.");
						$("#postcard").show();
					} 
				}
		);
	}
	
	function validate_email(stringValue) {
		var objRegExp  =
		 /(^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$)/i;
		 ///(^[a-z0-9]([a-z0-9_\.]*)@([a-z_\.]*)([.][a-z]{3})$)|(^[a-z]([a-z_\.]*)@([a-z_\.]*)(\.[a-z]{3})(\.[a-z]{2})*$)/i;
		
		 //check for valid email
		 return objRegExp.test(stringValue);
	}	
$(document).ready(function() {
	$("a[rel^='gLightBox']").each(initLightBox);
});

function initLightBox() {
	var link = $(this).attr("href");
		
	var width = "";
	var height = "";
	var rel = $(this).attr("rel");
	width = rel.match(/width=\d+/) + ""; // match returns array so append "" to convert to string
	height = rel.match(/height=\d+/) + "";
	width = width.match(/\d+/);
	height = height.match(/\d+/);
	
	$(this).attr("href", "javascript:openLightBox('" + link + "', " + width + ", " + height + ")");
	
	$(window).resize(repositionLightBox);	
}

function repositionLightBox() {
	var documentWidth = $(document).width();
	$("#gLightBox_bg").css("width", documentWidth);
	var bodyWidth = $("body").width();
	var offsetLeft = (bodyWidth - $("#gLightBox").width()) / 2;
	var offsetTop = getViewpointTop() + ((getViewpointHeight() - $("#gLightBox").height()) / 2);
	if (offsetLeft < 0) offsetLeft = 0;
	if (offsetTop < 0) offsetTop = 0;
	$("#gLightBox").animate({left: offsetLeft, top: offsetTop});	
}

function openLightBox(link, width, height, closeAction) {
	// width and height are passed in as null if not found
	// set the default width/height to 360px/100px
	if (width == null || width < 360) width = 360;
	if (height == null || height < 100) height = 100;
	
	if (closeAction == null) {
		closeAction = "closeLightBox()";
	}
	
	var target_width = width;
	var target_height = height;
	
	width = 360;
	height = 100;
	
	var padding = 10;
	
	if ($.browser.msie) padding = 20;
	
	var wrapperWidth = width + 18 + 18 + padding;
	var wrapperHeight = height + 70 + 64;

	var documentHeight = $(document).height();
	var documentWidth = $(document).width();
	$("body").prepend('<div id="gLightBox_bg">&nbsp;</div>');
	$("#gLightBox_bg").css({
		"opacity": 0.8,
		width: documentWidth,
		height: documentHeight
	});
	$("#gLightBox_bg").click(function() {eval(closeAction);});

	if ($.browser.msie && jQuery.browser.version == 6.0)
		$("#gLightBox_bg").css({ "opacity": 0.95 });
	
	var tags = '<div id="gLightBox">';
	tags += '<div id="gLightBox_top">';
	tags += '<div id="gLightBox_topLeft"></div>';
	tags += '<div id="gLightBox_topMiddle"></div>';
	tags += '<div id="gLightBox_topRight"></div>';
	tags += '</div>';
	tags += '<div id="gLightBox_middle">';
	tags += '<div id="gLightBox_middleRight">';
	tags += '<div id="gLightBox_content"></div>';
	tags += '<div style="clear: both"></div>';
	tags += '</div>';
	tags += '</div>';
	tags += '<div id="gLightBox_bottom">';
	tags += '<div id="gLightBox_bottomLeft"></div>';	
	tags += '<div id="gLightBox_bottomMiddle"></div>';	
	tags += '<div id="gLightBox_bottomRight"><a href="javascript:' + closeAction + '" title="Close"><span class="red">x</span> Close</a></div>';
	tags += '</div>';
	tags +='</div>';
	
	$("body").prepend(tags);

	var bodyWidth = $("body").width();

	var offsetTop = getViewpointTop() + ((getViewpointHeight() - wrapperHeight) / 2);	
	var offsetLeft = (bodyWidth - wrapperWidth) / 2;
	$("#gLightBox").css({width: wrapperWidth, height: wrapperHeight, left: offsetLeft, top: offsetTop});
	$("#gLightBox_content").css({width: width + padding, height: height});
	$("#gLightBox_topMiddle").css({width: wrapperWidth - 200 - 160});
	$("#gLightBox_bottomMiddle").css({width: wrapperWidth - 112 - 153});

	width = target_width;
	height = target_height;

	wrapperWidth = width + 18 + 18 + padding;
	wrapperHeight = height + 70 + 64;

	offsetTop = getViewpointTop() + ((getViewpointHeight() - wrapperHeight) / 2);	
	offsetLeft = (bodyWidth - wrapperWidth) / 2;
	$("#gLightBox").animate({width: wrapperWidth, left: offsetLeft}, function() {
		$("#gLightBox").animate({height: wrapperHeight, top: offsetTop}, function() {
			$("#gLightBox_content").load(gLightBoxTemplatePath, {link: link}, function () {
				$("#gLightBox_content").css("background-image", "none");
			});		
		});			
		$("#gLightBox_content").animate({height: height});
	});
	$("#gLightBox_content").animate({width: width + padding});
	$("#gLightBox_topMiddle").animate({width: wrapperWidth - 200 - 160});
	$("#gLightBox_bottomMiddle").animate({width: wrapperWidth - 112 - 153});	
}

function closeLightBox() {
	$("#gLightBox_bg").remove();
	$("#gLightBox").remove();
}var popUpOpened = 0;

function sharedWishList(wishlistid, wishlistName) {
	// if only the pop-up isn't open.
	if (popUpOpened != 1)
	{
		closeSharedWishList();
		if (doCoreMetrix)
		{
			cmCreateConversionEventTag('ShareWishList', 1, 'Email Wish List', 0);
		}
		
		var documentWidth = $(document).width();
		var documentHeight = $(document).height();
		$("body").prepend('<div id="overlayBG" ></div>');
		$("#overlayBG").css({opacity: 0.6, left:0, position: "absolute", "z-index": 998, width: documentWidth, height: documentHeight,"background-color": "black" });
		var sharedWishList_box = '<div id="sharedWishList_box"><div id="sharedWishList_content"></div><div id="sharedWishList_close"><a href="javascript:closeSharedWishList()" title="Close">' + RBM.wishList.shareWishList.button.close + '</a></div></div>';
		$("body").prepend(sharedWishList_box);
		var linkImg = $("#sharedWishList_link span");
		var linkImgOffset = linkImg.offset();
		var offsetTop = linkImgOffset.top - 260;
		var bodyWidth = $("body").width();
		var leftOffset = (bodyWidth - 650) / 2;
		$("#sharedWishList_box").css({ width: linkImg.width(), height: linkImg.height(), left: linkImgOffset.left, top: offsetTop});
		$("#sharedWishList_content").addClass("loading");
		$("#sharedWishList_box").animate({height: 530, width: 650, left: leftOffset}
			, 	"slow"
			,	function () {
				// alert('here');
				$("#sharedWishList_content").load(
					wishlistpostCardURL,
					{wishlistid: wishlistid, wishlistName: wishlistName},
					function (responseText, textStatus, XMLHttpRequest) {
						$("#sharedWishList_content").removeClass("loading");
						if (textStatus != "success") {
							alert("There was a problem while loading the form. Please try back later.");
							closeSharedWishList();
						}
						else {
							
						}
					}
				)				
			}
		);
	}
	// We get here after the pop-up has been opened the first time.
		if (popUpOpened != 1)
		{	popUpOpened = 1; }
}

function closeSharedWishList() {
	var linkImg = $("#sharedWishList_link span");
	var linkImgOffset = linkImg.offset();
	// reset this flag so that the pop-up can be opened again.
	popUpOpened = 0;
	
	$("#postcard").remove();
	$("#sharedWishList_sent").remove();
	
	$("#sharedWishList_box").animate({height: linkImg.height(), width: linkImg.width(), left: linkImgOffset.left, top: linkImgOffset.top}
		,	function () {
			if ($.browser.msie && $.browser.version < 7) $("select").show();
			$("#overlayBG").remove();
			$("#sharedWishList_box").remove();			
		}
	);
}

function sendWishList() {
	var errMsg = "";
	
	/*if ($.trim($("#sharedWishList_fromName").val()) == "") {
		errMsg = errMsg + "- Please enter Sender's Name.\n";
	}
	if ($.trim($("#sharedWishList_fromEmail").val()) == "") {
		errMsg = errMsg + "- Please enter Sender's Email.\n";
	}
	else if (validate_email($("#sharedWishList_fromEmail").val()) == false) {
		errMsg = errMsg + "- Sender's Email is not of valid format.\n";
	}*/
	
	var toName="";
	var toEmail="";
	var blankRecipient = 0;
	for (var i=1; i<=RecipientCount; i++) {
		toName = "#sharedWishList_toName_" + i;
		toEmail = "#sharedWishList_toEmail_" + i;
		
		if ($.trim($(toName).val()) == "" && $.trim($(toEmail).val()) != "") {
			errMsg = errMsg + "- Please enter #" + i + " Recipient's Name.\n";
		}
		else if ($.trim($(toName).val()) != "" && $.trim($(toEmail).val()) == "") {
			errMsg = errMsg + "- Please enter #" + i + " Recipient's Email.\n";
		}
		else if ($.trim($(toName).val()) == "" && $.trim($(toEmail).val()) == "") {
			blankRecipient = blankRecipient + 1;
		}
		else if (validate_email($(toEmail).val()) == false) {
			errMsg = errMsg + "- #" + i + " Recipient's Email is not of valid format.\n";
		}
	}

	if (blankRecipient == RecipientCount) {
		errMsg = errMsg + "- Please enter at least one Recipient's Name and Email.\n";
	}
	
	if (errMsg != "") {
		alert(errMsg);
		return;
	}
	
	var arguments = new Object();
	var recipientNameArray = new Array();
	var recipientEmailArray = new Array();
	
	arguments.dsnname = dsnname;
	
	var totalrecipient = 0;
	for (var j=1; j<=RecipientCount; j++) {
		toName = "#sharedWishList_toName_" + j;
		toEmail = "#sharedWishList_toEmail_" + j;
		if ($.trim($(toName).val()) != "" && $.trim($(toEmail).val()) != "") {
			recipientNameArray[totalrecipient] = $.trim($(toName).val());
			recipientEmailArray[totalrecipient] = $.trim($(toEmail).val());
			totalrecipient = totalrecipient + 1;			
		}
	}
		
	arguments.recipientNames = recipientNameArray.toString();
	arguments.recipientEmails = recipientEmailArray.toString();
	arguments.wishlistid 			= $("#wishlistid").val();
	arguments.wishlistname 			= $("#wishlistName").val();
	arguments.sharedwishlist_msg 		= $("#sharedWishList_msg").val();
	arguments.requestkey = $("#requestKey").val();
	arguments.totalrecipient = totalrecipient;
	
	if ($("#sharedWishList_selfCopy:checked").val() != null) {
		if ($("#sharedWishList_selfCopy:checked").val() == "on") {
			arguments.sharedwishlist_selfCopy = true;
		}
		else {
			arguments.sharedwishlist_selfCopy = false;
		}
	}
	else {
		arguments.sharedwishlist_selfCopy = false;
	}
	if (document.getElementById("formfield1234567891") != null)
		{ arguments.formfield1234567891 = $("#formfield1234567891").val(); }
	if (document.getElementById("formfield1234567892") != null)
		{ arguments.formfield1234567892 = $("#formfield1234567892").val();	}
	if (document.getElementById("formfield1234567893") != null)
		{ arguments.formfield1234567893 = $("#formfield1234567893").val(); }
	if (document.getElementById("formfield1234567894") != null)
		{ arguments.formfield1234567894 = $("#formfield1234567894").val(); }
	
	arguments.html = $("#postcard").html();
	
	$("#postcard").hide();
	$("#sharedWishList_content").addClass("loading");
	$.post(wishlistmailSender
		,	arguments
		,	function(data, textStatus) {
				var startPosition = data.indexOf('aaaa') + 4;
				var endPosition   = startPosition + 2;
				//vaidateResponse 11 if true, 00 if false, 22 is illegal words found
				var validateResponse = data.substring(startPosition,endPosition);
				$("#sharedWishList_content").removeClass("loading");

				if (textStatus != "success") {
					alert("There was problem sending the e-mail. Please try back again later.");
					$("#postcard").show();
				} else {
					if (validateResponse == "11") {
						$("#sharedWishList_content").prepend('<div id="sharedWishList_sent"><h1>' + RBM.wishList.loggedin.message.friendReceiveEmailTitle + '</h1><div>' + RBM.wishList.loggedin.message.friendReceiveEmail + '</div></div>');
	
						if (doCoreMetrix) {
							cmCreatePageviewTag("Wish List Email Sent", "Wish List: Successful email");
							cmCreateConversionEventTag('ShareWishList', 2, 'Email Wish List', 0);
						}
					} else if (validateResponse == "22") {
						alert("There were illegal word(s) detected in the e-mail. Please try back again later.");
						$("#postcard").show();
					} else {
						alert("There was problem sending the e-mail. Please try back again later.");
						$("#postcard").show();
					}
				}
			}
	);
}

function validate_email(stringValue) {
	var objRegExp  =
	 /(^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$)/i;
	 ///(^[a-z0-9]([a-z0-9_\.]*)@([a-z_\.]*)([.][a-z]{3})$)|(^[a-z]([a-z_\.]*)@([a-z_\.]*)(\.[a-z]{3})(\.[a-z]{2})*$)/i;
	 //check for valid email
	 return objRegExp.test(stringValue);
}	

function addmoreRecipients() {
	var moreRecipient = "";
	RecipientCount++;
	if (RecipientCount <= 50) {
		moreRecipient += '<label for="sharedWishList_toName_' + RecipientCount + '" class="sharedWishList_toName">#' + RecipientCount + ' ' + RBM.wishList.loggedin.label.recipientsName + ':</label><input type="text" name="sharedWishList_toName_' + RecipientCount + '" id="sharedWishList_toName_' + RecipientCount + '" class="sharedWishList_toName">';
		moreRecipient += '<label for="sharedWishList_toEmail_' + RecipientCount + '" class="sharedWishList_toEmail">#' + RecipientCount + ' ' + RBM.wishList.loggedin.label.recipientsEmail +':</label><input type="text" name="sharedWishList_toEmail_' + RecipientCount + '" id="sharedWishList_toEmail_' + RecipientCount + '" class="sharedWishList_toEmail">';
		$(moreRecipient).insertBefore("#addmore");
	}
	else {
		alert("You can share your wish list to a maximum of 50 e-mail addresses.");
	}
}

var login_action = "";
var login_object = null;
var login_callback = null;
var login_registerAction = "";
var login_coremetricsEventId = "";
var login_CoremetricsCategoryId = "";
var localCoreMetricsDo = 'false';
var localdontRunBV = '';
var local_login_template_path = '';
var globalSiteWidth = 966;

function initializeLoginRequired() {
	$(this).click(openLoginDialog);
}

function openLoginDialog() {
	closeLoginDialog();
	
	login_object = this;
	login_registerAction = "";
	if (this.tagName == "INPUT") {
		login_action = "submit";
	}
	else {
		login_action = "link";
	}

	openLoginDialog_common(this);
	
	return false;
}
//
function openLoginDialogForID(id, action, registerAction, 
							  callback, direction, coremetricsEventId, 
							  CoremetricsCategoryId, coreMetricsDo, dontRunBV ) {
	closeLoginDialog();
	
	login_coremetricsEventId = coremetricsEventId;
	login_CoremetricsCategoryId = CoremetricsCategoryId;
	localCoreMetricsDo = coreMetricsDo;
	localdontRunBV = dontRunBV;
	
	
	login_object = $("#" + id).get(0);
	login_registerAction = "";
	if (action != null)
		login_action = action;
	else
		login_action = "";

	if (registerAction != null)
		login_registerAction = registerAction;
		
	if (callback != null)
		login_callback = callback;
		
	openLoginDialog_common(login_object, direction, coremetricsEventId, CoremetricsCategoryId, coreMetricsDo);
}

function openLoginDialog_common(sender, direction, coremetricsEventId, CoremetricsCategoryId, coreMetricsDo) {
	closeLoginDialog();
	
	
	if (localdontRunBV)
		{
			local_login_template_path = login_template_path + '&dontRunBV=' + localdontRunBV; 
		}
	loginReady();	
	
	var html = '<div id="login_container"></div>';
	var html_shadow = '<div id="login_container_shadow"><div><div></div></div></div>';
	var bodyWidth = $("body").width();
	var pageRightBorder = bodyWidth - ((bodyWidth - globalSiteWidth) / 2);
	
	$("body").prepend(html);
	$("body").prepend(html_shadow);
	
	var targetOffset = $(sender).offset();
	var button_width = $(sender).width();
	var button_height = $(sender).height();
	
	var width = $("#login_container").width();
	var height = $("#login_container").height();

	var left = targetOffset.left;

	if ((left + width) > bodyWidth || (left + width) > pageRightBorder) {
		left = left + button_width - width;
	} else if (left < 1) {
		left = 1;
	}
	
	var top = targetOffset.top;
	//top -= height + 10;
	top += button_height;
	
	if (direction == "bottomleft") {
		top = top - button_height - height;
	}
	
	$("#login_container").css({left: left, top: top});
	$("#login_container_shadow").css({left: left + 6, top: top + 6, opacity: 0.5});
	$("#login_container").load(local_login_template_path, function(responseText, textStatus, XMLHttpRequest) {
		
		if (textStatus != "success") {
			$("body").html(responseText);
			//closeLoginDialog();
		}
	});
	
	$('#login_container').click(function(e) {
		e.stopPropagation();
	});
	$(document).click(closeLoginDialog);		
}

function gotoRegistration() {
	//alert(login_coremetricsEventId); alert(login_CoremetricsCategoryId);
	if (login_coremetricsEventId != '' && login_CoremetricsCategoryId != '' && localCoreMetricsDo == 'true')
	{
		if (login_coremetricsEventId == 'Global Header' &&  login_CoremetricsCategoryId == 'Log In')	
			{
				cmCreateConversionEventTag('Global Header Log In', 1, 'Create an Account', 0);
				createCookie('NewRegistrant', 'Global Header Log In|Create an Account');
			}
		else if (login_coremetricsEventId == 'Registered Message' &&  login_CoremetricsCategoryId == 'Log In')
			{
				// cmCreateConversionEventTag('Registered Message Log In', 1, 'Create an Account', 0);
				createCookie('NewRegistrant', 'Registered Message Log In|Create an Account');
			}
		else if (login_coremetricsEventId.search('Loyalty Message') != -1 &&  login_CoremetricsCategoryId == 'Log In')	
			{
				cmCreateConversionEventTag('Loyalty Message Log In - ' + window.parent.currentloyaltylevel, 1, 'Create an Account', 0);
				createCookie('NewRegistrant', 'Loyalty Message Log In - '+ window.parent.currentloyaltylevel + '|Create an Account');
			}
		else if (login_coremetricsEventId.search('Loyalty PDP') != -1 &&  login_CoremetricsCategoryId == 'Log In')	
			{
				// cmCreateConversionEventTag('Loyalty PDP Log In', 1, 'Create an Account', 0);
				createCookie('NewRegistrant', 'Loyalty PDP Log In - ' + window.parent.level + '|Create an Account');
			}
		else if (login_coremetricsEventId.search('Loyalty Renewal ') != -1 &&  login_CoremetricsCategoryId == 'Log In')	
			{
				//loyalty renewal pdp login dialog box in topnav
				createCookie('NewRegistrant', 'Loyalty Renewal PDP Log In - ' + window.parent.level + '|Create an Account');
			}
			
	}
	// alert('login_registerAction - ' + login_registerAction);
	// alert('register_url - ' + register_url);
	
	if (login_registerAction != "")
		window.parent.location = login_registerAction;
	else
		window.parent.location = register_url;
}

function closeLoginDialog() {
	$("#login_container_shadow").remove();
	$("#login_container").remove();
}

// Continue with the previous action
function closeAndPerformAction() {
	closeLoginDialog();
	// alert(login_action); return;
	
	if (login_coremetricsEventId != '' && login_CoremetricsCategoryId != '' && localCoreMetricsDo == 'true')
		{	cmCreateConversionEventTag(login_coremetricsEventId, 2, login_CoremetricsCategoryId, 0);  }
		
	if (login_callback != null)
	{
		login_callback();
		login_callback = null;
		return;
	}
	
	if (login_action == "") return;
	
	if (login_action == "submit") {
		$(login_object).parents("form").submit();
	}
	else {
		var action = $(login_object).attr("href");
		if (action != null)
			window.location = $(login_object).attr("href");
	}
}

function loginReady() {
	
	if (login_coremetricsEventId != '' && login_CoremetricsCategoryId != ''  && localCoreMetricsDo == 'true')
		{	cmCreateConversionEventTag(login_coremetricsEventId, 1, login_CoremetricsCategoryId, 0); }
		
	return;
}

function bv_openLoginDialogForID(action, callback) {
	closeLoginDialog();
	if (callback != null)
		login_callback = callback;
	var login_template = login_template_path;
	var sku = $("#pdp_selectedSKU").val();
	var model_nbr = $("#the_model_nbr").val();
	login_template = login_template + '&action=' + action + '&model_nbr=' + model_nbr + '&sku=' + sku + '&' + bv_querystring;
	var html = '<div id="login_container"></div>';
	var html_shadow = '<div id="login_container_shadow"><div><div></div></div></div>';
	
	$("body").prepend(html);
	$("body").prepend(html_shadow);
	
	if (action == "bazaarvoiceReviews") {
		var targetOffset = $("#BVSubmissionURL").offset();
		var button_width = $("#BVSubmissionURL").width();
		var button_height = $("#BVSubmissionURL").height();
	}
	else if (action == "bazaarvoiceAskQuestion") {
		var targetOffset = $("#BVQuestionAnswer").offset();
		var button_width = $("#BVQuestionAnswer").width();
		var button_height = $("#BVQuestionAnswer").height();
	}
	/*else if (action == "bazaarvoiceAnswerQuestion") {
		var targetOffset = $("#BVAnswerQuestionURL").offset();
		var button_width = $("#BVAnswerQuestionURL").width();
		var button_height = $("#BVAnswerQuestionURL").height();
	}*/
	
	var width = $("#login_container").width();
	var height = $("#login_container").height();

	var left = targetOffset.left;
	var top = targetOffset.top;

	left -= (width - button_width) / 2;
	//top -= height + 10;
	top += button_height;
	
	$("#login_container").css({left: left, top: top});
	$("#login_container_shadow").css({left: left + 6, top: top + 6, opacity: 0.5});
	$("#login_container").load(login_template, function(responseText, textStatus, XMLHttpRequest) {
		
		if (textStatus != "success") {
			$("body").html(responseText);
			//closeLoginDialog();
		}
	});
	
	$('#login_container').click(function(e) {
		e.stopPropagation();
	});
	$(document).click(closeLoginDialog);		
}
