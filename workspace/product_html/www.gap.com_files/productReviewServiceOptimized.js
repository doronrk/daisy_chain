
var ProductReviewService=Class.create();ProductReviewService.prototype={initialize:function(){},model:{rawData:null,data:{isAllDataLoaded:true,isDataLoading:false,dataFileUrl:"",paginatedDataFileUrl:"",productReviews:[],reviewProfiles:[]}},controller:{pageType:null,init:{},handlers:{},reportingManager:{},productManager:{},profileManager:{},dataLoadManager:{},externalOverrides:{}},utils:{getConstantKey:function(key){if(key){return key.replace(/\./g,"_").toUpperCase();}
return null;},getFormattedNodeIdName:function(str){return str.replace(/\s+/,"").replace(/\/+/,"");},position:{scrollToElement:function(element){element=$(element);var pos=Position.cumulativeOffset(element);window.scrollTo(0,pos[1]);return element;}},setFocus:function(element){var PRODUCT_CONTENT_LEFT_NODE_NAME=productReviewService.constants.nodeNames.PRODUCT_CONTENT_LEFT_NODE_NAME;if(clientBrowser&&clientBrowser.isIE7){Element.toggle(PRODUCT_CONTENT_LEFT_NODE_NAME);}
gidLib.setFocus(element);if(clientBrowser&&clientBrowser.isIE7){Element.toggle(PRODUCT_CONTENT_LEFT_NODE_NAME);}},hasCustomerReviews:function(productReview){var hasReviews=false;if(productReview&&productReview.customerReviews&&productReview.customerReviews.size()>0){hasReviews=true;}
return hasReviews;},getProductStyleId:function(){var styleId="";if(productPage&&productPage.productId){styleId=productPage.productId;}
return styleId;},getProductStyleColorId:function(){var styleColorId="";if(productPage&&productPage.activeColor!=null&&productPage.objV&&productPage.objV.arrayVariantStyleColors){styleColorId=productPage.objV.arrayVariantStyleColors[productPage.activeColor].strColorCodeId.substring(6);}
return styleColorId;},addReviewerProfilePopupStyle:function(){var nodeNames=productReviewService.constants.nodeNames.profilePopup;var reviewerProfilePopupStyle={templates:{mainTemplate:new Template('<div id="'+nodeNames.PROFILE_POPUP_MAIN_NODE_NAME+'" class="reviewerProfilePanel" style="width:#{width}px;">'+'<div id="'+nodeNames.PROFILE_POPUP_TITLE_NODE_NAME+'" class="titleBar clearfix">'+'<div class="title">#{title}</div>'+'<div class="closeButton">#{closeButton}</div>'+'</div>'+'<div id="'+nodeNames.PROFILE_POPUP_PANEL_CONTENT_NODE_NAME+'" class="panelContent" style="width:#{width}px;height:#{height}px;">#{content}</div>'+'</div>'),iFrameContentTemplateWithNoScroll:new Template('<iframe id="#{id}PopupContent" name="#{id}PopupContent" src="#{src}" class="content" '+'style="width:#{width}px;height:#{height}px;" scrolling=no frameborder="0"></iframe>'),closeReviewerProfilePopupTemplate:new Template('<a href="#" onclick="return productReviewService.controller.productManager.view.handlers.closeReviewerProfileLayeredPopup();"><img alt="#{text}" src="/assets/common/clear.gif" class="reviewerCloseButton"/></a>')},getMarkup:function(useIFrame,width,height,title,strContent,id,style){var templates=this.templates;var commonTemplates=gidLib.layeredPopup.styles.commonTemplates;var content="";if(useIFrame){content=templates.iFrameContentTemplateWithNoScroll.evaluate({id:id,src:gidLib.addCurrentDomain(strContent),width:width,height:height});}else{content=commonTemplates.markupContentTemplate.evaluate({id:id,content:strContent,width:width,height:height});}
var closeButton=templates.closeReviewerProfilePopupTemplate.evaluate({text:'close'});return templates.mainTemplate.evaluate({width:width,height:height,content:content,title:title,closeButton:closeButton});}}
Object.extend(gidLib.layeredPopup.styles,{reviewerProfilePanel:reviewerProfilePopupStyle});},reSizeProfilePopup:function(){var reviewerProfileIFrame=$(productReviewService.constants.nodeNames.profilePopup.PROFILE_POPUP_IFRAME_NODE_NAME);var nodeNames=productReviewService.constants.nodeNames;var iFramePadding=10;var reviewerProfileDocument=reviewerProfileIFrame.contentDocument?reviewerProfileIFrame.contentDocument:reviewerProfileIFrame.contentWindow.document;var reviewsListNode=reviewerProfileDocument.getElementById(productReviewService.constants.nodeNames.profileDetails.REVIEWER_REVIEWS_LIST_NODE_NAME);var iFrameScrollHeight=reviewerProfileDocument.documentElement.scrollHeight;var iFrameOffsetHeight=reviewerProfileDocument.documentElement.offsetHeight;var booleanHeightFlag=(iFrameScrollHeight>iFrameOffsetHeight);var iFrameHeight=booleanHeightFlag?iFrameOffsetHeight:iFrameScrollHeight;var isIE=clientBrowser&&clientBrowser.isIE;var isNetscape=clientBrowser.isNetscape;if((booleanHeightFlag&&isIE)||isNetscape){iFrameHeight=iFrameScrollHeight;var reviewsListNode=reviewerProfileDocument.getElementById(productReviewService.constants.nodeNames.profileDetails.REVIEWER_REVIEWS_LIST_NODE_NAME);var reviewsScrollHeight=reviewsListNode.scrollHeight;var reviewsOffsetHeight=reviewsListNode.offsetHeight;if((reviewsScrollHeight>reviewsOffsetHeight)||isNetscape){var mainContentNode=reviewerProfileDocument.getElementById(productReviewService.constants.nodeNames.profileDetails.REVIEWER_PROFILE_MAIN_CONTENT_NONE_NAME);iFrameHeight=mainContentNode.offsetHeight+13;}}
$(nodeNames.profilePopup.PROFILE_POPUP_IFRAME_NODE_NAME).setStyle({"height":iFrameHeight+"px"});var popupHeight=iFrameHeight+iFramePadding;var popupHeightOffset=5;$(nodeNames.profilePopup.PROFILE_POPUP_PANEL_CONTENT_NODE_NAME).setStyle({"height":popupHeight+"px"});var titleHeight=$(nodeNames.profilePopup.PROFILE_POPUP_TITLE_NODE_NAME).offsetHeight;popupHeight=popupHeight+titleHeight;$(nodeNames.profilePopup.PROFILE_POPUP_MAIN_NODE_NAME).setStyle({"height":popupHeight+popupHeightOffset+"px"});},launchReviewerProfile:function(calleeElement,reviewerId){if(!gidLib.layeredPopup.styles.reviewerProfilePanel)this.addReviewerProfilePopupStyle();var reviewerProfileUrl=productReviewService.constants.actions.REVIEWER_PROFILE_ACTION+reviewerId;gidLib.layeredPopup.openLayeredPopup({str:reviewerProfileUrl,id:'reviewerProfile',width:624,height:400,title:'Profile',calleeElement:calleeElement,style:{name:'reviewerProfilePanel'},effects:{show:{method:Effect.Appear,args:{duration:0.25}},hide:{method:Effect.Fade,args:{duration:0.25}}}});},addProductReviewPanelStyle:function(){var productReviewPanelStyle={templates:{mainTemplate:new Template('<div class="productReviewPanel">#{content}</div>')},getMarkup:function(useIFrame,width,height,title,strContent,id,style){var templates=this.templates;var commonTemplates=gidLib.layeredPopup.styles.commonTemplates;var content="";content=commonTemplates.markupContentTemplate.evaluate({id:id,content:strContent,width:width,height:height});return templates.mainTemplate.evaluate({content:content});}}
Object.extend(gidLib.layeredPopup.styles,{productReviewPanel:productReviewPanelStyle});},launchReviewAcknowledgementPopup:function(calleeElement,message,alignment){if(!gidLib.layeredPopup.styles.productReviewPanel)this.addProductReviewPanelStyle();var popupContent=$(productReviewService.constants.nodeNames.POPUP_CONTENT_NODE_NAME);var targetPosition=Position.cumulativeOffset($(calleeElement));var popupPaddingOffset=5;var panelHeight=45;var panelWidth=257;var leftOffset=targetPosition[0];if(alignment=="right")leftOffset-=(panelWidth-$(calleeElement).offsetWidth);var topOffset=targetPosition[1]-(panelHeight+popupPaddingOffset);$('reviewVoteAcknowledgementMessage').update(message);gidLib.layeredPopup.openLayeredPopup({str:'reviewVoteAcknowledgement',id:'reviewVote',width:panelWidth,height:panelHeight,left:leftOffset,top:topOffset,calleeElement:calleeElement,isDraggable:false,style:{name:'productReviewPanel'},effects:{show:{method:Effect.Appear,args:{duration:0.25}},hide:{method:Effect.Fade,args:{duration:0.25}}}});var okButton=popupContent.getElementsBySelector('a')[0];okButton.onclick=function(){return gidLib.layeredPopup.closeLayeredPopup();}},badgeDetailsDisplay:{launchBadgeDescription:function(badgeElement,badgeCode,panelAlignment){if(gidLib.layeredPopup.isOpen==false){var badgeDescription=this.getBadgeDescription(badgeCode);if(!gidLib.layeredPopup.styles.productReviewPanel)productReviewService.utils.addProductReviewPanelStyle();var popupContent=$(productReviewService.constants.nodeNames.POPUP_CONTENT_NODE_NAME);var targetPosition=Position.cumulativeOffset($(badgeElement));var popupTopOffset=25;var panelHeight;var panelWidth=235;var leftOffset;var topOffset=targetPosition[1]+popupTopOffset;var markup='<div style="padding:7px 7px 10px 7px; font-size:10px; line-height:12px; color:#666">'+badgeDescription+'</div>';if(panelAlignment=="right"){leftOffset=targetPosition[0]-(panelWidth-$(badgeElement).offsetWidth);}else{leftOffset=targetPosition[0];}
gidLib.layeredPopup.openLayeredPopup({str:markup,id:'badgeDescriptionHover',width:panelWidth,height:panelHeight,left:leftOffset,top:topOffset,calleeElement:badgeElement,isDraggable:false,style:{name:'productReviewPanel'}});}},getBadgeDescription:function(badgeCode){var templates=productReviewService.controller.productManager.view.templates;var constants=productReviewService.constants;var badgeKey=productReviewService.utils.getConstantKey(badgeCode);var badgeDescription=constants.profileBadge.badgeDescriptions[badgeKey];return badgeDescription;},positionBadgeDescriptionPopup:function(badgeElement){var badgeNodeNames=productReviewService.constants.nodeNames.badgeDescriptionPopup;var targetPosition=Position.cumulativeOffset(badgeElement);var panelWidth=234;var panelHeight=78;var imagePaddingLeft=7;var imagePaddingRight=7;var imageWidth=badgeElement.width;var imageSectionHeight=26;var remainingWidth=panelWidth-imageWidth-3;var leftOffset=targetPosition[0]-remainingWidth;var topOffset=targetPosition[1]-(imageSectionHeight-badgeElement.height+6);var badgeNameContent=$(badgeNodeNames.BADGE_NAME_CONTENT_NODE_NAME);badgeNameContent.setStyle({"width":imageWidth+"px","height":"26px"});var badgeNameSection=$(badgeNodeNames.BADGE_NAME_SECTION_NODE_NAME);badgeNameSection.setStyle({"padding-left":imagePaddingLeft+"px","padding-right":imagePaddingRight+"px"});remainingWidth=remainingWidth-(imagePaddingLeft+imagePaddingRight);var badgeSpacerContent=$(badgeNodeNames.BADGE_SPACER_SECTION_NODE_NAME);badgeSpacerContent.setStyle({"width":remainingWidth+"px","height":"26px"});var badgeHoverPanel=$(badgeNodeNames.BADGE_MAIN_NODE_NAME);badgeHoverPanel.setStyle({"width":panelWidth+"px","height":panelHeight+"px","left":leftOffset+'px',"top":topOffset+'px'});}},loadPaginatedReviewData:function(args){productReviewService.controller.dataLoadManager.loadPaginatedData(args);},reviewsPaging:{numberOfPages:0,reviewsPerPage:0,currentPage:1,totalNumberOfReviews:0,pagedCustomerReviewsMap:{},paginate:function(allCustomerReviews,reviewsPerPage,totalNumberOfReviews){this.reviewsPerPage=reviewsPerPage;this.totalNumberOfReviews=totalNumberOfReviews;this.numberOfPages=Math.ceil(totalNumberOfReviews/reviewsPerPage);if(allCustomerReviews instanceof Array){for(var p=1;p<=this.numberOfPages;p++){this.pagedCustomerReviewsMap[p]=[];for(var r=0;r<this.reviewsPerPage;r++){var review=allCustomerReviews[(p-1)*this.reviewsPerPage+r];if(!review)break;this.pagedCustomerReviewsMap[p][r]=review.prReviewId;}}
if(productReviewService.model.data.isAllDataLoaded==true){this.pagedCustomerReviewsMap[0]=allCustomerReviews.pluck('prReviewId');}
return this.pagedCustomerReviewsMap[this.currentPage];}
return allCustomerReviews.prReviewId;},clearReviewsPagingCache:function(){this.pagedCustomerReviewsMap={};},setReviewsPagingCache:function(pagedMap){this.pagedCustomerReviewsMap=pagedMap;this.numberOfPages=Object.keys(pagedMap).length-1;this.currentPage=1;},getPagedCustomerReviews:function(pageId){this.currentPage=pageId;return this.pagedCustomerReviewsMap[this.currentPage];},getPaginationMarkupForPage:function(pageId,pageHandler){var constants=productReviewService.constants;var templates=constants.commonTemplates.reviewsPaging;if(pageId==this.currentPage){return templates.CURRENT_PAGE_TEMPLATE.evaluate({pageId:pageId});}else{return templates.PAGE_ANCHOR_LINK_TEMPLATE.evaluate({pageHandler:pageHandler,pageId:pageId,pageSymbol:pageId});}},getPaginationLinksMarkup:function(pageHandler){var pageLinksMarkup="";var constants=productReviewService.constants;if(this.numberOfPages<=1)return pageLinksMarkup;var templates=constants.commonTemplates.reviewsPaging;if(this.currentPage>1){pageLinksMarkup+=templates.PAGE_ANCHOR_LINK_TEMPLATE.evaluate({pageHandler:pageHandler,pageId:(this.currentPage-1),pageSymbol:constants.messages.reviewsPaging.NAVIGATE_LEFT});}
if(this.numberOfPages<=5){for(i=1;i<=this.numberOfPages;i++){pageLinksMarkup+=this.getPaginationMarkupForPage(i,pageHandler);}}else{var needSecondEllipsis=true;pageLinksMarkup+=this.getPaginationMarkupForPage(1,pageHandler);if(this.currentPage<=2){pageLinksMarkup+=this.getPaginationMarkupForPage(2,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(3,pageHandler);needSecondEllipsis=false;}
if(this.currentPage==3){pageLinksMarkup+=this.getPaginationMarkupForPage(2,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(3,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(4,pageHandler);needSecondEllipsis=false;}
pageLinksMarkup+="...";if(this.currentPage>3&&this.currentPage<this.numberOfPages-2){pageLinksMarkup+=this.getPaginationMarkupForPage(this.currentPage-1,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(this.currentPage,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(this.currentPage+1,pageHandler);}
if(this.currentPage==this.numberOfPages-2){pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages-3,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages-2,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages-1,pageHandler);needSecondEllipsis=false;}
if(this.currentPage>=this.numberOfPages-1){pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages-2,pageHandler);pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages-1,pageHandler);needSecondEllipsis=false;}
if(needSecondEllipsis){pageLinksMarkup+="...";}
pageLinksMarkup+=this.getPaginationMarkupForPage(this.numberOfPages,pageHandler);}
if(this.currentPage<this.numberOfPages){pageLinksMarkup+=templates.PAGE_ANCHOR_LINK_TEMPLATE.evaluate({pageHandler:pageHandler,pageId:(this.currentPage+1),pageSymbol:constants.messages.reviewsPaging.NAVIGATE_RIGHT});}
return pageLinksMarkup;}},submitReview:function(){var pageId=this.getProductStyleId();var variant=this.getProductStyleColorId();var writeareview_action_template=new Template(productReviewService.constants.actions.WRITE_A_REVIEW_ACTION);var writeareview_action_url=writeareview_action_template.evaluate({pageId:pageId,variant:variant});window.location.href=writeareview_action_url;},insertPixel:function(src){var img=$(document.createElement("img"));img.src=src;img.setStyle({display:"none"});img.onload=function(){this.remove();};document.documentElement.appendChild(img);},sortCustomerReviewsBy:function(sortByOption,customerReviews){var sortByKeys=productReviewService.constants.productReview.sortByKeys;var sortedCustomerReviews=customerReviews.clone();var getCriterion=function(customerReview,sortByOption){var criteria;switch(sortByOption){case sortByKeys.SORT_BY_MOST_RECENT:criteria=0;break;case sortByKeys.SORT_BY_HIGH_TO_LOW:case sortByKeys.SORT_BY_LOW_TO_HIGH:criteria=customerReview.overallRating;break;case sortByKeys.SORT_BY_FEATURED:criteria=customerReview.badgePriority;break;case sortByKeys.SORT_BY_MOST_HELPFUL:break;default:criteria=customerReview.helpfulValue();}
return criteria;};var sortCustomerReviewsIterator=function(left,right){var a=getCriterion(left,sortByOption);var b=getCriterion(right,sortByOption);var order=b-a;if(sortByOption==sortByKeys.SORT_BY_LOW_TO_HIGH){order=a-b;}
if(order==0){var dateLeft=left.createdDate,dateRight=right.createdDate;var dateLeftArr=dateLeft.split("-");var dateRightArr=dateRight.split("-");var jsLeftDate=new Date(),jsRightDate=new Date();jsLeftDate.setFullYear(dateLeftArr[2],dateLeftArr[0],dateLeftArr[1]);jsRightDate.setFullYear(dateRightArr[2],dateRightArr[0],dateRightArr[1]);if(jsLeftDate>jsRightDate)return-1;if(jsLeftDate<jsRightDate)return 1;return 0;}
return order;};if(productReviewService.model.data.isAllDataLoaded==true&&sortByOption!=productReviewService.constants.productReview.DEFAULT_SORT_BY){sortedCustomerReviews=sortedCustomerReviews.sort(sortCustomerReviewsIterator.bind(this));}
return sortedCustomerReviews;},saveProfilePopupState:function(reviewerId,productId){gidLib.setCookieVar("globalSession","productReviewProfilePopup",reviewerId+","+productId);},loadProfilePopupState:function(){var state=gidLib.getCookieVar("globalSession","productReviewProfilePopup");if(state!=""){var stateInfo=state.split(",");var reviewerId=stateInfo[0];var productId=stateInfo[1];var pageVisit=stateInfo[2];if(pageVisit){if(productId==productPage.objP.strProductId){this.position.scrollToElement($(productReviewService.constants.nodeNames.reviewDetails.REVIEW_LIST_DISPLAY_ROOT_NODE_NAME));this.launchReviewerProfile(document.body,reviewerId);}
gidLib.setCookieVar("globalSession","productReviewProfilePopup","");}else{gidLib.setCookieVar("globalSession","productReviewProfilePopup",state+",1");}}},view:{getStarRatingImageMarkup:function(rating){var starRatingImageMarkup="";var imageConstants=productReviewService.constants.image;var totalNumberOfStars=5;for(i=0;i<totalNumberOfStars;i++){if((i+0.5)==rating){starRatingImageMarkup=starRatingImageMarkup+"<img class=\"sprite-reviews_star sprite-reviews_star_half\" src='/assets/common/clear.gif'/>";}
else if(i>=rating){starRatingImageMarkup=starRatingImageMarkup+"<img class=\"sprite-reviews_star sprite-reviews_star_empty\" src='/assets/common/clear.gif'/>";}
else{starRatingImageMarkup=starRatingImageMarkup+"<img class=\"sprite-reviews_star sprite-reviews_star_full\" src='/assets/common/clear.gif'/>";}}
var starRatingTemplate=new Template(productReviewService.constants.messages.common.STAR_RATING_VALUE);starRatingImageMarkup+="<span class='cssHide'>"+starRatingTemplate.evaluate({0:rating})+"</span>";return starRatingImageMarkup;},getFirstReviewMarkup:function(){var template=productReviewService.controller.productManager.view.templates.REVIEW_SUMMARY_FIRST_REVIEW_LINK_TEMPLATE;var templateData={writeAReviewHandler:productReviewService.constants.handlers.WRITE_A_REVIEW_HANDLER,writeAReview:productReviewService.constants.messages.reviewLinks.REVIEW_LINKS_WRITEAREVIEW,firstReview:productReviewService.constants.messages.reviewLinks.REVIEW_LINKS_FIRSTREVIEW};return template.evaluate(templateData);},getFitDetailsMarkup:function(review){var constants=productReviewService.constants;var externalOverrides=productReviewService.controller.externalOverrides;var fitTemplate=constants.commonTemplates.CUSTOMER_REVIEW_FIT_TYPE_TEMPLATE;var tagTemplate=constants.commonTemplates.CUSTOMER_REVIEW_TAG_TYPE_TEMPLATE;var fitAttributes=review.customerReviewAttributes["fitAttributes"];var tagAttributes=review.customerReviewAttributes["tagAttributes"];var reviewId=review.prReviewId;var fitDetailsMarkup="";var fitTypesMarkup="";var tagTypesMarkup="";var hideFitElement="";var numberOfFits=fitAttributes.size();if(externalOverrides.isFitOverrideEnabled==true)numberOfFits=Math.min(numberOfFits,externalOverrides.maxFits);var numberOfTags=tagAttributes.size();if(externalOverrides.isTagOverrideEnabled==true)numberOfTags=Math.min(numberOfTags,externalOverrides.maxTags);if(numberOfFits>0||numberOfTags>0){if(numberOfFits>0){var fitTypes=[];for(var i=0;i<numberOfFits;i++){var attribute=fitAttributes[i];if(attribute&&attribute.valueCode!=null){var fitMarkup=fitTemplate.evaluate({fitIndex:productReviewService.utils.getFormattedNodeIdName(attribute.nameCode),reviewId:reviewId,fitLabel:attribute.nameCode,fitVote:attribute.valueText});fitTypes.push(fitMarkup);}}
fitTypesMarkup=fitTypes.join("");}else{hideFitElement='style="display:none;"';}
if(numberOfTags>0){var tagTypes=[];for(var i=0;i<numberOfTags;i++){var attribute=tagAttributes[i];var tagLabel="";var tagVote="";if(attribute&&attribute instanceof Array&&attribute.length>0){tagLabel=attribute[0].nameCode;var tagVoteAccumulator=function(tagVotes,attribute){return tagVotes+attribute.valueText+"<br/>";};tagVote=attribute.inject("",tagVoteAccumulator);}else{tagLabel=attribute.nameCode;tagVote=attribute.valueText;}
if(!tagLabel.blank()&&!tagVote.blank()){var tagMarkup=tagTemplate.evaluate({tagIndex:productReviewService.utils.getFormattedNodeIdName(tagLabel),reviewId:reviewId,tagLabel:tagLabel,tagVote:tagVote});tagTypes.push(tagMarkup);}}
tagTypesMarkup=tagTypes.join("");}
fitDetailsMarkup=constants.commonTemplates.CUSTOMER_REVIEW_FIT_DETAILS_TEMPLATE.evaluate({reviewId:reviewId,fitTypesMarkup:fitTypesMarkup,tagTypesMarkup:tagTypesMarkup,hideFitElement:hideFitElement});}
return fitDetailsMarkup;}}},constants:{actions:{REVIEWER_PROFILE_ACTION:"/browse/reviewerProfile.do?reviewerId=",PRODUCT_ACTION:"/browse/product.do?pid=",WRITE_A_REVIEW_ACTION:"/browse/writeareview.do?pageId=#{pageId}&variant=#{variant}&source=web",INVENTORY_STATUS_CHECK_ACTION:"/browse/isProductSalable.do?isPowerReviews=true&pid="},urls:{},handlers:{WRITE_A_REVIEW_HANDLER:"productReviewService.controller.productManager.view.handlers.launchWriteAReviewForm"},pageType:{PRODUCT:"product",PROFILE:"profile",REVIEW_WRAPPER:"reviewWrapper"},commonTemplates:{CUSTOMER_REVIEW_FIT_TYPE_TEMPLATE:new Template('<span id="productReview#{fitIndex}Title#{reviewId}" class="productReviewFitTitle reviewRatingName">#{fitLabel}</span>: '+'<span id="productReview#{fitIndex}LargestVoteName#{reviewId}" class="reviewRatingValue">#{fitVote}</span><br/>'),CUSTOMER_REVIEW_TAG_TYPE_TEMPLATE:new Template('<div class="productReviewTagDetails">'+'<div id="productReview#{tagIndex}Title#{reviewId}" class="reviewRatingName">#{tagLabel}:</div>'+'<div id="productReview#{tagIndex}LargestVoteName#{reviewId}" class="reviewRatingValue">#{tagVote}</div>'+'</div>'),CUSTOMER_REVIEW_FIT_DETAILS_TEMPLATE:new Template('<div class="productReviewFitDetailsContainer clearfix">'+'<div class="productReviewFitDetails" #{hideFitElement}>'+'#{fitTypesMarkup}'+'</div>'+'#{tagTypesMarkup}'+'</div>'),reviewsPaging:{PAGE_ANCHOR_LINK_TEMPLATE:new Template('<a href="#" onclick="return #{pageHandler}(#{pageId});">#{pageSymbol}</a>'),CURRENT_PAGE_TEMPLATE:new Template('<span class="currentPage">#{pageId}</span>')}},reviewsPaging:{REVIEWS_PER_PAGE_ON_PRODUCT:20,REVIEWS_PER_PAGE_ON_PROFILE:5},reviewAttribute:{reviewAttributeKeys:{SHOES_IN_CLOSET:"profile.shoes_in_closet",BRANDS_I_LOVE:"profile.brands_i_love"}},profileBadge:{badgeImages:{PROFILE_BADGE_VIP:"icon_reviews_vip_red.gif",PROFILE_BADGE_LOVE:"icon_reviews_heart_red.gif",PROFILE_BADGE_GUEST:"icon_reviews_crown_red.gif",PROFILE_BADGE_STAFF:"badge_PL_staff.gif",PROFILE_BADGE_CROWD:"icon_reviews_hand_red.gif",PROFILE_BADGE_EXPERT:"icon_reviews_ruler_red.gif"},badgePriority:{PROFILE_BADGE_LOVE:6,PROFILE_BADGE_CROWD:5,PROFILE_BADGE_VIP:4,PROFILE_BADGE_EXPERT:3,PROFILE_BADGE_STAFF:2,PROFILE_BADGE_PLSTAFF:2,PROFILE_BADGE_ONSTAFF:2,PROFILE_BADGE_GPSTAFF:2,PROFILE_BADGE_BRSTAFF:2,PROFILE_BADGE_DESIGNER:2,PROFILE_BADGE_GUEST:1}},xmlFeedTagPrefixes:{PRODUCT_TAG_PREFIX:"PR",PROFILE_TAG_PREFIX:"PFR"},productReview:{sortByNames:{},sortByKeys:{SORT_BY_MOST_RECENT:"1",SORT_BY_MOST_HELPFUL:"2",SORT_BY_HIGH_TO_LOW:"3",SORT_BY_LOW_TO_HIGH:"4",SORT_BY_FEATURED:"5"},MOST_RECENT_SORT_ORDER:false},nodeNames:{xmlFeed:{XML_PRODUCT_FEED_NODE_NAME:"productReviewFeed",XML_PROFILE_FEED_NODE_NAME:"profileReviewFeed"},noReviews:{NO_REVIEWS_ROOT_NODE_NAME:"noReviews"},reviewSummary:{REVIEW_SUMMARY_ROOT_NODE_NAME:"reviewSummary",STAR_RATING_NODE_NAME:"starRating",TOTAL_REVIEW_COUNT_NODE_NAME:"totalReviewCount",REVIEW_SUMMARY_FIT_NODE_NAME:"reviewSummaryFit",REVIEW_TAGS_NODE_NAME:"reviewTags",REVIEW_LINKS_NODE_NAME:"reviewLinks",REVIEW_FIT_HOVER_TITLE_NODE_NAME:"reviewFitHoverHeader",REVIEW_FIT_HOVER_CONTENT_NODE_NAME:"reviewFitHoverContent",REVIEW_FIT_HOVER_NODE_NAME:"reviewFitHover",STAR_RATING_SMALL_NODE_NAME:"starRatingSmall",TOTAL_REVIEW_COUNT_SMALL_NODE_NAME:"totalReviewCountSmall"},reviewDetails:{REVIEW_SECTION_ROOT_NODE_NAME:"productReviewsSectionWide",REVIEW_LIST_DISPLAY_ROOT_NODE_NAME:"productReviewsListDisplay",REVIEW_DETAILS_ROOT_NODE_NAME:"productReviews",REVIEW_DETAILS_SORT_NODE_NAME:"productReviewsSort",REVIEW_DETAILS_SORT_SELECT_NODE_NAME:"productReviewsSortSelect",REVIEW_DETAILS_PRODUCT_REPORT_NODE_NAME:"productReviewReportLinkText",REVIEW_DETAILS_PAGING_CLASS_NAME:".reviewsPaging"},profileSummary:{AVATAR_IMAGE_NODE_NAME:"reviewerProfileAvatar",REVIEWER_NAME_NODE_NAME:"reviewerProfileName",REVIEWER_LOCATION_NODE_NAME:"reviewerProfileLocation",REVIEWER_ATTRIBUTES_NODE_NAME:"reviewerProfileAttributes",REVIEWER_REVIEWS_COMPLETED_NODE_NAME:"reviewerProfileCompletedReviews",REVIEWER_SUMMARY_NODE_NAME:"reviewerProfileSummary",REVIEWER_SUMMARY_TITLE_NODE_NAME:"reviewerProfileSummaryTitle",REVIEWER_SUMMARY_DESCRIPTION_NODE_NAME:"reviewerProfileSummaryDescription",REVIEWER_NAME_CONTAINER_NODE_NAME:"reviewerNameContainer",REVIEWER_LOCATION_CONTAINER_NODE_NAME:"reviewerLocationContainer",REVIEWER_SHOES_CONTAINER_NODE_NAME:"reviewerShoesContainer",REVIEWER_FAVORITE_CONTAINER_NODE_NAME:"reviewerFavoriteBrandsContainer",REVIEWER_REVIEWS_CONTAINER_NODE_NAME:"reviewerReviewsContainer",REVIEWER_ERROR_MESSAGE_NODE_NAME:"reviewerProfileErrorMessage",BADGE_IMAGE_NODE_NAME:"reviewerBadges"},profileDetails:{REVIEWER_REVIEWS_NODE_NAME:"reviewerReviews",REVIEWER_REVIEWS_LIST_NODE_NAME:"reviewerReviewsList",REVIEWER_SUMMARY_NODE_NAME:"reviewerProfileSummary",REVIEWER_MARKETING_NODE_NAME:"reviewerProfileMarketingContainer",REVIEWER_PROFILE_MAIN_CONTENT_NONE_NAME:"mainContent",REVIEWER_REVIEWS_PAGING_CLASS_NAME:".reviewsPaging",REVIEWER_REVIEW_CONTENT_CLASS_NAME:".productReviewContent",REVIEWER_REVIEW_CONTENT_NODE_NAME:"reviewerReviewContent",REVIEWER_REVIEW_PRODUCT_IMAGE_BORDER_NODE_NAME:"productImageBorder",REVIEWER_REVIEW_PRODUCT_REVIEW_DATA_NODE_NAME:"productReviewData"},profilePopup:{PROFILE_POPUP_IFRAME_NODE_NAME:"reviewerProfilePopupContent",PROFILE_POPUP_PANEL_CONTENT_NODE_NAME:"panelContent",PROFILE_POPUP_MAIN_NODE_NAME:"popupMain",PROFILE_POPUP_TITLE_NODE_NAME:"popupTitle"},PRODUCT_CONTENT_LEFT_NODE_NAME:"productContentLeft",POPUP_CONTENT_NODE_NAME:"popupLayeredContent",reviewVotePopup:{VOTE_POPUP_MAIN_CONTENT_NODE_NAME:"votePopupMainContent"},reviewReportPopup:{PANEL_NODE_NAME:"productReviewReportingPanel",REPORT_THIS_REVIEW_BUTTON_NODE_NAME:"reportThisReviewButton"},badgeDescriptionPopup:{BADGE_DESCRIPTION_NODE_NAME:"badgeDescriptionSection",BADGE_NAME_CONTENT_NODE_NAME:"badgeNameContent",BADGE_NAME_SECTION_NODE_NAME:"badgeNameSection",BADGE_SPACER_SECTION_NODE_NAME:"badgeSpacerContent",BADGE_MAIN_NODE_NAME:"badgeHoverMain"}},image:{IMAGE_PATH:"/gid/assets/browse/productReviews/en/",PR_FEED_IMAGE_PATH:"",DEFAULT_AVATAR_IMAGE:"default_profile.gif",DEFAULT_AVATAR_LARGE_IMAGE:"default_profile_80x80.gif",TICK_MARK:"vote_tickmark.gif",SOLD_OUT_IMAGE:"sold_out.gif",star:{FULL:"star_full.gif",HALF:"star_half.gif",EMPTY:"star_empty.gif"}},messages:{}},constructors:{ProductReview:{},CustomerReview:{},ReviewAttribute:{},ReviewProfile:{},ReviewProfileBadge:{},FitType:{}}}
var productReviewService=new ProductReviewService();productReviewService.constructors.ProductReview=Class.create();productReviewService.constructors.ProductReview.prototype={initialize:function(){},productName:null,prPageId:null,productId:null,locale:null,fitSummary:{fitTypes:[],fitTypesMap:null},reviewSummary:{newestReviewDate:null,oldestReviewDate:null,averageOverallRating:null,fullReviewCount:null,totalReviewCount:null},customerReviews:[],customerReviewsMap:null}
productReviewService.constructors.ReviewAttribute=Class.create();productReviewService.constructors.ReviewAttribute.prototype={initialize:function(){},nameCode:null,valueCode:null,valueText:null,attributeCount:null}
productReviewService.constructors.ReviewProfileBadge=Class.create();productReviewService.constructors.ReviewProfileBadge.prototype={initialize:function(){},badgeCode:null,badgeName:null,badgeImageUrl:null,badgeDescription:null}
productReviewService.constructors.ReviewProfile=Class.create();productReviewService.constructors.ReviewProfile.prototype={initialize:function(){},prProfileId:null,prMerchantUserId:null,customerToken:null,customerName:null,customerLocation:null,avatarUri:null,badges:[],badgesMap:null,reviewProfileAttributes:[],numberOfReviews:null,customerReviews:[],customerReviewsMap:null,voteSummary:{totalHelpfulVotes:null,totalNotHelpfulVotes:null,totalVotes:null}}
productReviewService.constructors.CustomerReview=Class.create();productReviewService.constructors.CustomerReview.prototype={initialize:function(){},prReviewId:null,prPageId:null,prPageIdVariant:null,productId:null,productColorCode:null,createdDate:null,helpfulVotes:null,notHelpfulVotes:null,totalVotes:null,headline:null,overallRating:null,comments:null,customerReviewAttributes:[],reviewProfile:null,productName:null,productBrand:null,productImageUrl:null,badgePriority:0,helpfulValue:function(){var totalVotes=parseFloat(this.totalVotes);if(totalVotes===0){return 0;}
var helpfulPercentage=parseFloat(this.helpfulVotes)/totalVotes;if(helpfulPercentage>0.39){return Math.round(helpfulPercentage*parseFloat(this.helpfulVotes)*100)/100;}else{return 0;}}}
productReviewService.constructors.FitType=Class.create();productReviewService.constructors.FitType.prototype={initialize:function(){},fitTypeCode:null,fitTypeName:null,totalVotes:null,largestVoteCount:null,largestVoteName:null,largestVoteKey:null,voteSummaryAttributes:[]}
Object.extend(productReviewService.controller.init,{main:function(){productReviewService.controller.reportingManager.setBvProductReviewsProcessingStartTime();if(typeof productReviewService.constants.bvReviews!=='undefined'){var bvReviewsEnabled=productReviewService.constants.bvReviews.BV_REVIEW_ENABLED;var legacyStyleColor=productReviewService.constants.legacyStyleColor.BV_LEGACY_STYLECOLOR;var marketCode=productReviewService.constants.marketCode.MARKET_CODE;if(bvReviewsEnabled==='true'){var productStyleColorId="";if(productPage&&productPage.activeColor!=null&&productPage.objV&&productPage.objV.arrayVariantStyleColors){productStyleColorId=productPage.objV.arrayVariantStyleColors[productPage.selectedColor].strColorCodeId;if(marketCode=='EU'){productStyleColorId=legacyStyleColor;}}
$BV.configure('global',{productId:productStyleColorId,events:{bvRender:function(data){BV.require(['jquery'],function($){$('#event-bvRender').append('<p>'+data.method+'</p>');var totalReviewCount=data.TotalReviewCount;if(totalReviewCount>0){jQuery("#BVRRContainer").show();}});}}});$BV.ui('rr','show_reviews',{});}}
productReviewService.controller.reportingManager.setBvProductReviewsProcessingEndTime();productReviewService.controller.reportingManager.setProductReviewServiceStartTime();var pageType=productReviewService.controller.pageType;var pageTypeConstants=productReviewService.constants.pageType;if(pageType==pageTypeConstants.PRODUCT){if(productReviewService.constants.productReview.MOST_RECENT_SORT_ORDER){productReviewService.constants.productReview.DEFAULT_SORT_BY=productReviewService.constants.productReview.sortByKeys.SORT_BY_MOST_RECENT;}else{productReviewService.constants.productReview.DEFAULT_SORT_BY=productReviewService.constants.productReview.sortByKeys.SORT_BY_MOST_HELPFUL;}}
productReviewService.controller.init.data();},data:function(){var pageType=productReviewService.controller.pageType;productReviewService.controller.dataLoadManager.setDataUrls(pageType);productReviewService.controller.init.postDataLoad();},postDataLoad:function(){var isProductPage=(productReviewService.controller.pageType==productReviewService.constants.pageType.PRODUCT);if(isProductPage){productReviewService.controller.init.view();productReviewService.controller.reportingManager.setProductReviewServiceEndTime();productPage.callProductPageReportingService(false);}else{productReviewService.controller.init.view();productReviewService.controller.reportingManager.setProductReviewServiceEndTime();parent.productReviewService.utils.reSizeProfilePopup();}},view:function(){var pageType=productReviewService.controller.pageType;var currentControllerManagerName=null;if(pageType!=null){currentControllerManagerName=pageType+"Manager";if(productReviewService.controller[currentControllerManagerName]){productReviewService.controller[currentControllerManagerName].init.main();}}}});Object.extend(productReviewService.controller.externalOverrides,{showProductReviews:true,isFitOverrideEnabled:false,maxFits:0,isTagOverrideEnabled:false,maxTags:0});Object.extend(productReviewService.controller.dataLoadManager,{ModelDataBuilder:{constants:{XML_NAMESPACE_REVIEW:"pr:",XML_NAMESPACE_PROFILE:"pfr:",BUILDING_AGGREGATES:"summary",BUILDING_CUST_REVIEW:"customer_review",BUILDING_PROFILE:"profile"},namespacePrefix:null,formatDate:function(date){if(date){var d=date.split("-");var y=d.splice(0,1);d.push(y);return d.join("-");}},mapData:function(){var rawData=productReviewService.model.rawData;var pageType=productReviewService.controller.pageType;if(rawData){if(pageType==productReviewService.constants.pageType.PRODUCT){this.namespacePrefix=this.constants.XML_NAMESPACE_REVIEW;productReviewService.model.data.productReviews.push(this.mapProductReviewData(rawData));this.checkDataLoadStatus();}
else if(pageType==productReviewService.constants.pageType.PROFILE){this.namespacePrefix=this.constants.XML_NAMESPACE_PROFILE;productReviewService.model.data.reviewProfiles.push(this.mapReviewProfileData(rawData));}}},checkDataLoadStatus:function(){var productReviews=productReviewService.model.data.productReviews[0];productReviewService.model.data.isAllDataLoaded=(productReviews.customerReviews.length==parseInt(productReviews.reviewSummary.fullReviewCount,10));},mapReviewProfileData:function(profile){var reviewProfile=new productReviewService.constructors.ReviewProfile();reviewProfile.prProfileId=profile[this.namespacePrefix+"id"];reviewProfile.prMerchantUserId=profile[this.namespacePrefix+"merchantuserid"];reviewProfile.customerToken=profile[this.namespacePrefix+"merchantuserid"];reviewProfile.customerName=profile[this.namespacePrefix+"name"];reviewProfile.customerLocation=profile[this.namespacePrefix+"location"];var prFeedImagePath=productReviewService.constants.image.PR_FEED_IMAGE_PATH;var prAvatarUri=profile[this.namespacePrefix+"avatar_uri"];if(prAvatarUri){reviewProfile.avatarUri=prFeedImagePath+prAvatarUri;}
reviewProfile.numberOfReviews=profile[this.namespacePrefix+"num_reviews"];reviewProfile.comments=profile[this.namespacePrefix+"comments"];var badges=[];var badgesMap={};if(profile[this.namespacePrefix+"badges"]&&profile[this.namespacePrefix+"badges"][this.namespacePrefix+"badge"]){var badgeNodes=profile[this.namespacePrefix+"badges"][this.namespacePrefix+"badge"];if(badgeNodes instanceof Array){$A(badgeNodes).each(function(badge){var badgeObj=this.createReviewProfileBadge(badge);badges.push(badgeObj);badgesMap[badgeObj.badgeCode]=badgeObj;}.bind(this));}
else{var badgeObj=this.createReviewProfileBadge(badgeNodes);badges.push(badgeObj);badgesMap[badgeObj.badgeCode]=badgeObj;}}
reviewProfile.badges=badges;reviewProfile.badgesMap=badgesMap;if(productReviewService.controller.pageType==productReviewService.constants.pageType.PROFILE){var reviewProfileAttributes=[];var reviewProfileAttributesMap={};if(profile[this.namespacePrefix+"taggroups"]&&profile[this.namespacePrefix+"taggroups"][this.namespacePrefix+"taggroup"]){var tagGroupNodes=profile[this.namespacePrefix+"taggroups"][this.namespacePrefix+"taggroup"];if(tagGroupNodes instanceof Array){$A(tagGroupNodes).each(function(tagGroup){var reviewProfileAttributesObj=this.mapReviewAttributes(tagGroup,this.constants.BUILDING_PROFILE);reviewProfileAttributes.push(reviewProfileAttributesObj);reviewProfileAttributesMap[reviewProfileAttributesObj.nameCode]=reviewProfileAttributesObj;}.bind(this));}
else{var reviewProfileAttributesObj=this.mapReviewAttributes(tagGroupNodes,this.constants.BUILDING_PROFILE);reviewProfileAttributes.push(reviewProfileAttributesObj);reviewProfileAttributesMap[reviewProfileAttributesObj.nameCode]=reviewProfileAttributesObj;}}
reviewProfile.reviewProfileAttributes=reviewProfileAttributes;reviewProfile.reviewProfileAttributesMap=reviewProfileAttributesMap;reviewProfile.voteSummary.totalHelpfulVotes=profile[this.namespacePrefix+"totalhelpfulvotes"];reviewProfile.voteSummary.totalNotHelpfulVotes=profile[this.namespacePrefix+"totalnothelpfulvotes"];reviewProfile.voteSummary.totalVotes=profile[this.namespacePrefix+"total_votes"];var customerReviewsData=this.mapCustomerReviews(profile);reviewProfile.customerReviews=customerReviewsData.array;reviewProfile.customerReviewsMap=customerReviewsData.hash;}
return reviewProfile;},createReviewProfileBadge:function(badge){var reviewProfilebadge=new productReviewService.constructors.ReviewProfileBadge();reviewProfilebadge.badgeCode=badge[this.namespacePrefix+"type"];if(reviewProfilebadge.badgeCode){var badgeKey=productReviewService.utils.getConstantKey(reviewProfilebadge.badgeCode);var constants=productReviewService.constants;reviewProfilebadge.badgeName=constants.profileBadge.badgeNames[badgeKey];reviewProfilebadge.badgeImageUrl=constants.image.IMAGE_PATH+constants.profileBadge.badgeImages[badgeKey];reviewProfilebadge.badgeDescription=constants.profileBadge.badgeDescriptions[badgeKey];}
return reviewProfilebadge;},mapProductReviewData:function(rawData){var productReview=new productReviewService.constructors.ProductReview();productReview.productName=rawData[this.namespacePrefix+"name"];productReview.productBrand=rawData[this.namespacePrefix+"brand"];productReview.prPageId=rawData[this.namespacePrefix+"pageid"];productReview.productId=rawData[this.namespacePrefix+"pageid"];productReview.locale=rawData["@locale"];productReview.reviewSummary.newestReviewDate=this.formatDate(rawData[this.namespacePrefix+"newestreviewdate"]);productReview.reviewSummary.oldestReviewDate=this.formatDate(rawData[this.namespacePrefix+"oldestreviewdate"]);productReview.reviewSummary.averageOverallRating=rawData[this.namespacePrefix+"averageoverallrating"];productReview.reviewSummary.fullReviewCount=rawData[this.namespacePrefix+"full_review_count"];productReview.reviewSummary.totalReviewCount=rawData[this.namespacePrefix+"total_review_count"];var tagGroupData=this.getSummaryTagGroups(rawData);productReview.fitSummary.fitTypes=tagGroupData.fit.array;productReview.fitSummary.fitTypesMap=tagGroupData.fit.hash;productReview.fitSummary.tagTypes=tagGroupData.tag.array;productReview.fitSummary.tagTypesMap=tagGroupData.tag.hash;var customerReviews=this.mapCustomerReviews(rawData);productReview.customerReviews=customerReviews.array;productReview.customerReviewsMap=customerReviews.hash;return productReview;},mapCustomerReviews:function(rawData){var customerReviews=[];var customerReviewsMap={};if(rawData&&rawData[this.namespacePrefix+"reviews"]&&rawData[this.namespacePrefix+"reviews"][this.namespacePrefix+"fullreview"]){var fullReviews=rawData[this.namespacePrefix+"reviews"][this.namespacePrefix+"fullreview"];if(fullReviews instanceof Array){$A(fullReviews).each(function(fullReview){var customerReview=this.createCustomerReview(fullReview);customerReviews.push(customerReview);customerReviewsMap[customerReview.prReviewId]=customerReview;}.bind(this));}else{var customerReview=this.createCustomerReview(fullReviews);customerReviews.push(customerReview);customerReviewsMap[customerReview.prReviewId]=customerReview;}}
return{array:customerReviews,hash:customerReviewsMap};},getSummaryTagGroups:function(rawData){var tagGroupsOutput={fit:{array:[],hash:{}},tag:{array:[],hash:{}}};var rawDataTagGroups=rawData[this.namespacePrefix+"taggroups"];if(rawDataTagGroups){var rawDataTagGroup=rawDataTagGroups[this.namespacePrefix+"taggroup"];if(rawDataTagGroup){var fitTypeIterator=function(tagGroup){var fitType=new productReviewService.constructors.FitType();var tagGroupType=tagGroup["@tagGroupType"];fitType.fitTypeCode=tagGroup["@name"];fitType.fitTypeName=tagGroup["@name"];fitType.totalVotes=tagGroup[this.namespacePrefix+"total_votes"];fitType.largestVoteCount=tagGroup[this.namespacePrefix+"largest_vote_count"];fitType.largestVoteKey=tagGroup[this.namespacePrefix+"largest_vote"];fitType.voteSummaryAttributes=this.mapReviewAttributes(tagGroup,this.constants.BUILDING_AGGREGATES,fitType);tagGroupsOutput[tagGroupType].array.push(fitType);tagGroupsOutput[tagGroupType].hash[fitType.fitTypeCode]=fitType;}.bind(this);if(rawDataTagGroup instanceof Array){var tagGroupsArray=$A(rawDataTagGroup);tagGroupsArray.each(fitTypeIterator);}else{fitTypeIterator(rawDataTagGroup);}}}
return tagGroupsOutput;},mapReviewAttributes:function(tagGroup,buildingWhat,fitType){if(tagGroup[this.namespacePrefix+"tag"]instanceof Array){var reviewAttributes=[];tagGroup[this.namespacePrefix+"tag"].each(function(tag){reviewAttributes.push(this.createReviewAttribute(tag,tagGroup,buildingWhat,fitType));}.bind(this));return reviewAttributes;}else{return this.createReviewAttribute(tagGroup[this.namespacePrefix+"tag"],tagGroup,buildingWhat,fitType);}},createReviewAttribute:function(tag,tagGroup,buildingWhat,fitType){var reviewAttribute=new productReviewService.constructors.ReviewAttribute();if(tag&&tagGroup){reviewAttribute.nameCode=tagGroup["@name"];reviewAttribute.valueCode=tag["#text"];var isUserAdded=tag["@isuseradded"];if(reviewAttribute.valueCode==null&&isUserAdded=="true"){reviewAttribute.valueCode=reviewAttribute.nameCode;}
reviewAttribute.valueText=tag["#text"];if(buildingWhat==this.constants.BUILDING_AGGREGATES){reviewAttribute.attributeCount=tag["@count"];if(fitType!=null&&fitType.largestVoteKey==reviewAttribute.valueCode){fitType.largestVoteName=reviewAttribute.valueText;}}}
return reviewAttribute;},getReviewTagGroups:function(fullReview){var customerReviewAttributes={fitAttributes:[],tagAttributes:[]};var fullReviewTagGroups=fullReview[this.namespacePrefix+"taggroups"];if(fullReviewTagGroups){var fullReviewTagGroup=fullReviewTagGroups[this.namespacePrefix+"taggroup"];if(fullReviewTagGroup){var tagGroupIterator=function(tagGroup){var type=tagGroup["@tagGroupType"];if(!type)type="fit";customerReviewAttributes[type+"Attributes"].push(this.mapReviewAttributes(tagGroup,this.constants.BUILDING_CUST_REVIEW));}.bind(this);if(fullReviewTagGroup instanceof Array){$A(fullReviewTagGroup).each(tagGroupIterator);}else{var type=fullReviewTagGroup["@tagGroupType"];if(!type)type="fit";customerReviewAttributes[type+"Attributes"].push(this.mapReviewAttributes(fullReviewTagGroup,this.constants.BUILDING_CUST_REVIEW));}}}
return customerReviewAttributes;},createCustomerReview:function(fullReview){var customerReview=new productReviewService.constructors.CustomerReview();customerReview.prReviewId=fullReview[this.namespacePrefix+"id"];customerReview.prPageId=fullReview[this.namespacePrefix+"pageid"];customerReview.prPageIdVariant=fullReview[this.namespacePrefix+"pageid_variant"];customerReview.productId=fullReview[this.namespacePrefix+"pageid"];customerReview.businessUnit=fullReview[this.namespacePrefix+"businessunit"];customerReview.productColorCode=fullReview[this.namespacePrefix+"pageid_variant"];customerReview.createdDate=this.formatDate(fullReview[this.namespacePrefix+"createddate"]);customerReview.helpfulVotes=fullReview[this.namespacePrefix+"helpfulvotes"];customerReview.notHelpfulVotes=fullReview[this.namespacePrefix+"nothelpfulvotes"];customerReview.totalVotes=fullReview[this.namespacePrefix+"total_votes"];customerReview.headline=fullReview[this.namespacePrefix+"headline"];customerReview.overallRating=fullReview[this.namespacePrefix+"overallrating"];customerReview.comments=fullReview[this.namespacePrefix+"comments"];customerReview.customerReviewAttributes=this.getReviewTagGroups(fullReview);if(productReviewService.controller.pageType==productReviewService.constants.pageType.PRODUCT){customerReview.reviewProfile=this.mapReviewProfileData(fullReview[this.namespacePrefix+"profile"]);customerReview.badgePriority=this.getBadgePriority(customerReview);}
if(fullReview[this.namespacePrefix+"product"]){var product=fullReview[this.namespacePrefix+"product"];customerReview.productName=product[this.namespacePrefix+"name"];customerReview.productBrand=product[this.namespacePrefix+"brand"];customerReview.productImageUrl=product[this.namespacePrefix+"image_url"];}
return customerReview;},getBadgePriority:function(customerReview){var badgePriority=0;if(customerReview){var weightOfHelpfulNess=(0.001*parseInt(customerReview.helpfulVotes,10));if(!isNaN(weightOfHelpfulNess)){badgePriority=weightOfHelpfulNess;}
var badges=customerReview.reviewProfile!=null?customerReview.reviewProfile.badges:null;if(badges){var badgePriorityConstants=productReviewService.constants.profileBadge.badgePriority;var badgeIterator=function(badge){var badgeKey=productReviewService.utils.getConstantKey(badge.badgeCode);return badgePriorityConstants[badgeKey];};var numberOfBadges=badges.length;if(numberOfBadges>0){var weightOfBadges=numberOfBadges==1?0:(0.1*numberOfBadges);badgePriority=badgePriority+badges.max(badgeIterator)+weightOfBadges;}}}
return badgePriority;}},setDataUrls:function(pageType){var dataLoadManager=productReviewService.controller.dataLoadManager;var fileUrl="";var paginatedFileUrl="";if(pageType==productReviewService.constants.pageType.PRODUCT){var productId=productPage.productId;var baseUrl=productReviewService.constants.JSON_DATA_PATH+productId.substring(0,3)+"/"+productId.substr(3)+"/product_review_"+productId;fileUrl=baseUrl+".js";paginatedFileUrl=baseUrl+"_paginated.js";}else if(pageType==productReviewService.constants.pageType.PROFILE){var reviewerId=gidLib.getQuerystringParam("reviewerId");var reviewerFullId=("0").times(10-reviewerId.length)+reviewerId;var baseUrl=productReviewService.constants.JSON_DATA_PATH+reviewerFullId.match(/.{2}/g).join("/")+"/reviewer_profile_"+reviewerId;fileUrl=baseUrl+".js";paginatedFileUrl=baseUrl+"_paginated.js";}
productReviewService.model.data.dataFileUrl=fileUrl;productReviewService.model.data.paginatedDataFileUrl=paginatedFileUrl;},loadData:function(){new Ajax.Request(productReviewService.model.data.dataFileUrl,{method:"get",onComplete:this.parseDataResponse.bind(this)});},parseDataResponse:function(transport){var response=null;var responseJSON=null;response=transport.responseText.replace(/(\n|\r)/g,"");try{responseJSON=response.evalJSON(clientBrowser.userAgent.indexOf('Safari')<0);if(responseJSON){productReviewService.model.rawData=responseJSON;productReviewService.controller.dataLoadManager.ModelDataBuilder.mapData();}}catch(e){}
productReviewService.controller.init.postDataLoad();},loadPaginatedData:function(args){productReviewService.model.data.isDataLoading=true;gidLib.inProgressIndicator.open({targetElement:productReviewService.constants.nodeNames.reviewDetails.REVIEW_SECTION_ROOT_NODE_NAME});var onCompleteHandler=function(){var callBack=arguments[0];var transport=arguments[1];this.parsePaginatedDataResponse(transport,callBack);};new Ajax.Request(productReviewService.model.data.paginatedDataFileUrl,{method:"get",onComplete:onCompleteHandler.bind(this,args)});},parsePaginatedDataResponse:function(transport,callBack){var response=null;var responseJSON=null;response=transport.responseText.replace(/(\n|\r)/g,"");try{responseJSON=response.evalJSON(clientBrowser.userAgent.indexOf('Safari')<0);if(responseJSON){var customerReviews=productReviewService.controller.dataLoadManager.ModelDataBuilder.mapCustomerReviews(responseJSON);var productReview=productReviewService.model.data.productReviews[0];productReview.customerReviews=productReview.customerReviews.concat(customerReviews.array);Object.extend(productReview.customerReviewsMap,customerReviews.hash);productReviewService.model.data.isDataLoading=false;productReviewService.model.data.isAllDataLoaded=true;productReviewService.controller.productManager.view.productReviewDetails.setDataToPage();gidLib.inProgressIndicator.close();if(callBack&&callBack.callBackMethod)callBack.callBackMethod(callBack.callBackArgs);}}catch(e){e;}}});Object.extend(productReviewService.controller.productManager,{init:{main:function(){if(productReviewService.controller.externalOverrides.showProductReviews==true){if(productReviewService.model.rawData!=null){productReviewService.controller.productManager.initVariableReferenceDelegator();if(productReviewService.constants.bvReviews.BV_REVIEW_ENABLED!="true"){productReviewService.controller.productManager.view.showProductReviewElementsOnPage();productReviewService.controller.productManager.view.setDataToPage();}}}}},initVariableReferenceDelegator:function(){productReviewService.controller.productManager.view.productReviewSummary.initVariableReferences();productReviewService.controller.productManager.view.productReviewDetails.initVariableReferences();},view:{templates:{LABEL_DISPLAY_TEMPLATE:new Template("#{labelName}: "),REVIEW_SUMMARY_WRITE_REVIEW_LINK_TEMPLATE:new Template('<a href="#" onclick="return #{writeAReviewHandler}();">#{writeAReview}</a>'+' | '+'<a href="#" onclick="return #{seeAllReviewsHandler}();">#{seeAllReviews}</a>'),REVIEW_SUMMARY_FIRST_REVIEW_LINK_TEMPLATE:new Template('<a href="#" onclick="return #{writeAReviewHandler}();">#{writeAReview}</a>'+'<br>'+'<span id="reviewLinksText">#{firstReview}</span>'),REVIEW_SUMMARY_FIT_TEMPLATE:new Template('<div class="fitFinish clearfix">'+'<div id="reviewSummaryFitTitle#{i}" class="reviewSummaryFitTitle">#{reviewFitTitle}</div>'+'<div id="reviewSummaryFitBody#{i}" class="reviewSummaryFitBody"><a id="reviewFitSummaryLink" href="#" onclick="return #{onClickHandler}(event);" onmouseover="#{onMouseOverHandler}(event,#{fitTypeHandlerKey});" onmouseout="#{onMouseOutHandler}(event);">'+'#{reviewFitSummary} #{reviewFitLargestVoteName}'+'</a></div>'+'</div>'),REVIEW_SUMMARY_REVIEW_TAG_TEMPLATE:new Template('<div class="fitFinish clearfix">'+'<div id="reviewSummaryTagTitle#{i}" class="reviewSummaryFitTitle">#{reviewTagsTitle}</div>'+'<div id="reviewSummaryTagBody#{i}" class="reviewSummaryFitBody">#{attributeMarkup}</div>'+'</div>'),REVIEW_SUMMARY_REVIEW_TAG_ATTRIBUTE_TEMPLATE:new Template('#{name} <span class="reviewSummaryTagAttributeCount">(#{count})</span>'),REVIEW_DETAILS_MAIN_TEMPLATE:new Template('<li id="productReview#{reviewId}" class="productReview">'+'<div id="productReviewData#{reviewId}" class="productReviewData clearfix">'+'<div id="reviewerProfile#{reviewId}" class="reviewerProfile">'+'<div id="reviewerName#{reviewId}">#{nameMarkup}</div>'+'<div id="reviewerLocation#{reviewId}">#{locationMarkup}</div>'+'<div id="reviewerBadges#{reviewId}" class="reviewerBadges">#{reviewerBadgeMarkup}</div>'+'<div id="reviewerReviews#{reviewId}" class="reviewerReviews">'+'<a href="#{reviewerProfileUrl}" onclick="return #{reviewerProfilePopupHandler}(this,\'#{reviewerId}\');">#{seeAllReviews}</a>'+'</div>'+'</div>'+'<div id="productReviewBody#{reviewId}" class="productReviewBody">'+'<div id="productReviewDetails#{reviewId}" class="productReviewDetails">'+'<div class="productReviewDetailsTop clearfix">'+'<div class="productReviewStarsContainer">#{reviewStarMarkup}</div>'+'<div id="productReviewHeadline#{reviewId}" class="productReviewHeadline reviewBrandSpecificText"><span class="cssHide">#{reviewHeadlineLabel}</span>#{reviewHeadline}</div>'+'<div id="productReviewDate#{reviewId}" class="productReviewDate"><span class="cssHide">#{reviewDateLabel}</span>#{reviewDate}</div>'+'</div>'+'<div id="productReviewComment#{reviewId}" class="productReviewComment"><span class="cssHide">#{reviewCommentLabel}</span>#{reviewComment}</div>'+'#{fitDetailsMarkup}'+'<div id="productReviewVote#{reviewId}" class="productReviewVote">'+'<div id="productReviewHelpful#{reviewId}" class="productReviewHelpful reviewBrandSpecificText">#{votesMarkup}</div>'+'<span id="productReviewVoteYesNo#{reviewId}" class="productReviewVoteYesNo">'+'#{voteLabel} <a id="#{voteYes}#{reviewId}" href="#" onclick="return productReviewService.controller.productManager.view.handlers.productReviewVoteYes(this,\'#{reviewId}\');">#{voteYes}</a> |'+' <a id="#{voteNo}#{reviewId}" href="#" onclick="return productReviewService.controller.productManager.view.handlers.productReviewVoteNo(this,\'#{reviewId}\');">#{voteNo}</a>'+'</span> | '+'<span id="productReviewReportLink#{reviewId}" class="productReviewReportLink"><a id="productReviewReportLinkText#{reviewId}" href="#" onclick="return productReviewService.controller.productManager.view.handlers.productReviewReport(this,\'#{reviewId}\');">#{reportThis}</a></span>'+'</div>'+'</div>'+'</div>'+'</div>'+'</li>'),REVIEW_DETAILS_NAME_TEMPLATE:new Template('<span id="reviewerName#{reviewId}" class="reviewerName">#{reviewerName}</span>'),REVIEW_DETAILS_LOCATION_TEMPLATE:new Template('<span id="reviewerLocation#{reviewId}" class="reviewerLocation">#{reviewerLocation}</span>'),REVIEW_DETAILS_HELPFUL_VOTE_TEMPLATE:new Template('<span id="productReviewHelpfulVotes#{reviewId}" class="productReviewHelpfulVotes">#{helpfulVoteNumber}</span>'),REVIEW_DETAILS_TOTAL_VOTE_TEMPLATE:new Template('<span id="productReviewTotalVotes#{reviewId}" class="productReviewTotalVotes">#{totalVoteNumber}</span>'),REVIEW_DETAILS_BADGE_TEMPLATE:new Template('<img id="reviewer#{reviewId}Badge#{badgeNo}" class="reviewerBadge #{reviewerBadgeType}" '+'src="/assets/common/clear.gif" onmouseover='+'"productReviewService.controller.productManager.view.handlers.launchBadgeDescription(this, \'#{badgeCode}\', \'left\');" onmouseout="productReviewService.controller.productManager.view.handlers.hideBadgeDescription();"/>'+'<span class="cssHide">#{reviewerBadgeAlt}</span>'+'#{divider}'),REVIEW_DETAILS_BADGE_DIVIDER_TEMPLATE:'<div class="reviewerBadgeDivider">|</div>',REVIEW_DETAILS_SEE_ALL_REVIEWS_TEMPLATE:new Template('#{text}<br/>(#{number})'),REVIEW_SUMMARY_FITTYPE_CONTENT_TEMPLATE:new Template('<div class="reviewFitAttributeContainer #{largest} clearfix">'+'<div class="reviewFitAttributeName">#{name}</div>'+'<div class="reviewFitAttributeBarContent">'+'<div class="reviewFitAttributeBarBackground">'+'<div class="reviewFitAttributeBar" style="width:#{bar}px;"></div>'+'</div>'+'<div class="reviewFitAttributeCount" style="left:#{countX}px;">#{count}</div>'+'</div>'+'</div>'),PROFILE_ATTRIBUTE_TEMPLATE:new Template('<div class="profileAttributeTitle">'+'#{profileAttributeTitle}'+'<span class="profileAttributeDescription">#{profileAttributeDetails}</span>'+'</div>')},handlers:{launchWriteAReviewForm:function(){productReviewService.utils.submitReview();return false;},launchReviewerProfile:function(element,reviewerId){productReviewService.utils.launchReviewerProfile(element,reviewerId);return false;},closeReviewerProfileLayeredPopup:function(){return gidLib.layeredPopup.closeLayeredPopup();},launchBadgeDescription:function(badgeElement,badgeCode,panelAlignment){productReviewService.utils.badgeDetailsDisplay.launchBadgeDescription(badgeElement,badgeCode,panelAlignment);},hideBadgeDescription:function(){if(gidLib.layeredPopup.popupId=="badgeDescriptionHover")gidLib.layeredPopup.closeLayeredPopup();return false;},seeAllReviews:function(){productReviewService.controller.productManager.view.productReviewDetails.handlers.seeAllReviews();return false;},productReviewVoteYes:function(element,reviewId){productReviewService.controller.productManager.view.productReviewDetails.handlers.productReviewVote(element,productReviewService.constants.messages.reviewDetails.REVIEW_DETAILS_VOTE_YES,reviewId);return false;},productReviewVoteNo:function(element,reviewId){productReviewService.controller.productManager.view.productReviewDetails.handlers.productReviewVote(element,productReviewService.constants.messages.reviewDetails.REVIEW_DETAILS_VOTE_NO,reviewId);return false;},productReviewReport:function(element,reviewId){productReviewService.controller.productManager.view.productReviewDetails.handlers.launchProductReviewReport(element,reviewId);return false;},sortProductReviews:function(){productReviewService.controller.productManager.view.productReviewDetails.handlers.sortProductReviews();},sendProductReviewReport:function(){var reviewId=$A(arguments)[0];productReviewService.controller.productManager.view.productReviewDetails.handlers.sendProductReviewReport(reviewId);return false;},reviewsPaginationHandler:function(pageId){productReviewService.controller.productManager.view.productReviewDetails.handlers.reviewsPaginationHandler(pageId);return false;}},showProductReviewElementsOnPage:function(){var nodeNames=productReviewService.constants.nodeNames;$(nodeNames.reviewSummary.REVIEW_SUMMARY_ROOT_NODE_NAME,nodeNames.reviewDetails.REVIEW_DETAILS_ROOT_NODE_NAME).invoke("setStyle",{"display":"block"});$(nodeNames.reviewSummary.REVIEW_SUMMARY_ROOT_NODE_NAME,nodeNames.reviewDetails.REVIEW_DETAILS_ROOT_NODE_NAME).invoke("addClassName","clearfix");},setDataToPage:function(){productReviewService.controller.productManager.view.productReviewSummary.setDataToPage();productReviewService.controller.productManager.view.productReviewDetails.setDataToPage();productReviewService.utils.loadProfilePopupState();},callReviewVoteReportingService:function(reviewId){reportingService.controller.viewManagers['reviewsVoteViewManager'].controller.getReportRequest(reviewId);}}});Object.extend(productReviewService.controller.profileManager,{init:{main:function(){if(productReviewService.model.rawData!=null){productReviewService.controller.profileManager.initVariableReferenceDelegator();productReviewService.controller.profileManager.init.quickLook();productReviewService.controller.profileManager.view.setDataToPage();productReviewService.controller.profileManager.view.callProfileReportingService();}else{productReviewService.controller.profileManager.view.showErrorMessage();}},quickLook:function(){quickLook.initializeQuickLook();quickLook.launchQuickLook=productReviewService.controller.profileManager.view.handlers.launchQuickLookHandler;}},initVariableReferenceDelegator:function(){productReviewService.controller.profileManager.view.profileReviewSummary.initVariableReferences();productReviewService.controller.profileManager.view.profileReviewDetails.initVariableReferences();},view:{templates:{REVIEW_DETAILS_MAIN_TEMPLATE:new Template('<li id="reviewerReview#{reviewId}" class="productReview">'+'<div id="reviewerReviewContent#{reviewId}" class="productReviewContent clearfix">'+'<div id="productImageDisplay#{reviewId}" class="productImageDisplay">'+'<div id="productImageBorder#{reviewId}" class="productImageBorder">'+'<a href="#{productPageUrl}" target="_top" id="productAnchor#{reviewId}" class="clickDisabled" onclick="return productReviewService.controller.profileManager.view.handlers.launchProductPageHandler(this);">'+'#{productImageMarkup}'+'<span id="productVendorName#{reviewId}" class="productVendorName">#{productVendor}</span>'+'<span id="productName#{reviewId}">#{productName}</span>'+'</a>'+'</div>'+'<div class="outOfStockMsg" id="productOutOfStockMsg#{reviewId}" style="display:none">'+'<img src="#{soldOutImage}" alt="#{soldOutMsg}" />'+'</div>'+'<img src="#{productBusinessUnitBadge}" alt="#{productBrandName}" class="reviewsBrandBadge"/>'+'</div>'+'<div id="productReviewData#{reviewId}" class="productReviewData">'+'<div id="productReviewBody#{reviewId}" class="productReviewBody">'+'<div id="productReviewDetails#{reviewId}" class="productReviewDetails clearfix">'+'<div class="productReviewStarsContainer">#{reviewStarMarkup}</div>'+'<div id="productReviewHeadline#{reviewId}" class="productReviewHeadline"><span class="cssHide">#{reviewHeadlineLabel}</span>#{reviewHeadline}</div>'+'<div id="productReviewDate#{reviewId}" class="productReviewDate"><span class="cssHide">#{reviewDateLabel}</span>#{reviewDate}</div>'+'</div>'+'<div id="productReviewComment#{reviewId}" class="productReviewComment"><span class="cssHide">#{reviewCommentLabel}</span>#{reviewComment}</div>'+'#{fitDetailsMarkup}'+'<div id="productReviewVote#{reviewId}" class="productReviewVote">'+'<div id="productReviewHelpful#{reviewId}" class="productReviewHelpful">#{votesMarkup}</div>'+'</div>'+'</div>'+'</div>'+'</div>'+'</li>'),REVIEW_DETAILS_PRODUCT_IMAGE_TEMPLATE:new Template('<img class="productImage quickLookDisabled" id="productImage#{reviewId}" alt="#{productImageAtl}" src="#{productImageSrc}" '+'onmouseover="productReviewService.controller.profileManager.view.handlers.openQuickLookButtonHandler(this,\'#{reviewId}\',\'#{productId}\',\'#{productStyleColorId}\',\'#{businessUnit}\');" '+'onmouseout="productReviewService.controller.profileManager.view.handlers.closeQuickLookButtonHandler(event,this);" '+'/><br>'),REVIEW_DETAILS_HELPFUL_VOTE_TEMPLATE:new Template('<span id="productReviewHelpfulVotes#{reviewId}" class="productReviewHelpfulVotes">#{helpfulVoteNumber}</span>'),REVIEW_DETAILS_TOTAL_VOTE_TEMPLATE:new Template('<span id="productReviewTotalVotes#{reviewId}" class="productReviewTotalVotes">#{totalVoteNumber}</span>'),REVIEWER_BADGES_TEMPLATE:new Template('<img id="reviewer#{reviewId}Badge#{badgeNo}" class="reviewerBadge #{reviewerBadgeType}" '+'src="/assets/common/clear.gif" onmouseover='+'"productReviewService.controller.productManager.view.handlers.launchBadgeDescription(this, \'#{badgeCode}\', \'right\');" onmouseout="productReviewService.controller.productManager.view.handlers.hideBadgeDescription();"/>'+'<span class="cssHide">#{reviewerBadgeAlt}</span>'+'#{divider}'),REVIEW_DETAILS_BADGE_DIVIDER_TEMPLATE:'<div class="reviewerBadgeDivider">&nbsp;</div>'},handlers:{launchBadgeDescription:function(badgeElement,badgeCode,panelAlignment){productReviewService.utils.badgeDetailsDisplay.launchBadgeDescription(badgeElement,badgeCode,panelAlignment);},hideBadgeDescription:function(){return gidLib.layeredPopup.closeLayeredPopup();},reviewsPaginationHandler:function(pageId){productReviewService.controller.profileManager.view.profileReviewDetails.handlers.reviewsPaginationHandler(pageId);return false;},launchProductPageHandler:function(calleeElement){if(!($(calleeElement).hasClassName("clickDisabled"))){var reviewerId=productReviewService.model.data.reviewProfiles[0].prMerchantUserId;var productId=parent.productPage.objP.strProductId;productReviewService.utils.saveProfilePopupState(reviewerId,productId);parent.window.location.href=calleeElement.href;}
return false;},launchQuickLookHandler:function(){var quickLookTarget=quickLook.objQuickLookTarget;quickLookTarget.obj=parent.document.getElementById('productReviews');parent.document.getElementById("quickLookWindow").style.zIndex=100;parent.quickLook.objQuickLookTarget=quickLookTarget;parent.quickLook.launchQuickLook();$('quickLookLauncher').style.visibility="hidden";},openQuickLookButtonHandler:function(calleeElement,reviewId,pid,scid,businessUnit){if(!($(calleeElement).hasClassName("quickLookDisabled"))){var reviewsListNode=$(productReviewService.constants.nodeNames.profileDetails.REVIEWER_REVIEWS_LIST_NODE_NAME);var reviewsListOffsetY=Position.cumulativeOffset(reviewsListNode)[1];var reviewsListHeight=reviewsListNode.offsetHeight;var productImagePositionY=Position.page(calleeElement)[1];var quickLookButtonHeight=$('quickLookLauncher').offsetHeight;var quickLookOffset=quickLook.QUICKLOOKTARGETYPOS+quickLook.QuickLookBtnAdj[brandConst.BRAND_CODE];var quickLookButtonWontBeHidden=true;if(reviewsListOffsetY>productImagePositionY+quickLookOffset){quickLookButtonWontBeHidden=false;}else if(reviewsListOffsetY+reviewsListHeight<productImagePositionY+quickLookOffset+quickLookButtonHeight){quickLookButtonWontBeHidden=false;}
var customProperties={PRODUCTIMGWIDTH:90,PRODUCTIMGHEIGHT:120,QUICKLOOKTARGETXPOS:0,QUICKLOOKTARGETYPOS:80};if(quickLookButtonWontBeHidden)quickLook.openQuickLookLauncher(pid,scid,'',-1,'productImage'+reviewId,false,businessUnit,customProperties);}},closeQuickLookButtonHandler:function(event,calleeElement){if(!($(calleeElement).hasClassName("quickLookDisabled"))){quickLook.closeQuickLookLauncher(event);}}},setDataToPage:function(){productReviewService.controller.profileManager.view.profileReviewSummary.setDataToPage();productReviewService.controller.profileManager.view.profileReviewDetails.setDataToPage();},showErrorMessage:function(){$(productReviewService.constants.nodeNames.profileSummary.REVIEWER_ERROR_MESSAGE_NODE_NAME).setStyle({display:"block"});},callProfileReportingService:function(){reportingService.controller.viewManagers['reviewsProfileViewManager'].controller.getReportRequest();}}});Object.extend(productReviewService.controller.productManager.view,{productReviewSummary:{messages:null,nodeNames:null,fitTypeKeys:null,handlers:{fitHoverDisplay:function(event,fitTypeIndex){var data=productReviewService.model.data.productReviews[0];var nodeNames=productReviewService.controller.productManager.view.productReviewSummary.nodeNames;productReviewService.controller.productManager.view.productReviewSummary.setReviewFitHoverMarkup(data,fitTypeIndex)
var hoverElement=$(nodeNames.REVIEW_FIT_HOVER_NODE_NAME);var hoverDimensions=Element.getDimensions(hoverElement);var summaryElement=$(nodeNames.REVIEW_SUMMARY_ROOT_NODE_NAME);var summaryPosition=Position.cumulativeOffset(summaryElement);var sumamryDimensions=Element.getDimensions(summaryElement);var targetElement=Event.element(event);var targetDimensions=Element.getDimensions(targetElement);var targetPosition=Position.cumulativeOffset(targetElement);var newX=summaryPosition[0]+((sumamryDimensions.width-hoverDimensions.width-2)/2);var newY=targetPosition[1]-hoverDimensions.height-6;gidLib.setObjPosition(hoverElement,newX,newY);Element.show(hoverElement);},fitHoverHide:function(event){var nodeNames=productReviewService.controller.productManager.view.productReviewSummary.nodeNames;Element.hide($(nodeNames.REVIEW_FIT_HOVER_NODE_NAME));},focusFitHover:function(){var reviewFittypeHoverNode=$(productReviewService.controller.productManager.view.productReviewSummary.nodeNames.REVIEW_FIT_HOVER_NODE_NAME);if(reviewFittypeHoverNode&&reviewFittypeHoverNode.visible){productReviewService.utils.setFocus(reviewFittypeHoverNode);}}},initVariableReferences:function(){this.messages=productReviewService.constants.messages.reviewSummary;this.utils=productReviewService.utils;this.nodeNames=productReviewService.constants.nodeNames.reviewSummary;this.templates=productReviewService.controller.productManager.view.templates;},setDataToPage:function(){var data=productReviewService.model.data.productReviews[0];if(data!=null){this.setAverageRatingMarkup(data);this.setReviewFitMarkup(data);this.setReviewLinksMarkup(data);this.setReviewTagsMarkup(data);}},setAverageRatingMarkup:function(data){var reviewSummary=data['reviewSummary'];if(reviewSummary['averageOverallRating']>0){var data=this.utils.view.getStarRatingImageMarkup(reviewSummary['averageOverallRating']);$(this.nodeNames.STAR_RATING_NODE_NAME).update(data);var starRatingSmall=$(this.nodeNames.STAR_RATING_SMALL_NODE_NAME);if(starRatingSmall){starRatingSmall.update(data);}}
if(reviewSummary['totalReviewCount']>0){var reviewSummaryReviews=new Template(this.messages.REVIEW_SUMMARY_REVIEWS).evaluate({0:"<span id=\"reviewCount\">"+reviewSummary['totalReviewCount']})+"</span>";$(this.nodeNames.TOTAL_REVIEW_COUNT_NODE_NAME).update(reviewSummaryReviews);var totalCountSmall=$(this.nodeNames.TOTAL_REVIEW_COUNT_SMALL_NODE_NAME);if(totalCountSmall){totalCountSmall.update(reviewSummaryReviews);}}},setReviewFitMarkup:function(data){var reviewFitMarkups=[];var numberOfFits=data.fitSummary.fitTypes.size();var onClickHandler="productReviewService.controller.productManager.view.productReviewSummary.handlers.focusFitHover";var onMouseOverHandler="productReviewService.controller.productManager.view.productReviewSummary.handlers.fitHoverDisplay";var onMouseOutHandler="productReviewService.controller.productManager.view.productReviewSummary.handlers.fitHoverHide";var externalOverrides=productReviewService.controller.externalOverrides;if(externalOverrides.isFitOverrideEnabled==true)numberOfFits=Math.min(numberOfFits,externalOverrides.maxFits);for(var i=0;i<numberOfFits;i++){var fitTypeData=data.fitSummary.fitTypes[i];if(fitTypeData!=null&&fitTypeData['totalVotes']>0){var reviewTitle=this.getFormattedLabelName(fitTypeData.fitTypeName);var fitTypeHandlerKey=i;var reviewSummary=new Template(this.messages.REVIEW_FIT_SUMMARY).evaluate({0:fitTypeData['largestVoteCount'],1:fitTypeData['totalVotes']});var suggestedLargestVoteName=(fitTypeData['largestVoteName']).toLowerCase();var nodeId=productReviewService.utils.getFormattedNodeIdName(fitTypeData.fitTypeName);var reviewFitMarkup=productReviewService.controller.productManager.view.templates.REVIEW_SUMMARY_FIT_TEMPLATE.evaluate({i:nodeId,reviewFitTitle:reviewTitle,fitTypeHandlerKey:fitTypeHandlerKey,onClickHandler:onClickHandler,onMouseOverHandler:onMouseOverHandler,onMouseOutHandler:onMouseOutHandler,reviewFitSummary:reviewSummary,reviewFitLargestVoteName:suggestedLargestVoteName});reviewFitMarkups.push(reviewFitMarkup);}}
if(reviewFitMarkups.length>0){var reviewSummaryFitNode=$(this.nodeNames.REVIEW_SUMMARY_FIT_NODE_NAME);reviewSummaryFitNode.update(reviewFitMarkups.join(""));reviewSummaryFitNode.setStyle({"display":"block"});}},setReviewFitHoverMarkup:function(data,fitTypeIndex){var fitType=data.fitSummary.fitTypes[fitTypeIndex];if(fitType){var fitAttributes=fitType.voteSummaryAttributes;var totalVotes=fitType.totalVotes;var fitAttributeMarkup=[];var maxBarSize=100;var titleText=(new Template(this.messages.REVIEW_FIT_HOVER_TITLE)).evaluate({fit:fitType.fitTypeName.toLowerCase()});for(var i=0;i<fitAttributes.length;i++){var attributeCount=fitAttributes[i].attributeCount;var barLength=Math.round(attributeCount/totalVotes*maxBarSize);var markup=productReviewService.controller.productManager.view.templates.REVIEW_SUMMARY_FITTYPE_CONTENT_TEMPLATE.evaluate({name:fitAttributes[i].valueText,bar:barLength,count:attributeCount,countX:barLength+3,largest:(attributeCount==fitType.largestVoteCount?"highlighted":"")});fitAttributeMarkup.push(markup);}
$(this.nodeNames.REVIEW_FIT_HOVER_TITLE_NODE_NAME).update(titleText);$(this.nodeNames.REVIEW_FIT_HOVER_CONTENT_NODE_NAME).update(fitAttributeMarkup.join(""));}},setReviewLinksMarkup:function(data){var reviewLinksData=null;var template=null;var templateData={};var seeAllReviewsHandler="productReviewService.controller.productManager.view.handlers.seeAllReviews";if(data&&this.utils.hasCustomerReviews(data)){template=this.templates.REVIEW_SUMMARY_WRITE_REVIEW_LINK_TEMPLATE;templateData={writeAReviewHandler:productReviewService.constants.handlers.WRITE_A_REVIEW_HANDLER,writeAReview:productReviewService.constants.messages.reviewLinks.REVIEW_LINKS_WRITEAREVIEW,seeAllReviewsHandler:seeAllReviewsHandler,seeAllReviews:productReviewService.constants.messages.reviewLinks.REVIEW_LINKS_SEEALLREVIEWS};reviewLinksData=template.evaluate(templateData);}
else{reviewLinksData=productReviewService.utils.view.getFirstReviewMarkup();Element.hide($(productReviewService.constants.nodeNames.reviewDetails.REVIEW_DETAILS_ROOT_NODE_NAME));}
$(this.nodeNames.REVIEW_LINKS_NODE_NAME).update(reviewLinksData);},setReviewTagsMarkup:function(data){var reviewTagMarkup=[];var numberOfTags=data.fitSummary.tagTypes.size();var externalOverrides=productReviewService.controller.externalOverrides;if(externalOverrides.isTagOverrideEnabled==true)numberOfTags=Math.min(numberOfTags,externalOverrides.maxTags);for(var i=0;i<numberOfTags;i++){var tagType=data.fitSummary.tagTypes[i];if(tagType!=null){var tagName=this.getFormattedLabelName(tagType.fitTypeName);var voteSummaryAttributes=tagType.voteSummaryAttributes;if(voteSummaryAttributes instanceof Array==false)voteSummaryAttributes=[voteSummaryAttributes];var sortedAttributes=voteSummaryAttributes.sortBy(function(att){return-1*att.attributeCount;});var attributeMarkup=[];for(var j=0;j<2;j++){var attribute=sortedAttributes[j];if(attribute){attributeMarkup.push(productReviewService.controller.productManager.view.templates.REVIEW_SUMMARY_REVIEW_TAG_ATTRIBUTE_TEMPLATE.evaluate({name:attribute.valueText,count:attribute.attributeCount}));}}
var nodeId=tagType.fitTypeName.replace(/\s+/,"").replace(/\/+/,"");reviewTagMarkup.push(productReviewService.controller.productManager.view.templates.REVIEW_SUMMARY_REVIEW_TAG_TEMPLATE.evaluate({i:nodeId,reviewTagsTitle:tagName,attributeMarkup:attributeMarkup.join(", ")}));}}
if(reviewTagMarkup.length>0){var reviewSummaryTagsNode=$(this.nodeNames.REVIEW_TAGS_NODE_NAME);reviewSummaryTagsNode.update(reviewTagMarkup.join(""));reviewSummaryTagsNode.setStyle({"display":"block"});}},getFormattedLabelName:function(labelName){return this.templates.LABEL_DISPLAY_TEMPLATE.evaluate({"labelName":labelName});}}});Object.extend(productReviewService.controller.productManager.view,{productReviewDetails:{messages:null,templates:null,constants:null,utils:null,productReview:null,customerReviewData:null,selectedSortOption:0,pagedReviewsBySortOptionCache:{},initVariableReferences:function(){this.messages=productReviewService.constants.messages;this.templates=productReviewService.controller.productManager.view.templates;this.constants=productReviewService.constants;this.utils=productReviewService.utils.view;this.selectedSortOption=this.constants.productReview.DEFAULT_SORT_BY;},setDataToPage:function(){this.productReview=productReviewService.model.data.productReviews[0];var totalNumberOfReviews=this.productReview.reviewSummary.fullReviewCount;var allReviews=this.getSortedCustomerReviews();var reviewsPaging=productReviewService.utils.reviewsPaging;reviewsPaging.clearReviewsPagingCache();this.customerReviewData=reviewsPaging.paginate(allReviews,this.constants.reviewsPaging.REVIEWS_PER_PAGE_ON_PRODUCT,totalNumberOfReviews);this.setCustomerReviewsDataToPage();},setCustomerReviewsDataToPage:function(){var reviewListDisplayMarkup=this.buildReviewsListMarkup();$(this.constants.nodeNames.reviewDetails.REVIEW_LIST_DISPLAY_ROOT_NODE_NAME).update(reviewListDisplayMarkup);this.setPageLinksMarkup();},setPageLinksMarkup:function(){var pageHandler="productReviewService.controller.productManager.view.handlers.reviewsPaginationHandler";var reviewsPaginationMarkup=productReviewService.utils.reviewsPaging.getPaginationLinksMarkup(pageHandler);if(reviewsPaginationMarkup&&!reviewsPaginationMarkup.blank()){var pagingNodes=$$(this.constants.nodeNames.reviewDetails.REVIEW_DETAILS_PAGING_CLASS_NAME);pagingNodes.invoke("update",reviewsPaginationMarkup);pagingNodes.invoke("setStyle",{"display":"block"});}},buildReviewsListMarkup:function(){var customerReviewData=this.customerReviewData;var reviewListDisplayMarkup="";var mainTemplate=this.templates.REVIEW_DETAILS_MAIN_TEMPLATE;var votesTemplate=new Template(this.messages.reviewDetails.REVIEW_DETAILS_HELPFUL_OF_TOTAL);var nameTemplate=this.templates.REVIEW_DETAILS_NAME_TEMPLATE;var locationTemplate=this.templates.REVIEW_DETAILS_LOCATION_TEMPLATE;var helpfulVotesTemplate=this.templates.REVIEW_DETAILS_HELPFUL_VOTE_TEMPLATE;var totalVotesTemplate=this.templates.REVIEW_DETAILS_TOTAL_VOTE_TEMPLATE;var reviewerBadgeTemplate=this.templates.REVIEW_DETAILS_BADGE_TEMPLATE;var seeAllReviewsTemplate=this.templates.REVIEW_DETAILS_SEE_ALL_REVIEWS_TEMPLATE;var seeAllReviewsText=this.messages.reviewDetails.REVIEW_DETAILS_SEE_ALL_REVIEWS;var reviewerBadgeDividerMarkup=this.templates.REVIEW_DETAILS_BADGE_DIVIDER_TEMPLATE;var reviewHeadlineLabel=this.messages.reviewDetails.REVIEW_DETAILS_SUMMARY_LABEL;var reviewDateLabel=this.messages.reviewDetails.REVIEW_DETAILS_DATE_LABEL;var reviewCommentLabel=this.messages.reviewDetails.REVIEW_DETAILS_COMMENT_LABEL;var reportThis=this.messages.reviewDetails.REVIEW_DETAILS_REPORT_LINK;var voteLabel=this.messages.reviewDetails.REVIEW_DETAILS_VOTE_LABEL;var voteYes=this.messages.reviewDetails.REVIEW_DETAILS_VOTE_YES;var voteNo=this.messages.reviewDetails.REVIEW_DETAILS_VOTE_NO;var reviewForLabel=this.messages.reviewDetails.REVIEW_DETAILS_REVIEW_FOR_LABEL;var defaultAvatarImageSrc=this.constants.image.IMAGE_PATH+this.constants.image.DEFAULT_AVATAR_IMAGE;var reviewerProfilePopupHandler="productReviewService.controller.productManager.view.handlers.launchReviewerProfile";var reviewProductName=this.productReview.productName;var reviewProductBrand=this.productReview.productBrand;var productNameAndBrand=(reviewProductBrand!=null&&reviewProductBrand!=""?reviewProductBrand+" ":"")+reviewProductName;var customerReviewIterator=function(customerReviewId){var review=this.productReview.customerReviewsMap[customerReviewId];if(review){var reviewProfile=review.reviewProfile;var reviewId=review.prReviewId;var reviewerId=reviewProfile.customerToken;var reviewerProfileUrl=this.constants.actions.REVIEWER_PROFILE_ACTION+reviewerId;var reviewerAvatarSrc=(reviewProfile.avatarUri?reviewProfile.avatarUri:defaultAvatarImageSrc);var reviewerAvatarAlt=reviewProfile.customerName;var reviewerName=reviewProfile.customerName;var reviewerLocation=reviewProfile.customerLocation;var reviewHeadline=review.headline;var reviewDate=review.createdDate;var reviewComment=review.comments;var helpfulVoteNumber=review.helpfulVotes;var totalVoteNumber=review.totalVotes;var fitDetailsMarkup=this.utils.getFitDetailsMarkup(review);var reviewerBadgeMarkup="";var locationMarkup="";var seeAllReviews=seeAllReviewsTemplate.evaluate({text:seeAllReviewsText,number:reviewProfile.numberOfReviews});var reviewStarMarkup=this.utils.getStarRatingImageMarkup(review.overallRating);var nameMarkup=nameTemplate.evaluate({reviewId:reviewId,reviewerName:reviewerName});if(reviewerLocation&&reviewerLocation!=""){locationMarkup=locationTemplate.evaluate({reviewerLocation:reviewerLocation});}
var helpfulVotesMarkup=helpfulVotesTemplate.evaluate({reviewId:reviewId,helpfulVoteNumber:helpfulVoteNumber,product:reviewProductName});var totalVotesMarkup=totalVotesTemplate.evaluate({reviewId:reviewId,totalVoteNumber:totalVoteNumber});var votesMarkup=votesTemplate.evaluate({helpful:helpfulVotesMarkup,total:totalVotesMarkup,product:productNameAndBrand});if(reviewProfile.badges){reviewProfile.badges.each(function(badge,i){reviewerBadgeMarkup+=reviewerBadgeTemplate.evaluate({reviewId:reviewId,badgeNo:i,reviewerBadgeSrc:badge.badgeImageUrl,reviewerBadgeType:"reviewerBadge"+badge.badgeName.replace(/\s/,"_"),reviewerBadgeAlt:badge.badgeName+": "+badge.badgeDescription,divider:"",badgeCode:badge.badgeCode});});}
var reviewMarkup=mainTemplate.evaluate({reviewId:reviewId,reviewerId:reviewerId,reviewerProfileUrl:reviewerProfileUrl,reviewerProfilePopupHandler:reviewerProfilePopupHandler,reviewerAvatarSrc:reviewerAvatarSrc,reviewerAvatarAlt:reviewerAvatarAlt,nameMarkup:nameMarkup,locationMarkup:locationMarkup,reviewerBadgeMarkup:reviewerBadgeMarkup,reviewStarMarkup:reviewStarMarkup,reviewHeadline:reviewHeadline,reviewDate:reviewDate,reviewComment:reviewComment,fitDetailsMarkup:fitDetailsMarkup,reviewHeadlineLabel:reviewHeadlineLabel,reviewDateLabel:reviewDateLabel,reviewCommentLabel:reviewCommentLabel,seeAllReviews:seeAllReviews,reportThis:reportThis,votesMarkup:votesMarkup,voteLabel:voteLabel,voteYes:voteYes,voteNo:voteNo});reviewListDisplayMarkup+=reviewMarkup;}};if(customerReviewData){customerReviewData.each(customerReviewIterator.bind(this));}
return reviewListDisplayMarkup;},getSortedCustomerReviews:function(){if(this.productReview&&this.productReview.reviewSummary){if(this.productReview.reviewSummary.fullReviewCount>1){$(this.constants.nodeNames.reviewDetails.REVIEW_DETAILS_SORT_NODE_NAME).setStyle({"display":"block"});this.populateSortDropDown();return productReviewService.utils.sortCustomerReviewsBy(this.selectedSortOption,this.productReview.customerReviews);}else{return this.productReview.customerReviews;}}},populateSortDropDown:function(){var sortDropDownNode=$(this.constants.nodeNames.reviewDetails.REVIEW_DETAILS_SORT_SELECT_NODE_NAME);sortDropDownNode.options.length=0;var sortOptions=Object.keys(this.constants.productReview.sortByKeys);sortOptions.each(function(sortOption){sortDropDownNode.options[sortDropDownNode.length]=new Option(this.constants.productReview.sortByNames[sortOption],this.constants.productReview.sortByKeys[sortOption]);}.bind(this));sortDropDownNode.selectedIndex=Number(this.selectedSortOption)-1;},handlers:{seeAllReviews:function(){$(productReviewService.constants.nodeNames.reviewDetails.REVIEW_SECTION_ROOT_NODE_NAME).scrollTo();},productReviewVote:function(calleeElement,vote,reviewId){var utils=productReviewService.utils;var constants=productReviewService.constants;var url="";var isHelpfulVote=false;if(vote==constants.messages.reviewDetails.REVIEW_DETAILS_VOTE_YES){url=constants.urls.PR_VOTING_HELPFUL_URL;isHelpfulVote=true;}
else{url=constants.urls.PR_VOTING_UNHELPFUL_URL;}
url=url+reviewId;utils.insertPixel(url);if(isHelpfulVote)productReviewService.controller.productManager.view.callReviewVoteReportingService(reviewId);utils.launchReviewAcknowledgementPopup(calleeElement,productReviewService.constants.messages.acknowledgementPanel.VOTE_MESSAGE);return false;},launchProductReviewReport:function(calleeElement,reviewId){var utils=productReviewService.utils;var constants=productReviewService.constants;if(!gidLib.layeredPopup.styles.productReviewPanel)utils.addProductReviewPanelStyle();var popupContent=$(constants.nodeNames.POPUP_CONTENT_NODE_NAME);var targetPosition=Position.cumulativeOffset($(calleeElement));var popupPaddingOffset=5;var panelHeight=115;var panelWidth=254;var leftOffset=targetPosition[0]-panelWidth+calleeElement.offsetWidth;var topOffset=targetPosition[1]-(panelHeight+popupPaddingOffset);gidLib.layeredPopup.openLayeredPopup({str:constants.nodeNames.reviewReportPopup.PANEL_NODE_NAME,id:'flagReview',width:panelWidth,height:panelHeight,left:leftOffset,top:topOffset,calleeElement:calleeElement,isDraggable:false,style:{name:'productReviewPanel'},effects:{show:{method:Effect.Appear,args:{duration:0.25}},hide:{method:Effect.Fade,args:{duration:0.25}}}});var buttons=popupContent.getElementsBySelector('a');var reportButton=buttons[0];var reportButtonEventBinding=productReviewService.controller.productManager.view.handlers.sendProductReviewReport.bind(productReviewService.controller.productManager.view.handlers,{reviewId:reviewId,calleeElement:calleeElement});reportButton.observe("click",reportButtonEventBinding);var cancelButton=buttons[1];cancelButton.onclick=function(){return gidLib.layeredPopup.closeLayeredPopup();}
return false;},sortProductReviews:function(){var sortDropDownNode=$(productReviewService.constants.nodeNames.reviewDetails.REVIEW_DETAILS_SORT_SELECT_NODE_NAME);var productReviewDetails=productReviewService.controller.productManager.view.productReviewDetails;if(productReviewService.model.data.isDataLoading==false){if(productReviewService.model.data.isAllDataLoaded==false){productReviewDetails.selectedSortOption=sortDropDownNode.options[sortDropDownNode.selectedIndex].value;productReviewService.utils.loadPaginatedReviewData({callBackMethod:productReviewService.controller.productManager.view.handlers.sortProductReviews});}else{var reviewsPaging=productReviewService.utils.reviewsPaging;var currentSelectedSortOption=sortDropDownNode.options[sortDropDownNode.selectedIndex].value;if(currentSelectedSortOption==productReviewDetails.selectedSortOption){return;}
if(reviewsPaging.currentPage!=0)reviewsPaging.currentPage=1;productReviewDetails.selectedSortOption=currentSelectedSortOption;var pagedCustomerReviewsMap=productReviewDetails.pagedReviewsBySortOptionCache[productReviewDetails.selectedSortOption];if(pagedCustomerReviewsMap==null||pagedCustomerReviewsMap==undefined){productReviewDetails.setDataToPage();}
else{reviewsPaging.setReviewsPagingCache(pagedCustomerReviewsMap);productReviewDetails.customerReviewData=reviewsPaging.getPagedCustomerReviews(1);productReviewDetails.setCustomerReviewsDataToPage();}}}},reviewsPaginationHandler:function(pageId){if(productReviewService.model.data.isDataLoading==false){var productReviewDetailsView=productReviewService.controller.productManager.view.productReviewDetails;productReviewDetailsView.customerReviewData=productReviewService.utils.reviewsPaging.getPagedCustomerReviews(pageId);if(!productReviewDetailsView.customerReviewData||productReviewDetailsView.customerReviewData.size()==0){productReviewService.utils.loadPaginatedReviewData({callBackMethod:productReviewService.controller.productManager.view.handlers.reviewsPaginationHandler,callBackArgs:pageId});}else{productReviewDetailsView.setCustomerReviewsDataToPage();productReviewService.utils.position.scrollToElement(productReviewService.constants.nodeNames.reviewDetails.REVIEW_SECTION_ROOT_NODE_NAME);gidLib.setCookieVar("globalSession","isProductReviewsSeeAll",(pageId==0));}}},sendProductReviewReport:function(args){var utils=productReviewService.utils;var constants=productReviewService.constants;var url=constants.urls.PR_FLAGGING_URL+args.reviewId;utils.insertPixel(url);return gidLib.layeredPopup.closeLayeredPopup();}}}});Object.extend(productReviewService.controller.profileManager.view,{profileReviewSummary:{messages:null,nodeNames:null,templates:null,constants:null,initVariableReferences:function(){this.messages=productReviewService.constants.messages.profileSummary;this.utils=productReviewService.utils.view;this.nodeNames=productReviewService.constants.nodeNames.profileSummary;this.templates=productReviewService.controller.profileManager.view.templates;this.constants=productReviewService.constants;},setDataToPage:function(){$(this.nodeNames.REVIEWER_SUMMARY_NODE_NAME).setStyle({display:"block"});var profileData=productReviewService.model.data.reviewProfiles[0];this.setProfileAvatar(profileData);this.setProfileSummaryDetails(profileData);this.setBadge(profileData);this.setProfileDescription(profileData);this.setProfileAttributes(profileData);},setProfileAvatar:function(profileData){var imgNode=$(this.nodeNames.AVATAR_IMAGE_NODE_NAME);var imgSrc="";if(profileData.avatarUri){imgSrc=profileData.avatarUri}else{imgSrc=this.constants.image.IMAGE_PATH+this.constants.image.DEFAULT_AVATAR_LARGE_IMAGE;}
imgNode.setSrc(imgSrc);imgNode.alt=profileData.customerName;},setProfileSummaryDetails:function(profileData){var reviewAttributeKeys=this.constants.reviewAttribute.reviewAttributeKeys;$(this.nodeNames.REVIEWER_NAME_NODE_NAME).update(profileData.customerName);if(profileData.customerLocation){$(this.nodeNames.REVIEWER_LOCATION_NODE_NAME).update(profileData.customerLocation);$(this.nodeNames.REVIEWER_LOCATION_CONTAINER_NODE_NAME).setStyle({display:"block"});}
if(profileData.numberOfReviews){$(this.nodeNames.REVIEWER_REVIEWS_COMPLETED_NODE_NAME).update(profileData.numberOfReviews);$(this.nodeNames.REVIEWER_REVIEWS_CONTAINER_NODE_NAME).setStyle({display:"block"});}},setBadge:function(profileData){var badgeNode=$(this.nodeNames.BADGE_IMAGE_NODE_NAME);var badgeMarkup="";if(profileData&&profileData.badges&&profileData.badges.length>0){var reviewerBadgeTemplate=this.templates.REVIEWER_BADGES_TEMPLATE;var reviewerBadgeDividerMarkup=this.templates.REVIEW_DETAILS_BADGE_DIVIDER_TEMPLATE;profileData.badges.each(function(badge,i){badgeMarkup+=reviewerBadgeTemplate.evaluate({reviewerId:profileData.prProfileId,badgeNo:i,reviewerBadgeSrc:badge.badgeImageUrl,reviewerBadgeType:"reviewerBadge"+badge.badgeName.replace(/\s/,"_"),reviewerBadgeAlt:badge.badgeName+": "+badge.badgeDescription,divider:(i<profileData.badges.length-1?reviewerBadgeDividerMarkup:""),badgeCode:badge.badgeCode});});}else{badgeMarkup="&nbsp;"}
badgeNode.update(badgeMarkup);},setProfileDescription:function(profileData){if(profileData.comments){$(this.nodeNames.REVIEWER_SUMMARY_DESCRIPTION_NODE_NAME).update(profileData.comments);$(this.nodeNames.REVIEWER_SUMMARY_TITLE_NODE_NAME).setStyle({display:"block"});}},setProfileAttributes:function(profileData){var profileAttributeMarkup=[];for(var i=0;i<profileData.reviewProfileAttributes.size();i++){var profileAttribute=profileData.reviewProfileAttributes[i];if(profileAttribute!=null){var profileAttributeName=this.getFormattedLabelName(profileAttribute.nameCode);var profileAttributeText=profileAttribute.valueText;profileAttributeMarkup.push(productReviewService.controller.productManager.view.templates.PROFILE_ATTRIBUTE_TEMPLATE.evaluate({profileAttributeTitle:profileAttributeName,profileAttributeDetails:profileAttributeText}));}}
if(profileAttributeMarkup.length>0){var profileAttributeNode=$(this.nodeNames.REVIEWER_ATTRIBUTES_NODE_NAME);profileAttributeNode.update(profileAttributeMarkup.join(""));profileAttributeNode.setStyle({"display":"block"});}},getFormattedLabelName:function(labelName){return productReviewService.controller.productManager.view.templates.LABEL_DISPLAY_TEMPLATE.evaluate({"labelName":labelName});}}});Object.extend(productReviewService.controller.profileManager.view,{profileReviewDetails:{messages:null,nodeNames:null,templates:null,constants:null,reviewsListScrollOffset:0,reviewerProfile:null,customerReviewData:null,loadScriptTimer:[],totalScriptRequests:0,loadedScriptRequests:0,productInventoryStatus:[],businessUnitProducts:[],scriptCounterToBusinessUnitMap:[],initVariableReferences:function(){this.messages=productReviewService.constants.messages;this.utils=productReviewService.utils.view;this.nodeNames=productReviewService.constants.nodeNames.profileDetails;this.templates=productReviewService.controller.profileManager.view.templates;this.constants=productReviewService.constants;},setDataToPage:function(){this.reviewerProfile=productReviewService.model.data.reviewProfiles[0];var allReviews=productReviewService.utils.sortCustomerReviewsBy(productReviewService.constants.productReview.sortByKeys.SORT_BY_MOST_RECENT,this.reviewerProfile.customerReviews);this.customerReviewData=productReviewService.utils.reviewsPaging.paginate(allReviews,this.constants.reviewsPaging.REVIEWS_PER_PAGE_ON_PROFILE,this.reviewerProfile.numberOfReviews);this.setCustomerReviewsDataToPage();},setCustomerReviewsDataToPage:function(){var reviewerReviewsDisplayMarkup=this.buildReviewerReviewsMarkup();$(this.nodeNames.REVIEWER_REVIEWS_LIST_NODE_NAME).update(reviewerReviewsDisplayMarkup);$(this.nodeNames.REVIEWER_REVIEWS_NODE_NAME).setStyle({display:"block"});this.resetReviewBorderHeight();var pageHandler="productReviewService.controller.profileManager.view.handlers.reviewsPaginationHandler";var reviewsPaginationMarkup=productReviewService.utils.reviewsPaging.getPaginationLinksMarkup(pageHandler);if(reviewsPaginationMarkup&&!reviewsPaginationMarkup.blank()){var pagingNodes=$$(this.nodeNames.REVIEWER_REVIEWS_PAGING_CLASS_NAME);pagingNodes.invoke("update",reviewsPaginationMarkup);}
this.setReviewsListScrollObserver();this.setBusinessUnitProductsMap();productReviewService.controller.profileManager.view.profileReviewDetails.loadedScriptRequests=0;setTimeout(this.checkCustomerReviewsInventoryStatus.bind(this),250);$(this.nodeNames.REVIEWER_REVIEWS_LIST_NODE_NAME).scrollTop=0;},resetReviewBorderHeight:function(){var profileDetailsNodeNames=productReviewService.constants.nodeNames.profileDetails;var reviewContentNodes=$$(profileDetailsNodeNames.REVIEWER_REVIEW_CONTENT_CLASS_NAME);var resetEachReviewIterator=function(contentNode){var nodeId=contentNode.id;var sReviewId=nodeId.replace(profileDetailsNodeNames.REVIEWER_REVIEW_CONTENT_NODE_NAME,"");var reviewId=parseInt(sReviewId,10);var imageBorderNode=$(profileDetailsNodeNames.REVIEWER_REVIEW_PRODUCT_IMAGE_BORDER_NODE_NAME+reviewId);var productReviewDataNode=$(profileDetailsNodeNames.REVIEWER_REVIEW_PRODUCT_REVIEW_DATA_NODE_NAME+reviewId);var productSectionHeight=imageBorderNode.offsetHeight;var reviewSectionHeight=productReviewDataNode.offsetHeight;if(reviewSectionHeight>productSectionHeight){imageBorderNode.setStyle({"height":reviewSectionHeight+"px"});}};reviewContentNodes.each(resetEachReviewIterator.bind(this));},buildReviewerReviewsMarkup:function(){var customerReviewData=this.customerReviewData;var reviewerReviewsDisplayMarkup="";var mainTemplate=this.templates.REVIEW_DETAILS_MAIN_TEMPLATE;var votesTemplate=new Template(this.messages.reviewDetails.REVIEW_DETAILS_HELPFUL_OF_TOTAL);var helpfulVotesTemplate=this.templates.REVIEW_DETAILS_HELPFUL_VOTE_TEMPLATE;var totalVotesTemplate=this.templates.REVIEW_DETAILS_TOTAL_VOTE_TEMPLATE;var productImageTemplate=this.templates.REVIEW_DETAILS_PRODUCT_IMAGE_TEMPLATE;var reviewHeadlineLabel=this.messages.reviewDetails.REVIEW_DETAILS_SUMMARY_LABEL;var reviewDateLabel=this.messages.reviewDetails.REVIEW_DETAILS_DATE_LABEL;var reviewCommentLabel=this.messages.reviewDetails.REVIEW_DETAILS_COMMENT_LABEL;var soldOutMsg=this.messages.reviewDetails.REVIEW_DETAILS_OUT_OF_STOCK_MSG;var soldOutImage=this.constants.image.IMAGE_PATH+this.constants.image.SOLD_OUT_IMAGE;var gidBrandSiteConstruct=(window.parent?window.parent.gidBrandSiteConstruct:null);var customerReviewIterator=function(customerReviewId){var review=this.reviewerProfile.customerReviewsMap[customerReviewId];if(review){var reviewComment=review.comments;if(reviewComment&&!reviewComment.strip().blank()){var customerReviewAttributes=review.customerReviewAttributes;var reviewId=review.prReviewId;var productId=review.productId;var productStyleColorId=this.getProductStyleColorId(review);var productPageUrl="#";if(gidBrandSiteConstruct){var brandSite=gidBrandSiteConstruct.gidBrandSites[review.businessUnit];if(brandSite)productPageUrl=brandSite.unsecureUrl+productReviewService.constants.actions.PRODUCT_ACTION+productStyleColorId;}
var productImageSrc=review.productImageUrl;var productName=review.productName;var productVendor=review.productBrand;var productImageAtl=productName;var reviewHeadline=review.headline;var reviewDate=review.createdDate;var helpfulVoteNumber=review.helpfulVotes;var totalVoteNumber=review.totalVotes;var fitDetailsMarkup=this.utils.getFitDetailsMarkup(review);var productBusinessUnit=review.businessUnit;var productNameAndBrand=(productVendor!=null&&productVendor!=""?productVendor+" ":"")+productName;var productImageMarkup=productImageTemplate.evaluate({reviewId:reviewId,productId:productId,productStyleColorId:productStyleColorId,productImageAtl:productImageAtl,productImageSrc:productImageSrc,businessUnit:review.businessUnit});var reviewStarMarkup=this.utils.getStarRatingImageMarkup(review.overallRating);var helpfulVotesMarkup=helpfulVotesTemplate.evaluate({reviewId:reviewId,helpfulVoteNumber:helpfulVoteNumber});var totalVotesMarkup=totalVotesTemplate.evaluate({reviewId:reviewId,totalVoteNumber:totalVoteNumber});var votesMarkup=votesTemplate.evaluate({helpful:helpfulVotesMarkup,total:totalVotesMarkup,product:productNameAndBrand});var productBusinessUnitBadge="/assets/common/clear.gif";var productBrandName="";if(productBusinessUnit&&brandConst){productBusinessUnitBadge=brandConst["BRAND"+productBusinessUnit+"_BADGE_CONTENT_PATH"]+"badge_reviews.gif";}
if(productBusinessUnit&&window.parent&&window.parent.gidBrandSiteConstruct&&window.parent.gidBrandSiteConstruct.gidBrandSites[productBusinessUnit]){productBrandName=window.parent.gidBrandSiteConstruct.gidBrandSites[productBusinessUnit].brandDisplayName;}
var reviewMarkup=mainTemplate.evaluate({reviewId:reviewId,productId:productId,productName:productName,productVendor:productVendor,productPageUrl:productPageUrl,productImageMarkup:productImageMarkup,soldOutMsg:soldOutMsg,soldOutImage:soldOutImage,reviewStarMarkup:reviewStarMarkup,reviewHeadline:reviewHeadline,reviewDate:reviewDate,reviewComment:reviewComment,fitDetailsMarkup:fitDetailsMarkup,reviewHeadlineLabel:reviewHeadlineLabel,reviewDateLabel:reviewDateLabel,reviewCommentLabel:reviewCommentLabel,votesMarkup:votesMarkup,productBusinessUnitBadge:productBusinessUnitBadge,productBrandName:productBrandName});reviewerReviewsDisplayMarkup+=reviewMarkup;}}};customerReviewData.each(customerReviewIterator.bind(this));return reviewerReviewsDisplayMarkup;},setReviewsListScrollObserver:function(){Event.observe($(this.nodeNames.REVIEWER_REVIEWS_LIST_NODE_NAME),"scroll",function(){quickLook.closeQuickLookLauncher();});},setBusinessUnitProductsMap:function(){var customerReviewData=this.customerReviewData;var profileReviewDetails=productReviewService.controller.profileManager.view.profileReviewDetails;var productInventoryStatus=profileReviewDetails.productInventoryStatus;var reviewIterator=function(reviewId){var review=productReviewService.model.data.reviewProfiles[0].customerReviewsMap[reviewId];if(review){var productId=review.productId;var businessUnit=review.businessUnit
if(productId&&businessUnit){if(!profileReviewDetails.businessUnitProducts[businessUnit]){profileReviewDetails.totalScriptRequests++;profileReviewDetails.scriptCounterToBusinessUnitMap[profileReviewDetails.totalScriptRequests]=businessUnit;profileReviewDetails.businessUnitProducts[businessUnit]={products:[],businessUnitId:businessUnit};}
if(!productInventoryStatus[businessUnit+"-"+productId]){profileReviewDetails.businessUnitProducts[businessUnit].products.push(productId);}}}};customerReviewData.each(reviewIterator);},checkCustomerReviewsInventoryStatus:function(){var profileReviewDetails=productReviewService.controller.profileManager.view.profileReviewDetails;if(profileReviewDetails.totalScriptRequests>0&&profileReviewDetails.loadedScriptRequests<profileReviewDetails.totalScriptRequests){profileReviewDetails.loadedScriptRequests++;profileReviewDetails.loadInventoryCall(profileReviewDetails.loadedScriptRequests);}else{profileReviewDetails.setCustomerReviewsInventoryStatus();}},loadInventoryCall:function(i){var profileReviewDetails=productReviewService.controller.profileManager.view.profileReviewDetails;var inventoryStatusCheckUrl=productReviewService.constants.actions.INVENTORY_STATUS_CHECK_ACTION;var businessUnitId=profileReviewDetails.scriptCounterToBusinessUnitMap[i];var businessUnit=profileReviewDetails.businessUnitProducts[businessUnitId];if(businessUnit){var products=businessUnit.products;var gidBrandSiteConstruct=(gidBrandSiteConstruct||window.parent.gidBrandSiteConstruct);if(gidBrandSiteConstruct&&products&&products.length>0&&businessUnitId){var host=gidBrandSiteConstruct.gidBrandSites[businessUnitId].unsecureUrl;var url=host+inventoryStatusCheckUrl+products.join(",")+"&isJS=true&method=productReviewService.controller.profileManager.view.profileReviewDetails.handlers.parseInventoryStatusCheckResponseHandler&args="+businessUnitId;gidLib.loadScript({callerObject:profileReviewDetails.loadScriptTimer,src:url,timeout:{handler:productReviewService.controller.profileManager.view.profileReviewDetails.handlers.loadScriptTimeoutHandler,timeDelay:5}});}}},setCustomerReviewsInventoryStatus:function(){var productInventoryStatus=productReviewService.controller.profileManager.view.profileReviewDetails.productInventoryStatus;var customerReviewData=this.customerReviewData;var profileReviewDetails=this;var reviewIterator=function(reviewId){var review=productReviewService.model.data.reviewProfiles[0].customerReviewsMap[reviewId];if(review){var productKey=review.productId;var businessUnit=review.businessUnit;var isInInventory=(productInventoryStatus[businessUnit+"-"+productKey]=="true");if(isInInventory){profileReviewDetails.setProductInStock(reviewId);}else{profileReviewDetails.setProductOutOfStock(reviewId);}}};customerReviewData.each(reviewIterator);$$(this.nodeNames.REVIEWER_REVIEWS_PAGING_CLASS_NAME).invoke("setStyle",{visibility:"visible"});},getProductStyleColorId:function(review){return review.productId+review.productColorCode;},setProductInStock:function(reviewId){var productAnchor=$("productAnchor"+reviewId);var productImage=$("productImage"+reviewId);if(productAnchor){productAnchor.removeClassName("clickDisabled");}
var productOutOfStockMsg=$("productOutOfStockMsg"+reviewId);if(productOutOfStockMsg){productOutOfStockMsg.hide();}},setProductOutOfStock:function(reviewId){var productOutOfStockMsg=$("productOutOfStockMsg"+reviewId);if(productOutOfStockMsg){productOutOfStockMsg.show();}},handlers:{parseInventoryStatusCheckResponseHandler:function(response,businessUnit){var profileReviewDetails=productReviewService.controller.profileManager.view.profileReviewDetails;var productInventoryStatus=profileReviewDetails.productInventoryStatus;response=response.replace(/(\n|\r|\s)/g,"");try{var products=response.split(",");var productsIterator=function(product){var keyValuePair=product.split("-");productInventoryStatus[businessUnit+"-"+keyValuePair[0]]=keyValuePair[1];};products.each(productsIterator);profileReviewDetails.checkCustomerReviewsInventoryStatus();}catch(e){}},reviewsPaginationHandler:function(pageId){var profileReviewDetailsView=productReviewService.controller.profileManager.view.profileReviewDetails;profileReviewDetailsView.customerReviewData=productReviewService.utils.reviewsPaging.getPagedCustomerReviews(pageId);profileReviewDetailsView.setCustomerReviewsDataToPage();},loadScriptTimeoutHandler:function(){productReviewService.controller.profileManager.view.profileReviewDetails.checkCustomerReviewsInventoryStatus();}}}});Object.extend(productReviewService.controller.reportingManager,{productReviewServiceStartTime:null,productReviewServiceEndTime:null,bvProductReviewsProcessingStartTime:null,bvProductReviewsProcessingEndTime:null,setProductReviewServiceStartTime:function(){this.productReviewServiceStartTime=(new Date()).getTime();},setProductReviewServiceEndTime:function(){if(productReviewService.model.rawData!=null)this.productReviewServiceEndTime=(new Date()).getTime();},getProductReviewServiceProcessingTime:function(){var time=null;if(this.productReviewServiceEndTime!=null&&this.productReviewServiceStartTime!=null){time=this.productReviewServiceEndTime-this.productReviewServiceStartTime;}
return time;},setBvProductReviewsProcessingStartTime:function(){this.bvProductReviewsProcessingStartTime=(new Date()).getTime();},setBvProductReviewsProcessingEndTime:function(){this.bvProductReviewsProcessingEndTime=(new Date()).getTime();},getBvProductReviewProcessingTime:function(){var time=null;if(this.bvProductReviewsProcessingEndTime!=null&&this.bvProductReviewsProcessingStartTime!=null){time=this.bvProductReviewsProcessingEndTime-this.bvProductReviewsProcessingStartTime;}
return time;}});