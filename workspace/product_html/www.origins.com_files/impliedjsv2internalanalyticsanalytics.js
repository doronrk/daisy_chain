var Analytics=Class.create({subscribers:{},listeners:{},fromConfigListeners:[],seenMemoWithTag:{},isEnabled:false,enabledModules:new Array(),bvLoaded:0,uniqueEvents:[],lastQVloc:"",lastQVkey:"",currentTags:[],analytics_div:null,debug:false,RPC_METHODS_ALLOWED:new Hash({prodcat:1,generic:1,cart:1,"rpc.form":1,search:1,"email.signup":1}),initialize:function(b,a){this._addStaticListeners()},addPendingTags:function(a){this.pendingTags=a;this.execTags();return this},_addStaticListeners:function(){var self=this;document.observe("dom:loaded",function(){self.isEnabled=(typeof ANALYTICS_ENABLED!="undefined")?ANALYTICS_ENABLED:false;self.enabledModules=(typeof ANALYTICS_MODULES!="undefined")?ANALYTICS_MODULES:[];self.jsEvents=(typeof CONVERSION_EVENTS!="undefined")?CONVERSION_EVENTS:[];self.jsEvents=self.jsEvents.concat((typeof JS_EVENTS!="undefined")?JS_EVENTS:[]);self.jsPixelEvents=(typeof JS_PIXEL_EVENTS!="undefined")?JS_PIXEL_EVENTS:new Object();if(Object.keys(self.jsPixelEvents).length>0){Object.keys(self.jsPixelEvents).each(function(module){self.jsPixelEvents[module].each(function(CEVENT){self.jsEvents=self.jsEvents.concat((typeof CEVENT!="undefined")?CEVENT:[])})})}if(typeof self.jsEvents!="undefined"){self.jsEventsWaited=[];self.jsEvents.each(function(CEVENT){CEVENT.hookIds=[];if(CEVENT.after){self.jsEventsWaited.push(CEVENT)}else{self._addFrontendEvent(CEVENT)}})}if(typeof page_data!="undefined"){if(page_data.checkout){if(page_data.checkout.viewcart){if(page_data.checkout.viewcart.recommendedProducts){localPath=document.location.pathname;if(localPath.match("viewcart.tmpl")){document.fire("PAGEDATA:RESULT","checkout.viewcart.recommendedProducts")}}}}}self.analytics_div=$("analytics_div");if(!Object.isElement(self.analytics_div)){self.analytics_div=new Element("div",{id:"analytics_div"});self.analytics_div.setStyle({width:"1px",height:"1px",display:"none"});$(document.body).insert(self.analytics_div)}});document.observe("kit:success",function(args){var giftsets=args.memo;var localPath=document.location.pathname;if(localPath.match("create.tmpl")||localPath.match("edit.tmpl")){giftsets.giftLocation="Kits"}var isMobile=(generic&&generic.env)?!!generic.env.isMobile:false;var elementId=giftsets.giftLocation+" - "+giftsets.product_name;var elementCat=isMobile?"MOBILE : Add to Gift":"Add to Gift";self.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[elementId,elementCat,null],tag:"cmCreatePageElementTag"}]}})});document.observe("kit:action",function(args){var action=args.memo.action;var kitActions={add_sample:"Add Sample",remove_product:"Remove Product",edit_gift_box:"Edit Gift Box",edit_name:"Edit Name",remove_gift:"Remove Gift"};if(!kitActions[action]){return}var elementId=kitActions[action];var isMobile=(generic&&generic.env)?!!generic.env.isMobile:false;var elementCat=(isMobile)?"MOBILE : Edit Gift":"Edit Gift";self.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[elementId,elementCat,null],tag:"cmCreatePageElementTag"}]}})});document.observe("search:results",function(event){var res=event.memo;self.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[res.pageid,res.keywords,res.cat,'"'+res.count+'"',null],tag:"cmCreatePageviewTag"}]}})});document.observe("livechat:button_clicked",function(obj){var button_name=obj.memo.name;self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="livechat:button_clicked"){var do_event=(typeof(EVENT.buttonName)!=="undefined")?(EVENT.buttonName==button_name):true;if(do_event){self._addFrontendEvent(EVENT)}}})});document.observe("livechat:invite_accepted",function(obj){var invite_name=obj.memo.name;self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="livechat:invite_accepted"){var do_event=(typeof(EVENT.inviteName)!=="undefined")?(EVENT.inviteName==invite_name):true;if(do_event){self._addFrontendEvent(EVENT)}}})});document.observe("livechat:invite_shown",function(obj){var invite_name=obj.memo.name;self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="livechat:invite_shown"){var do_event=(typeof(EVENT.inviteName)!=="undefined")?(EVENT.inviteName==invite_name):true;if(do_event){self._addFrontendEvent(EVENT)}}})});document.observe("bv:loaded",function(){if(self.bvLoaded==1){return}else{self.bvLoaded=1}self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="bv:loaded"){self._addFrontendEvent(EVENT)}})});document.observe("bv:created",function(){self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="bv:created"){self._addFrontendEvent(EVENT)}})});document.observe("email:signup",function(){self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="email:signup"){self._addFrontendEvent(EVENT)}})});document.observe("MPP:productQV",function(obj){setTimeout("Analytics._pushBV()",4000);var args=obj.memo||{};var qvProdId=(typeof(args.prodId)!="undefined")?args.prodId:false;var qvCatId=(typeof(args.catId)!="undefined")?args.catId:false;self.jsEventsWaited.each(function(EVENT){if(EVENT.after&&EVENT.after=="MPP:productQV"){var eventProdId=(typeof(EVENT.prodId)!="undefined")?EVENT.prodId:false;var eventCatId=(typeof(EVENT.catId)!="undefined")?EVENT.catId:false;if((eventProdId===false)&&(eventCatId===false)){self._addFrontendEvent(EVENT)}else{var canAdd=true;if(eventProdId){if((qvProdId===false)||(eventProdId!=qvProdId)){canAdd=false}}if(eventCatId){if((qvCatId===false)||(eventCatId!=qvCatId)){canAdd=false}}if(canAdd){self._addFrontendEvent(EVENT)}}}})});document.observe("RPC:RESULT",function(obj){var rpcRequestArray,rpcResponseArray;var requestMethod,requestId;var localPath=document.location.pathname;if(typeof obj.memo.request!="undefined"){rpcRequestArray=(obj.memo.request.parameters.JSONRPC!=null)?obj.memo.request.parameters.JSONRPC.evalJSON():null;if(rpcRequestArray){rpcResponseArray=obj.memo.responseText.evalJSON();if(rpcResponseArray){rpcRequestArray.each(function(rpcRequest){requestMethod=rpcRequest.method;requestId=rpcRequest.id;if(!self.RPC_METHODS_ALLOWED.get(requestMethod)){}else{var myRpcResponse=rpcResponseArray.find(function(rpcResponse){return rpcResponse.id==requestId});if(myRpcResponse&&myRpcResponse.result!=null){var newTags=myRpcResponse.result.data.Analytics;self.addPendingTags(newTags)}if(localPath.match("subscriptions")&&requestMethod=="rpc.form"){if(rpcRequest.params[0]["_SUBMIT"]=="alter_subscription"){cmelementid=myRpcResponse.result.data.ac_results[0].result.COLLECTION_NAME;cmElementCat=(generic&&generic.env&&generic.env.isMobile)?"MOBILE : Gift of the Month Add to Bag":"Gift of the Month Add to Bag";self.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[cmelementid,cmElementCat,null,null,null],tag:"cmCreatePageElementTag"}]}})}}}})}}}});document.observe("PAGEDATA:RESULT",function(obj){var catalog_path=obj.memo;var path;try{path=eval("page_data."+catalog_path)}catch(e){}if(path&&path.rpcdata){if(path.rpcdata.result){if(path.rpcdata.result.Analytics){var newTags=eval("page_data."+catalog_path+".rpcdata.result.Analytics");self.addPendingTags(newTags)}}}})},_pushBV:function(){Analytics.jsEventsWaited.each(function(a){if(a.after&&a.after=="bv:loaded"){Analytics._addFrontendEvent(a)}})},addDynamicListener:function(c,b,d){var a=this;var e="default";d.each(function(f){if(typeof f.memo!="undefined"){e=f.memo}if(!a.subscribers[e]){a.subscribers[e]={}}if(!a.subscribers[e][c]){a.subscribers[e][c]={}}if(!a.subscribers[e][c][b]){a.subscribers[e][c][b]=new Array()}else{}if(!a.seenMemoWithTag[e]){a.seenMemoWithTag[e]={}}if(!a.seenMemoWithTag[e][f.tag]){a.seenMemoWithTag[e][f.tag]=1;a.subscribers[e][c][b].push(f)}});if(!a.listeners[b]){a.listeners[b]=1;document.observe(b,function(f){var g=((typeof(f.memo.prodId!=undefined))?f.memo.prodId:f.memo);a.enabledModules.each(function(h){if(typeof a.subscribers[g][h]!="undefined"){if(a.subscribers[g][h][b]){if(h.match("CoreMetrics")){a.execEventTagBlocks(a.subscribers[g][h][b])}else{a.execImageBlocks(a.subscribers[g][h][b])}}}})})}},execTags:function(){var a=this;if(typeof a.pendingTags=="object"){Object.keys(a.pendingTags).each(function(b){if(typeof b!="object"&&a.pendingTags[b]=="notag"){return}if(a.pendingTags[b]==null){return}Object.keys(a.pendingTags[b]).each(function(c){if(c!="dom:loaded"){a.addDynamicListener(b,c,a.pendingTags[b][c])}else{if(b.match("CoreMetrics")){a.execEventTagBlocks(a.pendingTags[b][c])}else{a.execImageBlocks(a.pendingTags[b][c])}}})})}},execImageBlocks:function(c){var a=this;var b=Math.random()+"";var d=b*1000000000000000000;c.each(function(f){var g=f.replace("rndnum",d);var e=new Element("image",{id:"analytics_image_"+d,name:"analytics_image_"+d,src:g});a.analytics_div.insert(e)})},execIframeBlocks:function(c){var a=this;var b=Math.random()+"";var d=b*1000000000000000000;c.each(function(f){var g=f.src.replace("rndnum",d);var e=new Element("iframe",{id:"analytics_iframe_"+d,name:"analytics_iframe_"+d});e.setStyle({width:"1px",height:"1px",display:"none"});e.src=g;a.analytics_div.insert(e)})},execEventTagBlocks:function(a){a.each(function(b){if(!b.params||!b.tag){return}Analytics.debug&&console.log("Analytics.execEventTagBlocks about to execute tag: ",b.tag," with params: ",b.params);if(typeof window[b.tag]=="undefined"){return}window[b.tag].apply(this,b.params)})},_addFrontendEvent:function(b){var a=this;if($(b.domID)==null&&b.event!="dom:loaded"){}if(b.event=="dom:loaded"){a.execTagsbyType(b)}else{if(b.domID||(b.attachAttr&&b.attachValue)){a._attachFrontendEvent(b)}}},_attachFrontendEvent:function(c){var b=this;if(c.domID){c.attachAttr="id";c.attachValue=c.domID}if(typeof c.attachTag=="undefined"){c.attachTag=""}if(c.attachAttr&&c.attachValue){var a=[];$$(""+c.attachTag+"["+c.attachAttr+'="'+c.attachValue+'"]').each(function(e){var d=c.hookIds.indexOf($(e).identify());if(d<0){c.hookIds.push($(e).identify());b.fromConfigListeners.push(e);a.push(e)}});a.each(function(d){if(b.uniqueEvents.indexOf(d)!=-1){return}b.uniqueEvents.push(d);d.observe(c.event,function(e){var f;b.jsEvents.each(function(g){g.hookIds.each(function(h){var j=null;if(h==e.target.parentNode.id){j=e.target.parentNode.id}if(h==e.target.id){j=e.target.id}if(e.target&&typeof e.target.up=="function"){var k=1;while(arr=e.target.up(k)){if(h==arr.id){j=arr.id;break}k=k+1}}if(e.target.parentNode&&typeof e.target.parentNode.up=="function"){var k=1;while(arr=e.target.parentNode.up(k)){if(h==arr.id){j=arr.id;break}k=k+1}}if(j){f=g;b.execTagsbyType(g)}})})})})}},execTagsbyType:function(CEVENT){Object.keys(CEVENT).each(function(param){if(param.match("_")){newParam=param.replace(/_/,"");CEVENT[newParam]=eval(CEVENT[param])}});if(CEVENT.type=="conversion_event"){if(CEVENT.points<1){CEVENT.points='"0"'}this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.eventID,CEVENT.actionType,CEVENT.cat,CEVENT.points,CEVENT.attributes],tag:"cmCreateConversionEventTag"}]}})}if(CEVENT.type=="element"){this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.elementID,CEVENT.elementCategory,CEVENT.attributes],tag:"cmCreatePageElementTag"}]}})}if(CEVENT.type=="mpageview"){this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.pageID,CEVENT.categoryID,CEVENT.DestinationURL,CEVENT.ReferringURL],tag:"cmCreateManualPageviewTag"}]}})}if(CEVENT.type=="mlinkclick"){this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.href,CEVENT.name,CEVENT.pageID],tag:"cmCreateManualLinkClickTag"}]}})}if(CEVENT.type=="mimpression"){this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.pageID,CEVENT.trackSP,CEVENT.trackRE],tag:"cmCreateManualImpressionTag"}]}})}if(CEVENT.type=="error"){this.addPendingTags({CoreMetrics:{"dom:loaded":[{params:[CEVENT.pageID,CEVENT.categoryID],tag:"cmCreateErrorTag"}]}})}if(CEVENT.type=="img"){this.execImageBlocks([CEVENT.src])}if(CEVENT.type=="iframe"){this.execIframeBlocks([CEVENT])}},findAttrUp:function(d,a){if(d&&d!="undefined"){current_element=d;if(current_element.parentNode){if(current_element.parentNode.hasAttribute(a)){if(current_element.parentNode.readAttribute(a)){return current_element.parentNode.readAttribute(a)}}}var b;var c=1;while(arr=current_element.up(c)){if(arr.readAttribute(a)){b=arr;break}c=c+1}c=1;while(arr=current_element.parentNode.up(c)){if(arr.readAttribute(a)){b=arr;break}c=c+1}}return b},findAttrDown:function(c,a){var b=[];i=0;while(arr=c.down(i)){if(arr.readAttribute(a)){b.push(arr)}i=i+1}return b},assignLocEvents:function(c,a){if(typeof c!="object"){return}var b=Analytics.findAttrDown(c,a);if(typeof b=="undefined"){return}b.each(function(d){d.observe("click",function(f){params={};if(f.target){loc=f.target.readAttribute("loctmpl");if(loc){location_params=loc.split(",");params.TYPE_LOCATION=location_params[0];params.PRODUCT_KEY=location_params[1]}if(params.TYPE_LOCATION){params.URL_CLICK=1;Analytics.reportProductView(params)}else{if(typeof Analytics=="object"){loc=Analytics.findAttrUp(f.target,"loctmpl");if(loc){location_params=loc.split(",");params.TYPE_LOCATION=location_params[0];params.PRODUCT_KEY=location_params[1];params.URL_CLICK=1;Analytics.reportProductView(params)}}}}})})},reportProductView:function(a){params=a;var b=false;if(params.URL_CLICK){b=true}var c=generic.jsonrpc.fetch({method:"prodcat.viewc",sync:b,params:[params]})},onDivShow:function(){},onFrameUpdate:function(){},onJsRedirect:function(){}});Analytics=new Analytics();