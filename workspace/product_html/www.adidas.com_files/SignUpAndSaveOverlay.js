app.define("component/common/SignUpAndSaveOverlay",["jquery","Component","component/common/Dialog","utils/cookies","utils/url","utils/forms"],function(h,e,a,f,d,c){var g={resizable:false,autoOpen:false,modal:true,removeAutoFocus:true,width:"auto",dialogClass:"signUpOverlay"};function b(j){e.call(this,j);this.subscriptionParams={};this.isIgnoreHttps=this.el.data("ignorecountforhttps");this.showOverlayOnXPage=this.el.data("showoverlayonxpage")||0;this.ignoreCountForUrls=this.el.data("ignorecountforurls")||"";this.ignoreCountForUrlParams=this.el.data("ignorecountforurlparams")||"";this.ignoreCountForUrlsArray=this.ignoreCountForUrls.split(",");this.pageIs=!!f.getCookie("UserSignUpAndSave")?parseInt(f.getCookie("UserSignUpAndSave")):1;this.newsletterSubscribed=!!f.getCookie("newsletter_subscribed")?parseInt(f.getCookie("newsletter_subscribed")):0;this.pageUrl=window.location.href;var i=((this.pageUrl.split("?")[0]).split("/"));if(this.ignoreCountForUrlsArray[0]!=""){this.pageIncluded=!(this.ignoreCountForUrlsArray.indexOf(i[i.length-1])!=-1)}this.notSamePage=this.checkPage(this.pageUrl);f.setCookie("PrevPageURL",this.pageUrl);if(this.isIgnoreHttps){this.isProtocolAcceptable=!d.checkHTTPSProtocol()}this.paramsIncluded=!d.checkURLParams(this.ignoreCountForUrlParams.split(","));if(!this.paramsIncluded){f.setCookie("suppressedByURLParam",1)}this.control("click",".newsletter_signup_layer_two #newslettersubmitbuttonwomen",this.onLayerTwoButtonWomenClick).control("click",".newsletter_signup_layer_two #newslettersubmitbuttonmen",this.onLayerTwoButtonMenClick).control("focusout","#signupandsaveform .email input[type=text]",this.onEmailFocusOut).control("change","#signupandsaveform .birthday select",this.onBirthdayChange).control("click",'.newsletter_signup_layer_two input[name="gender"] #genderMale',this.onGenderMaleClick).control("click",'.newsletter_signup_layer_two input[name="gender"] #genderFemale',this.onGenderFemaleClick).control("click","div.newsletter_signup_layer_one",this.onSignupLayerOneClick).control("submit",".newsletter_signup_layer_two form",this.onSignupLayerTwoFormSubmit);h(".newsletter_signup_layer_two .floated-popup").live("mouseleave",function(){h(this).removeClass("popup-opened");h(this).children(".simpledialog").fadeOut(200);return false});h(".newsletter_signup_layer_two .floated-popup .showdialog").live("mouseenter",function(){h(this).parent().addClass("popup-opened");h(this).next(".simpledialog").fadeIn(200);return false})}b.prototype=h.extend({isProtocolAcceptable:true,pageIncluded:true,paramsIncluded:true},e.prototype);b.prototype.checkPage=function(j){var i=!!f.getCookie("PrevPageURL")?f.getCookie("PrevPageURL"):"";return i!=j};b.prototype.render=function(){this.el.find("#signupandsaveform .birthday select, #signupandsaveform .email input[type=text]").removeClass("required");if(this.notSamePage&&this.isProtocolAcceptable&&this.pageIncluded&&this.paramsIncluded&&this.newsletterSubscribed!=1){if(this.pageIs==this.showOverlayOnXPage){var i=a.getDialog();i.open(this.el," ",g);h("body > .ui-widget-overlay").one("click",function(){i.close()});PageContext.addIncludeHandler("analytics.js",function(){Analytics.trigger("header-signup",{signup_location:"OVERLAY",signup_step:"START"})})}f.setCookie("UserSignUpAndSave",this.pageIs+1,500)}};b.prototype.onLayerTwoButtonWomenClick=function(i,j){j.preventDefault();this.el.find(".newsletter_signup_layer_two input[name='gender']").val("2");h(i).closest("form").submit()};b.prototype.onLayerTwoButtonMenClick=function(i,j){j.preventDefault();this.el.find(".newsletter_signup_layer_two input[name='gender']").val("1");h(i).closest("form").submit()};b.prototype.onEmailFocusOut=function(j,m){var k=this.el.find("#signupandsaveform .email .errormsg");var l=h(j).closest("fieldset");if(!h(j).val()){var i=k.data("emptyError");l.addClass(".errorclient");k.text(i).show()}else{l.removeClass(".errorclient");k.text("").hide()}};b.prototype.onBirthdayChange=function(i,j){this.el.find("#signupandsaveform .birthday").closest("fieldset").removeClass("errorclient");this.el.find("#signupandsaveform .birthday .errormsg").hide()};b.prototype.onGenderMaleClick=function(i,j){this.el.find(".newsletter_signup_layer_two input[name='gender']").val("1")};b.prototype.onGenderFemaleClick=function(i,j){this.el.find(".newsletter_signup_layer_two input[name='gender']").val("2")};b.prototype.onSignupLayerOneClick=function(i,j){h(i).hide();this.el.find("div.newsletter_signup_layer_two").show();c.initSubstitutes()};b.prototype.onSignupLayerTwoFormSubmit=function(l,m){var k=h(l);var i=this.el.find(".newsletter_signup_layer_two");k.find(".formfield .errormsg, .general_error").text("").hide();var j={email:k.find("input[name='email']").val(),dayofmonth:k.find(".birthday .value select[name$='_dayofmonth']").val(),month:k.find(".birthday .value select[name$='_month']").val(),year:k.find(".birthday .value select[name$='_year']").val(),gender:k.find("input[name='gender']").val()||"",nid:this.subscriptionParams.nid||"",source:this.subscriptionParams.source||""};if(i.find(".ageconfirmatininp").length!=0){j.ageconfirmation=h(".ageconfirmatininp").find("div.c-checkbox").hasClass("checked")||h(".ageconfirmatininp").find("div.ffCheckboxWrapper").hasClass("on")}this.el.find("#signupandsaveform .errormsg, #signupandsaveform .general_error").text("").hide();this.el.find("#signupandsaveform .errorclient").removeClass("errorclient");h.ajax({url:k.attr("action"),beforeSend:function(n){k.find(".general_error").fadeOut();i.find(".loading_wrapper").fadeIn()},async:true,cache:false,dataType:"jsonp",type:"POST",data:j,context:this,success:this.onResponseSing,error:function(){this.hideLoadingOverlay();this.showGeneralError(app.resources.SERVICE_ERROR);this.trackHeaderSignup("ERROR")}});return false};b.prototype.hideLoadingOverlay=function(){this.el.find(".newsletter_signup_layer_two .loading_wrapper").fadeOut()};b.prototype.showGeneralError=function(i){container.find("#signupandsaveform fieldset:has(.general_error)").addClass("errorclient");container.find("#signupandsaveform .general_error").text(i).show()};b.prototype.onResponseSing=function(k){this.isgeneralerror=false;var i=this.el.find(".newsletter_signup_layer_two"),j="SUCCESS";this.hideLoadingOverlay();if("error" in k){if("email" in k.error&&k.error.email){j="ERROR";i.find("#signupandsaveform fieldset:has(.email)").addClass("errorclient");i.find("#signupandsaveform .formfield.email .errormsg").text(k.error.email).show()}if("birthdate" in k.error&&k.error.birthdate){j="ERROR";i.find("#signupandsaveform fieldset:has(.birthday)").addClass("errorclient");i.find("#signupandsaveform .formfield.birthday .errormsg").text(k.error.birthdate).show()}if("general" in k.error&&k.error.general){j="ERROR";this.showGeneralError(k.error.general)}}if(j==="SUCCESS"){i.find("div.newsletter_signup_form").hide();i.find("h3.signup-and-save-header").hide();i.find(".signupandsave_complete p").text(k.success).parent().show()}this.trackHeaderSignup(j,k.encrypted_email)};b.prototype.trackHeaderSignup=function(i,j){h(document).trigger("analytics.header-signup",{signup_step:i,signup_location:"OVERLAY",customer_email:this.el.find(".newsletter_signup_layer_two input[name$='email']").val(),customer_encrypted_email:encodeURIComponent(j||"")})};return b});