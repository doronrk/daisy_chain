/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
s7sdk.pkg("s7sdk.image");if(s7sdk.browser.name==="ie"){s7sdk.Util.require("s7sdk.image.rgn.View")}else{s7sdk.Util.require("s7sdk.image.View")}s7sdk.Util.require("s7sdk.common.IS");s7sdk.Util.require("s7sdk.common.IconEffect");s7sdk.Util.require("s7sdk.common.ItemDesc");s7sdk.Util.require("s7sdk.event.InputController");if(!s7sdk.image.ZoomView){s7sdk.image.ZoomView=function ZoomView(b,e,d){s7sdk.Logger.log(s7sdk.Logger.CONFIG,"s7sdk.image.ZoomView constructor - containerId: %0, settings: %1 , compId: %2",b,e,d);arguments.callee.superclass.apply(this,[d,b,"div","s7zoomview",e]);this.createElement();this.container=s7sdk.Util.byId(b);if(this.container.tagName=="DIV"&&(!this.container.style.position||this.container.style.position=="static")){this.container.style.position="relative"}if(this.enableHD.enable.toLowerCase()=="always"){this.enableHD.maxHdPixels=-1}else{if(this.enableHD.enable.toLowerCase()=="never"){this.enableHD.maxHdPixels=0}else{if(this.enableHD.enable.toLowerCase()=="limit"){if(NaN==this.enableHD.maxHdPixels){this.enableHD.maxHdPixels=2250000}else{this.enableHD.maxHdPixels=this.enableHD.maxHdPixels*this.enableHD.maxHdPixels}}else{this.enableHD.maxHdPixels=2250000}}}this.view=null;if(this.serverUrl.lastIndexOf("/")!=(this.serverUrl.length-1)){this.serverUrl+="/"}this.compId=(s7sdk.Util.isNull(d)?"":d);this.locale=this.getParam("locale","");this.imageModifier=s7sdk.MediaSetParser.parseAssetForSetReq(this.asset).mod;this.wid=this.stagesize.width;this.hei=this.stagesize.height;if(this.wid==0||this.hei==0){this.wid=this.size.width;this.hei=this.size.height}if(this.wid==0||this.hei==0){this.wid=parseInt(s7sdk.Util.css.getCss("s7zoomview","width",this.compId,null,this.container));this.hei=parseInt(s7sdk.Util.css.getCss("s7zoomview","height",this.compId,null,this.container));if(!s7sdk.Util.isNumber(this.wid)||!s7sdk.Util.isNumber(this.hei)||this.wid<=0||this.hei<=0){if("clientHeight" in this.container&&"clientWidth" in this.container){this.wid=this.container.clientWidth;this.hei=this.container.clientHeight}if(this.wid==0||this.hei==0){this.wid=400;this.hei=400}}}this.devicePixelRatio=s7sdk.Util.adjustDevicePixelRatio(this.enableHD.maxHdPixels,this.hei,this.wid);this.outWidth=this.wid*this.devicePixelRatio;this.outHeight=this.hei*this.devicePixelRatio;this.item=null;this.clickToZoom=0;if((/reset/i).test(this.singleclick)){this.clickToZoom|=s7sdk.Enum.CLICK_STATE.CLICK_TO_RESET}if((/zoom/i).test(this.singleclick)){this.clickToZoom|=s7sdk.Enum.CLICK_STATE.CLICK_TO_ZOOM}if((/reset/i).test(this.doubleclick)){this.clickToZoom|=s7sdk.Enum.CLICK_STATE.DOUBLE_CLICK_TO_RESET}if((/zoom/i).test(this.doubleclick)){this.clickToZoom|=s7sdk.Enum.CLICK_STATE.DOUBLE_CLICK_TO_ZOOM}var g=s7sdk.MediaSetParser.parseAssetForSetReq(this.asset);var f=this.serverUrl+"/"+g.name;f+="?"+g.req;if(s7sdk.Util.isNonEmptyString(this.locale)){f+="&locale="+this.locale}this.mediaSet=null;this.displayElement=s7sdk.View.createDisplay();this.displayElement.width=this.outWidth;this.displayElement.height=this.outHeight;if(s7sdk.Util.hasProperty(this.displayElement,"clientHeight")&&s7sdk.browser.name!=="ie"){this.displayElement.clientHeight=this.outHeight;this.displayElement.clientWidth=this.outWidth}this.displayElement.style.width=this.wid+"px";this.displayElement.style.height=this.hei+"px";this.displayElement.s7gesture=new s7sdk.Gesture();this.obj.appendChild(this.displayElement);if(this.container.firstChild){this.container.insertBefore(this.obj,this.container.firstChild)}else{this.container.appendChild(this.obj)}this.displayElement.onselectstart=function(){return false};s7sdk.currentContainerView=this;window.onunload=function(i){var h=s7sdk.currentContainerView;if(h&&h.view){s7sdk.Logger.log(s7sdk.Logger.FINER,"s7sdk.image.ZoomView - Page Unload Event - asset: %0",h.asset);h.view.unload(8)}};this.iconEffectObj=new s7sdk.IconEffect(this,this.iconEffect.enabled,this.iconEffect.count,this.iconEffect.fade,this.iconEffect.autoHide);this.iconEffectVisible=true;var c=this;this.handler=new s7sdk.InputController(this.displayElement);this.handler.singleTapCallback=function(i,h,j){if(c.view){if(c.clickToZoom&s7sdk.Enum.CLICK_STATE.CLICK_TO_ZOOM){if(c.clickToZoom&s7sdk.Enum.CLICK_STATE.CLICK_TO_RESET){if(c.view.state&1){c.view.zoomClick(h,j,i.shiftKey)}else{c.view.zoomReset()}}else{c.view.zoomClick(h,j,i.shiftKey)}}else{if(c.view.clickToZoom&s7sdk.Enum.CLICK_STATE.CLICK_TO_RESET){c.view.zoomReset()}}}s7sdk.Event.dispatch(c.obj,s7sdk.Event.CLICK,false)};this.handler.doubleTapCallback=function(i,h,j){h-=s7sdk.Util.getObjPos(c.obj).x;j-=s7sdk.Util.getObjPos(c.obj).y;if(c.view){if(c.clickToZoom&s7sdk.Enum.CLICK_STATE.DOUBLE_CLICK_TO_ZOOM){if(c.clickToZoom&s7sdk.Enum.CLICK_STATE.DOUBLE_CLICK_TO_RESET){if(c.view.state&1){c.view.zoomClick(h,j,i.shiftKey)}else{c.view.zoomReset()}}else{c.view.zoomClick(h,j,i.shiftKey)}}else{if(c.clickToZoom&s7sdk.Enum.CLICK_STATE.DOUBLE_CLICK_TO_RESET){c.view.zoomReset()}}}};this.handler.swipeCallback=function(h){if(c.view){if(!(c.state&4)){if(h=="right"){c.onSwipeLeft()}if(h=="left"){c.onSwipeRight()}}else{c.view.inPinch=false;c.view.inPan=false;c.view.doPan(0,0,false);c.invalidate();var i=new s7sdk.event.UserEvent(s7sdk.event.UserEvent.PAN,[],true);s7sdk.Event.dispatch(c.obj,i,false)}}};this.handler.dragCallback=function(k,h,l,j,i){if(c.view){c.view.inPan=true;c.view.doPan(j,i,true)}};this.handler.endDragCallback=function(k,h,m,j,i){if(c.view){c.view.inPinch=false;c.view.inPan=false;c.view.doPan(0,0,false);c.invalidate();var l=new s7sdk.event.UserEvent(s7sdk.event.UserEvent.PAN,[],true);s7sdk.Event.dispatch(c.obj,l,false)}};this.handler.pinchCallback=function(i,h,k,j){if(c.view){h-=s7sdk.Util.getObjPos(c.obj).x;k-=s7sdk.Util.getObjPos(c.obj).y;c.view.inPinch=true;c.view.pinchZoom(h,k,j,c.view.viewToImage)}};this.handler.endPinchCallback=function(i,h,k,j){if(c.view){c.view.inPinch=false;c.view.inPan=false;s7sdk.Logger.log(s7sdk.Logger.FINEST,"s7sdk.image.ZoomView.endPinchCallback - invalidate");c.view.invalidate(false);c.invalidate()}};if(s7sdk.browser.name==="ie"&&s7sdk.browser.version.minor<=8){var a=c.handler;this.handlerOverlay=new s7sdk.InputController(this.iconEffectObj);this.handlerOverlay.singleTapCallback=function(i,h,j){a.singleTapCallback(i,h,j)};this.handlerOverlay.doubleTapCallback=function(i,h,j){a.doubleTapCallback(i,h,j)};this.handlerOverlay.swipeCallback=function(h){a.swipeCallback(h)};this.handlerOverlay.dragCallback=function(k,h,l,j,i){a.dragCallback(k,h,l)};this.handlerOverlay.endDragCallback=function(k,h,l,j,i){a.endDragCallback(k,h,l)};this.handlerOverlay.pinchCallback=function(i,h,k,j){a.pinchCallback(i,h,k)};this.handlerOverlay.endPinchCallback=function(i,h,k,j){a.endPinchCallback(i,h,k)}}this.iconEffectVisibility={show:function(){c.iconEffectVisible=true;c.checkIconEffect()},hide:function(){c.iconEffectVisible=false;c.checkIconEffect()}};if(this.asset&&this.asset.length>0){this.isReq=new s7sdk.IS(this.serverUrl,this.asset);this.isReq.getHttpReq(f,function(i,h){s7sdk.image.ZoomView.prototype.loadRequest.apply(h,[i])},null,this)}};s7sdk.Class.inherits(s7sdk.image.ZoomView,s7sdk.UIComponent);s7sdk.image.ZoomView.prototype.modifiers={serverUrl:{params:["isRootPath"],defaults:["/is/image/"]},asset:{params:["asset"],defaults:[""],parseParams:false},iscommand:{params:["value"],defaults:[""],parseParams:false},stagesize:{params:["width","height"],defaults:[0,0],ranges:["0:","0:"],deprecated:true},size:{params:["width","height"],defaults:[0,0],ranges:["0:","0:"],deprecated:true},zoomStep:{params:["step","limit"],defaults:[1,1]},transition:{params:["time","easing"],defaults:[0.5,0],ranges:["0:","0:5"]},singleclick:{params:["singleclick"],defaults:["none"],ranges:[["none","zoom","reset","zoomReset"]]},doubleclick:{params:["doubleclick"],defaults:["zoomReset"],ranges:[["none","zoom","reset","zoomReset"]]},reset:{params:["reset"],defaults:[true]},enableHD:{params:["enable","maxHdPixels"],defaults:["limit",1500],ranges:[["always","never","limit"]]},iconEffect:{params:["enabled","count","fade","autoHide"],defaults:[true,1,0.3,3],ranges:[,"-1:","0:","0:"]},elasticZoom:{params:["elasticzoom"],defaults:[0],ranges:["0.0:1.0"],deprecated:true},fmt:{params:["fmt"],defaults:["jpg"],ranges:[["jpg","jpeg","png","png-alpha","gif","gif-alpha"]]}};s7sdk.image.ZoomView.prototype.addEventListener=function(c,b,a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.addEventListener - type: %0, handler: %1, useCapture: %2",c,b.toString().substring(0,b.toString().indexOf("(")),a);this.superproto.addEventListener.apply(this,[c,b,a])};s7sdk.image.ZoomView.prototype.setItem=function(a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.setItem - item: %0",a);if(this.isReq){this.isReq.cancelHttpReq()}if(a instanceof s7sdk.ItemDesc==false){throw new Error("Item must be a descendant of ItemDesc!")}if(a.parent==null){throw new Error("ItemDesc must be part of a parent set!")}this.mediaSet=a.parent;this.item=a;this.createView(a)};s7sdk.image.ZoomView.prototype.loadRequest=function(a){this.mediaSet=s7sdk.MediaSetParser.parse(a.set,this.imageModifier);if(this.mediaSet.items.length>0&&this.mediaSet.items[0] instanceof s7sdk.ItemDesc){this.item=this.mediaSet.items[0];this.createView(this.item)}else{throw new Error("Set response did not contain valid items! Set may be empty.")}};s7sdk.image.ZoomView.prototype.createView=function(d){var a=null;if(this.view){if(!this.reset){a=this.view.getViewPort()}this.view.unload(1|8)}var b=new s7sdk.Rectangle(0,0,d.width,d.height);var f=d.name;function c(h,g,i){h+=((h.indexOf("?")==-1)?"?":"&")+g;h+=(typeof i=="undefined")?"":"="+i;return h}if(this.iscommand!=null&&this.iscommand.length>0){f=c(f,this.iscommand)}if(s7sdk.Util.isNonEmptyString(this.locale)){f=c(f,"locale",this.locale)}if(s7sdk.Util.isNonEmptyString(d.version)){f=c(f,"id",d.version)}this.view=new s7sdk.View(this.serverUrl+f,b.width,b.height,this.outWidth,this.outHeight,this.devicePixelRatio,this.zoomStep.step,this.zoomStep.limit,this.transition.time,this.transition.easing,a,this.elasticZoom,this.clickToZoom,this.fmt,0,true);this.view.viewParent=this;if(this.container){this.view.attach(this)}this.viewStateChange(this.view.state);this.settings.trackLoad(this);var e=new s7sdk.AssetEvent(s7sdk.event.AssetEvent.ASSET_CHANGED,d,this.getIndexFromItem(d),true);this.dispatchEvent(e)};s7sdk.image.ZoomView.prototype.getIndexFromItem=function(d){if(this.mediaSet==null){throw new Error("Cannot get index of item because media-set is does not exist!")}var c=-1;var b=this.mediaSet.items;for(var a=0;a<b.length;a++){if(b[a].name==d.name){c=a;break}}return c};s7sdk.image.ZoomView.prototype.setAsset=function(a){if(typeof a!="string"){throw new Error("Asset name must be represented by a string!")}s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.setAsset - asset: %0",a);if(a==""){return}var e=this.asset;this.asset=unescape(a);this.mediaSet=null;var c=s7sdk.MediaSetParser.parseAssetForSetReq(this.asset);var b=this.serverUrl+"/"+c.name;b+="?"+c.req;if(s7sdk.Util.isNonEmptyString(this.locale)){b+="&locale="+this.locale}if(this.isReq){this.isReq.cancelHttpReq()}this.isReq=new s7sdk.IS(this.serverUrl,this.asset);this.isReq.getHttpReq(b,function(g,f){s7sdk.image.ZoomView.prototype.loadRequest.apply(f,[g])},null,this);if(e!=this.asset&&e!=null){var d=new s7sdk.event.UserEvent(s7sdk.event.UserEvent.SWAP,[0,this.asset],true);s7sdk.Event.dispatch(this.obj,d,false)}};s7sdk.image.ZoomView.prototype.getAsset=function(){return this.asset};s7sdk.image.ZoomView.prototype.zoomIn=function(){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomIn");if(this.view){this.view.zoomIn()}};s7sdk.image.ZoomView.prototype.zoomOut=function(){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomOut");if(this.view){this.view.zoomOut()}};s7sdk.image.ZoomView.prototype.zoomReset=function(){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomReset");if(this.view){this.view.zoomReset()}};s7sdk.image.ZoomView.prototype.zoomNPan=function(b,a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomNPan - dx: %0, dy: %1",b,a);if(this.view){this.view.doNPan(b,a)}};s7sdk.image.ZoomView.prototype.zoomNRgn=function(a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomNRgn - rgn: %0",a);if(this.view){this.view.zoomNRgn(a)}};s7sdk.image.ZoomView.prototype.zoomRgn=function(a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.zoomRgn - rgn: %0",a);if(this.view){this.view.zoomRgn(a)}};s7sdk.image.ZoomView.prototype.viewInvalidate=function(g){var d=new s7sdk.Rectangle(Math.round(g.x*this.view.imageWidth),Math.round(g.y*this.view.imageHeight),Math.round(g.width*this.view.imageWidth),Math.round(g.height*this.view.imageHeight));s7sdk.Event.dispatch(this.obj,new s7sdk.event.ZoomRgnEvent(s7sdk.event.ZoomRgnEvent.NOTF_ZOOM_NRGN,g),false);s7sdk.Event.dispatch(this.obj,new s7sdk.event.ZoomRgnEvent(s7sdk.event.ZoomRgnEvent.NOTF_ZOOM_RGN,d),false);if(!this.lastViewPort||this.lastViewPort.isEmpty()||g.equals(this.lastViewPort)){this.lastViewPort=g;return}var b=this.imagePixelsToViewPoint(d.topLeft());var a=this.imagePixelsToViewPoint(d.bottomRight());var e=(a.y-b.y)/(g.height*this.view.imageHeight);e=Math.round((e+0.00005)*10000)/100;if(e!=this.lastScale){if(!this.view.inTransition){}this.lastScale=e}else{var f=this.imagePixelsToViewPoint(new s7sdk.Point2D(Math.round(this.lastViewPort.x*this.view.imageWidth),Math.round(this.lastViewPort.y*this.view.imageHeight)));var i=Math.round(f.x-b.x);var h=Math.round(f.y-b.y);if(i!=0||h!=0){var c=new s7sdk.event.ZoomPanEvent(s7sdk.event.ZoomPanEvent.NOTF_ZOOM_NPAN,this.lastViewPort.x-g.x,this.lastViewPort.y-g.y);s7sdk.Event.dispatch(this.obj,c,false);c=new s7sdk.event.ZoomPanEvent(s7sdk.event.ZoomPanEvent.NOTF_ZOOM_PAN,i,h);s7sdk.Event.dispatch(this.obj,c,false)}}this.lastViewPort=g};s7sdk.image.ZoomView.prototype.viewTransitionStop=function(){var a=new s7sdk.event.UserEvent(s7sdk.event.UserEvent.ZOOM,[this.lastScale],true);s7sdk.Event.dispatch(this.obj,a,false)};s7sdk.image.ZoomView.prototype.viewStateChange=function(a){this.state=a;this.dispatchEvent(new s7sdk.event.CapabilityStateEvent(s7sdk.event.CapabilityStateEvent.NOTF_ZOOM_CAPABILITY_STATE,new s7sdk.ZoomCapabilityState(this.state)));this.checkIconEffect()};s7sdk.image.ZoomView.prototype.checkIconEffect=function(){if(this.iconEffectObj.enabled){if(!this.iconEffectVisible||(this.state&4)){this.iconEffectObj.hide()}else{if(this.iconEffectVisible){this.iconEffectObj.show(this.wid,this.hei)}}}};s7sdk.image.ZoomView.prototype.resize=function(b,a){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.resize - width: %0, height: %1",b,a);if(b==this.wid&&a==this.hei){return}this.wid=b;this.hei=a;this.devicePixelRatio=s7sdk.Util.adjustDevicePixelRatio(this.enableHD.maxHdPixels,this.hei,this.wid);this.outWidth=this.wid*this.devicePixelRatio;this.outHeight=this.hei*this.devicePixelRatio;this.displayElement.width=this.outWidth;this.displayElement.height=this.outHeight;this.displayElement.style.width=this.wid+"px";this.displayElement.style.height=this.hei+"px";if(this.view){this.view.resize(b*this.devicePixelRatio,a*this.devicePixelRatio)}if(this.iconEffectObj.enabled){this.iconEffectObj.centerOverlay(b,a)}this.dispatchEvent(new s7sdk.event.ResizeEvent(s7sdk.event.ResizeEvent.COMPONENT_RESIZE,b,a,false));s7sdk.UIComponent.prototype.resize.apply(this,[b,a])};s7sdk.image.ZoomView.prototype.onSwipeRight=function(){this.selectItemByIndex(Math.min(Math.max(0,this.getIndexFromItem(this.item)+1),this.mediaSet.items.length-1))};s7sdk.image.ZoomView.prototype.onSwipeLeft=function(){this.selectItemByIndex(Math.min(Math.max(0,this.getIndexFromItem(this.item)-1),this.mediaSet.items.length-1))};s7sdk.image.ZoomView.prototype.selectItemByIndex=function(a){if(this.mediaSet&&a>=0&&a<this.mediaSet.items.length){this.setItem(this.mediaSet.items[a])}else{throw new Error("Invalid index or media-set!")}};s7sdk.image.ZoomView.prototype.invalidate=function(){};s7sdk.image.ZoomView.prototype.imagePixelsToViewPoint=function(b){if(this.view==null){return new s7sdk.Point2D(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)}var a=this.view.imagePixelsToViewPoint(b);var d=new s7sdk.Point2D(0,0);a.x=a.x+d.x;a.y=a.y+d.y;var c=new s7sdk.Point2D(b.x-d.x,b.y-d.y);return a};s7sdk.image.ZoomView.prototype.viewPointToImagePixels=function(a){if(this.view==null){return new s7sdk.Point2D(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)}var c=new s7sdk.Point2D(0,0);var b=new s7sdk.Point2D(a.x-c.x,a.y-c.y);return this.view.viewPointToImagePixels(b)};s7sdk.image.ZoomView.prototype.getCapabilityState=function(){s7sdk.Logger.log(s7sdk.Logger.FINE,"s7sdk.image.ZoomView.getCapabilityState");return new s7sdk.ZoomCapabilityState(this.state)};s7sdk.ZoomView=s7sdk.image.ZoomView;(function addDefaultCSS(){var c=s7sdk.Util.css.createCssRuleText;var b=s7sdk.Util.css.createCssImgUrlText;var a=c(".s7zoomview",{position:"absolute","background-color":"#FFFFFF","user-select":"none","-moz-user-select":"-moz-none","-webkit-user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)"})+c(".s7zoomview .s7iconeffect",{width:"120px",height:"120px","background-repeat":"no-repeat","background-position":"center"})+c(".s7zoomview .s7iconeffect[media-type='standard']",{"background-image":b("doubletapicon.png")})+c(".s7zoomview .s7iconeffect[media-type='multitouch']",{"background-image":b("zoomicon.png")});s7sdk.Util.css.addDefaultCSS(a,"ZoomView")})()}if(!s7sdk.SwipeDetector){s7sdk.SwipeDetector=function SwipeDetector(a,b){this.speedX=0;this.currentX=0;this.lastX=0;this.onSwipeLeft=a;this.onSwipeRight=b};s7sdk.SwipeDetector.prototype.touchDown=function(a){this.speedX=a.speedX;this.currentX=a.currentX};s7sdk.SwipeDetector.prototype.touchUp=function(a){if(this.speedX>1){if(a.currentX>this.lastX){this.onSwipeLeft();return true}if(a.currentX<this.lastX){this.onSwipeRight();return true}}return false};s7sdk.SwipeDetector.prototype.touchMove=function(a){this.speedX=a.speedX;this.lastX=this.currentX;this.currentX=a.currentX}};