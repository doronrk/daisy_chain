var fromModal=false;var miCounter=0,map=null,imagePathDir=null;isFirst=false;offset=null;$(document).ready(function(){imagePathDir=$("#imagePathIcons").val();populateStoreLocatorSearchBox();if(window.addEventListener){window.addEventListener("scroll",handleScroll,false)}else{window.attachEvent("onscroll",handleScroll)}});function populateStoreLocatorSearchBox(){var locationParam=$.getUrlVar("locationEntry"),searchBox=$("#locationEntry"),geoCity=$.trim($.cookie("lc_city")),geoState=$.trim($.cookie("lc_state")),metroCode=$.cookie("metroCode"),lastValidSearch=$.cookie("lc_lastValidStoreSearch");if(searchBox.length&&($.trim(searchBox.val())==""||searchBox.val()==searchBox.attr("placeholder"))){if(locationParam!=null&&locationParam!=""){$("#locationEntry").attr("value",locationParam.replace(/\+/g," "))}else{if(lastValidSearch){$("#locationEntry").val(lastValidSearch)}else{var locationDisplay=geoCity+", "+geoState;if(geoCity&&geoState&&geoCity!="null"&&geoState!="null"&&/\w/.test(locationDisplay)&&metroCode>0){$("#locationEntry").val(locationDisplay)}}}}else{utag_data.form_name="find a store";utag_data.form_field=error_list}}$(function(){var doClose=false;$("#warningModalClose").dialog({width:500,modal:true,autoOpen:false,open:function(){$(this).closest(".ui-dialog").css("z-index","100003");$(this).closest(".ui-dialog").siblings(".ui-widget-overlay").remove();$(this).find(".continue").bind("click",function(){doClose=true;$("#locatorModal").dialog("close");$("#warningModalClose").dialog("close");return false});$(this).find(".cancel").bind("click",function(){doClose=false;$("#warningModalClose").dialog("close");return false})},close:function(){doClose=false;$(this).find(".continue, .cancel").unbind("click")}});$(".schedule-exam-store").live("click",function(e){$.cookie("thank_you_page","0",{path:"/"});var doctorModalText=$.trim($(this).parent().find(".examState").text().toLowerCase());if($(this).parent().siblings(".store-address").find(".state").text()=="tx"||doctorModalText=="tx"){storeLocation=$(this).parent().siblings(".link-options").find(".doctorInfo").attr("data-store-number");if(storeLocation===undefined||storeLocation==""){storeLocation=modalStoreNumber}var href=$(this).attr("href");storeLocatorJS.createEyeExamRedirectModal($("#texasExamModal"));return false}else{if($(this).parent().siblings(".store-address").find(".state").text()=="ca"||doctorModalText=="ca"){storeLocation=$(this).parent().siblings(".link-options").find(".doctorInfo").attr("data-store-number");if(storeLocation===undefined||storeLocation==""){storeLocation=modalStoreNumber}var href=$(this).attr("href");storeLocatorJS.createEyeExamRedirectModal($("#californiaExamModal"));return false}}})});function handleScroll(){if(window.XMLHttpRequest){var $storeResults=$(".storeLocatorResults"),$map=$("#map"),isVisible=$map.is(":visible");if($(".storeLocation").length>3&&isVisible){if(($(window).scrollTop()+20)>=offset){var positionLeft=$storeResults.offset().left+$storeResults.width()+Number($storeResults.css("marginRight").split("px")[0]);if(!($(window).scrollTop()+$(window).height()>=($(document).height()-335))){$map.addClass("fixed").css("left",positionLeft+"px").css("top","0px")}else{$map.removeClass("fixed").css("left","0px").css("top",($storeResults.height()-$map.height()-40)+"px")}}else{$map.removeClass("fixed").css("left","0px").css("top","0px")}}}}storeLocatorJS={pois:[],stLocId:null,storeName:null,storeId:null,catalogId:null,langId:null,preferredStoreNumber:0,noValidate:false,routeController:null,displayMoreLocation:function(clearCurrentResults,reloadPage){if(!isStoreLocatorPage()){storeLocatorJS.initializeMapquest()}var pageSize=3;var page=0;var startIndex=0;if(!clearCurrentResults){var numStores=$(".storeLocation").length;page=numStores/pageSize}$('input[name="page"]').val(page);if($('input[name="latLong"]').val()==null||$('input[name="latLong"]').val().length===0){$('input[name="latLong"]').val($.cookie("lc_latitude")+"|"+$.cookie("lc_longitude"))}if(reloadPage){if(clearCurrentResults){window.location=window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+$("#storeSearchForm").serialize()+"&startIndex="+startIndex;return false}startIndex=$(".store").length;$.get(getAbsoluteURL()+"AjaxStoreLocatorResultsView",$("#storeSearchForm").serialize()+"&startIndex="+startIndex,function(data){$("#hasMoreLocations").remove();$("#num-results").show();$(".disclaimer").show();if(clearCurrentResults){$(".storeLocatorResults").html(data)}else{$(".storeLocatorResults").append(data)}var storeResultNumber=$("#storeResultNumber").val();$("#number-of-store-results").html(storeResultNumber);$("#number-of-results-on-page").text($(".store").length);if($("#hasMoreLocations").val()=="true"){$(".seeMoreLocationLink").show()}else{$(".seeMoreLocationLink").hide()}$(".storeLocation").removeClass("last");$(".storeLocation").last().addClass("last");storeLocatorJS.displayMapquest(clearCurrentResults);cursor_clear();requestSubmitted=false}).done(function(){setTimeout(function(){$("a.make-preferred-store").toggleClass("sign-in-link",!constants.ajaxParams.loggedIn);$("a.make-preferred-store").toggleClass("makePreferred",constants.ajaxParams.loggedIn);$(".sign-in-link").unbind("click");$(".sign-in-link").click(function(){showLogonModal();return false})},0)})}else{$(".ui-dialog .find-a-store").hide();$("#modal-loading-icon").show();$.get(getAbsoluteURL()+"AjaxStoreLocatorResultsView",$("#storeSearchForm").serialize(),function(data){$("#hasMoreLocations").remove();$("#num-results").show();$(".disclaimer").show();if(clearCurrentResults){$(".storeLocatorResults").html(data)}else{$(".storeLocatorResults").append(data)}var storeResultNumber=$("#storeResultNumber").val();$("#number-of-store-results").html(storeResultNumber);$("#number-of-results-on-page").text($(".store").length);if($("#hasMoreLocations").val()=="true"){$(".seeMoreLocationLink").show()}else{$(".seeMoreLocationLink").hide()}$(".storeLocation").removeClass("last");$(".storeLocation").last().addClass("last");var prodId=$("#StoreLocator_ProductId").val();if(prodId!=""&&prodId!=undefined){if(storeResultNumber>0){utagViewSafe({page_name:"in store product look up",sc_event:"event31,event40"})}else{utagViewSafe({page_name:"in store product look up",sc_event:"event31,event41"})}}else{var sc_event="event8";var search_results="zero";if(storeResultNumber>0){sc_event="event10,event11";search_results=storeResultNumber}utagViewSafe({page_name:"StoreLocatorResults",page_type:"Service",sc_event:sc_event,search_results:search_results,search_term:$("#locationEntry").val()})}$(".ui-dialog .find-a-store").show();$("#modal-loading-icon").hide();storeLocatorJS.displayMapquest(clearCurrentResults);cursor_clear();requestSubmitted=false}).done(function(){setTimeout(function(){$("a.make-preferred-store").toggleClass("sign-in-link",!constants.ajaxParams.loggedIn);$("a.make-preferred-store").toggleClass("makePreferred",constants.ajaxParams.loggedIn);$(".sign-in-link").unbind("click");$(".sign-in-link").click(function(){showLogonModal();return false})},0)})}},displayMapquest:function(clearCurrentResults){$("#map").show();$("#store-locator-loading-icon").hide();if(clearCurrentResults){map.removeAllShapes()}$(".unmapped").each(function(index,storeDiv){miCounter++;var latitude=$(storeDiv).find(".latitude").val();var longitude=$(storeDiv).find(".longitude").val();var stLocId=$(storeDiv).find("input.stLocId").val();var poi=new MQA.Poi({lat:latitude,lng:longitude});var icon=new MQA.Icon(imagePathDir+"images/icons/mapquest_icon"+miCounter+".png",34,42);poi.setAltIcon(new MQA.Icon(imagePathDir+"images/icons/mapquest_icon_on_hover"+miCounter+".png",34,42));poi.setIcon(icon);storeLocatorJS.pois["stLocId-"+stLocId]=poi;var template=$("#mapDetailTemplate .mapDetailStoreInfo").clone();$(storeDiv).find(".copyToInfoWindow").each(function(index,input){template.find("."+$(input).data("name")).html($(input).html())});var getDirectionLink=$(storeDiv).find(".getDirections").attr("href");template.find(".getDirections").attr("href",getDirectionLink);MQA.EventManager.addListener(poi,"mouseover",function(evt){evt.srcObject.setAltStateFlag(true)});MQA.EventManager.addListener(poi,"infowindowopen",function(evt){evt.srcObject.setAltStateFlag(true)});MQA.EventManager.addListener(poi,"mouseout",function(evt){evt.srcObject.setAltStateFlag(false)});if(userStoresArray.length>0){if($.inArray(stLocId,userStoresArray)>=0){var parentElem=template.children(".mapquest-options");parentElem.children(".makePreferred").html("Store added");parentElem.children(".makePreferred").removeClass("makePreferred")}}poi.setRolloverContent(template.html());poi.setInfoContentHTML(template.html());map.addShape(poi);$(storeDiv).removeClass("unmapped")});if(offset==null){offset=$("#map").offset().top}map.bestFit()},isStoreLocatorResultsPage:function(){return $(".storeLocatorResults").length>0},isPreferredStoresPage:function(){return $(".stores").length>0},handleStoreSearchForm:function(form){miCounter=0;storeLocatorJS.currentForm=form;var locationEntry=form.find('input[name="locationEntry"]').val();fromModal=false;if(!locationEntry){locationEntry=form.find('input[name="modalLocationEntry"]').val();fromModal=true}locationEntry=$.trim(locationEntry);storeLocatorJS.noValidate=storeLocatorJS.currentForm.attr("id")=="storeSearchFormNoRules";if(constants.ajaxParams.countryName=="CA"){locationEntry=locationEntry}if(document.getElementById("ErrorDivStoreSearch")){document.getElementById("ErrorDivStoreSearch").innerHTML=""}if(storeLocatorJS.isStoreLocatorResultsPage()&&locationEntry==""){MessageHelper.formErrorHandleClient("location",MessageHelper.messages.ERROR_SearchBoxEmpty)}if(locationEntry!=""){var url=document.location.protocol+"//www.mapquestapi.com/geocoding/v1/batch?key=Kmjtd%7Cluu7n162n1%2C22%3Do5-h61wh&callback=renderLatLong&inFormat=kvp&outFormat=json&location="+locationEntry;var script=document.createElement("script");script.type="text/javascript";script.src=url;document.body.appendChild(script);window.lastSearchForm=form}},bindInfoWindowEvents:function(){$("a.make-preferred-store").toggleClass("sign-in-link",!constants.ajaxParams.loggedIn);$("a.make-preferred-store").toggleClass("makePreferred",constants.ajaxParams.loggedIn);var makePreferredFunction=function(e){$("#StoreAddedMsgDiv").dialog("open");tooptipContentObj=$(this);var storeDiv=$(this).parents(".mqabasicwnd-content");if(storeDiv.length==0){storeDiv=$("#storeInfoDiv")}var stLocId=storeDiv.find(".stLocId").html();if(stLocId==null){stLocId=$(this).data("stlocid");storeDiv=$(this).parents(".store");$("body").data("storeInfo",storeDiv.children(".store-address").clone())}else{$("body").data("storeInfo",storeDiv.clone())}var params={};var poi=storeLocatorJS.pois["stLocId-"+stLocId];if(poi){poi.toggleInfoWindow()}userStoresArray.push(stLocId);storeAddedResponseDiv=storeDiv;params.storeId=constants.ajaxParams.storeId;params.catalogId=constants.ajaxParams.catalogId;params.langId=constants.ajaxParams.langId;params.stLocId=stLocId;params.storeName=storeDiv.find(".storeName").html();if(params.storeName==null){params.storeName=storeDiv.find(".store-name").html()}if(this.preferredStoreNumber!=null&&this.preferredStoreNumber!=""){params.preferredStoreNumber=this.preferredStoreNumber}$(".responseStoreNameLabel").html(params.storeName);params.primary="0";params.storeNickName="";params.requesttype="ajax";$.ajax({url:getAbsoluteURL()+"AjaxUpdatePreferredStoreCmd",data:params,dataType:"html",type:"post",complete:function(response){try{var serviceResponse=filterAjaxResponse(response.responseText);storeLocatorJS.storeAddedResponseDiv=$("#StoreAddedAsPrefferedDiv");storeLocatorJS.storeId=serviceResponse.storeId;storeLocatorJS.langId=serviceResponse.langId;storeLocatorJS.catalogId=serviceResponse.catalogId;storeLocatorJS.stLocId=serviceResponse.stLocId.toString();storeLocatorJS.storeName=serviceResponse.storeName}catch(e){if(console){console.error("Could not add preferred store")}}},error:function(){if(console){console.error("Could not add preferred store")}}});e.preventDefault();return false};if(navigator.userAgent.indexOf("Mobile")==-1){$(".makePreferred").off("click").on("click",makePreferredFunction)}else{$(".makePreferred").off("click").live("click",makePreferredFunction)}$(".sign-in-link").unbind("click");$(".sign-in-link").on("click",function(){showLogonModal();return false})},makePreferredStore:function(storeLocId,storeName,storeId,catalogId,langId,storeNickName,isPreferredStore){var params={};params.storeId=storeId;params.catalogId=catalogId;params.langId=langId;params.stLocId=storeLocId.toString();params.storeNickName=storeNickName;params.storeName=storeName;params.preferredStoreNumber="0";params.primary=isPreferredStore?1:0;params.requesttype="ajax";$.ajax({url:getAbsoluteURL()+"AjaxUpdatePreferredStoreCmd",data:params,dataType:"html",type:"post",complete:function(response){try{var serviceResponse=filterAjaxResponse(response.responseText);$("#StoreAddedMsgDiv").dialog("close");$("#StoreAddedAsPrefferedDiv").dialog("open");$(".store-info-updated-content .store-name .storeName").html($(".responseStoreNameLabel").html());$(".store-preferred-info").html($("body").data("storeInfo"));$(".nick_store_name_div").text(serviceResponse.storeNickName[0]);$(".store-preferred-info .mapquest-options").hide()}catch(e){if(console){console.error("Could not add preferred store")}}},error:function(){if(console){console.error("Could not add preferred store")}}})},createEyeExamRedirectModal:function(modal){$(modal).dialog({modal:true,width:500,height:300,position:["center","center"],create:function(){$("html").scrollTop(0).addClass("cut")},open:function(){$("html").scrollTop(0).addClass("cut");$(modal).dialog("option","position",["center","center"])},beforeClose:function(){},close:function(){$("html").removeClass("cut");window.document.closeMe=null}})},initializeMapquest:function(showMap,showLocations){var mqMap=$("#map");if(showMap==null){$("#store-locator-loading-icon").show();showMap=true}if(mqMap.length>0&&mqMap.data("initialized")!=true){mqMap.data("initialized",true);var latLong={lat:39.358056,lng:-84.311944};if(showLocations){latLong.lat=$(".unmapped").find(".latitude").val();latLong.lng=$(".unmapped").find(".longitude").val()}var options={elt:document.getElementById("map"),zoom:10,latLng:latLong,mtype:"map",bestFitMargin:0,zoomOnDoubleClick:true};map=window.map=new MQA.TileMap(options);MQA.withModule("largezoom","traffictoggle","viewoptions","geolocationcontrol","insetmapcontrol","mousewheel",function(){$("#store-locator-loading-icon").hide();map.addControl(new MQA.LargeZoom(),new MQA.MapCornerPlacement(MQA.MapCorner.TOP_RIGHT,new MQA.Size(5,5)));var options={size:{width:150,height:125},zoom:3,mapType:"map",minimized:false};map.addControl(new MQA.InsetMapControl(options),new MQA.MapCornerPlacement(MQA.MapCorner.BOTTOM_RIGHT))});MQA.EventManager.addListener(map,"rolloveropen",storeLocatorJS.bindInfoWindowEvents);MQA.EventManager.addListener(map,"infowindowopen",storeLocatorJS.bindInfoWindowEvents);if(showLocations){storeLocatorJS.displayMapquest(false)}mqMap.toggle(showMap);$("#store-locator-loading-icon").toggle(!showMap)}}};var tooptipContentObj;var storeAddedResponseDiv;var updatedPoi;function redirectToHomePage(){location.href=$("#homeUrlHiddenInput")[0].value}function renderLatLong(response){var paramString="";var countryCheck=false;var invalidRes=false;paramString=paramString+response.results[0].locations[0].latLng.lat+"|"+response.results[0].locations[0].latLng.lng;if(response.results[0].locations[0].geocodeQualityCode.substring(0,2)!="A1"){if(response.results[0].locations[0].adminArea1Type=="Country"&&response.results[0].locations[0].adminArea1==$("#currentCountryName").val()){countryCheck=true}}else{invalidRes=true;requestSubmitted=false}if(countryCheck||storeLocatorJS.noValidate){if(countryCheck){storeLocatorJS.currentForm.find('input[name="latLong"]').val(paramString)}var expires="";var name="lc_lastValidStoreSearch";var data=null;if(window.lastSearchForm!=null&&$(window.lastSearchForm).find("[id=locationEntry]")){data=$(window.lastSearchForm).find("[id=locationEntry]").val()}else{data=$("#locationEntry").val()}$.cookie("lc_lastValidStoreSearch",data,{path:"/"});$.cookie("lc_latitude",response.results[0].locations[0].latLng.lat,{path:"/"});$.cookie("lc_longitude",response.results[0].locations[0].latLng.lng,{path:"/"});var isRecommendationsForm=window.lastSearchForm!=null&&$(window.lastSearchForm).attr("id")=="recs-form";if(storeLocatorJS.isStoreLocatorResultsPage()&&!isRecommendationsForm){if(!isFirst&&isStoreLocatorPage()){storeLocatorJS.displayMoreLocation(true,true);isFirst=true}else{if(!isFirst){storeLocatorJS.displayMoreLocation(true,false);isFirst=true}}}else{window.location="AjaxStoreLocatorDisplayView?"+storeLocatorJS.currentForm.serialize()}}else{if(invalidRes){$("span[for=locationEntry],#ErrorDivStoreSearch,#ModalErrorDivStoreSearch").hide();if($("#currentCountryName").val()=="US"){if(!fromModal){$("#ErrorDivStoreSearch").text("Please enter a valid City, State, or ZIP Code")}else{if(fromModal){$("#ModalErrorDivStoreSearch").text("Please enter a valid City, State, or ZIP Code")}}}else{if(!fromModal){$("#ErrorDivStoreSearch").text("Please enter a valid City, Province or Postal Code")}else{if(fromModal){$("#ModalErrorDivStoreSearch").text("Please enter a valid City, Province or Postal")}}}if($("#ErrorDivStoreSearch").siblings("div#map_accountDashBoard").size()>0){$("#ErrorDivStoreSearch").appendTo($("#ErrorDivStoreSearch").siblings("div#map_accountDashBoard").find("#storeSearchForm"))}else{if($("#ErrorDivStoreSearch").siblings("form#storeSearchForm").size()>0){$("#ErrorDivStoreSearch").appendTo($("#ErrorDivStoreSearch").siblings("form#storeSearchForm")).css("clear","none")}else{if($("#ErrorDivStoreSearch").parent("form").siblings("div#map").attr("id")=="map"){$("#ErrorDivStoreSearch").insertAfter($("#ErrorDivStoreSearch").parent("form").find(".submit-find-store")).css("clear","none").css("position","absolute").css("top","104px")}}}$("#ErrorDivStoreSearch").show();$("#ModalErrorDivStoreSearch").show()}else{if($("#currentCountryName").val()=="US"){var caUrl=$(".ca .ca_flag").attr("href");if(!fromModal){$("#ErrorDivStoreSearch").html('Did you mean to go to <a href="'+caUrl+'">LensCrafters.ca</a>?')}else{if(fromModal){$("#ModalErrorDivStoreSearch").html('Did you mean to go to <a href="'+caUrl+'">LensCrafters.ca</a>?')}}$("span[for=locationEntry]").hide()}else{var usUrl=$(".us .us_flag").attr("href");if(!fromModal){$("#ErrorDivStoreSearch").html("Please enter a valid City, Province or Postal Code")}else{if(fromModal){$("#ModalErrorDivStoreSearch").html("Please enter a valid City, Province or Postal Code")}}$("span[for=locationEntry]").hide()}if($("#ErrorDivStoreSearch").siblings("div#map_accountDashBoard").size()>0){$("#ErrorDivStoreSearch").appendTo($("#ErrorDivStoreSearch").siblings("div#map_accountDashBoard").find("#storeSearchForm"))}else{if($("#ErrorDivStoreSearch").siblings("form#storeSearchForm").size()>0){$("#ErrorDivStoreSearch").appendTo($("#ErrorDivStoreSearch").siblings("form#storeSearchForm")).css("clear","none")}else{if($("#ErrorDivStoreSearch").parent("form").siblings("div#map").attr("id")=="map"){$("#ErrorDivStoreSearch").insertAfter($("#ErrorDivStoreSearch").parent("form").find(".submit-find-store")).css("clear","none").css("position","absolute").css("top","104px")}}}$("#ErrorDivStoreSearch").show();$("#ModalErrorDivStoreSearch").show()}requestSubmitted=false}}$(document).ready(function(){$(document).keydown(function(e){if(e.keyCode==13&&$('[id="locationEntry"]').is(":focus")){var submitButton=$('[id="locationEntry"]').filter(":focus").closest("form").find('.submit-find-store, input[type="submit"]').first();if(submitButton.length){submitButton.click()}else{$(".submit-find-store").click()}}});$("#StoreAddedMsgDiv").dialog({autoOpen:false,draggable:false,resizable:false,modal:true,zIndex:9999,minWidth:490});$("#StoreAddedAsPrefferedDiv").dialog({autoOpen:false,draggable:false,resizable:false,modal:true,zIndex:9999,minWidth:590,open:function(){$(".done").bind("click",function(e){$("#StoreAddedAsPrefferedDiv").dialog("close")})},close:function(){$(".done").unbind("click")}});$("#preferredStoreChangeModalDiv").dialog({autoOpen:false,draggable:false,resizable:false,modal:true,zIndex:9999,minWidth:485,open:function(event,ui){$("input").blur()}});if(!isStoreLocatorPage()){$("#num-results").hide();$(".disclaimer").hide()}$("body").on("click",".submit-find-store",function(e){e.preventDefault();isFirst=false;miCounter=0;var parentForm=$(this).closest("form");if(parentForm.length==0){parentForm=$(this).closest(".each-saved-store").find("form.store-search-form")}if(!submitRequest()){return}cursor_wait();storeLocatorJS.handleStoreSearchForm(parentForm)});$.validator.addMethod("USPostalCode",function(value,element){$("span[for=locationEntry],#ErrorDivStoreSearch").hide();if(MessageHelper.IsNumeric(value)){return/^\d{5}|\d{5}-\d{4}$/.test(value)}else{return true}},"Please Enter a Valid US Zip Code");$.validator.addMethod("postalFormatCheckDirections",function(value,element){var regexObj={canada:/^[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]( )?\d[ABCEGHJKLMNPRSTVWXYZ]\d$/i,usa:/^\d{5}(-\d{4})?$/};if($("#storeCountryName").val()!=""&&$("#storeCountryName").val()=="US"){var regexp=new RegExp(regexObj.usa);if(value.length>0){return regexp.test(value)}}else{regexp=null;var regexp=new RegExp(regexObj.canada);if(value.length>0){return regexp.test(value)}}});$.validator.addMethod("CityStateValidation",function(value,element){var form=document.getDirectionsForm;var status=true;if(form.city.value=="City"||form.city.value==""||form.city.value.length==0){status=false}if(form.state.value==""||form.state.value.length==0){status=false}return status});$.validator.addMethod("Address1Validation",function(value,element){var form=document.getDirectionsForm;var status=true;if(form.address1.value=="Address 1"||form.address1.value==""||form.address1.value.length==0){status=false}return status});var canadaURL="";var storeSearchRequiredMessage="";var invalidPostalCode="";if($("#currentCountryName").val()=="US"){storeSearchRequiredMessage="Please enter a valid City, State, or ZIP Code";error_list.push(storeSearchRequiredMessage);invalidPostalCode="Please enter a valid ZIP code";canadaURL="LensCrafters.ca"}else{storeSearchRequiredMessage="Please enter a valid City, Province or Postal Code";invalidPostalCode="Please enter a valid Postal code";canadaURL="LensCrafters.com"}var storeSearchValidation={onfocusout:false,onclick:false,onkeyup:false,errorClass:"required",errorElement:"span",rules:{locationEntry:{required:true,USPostalCode:true,antipattern:otherCountryZipPattern}},messages:{locationEntry:{required:storeSearchRequiredMessage,minlength:"minimum 5 digits",USPostalCode:invalidPostalCode,antipattern:"Did you mean to go to "+canadaURL.link("http://"+canadaURL)+"?"}},submitHandler:function(form){$("span[for=locationEntry],#ErrorDivStoreSearch").hide();storeLocatorJS.handleStoreSearchForm($(form))},invalidHandler:function(form,validator){cursor_clear();$("span[for=locationEntry],#ErrorDivStoreSearch").hide()},errorPlacement:function(error,element){$("span[for=locationEntry],#ErrorDivStoreSearch").hide();if($(element).parent("form").attr("id")=="storeSearchForm"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}else{if($(element).parent("form").attr("name")=="NewStoreLocationAddForm"){if($(error).parent(element).siblings("div#map").attr("id")=="map"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none").css("position","absolute").css("top","104px")}else{$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}}else{if($(element).parent("form").attr("name")=="StoreLocationAddForm"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}else{if($(element).parent("div").parent("form").attr("id")=="storeSearchFormAdd"){$(error).insertAfter($(element).parent("div").parent("form").find(".submit-find-store"));$("span[for=locationEntry],#ErrorDivStoreSearch").hide()}else{$(error).insertAfter(element)}}}}}};var modalStoreSearchValidation={onfocusout:false,onclick:false,onkeyup:false,errorClass:"required",errorElement:"span",rules:{modalLocationEntry:{required:true,USPostalCode:true,antipattern:otherCountryZipPattern}},messages:{modalLocationEntry:{required:storeSearchRequiredMessage,minlength:"minimum 5 digits",USPostalCode:invalidPostalCode,antipattern:"Did you mean to go to "+canadaURL.link("http://"+canadaURL)+"?"}},submitHandler:function(form){$("span[for=modalLocationEntry],#ModalErrorDivStoreSearch").hide();storeLocatorJS.handleStoreSearchForm($(form))},invalidHandler:function(form,validator){cursor_clear();$("span[for=modalLocationEntry],#ModalErrorDivStoreSearch").hide()},errorPlacement:function(error,element){$("span[for=modalLocationEntry],#ModalErrorDivStoreSearch").hide();if($(element).parent("form").attr("id")=="storeSearchForm"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}else{if($(element).parent("form").attr("name")=="storeSearchFormChange"){if($(error).parent(element).siblings("div#map").attr("id")=="map"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none").css("position","absolute").css("top","104px")}else{$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}}else{if($(element).parent("form").attr("name")=="storeSearchFormChange"){$(error).insertAfter($(element).parent("form").find(".submit-find-store")).css("clear","none")}else{if($(element).parent("div").parent("form").attr("id")=="storeSearchForm"){$(error).insertAfter($(element).parent("div").parent("form").find(".submit-find-store"))}else{$(error).insertAfter(element)}}}}}};$("#storeSearchForm").validate(storeSearchValidation);$("#storeSearchFormChange").validate(modalStoreSearchValidation);$("#storeSearchFormGo1").validate(storeSearchValidation);$("#storeSearchFormGo2").validate(storeSearchValidation);$("#storeSearchFormGo3").validate(storeSearchValidation);$("#storeSearchFormAdd").validate(storeSearchValidation);$("#recs-form").validate(storeSearchValidation);delete storeSearchValidation.rules;$("#storeSearchFormNoRules").validate(storeSearchValidation);$("#ChangePreferredStoreLocation_Change").click(function(){$(this).parents("form").submit();return false});$("#getDirectionsForm").validate({onfocusout:false,onkeyup:function(form,event){if(event.keyCode==13){prepareGetDirectionSubmit()}},onclick:false,errorClass:"required",errorElement:"span",rules:{city:{CityStateValidation:{depends:function(element){return $("#zipCode").val()==""}}},zipCode:{required:false,postalFormatCheckDirections:{depends:function(element){return $("#zipCode").val()!=""}}}},messages:{city:{CityStateValidation:MessageHelper.messages.ERROR_ZIPCODE_CITY_STATE_EMPTY},zipCode:{postalFormatCheckDirections:MessageHelper.messages.ERROR_INVALID_ZIP_CODE}},submitHandler:function(form){prepareGetDirectionSubmit()},errorPlacement:function(error,element){if($(element).attr("name")=="state"){$(error).insertAfter(".drop_down_country");$("#state").next(".required").remove()}else{$(error).insertAfter(element)}}});$("#getDirectionsForm #zipCode").keydown(function(evt){var charCode=(evt.which)?evt.which:event.keyCode;var isUS=$("#currentCountryName").val()=="US";if(isUS){if(charCode>31&&((charCode<48||charCode>57)&&(charCode<96||charCode>105))){evt.preventDefault()}}});$(".disclaimer").on("click",".seeMoreLocationLink",function(){if(isStoreLocatorPage()){storeLocatorJS.displayMoreLocation(false,true)}else{storeLocatorJS.displayMoreLocation(false,false)}return false});$(".storeLocatorResults").on("click",".storeHours",function(){var stLocId=$(this).data("stlocid");var poi=storeLocatorJS.pois["stLocId-"+stLocId];poi.toggleInfoWindow();$(".mqabasicwnd-content .make-preferred-store").focus();return false});$(".storeLocatorResults").on("hover",".store-address",function(){var stLocId=$(this).find(">:first-child").data("stlocid");var poi=storeLocatorJS.pois["stLocId-"+stLocId];poi.toggleInfoWindowRollover();return false});$(".storeLocatorResults").on("hover",".miles",function(){var stLocId=$(this).data("stlocid");var poi=storeLocatorJS.pois["stLocId-"+stLocId];poi.toggleInfoWindow();return false});$(".change-store").click(function(){var form=document.StoreLocationSearchForm;form[1]["preferredStoreNumber"].value=$(this).data("number");$("#preferredStoreChangeModalDiv").dialog("open");return false});$(".make-preferred, .remove-store").click(function(){$(this).parents("form").submit();return false});$(".close-preferred-store").click(function(){$("#preferredStoreChangeModalDiv").dialog("close");return false});$(".makePreferredApplyButton").click(function(){var nickname=$(".storeNickName").val();var isPreferredStore=$("#isPreferredStore").is(":checked");storeLocatorJS.makePreferredStore(storeLocatorJS.stLocId,storeLocatorJS.storeName,constants.ajaxParams.storeId,constants.ajaxParams.catalogId,constants.ajaxParams.langId,nickname,isPreferredStore)});if($("#map").length>0){if(storeLocatorJS.isPreferredStoresPage()||$("#getDirectionsForm").length>0){storeLocatorJS.initializeMapquest()}}if(storeLocatorJS.isStoreLocatorResultsPage()){var showMap=false,showLocations=false;if(isStoreLocatorPage()&&$("#storeResultNumber").length&&$("#storeResultNumber").val()!="0"){showMap=true;showLocations=true}if(isStoreLocatorPage()&&$("#storeResultNumber").length){var prodId=$("#StoreLocator_ProductId").val();if(prodId!=""&&prodId!=undefined){if(storeResultNumber>0){utagViewSafe({page_name:"in store product look up",sc_event:"event31,event40"})}else{utagViewSafe({page_name:"in store product look up",sc_event:"event31,event41"})}}else{var sc_event="event8";var search_results="zero";if(storeResultNumber>0){sc_event="event10,event11";search_results=storeResultNumber}}}if($.getUrlVar("latLong")!=null){$("#latLong").val($.getUrlVar("latLong"));storeLocatorJS.initializeMapquest(showMap,showLocations)}else{if($(".storeLocatorResults:visible").length>0){storeLocatorJS.initializeMapquest(showMap,showLocations)}}if(otherCountryZipPattern.test($("#locationEntry").val())){$("span[for=locationEntry],#ErrorDivStoreSearch").hide();$("#storeSearchForm").submit()}}});function isStoreLocatorPage(){return $(".store-locator-page").length>0}function prepareGetDirectionSubmit(){var fromAddress=$("#address1").val();var fromCity=$("#city").val();var fromState=$("#state").val();var fromZipCode=$("#zipCode").val();var toAddress=$.getUrlVar("address").replace(/\+/g," ");var toCity=$.getUrlVar("city").replace(/\+/g," ");var toState=$.getUrlVar("state").replace(/\+/g," ");var toZipCode=$.getUrlVar("zip").replace(/\+/g," ");if($("#getDirectionsForm").valid()){var printLink=$("#getDirectionPrintLink"),emailLink=$("#getDirectionLink");if(!printLink.data("originalHref")){printLink.data("originalHref",printLink.attr("href"))}if(!emailLink.data("originalEmailHref")){emailLink.data("originalEmailHref",emailLink.attr("generic_email_view_url"))}if(printLink.length>0){var currentPrintUrl=printLink.data("originalHref"),currentEmailUrl=emailLink.data("originalEmailHref");var newPrintUrl=currentPrintUrl+"&fromAddress="+fromAddress+"&fromCity="+fromCity+"&fromState="+fromState+"&fromZipCode="+fromZipCode;var newEmailUrl=currentEmailUrl+encodeURI("&startAddress="+fromAddress+"&startCity="+fromCity+"&startStateProvince="+fromState+"&startPostalCode="+fromZipCode);printLink.attr("href",newPrintUrl);emailLink.attr("generic_email_view_url",newEmailUrl)}addRoute(fromAddress,fromCity,fromState,fromZipCode,toAddress,toCity,toState,toZipCode)}}function addRoute(fromAddress,fromCity,fromState,fromZipCode,toAddress,toCity,toState,toZipCode){var country=$("#storeCountryName").val();MQA.withModule("route","routeio",function(){var io=new MQA.RouteIO(MQROUTEURL,true);delegate=new MQA.Route.RouteDelegate();delegate.customizePoi=function(thePoi){$(thePoi).each(function(){if(thePoi.stopNumber==1){var icon1=new MQA.Icon(imagePathDir+"images/mapquest_icon_a.png",34,42);thePoi.setAltIcon(new MQA.Icon(imagePathDir+"images/mapquest_icon_a.png",34,42));thePoi.setIcon(icon1);map.addShape(thePoi)}if(thePoi.stopNumber==2){var icon2=new MQA.Icon(imagePathDir+"images/mapquest_icon_b.png",34,42);thePoi.setAltIcon(new MQA.Icon(imagePathDir+"images/mapquest_icon_b.png",34,42));thePoi.setIcon(icon2);map.addShape(thePoi)}})};if(storeLocatorJS.routeController!=null){storeLocatorJS.routeController.dispose()}storeLocatorJS.routeController=map.createRoute(delegate,io,false);io.route({locations:[{street:encodeURIComponent(fromAddress),city:encodeURIComponent(fromCity),state:encodeURIComponent(fromState),postalCode:encodeURIComponent(fromZipCode),country:country},{street:encodeURIComponent(toAddress),city:encodeURIComponent(toCity),state:encodeURIComponent(toState),postalCode:encodeURIComponent(toZipCode),country:country}],mapState:storeLocatorJS.routeController.delegate.virtualMapState(map)},{timeout:10000},function(results){storeLocatorJS.routeController.setRouteData(results.route);displayNarrative(results);map.bestFit();if(document.getElementById("directionsEmailPrintLink")){document.getElementById("directionsEmailPrintLink").style.display="block"}})})}function addScrollDirections(){var scrollPane=$("#scroll-pane-narrative-directions");scrollableHeight=scrollPane.height()-$("#the-directions").height()||0;if(scrollableHeight<=0){$("#slider-vertical-directions").hide();$(".scroll-bar-bottom").hide()}else{$("#slider-vertical-directions").show();$(".scroll-bar-bottom").show()}$("#slider-vertical-directions").slider({orientation:"vertical",range:"max",min:0,max:scrollableHeight,value:scrollableHeight,create:function(event,ui){},slide:function(event,ui){scrollPane.css({top:ui.value-scrollableHeight})},change:function(event,ui){if(($("#scroll-pane-narrative-directions").height()-$("#the-directions").height()||0)>0){scrollPane.css({top:ui.value-scrollableHeight})}}});$("#slider-vertical-directions a").attr("tabindex","-1")}function displayNarrative(data){$("#map").show();$(".directions-result-holder").show();scrollToElement($(".directions-result-holder"),1000);if(data.route){var allDirections="",originLatLng="",destLatLng="";var legs=data.route.legs,html="",i=0,j=0,trek,maneuver;for(;i<legs.length;i++){for(j=0;j<legs[i].maneuvers.length;j++){maneuver=legs[i].maneuvers[j];if(maneuver.index==0){html+='<div class="each-direction-step first">';originLatLng=maneuver.startPoint.lat+","+maneuver.startPoint.lng}if(maneuver.index==legs[i].maneuvers.length-1){html+='<div class="each-direction-step last">';destLatLng=maneuver.startPoint.lat+","+maneuver.startPoint.lng}if(maneuver.index!==0&&maneuver.index!==legs[i].maneuvers.length-1){html+='<div class="each-direction-step">'}html+="<div>";if(maneuver.iconUrl&&maneuver.index!==0&&maneuver.index!==legs[i].maneuvers.length-1){html+='<div class="icon-holder"><img src="'+maneuver.iconUrl+'"></div>'}if(maneuver.iconUrl&&maneuver.index==0){html+='<div class="icon-holder first"><img src="'+imagePathDir+'images/mapquest_icon_a.png"></div>'}if(maneuver.iconUrl&&maneuver.index==legs[i].maneuvers.length-1){html+='<div class="icon-holder last"><img src="'+imagePathDir+'images/mapquest_icon_b.png"></div>'}for(k=0;k<maneuver.signs.length;k++){var sign=maneuver.signs[k];if(sign&&sign.url){html+='<div class="icon-holder"><img src="'+sign.url+'"></div>'}}var multiple=Math.pow(10,2);var rndedDistance=Math.round(maneuver.distance*multiple)/multiple;html+='<div class="text-narrative"><p><span class="number">'+(j+1)+'.</span><span class="narrative"> '+maneuver.narrative+'</span></p> <span class="distance"> '+rndedDistance+" "+data.route.options.unit+"</span></div>";allDirections+=(j+1)+". "+maneuver.narrative+" `"+rndedDistance+" "+data.route.options.unit+"~";html+="</div>";html+="</div>"}}html+='<div class="hide" id="totalDist">'+data.route.distance+"</div>";html+='<div class="hide" id="allDirections">'+allDirections+"</div>";var time=data.route.formattedTime;var formattedTime=formatTime(time.substring(0,2))+" hours "+formatTime(time.substring(3,5))+" minutes "+formatTime(time.substring(6,8))+" seconds ";html+='<div class="hide" id="timeTaken">'+formattedTime+"</div>";html+='<div class="hide" id="imageUrl">http://www.mapquestapi.com/staticmap/v4/getmap?key=Kmjtd%7Cluu7n162n1%2C22%3Do5-h61wh&size=342,425&type=map&session='+data.route.sessionId+"&scenter="+originLatLng+"&ecenter="+destLatLng+"</div>";document.getElementById("scroll-pane-narrative-directions").innerHTML=html}}function formatTime(string){return(string>10)?string:string.substring(1,2)}function scheduleWithPreffStores(oldUrl){var selectedStoreId=$("#myPreffStoreSelection").val();var newUrl=oldUrl+"&storeNumber="+selectedStoreId;location.href=newUrl};