YAHOO.util.Get=function(){var M={},L=0,R=0,E=false,N=YAHOO.env.ua,S=YAHOO.lang;var J=function(W,T,X){var U=X||window,Y=U.document,Z=Y.createElement(W);for(var V in T){if(T[V]&&YAHOO.lang.hasOwnProperty(T,V)){Z.setAttribute(V,T[V])}}return Z};var I=function(T,U,W){var V=W||"utf-8";return J("link",{id:"yui__dyn_"+(R++),type:"text/css",charset:V,rel:"stylesheet",href:T},U)};var P=function(T,U,W){var V=W||"utf-8";return J("script",{id:"yui__dyn_"+(R++),type:"text/javascript",charset:V,src:T},U)};var A=function(T,U){return{tId:T.tId,win:T.win,data:T.data,nodes:T.nodes,msg:U,purge:function(){D(this.tId)}}};var B=function(T,W){var U=M[W],V=(S.isString(T))?U.win.document.getElementById(T):T;if(!V){Q(W,"target node not found: "+T)}return V};var Q=function(W,V){var T=M[W];if(T.onFailure){var U=T.scope||T.win;T.onFailure.call(U,A(T,V))}};var C=function(W){var T=M[W];T.finished=true;if(T.aborted){var V="transaction "+W+" was aborted";Q(W,V);return}if(T.onSuccess){var U=T.scope||T.win;T.onSuccess.call(U,A(T))}};var O=function(V){var T=M[V];if(T.onTimeout){var U=T.scope||T;T.onTimeout.call(U,A(T))}};var G=function(V,Z){var U=M[V];if(U.timer){U.timer.cancel()}if(U.aborted){var X="transaction "+V+" was aborted";Q(V,X);return}if(Z){U.url.shift();if(U.varName){U.varName.shift()}}else{U.url=(S.isString(U.url))?[U.url]:U.url;if(U.varName){U.varName=(S.isString(U.varName))?[U.varName]:U.varName}}var c=U.win,b=c.document,a=b.getElementsByTagName("head")[0],W;if(U.url.length===0){if(U.type==="script"&&N.webkit&&N.webkit<420&&!U.finalpass&&!U.varName){var Y=P(null,U.win,U.charset);Y.innerHTML='YAHOO.util.Get._finalize("'+V+'");';U.nodes.push(Y);a.appendChild(Y)}else{C(V)}return}var T=U.url[0];if(!T){U.url.shift();return G(V)}if(U.timeout){U.timer=S.later(U.timeout,U,O,V)}if(U.type==="script"){W=P(T,c,U.charset)}else{W=I(T,c,U.charset)}F(U.type,W,V,T,c,U.url.length);U.nodes.push(W);if(U.insertBefore){var e=B(U.insertBefore,V);if(e){e.parentNode.insertBefore(W,e)}}else{a.appendChild(W)}if((N.webkit||N.gecko)&&U.type==="css"){G(V,T)}};var K=function(){if(E){return}E=true;for(var T in M){var U=M[T];if(U.autopurge&&U.finished){D(U.tId);delete M[T]}}E=false};var D=function(a){var X=M[a];if(X){var Z=X.nodes,T=Z.length,Y=X.win.document,W=Y.getElementsByTagName("head")[0];if(X.insertBefore){var V=B(X.insertBefore,a);if(V){W=V.parentNode}}for(var U=0;U<T;U=U+1){W.removeChild(Z[U])}X.nodes=[]}};var H=function(U,T,V){var X="q"+(L++);V=V||{};if(L%YAHOO.util.Get.PURGE_THRESH===0){K()}M[X]=S.merge(V,{tId:X,type:U,url:T,finished:false,aborted:false,nodes:[]});var W=M[X];W.win=W.win||window;W.scope=W.scope||W.win;W.autopurge=("autopurge" in W)?W.autopurge:(U==="script")?true:false;S.later(0,W,G,X);return{tId:X}};var F=function(c,X,W,U,Y,Z,b){var a=b||G;if(N.ie){X.onreadystatechange=function(){var d=this.readyState;if("loaded"===d||"complete"===d){X.onreadystatechange=null;a(W,U)}}}else{if(N.webkit){if(c==="script"){if(N.webkit>=420){X.addEventListener("load",function(){a(W,U)})}else{var T=M[W];if(T.varName){var V=YAHOO.util.Get.POLL_FREQ;T.maxattempts=YAHOO.util.Get.TIMEOUT/V;T.attempts=0;T._cache=T.varName[0].split(".");T.timer=S.later(V,T,function(j){var f=this._cache,e=f.length,d=this.win,g;for(g=0;g<e;g=g+1){d=d[f[g]];if(!d){this.attempts++;if(this.attempts++>this.maxattempts){var h="Over retry limit, giving up";T.timer.cancel();Q(W,h)}else{}return}}T.timer.cancel();a(W,U)},null,true)}else{S.later(YAHOO.util.Get.POLL_FREQ,null,a,[W,U])}}}}else{X.onload=function(){a(W,U)}}}};return{POLL_FREQ:10,PURGE_THRESH:20,TIMEOUT:2000,_finalize:function(T){S.later(0,null,C,T)},abort:function(U){var V=(S.isString(U))?U:U.tId;var T=M[V];if(T){T.aborted=true}},script:function(T,U){return H("script",T,U)},css:function(T,U){return H("css",T,U)}}}();YAHOO.register("get",YAHOO.util.Get,{version:"2.7.0",build:"1799"});YAHOO.namespace("util");YAHOO.util.Cookie={_createCookieString:function(B,D,C,A){var F=YAHOO.lang;var E=encodeURIComponent(B)+"="+(C?encodeURIComponent(D):D);if(F.isObject(A)){if(A.expires instanceof Date){E+="; expires="+A.expires.toGMTString()}if(F.isString(A.path)&&A.path!=""){E+="; path="+A.path}if(F.isString(A.domain)&&A.domain!=""){E+="; domain="+A.domain}if(A.secure===true){E+="; secure"}}return E},_createCookieHashString:function(B){var D=YAHOO.lang;if(!D.isObject(B)){throw new TypeError("Cookie._createCookieHashString(): Argument must be an object.")}var C=new Array();for(var A in B){if(D.hasOwnProperty(B,A)&&!D.isFunction(B[A])&&!D.isUndefined(B[A])){C.push(encodeURIComponent(A)+"="+encodeURIComponent(String(B[A])))}}return C.join("&")},_parseCookieHash:function(E){var D=E.split("&"),F=null,C=new Object();if(E.length>0){for(var B=0,A=D.length;B<A;B++){F=D[B].split("=");C[decodeURIComponent(F[0])]=decodeURIComponent(F[1])}}return C},_parseCookieString:function(J,A){var K=new Object();if(YAHOO.lang.isString(J)&&J.length>0){var B=(A===false?function(L){return L}:decodeURIComponent);if(/[^=]+=[^=;]?(?:; [^=]+=[^=]?)?/.test(J)){var H=J.split(/;\s/g),I=null,C=null,E=null;for(var D=0,F=H.length;D<F;D++){E=H[D].match(/([^=]+)=/i);if(E instanceof Array){try{I=decodeURIComponent(E[1]);C=B(H[D].substring(E[1].length+1))}catch(G){}}else{I=decodeURIComponent(H[D]);C=I}K[I]=C}}}return K},get:function(A,B){var D=YAHOO.lang;var C=this._parseCookieString(document.cookie);if(!D.isString(A)||A===""){throw new TypeError("Cookie.get(): Cookie name must be a non-empty string.")}if(D.isUndefined(C[A])){return null}if(!D.isFunction(B)){return C[A]}else{return B(C[A])}},getSub:function(A,C,B){var E=YAHOO.lang;var D=this.getSubs(A);if(D!==null){if(!E.isString(C)||C===""){throw new TypeError("Cookie.getSub(): Subcookie name must be a non-empty string.")}if(E.isUndefined(D[C])){return null}if(!E.isFunction(B)){return D[C]}else{return B(D[C])}}else{return null}},getSubs:function(A){if(!YAHOO.lang.isString(A)||A===""){throw new TypeError("Cookie.getSubs(): Cookie name must be a non-empty string.")}var B=this._parseCookieString(document.cookie,false);if(YAHOO.lang.isString(B[A])){return this._parseCookieHash(B[A])}return null},remove:function(B,A){if(!YAHOO.lang.isString(B)||B===""){throw new TypeError("Cookie.remove(): Cookie name must be a non-empty string.")}A=A||{};A.expires=new Date(0);return this.set(B,"",A)},removeSub:function(B,D,A){if(!YAHOO.lang.isString(B)||B===""){throw new TypeError("Cookie.removeSub(): Cookie name must be a non-empty string.")}if(!YAHOO.lang.isString(D)||D===""){throw new TypeError("Cookie.removeSub(): Subcookie name must be a non-empty string.")}var C=this.getSubs(B);if(YAHOO.lang.isObject(C)&&YAHOO.lang.hasOwnProperty(C,D)){delete C[D];return this.setSubs(B,C,A)}else{return""}},set:function(B,C,A){var E=YAHOO.lang;if(!E.isString(B)){throw new TypeError("Cookie.set(): Cookie name must be a string.")}if(E.isUndefined(C)){throw new TypeError("Cookie.set(): Value cannot be undefined.")}var D=this._createCookieString(B,C,true,A);document.cookie=D;return D},setSub:function(B,D,C,A){var F=YAHOO.lang;if(!F.isString(B)||B===""){throw new TypeError("Cookie.setSub(): Cookie name must be a non-empty string.")}if(!F.isString(D)||D===""){throw new TypeError("Cookie.setSub(): Subcookie name must be a non-empty string.")}if(F.isUndefined(C)){throw new TypeError("Cookie.setSub(): Subcookie value cannot be undefined.")}var E=this.getSubs(B);if(!F.isObject(E)){E=new Object()}E[D]=C;return this.setSubs(B,E,A)},setSubs:function(B,C,A){var E=YAHOO.lang;if(!E.isString(B)){throw new TypeError("Cookie.setSubs(): Cookie name must be a string.")}if(!E.isObject(C)){throw new TypeError("Cookie.setSubs(): Cookie value must be an object.")}var D=this._createCookieString(B,this._createCookieHashString(C),false,A);document.cookie=D;return D}};YAHOO.register("cookie",YAHOO.util.Cookie,{version:"2.7.0",build:"1799"});RightNow.namespace("Chat.UI");RightNow.Chat.UI.EventBus=function(){function a(a,b){b=b[0];h.setConnectionParameters(b.data.connectionData);var c=b.data.agentAbsentRetryCount,d=b.data.surveyCompID,e=b.data.surveyTermID;q=b.data.closingUrl;r=b.data.surveyBaseUrl;c&&h.setAgentAbsentRetryCount(c);d&&h.setCompletedSurveyID(d);e&&h.setCancelledSurveyID(e);t=b.data.terminateChatSessionString;RightNow.Event.fire("evt_chatSetParametersResponse",b)}function b(a,b){b=b[0];b.data.valid=RightNow.Chat.UI.Validator.validate(b.data);RightNow.Event.fire("evt_chatValidateParametersResponse",b)}function c(a,b){var b=b[0],c=!1;if(b.data.firstNameRequired&&!b.data.firstName||b.data.lastNameRequired&&!b.data.lastName||b.data.emailRequired&&!b.data.email){c=!0}b.data.anonymousRequest=c;RightNow.Event.fire("evt_chatCheckAnonymousResponse",b)}function g(a,b){h.logon(b[0])}function f(a,b){RightNow.Event.fire("evt_chatConnectResponse",b[0])}function e(){h.fetchUpdate()}function l(a,b){RightNow.Event.fire("evt_chatFetchUpdateResponse",b[0])}function i(a,b){RightNow.Event.fire("evt_chatStateChangeResponse",b[0])}function o(a,b){RightNow.Event.fire("evt_chatAgentStatusChangeResponse",b[0])}function k(a,b){RightNow.Event.fire("evt_chatEngagementParticipantAddedResponse",b[0])}function j(a,b){var c=b[0].data.reason,d=RightNow.Chat.Model.ChatDisconnectReason;c===d.PARTICIPANT_LEFT||c===d.TRANSFERRED_TO_QUEUE?RightNow.Event.fire("evt_chatEngagementParticipantRemovedResponse",b[0]):(c===d.AGENT_CONCLUDED||b[0].data.isUserDisconnect)&&RightNow.Event.fire("evt_chatEngagementConcludedResponse",b[0])}function m(a,b){h.logoff(!1,b[0].data.isCancelled);if(b[0].data.isCancelled){var c=h.getCancelledSurveyID(),d=YAHOO.lang.trim(b[0].data.cancelingUrl);c!==0?(window.open(r+"/5/"+c+"/7/"+h.getEngagementID()),setTimeout("window.close()",2000)):d!==""&&(window.open(d),setTimeout("window.close()",2000))}}function d(a,b){if(b[0].data.isOffTheRecord==null){b[0].data.isOffTheRecord=!1}if(b[0].data.isEndUserPost&&(b[0].data.endUser=h.getEndUser(),b[0].data.postMessage!==!1)){b[0].data.messageId=h.postMessage(b[0].data.messageBody,b[0].data.isOffTheRecord)}RightNow.Event.fire("evt_chatPostResponse",b[0])}function u(a,b){var c=b[0].data.keyEvent?b[0].data.keyEvent.keyCode:null;if((c===null||c!==YAHOO.util.KeyListener.KEY.BACK_SPACE&&c!==YAHOO.util.KeyListener.KEY.DELETE)&&!h.isMessageAllowed(b[0].data.inputValue,b[0].data.isOffTheRecord)){c=new RightNow.Event.EventObject,c.data.inputValueBeforeChange=b[0].data.inputValueBeforeChange,c.w_id=b[0].w_id,RightNow.Event.fire("evt_chatPostLengthExceededResponse",c)}h.handleChatPostMessageKeyUp(b[0].data.keyEvent,b[0].data.inputValue)}function p(a,b){RightNow.Event.fire("evt_chatQueuePositionNotificationResponse",b[0])}function v(a,b){RightNow.Event.fire("evt_chatSendButtonClickResponse",b[0])}function w(){var a=++n.transactionID;n[a]={};h.notifyFileAttach()}function x(a,b){b[0].transactionID=n.transactionID;RightNow.Event.fire("evt_chatNotifyFattachUpdateResponse",b[0])}function y(){var a=RightNow.Interface.getConfig("CP_FILE_UPLOAD_MAX_TIME");RightNow.Ajax.makeRequest("/ci/fattach/upload/",null,{data:{eventName:"evt_fileUploadUpdate",data:{transactionID:n.transactionID}},uploadHandler:RightNow.Ajax.genericSuccess,timeout:a*1000||300000})}function z(a,b){var c=new RightNow.Event.EventObject;c.data=b[0];c.data.transactionID=b[1].transactionID;RightNow.Event.fire("evt_chatNotifyFileUploadRequest",c)}function A(a,b){if(n[b[0].data.transactionID].canceled){b[0].data.error=2}h.notifyFileUploaded(b[0])}function B(a,b){RightNow.Event.fire("evt_fileUploadUpdateResponse",b[1])}function C(){if(n[n.transactionID]){n[n.transactionID].canceled=!0}}function D(a,b){RightNow.Event.fire("evt_chatCobrowseInvitationResponse",b[0])}function E(a,b){b[0].data.accepted=!0;RightNow.Event.fire("evt_chatCobrowseAcceptResponse",b[0]);h.sendCoBrowseAction(RightNow.Chat.Model.ChatCoBrowseStatusCode.ACCEPTED)}function F(a,b){b[0].data.accepted=!1;RightNow.Event.fire("evt_chatCobrowseAcceptResponse",b[0]);h.sendCoBrowseAction(RightNow.Chat.Model.ChatCoBrowseStatusCode.DECLINED)}function G(a,b){RightNow.Event.fire("evt_chatCobrowseStatusResponse",b[0])}function H(a,b){RightNow.Event.fire("evt_chatOffTheRecordButtonClickResponse",b[0])}function I(a,b){var c=h.getCompletedSurveyID(),d=!1;c!==0?(d=!0,s(r+"/5/"+c+"/7/"+h.getEngagementID())):q!=null?(d=!0,s(q)):b[0].closingUrl&&s(b[0].closingUrl,!0);d?setTimeout("window.close()",500):window.close()}function J(){h.setSearchPerformed(!0)}function K(a,b){RightNow.Event.fire("evt_chatReconnectUpdateResponse",b[0])}function L(a,b){RightNow.Event.fire("evt_chatAgentAbsentUpdateResponse",b[0])}function s(a,b){a.match(/^(http[s]?|ftp):\/\//i)||(a=a.match(/^ftp\./i)?"ftp://"+a:"http://"+a);b?window.opener.location=a:window.open(a)}var q=null,h=null,n={transactionID:-1},r=null,t=null;this.initializeEventBus=function(){h=RightNow.Chat.Controller.ChatCommunicationsController;RightNow.Event.subscribe("evt_chatSetParametersRequest",a);RightNow.Event.subscribe("evt_chatValidateParametersRequest",b);RightNow.Event.subscribe("evt_chatCheckAnonymousRequest",c);RightNow.Event.subscribe("evt_chatConnectRequest",g);RightNow.Event.subscribe("evt_chatConnectUpdate",f);RightNow.Event.subscribe("evt_chatFetchUpdateRequest",e);RightNow.Event.subscribe("evt_chatFetchUpdateComplete",l);RightNow.Event.subscribe("evt_chatStateChange",i);RightNow.Event.subscribe("evt_chatEngagementParticipantAdded",k);RightNow.Event.subscribe("evt_chatAgentStatusChange",o);RightNow.Event.subscribe("evt_chatDisconnectNotification",j);RightNow.Event.subscribe("evt_chatHangupRequest",m);RightNow.Event.subscribe("evt_chatPostMessageRequest",d);RightNow.Event.subscribe("evt_chatQueuePositionNotification",p);RightNow.Event.subscribe("evt_chatPostMessageKeyUpRequest",u);RightNow.Event.subscribe("evt_chatSendButtonClickRequest",v);RightNow.Event.subscribe("evt_chatNotifyFattachLocalRequest",w);RightNow.Event.subscribe("evt_chatNotifyFattachUpdate",x);RightNow.Event.subscribe("evt_chatFileUploadRequest",y);RightNow.Event.subscribe("evt_fileUploadUpdate",z);RightNow.Event.subscribe("evt_chatNotifyFileUploadRequest",A);RightNow.Event.subscribe("evt_chatNotifyFileUploadUpdate",B);RightNow.Event.subscribe("evt_fileUploadCancelRequest",C);RightNow.Event.subscribe("evt_chatCobrowseInvitation",D);RightNow.Event.subscribe("evt_chatCoBrowseAcceptRequest",E);RightNow.Event.subscribe("evt_chatCoBrowseDenyRequest",F);RightNow.Event.subscribe("evt_chatCobrowseStatusNotification",G);RightNow.Event.subscribe("evt_chatOffTheRecordButtonClickRequest",H);RightNow.Event.subscribe("evt_chatCloseButtonClickRequest",I);RightNow.Event.subscribe("evt_searchRequest",J);RightNow.Event.subscribe("evt_chatReconnectUpdate",K);RightNow.Event.subscribe("evt_chatAgentAbsentUpdate",L);RightNow.Event.fire("evt_chatEventBusInitializedResponse",null);this._eventBusInitialized=!0};this.isEventBusInitialized=function(){return this._eventBusInitialized};this.onWindowClose=function(){if(h.isConnected()){return t}};this.onWindowUnload=function(){h.isConnected()&&h.logoff(!0)};this.onKeyDown=function(a){a.keyCode&&a.keyCode===YAHOO.util.KeyListener.KEY.ESCAPE&&YAHOO.util.Event.stopEvent(a)}};RightNow.Chat.UI.Util=RightNow.Chat.UI.Util||{doPositionAndWaitTimeVariableSubstitution:function(a,b,c){a=this.replaceStringAndSurroundingSpace(a,"${queue-position}","<span id='rn_"+b+"_QueuePosition'></span>");a=a.replace("${wait-time-samples}",c);a=this.replaceStringAndSurroundingSpace(a,"${estimated-wait-time}","<span id='rn_"+b+"_EstimatedWaitTime'></span>");return a=this.replaceStringAndSurroundingSpace(a,"${average-wait-time}","<span id='rn_"+b+"_AverageWaitTime'></span>")},replaceStringAndSurroundingSpace:function(a,b,c){a=a.replace(" "+b+" ","&nbsp;"+c+"&nbsp;");a=a.replace(" "+b,"&nbsp;"+c);a=a.replace(b+" ",c+"&nbsp;");return a=a.replace(b,c)},toIso8601Time:function(a){if(a<=0){return a}var b,c,g=0;b=Math.floor(a/3600);c=Math.floor(a%3600/60);g=a%60;a="";b>0&&(a=b<10?"0"+b:b,a+=":");c<10?a=a+"0"+c:a+=c;a+=":";g<10?a=a+"0"+g:a+=g;return a}};RightNow.Chat.UI.Validator=RightNow.Chat.UI.Validator||{validate:function(a){return a.email&&!RightNow.Text.isValidEmailAddress(a.email)?!1:a.prod&&!this.isInteger(a.prod)?!1:a.cat&&!this.isInteger(a.cat)?!1:!this.validateCustomFields(a.miscellaneousData,a.customFields)?!1:!0},validateCustomFields:function(a,b){if(!a){return !0}for(var c in a){if(!this.validateCustomField(c,a[c],b)){return !1}}return !0},validateCustomField:function(a,b,c){a=a.substring(5);c=c[a];if(!c){return !1}switch(c.data_type){case RightNow.Interface.Constants.EUF_DT_DATE:case RightNow.Interface.Constants.EUF_DT_DATETIME:if(!this.isValidDateTime(b)){return !1}break;case RightNow.Interface.Constants.EUF_DT_INT:if(!this.isInteger(b)){return !1}b=parseInt(b,10);if(c.min_val&&b<parseInt(c.min_val,10)){return !1}if(c.max_val&&b>parseInt(c.max_val,10)){return !1}break;case RightNow.Interface.Constants.EUF_DT_RADIO:if(!this.isInteger(b)){return !1}if(b!="0"&&b!="1"){return !1}}return !0},isInteger:function(a){return/^-?\d+$/.test(a)},isValidDateTime:function(a){var b=/^\d{1,2}:\d{1,2}$/,a=a.split(" ");if(!/^\d{4}-\d{1,2}-\d{1,2}$/.test(a[0])||a[1]&&!b.test(a[1])){return !1}var b=a[0].split("-"),c=a[1]?a[1].split(":"):null,a=null,a=c?new Date(b[0],b[1]-1,b[2],c[0],c[1]):new Date(b[0],b[1]-1,b[2]);if(a.getFullYear()!=b[0]||a.getMonth()+1!=b[1]||a.getDate()!=b[2]){return !1}if(c!=null&&(a.getHours()!=c[0]||a.getMinutes()!=c[1])){return !1}b=new Date(2038,0,18);return a<new Date(1970,0,2)||a>=b?!1:!0}};try{document.createElement("p").doScroll("left"),YAHOO.util.Event.onDOMReady=function(a,b,c){YAHOO.util.Event.addListener(window,"load",a,b,c)}}catch(e$$5){}YAHOO.util.Event.onDOMReady(function(){var a=RightNow.Chat.UI;a.EventBus=new a.EventBus;a.EventBus.initializeEventBus();window.onbeforeunload=a.EventBus.onWindowClose;window.onunload=a.EventBus.onWindowUnload;YAHOO.util.Event.addListener(document,"keydown",a.EventBus.onKeyDown,null,this)},null,this);RightNow.namespace("Chat.Model");RightNow.Chat.Model.ChatEndUserAction={LOGON:"LOGON",LOGOFF:"LOGOFF",GETUPDATE:"GETUPDATE",SEND_TEXT:"SEND_TEXT",ACTIVITY_STATUS:"ACTIVITY_STATUS",PROACTIVE_QUERY:"PROACTIVE_QUERY",COBROWSE:"COBROWSE",NOTIFY_FATTACH:"NOTIFY_FATTACH",FATTACH_UPLOAD:"FATTACH_UPLOAD"};RightNow.Chat.Model.ChatState={UNDEFINED:0,SEARCHING:1,CONNECTED:2,REQUEUED:3,CANCELLED:4,DEQUEUED:5,DISCONNECTED:6,RECONNECTING:7};RightNow.Chat.Model.ChatCreateEngagementResumeCode={NONE:"NONE",RESUME:"RESUME",DO_NOT_RESUME:"DO_NOT_RESUME"};RightNow.Chat.Model.ChatActivityState={LISTENING:"LISTENING",RESPONDING:"RESPONDING",ABSENT:"ABSENT"};RightNow.Chat.Model.ChatParticipantConnectionState={ABSENT:"ABSENT",ACTIVE:"ACTIVE",DISCONNECTED:"DISCONNECTED"};RightNow.Chat.Model.ChatConclusionReason={ENDED_USER_CANCEL:"ENDED_USER_CANCEL",ENDED_USER_DEFLECTED:"ENDED_USER_DEFLECTED"};RightNow.Chat.Model.ChatDisconnectReason={AGENT_CONCLUDED:"AGENT_CONCLUDED",END_USER_CONCLUDED:"END_USER_CONCLUDED",QUEUE_TIMEOUT:"QUEUE_TIMEOUT",IDLE_TIMEOUT:"IDLE_TIMEOUT",EJECTED:"EJECTED",TRANSFERRED_TO_QUEUE:"TRANSFERRED_TO_QUEUE",PARTICIPANT_LEFT:"PARTICIPANT_LEFT",NO_AGENTS_AVAILABLE:"NO_AGENTS_AVAILABLE"};RightNow.Chat.Model.ChatCoBrowseType={SCREEN_POINTER:"SCREEN_POINTER",SCREEN:"SCREEN",MOUSE_NAVIGATION:"MOUSE_NAVIGATION",DESKTOP_CONTROL:"DESKTOP_CONTROL"};RightNow.Chat.Model.ChatCoBrowseStatusCode={ACCEPTED:"ACCEPTED",DECLINED:"DECLINED",UNAVAILABLE:"UNAVAILABLE",TIMEOUT:"TIMEOUT",STARTED:"STARTED",STOPPED:"STOPPED",ERROR:"ERROR"};RightNow.Chat.Model.CommunicationMethod={AJAX_POST:"AJAX_POST",YUI_GET:"YUI_GET",RNW_REDIRECT:"RNW_REDIRECT",XDOMAIN_REQUEST:"XDOMAIN_REQUEST"};RightNow.Chat.Model.Agents=function(){this._agents={}};RightNow.Chat.Model.Agents.prototype={_leadAgentID:null,addAgent:function(a,b,c,g){b={name:b,greeting:c,clientID:a};this._agents[a]=b;if(g){this._leadAgentID=a}return b},getAgent:function(a){return this._agents[a]},getLeadAgentID:function(){return this._leadAgentID},setLeadAgentID:function(a){this._leadAgentID=a},setActivityStatus:function(a,b){this._agents[a].activityStatus=b}};RightNow.Chat.Model.Agents=new RightNow.Chat.Model.Agents;RightNow.Chat.Model.EndUser={activityStatus:RightNow.Chat.Model.ChatActivityState.LISTENING,firstName:"",lastName:"",servletSessionID:"",email:""};RightNow.namespace("Chat.Communicator");RightNow.Chat.Communicator=function(){this._currentGetTransaction=null;this._communicationMethod=RightNow.Chat.Model.CommunicationMethod.YUI_GET;this._baseParameters=this._baseUrl="";this._invocationTimeout=this._javaSessionID=null;this._redirectUrl="/ci/ajaxRequest/doChatRequest";this._siteName="";this._msXMLProgID=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"];this._clusterPoolID="";this._appendRandomURLValue=!1;this._lastTransactionID=0};RightNow.Chat.Communicator.prototype={initialize:function(a){var b=navigator.userAgent,c=b.indexOf("Firefox/");if(c!==-1){if(parseFloat(b.substring(c+8))>=3.5){this._communicationMethod=RightNow.Chat.Model.CommunicationMethod.AJAX_POST}}else{if(YAHOO.env.ua.ie>=8&&window.XDomainRequest){this._communicationMethod=RightNow.Chat.Model.CommunicationMethod.XDOMAIN_REQUEST}else{if(navigator.vendor&&navigator.vendor.indexOf("Apple")!==-1&&b.indexOf("iPhone")===-1){if(c=b.indexOf("Version"),c!==-1&&(b=parseFloat(b.substring(c+8)))&&b>=4){this._communicationMethod=RightNow.Chat.Model.CommunicationMethod.AJAX_POST}}else{if(b.indexOf("iPhone")!==-1){this._appendRandomURLValue=!0}else{if(b.indexOf("Chrome")!==-1&&window.XMLHttpRequest){this._communicationMethod=RightNow.Chat.Model.CommunicationMethod.AJAX_POST}}}}}if(b=YAHOO.util.Cookie.get("CHAT_SESSION_ID")){this._javaSessionID=b}this._baseUrl="http"+(a.useHttps?"s":"")+"://"+a.chatServerHost+(a.chatServerPort===80||a.chatServerPort===443?"":":"+a.chatServerPort)+"/Chat/chat/"+a.dbName;this._clusterPoolID=RightNow.Interface.getConfig("CHAT_CLUSTER_POOL_ID");this._baseParameters="site_name="+a.dbName+"&responseType=JSON";this._siteName=a.dbName},setJavaSessionID:function(a){this._javaSessionID=a},setClusterPoolID:function(a){this._clusterPoolID=a},makeRequest:function(a,b,c,g,f,e,l,i,o){var k=this._communicationMethod;if(i){k=RightNow.Chat.Model.CommunicationMethod.RNW_REDIRECT}if(e&&(k!==RightNow.Chat.Model.CommunicationMethod.YUI_GET||a.offTheRecord===!0)){return a.msg.length>349525?!1:!0}k===RightNow.Chat.Model.CommunicationMethod.RNW_REDIRECT&&YAHOO.lang.augmentObject(a,{chatAction:a.action||a.chatAction,message:a.msg||a.message,action:null,msg:null},!0);l==null&&(l=!0);var j=this._baseUrl;if(this._javaSessionID!=null){k===RightNow.Chat.Model.CommunicationMethod.RNW_REDIRECT?a.jsessionID=this._javaSessionID:j+=";jsessionid="+this._javaSessionID}j+="?"+(this._clusterPoolID===""?"":"pool="+this._clusterPoolID+"&");i=null;if(b&&typeof b==="object"){i=b.argument,b=b.callback}var m=this._baseParameters+(b?"&callback="+b:"")+(i!==null?"&callbackArgument="+i:"")+"&"+RightNow.Ajax.convertObjectToPostString(a);o&&(m+="&tId="+ ++this._lastTransactionID);if(k===RightNow.Chat.Model.CommunicationMethod.YUI_GET&&l){j+=m;this._appendRandomURLValue===!0&&(j+="&r="+(new Date).getTime());if(e){return o&&this._lastTransactionID--,j.length>2083?!1:!0}f&&this.abortRequest(this._currentGetTransaction);return this._currentGetTransaction=YAHOO.util.Get.script(j,{autopurge:!0,scope:g})}else{if(k===RightNow.Chat.Model.CommunicationMethod.RNW_REDIRECT&&l){YAHOO.lang.augmentObject(a,{site_name:this._siteName,callback:b,responseType:"JSON"}),i!==null?(YAHOO.lang.augmentObject(a,{callbackArgument:RightNow.JSON.stringify(i)}),typeof i!=="object"&&(i={argument:i})):i={},YAHOO.lang.augmentObject(i,{failureCallback:c,scope:g}),RightNow.Ajax.makeRequest(this._redirectUrl,a,{data:{data:i},successHandler:RightNow.Chat.Communicator.onRnwRedirectSuccess,failureHandler:RightNow.Chat.Communicator.onRnwRedirectFailure,scope:this})}else{if(k===RightNow.Chat.Model.CommunicationMethod.XDOMAIN_REQUEST&&l){var d=new XDomainRequest;d.open("POST",j+"action="+a.action+"&parametersTextInBody=true");d.onFailure=c;d.callbackScope=g;d.onload=function(){if(d.contentType!=="text/plain"||d.responseText==="null"){if(d.onFailure){if(d.callbackScope){d.onFailure.apply(d.callbackScope,[d])}else{d.onFailure(d)}}}else{eval(d.responseText)}};d.onprogress=function(){};d.timeout=f?15000:45000;d.onerror=d.ontimeout=function(){if(d.onFailure){if(d.callbackScope){d.onFailure.apply(d.callbackScope,[d])}else{d.onFailure(d)}}};d.send(m)}else{d=null;if(k===RightNow.Chat.Model.CommunicationMethod.RNW_REDIRECT){j=this._redirectUrl}if(window.XMLHttpRequest){d=new XMLHttpRequest}else{if(window.ActiveXObject){for(b=0;b<this._msXMLProgID.length;++b){try{d=new ActiveXObject(this._msXMLProgID[b]);break}catch(u){}}}}var p=function(){if(d.readyState==4){if(clearTimeout(this._invocationTimeout),d.status==200){d.responseText!="null"&&eval(d.responseText)}else{if(d.onFailure){if(d.callbackScope){d.onFailure.apply(d.callbackScope,[d])}else{d.onFailure(d)}}}}};if(d){if(window.XMLHttpRequest){b=function(){d.open("POST",j,l);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(c){d.onFailure=c}if(g){d.callbackScope=g}d.onreadystatechange=p;d.send(m);this._invocationTimeout=setTimeout(function(){(d.readyState===1||d.readyState===2||d.readyState===3)&&d.abort()},f?15000:45000)},a.action!==RightNow.Chat.Model.ChatEndUserAction.LOGOFF&&a.chatAction!==RightNow.Chat.Model.ChatEndUserAction.LOGOFF?setTimeout(b,0):b()}else{if(window.ActiveXObject){d.open("POST",j,l),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.onreadystatechange=p,d.send(m),this._invocationTimeout=setTimeout(function(){(d.readyState===1||d.readyState===2||d.readyState===3)&&d.abort()},f?15000:45000)}}}return d}}}},abortRequest:function(a){try{a!=null&&(this._communicationMethod===RightNow.Chat.Model.CommunicationMethod.YUI_GET?YAHOO.util.Get.abort(a):window.XMLHttpRequest&&a.abort())}catch(b){}},isYuiGetTransaction:function(){return this._communicationMethod===RightNow.Chat.Model.CommunicationMethod.YUI_GET},getLastTransactionID:function(){return this._lastTransactionID},isXDRTransaction:function(){return this._communicationMethod===RightNow.Chat.Model.CommunicationMethod.XDOMAIN_REQUEST},onRnwRedirectSuccess:function(a){a.responseText===null||a.responseText===""||a.responseText.indexOf("RightNow.Chat.Controller")!==0||eval(a.responseText)},onRnwRedirectFailure:function(a){a.argument.failureCallback&&(a.argument.scope?a.argument.failureCallback.apply(a.argument.scope,[a]):a.argument.failureCallback())}};RightNow.namespace("Chat.Controller");RightNow.Chat.Controller.ChatCommunicationsController=function(){RightNow.Chat.Communicator=new RightNow.Chat.Communicator;this._absentIntervalMS=null;this._agentAbsentRetryCount=2;this._agentAbsentIntervalsRemaining=null;this._agents=RightNow.Chat.Model.Agents;this._beginProcessingTimestamp=null;this._completedSurveyID=this._cancelledSurveyID=0;this._chatCommunicator=RightNow.Chat.Communicator;this._connected=!1;this._currentState=null;this._currentlySendingMessage=!1;this._endUser=RightNow.Chat.Model.EndUser;this._engagementID=-1;this._fetchUpdateFailures=0;this._firstParticipant=!0;this._postMessageResponseTimer=this._fetchUpdateResponseTimer=null;this._postMessageRetryCount=0;this._lastPostedMessageID=-1;this._responseSentMilliseconds=this._reconnectTimer=this._currentAbsentInterval=this._myClientID=this._maxAbsentIntervals=this._logonResponseTimer=null;this._retryReconnect=!0;this._stateBeforeReconnect=null;this._statusTimerId=0;this._searchPerformed=!1;this._timeUpdateRequested=null;this._messageSendQueue=[];this._xmlDateRE=RegExp(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(\.[0-9]+)?.*$/)};RightNow.Chat.Controller.ChatCommunicationsController.prototype={setConnectionParameters:function(a){this._absentIntervalMS=a.absentInterval?a.absentInterval*1000:120000;this._maxAbsentIntervals=a.absentRetryCount?a.absentRetryCount:2;this._chatCommunicator.initialize(a)},setAgentAbsentRetryCount:function(a){this._agentAbsentIntervalsRemaining=this._agentAbsentRetryCount=a},setState:function(a,b){if(!(this._currentState==RightNow.Chat.Model.ChatState.CANCELLED||this._currentState==RightNow.Chat.Model.ChatState.DISCONNECTED||this._currentState==RightNow.Chat.Model.ChatState.DEQUEUED)){var c=new RightNow.Event.EventObject;c.data.previousState=this._currentState;c.data.currentState=this._currentState=a;c.data.reason=b;RightNow.Event.fire("evt_chatStateChange",c)}},isConnected:function(){return this._connected},getState:function(){return this._currentState},setAgentActivityStatus:function(a,b){var c=new RightNow.Event.EventObject;if(this._agents.getAgent(a)!=null){c.data.previousState=this._agents.getAgent(a).activityStatus,this._agents.setActivityStatus(a,b),c.data.agent=this._agents.getAgent(a),RightNow.Event.fire("evt_chatAgentStatusChange",c)}},setEndUserActivityStatus:function(a){this._endUser.activityStatus=a;this._chatCommunicator.makeRequest({action:RightNow.Chat.Model.ChatEndUserAction.ACTIVITY_STATUS,mode:a})},handleChatPostMessageKeyUp:function(a,b){var c=RightNow.Chat.Model.ChatActivityState;clearTimeout(this._statusTimerId);if(!(a&&a.keyCode===13)&&(b===""&&this._endUser.activityStatus!==c.LISTENING?this.setEndUserActivityStatus(c.LISTENING):b!==""&&this._endUser.activityStatus!==c.RESPONDING&&this.setEndUserActivityStatus(c.RESPONDING),this._endUser.activityStatus===c.RESPONDING)){this._statusTimerId=setTimeout('RightNow.Chat.Controller.ChatCommunicationsController.setEndUserActivityStatus("'+c.LISTENING+'")',5000)}},onLogonSuccess:function(a){clearTimeout(this._logonResponseTimer);var b=null;if(a.responses!=null){b=a.responses[0].chatCreateEngagementResult}if(b!=null){var c=b.resultCode.value;this._chatCommunicator.setJavaSessionID(a.responses[0].sessionId);this._myClientID=a.responses[0].clientId;this._endUser.servletSessionID=a.responses[0].sessionId;this._engagementID=b.engagementId;YAHOO.util.Cookie.set("CHAT_SESSION_ID",a.responses[0].sessionId,{path:"/",expires:new Date((new Date).getTime()+7200000)});if(this._cancelledSurveyID===0&&b.cancelledSurveyId){this._cancelledSurveyID=b.cancelledSurveyId}if(this._completedSurveyID===0&&b.completedSurveyId){this._completedSurveyID=b.completedSurveyId}}a=new RightNow.Event.EventObject;a.data.connected=!0;if(c=="EXISTING_SESSION"){a.data.existingSession=!0}RightNow.Event.fire("evt_chatConnectUpdate",a);if(!a.data.existingSession){c==="FAIL_OUT_OF_HOURS"||c==="FAIL_HOLIDAY"||c==="FAIL_NO_AGENTS_AVAIL"||c==="FAIL_RULE_DEQUEUE"||b==null?this.setStateByReasonCode(c):(this._connected=!0,this.setState(RightNow.Chat.Model.ChatState.SEARCHING))}},onLogonFailure:function(){var a=new RightNow.Event.EventObject;a.data.connected=!1;RightNow.Event.fire("evt_chatConnectUpdate",a)},logon:function(a){var a=a.data,b=this.onLogonFailure;this._endUser.firstName=a.firstName;this._endUser.lastName=a.lastName;this._endUser.email=a.email;var c={action:RightNow.Chat.Model.ChatEndUserAction.LOGON,first_name:a.firstName,last_name:a.lastName,email:a.email,c_id:a.contactID,question:a.subject,org_id:a.organizationID,request_src:a.requestSource,prod_id:a.prod,cat_id:a.cat,survey_send_id:a.surveySendID,survey_send_delay:a.surveySendDelay,queue_id:a.queueID,intf_id:a.interfaceID,s_id:a.sessionID,i_id:a.incidentID};if(a.resume!=null){c.resume=a.resume?RightNow.Chat.Model.ChatCreateEngagementResumeCode.RESUME:RightNow.Chat.Model.ChatCreateEngagementResumeCode.DO_NOT_RESUME}for(var g in a.miscellaneousData){c[g]=a.miscellaneousData[g]}this._chatCommunicator.isYuiGetTransaction()?(this._chatCommunicator.makeRequest(c,"RightNow.Chat.Controller.ChatCommunicationsController.onLogonSuccess",b,this,!1,!0)?this._chatCommunicator.makeRequest(c,"RightNow.Chat.Controller.ChatCommunicationsController.onLogonSuccess",b):this._chatCommunicator.makeRequest(c,"RightNow.Chat.Controller.ChatCommunicationsController.onLogonSuccess",b,this,!1,!1,!0,!0),this._logonResponseTimer=setTimeout(function(){RightNow.Chat.Controller.ChatCommunicationsController.onLogonFailure.apply(this)},7000)):this._chatCommunicator.makeRequest(c,"RightNow.Chat.Controller.ChatCommunicationsController.onLogonSuccess",b)},setCancelledSurveyID:function(a){this._cancelledSurveyID=a},setCompletedSurveyID:function(a){this._completedSurveyID=a},getCancelledSurveyID:function(){return this._cancelledSurveyID},getCompletedSurveyID:function(){return this._completedSurveyID},getEndUser:function(){return this._endUser},getEngagementID:function(){return this._engagementID},setSearchPerformed:function(a){this._searchPerformed=a},setStateByReasonCode:function(a){var b;b=a==="FAIL_OUT_OF_HOURS"||a==="FAIL_HOLIDAY"||a==="FAIL_NO_AGENTS_AVAIL"||a==="ENDED_USER_CANCEL"||a==="QUEUE_TIMEOUT"||a==="ENDED_USER_DEFLECTED"?RightNow.Chat.Model.ChatState.CANCELLED:a=="FAIL_RULE_DEQUEUE"?RightNow.Chat.Model.ChatState.DEQUEUED:a=="TRANSFERRED_TO_QUEUE"?RightNow.Chat.Model.ChatState.REQUEUED:RightNow.Chat.Model.ChatState.DISCONNECTED;this._firstParticipant=!0;this.setState(b,a)},logoff:function(a,b){var c;b&&(c=this._searchPerformed?RightNow.Chat.Model.ChatConclusionReason.ENDED_USER_DEFLECTED:RightNow.Chat.Model.ChatConclusionReason.ENDED_USER_CANCEL);var g={action:RightNow.Chat.Model.ChatEndUserAction.LOGOFF,reason:c};a?this._chatCommunicator.isYuiGetTransaction()||this._chatCommunicator.isXDRTransaction()?this._chatCommunicator.makeRequest(g,"RightNow.Chat.Controller.ChatCommunicationsController.onLogoffSuccess",null,this,!1,!1,!1,!0):this._chatCommunicator.makeRequest(g,"RightNow.Chat.Controller.ChatCommunicationsController.onLogoffSuccess",null,this,!1,!1,!1):this._chatCommunicator.makeRequest(g,"RightNow.Chat.Controller.ChatCommunicationsController.onLogoffSuccess");this.setStateByReasonCode(c)},onLogoffSuccess:function(){this._connected=!1},fetchUpdate:function(){var a=RightNow.Chat.Controller.ChatCommunicationsController;if(!(this._currentState==RightNow.Chat.Model.ChatState.CANCELLED||this._currentState==RightNow.Chat.Model.ChatState.DEQUEUED||this._currentState==RightNow.Chat.Model.ChatState.DISCONNECTED)){var b=a.onFetchUpdateFailure,c={action:RightNow.Chat.Model.ChatEndUserAction.GETUPDATE};if(this._fetchUpdateFailures>0){c.useContinuation=!1}if(this._responseSentMilliseconds!=null){c.lastGetRequestMilliseconds=this._responseSentMilliseconds-((new Date).getTime()-this._beginProcessingTimestamp)}this.logDebug("Fetching update from chat service...");this._timeUpdateRequested=(new Date).getTime();this._chatCommunicator.makeRequest(c,"RightNow.Chat.Controller.ChatCommunicationsController.onFetchUpdate",b,a,this._fetchUpdateFailures>0,!1,!0,!1,!0);if(this._chatCommunicator.isYuiGetTransaction()){if(this._fetchUpdateResponseTimer!==null){this._fetchUpdateResponseTimer=null,clearTimeout(this._fetchUpdateResponseTimer)}this._fetchUpdateResponseTimer=setTimeout(function(){RightNow.Chat.Controller.ChatCommunicationsController.onFetchUpdateFailure.apply(a)},this._fetchUpdateFailures>0?15000:45000)}}},onFetchUpdate:function(a){this._beginProcessingTimestamp=(new Date).getTime();this.logDebug("Update fetched from chat service in "+(this._beginProcessingTimestamp-this._timeUpdateRequested)+" milliseconds");var b=!1;if(this._fetchUpdateFailures>0){if(this._reconnectTimer!==null){clearInterval(this._reconnectTimer),this._reconnectTimer=null}this._retryReconnect=!0;this._fetchUpdateFailures=0;this.containsError(a.responses)||this.setState(this._stateBeforeReconnect);this._messageSendQueue.length-1>this._lastPostedMessageID&&this.postMessageHelper(this._lastPostedMessageID+1)}if(a.responses!=null&&a.responses.length>0){for(var c=0;c<a.responses.length;c++){if(a.responses[c].sequenceNumber&&!b&&(b=a.responses[0].sequenceNumber,(b=this._chatCommunicator.getLastTransactionID()===b)&&this._fetchUpdateResponseTimer!==null)){clearTimeout(this._fetchUpdateResponseTimer),this._fetchUpdateResponseTimer=null}if(a.responses[c].getResponseTypes!==null){this._responseSentMilliseconds=a.responses[c].responseSentMilliseconds;for(var g=0;g<a.responses[c].getResponseTypes.length;g++){var f=a.responses[c].getResponseTypes[g],e=new RightNow.Event.EventObject,l=f.chatMessageType;try{switch(l){case"ChatQueuePositionNotification":e.data={position:f.position,expectedWaitSeconds:f.expectedWaitSeconds,averageWaitSeconds:f.averageWaitSeconds};RightNow.Event.fire("evt_chatQueuePositionNotification",e);break;case"ChatDisconnectNotification":var i=f.clientId;e.data.reason=f.reason.value;e.data.disconnectClientId=i;i!==this._myClientID?e.data.agent=this._agents.getAgent(i):e.data.reason==="AGENT_CONCLUDED"||e.data.reason==="TRANSFERRED_TO_QUEUE"?e.data.agent=this._agents.getAgent(this._agents.getLeadAgentID()):e.data.isUserDisconnect=!0;RightNow.Event.fire("evt_chatDisconnectNotification",e);if(e.data.reason==="QUEUE_TIMEOUT"){this.setStateByReasonCode(e.data.reason),this._connected=!1}else{if(e.data.reason==="TRANSFERRED_TO_QUEUE"){this.setStateByReasonCode(e.data.reason)}else{if(i===this._myClientID||e.data.reason==="AGENT_CONCLUDED"){this.setState(RightNow.Chat.Model.ChatState.DISCONNECTED),this._connected=!1}}}break;case"ChatEngagementParticipantAdded":e.data.role=f.role.value;e.data.agent=this._agents.addAgent(f.clientId,f.name,f.greeting,f.role.value==="LEAD");if(f.role.value==="LEAD"){this._agentAbsentIntervalsRemaining=this._agentAbsentRetryCount}RightNow.Event.fire("evt_chatEngagementParticipantAdded",e);if(this._firstParticipant){this._firstParticipant=!1,this.setState(RightNow.Chat.Model.ChatState.CONNECTED)}break;case"ChatRoleChangeNotification":this._agents.setLeadAgentID(f.leadClientId);break;case"ChatActivitySignal":this.setAgentActivityStatus(f.clientId,f.mode.value);break;case"ChatPostMessage":var o=f.senderId;e.data.messageBody=f.body;e.data.isOffTheRecord=f.offTheRecord;e.data.serviceFinishTime=this.createServiceFinishTimestamp(a.responses[c].serviceFinishTime);f.senderType.value==="AGENT"?(this.setAgentActivityStatus(o,RightNow.Chat.Model.ChatActivityState.LISTENING),e.data.agent=this._agents.getAgent(f.senderId)):(e.data.postMessage=!1,e.data.isEndUserPost=!0,e.data.endUser=this._endUser);RightNow.Event.fire("evt_chatPostMessageRequest",e);break;case"ChatCoBrowseInvitationMessage":e.data={modeType:f.modeType.value,coBrowseUrl:f.url,agent:this._agents.getAgent(f.senderId)};RightNow.Event.fire("evt_chatCobrowseInvitation",e);break;case"ChatCoBrowseStatusNotification":e.data.coBrowseStatus=f.status.value;e.data.coBrowseData=f.data;RightNow.Event.fire("evt_chatCobrowseStatusNotification",e);break;case"ChatEngagementUpdateNotification":var k=RightNow.Chat.Model.ChatParticipantConnectionState,j=f.clientId,m=f.connectionState.value;if(m===k.ABSENT&&j!==this._myClientID){if(this._agents.getAgent(j).activityStatus!==k.ABSENT&&this.setAgentActivityStatus(j,RightNow.Chat.Model.ChatActivityState.ABSENT),this._agents.getLeadAgentID()===j){this._agentAbsentIntervalsRemaining--,e.data.requeueSeconds=this._absentIntervalMS/1000*this._agentAbsentIntervalsRemaining,RightNow.Event.fire("evt_chatAgentAbsentUpdate",e)}}else{if(m===k.ACTIVE&&j!==this._myClientID&&(this.setAgentActivityStatus(j,RightNow.Chat.Model.ChatActivityState.LISTENING),this._agents.getLeadAgent()===j)){this._agentAbsentIntervalsRemaining=this._agentAbsentRetryCount}}break;case"ChatConfigChangeNotification":f.name==="CHAT_CLUSTER_POOL_ID"&&this._chatCommunicator.setClusterPoolID(f.value);break;case"ChatSystemError":this.setState(RightNow.Chat.Model.ChatState.DISCONNECTED,"ERROR"),this._connected=!1}}catch(d){this.logDebug("Error processing "+l+": "+d)}}}}}else{this.setState(RightNow.Chat.Model.ChatState.DISCONNECTED,"ERROR"),this._connected=!1}b&&RightNow.Event.fire("evt_chatFetchUpdateComplete",null)},onFetchUpdateFailure:function(a){this.logDebug("Fetch update failure after "+((new Date).getTime()-this._timeUpdateRequested)+" milliseconds");var b=this;this._fetchUpdateFailures++;if(this._postMessageResponseTimer!==null){clearTimeout(this._postMessageResponseTimer),this._postMessageResponseTimer=null}if(this._retryReconnect){if(this._reconnectTimer===null){this._reconnectTimer=setInterval(function(){RightNow.Chat.Controller.ChatCommunicationsController.reconnectIntervalExpired.apply(b)},this._absentIntervalMS)}if(this._fetchUpdateFailures===1){this._currentAbsentInterval=0,this._stateBeforeReconnect=this._currentState,this.setState(RightNow.Chat.Model.ChatState.RECONNECTING),this.updateReconnectStatus()}a&&a.status===-1?this.fetchUpdate():setTimeout(function(){RightNow.Chat.Controller.ChatCommunicationsController.fetchUpdate.apply(b)},5000)}else{this.setState(RightNow.Chat.Model.ChatState.DISCONNECTED,"RECONNECT_FAILED"),this._connected=!1}},containsError:function(a){for(var b=0;b<a.length;b++){if(a[b].getResponseTypes!=null){for(var c=0;c<a[b].getResponseTypes.length;c++){if(a[b].getResponseTypes[c].chatMessageType==="ChatSystemError"){return !0}}}}return !1},reconnectIntervalExpired:function(){this._currentAbsentInterval++;if(this._currentAbsentInterval>=this._maxAbsentIntervals){if(this._retryReconnect=!1,this._reconnectTimer!==null){clearInterval(this._reconnectTimer),this._reconnectTimer=null}}else{RightNow.Chat.Controller.ChatCommunicationsController.updateReconnectStatus()}},updateReconnectStatus:function(){var a=new RightNow.Event.EventObject;a.data.secondsLeft=(this._maxAbsentIntervals-this._currentAbsentInterval)*this._absentIntervalMS/1000;RightNow.Event.fire("evt_chatReconnectUpdate",a)},isMessageAllowed:function(a,b){return this._chatCommunicator.makeRequest({action:RightNow.Chat.Model.ChatEndUserAction.SEND_TEXT,msg:a,offTheRecord:b},null,null,this,!1,!0)},postMessage:function(a,b){a!=""&&(this._messageSendQueue[this._messageSendQueue.length]={action:RightNow.Chat.Model.ChatEndUserAction.SEND_TEXT,msg:a,offTheRecord:b},this._currentlySendingMessage===!1&&this.postMessageHelper(this._messageSendQueue.length-1));return this._messageSendQueue.length-1},postMessageHelper:function(a){this._currentlySendingMessage=!0;var b=this._messageSendQueue[a],c=this,a={callback:"RightNow.Chat.Controller.ChatCommunicationsController.onPostMessageSuccess",argument:a},g=c.onPostMessageFailure;b.offTheRecord&&this._chatCommunicator.isYuiGetTransaction()?this._chatCommunicator.makeRequest(b,a,g,this,!1,!1,!0,!0):this._chatCommunicator.makeRequest(b,a,g,this);if(this._chatCommunicator.isYuiGetTransaction()){this._postMessageResponseTimer=setTimeout(function(){RightNow.Chat.Controller.ChatCommunicationsController.onPostMessageFailure.apply(c)},15000)}this._endUser.activityStatus=RightNow.Chat.Model.ChatActivityState.LISTENING;clearTimeout(this._statusTimerId)},onPostMessageSuccess:function(a){clearTimeout(this._postMessageResponseTimer);var b=parseInt(a.data,10);this._lastPostedMessageID=b;this._postMessageRetryCount=0;if(a.responses!==null&&(new Date).getTime()-this._timeUpdateRequested>30000){var c=a.responses[0];c!==null&&c.chatPostResult!==null&&c.chatPostResult.clientReset===2&&this.fetchUpdate()}RightNow.Event.fire("evt_chatPostCompletion",b,this.createServiceFinishTimestamp(a.responses[0].serviceFinishTime));this._messageSendQueue[b+1]!==void 0?this.postMessageHelper(b+1):this._currentlySendingMessage=!1},onPostMessageFailure:function(){var a=this;this._postMessageRetryCount++;this._postMessageRetryCount<=5?this._chatCommunicator.isYuiGetTransaction()?this.postMessageHelper(this._lastPostedMessageID+1):this._postMessageResponseTimer=setTimeout(function(){RightNow.Chat.Controller.ChatCommunicationsController.postMessageHelper.apply(a,[a._lastPostedMessageID+1])},15000):(this.setState(RightNow.Chat.Model.ChatState.DISCONNECTED,"ERROR"),this._connected=!1)},notifyFileAttachSuccess:function(a){a.responses!=null&&RightNow.Event.fire("evt_chatNotifyFattachUpdate",a.responses)},notifyFileAttach:function(){this._chatCommunicator.makeRequest({action:RightNow.Chat.Model.ChatEndUserAction.NOTIFY_FATTACH,engagementId:this._engagementID,sessionId:this._endUser.servletSessionID},"RightNow.Chat.Controller.ChatCommunicationsController.notifyFileAttachSuccess")},notifyFileUploadSuccess:function(a){if(a.responses!==null){var b=a.data[0];this._chatCommunicator.isXDRTransaction()&&(b=RightNow.Text.Encoding.utf8Decode(b));RightNow.Event.fire("evt_chatNotifyFileUploadUpdate",a.responses,RightNow.JSON.parse(b))}},notifyFileUploaded:function(a){var b={action:RightNow.Chat.Model.ChatEndUserAction.FATTACH_UPLOAD,engagementId:this._engagementID,sessionId:this._endUser.servletSessionID,status:a.data.error===0?"RECEIVED":"ERROR",localFName:a.data.tmp_name,userFName:a.data.name,contentType:a.data.type,fileSize:a.data.size},a={error:a.data.error,name:a.data.name,size:a.data.size,transactionID:a.data.transactionID},a=RightNow.JSON.stringify(a);return this._chatCommunicator.makeRequest(b,{callback:"RightNow.Chat.Controller.ChatCommunicationsController.notifyFileUploadSuccess",argument:a})},sendCoBrowseAction:function(a){this._chatCommunicator.makeRequest({action:RightNow.Chat.Model.ChatEndUserAction.COBROWSE,cobrowse_action:a})},logDebug:function(a){if(!(window.console===void 0||window.console.log===void 0)){var b=YAHOO.util.Cookie.get("location");b&&(b=b.split("~"));b&&b[0]&&(b=b[0]);b==="development"&&window.console.log(a)}},createServiceFinishTimestamp:function(a){a=a.match(this._xmlDateRE);return !a?null:(new Date(a[1],a[2],a[3],a[4],a[5],a[6],a[7]?a[7]:"")).getTime()}};RightNow.Chat.Controller.ChatCommunicationsController=new RightNow.Chat.Controller.ChatCommunicationsController;