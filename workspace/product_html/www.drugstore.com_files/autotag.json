if (!Array.prototype.filter)
{
    Array.prototype.filter = function(fun /*, thisp*/)
    {
        var len = this.length;
        if (typeof fun != "function")
            throw new TypeError();

        var res = [];
        var thisp = arguments[1];
        for (var i = 0; i < len; i++)
        {
            if (i in this)
            {
                var val = this[i]; // in case fun mutates this
                if (fun.call(thisp, val, i, this))
                    res.push(val);
            }
        }

        return res;
    };
}

if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function (obj, start) {
        for (var i = (start || 0); i < this.length; i++) {
            if (this[i] == obj) {
                return i;
            }
        }
        return -1;
    }
}

function AdextentAutotag(){
    this.MAX_PRODUCTS = 3;
    this.urlMode = "auto"; // /window/iframe/auto
    this.skipCanonical = "false" == "true";
    this.fireHeliumPixel = "true" == "true";
    this.dontSendProductIds = "false" == "true";
    this.fireFacebookPixel = "false" == "true";
    this.enableSync = "false" == "true";
    this.domainParameter = "false" == "true";
    this.sendAudienceOnConversion = "false" == "true";
    this.visitOnConversion = "false" == "true";
    this.domain = "drugstore.com";
    this.heliumTimeout = isNaN(parseInt("0")) ? 0 : parseInt("0");
    this.hasTimeout = this.heliumTimeout > 0;
    this.dev = false; //for testing

    this.getScriptParent = function() {
        var scripts = document.getElementsByTagName('script');
        for (var i = 0; i < scripts.length; ++i) {
            if(scripts[i].src.indexOf("/dynads/ServeS3.ashx/autotag") != -1 ||
                scripts[i].src.indexOf("/dynads/ServeS3.ashx/a/autotag") != -1 ||
                scripts[i].src.indexOf("dyau9xqp8gzji.cloudfront.net/autotag.js") != -1){
                return scripts[i].parentElement;
            }
        }
        return document.getElementsByTagName('body')[0];
    }

    this.setCookie = function( name, value, secure )
    {
        var today = new Date();
        today.setTime( today.getTime() );
        var expires = 1000 * 60 * 60 * 24 * 30 * 12; // year
        var expires_date = new Date( today.getTime() + (expires) );
        document.cookie = name + "=" + encodeURIComponent(value) +
            ( ";expires=" + expires_date.toGMTString() ) +
            ";path=/" +
            (location.host.indexOf("adextent.com") > -1 ? (";domain=.adextent.com") : "") +
            ( ( secure == true) ? ";secure" : "" );
    };
    this.getCookie = function( check_name ) {
        var a_all_cookies = document.cookie.split( ';' );
        var a_temp_cookie = '';
        var cookie_name = '';
        var cookie_value = '';
        var b_cookie_found = false;
        for ( i = 0; i < a_all_cookies.length; i++ ){
            a_temp_cookie = a_all_cookies[i].split( '=' );
            cookie_name = a_temp_cookie[0].replace(/^\s+|\s+$/g, '');
            if ( cookie_name == check_name ){
                b_cookie_found = true;
                if ( a_temp_cookie.length > 1 ){
                    cookie_value = unescape(a_temp_cookie.slice(1).join("=").replace(/^\s+|\s+$/g, '') );
                }
                return cookie_value;
                break;
            }
            a_temp_cookie = null;
            cookie_name = '';
        }
        if ( !b_cookie_found ){
            return null;
        }
    };

    this.deserializeAdextentCookie = function(cookie){
        if(!cookie){
            return [];
        }

        var res = [];
        var audienceParts = cookie.split('~');
        for(var i=0; i<audienceParts.length; ++i){
            var audienceObj = {};
            audienceObj.keys = [];
            var parts = audienceParts[i].split(':');
            audienceObj.audience = parts[0];
            var allKeys = parts[1].split(';');
            audienceObj.firstKey = allKeys[0];
            if(allKeys.length == 1){
                audienceObj.keys = [allKeys[0]];
            }
            else{
                allKeys.splice(0, 1);
                audienceObj.keys = allKeys;
            }
            res.push(audienceObj);
        }
        return res;
    };

    this.serializeAdextentCookie = function(obj){
        var strings = [];
        for(var i=0; i< obj.length; ++i){
            var audienceString = obj[i].audience + ":" + obj[i].firstKey;
            if(obj[i].keys.length > 0)
                audienceString += (";" + obj[i].keys.join(";"));
            strings.push(audienceString);
        }
        return strings.join("~");
    };

    this.newAudience = function(name){
        return {audience:name, firstKey:'', keys:[]};
    };

    this.getAdextentCookie = function(domain){
        var cookie = this.getCookie("v2_" + domain);
        return this.deserializeAdextentCookie(cookie);
    };



    this.setAdextentCookie = function(domain, audience, key){
        var currentObj = this.getAdextentCookie(domain);
        var match = currentObj.filter(function(o) {return o.audience == audience});
        var aud;
        if(match.length == 0){
            aud = this.newAudience(audience);
            currentObj.push(aud);
        }else{
            aud = match[0];
        }


        if(!aud.firstKey){
            aud.firstKey = key;
            aud.keys.push(key);
        }
        else{
            if(aud.keys.indexOf(key) > -1)
                aud.keys.splice(aud.keys.indexOf(key), 1);
            while(aud.keys.length > this.MAX_PRODUCTS-1)
                aud.keys.shift();
            aud.keys.push(key);
        }
        this.setCookie("v2_" + domain, this.serializeAdextentCookie(currentObj));
    };

    this.getParams = function(url)
    {
        var loc;
        var prms = {};
        if(url){
            loc = url.split("?")[1];
        }
        else{
            loc=location.search;
            if (loc){
                loc=loc.substring(1);
            }
        }
        if (loc){
            var parms = loc.split('&');
            for(var i=0;i<parms.length;i++){
                kv=parms[i].split('=');
                prms[kv[0]]= unescape(kv.slice(1).join("="));
            }
        }
        return prms;
    };
    this.toQueryString = function(obj) {
        var parts = [];
        for (var i in obj) {
            if (obj.hasOwnProperty(i)) {
                parts.push(encodeURIComponent(i) + "=" + encodeURIComponent(obj[i]));
            }
        }
        return parts.join("&");
    };
    this.addScript = function(scriptPath){
        var th = this.getScriptParent();
        if(!th)
            return;
        var s = document.createElement('script');
        s.setAttribute('type','text/javascript');
        s.setAttribute('src',scriptPath);
        s.onError = s.onerror = function()
        {
            return false;
        }
        th.appendChild(s);
    };
    this.cleanUrl = function(url)
    {
        //${CLEAN_URL_CODE}
        //url = encodeURIComponent(url.replace("://www.","://").replace(/\/$/,"")).toLowerCase().replace(/%/g,"");
        return url.replace(/\/$/,"") + ".js";
    };
    this.getCanonical = function(){
        try{
            var doc = window.top && window.top.document ? window.top.document : document;
            var links = doc.getElementsByTagName("link");
            var canonical;
            for (var i = 0; i < links.length; i++) {
                if (links[i].getAttribute("rel") === "canonical") {
                    canonical = links[i].getAttribute("href")
                    return canonical.trim();
                }
            }
        }catch(e){
            return "";
        }

    };

    this.setImageTimeout = function(id, timeout){
        setTimeout("try {document.getElementById('" + id + "').src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'} catch (e){}", timeout || 5000);
    }

    this.setSeg = function(url, type, timeout) {
        type = type || 'img';
        var th = this.getScriptParent();
        if(!th)
            return;
        var s = document.createElement(type);
        if(type == 'script'){
            s.async = true;
        }
        s.setAttribute('width', '1');
        s.setAttribute('height', '1');
        s.setAttribute('style', 'display:none;position:absolute;z-index:-50;');
        s.setAttribute('src', url);
        var autotagId = "adextent_" + new Date().getTime();
        s.setAttribute("id", autotagId);
        th.appendChild(s);
        if(this.hasTimeout)
            this.setImageTimeout(autotagId, timeout);

        };
    this.getUtmzReferrer = function(){
        var utmz = this.getCookie("__utmz");

        if(!utmz)
            return "";

        var utmparts = utmz.split('|');

        for(var i=0; i < utmparts.length; i++)
        {
            var name = utmparts[i].split('=') ? utmparts[i].split('=')[0] : "";
            if(!name)
                continue;
            if(name.indexOf(".utmcsr") > -1)
                return utmparts[i].split('=')[1];
        }
    };

    var adextent_use_exp = false;
    var adextent_exp = "";
    var global_ansn_urlparams = "";
    this.adextent_secured = ('https:' == document.location.protocol);

    var excludeDomains = ['babylon.com','orbitz.com','cheaptickets.com','file-extractor.com'];
    this.fireNetworkSegment = function()
    {
        for(var i=0; i<excludeDomains.length; ++i)
            if(location.href.indexOf(excludeDomains[i]) != -1)
                return;
        var th = this.getScriptParent();
        if(!th)
            return;
        var s = document.createElement('img');
        var domain = typeof(this.adextent_secured) == "undefined" || !this.adextent_secured ?
            "http://ib.adnxs.com/" : "https://secure.adnxs.com/";

        var imgurl = domain + "seg?add=705716&t=2";
        s.setAttribute('width','1;');
        s.setAttribute('height','1;');
        s.setAttribute('style','display:none;position:absolute;z-index:-50;');
        s.setAttribute('src',imgurl);
        th.appendChild(s);
    }

    this.isEmptyObject = function(obj){
        for(var prop in obj) {
            if (obj.hasOwnProperty(prop)) {
                return false;
            }
        }
        return true;
    }


    this.addHeliumPixel = function(refererUrl, secured, conversion, action, audience, products, cookies) {
        var params = [];
        var url = "";
        var verb = "vj";
        var segType = this.hasTimeout ? "img" : "iframe";
        if(this.enableSync){
            if(this.hasTimeout)
                verb = "synci";
            else
                verb = "syncj";
        }
        else{
            if(this.hasTimeout)
                verb = "vi";
            else
                verb = "vj";
        }
        if (!secured)
            url = "http://helium.adextent.com/" + verb;
        else
            url = "https://helium.adextent.com/" + verb;
        if(conversion)
            params.push("conv=true");
        if(action)
            params.push("action=" + action);
        if(audience && (!conversion || (conversion && this.sendAudienceOnConversion)))
            params.push("audience=" + audience);
        if(products && !this.dontSendProductIds)
            params.push("products=" + products)
        if(cookies && !this.isEmptyObject(cookies) && JSON && JSON.stringify)
            params.push("cookies=" + encodeURIComponent(JSON.stringify(cookies)));

        var haveDomain = (this.domain && this.domain.indexOf("${") != 0);
        if(!this.domainParameter && haveDomain)
            refererUrl = "http://" + this.domain + "/" + refererUrl.split("/").slice(3).join("/");

        params.push("url=" + encodeURIComponent(refererUrl));

        if(this.domainParameter && haveDomain)
            params.push("domain=" + this.domain);

        url = (url + "?" + params.join("&"));
        this.setSeg(url, segType);

        if(conversion && this.visitOnConversion){
            this.addHeliumPixel(refererUrl, secured, false, undefined, "product", products, cookies);
        }
    }

    this.isUrl = function (urlsOrSKUs){
        urlsOrSKUs = urlsOrSKUs instanceof Array ? urlsOrSKUs : [urlsOrSKUs];
        return urlsOrSKUs[0].indexOf('http://') == 0 || urlsOrSKUs[0].indexOf('https://') == 0;
    }

    this.callHelium = function (urlsOrSKUs,audienceCode,action,parameters,isConversion){
        var cookies = {};
        if(urlsOrSKUs){
            if(typeof(urlsOrSKUs) == "number"){
                urlsOrSKUs = urlsOrSKUs.toString();
            }
            else if (urlsOrSKUs instanceof Array && urlsOrSKUs[0] && typeof(urlsOrSKUs[0]) == "number"){
                for(var i=0; i<urlsOrSKUs.length; ++i)
                    urlsOrSKUs[i] = urlsOrSKUs[i].toString();
            }
            if(!this.isUrl(urlsOrSKUs) && urlsOrSKUs.indexOf(',') > -1)
                urlsOrSKUs = urlsOrSKUs.split(',');
            urlsOrSKUs = urlsOrSKUs instanceof Array ? urlsOrSKUs : [urlsOrSKUs]
        }
        var utmz = this.getUtmzReferrer();
        if(utmz)
            cookies["utmz"] = utmz;
        if(parameters){
            for(var par in parameters) {
                if (parameters.hasOwnProperty(par)) {
                    cookies[par] = parameters[par];
                }
            }
        }

        var url;
        var products = "";
        if(urlsOrSKUs && urlsOrSKUs[0]){
            if(!this.isUrl(urlsOrSKUs)){
                products = urlsOrSKUs.join(",");
                url = "http://" + this.adextent_tag_domain + "/aeid/" + products;
            }
            else{
                url = urlsOrSKUs[0];
            }
        }
        else{
            url = "http://" + this.adextent_tag_domain + "/";
        }

        this.addHeliumPixel(url, this.adextent_secured, isConversion ,action, audienceCode, products, cookies);
    }

    this.addToCart = function(url,parameters){
        var cartAudience = "cart"; // read from macro.
        this.callHelium(url, cartAudience,"add",parameters);
    }

    this.syncCart = function(urls,parameters){
        var cartAudience = "cart"; // read from macro.
        this.callHelium(urls, cartAudience,"sync",parameters);
    }

    this.removeFromCart = function(url,parameters){
        var cartAudience = "cart"; // read from macro.
        this.callHelium(url ,cartAudience,"remove",parameters);
    }
    this.visit = function(url, parameters){
        this.callHelium(url ,undefined, undefined, parameters);
    }

    this.conversion = function(code, urls, cartvalue,parameters){
        var cookies = parameters || {};
        if(cartvalue){
            cookies["cartValue"] = cartvalue
            for(var par in parameters) {
                if (parameters.hasOwnProperty(par)) {
                    cookies[par] = parameters[par];
                }
            }
        }
        this.callHelium(urls ,code || "conversion", undefined, cookies, true);
    }

    this.addToSegment = function(code, url, parameters){
        if(!code)
            return;
        this.callHelium(url ,code,"add",parameters)
    }

    this.customCleaner = function(pageurl, canonical){
        try{
            
        }
        catch(err){
            return "";
        }
    }

    this.fireAdextentPixel = function(overrideUrl){
        var usedparam = false;
        var adextent_usekw = false;

        var reurl
        if(overrideUrl){
            reurl = overrideUrl;
        }
        else{
            if(this.urlMode == "window"){
                reurl = location.href;
            }
            else if(this.urlMode == "iframe"){
                reurl = document.referrer;
            }
            else{//auto
                try{
                    if(window.top && window.top.location && window.top.location.href)
                        reurl = window.top.location.href;
                    else
                        reurl = (window.self === window.top ? location.href : document.referrer);
                }
                catch(err){
                    reurl = (window.self === window.top ? location.href : document.referrer);
                }
            }
        }

        var scripts = document.getElementsByTagName('script');
        for (var i = 0; i < scripts.length; ++i) {
            if(scripts[i].src.indexOf("/dynads/ServeS3.ashx/autotag") != -1 || scripts[i].src.indexOf("/dynads/ServeS3.ashx/a/") != -1){
                if(scripts[i].src.indexOf("?") != -1){
                    var scriptParams = this.getParams(scripts[i].src);
                    if(scriptParams["url"] && !overrideUrl){
                        reurl = prms1["url"];
                        usedparam = true;
                    }
                    if(scriptParams["i"]){
                        var imode = prms1["i"];
                        if(imode == "kw")
                            adextent_usekw = true;
                    }
                    if(scriptParams["expire"])
                    {
                        adextent_use_exp = true;
                        adextent_exp = prms1["expire"];
                    }
                    if(scriptParams["dev"])
                        this.dev = (scriptParams["dev"] == "true");
                    global_ansn_urlparams = escape(scripts[i].src.split("?")[1]);
                }
                break;
            }

        }


        this.adextent_tag_domain = reurl.split("/")[2];
        var adextent_tag_url = reurl;
        var canonical = this.getCanonical();


        var customCleanedUrl = this.customCleaner(adextent_tag_url, canonical);
        if(customCleanedUrl){
            adextent_tag_url = customCleanedUrl;
        }
        else{
            if(canonical && canonical.indexOf('\n') == -1 && !usedparam && !this.skipCanonical && !overrideUrl)
                adextent_tag_url = canonical;

            if((typeof(adextent_dynads_url) != "undefined")  && !overrideUrl)
                adextent_tag_url = adextent_dynads_url;

            if(adextent_tag_url.match(/^\//gi)){
                adextent_tag_url = "http://" + this.adextent_tag_domain + adextent_tag_url;
                if(this.adextent_secured){
                    adextent_tag_url = "https://" + this.adextent_tag_domain + adextent_tag_url;
                }
            }

        }
        adextent_tag_url = this.cleanUrl(adextent_tag_url);

        this.adextent_tag_domain = this.adextent_tag_domain.toLowerCase().replace("www.","");
        if(adextent_tag_url.indexOf('http://') != 0 && adextent_tag_url.indexOf('https://') != 0){
            adextent_tag_url = document.location.protocol + '//' + this.adextent_tag_domain + '/' + adextent_tag_url
        }

        var scriptForPagePath = "http://dynads.adextent.com/ansn-creative/dynads/ServeS3.ashx/";
        if(this.adextent_secured){
            scriptForPagePath = "https://s.adextent.com/ansn-creative/dynads/ServeS3.ashx/";
        }
        if(adextent_usekw){
            var adextent_utmz = this.getCookie("__utmz");
            if(adextent_utmz){
                var utmparts = adextent_utmz.split('|')
                for(var ii=0; ii < utmparts.length;ii++)
                {
                    var utmkwpart =  utmparts[ii];
                    var kwspl = utmkwpart.split('=');
                    var kwprm = kwspl[0];
                    if(kwprm == 'utmctr')
                    {
                        if(kwspl.length < 2)
                            continue;

                        var kwstr = kwspl[1].toLowerCase();
                        scriptForPagePath = scriptForPagePath + "k/" +this.adextent_tag_domain+"/"+ encodeURIComponent(kwstr.replace(/ /g,"2b")) +".js";
                        this.addScript(scriptForPagePath);
                        break;
                    }
                }
            }
        }
        else{
            if(usedparam)
                scriptForPagePath = scriptForPagePath + "r";
            else
                scriptForPagePath = scriptForPagePath + "u";
            scriptForPagePath = scriptForPagePath + "/" + this.adextent_tag_domain + "/" + encodeURIComponent(adextent_tag_url);

            if (this.fireHeliumPixel)
                this.addHeliumPixel(adextent_tag_url, this.adextent_secured);
            else
                this.addScript(scriptForPagePath);
        }
    }
}

var adextent_autotag = new AdextentAutotag();
if("false" != "true")
    adextent_autotag.fireAdextentPixel();
if((typeof(OnAdextentInit) != "undefined") && OnAdextentInit)
    OnAdextentInit();
if((typeof(onAdextentInit) != "undefined") && onAdextentInit)
    onAdextentInit();


if(adextent_autotag.fireFacebookPixel){
    (function(){
        window._fbds = window._fbds || {};
        _fbds.pixelId = 673925502658156;
        var fbds = document.createElement('script');
        fbds.async = true;
        fbds.src = '//connect.facebook.net/en_US/fbds.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(fbds, s);
    })();
    window._fbq = window._fbq || [];
    window._fbq.push(["track", "PixelInitialized", {}]);
}
//adextent_autotag.fireNetworkSegment();