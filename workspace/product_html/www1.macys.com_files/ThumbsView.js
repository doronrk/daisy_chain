define(["jquery","underscore","backbone","cookie","handlebars","recommendation","productThumbnail/collections/ProductThumbnail","iscroll","bagContent","logger","globals","thumbCarouselHelpers"],function(t,e,i,n,o,a,s,r,l,c,h){"use strict";var u=function(){var e=[],i=t("#categoryId"),n=location.search.match(/[&|?]CategoryID=([^&]+)/i);if(l.param){e.push(l.param)}if(i&&i.val()){e.push("categoryId="+i.val())}else if(n){e.push("categoryId="+n[1])}else if(l.categories&&l.categories.length){e.push("categoryId="+l.categories[l.categories.length-1])}return e.join("&")};return i.View.extend({events:{"click .next > button":"next","click .prev > button":"prev","click li.thumb a":"sendClickInfo"},pagination:3,orientation:"horizontal",template:"mcomTemplates/component/thumbCarousel/pdpHorizontal",panelTemplate:"mcomTemplates/component/thumbCarousel/commonPanel",partials:["mcomTemplates/component/thumbCarousel/partials/ratings","mcomTemplates/component/thumbCarousel/partials/priceInfo","mcomTemplates/component/thumbCarousel/partials/trackingDiv","mcomTemplates/component/thumbCarousel/partials/promoText","mcomTemplates/component/thumbCarousel/partials/moreColors","mcomTemplates/component/thumbCarousel/partials/priceInfo2Tiers"],initialize:function(t,e){var i=this;if(e===true){this.$el.fadeOut()}else{this.$el.hide()}if(!t){t={}}this.page=1;this.choiceId=t.choiceId;this.collection=t.collection;this.presentedIds={};this.timeout=t.timeout;if(undefined!==t.template){this.template=t.template}if(undefined!==t.panelTemplate){this.panelTemplate=t.panelTemplate}if(t.pagination){this.pagination=t.pagination}if(t.orientation){this.orientation=t.orientation}if(undefined!==t.snap){this.snap=t.snap}if(undefined!==t.touch){this.touch=t.touch}if(undefined!==t.pageSnap){this.pageSnap=t.pageSnap}if(t.header){this.header=t.header}if(t.autoscroll&&t.collection.length>t.pagination){this.autoscrollTime=t.autoscroll}if(undefined!==t.onLoadAnimation&&"function"===typeof t.onLoadAnimation){this.onLoadAnimation=t.onLoadAnimation}this.tracking=t.tracking||{};this.vertical=this.orientation==="vertical";this.horizontal=this.orientation==="horizontal";this.scrollOptions={scrollX:this.horizontal,scrollY:this.vertical,mouseWheel:false,snap:this.snap,momentum:false,click:this.touch,eventPassthrough:true};this.registerPartials();if(i.panelTemplate){require([i.panelTemplate],function(t){i.build(t(i))})}else{i.build()}},registerPartials:function(){var t=this;require(this.partials,function(t,e,i,n,a,s){o.registerPartial("ratings",t);o.registerPartial("priceInfo",e);o.registerPartial("trackingDiv",i);o.registerPartial("promoText",n);o.registerPartial("moreColors",a);o.registerPartial("priceInfo2Tiers",s)},function(t){e.each(t.requireModules,function(t){requirejs.undef(t)});c.log("Error loading partials")})},build:function(e){var i=this;if(e){this.$el.html(e)}this.wrapper=this.$el.find(".wrapper");this.scroller=this.$el.find(".scroller");this.container=this.scroller.find("ul");this.buttons={next:this.$el.find(".next > button"),prev:this.$el.find(".prev > button")};if(!t.support.opacity){this.scroll=this.ieCarousel()}else{this.scroll=new r(this.wrapper.get(0),this.scrollOptions)}if(!this.touch){this.scroll.disable()}this.scroll.on("scrollEnd",function(){var e=Math.abs(i.scroll.x/i.itemSize);e=Math.floor(e);if("horizontal"===i.orientation){i.page=1+Math.ceil(e/i.pagination)}else if("vertical"===i.orientation){var n=Math.abs(i.scroll.y);var o=i.$el.find("ul");var a=t(o).find("li").length;var s=0;for(var r=1;s<n&&r<=a;r+=1){s+=t(o).find("li:nth-child("+r+")").innerHeight()}i.page=Math.floor(r/i.pagination)+1}if(!i.snap&&i.pageSnap){i.updateScrollPosition()}i.loadPage(i.page)});if(this.autoscrollTime){this.initAutoscroll()}this.render()},render:function(){var t=this;this.collection.loadPage(this.page,this.pagination,function(e){if(e.length===0){return}var i=function(){t.$el.fadeIn();t.buttonState("prev",false);t.collection.on("change:loaded remove",function(){t.refresh(t.collection)});t.refresh(t.collection);t.sendPresentedInfo(0,e)};if(t.onLoadAnimation){t.onLoadAnimation.call(t,i)}else{i()}})},refresh:function(t){var i=this,n,o,a,s;this.pages=Math.ceil(t.length/this.pagination);if(this.page>this.pages){this.page=this.pages}if(this.pages===1&&this.page===1){this.deInitAutoscroll()}i.updateButtonsState();require([this.template],function(r){var l=e.map(t.toJSON(),function(t,n){return r(e.extend(t,{choiceId:t.choiceId,index:n,tracking:i.tracking}))});i.container.html(l.join(""));if(i.orientation==="horizontal"){o=i.$el.innerWidth();a=i.$el.find(".carouselWrapper").width();i.itemSize=a/i.pagination;n=i.itemSize*i.pagination*i.pages;i.scroller.css("width",n+"px");i.scroller.find("ul>li").css("width",i.itemSize+"px");i.wrapper.css("width",a+"px");s=i.scroller.innerHeight();i.wrapper.css("height",s+"px")}else if(i.orientation==="vertical"){i.updateScrollerHeight()}i.scroll.refresh();i.updateScrollPosition(0)},function(t){e.each(t.requireModules,function(t){requirejs.undef(t)});c.log("Error loading template")})},buttonState:function(t,e){this.buttons[t].attr("disabled",!e).css("cursor",e?"pointer":"default").toggleClass("enabled",e).toggleClass("disabled",!e)},updateButtonsState:function(){this.buttonState("next",this.page!==this.pages);this.buttonState("prev",this.page!==1)},next:function(){this.page+=1;if(this.orientation==="vertical"){this.updateScrollerHeight()}this.loadPage(this.page);this.updateScrollPosition();this.updateButtonsState();if(arguments.length>0&&this.isAutoscrollOn){this.deInitAutoscroll()}},prev:function(){this.page-=1;if(this.orientation==="vertical"){this.updateScrollerHeight()}this.updateScrollPosition();this.updateButtonsState();this.loadPage(this.page);if(this.isAutoscrollOn){this.deInitAutoscroll()}},updateScrollPosition:function(t){var e=(this.page-1)*this.pagination+1,i=this.wrapper.find("li:nth-child("+e+")"),n=i.position();if(!n){return}if(undefined===t){t=1e3}this.scroll.scrollTo(-n.left,-n.top,t);this.updateTabIndex(i)},updateTabIndex:function(t){this.wrapper.find("li:nth-child("+this.pagination+"n+1)").attr("tabindex","-1");t.attr("tabindex","0")},updateScrollerHeight:function(){var e=this.scroller.find("ul>li"),i=(this.page-1)*this.pagination,n=0,o=this;for(var a=i;a-i<this.pagination;a+=1){n+=t(e[a]).innerHeight()}this.wrapper.animate({height:n+"px"},500,function(){o.scroll.refresh();o.updateScrollPosition(0)})},loadPage:function(t,e){var i=this;this.collection.loadPage(t,this.pagination,function(n){if("function"===typeof e){e(n)}setTimeout(function(){if(i.page===t){i.sendPresentedInfo((i.page-1)*i.pagination,n)}},500)})},sendClickInfo:function(e){if(!h.getValue("props.prosInformantsEnabled")){return}var i=e.target;var o=t(i).parents(".thumb").find(".prosTrackingDiv");if(o&&o[0]){var s=t(i).parents(".thumb").data("choiceid")||this.choiceId;var r=t(o).attr("id");var l=n.get("macys_online_uid");if(!l){l="9879879898"}var c=a.getRTDSessionCookie();if(s&&r&&l&&c){a.sendInformantCall(this.tracking.app,this.tracking.zone,"Clicked",s,r,l,c,function(){},this.timeout,u())}}},hasBeenPresented:function(t){return!!this.presentedIds[t]},sendPresentedInfo:function(t,i){if(this.lastPresentedIndex===t||!this.tracking.app||!this.tracking.zone||!h.getValue("props.prosInformantsEnabled")){return}this.lastPresentedIndex=t;var o=this,s=[],r=[],l=n.get("macys_online_uid"),c=a.getRTDSessionCookie();if(!l){l="9879879898"}e.each(i,function(t){if(o.hasBeenPresented(t.id)){return}o.presentedIds[t.id]=true;s.push(t.id);r.push(t.attributes.choiceId)});s=s.join("|");r=r.join("|");if(r&&s&&l&&c){a.sendInformantCall(this.tracking.app,this.tracking.zone,"Presented",r,s,l,c,function(){},this.timeout,u())}},ieCarousel:function(){var e=this,i={};i.disable=t.noop;i.enable=t.noop;i.on=t.noop;i.refresh=t.noop;i.scrollTo=function(i,n,o){t(e.scroller).animate({marginLeft:i,marginTop:n},o)};return i},initAutoscroll:function(){var t=this;this.$el.on("mouseenter.autoscroll",function(){t.stopRotation()});this.$el.on("mouseleave.autoscroll",function(){t.startRotation()});this.isAutoscrollOn=true;this.startRotation()},deInitAutoscroll:function(){this.isAutoscrollOn=false;this.$el.off("mouseenter.autoscroll");this.$el.off("mouseleave.autoscroll");this.stopRotation()},startRotation:function(){var t=this;this.stopRotation();this.autoscrollTimer=setInterval(function(){if(t.page===t.pages){t.page=1;t.updateButtonsState();t.updateScrollPosition(1e3)}else{t.loadPage(t.page+1,function(){setTimeout(function(){t.next()},100)})}},this.autoscrollTime)},stopRotation:function(){if(this.autoscrollTimer){clearInterval(this.autoscrollTimer);this.autoscrollTimer=null}},remove:function(){this.deInitAutoscroll()}},{views:[],createRecomendationPanel:function(e,i){var n=this,o=t(e.element);if(!o.length){return"function"===typeof i&&i(false)}a.getRecommendations(e.requester,e.context,e.productId,e.customerId,e.maxRecommendations,function(t,o){if(!t||!o||!o.recommendedIdsList){if("function"===typeof i){i(false)}return false}var a={el:e.element,header:o.headerText,collection:s.fromArray(o.recommendedIdsList),pagination:e.pagination||3,orientation:e.orientation||"horizontal",choiceId:o.encodedChoiceId,template:e.template,snap:e.snap,touch:e.touch,autoscroll:e.autoscroll,tracking:{app:e.requester,zone:e.context,extra:e.tracking},onLoadAnimation:e.onLoadAnimation,timeout:e.timeout};var r;if(n.views[e.element]===undefined){r=new n(a,false);n.views[e.element]=r}else{n.views[e.element].initialize(a,true)}if("function"===typeof i){i(r)}return true},e.timeout,e.rtoPath,u())}})});