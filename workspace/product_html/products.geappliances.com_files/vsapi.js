var VisitorService=VisitorService||{};VisitorService.Rules=VisitorService.Rules||{};
VisitorService.Rules.Adapter=function(){this._headElement=document.getElementsByTagName("head")[0];this._headElement||(this._headElement=document.createElement("head"),document.insertBefore(this._headElement,document.getElementsByTagName("body")));this._sessionId=this._visitorId="";this._domain=this._searchScriptNodes("vsapi",1);this._dataFields={};this._eventDataQueue=[];this._eventSending=!1;this._widgets=[];this._spacWidgets=[];this._vsOptsLoaded=!1;this._widgetLoadQueue=[];this._rnScript;this._widgets.indexOf=
this._widgets.indexOf||function(a){var c=this.length>>>0;for(i=0;i<c;i++)if(this[i]===a)return i;return-1};this.WTYPE={SPAC:2,SKB:3,SPOL:5,SCCL:7,PAC:"ProactiveChat",CCL:"ConditionalChatLink",VSPAC:1,VSSPAC:2,VSCCL:3,VSSCCL:4};this.ATYPE={LOAD:"PAGE_LOAD",OFFER:"OFFER",ACCEPT:"ACCEPT",CONVERT:"CONVERT",SUPPRESS:"SUPPRESS",REJECT:"REJECT"};this.WIDGET_STATE={LOADING:"LOADING",LOADED:"LOADED",OFFERED:"OFFERED"};this.initialize()};
VisitorService.Rules.Adapter.prototype={push:function(a){switch(a[0]){case "vsResponse":this._vsSuccess=a[1].success;!0===this._vsSuccess&&(this._vsLastSuccessfulEvent={name:a[1].name,value:"null"==a[1].value?void 0:a[1].value});break;case "vsOpts":if(this._vip!=a[1].vip||this._site!=a[1].site||this._poolID!=a[1].poolId||this._vsEnabled!=a[1].vsEnabled)this._vip=a[1].vip,this._site=a[1].site,this._poolID=a[1].poolId,this._vsEnabled=a[1].vsEnabled,this._cacheDomain=a[1].cacheDomain,this._vsOptsLoaded=
!0,this._loadWidgetsIfReady(),this._eventSending=!1,this._sendNextEventItem();break;case "rulesReady":this._processPageLoad(a[1].visitorId,a[1].sessionId);break;case "cpWidget":if(!RightNow.Event)break;var c={rule:a[1].rule,data:a[1]},a=a[1];this._processPagePeekInfo(a);delete c.data.rule;delete c.data.ts;switch(c.data.name){case this.WTYPE.PAC:c.data.offerOnlyOnce=!0;c.data.ignoreCookie=!0;c.data.ignoreTriggers=!0;0>this._widgets.indexOf(this.WTYPE.PAC)&&(this._widgets.push(this.WTYPE.PAC),RightNow.Event.subscribe("evt_ProactiveReady",
function(){RightNow.Event.fire("evt_customProactiveInitialization",c)}));RightNow.Event.fire("evt_isProactiveReady");break;case this.WTYPE.CCL:0>this._widgets.indexOf(this.WTYPE.CCL)&&(this._widgets.push(this.WTYPE.CCL),RightNow.Event.subscribe("evt_CCLReady",function(){RightNow.Event.fire("evt_customInitialization",c)}),RightNow.Event.fire("evt_isCCLReady"))}break;case "synWidget":a=a[1];this._processPagePeekInfo(a);a.rule&&(a.ruleId=a.rule.id,delete a.rule);if(a.suppress){this._logExternal(this.ATYPE.SUPPRESS,
a);break}switch(a.type){case this.WTYPE.SPAC:a.instance_id="spac_"+a.widget_id;a.lazy_mode=!0;a.vstype=this.WTYPE.VSSPAC;var b=this._findSpacWidget(a.instance_id);b?b.state===this.WIDGET_STATE.LOADED&&(a=new RightNow.Client.EventObject(a.module,a.instance_id),a.data={dataFields:this._dataFields},RightNow.Client.Event.evt_updateCustomFieldsRequest.fire(a),a.data={checkAvailability:!0},RightNow.Client.Event.evt_chatOfferRequest.fire(a)):(b={instanceId:a.instance_id,state:this.WIDGET_STATE.LOADING},
this._spacWidgets.push(b),this._widgetLoadQueue.push(a),this._loadWidgetsIfReady());break;case this.WTYPE.SKB:a.instance_id="skb_"+a.widget_id;this._loadWidgetOrIgnore(a);break;case this.WTYPE.SPOL:a.instance_id="spol_"+a.widget_id;this._loadWidgetOrIgnore(a);break;case this.WTYPE.SCCL:a.instance_id="sccl_"+a.widget_id,a.vstype=this.WTYPE.VSSCCL,this._loadWidgetOrIgnore(a)}break;case "transactionCompleted":this._sendEventData(this.ATYPE.CONVERT,a[1].customVars.total);break;case "customData":this._dataFields[a[1].name]=
a[1].value}},initialize:function(){if(window._vsq&&window._vsq.pop)for(;window._vsq.length;)this.push(window._vsq.pop());window._vsq=this},_searchScriptNodes:function(a,c){for(var b="",e=RegExp("//([a-z0-9-.]+)/.*"+a+"(-test)?.js"),d=document.getElementsByTagName("script"),g=0;g<d.length;g++){var h=d[g].src.match(e);if(h){b=h[c];break}}return b},_processPageLoad:function(a,c){this._visitorId=a;this._sessionId=c;this._sendEventData(this.ATYPE.LOAD)},_checkSendSuccess:function(){this._eventSending=
!1;void 0===this._vsSuccess||!1===this._vsSuccess?this._updateOpts():!0===this._vsSuccess&&(this._eventDataQueue.shift(),this._sendNextEventItem())},_updateOpts:function(){var a=this._searchScriptNodes("vsopts",0);if(""!==a){var c=document.createElement("iframe");c.style.display="none";c.src=a+"?update=true";document.body.appendChild(c)}},_sendEventData:function(a,c){this._eventDataQueue.push({name:a,value:c});!this._eventSending&&void 0!==this._vip&&(this._eventSending=!0,this._sendNextEventItem(a,
c))},_sendNextEventItem:function(){var a=this._eventDataQueue[0];void 0!==a&&this._sendEventDataItem(a.name,a.value)},_sendEventDataItem:function(a,c){if(this._vsEnabled){var b=document.createElement("script");b.setAttribute("type","text/javascript");var e=this;void 0!=b.addEventListener?(b.addEventListener("load",function(){e._checkSendSuccess()},!1),b.addEventListener("error",function(){e._updateOpts()},!1)):void 0!=b.attachEvent&&b.attachEvent("onreadystatechange",function(){"loaded"==b.readyState&&
e._checkSendSuccess()});var d="//"+this._vip+"/vs/site/"+this._site+"/visitor/"+this._visitorId+"/session/"+this._sessionId+"/type/"+a;a===this.ATYPE.OFFER||a===this.ATYPE.ACCEPT?d+="/val1/"+c.widget_id+"/val2/"+c.widget_name+"/val3/"+c.vstype:a===this.ATYPE.CONVERT&&(d+="/val1/"+c);""!=this._poolID&&(d+="?pool="+this._poolID);b.src=d;this._headElement.appendChild(b)}},_findSpacWidget:function(a){for(var c=0;c<this._spacWidgets.length;c++)if(this._spacWidgets[c].instanceId===a)return this._spacWidgets[c]},
_loadWidgetOrIgnore:function(a){0>this._widgets.indexOf(a.instance_id)&&(this._widgets.push(a.instance_id),this._widgetLoadQueue.push(a),this._loadWidgetsIfReady())},_loadWidgetsIfReady:function(){if(this._vsOptsLoaded||""===this._searchScriptNodes("vsopts",0))if(void 0===this._rnScript&&("undefined"===typeof RightNow||"undefined"===typeof RightNow.Client)){var a=this._cacheDomain||this._domain,c=this;rnScript=document.createElement("script");rnScript.setAttribute("type","text/javascript");rnScript.setAttribute("src",
"//"+a+"/euf/rightnow/RightNow.Client.js");"undefined"!==typeof rnScript.addEventListener?rnScript.addEventListener("load",function(){c._loadWidgetsIfReady()},!1):"undefined"!==typeof rnScript.attachEvent&&rnScript.attachEvent("onreadystatechange",function(){("complete"===rnScript.readyState||"loaded"===rnScript.readyState)&&c._loadWidgetsIfReady()});this._headElement&&this._headElement.appendChild(rnScript)}else for(;0<this._widgetLoadQueue.length;)this._loadWidget(this._widgetLoadQueue.pop())},
_loadWidget:function(a){var c=this._widgetLoaded,b=this._cacheDomain||this._domain,e={widgetData:a,instance:this},d=this._dataFields,g={},h={};a.custom_fields&&(g=RightNow.lang.JSON.parse(a.custom_fields));for(var f in d)0===f.indexOf("contacts.")||0===f.indexOf("incidents.")?h[f]=d[f]:g[f]=d[f];for(f in d)if(0===f.indexOf("incidents.prod")&&a.p&&(a.p=d[f]),0===f.indexOf("incidents.cat")&&a.c)a.c=d[f];a.custom_fields=RightNow.lang.JSON.stringify(g);a.common_fields=RightNow.lang.JSON.stringify(h);
RightNow.Client.Event.evt_widgetLoaded.subscribe(c,e);RightNow.Client.Controller.addComponent(a,"//"+b+"/ci/ws/get")},_processPagePeekInfo:function(a){ATGSvcs.pagepeek&&ATGSvcs.pagepeek.enabled&&(a.visitor_id=this._visitorId,a.ee_id=ATGSvcs.cfg("uoid"),a.estara_id=window.eStara_fsguid)},_widgetLoaded:function(a,c,b){if(b.instance._matchEventForWidget(c,b.widgetData)){var a=b.instance._chatOffered,c=b.instance._chatAccepted,e=b.instance._chatRejected;if(b.widgetData.type===b.instance.WTYPE.SPAC){var d=
b.instance._findSpacWidget(b.widgetData.instance_id);d&&(d.state=b.instance.WIDGET_STATE.LOADED);RightNow.Client.Event.evt_chatOffered.subscribe(a,b);RightNow.Client.Event.evt_chatAccepted.subscribe(c,b);RightNow.Client.Event.evt_chatRejected.subscribe(e,b)}else b.widgetData.type===b.instance.WTYPE.SCCL&&(RightNow.Client.Event.evt_conditionalChatLinkOffered.subscribe(a,b),RightNow.Client.Event.evt_conditionalChatLinkClicked.subscribe(c,b))}},_chatOffered:function(a,c,b){if(b.instance._matchEventForWidget(c,
b.widgetData)){if(b.widgetData.type===b.instance.WTYPE.SPAC&&(a=b.instance._findSpacWidget(b.widgetData.instance_id)))a.state=b.instance.WIDGET_STATE.OFFERED;b.instance._sendEventData(b.instance.ATYPE.OFFER,b.widgetData);b.instance._logExternal(b.instance.ATYPE.OFFER,b.widgetData)}},_chatAccepted:function(a,c,b){b.instance._matchEventForWidget(c,b.widgetData)&&(b.instance._sendEventData(b.instance.ATYPE.ACCEPT,b.widgetData),b.instance._logExternal(b.instance.ATYPE.ACCEPT,b.widgetData))},_chatRejected:function(a,
c,b){b.instance._matchEventForWidget(c,b.widgetData)&&b.instance._logExternal(b.instance.ATYPE.REJECT,b.widgetData)},_matchEventForWidget:function(a,c){return a[0].name===c.module&&a[0].id===c.instance_id},_logExternal:function(a,c){if(window.ATGSvcs){var b;c.type===this.WTYPE.SPAC?b="RNSPChat":c.type===this.WTYPE.SCCL&&(b="RNSCChat");var e;a===this.ATYPE.SUPPRESS?e="suppressed":a===this.ATYPE.OFFER?e="offered":a===this.ATYPE.ACCEPT?e="accepted":a===this.ATYPE.REJECT&&(e="closed");b&&e&&window.ATGSvcs.ee.logInvite({id:c.widget_id,
type:b,timestamp:+new Date,state:e,ruleid:c.ruleId})}}};var _adptr=new VisitorService.Rules.Adapter;
