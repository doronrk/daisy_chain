var Channel=(function(){var b=Math.floor(Math.random()*1000001);var g={};function e(o,i,l,j){function n(k){for(var p=0;p<k.length;p++){if(k[p].win===o){return true}}return false}var m=false;if(i==="*"){for(var h in g){if(!g.hasOwnProperty(h)){continue}if(h==="*"){continue}if(typeof g[h][l]==="object"){m=n(g[h][l]);if(m){break}}}}else{if((g["*"]&&g["*"][l])){m=n(g["*"][l])}if(!m&&g[i]&&g[i][l]){m=n(g[i][l])}}if(m){throw"A channel is already bound to the same window which overlaps with origin '"+i+"' and has scope '"+l+"'"}if(typeof g[i]!="object"){g[i]={}}if(typeof g[i][l]!="object"){g[i][l]=[]}g[i][l].push({win:o,handler:j})}function c(m,j,l){var h=g[j][l];for(var k=0;k<h.length;k++){if(h[k].win===m){h.splice(k,1)}}if(g[j][l].length===0){delete g[j][l]}}function f(h){if(Array.isArray){return Array.isArray(h)}else{return(h.constructor.toString().indexOf("Array")!=-1)}}var a={};var d=function(r){try{var k=JSON.parse(r.data);if(typeof k!=="object"||k===null){throw"malformed"}}catch(r){return}var u=r.source;var h=r.origin;var v,p,t;if(typeof k.method==="string"){var l=k.method.split("::");if(l.length==2){v=l[0];t=l[1]}else{t=k.method}}if(typeof k.id!=="undefined"){p=k.id}if(typeof t==="string"){var q=false;if(g[h]&&g[h][v]){for(var n=0;n<g[h][v].length;n++){if(g[h][v][n].win===u){g[h][v][n].handler(h,t,k);q=true;break}}}if(!q&&g["*"]&&g["*"][v]){for(var n=0;n<g["*"][v].length;n++){if(g["*"][v][n].win===u){g["*"][v][n].handler(h,t,k);break}}}}else{if(typeof p!="undefined"){if(a[p]){a[p](h,t,k)}}}};if(window.addEventListener){window.addEventListener("message",d,false)}else{if(window.attachEvent){window.attachEvent("onmessage",d)}}return{build:function(r){var i=function(y){if(r.debugOutput&&window.console&&window.console.log){try{if(typeof y!=="string"){y=JSON.stringify(y)}}catch(z){}console.log("["+k+"] "+y)}};if(!window.postMessage){throw ("jschannel cannot run this browser, no postMessage")}if(!window.JSON||!window.JSON.stringify||!window.JSON.parse){throw ("jschannel cannot run this browser, no JSON parsing/serialization")}if(typeof r!="object"){throw ("Channel build invoked without a proper object argument")}if(!r.window||!r.window.postMessage){throw ("Channel.build() called without a valid window argument")}if(window===r.window){throw ("target window is same as present window -- not allowed")}var j=false;if(typeof r.origin==="string"){var l;if(r.origin==="*"){j=true}else{if(null!==(l=r.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))){r.origin=l[0].toLowerCase();j=true}}}if(!j){throw ("Channel.build() called with an invalid origin")}if(typeof r.scope!=="undefined"){if(typeof r.scope!=="string"){throw"scope, when specified, must be a string"}if(r.scope.split("::").length>1){throw"scope may not contain double colons: '::'"}}var k=(function(){var A="";var z="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var y=0;y<5;y++){A+=z.charAt(Math.floor(Math.random()*z.length))}return A})();var v={};var h={};var s={};var u=false;var x=[];var n=function(C,y,B){var A=false;var z=false;return{origin:y,invoke:function(G,D){if(!s[C]){throw"attempting to invoke a callback of a nonexistent transaction: "+C}var F=false;for(var E=0;E<B.length;E++){if(G===B[E]){F=true;break}}if(!F){throw"request supports no such callback '"+G+"'"}t({id:C,callback:G,params:D})},error:function(D,E){z=true;if(!s[C]){throw"error called for nonexistent message: "+C}delete s[C];t({id:C,error:D,message:E})},complete:function(D){z=true;if(!s[C]){throw"complete called for nonexistent message: "+C}delete s[C];t({id:C,result:D})},delayReturn:function(D){if(typeof D==="boolean"){A=(D===true)}return A},completed:function(){return z}}};var q=function(z,y,A){return window.setTimeout(function(){if(h[z]){var B="timeout ("+y+"ms) exceeded on method '"+A+"'";(1,h[z].error)("timeout_error",B);delete h[z];delete a[z]}},y)};var w=function(J,y,A){if(typeof r.gotMessageObserver==="function"){try{r.gotMessageObserver(J,A)}catch(F){i("gotMessageObserver() raised an exception: "+F.toString())}}if(A.id&&y){if(v[y]){var M=n(A.id,J,A.callbacks?A.callbacks:[]);s[A.id]={};try{if(A.callbacks&&f(A.callbacks)&&A.callbacks.length>0){for(var E=0;E<A.callbacks.length;E++){var L=A.callbacks[E];var D=A.params;var z=L.split("/");for(var C=0;C<z.length-1;C++){var I=z[C];if(typeof D[I]!=="object"){D[I]={}}D=D[I]}D[z[z.length-1]]=(function(){var N=L;return function(O){return M.invoke(N,O)}})()}}var B=v[y](M,A.params);if(!M.delayReturn()&&!M.completed()){M.complete(B)}}catch(F){var H="runtime_error";var K=null;if(typeof F==="string"){K=F}else{if(typeof F==="object"){if(F&&f(F)&&F.length==2){H=F[0];K=F[1]}else{if(typeof F.error==="string"){H=F.error;if(!F.message){K=""}else{if(typeof F.message==="string"){K=F.message}else{F=F.message}}}}}}if(K===null){try{K=JSON.stringify(F);if(typeof(K)=="undefined"){K=F.toString()}}catch(G){K=F.toString()}}M.error(H,K)}}}else{if(A.id&&A.callback){if(!h[A.id]||!h[A.id].callbacks||!h[A.id].callbacks[A.callback]){i("ignoring invalid callback, id:"+A.id+" ("+A.callback+")")}else{h[A.id].callbacks[A.callback](A.params)}}else{if(A.id){if(!h[A.id]){i("ignoring invalid response: "+A.id)}else{if(A.error){(1,h[A.id].error)(A.error,A.message)}else{if(A.result!==undefined){(1,h[A.id].success)(A.result)}else{(1,h[A.id].success)()}}delete h[A.id];delete a[A.id]}}else{if(y){if(v[y]){v[y]({origin:J},A.params)}}}}}};e(r.window,r.origin,((typeof r.scope==="string")?r.scope:""),w);var m=function(y){if(typeof r.scope==="string"&&r.scope.length){y=[r.scope,y].join("::")}return y};var t=function(B,y){if(!B){throw"postMessage called with null message"}var A=(u?"post  ":"queue ");i(A+" message: "+JSON.stringify(B));if(!y&&!u){x.push(B)}else{if(typeof r.postMessageObserver==="function"){try{r.postMessageObserver(r.origin,B)}catch(z){i("postMessageObserver() raised an exception: "+z.toString())}}r.window.postMessage(JSON.stringify(B),r.origin)}};var p=function(y,z){i("ready msg received");if(u){throw"received ready message while in ready state.  help!"}if(z==="ping"){k+="-R"}else{k+="-L"}o.unbind("__ready");u=true;i("ready msg accepted.");if(z==="ping"){o.notify({method:"__ready",params:"pong"})}while(x.length){t(x.pop())}if(typeof r.onReady==="function"){r.onReady(o)}};var o={unbind:function(y){if(v[y]){if(!(delete v[y])){throw ("can't delete method: "+y)}return true}return false},bind:function(z,y){if(!z||typeof z!=="string"){throw"'method' argument to bind must be string"}if(!y||typeof y!=="function"){throw"callback missing from bind params"}if(v[z]){throw"method '"+z+"' is already bound!"}v[z]=y;return this},call:function(y){if(!y){throw"missing arguments to call function"}if(!y.method||typeof y.method!=="string"){throw"'method' argument to call must be string"}if(!y.success||typeof y.success!=="function"){throw"'success' callback missing from call"}var C={};var B=[];var z=[];var A=function(H,G){if(z.indexOf(G)>=0){throw"params cannot be a recursive data structure"}z.push(G);if(typeof G==="object"){for(var E in G){if(!G.hasOwnProperty(E)){continue}var F=H+(H.length?"/":"")+E;if(typeof G[E]==="function"){C[F]=G[E];B.push(F);delete G[E]}else{if(typeof G[E]==="object"){A(F,G[E])}}}}};A("",y.params);var D={id:b,method:m(y.method),params:y.params};if(B.length){D.callbacks=B}if(y.timeout){q(b,y.timeout,m(y.method))}h[b]={callbacks:C,error:y.error,success:y.success};a[b]=w;b++;t(D)},notify:function(y){if(!y){throw"missing arguments to notify function"}if(!y.method||typeof y.method!=="string"){throw"'method' argument to notify must be string"}t({method:m(y.method),params:y.params})},destroy:function(){c(r.window,r.origin,((typeof r.scope==="string")?r.scope:""));if(window.removeEventListener){window.removeEventListener("message",w,false)}else{if(window.detachEvent){window.detachEvent("onmessage",w)}}u=false;v={};s={};h={};r.origin=null;x=[];i("channel destroyed");k=""}};o.bind("__ready",p);setTimeout(function(){t({method:m("__ready"),params:"ping"},true)},0);return o}}})();