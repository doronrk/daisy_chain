(function(){function lc(){(function(){var a=this.BDM=this.BDM||{};a.$=a.$||this.jQuery.noConflict(!0);a.jQuery=a.$;a.JSON=a.JSON||window.JSON})();var u={};c.async=u;var lc=function(a,b){if(a.forEach)return a.forEach(b);for(var d=0;d<a.length;d+=1)b(a[d],d,a)},mc=function(a,b){if(a.map)return a.map(b);var d=[];lc(a,function(a,c,h){d.push(b(a,c,h))});return d},Hf=function(a){if(Object.keys)return Object.keys(a);var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(d);return b};u.nextTick=function(a){setTimeout(a,
0)};u.forEach=function(a,b,d){d=d||function(){};if(!a.length)return d();var c=0;lc(a,function(f){b(f,function(b){b?(d(b),d=function(){}):(c+=1,c===a.length&&d())})})};u.forEachSeries=function(a,b,d){d=d||function(){};if(!a.length)return d();var c=0,f=function(){b(a[c],function(b){b?(d(b),d=function(){}):(c+=1,c===a.length?d():f())})};f()};var Uc=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[u.forEach].concat(b))}},Vc=function(a){return function(){var b=
Array.prototype.slice.call(arguments);return a.apply(null,[u.forEachSeries].concat(b))}},If=function(a,b,d,c){var f=[],b=mc(b,function(a,b){return{index:b,value:a}});a(b,function(a,b){d(a.value,function(d,c){f[a.index]=c;b(d)})},function(a){c(a,f)})};u.map=Uc(If);u.mapSeries=Vc(If);var Jf=function(a,b,d,c){var f=[],b=mc(b,function(a,b){return{index:b,value:a}});a(b,function(a,b){d(a.value,function(d){d&&f.push(a);b()})},function(){c(mc(f.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};
u.filter=Uc(Jf);u.filterSeries=Vc(Jf);u.select=u.filter;u.selectSeries=u.filterSeries;var Kf=function(a,b,d,c){var f=[],b=mc(b,function(a,b){return{index:b,value:a}});a(b,function(a,b){d(a.value,function(d){d||f.push(a);b()})},function(){c(mc(f.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};u.reject=Uc(Kf);u.rejectSeries=Vc(Kf);var Lf=function(a,b,d,c){a(b,function(a,b){d(a,function(d){d?(c(a),c=function(){}):b()})},function(){c()})};u.detect=Uc(Lf);u.detectSeries=Vc(Lf);
u.some=function(a,b,d){u.forEach(a,function(a,c){b(a,function(a){a&&(d(!0),d=function(){});c()})},function(){d(!1)})};u.any=u.some;u.every=function(a,b,d){u.forEach(a,function(a,c){b(a,function(a){a||(d(!1),d=function(){});c()})},function(){d(!0)})};u.all=u.every;u.waterfall=function(a,b){b=b||function(){};if(!a.length)return b();var d=function(a){return function(c){if(c)b(c),b=function(){};else{var h=Array.prototype.slice.call(arguments,1),i=a.next();i?h.push(d(i)):h.push(b);u.nextTick(function(){a.apply(null,
h)})}}};d(u.iterator(a))()};u.parallel=function(a,b){b=b||function(){};if(a.constructor===Array)u.map(a,function(a,b){a&&a(function(a){var d=Array.prototype.slice.call(arguments,1);1>=d.length&&(d=d[0]);b.call(null,a,d)})},b);else{var d={};u.forEach(Hf(a),function(b,c){a[b](function(a){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]);d[b]=i;c(a)})},function(a){b(a,d)})}};u.series=function(a,b){b=b||function(){};if(a.constructor===Array)u.mapSeries(a,function(a,b){a&&a(function(a){var d=
Array.prototype.slice.call(arguments,1);1>=d.length&&(d=d[0]);b.call(null,a,d)})},b);else{var d={};u.forEachSeries(Hf(a),function(b,c){a[b](function(a){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]);d[b]=i;c(a)})},function(a){b(a,d)})}};u.iterator=function(a){var b=function(d){var c=function(){a.length&&a[d].apply(null,arguments);return c.next()};c.next=function(){return d<a.length-1?b(d+1):null};return c};return b(0)};(function(){(function(a){var b=this||(0,eval)("this"),d=b.document,
g=b.navigator,f=(b.BDM||b).jQuery,h=(b.BDM||b).JSON;(function(a){"object"===typeof c?a(c.ko={}):"function"===typeof require&&"object"===typeof exports&&"object"===typeof module?a(module.exports||exports):"function"===typeof define&&define.amd?define(["exports"],a):a(b.ko={})})(function(c){function j(a,b){return null===a||typeof a in t?a===b:!1}function k(b,d){var c;return function(){c||(c=setTimeout(function(){c=a;b()},d))}}function T(a,b){var d;return function(){clearTimeout(d);d=setTimeout(a,b)}}
function m(a,b,d,c){e.d[a]={init:function(a,g,H,f,h){var i,j;e.ba(function(){var H=e.a.c(g()),f=!d!==!H,Wd=!j;if(Wd||b||f!==i)Wd&&e.ca.fa()&&(j=e.a.jb(e.e.childNodes(a),!0)),f?(Wd||e.e.U(a,e.a.jb(j)),e.eb(c?c(h,H):h,a)):e.e.da(a),i=f},null,{F:a});return{controlsDescendantBindings:!0}}};e.g.aa[a]=!1;e.e.Q[a]=!0}var e="undefined"!==typeof c?c:{};e.b=function(a,b){for(var d=a.split("."),c=e,g=0;g<d.length-1;g++)c=c[d[g]];c[d[d.length-1]]=b};e.s=function(a,b,d){a[b]=d};e.version="3.1.0+bigdoor.0";e.b("version",
e.version);var c=e,n=function(a,b){for(var d in a)a.hasOwnProperty(d)&&b(d,a[d])},A=function(a,b){if(b)for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return a},fa=function(a,b){a.__proto__=b;return a},l={__proto__:[]}instanceof Array,p={},xa={};p[g&&/Firefox\/2/i.test(g.userAgent)?"KeyboardEvent":"UIEvents"]=["keyup","keydown","keypress"];p.MouseEvents="click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" ");n(p,function(a,b){if(b.length)for(var d=0,c=b.length;d<
c;d++)xa[b[d]]=a});var o={propertychange:!0};if(p=d){for(var p=3,I=d.createElement("div"),J=I.getElementsByTagName("i");I.innerHTML="<\!--[if gt IE "+ ++p+"]><i></i><![endif]--\>",J[0];);p=4<p?p:a}var ab=p;c.a={kb:["authenticity_token",/^__RequestVerificationToken(_.*)?$/],r:function(a,b){for(var d=0,c=a.length;d<c;d++)b(a[d],d)},l:function(a,b){if("function"==typeof Array.prototype.indexOf)return Array.prototype.indexOf.call(a,b);for(var d=0,c=a.length;d<c;d++)if(a[d]===b)return d;return-1},fb:function(a,
b,d){for(var c=0,g=a.length;c<g;c++)if(b.call(d,a[c],c))return a[c];return null},ma:function(a,b){var d=e.a.l(a,b);0<d?a.splice(d,1):0===d&&a.shift()},gb:function(a){for(var a=a||[],b=[],d=0,c=a.length;d<c;d++)0>e.a.l(b,a[d])&&b.push(a[d]);return b},ya:function(a,b){for(var a=a||[],d=[],c=0,g=a.length;c<g;c++)d.push(b(a[c],c));return d},la:function(a,b){for(var a=a||[],d=[],c=0,g=a.length;c<g;c++)b(a[c],c)&&d.push(a[c]);return d},$:function(a,b){if(b instanceof Array)a.push.apply(a,b);else for(var d=
0,c=b.length;d<c;d++)a.push(b[d]);return a},Y:function(a,b,d){var c=e.a.l(e.a.Ra(a),b);0>c?d&&a.push(b):d||a.splice(c,1)},na:l,extend:A,ra:fa,sa:l?fa:A,A:n,Na:function(a,b){if(!a)return a;var d={},c;for(c in a)a.hasOwnProperty(c)&&(d[c]=b(a[c],c,a));return d},Fa:function(a){for(;a.firstChild;)e.removeNode(a.firstChild)},cc:function(a){for(var a=e.a.R(a),b=d.createElement("div"),c=0,g=a.length;c<g;c++)b.appendChild(e.M(a[c]));return b},jb:function(a,b){for(var d=0,c=a.length,g=[];d<c;d++){var f=a[d].cloneNode(!0);
g.push(b?e.M(f):f)}return g},U:function(a,b){e.a.Fa(a);if(b)for(var d=0,c=b.length;d<c;d++)a.appendChild(b[d])},zb:function(a,b){var d=a.nodeType?[a]:a;if(0<d.length){for(var c=d[0],g=c.parentNode,f=0,h=b.length;f<h;f++)g.insertBefore(b[f],c);f=0;for(h=d.length;f<h;f++)e.removeNode(d[f])}},ea:function(a,b){if(a.length){for(b=8===b.nodeType&&b.parentNode||b;a.length&&a[0].parentNode!==b;)a.shift();if(1<a.length){var d=a[0],c=a[a.length-1];for(a.length=0;d!==c;)if(a.push(d),d=d.nextSibling,!d)return;
a.push(c)}}return a},Bb:function(a,b){7>ab?a.setAttribute("selected",b):a.selected=b},ta:function(b){return null===b||b===a?"":b.trim?b.trim():b.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")},mc:function(a,b){for(var d=[],c=(a||"").split(b),g=0,f=c.length;g<f;g++){var h=e.a.ta(c[g]);""!==h&&d.push(h)}return d},ic:function(a,b){a=a||"";return b.length>a.length?!1:a.substring(0,b.length)===b},Rb:function(a,b){if(a===b)return!0;if(11===a.nodeType)return!1;if(b.contains)return b.contains(3===a.nodeType?
a.parentNode:a);if(b.compareDocumentPosition)return 16==(b.compareDocumentPosition(a)&16);for(;a&&a!=b;)a=a.parentNode;return!!a},Ea:function(a){return e.a.Rb(a,a.ownerDocument.documentElement)},bb:function(a){return!!e.a.fb(a,e.a.Ea)},B:function(a){return a&&a.tagName&&a.tagName.toLowerCase()},q:function(a,b,d){var c=ab&&o[b];if(!c&&f)f(a).bind(b,d);else if(c||"function"!=typeof a.addEventListener)if("undefined"!=typeof a.attachEvent){var g=function(b){d.call(a,b)},h="on"+b;a.attachEvent(h,g);e.a.u.ja(a,
function(){a.detachEvent(h,g)})}else throw Error("Browser doesn't support addEventListener or attachEvent");else a.addEventListener(b,d,!1)},ha:function(a,c){if(!a||!a.nodeType)throw Error("element must be a DOM node when calling triggerEvent");var g;"input"===e.a.B(a)&&a.type&&"click"==c.toLowerCase()?(g=a.type,g="checkbox"==g||"radio"==g):g=!1;if(f&&!g)f(a).trigger(c);else if("function"==typeof d.createEvent)if("function"==typeof a.dispatchEvent)g=d.createEvent(xa[c]||"HTMLEvents"),g.initEvent(c,
!0,!0,b,0,0,0,0,0,!1,!1,!1,!1,0,a),a.dispatchEvent(g);else throw Error("The supplied element doesn't support dispatchEvent");else if(g&&a.click)a.click();else if("undefined"!=typeof a.fireEvent)a.fireEvent("on"+c);else throw Error("Browser doesn't support triggering events");},c:function(a){return e.v(a)?a():a},Ra:function(a){return e.v(a)?a.o():a},ua:function(a,b,d){if(b){var c=/\S+/g,g=a.className.match(c)||[];e.a.r(b.match(c),function(a){e.a.Y(g,a,d)});a.className=g.join(" ")}},Va:function(b,d){var c=
e.a.c(d);if(null===c||c===a)c="";var g=e.e.firstChild(b);!g||3!=g.nodeType||e.e.nextSibling(g)?e.e.U(b,[b.ownerDocument.createTextNode(c)]):g.data=c;e.a.Ub(b)},Ab:function(a,b){a.name=b;if(7>=ab)try{a.mergeAttributes(d.createElement("<input name='"+a.name+"'/>"),!1)}catch(c){}},Ub:function(a){9<=ab&&(a=1==a.nodeType?a:a.parentNode,a.style&&(a.style.zoom=a.style.zoom))},Sb:function(a){if(ab){var b=a.style.width;a.style.width=0;a.style.width=b}},gc:function(a,b){for(var a=e.a.c(a),b=e.a.c(b),d=[],c=
a;c<=b;c++)d.push(c);return d},R:function(a){for(var b=[],d=0,c=a.length;d<c;d++)b.push(a[d]);return b},kc:6===ab,lc:7===ab,oa:ab,mb:function(a,b){for(var d=e.a.R(a.getElementsByTagName("input")).concat(e.a.R(a.getElementsByTagName("textarea"))),c="string"==typeof b?function(a){return a.name===b}:function(a){return b.test(a.name)},g=[],f=d.length-1;0<=f;f--)c(d[f])&&g.push(d[f]);return g},dc:function(a){return"string"==typeof a&&(a=e.a.ta(a))?h&&h.parse?h.parse(a):(new Function("return "+a))():null},
Wa:function(a,b,d){if(!h||!h.stringify)throw Error("Cannot find JSON.stringify(). Some browsers (e.g., IE < 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js");return h.stringify(e.a.c(a),b,d)},ec:function(a,b,c){var c=c||{},g=c.params||{},f=c.includeFields||this.kb,h=a;if("object"==typeof a&&"form"===e.a.B(a))for(var h=a.action,i=f.length-1;0<=i;i--)for(var j=e.a.mb(a,f[i]),k=j.length-1;0<=k;k--)g[j[k].name]=
j[k].value;var b=e.a.c(b),p=d.createElement("form");p.style.display="none";p.action=h;p.method="post";for(var A in b)a=d.createElement("input"),a.name=A,a.value=e.a.Wa(e.a.c(b[A])),p.appendChild(a);n(g,function(a,b){var c=d.createElement("input");c.name=a;c.value=b;p.appendChild(c)});d.body.appendChild(p);c.submitter?c.submitter(p):p.submit();setTimeout(function(){p.parentNode.removeChild(p)},0)}};e.b("utils",e.a);e.b("utils.arrayForEach",e.a.r);e.b("utils.arrayFirst",e.a.fb);e.b("utils.arrayFilter",
e.a.la);e.b("utils.arrayGetDistinctValues",e.a.gb);e.b("utils.arrayIndexOf",e.a.l);e.b("utils.arrayMap",e.a.ya);e.b("utils.arrayPushAll",e.a.$);e.b("utils.arrayRemoveItem",e.a.ma);e.b("utils.extend",e.a.extend);e.b("utils.fieldsIncludedWithJsonPost",e.a.kb);e.b("utils.getFormFields",e.a.mb);e.b("utils.peekObservable",e.a.Ra);e.b("utils.postJson",e.a.ec);e.b("utils.parseJson",e.a.dc);e.b("utils.registerEventHandler",e.a.q);e.b("utils.stringifyJson",e.a.Wa);e.b("utils.range",e.a.gc);e.b("utils.toggleDomNodeCssClass",
e.a.ua);e.b("utils.triggerEvent",e.a.ha);e.b("utils.unwrapObservable",e.a.c);e.b("utils.objectForEach",e.a.A);e.b("utils.addOrRemoveItem",e.a.Y);e.b("unwrap",e.a.c);Function.prototype.bind||(Function.prototype.bind=function(a){var b=this,d=Array.prototype.slice.call(arguments),a=d.shift();return function(){return b.apply(a,d.concat(Array.prototype.slice.call(arguments)))}});e.a.f=new function(){function b(e,H){var f=e[c];if(!f||"null"===f||!g[f]){if(!H)return a;f=e[c]="ko"+d++;g[f]={}}return g[f]}
var d=0,c="__ko__"+(new Date).getTime(),g={};return{get:function(d,c){var g=b(d,!1);return g===a?a:g[c]},set:function(d,c,g){if(g!==a||b(d,!1)!==a)b(d,!0)[c]=g},clear:function(a){var b=a[c];return b?(delete g[b],a[c]=null,!0):!1},L:function(){return d++ +c}}};e.b("utils.domData",e.a.f);e.b("utils.domData.clear",e.a.f.clear);e.a.u=new function(){function b(d,g){var f=e.a.f.get(d,c);f===a&&g&&(f=[],e.a.f.set(d,c,f));return f}function d(a){var c=b(a,!1);if(c)for(var c=c.slice(0),g=0;g<c.length;g++)c[g](a);
e.a.f.clear(a);e.a.u.cleanExternalData(a);if(h[a.nodeType])for(c=a.firstChild;a=c;)c=a.nextSibling,8===a.nodeType&&d(a)}var c=e.a.f.L(),g={1:!0,8:!0,9:!0},h={1:!0,9:!0};return{ja:function(a,d){if("function"!=typeof d)throw Error("Callback must be a function");b(a,!0).push(d)},yb:function(d,g){var f=b(d,!1);f&&(e.a.ma(f,g),0==f.length&&e.a.f.set(d,c,a))},M:function(a){if(g[a.nodeType]&&(d(a),h[a.nodeType])){var b=[];e.a.$(b,a.getElementsByTagName("*"));for(var c=0,f=b.length;c<f;c++)d(b[c])}return a},
removeNode:function(a){e.M(a);a.parentNode&&a.parentNode.removeChild(a)},cleanExternalData:function(a){f&&"function"==typeof f.cleanData&&f.cleanData([a])}}};e.M=e.a.u.M;e.removeNode=e.a.u.removeNode;e.b("cleanNode",e.M);e.b("removeNode",e.removeNode);e.b("utils.domNodeDisposal",e.a.u);e.b("utils.domNodeDisposal.addDisposeCallback",e.a.u.ja);e.b("utils.domNodeDisposal.removeDisposeCallback",e.a.u.yb);e.a.Pa=function(a){var c;if(f)if(f.parseHTML)c=f.parseHTML(a)||[];else{if((c=f.clean([a]))&&c[0]){for(a=
c[0];a.parentNode&&11!==a.parentNode.nodeType;)a=a.parentNode;a.parentNode&&a.parentNode.removeChild(a)}}else{var g=e.a.ta(a).toLowerCase();c=d.createElement("div");g=g.match(/^<(thead|tbody|tfoot)/)&&[1,"<table>","</table>"]||!g.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!g.indexOf("<td")||!g.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||[0,"",""];a="ignored<div>"+g[1]+a+g[2]+"</div>";for("function"==typeof b.innerShiv?c.appendChild(b.innerShiv(a)):c.innerHTML=
a;g[0]--;)c=c.lastChild;c=e.a.R(c.lastChild.childNodes)}return c};e.a.Ua=function(b,d){e.a.Fa(b);d=e.a.c(d);if(null!==d&&d!==a)if("string"!=typeof d&&(d=d.toString()),f)f(b).html(d);else for(var c=e.a.Pa(d),g=0;g<c.length;g++)b.appendChild(c[g])};e.b("utils.parseHtmlFragment",e.a.Pa);e.b("utils.setHtml",e.a.Ua);var r=function(a,b){if(a)if(8==a.nodeType){var d=e.w.vb(a.nodeValue);null!=d&&b.push({Qb:a,ac:d})}else if(1==a.nodeType)for(var d=0,c=a.childNodes,g=c.length;d<g;d++)r(c[d],b)},q={};e.w={Ma:function(a){if("function"!=
typeof a)throw Error("You can only pass a function to ko.memoization.memoize()");var b=(4294967296*(1+Math.random())|0).toString(16).substring(1)+(4294967296*(1+Math.random())|0).toString(16).substring(1);q[b]=a;return"<\!--[ko_memo:"+b+"]--\>"},Gb:function(b,d){var c=q[b];if(c===a)throw Error("Couldn't find any memo with ID "+b+". Perhaps it's already been unmemoized.");try{return c.apply(null,d||[]),!0}finally{delete q[b]}},Hb:function(a,b){var d=[];r(a,d);for(var c=0,g=d.length;c<g;c++){var f=
d[c].Qb,h=[f];b&&e.a.$(h,b);e.w.Gb(d[c].ac,h);f.nodeValue="";f.parentNode&&f.parentNode.removeChild(f)}},vb:function(a){return(a=a.match(/^\[ko_memo\:(.*?)\]$/))?a[1]:null}};e.b("memoization",e.w);e.b("memoization.memoize",e.w.Ma);e.b("memoization.unmemoize",e.w.Gb);e.b("memoization.parseMemoText",e.w.vb);e.b("memoization.unmemoizeDomNodeAndDescendants",e.w.Hb);e.Ga={throttle:function(a,b){a.throttleEvaluation=b;var d=null;return e.h({read:a,write:function(c){clearTimeout(d);d=setTimeout(function(){a(c)},
b)}})},rateLimit:function(a,b){var d,c,g;"number"==typeof b?d=b:(d=b.timeout,c=b.method);g="notifyWhenChangesStop"==c?T:k;a.La(function(a){return g(a,d)})},notify:function(a,b){a.equalityComparer="always"==b?null:j}};var t={undefined:1,"boolean":1,number:1,string:1};e.b("extenders",e.Ga);e.Eb=function(a,b,d){this.target=a;this.za=b;this.Pb=d;this.qb=!1;e.s(this,"dispose",this.D)};e.Eb.prototype.D=function(){this.qb=!0;this.Pb()};e.N=function(){e.a.sa(this,e.N.fn);this.H={}};c={V:function(a,b,d){var c=
this,d=d||"change",g=new e.Eb(c,b?a.bind(b):a,function(){e.a.ma(c.H[d],g)});c.o&&c.o();c.H[d]||(c.H[d]=[]);c.H[d].push(g);return g},notifySubscribers:function(a,b){b=b||"change";if(this.ob(b))try{e.k.hb();for(var d=this.H[b].slice(0),c=0,g;g=d[c];++c)g.qb||g.za(a)}finally{e.k.end()}},La:function(a){var b=this,d=e.v(b),c,g,f;b.ia||(b.ia=b.notifySubscribers,b.notifySubscribers=function(a,d){d&&"change"!==d?"beforeChange"===d?b.$a(a):b.ia(a,d):b.ab(a)});var h=a(function(){d&&f===b&&(f=b());c=!1;b.Ka(g,
f)&&b.ia(g=f)});b.ab=function(a){c=!0;f=a;h()};b.$a=function(a){c||(g=a,b.ia(a,"beforeChange"))}},ob:function(a){return this.H[a]&&this.H[a].length},Vb:function(){var a=0;e.a.A(this.H,function(b,d){a+=d.length});return a},Ka:function(a,b){return!this.equalityComparer||!this.equalityComparer(a,b)},extend:function(a){var b=this;a&&e.a.A(a,function(a,d){var c=e.Ga[a];"function"==typeof c&&(b=c(b,d)||b)});return b}};e.s(c,"subscribe",c.V);e.s(c,"extend",c.extend);e.s(c,"getSubscriptionsCount",c.Vb);e.a.na&&
e.a.ra(c,Function.prototype);e.N.fn=c;e.rb=function(a){return null!=a&&"function"==typeof a.V&&"function"==typeof a.notifySubscribers};e.b("subscribable",e.N);e.b("isSubscribable",e.rb);var u=function(a){x.push(s);s=a},w=function(){s=x.pop()},x=[],s,z=0;e.ca=e.k={hb:u,end:w,xb:function(a){if(s){if(!e.rb(a))throw Error("Only subscribable things can act as dependencies");s.za(a,a.Jb||(a.Jb=++z))}},t:function(a,b,d){try{return u(),a.apply(b,d||[])}finally{w()}},fa:function(){if(s)return s.ba.fa()},pa:function(){if(s)return s.pa}};
e.b("computedContext",e.ca);e.b("computedContext.getDependenciesCount",e.ca.fa);e.b("computedContext.isInitial",e.ca.pa);e.m=function(a){function b(){if(0<arguments.length)return b.Ka(d,arguments[0])&&(b.P(),d=arguments[0],b.O()),this;e.k.xb(b);return d}var d=a;e.N.call(b);e.a.sa(b,e.m.fn);b.o=function(){return d};b.O=function(){b.notifySubscribers(d)};b.P=function(){b.notifySubscribers(d,"beforeChange")};e.s(b,"peek",b.o);e.s(b,"valueHasMutated",b.O);e.s(b,"valueWillMutate",b.P);return b};e.m.fn=
{equalityComparer:j};var v=e.m.fc="__ko_proto__";e.m.fn[v]=e.m;e.a.na&&e.a.ra(e.m.fn,e.N.fn);e.Ha=function(b,d){return null===b||b===a||b[v]===a?!1:b[v]===d?!0:e.Ha(b[v],d)};e.v=function(a){return e.Ha(a,e.m)};e.sb=function(a){return"function"==typeof a&&a[v]===e.m||"function"==typeof a&&a[v]===e.h&&a.Xb?!0:!1};e.b("observable",e.m);e.b("isObservable",e.v);e.b("isWriteableObservable",e.sb);e.T=function(a){a=a||[];if("object"!=typeof a||!("length"in a))throw Error("The argument passed when initializing an observable array must be an array, or null, or undefined.");
a=e.m(a);e.a.sa(a,e.T.fn);return a.extend({trackArrayChanges:!0})};e.T.fn={remove:function(a){for(var b=this.o(),d=[],c="function"!=typeof a||e.v(a)?function(b){return b===a}:a,g=0;g<b.length;g++){var f=b[g];c(f)&&(0===d.length&&this.P(),d.push(f),b.splice(g,1),g--)}d.length&&this.O();return d},removeAll:function(b){if(b===a){var d=this.o(),c=d.slice(0);this.P();d.splice(0,d.length);this.O();return c}return b?this.remove(function(a){return 0<=e.a.l(b,a)}):[]},destroy:function(a){var b=this.o(),d=
"function"!=typeof a||e.v(a)?function(b){return b===a}:a;this.P();for(var c=b.length-1;0<=c;c--)d(b[c])&&(b[c]._destroy=!0);this.O()},destroyAll:function(b){return b===a?this.destroy(function(){return!0}):b?this.destroy(function(a){return 0<=e.a.l(b,a)}):[]},indexOf:function(a){var b=this();return e.a.l(b,a)},replace:function(a,b){var d=this.indexOf(a);0<=d&&(this.P(),this.o()[d]=b,this.O())}};e.a.r("pop push reverse shift sort splice unshift".split(" "),function(a){e.T.fn[a]=function(){var b=this.o();
this.P();this.ib(b,a,arguments);b=b[a].apply(b,arguments);this.O();return b}});e.a.r(["slice"],function(a){e.T.fn[a]=function(){var b=this();return b[a].apply(b,arguments)}});e.a.na&&e.a.ra(e.T.fn,e.m.fn);e.b("observableArray",e.T);e.Ga.trackArrayChanges=function(a){if(!a.ib){var b=!1,d=null,c=0,g=a.V;a.V=a.subscribe=function(f,h,i){if("arrayChange"===i&&!b){b=!0;var j=a.notifySubscribers;a.notifySubscribers=function(a,b){b&&"change"!==b||++c;return j.apply(this,arguments)};var n=[].concat(a.o()||
[]);d=null;a.V(function(b){b=[].concat(b||[]);if(a.ob("arrayChange")){var g;if(!d||1<c)d=e.a.Aa(n,b,{sparse:!0});g=d;g.length&&a.notifySubscribers(g,"arrayChange")}n=b;d=null;c=0})}return g.apply(this,arguments)};a.ib=function(a,g,f){function H(a,b,d){return h[h.length]={status:a,value:b,index:d}}if(b&&!c){var h=[],i=a.length,j=f.length,n=0;switch(g){case "push":n=i;case "unshift":for(g=0;g<j;g++)H("added",f[g],n+g);break;case "pop":n=i-1;case "shift":i&&H("deleted",a[n],n);break;case "splice":for(var g=
Math.min(Math.max(0,0>f[0]?i+f[0]:f[0]),i),i=1===j?i:Math.min(g+(f[1]||0),i),j=g+j-2,n=Math.max(i,j),Mf=[],k=[],p=2;g<n;++g,++p)g<i&&k.push(H("deleted",a[g],g)),g<j&&Mf.push(H("added",f[p],g));e.a.lb(k,Mf);break;default:return}d=h}}}};e.ba=e.h=function(a,b,d){function c(){A=!0;e.a.A(aa,function(a,b){b.D()});aa={};J=0;n=!1}function g(){var a=h.throttleEvaluation;a&&0<=a?(clearTimeout(o),o=setTimeout(f,a)):h.wa?h.wa():f()}function f(){if(!k&&!A){if(xa&&xa()){if(!p){l();return}}else p=!1;k=!0;try{var a=
aa,d=J;e.k.hb({za:function(b,c){A||(d&&a[c]?(aa[c]=a[c],++J,delete a[c],--d):aa[c]||(aa[c]=b.V(g),++J))},ba:h,pa:!J});aa={};J=0;try{var c=b?I.call(b):I()}finally{e.k.end(),d&&e.a.A(a,function(a,b){b.D()}),n=!1}h.Ka(j,c)&&(h.notifySubscribers(j,"beforeChange"),j=c,h.wa&&!h.throttleEvaluation||h.notifySubscribers(j))}finally{k=!1}J||l()}}function h(){if(0<arguments.length){if("function"===typeof T)T.apply(b,arguments);else throw Error("Cannot write a value to a ko.computed unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters.");
return this}n&&f();e.k.xb(h);return j}function i(){return n||0<J}var j,n=!0,k=!1,p=!1,A=!1,I=a;I&&"object"==typeof I?(d=I,I=d.read):(d=d||{},I||(I=d.read));if("function"!=typeof I)throw Error("Pass a function that returns the value of the ko.computed");var T=d.write,m=d.disposeWhenNodeIsRemoved||d.F||null,fa=d.disposeWhen||d.Da,xa=fa,l=c,aa={},J=0,o=null;b||(b=d.owner);e.N.call(h);e.a.sa(h,e.h.fn);h.o=function(){n&&!J&&f();return j};h.fa=function(){return J};h.Xb="function"===typeof d.write;h.D=function(){l()};
h.ga=i;var q=h.La;h.La=function(a){q.call(h,a);h.wa=function(){h.$a(j);n=!0;h.ab(h)}};e.s(h,"peek",h.o);e.s(h,"dispose",h.D);e.s(h,"isActive",h.ga);e.s(h,"getDependenciesCount",h.fa);m&&(p=!0,m.nodeType&&(xa=function(){return!e.a.Ea(m)||fa&&fa()}));!0!==d.deferEvaluation&&f();m&&i()&&m.nodeType&&(l=function(){e.a.u.yb(m,l);c()},e.a.u.ja(m,l));return h};e.Zb=function(a){return e.Ha(a,e.h)};c=e.m.fc;e.h[c]=e.m;e.h.fn={equalityComparer:j};e.h.fn[c]=e.h;e.a.na&&e.a.ra(e.h.fn,e.N.fn);e.b("dependentObservable",
e.h);e.b("computed",e.h);e.b("isComputed",e.Zb);var y=function(b,d,c){c=c||new C;b=d(b);if("object"!=typeof b||null===b||b===a||b instanceof Date||b instanceof String||b instanceof Number||b instanceof Boolean)return b;var g=b instanceof Array?[]:{};c.save(b,g);var e=b,f=function(e){var f=d(b[e]);switch(typeof f){case "boolean":case "number":case "string":case "function":g[e]=f;break;case "object":case "undefined":var h=c.get(f);g[e]=h!==a?h:y(f,d,c)}};if(e instanceof Array){for(var h=0;h<e.length;h++)f(h);
"function"==typeof e.toJSON&&f("toJSON")}else for(h in e)f(h);return g},C=function(){this.keys=[];this.Za=[]};e.Fb=function(a){if(0==arguments.length)throw Error("When calling ko.toJS, pass the object you want to convert.");return y(a,function(a){for(var b=0;e.v(a)&&10>b;b++)a=a();return a})};e.toJSON=function(a,b,d){a=e.Fb(a);return e.a.Wa(a,b,d)};C.prototype={save:function(a,b){var d=e.a.l(this.keys,a);0<=d?this.Za[d]=b:(this.keys.push(a),this.Za.push(b))},get:function(b){b=e.a.l(this.keys,b);return 0<=
b?this.Za[b]:a}};e.b("toJS",e.Fb);e.b("toJSON",e.toJSON);e.i={p:function(b){switch(e.a.B(b)){case "option":return!0===b.__ko__hasDomDataOptionValue__?e.a.f.get(b,e.d.options.Oa):7>=e.a.oa?b.getAttributeNode("value")&&b.getAttributeNode("value").specified?b.value:b.text:b.value;case "select":return 0<=b.selectedIndex?e.i.p(b.options[b.selectedIndex]):a;default:return b.value}},X:function(b,d,c){switch(e.a.B(b)){case "option":switch(typeof d){case "string":e.a.f.set(b,e.d.options.Oa,a);"__ko__hasDomDataOptionValue__"in
b&&delete b.__ko__hasDomDataOptionValue__;b.value=d;break;default:e.a.f.set(b,e.d.options.Oa,d),b.__ko__hasDomDataOptionValue__=!0,b.value="number"===typeof d?d:""}break;case "select":if(""===d||null===d)d=a;for(var g=-1,f=0,h=b.options.length,i;f<h;++f)if(i=e.i.p(b.options[f]),i==d||""==i&&d===a){g=f;break}if(c||0<=g||d===a&&1<b.size)b.selectedIndex=g;break;default:if(null===d||d===a)d="";b.value=d}}};e.b("selectExtensions",e.i);e.b("selectExtensions.readValue",e.i.p);e.b("selectExtensions.writeValue",
e.i.X);var D=function(a){a=e.a.ta(a);123===a.charCodeAt(0)&&(a=a.slice(1,-1));var b=[],d=a.match(G),c,g,f=0;if(d){d.push(",");for(var h=0,i;i=d[h];++h){var j=i.charCodeAt(0);if(44===j){if(0>=f){c&&b.push(g?{key:c,value:g.join("")}:{unknown:c});c=g=f=0;continue}}else if(58===j){if(!g)continue}else if(47===j&&h&&1<i.length)(j=d[h-1].match(M))&&!O[j[0]]&&(a=a.substr(a.indexOf(i)+1),d=a.match(G),d.push(","),h=-1,i="/");else if(40===j||123===j||91===j)++f;else if(41===j||125===j||93===j)--f;else if(!c&&
!g){c=34===j||39===j?i.slice(1,-1):i;continue}g?g.push(i):g=[i]}}return b},E=["true","false","null","undefined"],F=/^(?:[$_a-z][$\w]*|(.+)(\.\s*[$_a-z][$\w]*|\[.+\]))$/i,G=RegExp("\"(?:[^\"\\\\]|\\\\.)*\"|'(?:[^'\\\\]|\\\\.)*'|/(?:[^/\\\\]|\\\\.)*/w*|[^\\s:,/][^,\"'{}()/:[\\]]*[^\\s,\"'{}()/:[\\]]|[^\\s]","g"),M=/[\])"'A-Za-z0-9_$]+$/,O={"in":1,"return":1,"typeof":1},L={};e.g={aa:[],W:L,Qa:D,qa:function(a,b){function d(a,b){var h,H=e.getBindingHandler(a);if(H&&H.preprocess?b=H.preprocess(b,a,d):1){if(H=
L[a])h=b,0<=e.a.l(E,h)?h=!1:(H=h.match(F),h=null===H?!1:H[1]?"Object("+H[1]+")"+H[2]:h),H=h;H&&g.push("'"+a+"':function(_z){"+h+"=_z}");f&&(b="function(){return "+b+" }");c.push("'"+a+"':"+b)}}var b=b||{},c=[],g=[],f=b.valueAccessors,h="string"===typeof a?D(a):a;e.a.r(h,function(a){d(a.key||a.unknown,a.value)});g.length&&d("_ko_property_writers","{"+g.join(",")+" }");return c.join(",")},$b:function(a,b){for(var d=0;d<a.length;d++)if(a[d].key==b)return!0;return!1},va:function(a,b,d,c,g){if(a&&e.v(a))!e.sb(a)||
g&&a.o()===c||a(c);else if((a=b.get("_ko_property_writers"))&&a[d])a[d](c)}};e.b("expressionRewriting",e.g);e.b("expressionRewriting.bindingRewriteValidators",e.g.aa);e.b("expressionRewriting.parseObjectLiteral",e.g.Qa);e.b("expressionRewriting.preProcessBindings",e.g.qa);e.b("expressionRewriting._twoWayBindings",e.g.W);e.b("jsonExpressionRewriting",e.g);e.b("jsonExpressionRewriting.insertPropertyAccessorsIntoJson",e.g.qa);var B=function(a){return 8==a.nodeType&&R.test(N?a.text:a.nodeValue)},K=function(a){return 8==
a.nodeType&&U.test(N?a.text:a.nodeValue)},P=function(a,b){for(var d=a,c=1,g=[];d=d.nextSibling;){if(K(d)&&(c--,0===c))return g;g.push(d);B(d)&&c++}if(!b)throw Error("Cannot find closing comment tag to match: "+a.nodeValue);return null},Q=function(a,b){var d=P(a,b);return d?0<d.length?d[d.length-1].nextSibling:a.nextSibling:null},N=d&&"<\!--test--\>"===d.createComment("test").text,R=N?/^\x3c!--\s*ko(?:\s+([\s\S]+))?\s*--\x3e$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/,U=N?/^\x3c!--\s*\/ko\s*--\x3e$/:/^\s*\/ko\s*$/,
X={ul:!0,ol:!0};e.e={Q:{},childNodes:function(a){return B(a)?P(a):a.childNodes},da:function(a){if(B(a))for(var a=e.e.childNodes(a),b=0,d=a.length;b<d;b++)e.removeNode(a[b]);else e.a.Fa(a)},U:function(a,b){if(B(a)){e.e.da(a);for(var d=a.nextSibling,c=0,g=b.length;c<g;c++)d.parentNode.insertBefore(b[c],d)}else e.a.U(a,b)},wb:function(a,b){B(a)?a.parentNode.insertBefore(b,a.nextSibling):a.firstChild?a.insertBefore(b,a.firstChild):a.appendChild(b)},pb:function(a,b,d){d?B(a)?a.parentNode.insertBefore(b,
d.nextSibling):d.nextSibling?a.insertBefore(b,d.nextSibling):a.appendChild(b):e.e.wb(a,b)},firstChild:function(a){return B(a)?!a.nextSibling||K(a.nextSibling)?null:a.nextSibling:a.firstChild},nextSibling:function(a){B(a)&&(a=Q(a));return a.nextSibling&&K(a.nextSibling)?null:a.nextSibling},Wb:B,jc:function(a){return(a=(N?a.text:a.nodeValue).match(R))?a[1]:null},ub:function(a){if(X[e.a.B(a)]){var b=a.firstChild;if(b){do if(1===b.nodeType){var d;d=b.firstChild;var c=null;if(d){do if(c)c.push(d);else if(B(d)){var g=
Q(d,!0);g?d=g:c=[d]}else K(d)&&(c=[d]);while(d=d.nextSibling)}if(d=c){c=b.nextSibling;for(g=0;g<d.length;g++)c?a.insertBefore(d[g],c):a.appendChild(d[g])}}while(b=b.nextSibling)}}}};e.b("virtualElements",e.e);e.b("virtualElements.allowedBindings",e.e.Q);e.b("virtualElements.emptyNode",e.e.da);e.b("virtualElements.insertAfter",e.e.pb);e.b("virtualElements.prepend",e.e.wb);e.b("virtualElements.setDomNodeChildren",e.e.U);e.J=function(){this.Mb={}};e.a.extend(e.J.prototype,{nodeHasBindings:function(a){switch(a.nodeType){case 1:return null!=
a.getAttribute("data-bind");case 8:return e.e.Wb(a);default:return!1}},getBindings:function(a,b){var d=this.getBindingsString(a,b);return d?this.parseBindingsString(d,b,a):null},getBindingAccessors:function(a,b){var d=this.getBindingsString(a,b);return d?this.parseBindingsString(d,b,a,{valueAccessors:!0}):null},getBindingsString:function(a){switch(a.nodeType){case 1:return a.getAttribute("data-bind");case 8:return e.e.jc(a);default:return null}},parseBindingsString:function(a,b,d,c){try{var g=this.Mb,
f=a+(c&&c.valueAccessors||""),h;if(!(h=g[f])){var i,j="with($context){with($data||{}){return{"+e.g.qa(a,c)+"}}}";i=new Function("$context","$element",j);h=g[f]=i}return h(b,d)}catch(n){throw n.message="Unable to parse bindings.\nBindings value: "+a+"\nMessage: "+n.message,n;}}});e.J.instance=new e.J;e.b("bindingProvider",e.J);var Y=function(a){return function(){return a}},S=function(a){return a()},W=function(a){return e.a.Na(e.k.t(a),function(b,d){return function(){return a()[d]}})},ea=function(a,
b){return W(this.getBindings.bind(this,a,b))},Z=function(a,b,d){var c,g=e.e.firstChild(b),f=e.J.instance,h=f.preprocessNode;if(h){for(;c=g;)g=e.e.nextSibling(c),h.call(f,c);g=e.e.firstChild(b)}for(;c=g;)g=e.e.nextSibling(c),ba(a,c,d)},ba=function(a,b,d){var c=!0,g=1===b.nodeType;g&&e.e.ub(b);if(g&&d||e.J.instance.nodeHasBindings(b))c=ca(b,null,a,d).shouldBindDescendants;c&&!oa[e.a.B(b)]&&Z(a,b,!g)},ca=function(b,d,c,g){var f=e.a.f.get(b,ha);if(!d){if(f)throw Error("You cannot apply bindings multiple times to the same element.");
e.a.f.set(b,ha,!0)}!f&&g&&e.Db(b,c);var h;if(d&&"function"!==typeof d)h=d;else{var i=e.J.instance,j=i.getBindingAccessors||ea,n=e.h(function(){(h=d?d(c,b):j.call(i,b,c))&&c.C&&c.C();return h},null,{F:b});h&&n.ga()||(n=null)}var k;if(h){var p=n?function(a){return function(){return S(n()[a])}}:function(a){return h[a]},A=function(){return e.a.Na(n?n():h,S)};A.get=function(a){return h[a]&&S(p(a))};A.has=function(a){return a in h};var I=h,T=[],m={},J=[];e.a.A(I,function kj(a){if(!m[a]){var b=e.getBindingHandler(a);
b&&(b.after&&(J.push(a),e.a.r(b.after,function(a){if(I[a]){if(-1!==e.a.l(J,a))throw Error("Cannot combine the following bindings, because they have a cyclic dependency: "+J.join(", "));kj(a)}}),J.length--),T.push({key:a,nb:b}));m[a]=!0}});e.a.r(T,function(d){var g=d.nb.init,f=d.nb.update,i=d.key;if(8===b.nodeType&&!e.e.Q[i])throw Error("The binding '"+i+"' cannot be used with virtual elements");try{"function"==typeof g&&e.k.t(function(){var d=g(b,p(i),A,c.$data,c);if(d&&d.controlsDescendantBindings){if(k!==
a)throw Error("Multiple bindings ("+k+" and "+i+") are trying to control descendant bindings of the same element. You cannot use these bindings together on the same element.");k=i}}),"function"==typeof f&&e.h(function(){f(b,p(i),A,c.$data,c)},null,{F:b})}catch(j){throw j.message='Unable to process binding "'+i+": "+h[i]+'"\nMessage: '+j.message,j;}})}return{shouldBindDescendants:k===a}},V=function(a){return a&&a instanceof e.I?a:new e.I(a)};e.d={};var oa={script:!0};e.getBindingHandler=function(a){return e.d[a]};
e.I=function(b,d,c,g){var f=this,h="function"==typeof b&&!e.v(b),i,j=e.h(function(){var a=h?b():b,i=e.a.c(a);d?(d.C&&d.C(),e.a.extend(f,d),j&&(f.C=j)):(f.$parents=[],f.$root=i,f.ko=e);f.$rawData=a;f.$data=i;c&&(f[c]=i);g&&g(f,d,i);return f.$data},null,{Da:function(){return i&&!e.a.bb(i)},F:!0});j.ga()&&(f.C=j,j.equalityComparer=null,i=[],j.Ib=function(b){i.push(b);e.a.u.ja(b,function(b){e.a.ma(i,b);i.length||(j.D(),f.C=j=a)})})};e.I.prototype.createChildContext=function(a,b,d){return new e.I(a,this,
b,function(a,b){a.$parentContext=b;a.$parent=b.$data;a.$parents=(b.$parents||[]).slice(0);a.$parents.unshift(a.$parent);d&&d(a)})};e.I.prototype.extend=function(a){return new e.I(this.C||this.$data,this,null,function(b,d){b.$rawData=d.$rawData;e.a.extend(b,"function"==typeof a?a():a)})};var ha=e.a.f.L(),ia=e.a.f.L();e.Db=function(a,b){if(2==arguments.length)e.a.f.set(a,ia,b),b.C&&b.C.Ib(a);else return e.a.f.get(a,ia)};e.xa=function(a,b,d){1===a.nodeType&&e.e.ub(a);return ca(a,b,V(d),!0)};e.Kb=function(a,
b,d){d=V(d);return e.xa(a,"function"===typeof b?W(b.bind(null,d,a)):e.a.Na(b,Y),d)};e.eb=function(a,b){1!==b.nodeType&&8!==b.nodeType||Z(V(a),b,!0)};e.cb=function(a,d){!f&&b.jQuery&&(f=b.jQuery);if(d&&1!==d.nodeType&&8!==d.nodeType)throw Error("ko.applyBindings: first parameter should be your view model; second parameter should be a DOM node");d=d||b.document.body;ba(V(a),d,!0)};e.Ca=function(b){switch(b.nodeType){case 1:case 8:var d=e.Db(b);if(d)return d;if(b.parentNode)return e.Ca(b.parentNode)}return a};
e.Ob=function(b){return(b=e.Ca(b))?b.$data:a};e.b("bindingHandlers",e.d);e.b("applyBindings",e.cb);e.b("applyBindingsToDescendants",e.eb);e.b("applyBindingAccessorsToNode",e.xa);e.b("applyBindingsToNode",e.Kb);e.b("contextFor",e.Ca);e.b("dataFor",e.Ob);var ka={"class":"className","for":"htmlFor"};e.d.attr={update:function(b,d){var c=e.a.c(d())||{};e.a.A(c,function(d,c){var c=e.a.c(c),g=!1===c||null===c||c===a;g&&b.removeAttribute(d);8>=e.a.oa&&d in ka?(d=ka[d],g?b.removeAttribute(d):b[d]=c):g||b.setAttribute(d,
c.toString());"name"===d&&e.a.Ab(b,g?"":c.toString())})}};e.d.checked={after:["value","attr"],init:function(b,d,c){function g(){return c.has("checkedValue")?e.a.c(c.get("checkedValue")):b.value}function f(){var a=b.checked,h=p?g():a;if(!e.ca.pa()&&(!j||a)){var i=e.k.t(d);n?k!==h?(a&&(e.a.Y(i,h,!0),e.a.Y(i,k,!1)),k=h):e.a.Y(i,h,a):e.g.va(i,c,"checked",h,!0)}}function h(){var a=e.a.c(d());b.checked=n?0<=e.a.l(a,g()):i?a:g()===a}var i="checkbox"==b.type,j="radio"==b.type;if(i||j){var n=i&&e.a.c(d())instanceof
Array,k=n?g():a,p=j||n;j&&!b.name&&e.d.uniqueName.init(b,function(){return!0});e.ba(f,null,{F:b});e.a.q(b,"click",f);e.ba(h,null,{F:b})}}};e.g.W.checked=!0;e.d.checkedValue={update:function(a,b){a.value=e.a.c(b())}};e.d.css={update:function(a,b){var d=e.a.c(b());"object"==typeof d?e.a.A(d,function(b,d){d=e.a.c(d);e.a.ua(a,b,d)}):(d=String(d||""),e.a.ua(a,a.__ko__cssValue,!1),a.__ko__cssValue=d,e.a.ua(a,d,!0))}};e.d.enable={update:function(a,b){var d=e.a.c(b());d&&a.disabled?a.removeAttribute("disabled"):
d||a.disabled||(a.disabled=!0)}};e.d.disable={update:function(a,b){e.d.enable.update(a,function(){return!e.a.c(b())})}};e.d.event={init:function(a,b,d,c,g){var f=b()||{};e.a.A(f,function(f){"string"==typeof f&&e.a.q(a,f,function(a){var h,i=b()[f];if(i){try{var H=e.a.R(arguments);c=g.$data;H.unshift(c);h=i.apply(c,H)}finally{!0!==h&&(a.preventDefault?a.preventDefault():a.returnValue=!1)}!1===d.get(f+"Bubble")&&(a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation())}})})}};e.d.foreach={tb:function(a){return function(){var b=
a(),d=e.a.Ra(b);if(!d||"number"==typeof d.length)return{foreach:b,templateEngine:e.K.Ja};e.a.c(b);return{foreach:d.data,as:d.as,includeDestroyed:d.includeDestroyed,afterAdd:d.afterAdd,beforeRemove:d.beforeRemove,afterRender:d.afterRender,beforeMove:d.beforeMove,afterMove:d.afterMove,templateEngine:e.K.Ja}}},init:function(a,b){return e.d.template.init(a,e.d.foreach.tb(b))},update:function(a,b,d,c,g){return e.d.template.update(a,e.d.foreach.tb(b),d,c,g)}};e.g.aa.foreach=!1;e.e.Q.foreach=!0;e.d.hasfocus=
{init:function(a,b,d){function c(g){a.__ko_hasfocusUpdating=!0;var f=a.ownerDocument;if("activeElement"in f){var h;try{h=f.activeElement}catch(i){h=f.body}g=h===a}f=b();e.g.va(f,d,"hasfocus",g,!0);a.__ko_hasfocusLastValue=g;a.__ko_hasfocusUpdating=!1}var g=c.bind(null,!0),f=c.bind(null,!1);e.a.q(a,"focus",g);e.a.q(a,"focusin",g);e.a.q(a,"blur",f);e.a.q(a,"focusout",f)},update:function(a,b){var d=!!e.a.c(b());a.__ko_hasfocusUpdating||a.__ko_hasfocusLastValue===d||(d?a.focus():a.blur(),e.k.t(e.a.ha,
null,[a,d?"focusin":"focusout"]))}};e.g.W.hasfocus=!0;e.d.hasFocus=e.d.hasfocus;e.g.W.hasFocus=!0;e.d.html={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b){e.a.Ua(a,b())}};m("if");m("ifnot",!1,!0);m("with",!0,!1,function(a,b){return a.createChildContext(b)});var da={};e.d.options={init:function(a){if("select"!==e.a.B(a))throw Error("options binding applies only to SELECT elements");for(;0<a.length;)a.remove(0);return{controlsDescendantBindings:!0}},update:function(b,d,
c){function g(){return e.a.la(b.options,function(a){return a.selected})}function f(a,b,d){var c=typeof b;return"function"==c?b(a):"string"==c?a[b]:d}function h(a,d){if(p.length){var c=0<=e.a.l(p,e.i.p(d[0]));e.a.Bb(d[0],c);A&&!c&&e.k.t(e.a.ha,null,[b,"change"])}}var i=0!=b.length&&b.multiple?b.scrollTop:null,j=e.a.c(d()),n=c.get("optionsIncludeDestroyed"),d={},k,p;p=b.multiple?e.a.ya(g(),e.i.p):0<=b.selectedIndex?[e.i.p(b.options[b.selectedIndex])]:[];j&&("undefined"==typeof j.length&&(j=[j]),k=e.a.la(j,
function(b){return n||b===a||null===b||!e.a.c(b._destroy)}),c.has("optionsCaption")&&(j=e.a.c(c.get("optionsCaption")),null!==j&&j!==a&&k.unshift(da)));var A=!1;d.beforeRemove=function(a){b.removeChild(a)};j=h;c.has("optionsAfterRender")&&(j=function(b,d){h(0,d);e.k.t(c.get("optionsAfterRender"),null,[d[0],b!==da?b:a])});e.a.Ta(b,k,function(d,g,h){h.length&&(p=h[0].selected?[e.i.p(h[0])]:[],A=!0);g=b.ownerDocument.createElement("option");d===da?(e.a.Va(g,c.get("optionsCaption")),e.i.X(g,a)):(h=f(d,
c.get("optionsValue"),d),e.i.X(g,e.a.c(h)),d=f(d,c.get("optionsText"),h),e.a.Va(g,d));return[g]},d,j);e.k.t(function(){c.get("valueAllowUnset")&&c.has("value")?e.i.X(b,e.a.c(c.get("value")),!0):(b.multiple?p.length&&g().length<p.length:p.length&&0<=b.selectedIndex?e.i.p(b.options[b.selectedIndex])!==p[0]:p.length||0<=b.selectedIndex)&&e.a.ha(b,"change")});e.a.Sb(b);i&&20<Math.abs(i-b.scrollTop)&&(b.scrollTop=i)}};e.d.options.Oa=e.a.f.L();e.d.selectedOptions={after:["options","foreach"],init:function(a,
b,d){e.a.q(a,"change",function(){var c=b(),g=[];e.a.r(a.getElementsByTagName("option"),function(a){a.selected&&g.push(e.i.p(a))});e.g.va(c,d,"selectedOptions",g)})},update:function(a,b){if("select"!=e.a.B(a))throw Error("values binding applies only to SELECT elements");var d=e.a.c(b());d&&"number"==typeof d.length&&e.a.r(a.getElementsByTagName("option"),function(a){var b=0<=e.a.l(d,e.i.p(a));e.a.Bb(a,b)})}};e.g.W.selectedOptions=!0;e.d.style={update:function(a,b){var d=e.a.c(b()||{});e.a.A(d,function(b,
d){d=e.a.c(d);a.style[b]=d||""})}};e.d.submit={init:function(a,b,d,c,g){if("function"!=typeof b())throw Error("The value for a submit binding must be a function");e.a.q(a,"submit",function(d){var c,e=b();try{c=e.call(g.$data,a)}finally{!0!==c&&(d.preventDefault?d.preventDefault():d.returnValue=!1)}})}};e.d.text={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b){e.a.Va(a,b())}};e.e.Q.text=!0;e.d.uniqueName={init:function(a,b){if(b()){var d="ko_unique_"+ ++e.d.uniqueName.Nb;
e.a.Ab(a,d)}}};e.d.uniqueName.Nb=0;e.d.value={after:["options","foreach"],init:function(a,b,d){function c(){h=!1;var g=b(),f=e.i.p(a);e.g.va(g,d,"value",f)}var g=["change"],f=d.get("valueUpdate"),h=!1;f&&("string"==typeof f&&(f=[f]),e.a.$(g,f),g=e.a.gb(g));!e.a.oa||"input"!=a.tagName.toLowerCase()||"text"!=a.type||"off"==a.autocomplete||a.form&&"off"==a.form.autocomplete||-1!=e.a.l(g,"propertychange")||(e.a.q(a,"propertychange",function(){h=!0}),e.a.q(a,"focus",function(){h=!1}),e.a.q(a,"blur",function(){h&&
c()}));e.a.r(g,function(b){var d=c;e.a.ic(b,"after")&&(d=function(){setTimeout(c,0)},b=b.substring(5));e.a.q(a,b,d)})},update:function(a,b,d){var c=e.a.c(b()),b=e.i.p(a);if(c!==b)if("select"===e.a.B(a)){var g=d.get("valueAllowUnset"),d=function(){e.i.X(a,c,g)};d();g||c===e.i.p(a)?setTimeout(d,0):e.k.t(e.a.ha,null,[a,"change"])}else e.i.X(a,c)}};e.g.W.value=!0;e.d.visible={update:function(a,b){var d=e.a.c(b()),c="none"!=a.style.display;d&&!c?a.style.display="":!d&&c&&(a.style.display="none")}};e.d.click=
{init:function(a,b,d,c,g){return e.d.event.init.call(this,a,function(){var a={};a.click=b();return a},d,c,g)}};e.G=function(){};e.G.prototype.renderTemplateSource=function(){throw Error("Override renderTemplateSource");};e.G.prototype.createJavaScriptEvaluatorBlock=function(){throw Error("Override createJavaScriptEvaluatorBlock");};e.G.prototype.makeTemplateSource=function(a,b){if("string"==typeof a){var b=b||d,c=b.getElementById(a);if(!c)throw Error("Cannot find template with ID "+a);return new e.n.j(c)}if(1==
a.nodeType||8==a.nodeType)return new e.n.Z(a);throw Error("Unknown template type: "+a);};e.G.prototype.renderTemplate=function(a,b,d,c){a=this.makeTemplateSource(a,c);return this.renderTemplateSource(a,b,d)};e.G.prototype.isTemplateRewritten=function(a,b){return!1===this.allowTemplateRewriting?!0:this.makeTemplateSource(a,b).data("isRewritten")};e.G.prototype.rewriteTemplate=function(a,b,d){a=this.makeTemplateSource(a,d);b=b(a.text());a.text(b);a.data("isRewritten",!0)};e.b("templateEngine",e.G);
var ma=function(a,b,d,c){for(var a=e.g.Qa(a),g=e.g.aa,f=0;f<a.length;f++){var h=a[f].key;if(g.hasOwnProperty(h)){var i=g[h];if("function"===typeof i){if(h=i(a[f].value))throw Error(h);}else if(!i)throw Error("This template engine does not support the '"+h+"' binding within its templates");}}d="ko.__tr_ambtns(function($context,$element){return(function(){return{ "+e.g.qa(a,{valueAccessors:!0})+" } })()},'"+d.toLowerCase()+"')";return c.createJavaScriptEvaluatorBlock(d)+b},sa=/(<([a-z]+\d*)(?:\s+(?!data-bind\s*=\s*)[a-z0-9\-]+(?:=(?:\"[^\"]*\"|\'[^\']*\'))?)*\s+)data-bind\s*=\s*(["'])([\s\S]*?)\3/gi,
ta=/\x3c!--\s*ko\b\s*([\s\S]*?)\s*--\x3e/g;e.Xa={Tb:function(a,b,d){b.isTemplateRewritten(a,d)||b.rewriteTemplate(a,function(a){return e.Xa.bc(a,b)},d)},bc:function(a,b){return a.replace(sa,function(a,d,c,g,e){return ma(e,d,c,b)}).replace(ta,function(a,d){return ma(d,"<\!-- ko --\>","#comment",b)})},Lb:function(a,b){return e.w.Ma(function(d,c){var g=d.nextSibling;g&&g.nodeName.toLowerCase()===b&&e.xa(g,a,c)})}};e.b("__tr_ambtns",e.Xa.Lb);e.n={};e.n.j=function(a){this.j=a};e.n.j.prototype.text=function(){var a=
e.a.B(this.j),a="script"===a?"text":"textarea"===a?"value":"innerHTML";if(0==arguments.length)return this.j[a];var b=arguments[0];"innerHTML"===a?e.a.Ua(this.j,b):this.j[a]=b};var na=e.a.f.L()+"_";e.n.j.prototype.data=function(a){if(1===arguments.length)return e.a.f.get(this.j,na+a);e.a.f.set(this.j,na+a,arguments[1])};var $=e.a.f.L();e.n.Z=function(a){this.j=a};e.n.Z.prototype=new e.n.j;e.n.Z.prototype.text=function(){if(0==arguments.length){var b=e.a.f.get(this.j,$)||{};b.Ya===a&&b.Ba&&(b.Ya=b.Ba.innerHTML);
return b.Ya}e.a.f.set(this.j,$,{Ya:arguments[0]})};e.n.j.prototype.nodes=function(){if(0==arguments.length)return(e.a.f.get(this.j,$)||{}).Ba;e.a.f.set(this.j,$,{Ba:arguments[0]})};e.b("templateSources",e.n);e.b("templateSources.domElement",e.n.j);e.b("templateSources.anonymousTemplate",e.n.Z);var ga=function(a,b,d){for(var c,b=e.e.nextSibling(b);a&&(c=a)!==b;)a=e.e.nextSibling(c),d(c,a)},pa=function(a,b){if(a.length){var d=a[0],c=a[a.length-1],g=d.parentNode,f=e.J.instance,h=f.preprocessNode;if(h){ga(d,
c,function(a,b){var g=a.previousSibling,e=h.call(f,a);e&&(a===d&&(d=e[0]||b),a===c&&(c=e[e.length-1]||g))});a.length=0;if(!d)return;d===c?a.push(d):(a.push(d,c),e.a.ea(a,g))}ga(d,c,function(a){1!==a.nodeType&&8!==a.nodeType||e.cb(b,a)});ga(d,c,function(a){1!==a.nodeType&&8!==a.nodeType||e.w.Hb(a,[b])});e.a.ea(a,g)}},ja=function(a){return a.nodeType?a:0<a.length?a[0]:null},qa=function(a,b,d,c,g){var g=g||{},f=a&&ja(a),f=f&&f.ownerDocument,h=g.templateEngine||la;e.Xa.Tb(d,h,f);d=h.renderTemplate(d,
c,g,f);if("number"!=typeof d.length||0<d.length&&"number"!=typeof d[0].nodeType)throw Error("Template engine must return an array of DOM nodes");f=!1;switch(b){case "replaceChildren":e.e.U(a,d);f=!0;break;case "replaceNode":e.a.zb(a,d);f=!0;break;case "ignoreTargetNode":break;default:throw Error("Unknown renderMode: "+b);}f&&(pa(d,c),g.afterRender&&e.k.t(g.afterRender,null,[d,c.$data]));return d},la;e.Cb=function(b){if(b!=a&&!(b instanceof e.G))throw Error("templateEngine must inherit from ko.templateEngine");
la=b};e.Sa=function(b,d,c,g,f){c=c||{};if((c.templateEngine||la)==a)throw Error("Set a template engine before calling renderTemplate");f=f||"replaceChildren";if(g){var h=ja(g);return e.h(function(){var a=d&&d instanceof e.I?d:new e.I(e.a.c(d)),i=e.v(b)?b():"function"==typeof b?b(a.$data,a):b,a=qa(g,f,i,a,c);"replaceNode"==f&&(g=a,h=ja(g))},null,{Da:function(){return!h||!e.a.Ea(h)},F:h&&"replaceNode"==f?h.parentNode:h})}return e.w.Ma(function(a){e.Sa(b,d,c,a,"replaceNode")})};e.hc=function(b,d,c,g,
f){function h(a,b){pa(b,j);c.afterRender&&c.afterRender(b,a)}function i(a,d){j=f.createChildContext(a,c.as,function(a){a.$index=d});var g="function"==typeof b?b(a,j):b;return qa(null,"ignoreTargetNode",g,j,c)}var j;return e.h(function(){var b=e.a.c(d)||[];"undefined"==typeof b.length&&(b=[b]);b=e.a.la(b,function(b){return c.includeDestroyed||b===a||null===b||!e.a.c(b._destroy)});e.k.t(e.a.Ta,null,[g,b,i,c,h])},null,{F:g})};var ua=e.a.f.L();e.d.template={init:function(a,b){var d=e.a.c(b());"string"==
typeof d||d.name?e.e.da(a):(d=e.e.childNodes(a),d=e.a.cc(d),(new e.n.Z(a)).nodes(d));return{controlsDescendantBindings:!0}},update:function(b,d,c,g,f){var h=d(),i,d=e.a.c(h),c=!0,g=null;"string"==typeof d?d={}:(h=d.name,"if"in d&&(c=e.a.c(d["if"])),c&&"ifnot"in d&&(c=!e.a.c(d.ifnot)),i=e.a.c(d.data));"foreach"in d?g=e.hc(h||b,c&&d.foreach||[],d,b,f):c?(f="data"in d?f.createChildContext(i,d.as):f,g=e.Sa(h||b,f,d,b)):e.e.da(b);f=g;(i=e.a.f.get(b,ua))&&"function"==typeof i.D&&i.D();e.a.f.set(b,ua,f&&
f.ga()?f:a)}};e.g.aa.template=function(a){a=e.g.Qa(a);return 1==a.length&&a[0].unknown||e.g.$b(a,"name")?null:"This template engine does not support anonymous templates nested within its templates"};e.e.Q.template=!0;e.b("setTemplateEngine",e.Cb);e.b("renderTemplate",e.Sa);e.a.lb=function(a,b,d){if(a.length&&b.length){var c,g,f,e,h;for(c=g=0;(!d||c<d)&&(e=a[g]);++g){for(f=0;h=b[f];++f)if(e.value===h.value){e.moved=h.index;h.moved=e.index;b.splice(f,1);c=f=0;break}c+=f}}};var va=function(a,b,d,c,g){var f=
Math.min,h=Math.max,i=[],j,n=a.length,k,p=b.length,A=p-n||1,I=n+p+1,T,m,J;for(j=0;j<=n;j++){m=T;i.push(T=[]);J=f(p,j+A);for(k=h(0,j-1);k<=J;k++)T[k]=k?j?a[j-1]===b[k-1]?m[k-1]:f(m[k]||I,T[k-1]||I)+1:k+1:j+1}f=[];h=[];A=[];j=n;for(k=p;j||k;)p=i[j][k]-1,k&&p===i[j][k-1]?h.push(f[f.length]={status:d,value:b[--k],index:k}):j&&p===i[j-1][k]?A.push(f[f.length]={status:c,value:a[--j],index:j}):(--k,--j,g.sparse||f.push({status:"retained",value:b[k]}));e.a.lb(h,A,10*n);return f.reverse()};e.a.Aa=function(a,
b,d){d="boolean"===typeof d?{dontLimitMoves:d}:d||{};a=a||[];b=b||[];return a.length<=b.length?va(a,b,"added","deleted",d):va(b,a,"deleted","added",d)};e.b("utils.compareArrays",e.a.Aa);var wa=function(b,d,c,g,f){var h=[],i=e.h(function(){var a=d(c,f,e.a.ea(h,b))||[];0<h.length&&(e.a.zb(h,a),g&&e.k.t(g,null,[c,a,f]));h.length=0;e.a.$(h,a)},null,{F:b,Da:function(){return!e.a.bb(h)}});return{S:h,h:i.ga()?i:a}},ra=e.a.f.L();e.a.Ta=function(b,d,c,g,f){function h(a,d){l=n[d];T!==d&&(fa[a]=l);l.Ia(T++);
e.a.ea(l.S,b);A.push(l);J.push(l)}function i(a,b){if(a)for(var d=0,c=b.length;d<c;d++)b[d]&&e.a.r(b[d].S,function(c){a(c,d,b[d].ka)})}for(var d=d||[],g=g||{},j=e.a.f.get(b,ra)===a,n=e.a.f.get(b,ra)||[],k=e.a.ya(n,function(a){return a.ka}),p=e.a.Aa(k,d,g.dontLimitMoves),A=[],I=0,T=0,m=[],J=[],d=[],fa=[],k=[],l,aa=0,xa,o;xa=p[aa];aa++)switch(o=xa.moved,xa.status){case "deleted":o===a&&(l=n[I],l.h&&l.h.D(),m.push.apply(m,e.a.ea(l.S,b)),g.beforeRemove&&(d[aa]=l,J.push(l)));I++;break;case "retained":h(aa,
I++);break;case "added":o!==a?h(aa,o):(l={ka:xa.value,Ia:e.m(T++)},A.push(l),J.push(l),j||(k[aa]=l))}i(g.beforeMove,fa);e.a.r(m,g.beforeRemove?e.M:e.removeNode);for(var aa=0,j=e.e.firstChild(b),q;l=J[aa];aa++){l.S||e.a.extend(l,wa(b,c,l.ka,f,l.Ia));for(I=0;p=l.S[I];j=p.nextSibling,q=p,I++)p!==j&&e.e.pb(b,p,q);!l.Yb&&f&&(f(l.ka,l.S,l.Ia),l.Yb=!0)}i(g.beforeRemove,d);i(g.afterMove,fa);i(g.afterAdd,k);e.a.f.set(b,ra,A)};e.b("utils.setDomNodeChildrenFromArrayMapping",e.a.Ta);e.K=function(){this.allowTemplateRewriting=
!1};e.K.prototype=new e.G;e.K.prototype.renderTemplateSource=function(a){var b=(9>e.a.oa?0:a.nodes)?a.nodes():null;if(b)return e.a.R(b.cloneNode(!0).childNodes);a=a.text();return e.a.Pa(a)};e.K.Ja=new e.K;e.Cb(e.K.Ja);e.b("nativeTemplateEngine",e.K)})})()})();var Nf=function(a,b,d){d=d||this;Pb.each(a||[],function(a,c){return b.call(d,c,a)});return this},Of=function(a,b,d,c){var f,c=c||this;Pb.isFunction(d)||(d=function(a){return a});Nf(b||[],function(b){f=a(f,b,d,c)});return f},lj=function(a,b,d,
c){return void 0===a||d.call(c,b)<d.call(c,a)?b:a},mj=function(a,b,d,c){return void 0===a||d.call(c,b)>d.call(c,a)?b:a},Pb=c.$,bb=c,Pf=Array.prototype.slice;bb.curry=function(a){var b=Pf.call(arguments,1);return function(){return a.apply(this,b.concat(Pf.call(arguments)))}};bb.bind=function(a,b){return Pb.proxy(b,a)};bb.each=Nf;bb.map=function(a,b,d){d=d||this;return Pb.map(a||[],function(a,c){return b.call(d,a,c)})};bb.filter=function(a,b,d){d=d||this;a=null===a||void 0===a?[]:a;return Array.prototype.filter&&
Array.prototype.filter===a.filter?a.filter(b,d):Pb.map(a,function(c,f){if(b.call(d,c,f,a))return c})};bb.first=function(a,b,d){var c,d=d||this;Pb.each(a||[],function(a,h){c=b.call(d,h,a)||void 0;c=!0===c?h:c;return!c});return c};bb.min=function(a,b,d){return Of(lj,a,b,d)};bb.max=function(a,b,d){return Of(mj,a,b,d)};var Qf=function(){},Rf=c,nj={}.hasOwnProperty,Sf=function(a,b){function d(){this.constructor=a}for(var c in b)nj.call(b,c)&&(a[c]=b[c]);d.prototype=b.prototype;a.prototype=new d;a.__super__=
b.prototype;return a};Rf.inherits=function(a,b){return Sf(b,a)};Qf.extend=function(a){return Sf(a,this)};Rf.Class=Qf;var Xd=function(){this.message="Property or method not implemented."},Tf=function(a){this.message=a||"Unexpected or incorrect value found."},Uf=function(a){this.message=a||"There was a problem with the gamify.js configuration; a value is missing or the configuration is malformed"},Vf=function(a){this.message=a||"There was a problem with the configuration of the economy"},Wc=c.error=
{};Xd.prototype=Error();Wc.NotImplemented=Xd;Xd.thrower=function(){var a=new this;this.apply(a,arguments);throw a;};Tf.prototype=Error();Wc.ValueError=Tf;Uf.prototype=Error();Wc.GamifyConfigurationError=Uf;Vf.prototype=Error();Wc.EconomyConfigurationError=Vf;var vb=function(a){a=a||{};this.data=a.data||{};this.request=a.request;this.response=a.response;this.endpoint=a.endpoint||c.app.current().spec.options.abby_normal_url;this.init()},Wf=c.$,oj=c.error||{};vb.prototype.init=function(){var a=c.app.current();
if(a&&(this._reported=!1,this.data.pub_id=a.spec.publisher_id,this.data.site_id=a.spec.site_id,this.data.orig_url=this.get_window_location(),a.auth&&a.auth.user&&(this.data.end_user_login=a.auth.user.end_user_login()),this.request&&(this.data.req_url=this.request.uri,this.request.pattern_signature||(this.request.pattern_signature=this.get_request_signature(this.request))),this.response))this.data.res_stat=this.response.code?this.response.status:"timeout"===this.response?"timeout":"none"};vb.prototype.get_request_signature=
function(a){if(a&&a.uri&&a.query)return(new c.transport.middleware.PatternMatchingMiddleware).get_request_signature(a)};vb.prototype.query_string=function(){return Wf.param(this.data)};vb.prototype.report=function(){if(!c._abnormal&&!this._reported){var a=this.endpoint+"?"+this.query_string();Wf(document.body).append('<img src="'+a+'" width="1" height="1" alt="">');this._reported=!0;c.trigger("abby_normal",this);c._abnormal=!0}c._abby_normals=c._abby_normals||[];c._abby_normals.push(this)};vb.prototype.matches_request_signature=
function(a){if(!a||!this.request.pattern_signature)return!1;a instanceof RegExp||(a=RegExp(a));return a.test(this.request.pattern_signature)};vb.prototype.get_window_location=function(){return window.location.href};oj.AbbyNormalError=vb;var Xf=c.$,ga=c.util={};c.device=c.device||{};ga.time_remaining=function(a){var b=ga.dates?ga.dates.now():new Date,a=Math.floor((a-b)/1E3),b=Math.floor(a/86400),a=a-86400*b,d=Math.floor(a/3600),a=a-3600*d,c=Math.floor(a/60);return[b,d,c,Math.floor(a-60*c)]};ga.time_since=
function(a){var a=(ga.dates?ga.dates.now():new Date)-a,a=Math.floor(a/1E3),b=Math.floor(a/86400),a=a-86400*b,d=Math.floor(a/3600),a=a-3600*d,c=Math.floor(a/60);return[b,d,c,Math.floor(a-60*c)]};var pj=[["day","days"],["hour","hours"],["minute","minutes"],["second","seconds"]];ga.format_duration=function(a,b,d){var c=[],f,h,b=b||1,d=d||pj;if(a)for(var i=0;i<a.length&&!(f=a[i],h=d[i][1==f?0:1],0<f&&c.push(f+" "+h),c.length>=b);i++);c.length||c.push(f+" "+h);return c.join(", ")};ga.date_to_user_string=
function(a){return c.util.dates.format(a,"%0m/%0d/%Y")};ga.add_dynamic_properties=function(a,b){a[b]&&c.each(a[b](),function(b){var g=c.first(b.attributes(),function(a){return c.first(a.attributes(),function(a){return"bdm-property"===a.friendly_id()})?a:void 0});g&&!a[g.friendly_id()]&&(a[g.friendly_id()]=b)})};ga.get_cookie_value=function(a){var b,d,c,f=document.cookie.split(";");for(b=0;b<f.length;b++)if(d=f[b].substr(0,f[b].indexOf("=")),c=f[b].substr(f[b].indexOf("=")+1),d=d.replace(/^\s+|\s+$/g,
""),d==a)return unescape(c)};ga.are_equal_objects=function(a,b){for(var d in a)if("undefined"==typeof b[d])return!1;for(d in a)if(a[d])switch(typeof a[d]){case "object":if(!a[d].equals(b[d]))return!1;break;case "function":if("undefined"==typeof b[d]||"equals"!=d&&a[d].toString()!=b[d].toString())return!1;break;default:if(a[d]!=b[d])return!1}else if(b[d])return!1;for(d in b)if("undefined"==typeof a[d])return!1;return!0};ga.wait_for=function(a){var b=c.app.current(),a=c.map(a,function(a){return c.is("String",
a)?c.util.walk(a,b):a});return Xf.when.apply(Xf,a)};var Yd="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");c.uuid=function(a,b){var d,c=0,f=[],b=b||Yd.length;if(a)for(;c<a;)f[c++]=Yd[0|Math.random()*b];else{f[8]=f[13]=f[18]=f[23]="-";for(f[14]="4";36>c;c++)f[c]||(d=0|16*Math.random(),f[c]=Yd[19==c?d&3|8:d])}return f.join("")};var Zd=function(a,b){var d=b[a];if(Xc.isFunction(d))try{d=d.call(b)}catch(c){d=void 0}return d},qj=function(a,b,d){return 1>d.length?{key:a,value:b[a],
context:b}:Zd(a,b,d)},rj=function(a,b,d){return 1>d.length?function(){Xc.isFunction(b[a])&&b[a].apply(b,arguments)}:Zd(a,b,d)},cb=function(a,b,d,c){"string"==Xc.type(a)&&(a=a.split("."));a=a||[];if(!b||1>a.length)return b;var d=Xc.isFunction(d)?d:Zd,f=a.shift(),h=b[f],h=d.call(c||this,f,b,a);return void 0===h||null===h||1>a.length?h:cb(a,h,d,c||this)},Xc=c.$,sj=c.util;cb.context=function(a,b){return cb(a,b,qj,this)};cb.callable=function(a,b){return cb(a,b,rj,this)};cb.observable=function(a,b){var d=
cb.context(a,b);return d?d.value:d};sj.walk=cb;c.util.string=function(a,b){return""+(a||b||"")};var $d=c.$,nc=c.ko,wb=c.util.convert={};wb.integer=function(a,b){a=b?a[b]:a;a=nc.utils.unwrapObservable(a);a=parseInt(a,10);return isNaN(a)?void 0:a};wb.real=function(a,b){a=b?a[b]:a;a=nc.utils.unwrapObservable(a);a=parseFloat(a,10);return isNaN(a)?void 0:a};wb.bool=function(a,b){a=b?a[b]:a;return!!nc.utils.unwrapObservable(a)};wb.timestamp=function(a,b){a=b?a[b]:a;a=nc.utils.unwrapObservable(a);if(a instanceof
Date)return a;a=parseInt(a,10);return isNaN(a)?void 0:new Date(1E3*a)};wb.value=function(a,b){a=b?a[b]:a;return a=nc.utils.unwrapObservable(a)};wb.encode_form=function(a,b){a=b?a[b]:a;return $d.param(a,!0)};var tj=/[^?&]+/gi,uj=/(.*)=(.*)/i;wb.decode_form=function(a,b){var a=b?a[b]:a,d,c,f={},h=(a||"").match(tj)||[];$d.each(h,function(a,b){if((d=b.match(uj))&&d[1])c=decodeURIComponent(d[1]),b=decodeURIComponent(d[2]),c.lastIndexOf("[]")==c.length-2?(c=c.slice(0,-2),f[c]=f[c]||[],f[c].push(b)):f[c]?
($d.isArray(f[c])||(f[c]=[f[c]]),f[c].push(b)):f[c]=b});return f};var Yf=function(a,b){this.opts=ae.extend({},this.defaults,b);this.collection=ae.isFunction(a)?a:xb.observable(a);this.page_size=ae.isFunction(this.opts.page_size)?this.opts.page_size:xb.observable(this.opts.page_size);this.page_count=xb.computed({read:function(){var a=this.collection().length||1;return Math.ceil(a/this.page_size())},owner:this,deferEvaluation:!0});this.opts.throttle&&(this.page_count=this.page_count.extend({throttle:this.opts.throttle}));
this._page_number=xb.observable(this.opts.page_number);this.page_number=xb.computed({read:function(){return Math.min(this._page_number(),this.page_count())},write:function(a){a=Math.max(1,+a);this._page_number(a)},owner:this,deferEvaluation:!0});this.pages=xb.computed({read:function(){for(var a=[],b=this.collection(),c=this.page_size(),h=this.page_count(),i=0,j=c,k=0;i<b.length||!a.length;){i={number:++k,items:b.slice(i,j),is_first:k==1,is_last:k==h,total:h,paginator:this};a.push(i);i=j;j=j+c}return a},
owner:this,deferEvaluation:!0});this.opts.throttle&&(this.pages=this.pages.extend({throttle:this.opts.throttle}));this.page=xb.computed({read:function(){var a=this.collection(),b=this.page_size(),c=this.page_count(),h=this.page_number(),i=b*(h-1);return{number:h,items:a.slice(i,i+b),is_first:h==1,is_last:h==c,total:c,paginator:this}},owner:this,deferEvaluation:!0});this.turn_next=function(){var a=this.page_number();a<this.page_count()?this.page_number(a+1):this.opts.loop&&a!=1&&this.page_number(1)}.bind(this);
this.turn_previous=function(){var a=this.page_number(),b=this.page_count();a>1?this.page_number(a-1):this.opts.loop&&a!=b&&this.page_number(b)}.bind(this)},ae=c.$,xb=c.ko,vj=c.util;Yf.prototype.defaults={page_size:5,loop:!1,page_number:1,throttle:0};vj.Paginator=Yf;var Zf=function(a){if(a){a=c.url.parse_params(a);if(a.bd_ref)return a.bd_ref;if(a.fb_ref&&(a=/BDM:([^&]*)/.exec(a.fb_ref)))return a[1].replace(":AT:","@")}},$f=function(a,b){return c.awesome.add_param_to_url(a,"bd_ref",b)},ag=function(a){var b=
Yc.decode_form(a);-1!==a.indexOf("?")&&(a=a.slice(0,a.indexOf("?")));delete b.bd_ref;var d=/^BDM:/;b.fb_ref&&b.fb_ref.match(d)&&(delete b.fb_ref,delete b.fb_source);return be.isEmptyObject(b)?a:a+"?"+Yc.encode_form(b)},bg=function(a){if(!a)return"must be called with a url to prep";var b=c.app.current();if(!b||!b.auth)return"prep_url_for_sharing called before BDM app finished loading";a=ag(a);b.auth.is_anonymous()||(a=$f(a,b.auth.user.end_user_login()));return a},be=c.$,Yc=c.util.convert,oa=c.awesome=
{};oa.config={api_key:"f9cad3e815e9dd01d21c1b080295d85ea75eefaf7dd571b9723670f4b84dd070",api_tool_key:"1rnB77"};oa.referrer_found=function(a){var b=Zf(a),d,g=c.app.current();g.spec.providers.referrals&&g.spec.providers.referrals.ref_site&&(d=c.url.get_param(g.spec.providers.referrals.ref_site,a));return!!b||!!d};oa.get_referrer=Zf;oa.get_param_value_from_url=function(a,b){if(a)return c.url.get_param(b,a)||void 0};oa.add_referral_to_url=$f;oa.add_campaign_to_url=function(a,b){return c.awesome.add_param_to_url(a,
"bd_ref_campaign",b)};oa.add_param_to_url=function(a,b,d){var c=Yc.decode_form(a);-1!==a.indexOf("?")&&(a=a.slice(0,a.indexOf("?")));c[b]=d;a.indexOf(".com")==a.length-4&&(a+="/");return a+"?"+Yc.encode_form(c)};oa.sanitize_referral_url=ag;oa.shorten_url_for_end_user=function(a,b,d){if(!a||!b)return"must be called with a url and a callback";var g=c.app.current();if(!g||!g.auth)return"short_url_for_end_user called before BDM app finished loading";a=bg(a);be.ajax({url:"http://api.awe.sm/url.json?v=3",
data:{key:this.config.api_key,url:a,channel:"socialnetwork",tool:this.config.api_tool_key,domain:g.options.shortener_domain||"big.do"},dataType:"jsonp",context:this,success:function(c,g){"success"===g?b.call(d||this,c.awesm_url):b.call(d||this,a)}})};oa.prep_url_for_sharing=bg;oa.build_api_url=function(a,b,d,g,f,h){if(null==a||""===a)a=location.href;g=c.app.current().options.shortener_domain||"big.do";a=encodeURIComponent(a);a="http://api.awe.sm/url/share?v=2&key="+this.config.api_key+"&url="+a+"&tool="+
this.config.api_tool_key+"&channel="+b+"&campaign="+h+"&domain="+g+"&destination="+encodeURIComponent(d);(b=c.url.params.awesm)&&(a+="&parent="+encodeURIComponent(b));return a};oa.open_window=function(a,b,d,c){if("facebook-post"===b){var f=be("<iframe />").attr({id:"bd-minibar-load",width:0,height:0,frameborder:0,src:a}).load(function(){c()}).appendTo("body");setTimeout(function(){f.remove()},1E4)}else window.open(a,"_blank",d)};oa.shorten_url=function(a,b,d,c,f,h,i,j){a=this.build_api_url(a,b,d,
c,f,h);this.open_window(a,b,i,j)};var yb=function(a){a=a||{};this.app_id=a.app_id;this.xfbml="xfbml"in a?a.xfbml:yb.xfbml;this.channel=a.channel;window.FB&&!("FB"in this)&&(this.FB=window.FB)},Zc=c.$,wj=c.util;yb.defaults={xfbml:!0};yb.prototype.init=function(a,b){this.promise||(this.promise=Zc.Deferred(),this.load());a&&(b=b||this,this.promise.then(function(d){a.call(b,d)}))};yb.prototype.load=function(){this.FB||window.FB&&window.FB.XFBML?(this.FB=this.FB||window.FB,this.promise.resolve(this.FB)):
(1>Zc("#fb-root").length&&Zc('<div id="fb-root"></div>').appendTo(document.body),this.get_facebook_library())};yb.prototype.get_facebook_library=function(){return Zc.ajax({url:"//connect.facebook.net/en_US/all.js#xfbml=1",dataType:"script",cache:!0,context:this,success:this.on_load})};yb.prototype.on_load=function(){if(window.FB){this.FB=window.FB;var a={xfbml:!!this.xfbml};this.app_id&&(a.appId=this.app_id);this.channel&&(a.channelUrl=this.channel);this.FB.init&&this.FB.init(a)}this.promise.resolve(this.FB)};
wj.Facebook=yb;var db=function(a,b,d){this.interval=a||1E3;this.end_date=b?new Date(b):void 0;this.tick_callback=d;this.is_started=!1;cg(document).bind("bigdoor.timer.tick",d)},cg=c.$,xj=c.util;db.prototype.start=function(){if(this.is_started||this.interval_id)throw"Already started.";this.interval_id=setInterval(cg.proxy(this.ontick,this),this.interval);this.is_started=!0;this.started_date=new Date;c.trigger("timer.start",this)};db.prototype.stop=function(){if(!this.is_started)throw"Not yet started.";
clearInterval(this.interval_id);this.interval_id=void 0;this.is_started=!1};db.prototype.restart=function(a){this.interval=a;this.is_started&&this.stop();db.call(this,a,this.end_date,this.tick_callback);this.start()};db.prototype.remaining_time=function(){if(!this.end_date)return Infinity;var a=this.end_date-new Date;return 0<a?a:0};db.prototype.elapsed_time=function(){return this.is_started?new Date-this.started_date:0};db.prototype.ontick=function(){c.trigger("timer.tick");this.end_date&&this.end_date<
new Date&&this.stop()};xj.Timer=db;var $c=function(a){return!a||"document"===a?document:"window"===a?window:a},wa=function(a,b,d){"string"==ba.type(a)&&(a=wa.parse(a));var a=a||{},g=c.app.current()&&c.app.current().providers&&c.app.current().providers.economycache||{};this.context={selector:eb(a.selector),live:eb(a.live),bind:eb(a.bind),unbind:eb(a.unbind),triggered:eb(a.triggered),untriggered:eb(a.untriggered),event:eb(a.event),hint:eb(a.hint),context:d||a.context,handler:b||a.handler,ntg_id:a.ntg_id,
args:a.args,strict:!!a.strict,auto:"auto"in a?!!a.auto:!0,redemption_curr_adj:a.redemption_curr_adj||g.default_redemption_curr_adj,level_curr_adj:a.level_curr_adj||g.default_level_curr_adj};this.is_bound=!1;this.handler=wa.handler(this.handler,this)},ba=c.$,yj=c.each,eb=c.util.string,Qb=c.util.walk;c.util.Listener=c.Class.extend(wa);wa.parse=function(a){if("string"==ba.type(a)&&a){if("{"===a[0]&&"}"==a[a.length-1])return c.$.parseJSON(a);var b,a=a.split(",");yj(a,function(a){var c;a&&(a=a.split(":"),
c=a[0]&&a[0].replace(/^\s+[{]?|\s+$/g,""),a=a[1]&&a[1].replace(/^\s+|[}]?\s+$/g,""),c&&a&&(b=b||{},b[c]=a))});return b}};wa.handler=function(a,b){return function(){var d=Array.prototype.slice.call(arguments);d.unshift(this);this._triggered=!0;a.apply(b||this,d)}};wa.prototype.handler=function(a){var b=this.context.args||Array.prototype.slice.call(arguments,1);this.transact(function(){var d=this.resolve(a);d&&ba.isFunction(d.callback)&&d.callback.apply(d.context||this,b)},this);return this};wa.prototype.resolve=
function(a){if(this.context.handler){var b={callback:this.context.handler,context:this.context.context};"string"===ba.type(this.context.context)&&(b.context=Qb(this.context.context,window));if("string"===ba.type(this.context.handler)){var d=Qb.context(this.context.handler,window);if(!d||!ba.isFunction(d.value))return;b.callback=d.value;b.context=b.context||d.context||a}b.context=b.context||a;return b}};wa.prototype.transact=function(a,b){var d=c.app.current();if(this.context.ntg_id&&d&&d.auth&&d.auth.user)if(d.providers&&
d.providers.economycache&&d.auth.is_anonymous()){var g={redemption_curr_adj:this.context.redemption_curr_adj,level_curr_adj:this.context.level_curr_adj},f=ba.proxy(function(d){c.trigger("currency.earned",[d,"custom",this.context]);ba.isFunction(a)&&a.call(b||this,d)},this);d.providers.economycache.transact(this.context.ntg_id,g,f)}else d.auth.user.transact(this.context.ntg_id,function(d,g,f){c.trigger("currency.earned",[d,"custom",this.context]);if("success"===g||!0!==this.context.strict)ba.isFunction(a)&&
a.apply(b||this,arguments)},this);else ba.isFunction(a)&&a.apply(b||this,arguments);return this};wa.prototype.bind=function(){if(!this.is_bound){delete this._triggered;if(this.context.live)ba($c(this.context.live)).live(this.context.event,this.handler),this.is_bound=!0;else if(this.context.selector)ba($c(this.context.selector)).bind(this.context.event,this.handler),this.is_bound=!0;else if(this.context.bind){var a=function(){var a=Qb.callable(this.context.bind,window);a&&(a(this.context.event,this.handler),
this.is_bound=!0);return this.is_bound};if(!a.call(this)&&-1!==this.context.bind.indexOf("FB")){var b=c.app.current();b&&b.facebook&&b.facebook.init(a,this)}}this.is_bound&&(this.context.auto&&this.triggered())&&this.handler()}return this};wa.prototype.unbind=function(){if(this.is_bound)if(this.context.live)ba($c(this.context.live)).die(this.context.event,this.handler),this.is_bound=!1;else if(this.context.selector)ba($c(this.context.selector)).unbind(this.context.event,this.handler),this.is_bound=
!1;else if(this.context.unbind){var a=Qb.callable(this.context.unbind,window);a&&(a(this.context.event,this.handler),this.is_bound=!1)}return this};wa.prototype.triggered=function(){"_triggered"in this||(this._triggered=!1,this.context.triggered&&Qb(this.context.triggered,window)?this._triggered=!0:this.context.untriggered&&!Qb(this.context.untriggered,window)&&(this._triggered=!0));return!!this._triggered};c.log=function(){window.console&&"function"===typeof window.console.log&&window.console.log.apply(window.console,
arguments)};var x=function(a){if(!a)throw new zj("Application must be passed to BucketManager");this.app=a;this.bucket_config=ad.extend(!0,{},Aj,this.app.spec&&this.app.spec.bucket||{});Rb.get_bucket=oc(this,this.get_bucket);Rb.is_in_disregard_bucket=oc(this,this.is_in_disregard_bucket);Rb.is_in_control_bucket=oc(this,this.is_in_control_bucket);Rb.is_in_exposed_bucket=oc(this,this.is_in_exposed_bucket);Rb.is_in_opted_out_bucket=oc(this,this.is_in_opted_out_bucket);c.subscribe("bucket.opt_out_intent_click",
ad.proxy(this.on_opt_out_intent_click_event,this))},ad=c.$,oc=c.bind,Bj=c.awesome,zj=c.error.ValueError,Rb=c.bucket=c.bucket||{};Rb.BucketManager=x;var Aj={disregard:{cookie_length:7,probability:0},control:{cookie_length:1825,probability:0},exposed:{cookie_length:1825,probability:100},opted_out:{cookie_length:1825},remote_storage_enabled:!1,use_server_profile_for_authenticated_users:!1,vary:""};x.prototype.get_bucket=function(){return this._current_bucket};x.prototype.is_in_disregard_bucket=function(){return"disregard"===
this.get_bucket()};x.prototype.is_in_control_bucket=function(){return"control"===this.get_bucket()};x.prototype.is_in_exposed_bucket=function(){return"exposed"===this.get_bucket()};x.prototype.is_in_opted_out_bucket=function(){return"opted_out"===this.get_bucket()};x.prototype.is_bucket_debug_mode=function(){return this.bucket_config.debug};x.prototype.is_remote_storage_bucket_enabled=function(){return this.bucket_config.remote_storage_enabled};x.prototype.is_anonymous=function(){return this.app.auth.is_anonymous()};
x.prototype.is_api_profile_buckets_enabled=function(){return this.bucket_config.use_server_profile_for_authenticated_users};x.prototype.get_cookie=function(a){a=a||{};if(!a.domain){for(var b=document.domain.split(".");2<b.length;)b.shift();ad.extend(a,{domain:"."+b.join(".")})}return new c.session.cookie.StateCookie("bd-bucket",a)};x.prototype.update_debug_copy_of_remote_bucket=function(a,b){c.remote_storage.get_string("bd-bucket",function(d,c){window.localStorage.setItem("bd-bucket-debug",c);a&&
a.call(b||this,c)},this)};x.prototype.is_valid_bucket_name=function(a){return-1!==ad.inArray(a,["control","exposed","disregard","opted_out"])};x.prototype.is_vary_diff_than_config=function(a){var b=this.bucket_config;return(a||"")!==b.vary};x.prototype.is_timestamp_expired=function(a){return c.storage.current_time_in_minutes()>=+a};x.prototype.is_disregard_set_to_zero=function(){return 0===this.bucket_config.disregard.probability};x.prototype.is_opt_in_transition=function(a,b){return"opted_out"===
a&&"exposed"===b};x.prototype.is_opt_out_transition=function(a,b){return"opted_out"!==a&&"opted_out"===b};x.prototype.detect_recruitment_override=function(){return Bj.referrer_found(c.url.current)?"exposed":void 0};x.prototype.detect_url_pattern_override=function(){var a=c.url.current;return c.first(this.bucket_config.override_rules||[],function(b){return a.match(RegExp(b))})?"exposed":void 0};x.prototype.detect_manual_bucket_override=function(){var a=c.url.params.bd_bucket,a=a?a.toLowerCase():"";
return this.is_valid_bucket_name(a)?a:void 0};x.prototype.detect_cohort_override=function(){return c.url.params.bd_cohort?"exposed":void 0};x.prototype.detect_queued_bucket_override=function(){return(c.storage.get_storage("queued-bucket","bucket")||{}).bucket};x.prototype.clear_queued_bucket_override=function(){c.storage.destroy_storage("queued-bucket","bucket")};x.prototype.on_opt_out_intent_click_event=function(){this.queue_bucket_transition("opted_out")};x.prototype.queue_bucket_transition=function(a){this.is_valid_bucket_name(a)&&
(a={bucket:a.toLowerCase()},c.storage.set_storage("queued-bucket",a,-1,"bucket"))};x.prototype._get_bucket_data_from_api_storage=function(a,b){var d=this.app.sessions.remote.read()||{},d={bucket:d.bucket,expiration:d.bucket_expires,vary:d.bucket_vary};a&&a.call(b||this,d)};x.prototype._get_bucket_data_from_browser_storage=function(a,b){if(this.is_remote_storage_bucket_enabled())c.remote_storage.get_string("bd-bucket",function(d,g){var f;if(g){if(f=c.JSON.parse(g),!f.data||!f.data.bucket)f.data={bucket:f.data,
vary:""}}else f={data:{}};f={bucket:f.data.bucket,expiration:f._EXPIRES,vary:f.data.vary};a&&a.call(b||this,f)},this);else{var d=this.get_cookie(),g=d.read("bucket"),f=d.read("expiration"),d=d.read("vary"),g={bucket:g,expiration:f,vary:d};a&&a.call(b||this,g)}};x.prototype.update_bucket_state=function(a,b,d,g,f){var h=function(h){var h=this.identify_current_bucket(a,b,d,h),j=h.bucket,k=h.transition;this._current_bucket=j;(this._last_transition=k)?this.set_bucket(j,function(){c.trigger("bucket.transition",
k);g.call(f||this,j)}):this.is_bucket_debug_mode()?this.update_debug_copy_of_remote_bucket(function(){g.call(f||this,j)}):g.call(f||this,j)};!a&&!this.is_anonymous()&&this.is_api_profile_buckets_enabled()?this._get_bucket_data_from_browser_storage(function(a){a=a||{};a.bucket?(a=this.identify_current_bucket(a.bucket,a.expiration,a.vary),!a.transition&&a.bucket?h.call(this,a.bucket):h.call(this),this.is_remote_storage_bucket_enabled()?c.remote_storage.destroy("bd-bucket"):this.get_cookie().remove()):
h.call(this)},this):h.call(this)};x.prototype.identify_current_bucket=function(a,b,d,c){var f=a=this.is_valid_bucket_name(a)&&a,h=!1,i,c=this.is_valid_bucket_name(c)&&c;if(!i&&(h=this.detect_recruitment_override())&&a!==h)i="recruitment",a=h;if(!i&&(h=this.detect_url_pattern_override())&&a!==h)i="url-pattern",a=h;h=this.detect_queued_bucket_override();!i&&h&&(this.clear_queued_bucket_override(),i="override-queued",a=h);if(!i&&(h=this.detect_manual_bucket_override())&&a!==h)i="override",a=h,this._bucket_override=
{old_bucket:f,new_bucket:h};if(!i&&(h=this.detect_cohort_override())&&a!==h)i="cohort",a=h;if("override"===i||"override-queued"===i)this.is_opt_in_transition(f,a)?i="opt-in":this.is_opt_out_transition(f,a)&&(i="opt-out");!i&&"disregard"===a&&this.is_disregard_set_to_zero()&&(i="launch-mode",a=void 0);!i&&a&&this.is_vary_diff_than_config(d)&&(i="namespace",a=void 0);!i&&(a&&b)&&this.is_timestamp_expired(b)&&(i="expiration",a=void 0);!i&&(!a&&c&&!this.app.auth.is_anonymous()&&this.is_api_profile_buckets_enabled())&&
(i="new-converted",a=c,"opted_out"===a&&(i="new-rejected",a=void 0));a||(i=i||"new",a=this.generate_new_bucket_name());return{bucket:a,transition:i}};x.prototype.set_bucket=function(a,b,d){if(this.is_valid_bucket_name(a)){var g=this,f=this.bucket_config,h=1440*f[a].cookie_length,i;this._current_bucket=a;!this.is_anonymous()&&this.is_api_profile_buckets_enabled()?(i={bucket:a,bucket_vary:f.vary,bucket_expires:c.storage.current_time_in_minutes()+h},this.app.sessions.remote.write(i,b,d)):this.is_remote_storage_bucket_enabled()?
(i={bucket:a,vary:f.vary},c.remote_storage.set("bd-bucket",i,h,function(){g.is_bucket_debug_mode()?g.update_debug_copy_of_remote_bucket(function(){b&&b.call(d||g)},g):b&&b.call(d||g)})):(i={bucket:a,vary:f.vary},this.get_cookie({expires:f[a].cookie_length}).write(i,b,d))}else c.warn("aborting: trying to save an invalid bucket type: "+a)};x.prototype.generate_new_bucket_name=function(){var a=this.bucket_config,b=[a.disregard.probability,a.control.probability,a.exposed.probability],a=[],d,c=0;for(d=
0;d<b.length-1;d++)c+=b[d]/100,a[d]=c;b=Math.random();for(d=0;d<a.length&&b>=a[d];d++);return["disregard","control","exposed"][d]};var ce=function(){return new c.session.cookie.StateCookie("bd-test",{domain:c.app.current().sessions.local.domain})},de=c.testmode=c.testmode||{};de.is_in_test_mode=function(){var a="true"===ce().read("testmode");a&&(document.title="BDM TESTMODE - "+document.title);return a};de.get_cookie=ce;de.update_test_mode_state=function(){var a=c.url.params.bd_test,b=window.parent&&
window.parent!==window&&window.parent.location.href,b=b&&c.url.get_param("bd_test",b),d=ce(),g=d.had_previous_value;if(a||b)g||d.write({testmode:"true"})};var bd=function(){return Math.floor((new Date).getTime()/6E4)},Sb=function(a,b){a=a||"";if(b=b||"")b.lastIndexOf("-")!==b.length-1&&(b+="-"),a=b+a;0!==a.indexOf("bd-")&&(a="bd-"+a);return a},dg=function(a){var b,d=ee(a),c;for(b in d)a=d[b],c=window.localStorage.getItem(a),fe(a,c)},ge=function(a){return void 0!==a._EXPIRES?bd()>=a._EXPIRES:!1},fe=
function(a,b){"object"===typeof b&&null!==b&&ge(b)&&(window.localStorage.removeItem(a),b=null);return b},he=function(a,b){var d=Sb(a,b),g=window.localStorage.getItem(d);g&&(g=c.JSON.parse(g),g=fe(d,g));return g},ee=function(a){for(var a=Sb("",a||""),b=[],d=window.localStorage.length-1;0<=d;--d){var c=window.localStorage.key(d);0===c.indexOf(a)&&b.push(c)}return b},eg=function(a){return c.filter(ee(a),function(a){return-1!==window.localStorage.getItem(a).indexOf("_EXPIRES")}).sort(function(a,d){return he(d)._EXPIRES-
he(a)._EXPIRES})},pa=function(a){a=a||{};this.origin=a.origin;this.path=a.path;this._iframe=a.iframe||null;this._is_iframe_ready=!1;this._message_queue=[];this._message_requests={};this._id=0},ha=c.storage=c.storage||{},zb=c.$;ha.current_time_in_minutes=bd;ha.normalize_keyname=Sb;ha.cleanup_expired_items=dg;ha.is_cache_obj_expired=ge;ha._validate_cached_object=fe;ha.get_storage=he;ha.set_storage=function(a,b,d,g){a=Sb(a,g);b=b||{};d=c.util.convert.integer(d);if("number"===typeof d&&-1<d){if(0===d)return window.localStorage.removeItem(a),
!1;b._EXPIRES=bd()+d}b=c.JSON.stringify(b);dg();try{return window.localStorage.setItem(a,b),!0}catch(f){if(("QUOTA_EXCEEDED_ERR"===f.name||"NS_ERROR_DOM_QUOTA_REACHED"===f.name)&&g&&b.length){d=window.localStorage.length;for(g=eg(g);g.length&&0<d;)d=g.shift(),window.localStorage.removeItem(d),d=window.localStorage.length;try{return window.localStorage.setItem(a,b),!0}catch(h){}}return!1}};ha.destroy_storage=function(a,b){window.localStorage.removeItem(Sb(a,b))};ha.clear_storage=function(a){for(var a=
Sb("",a||""),b=window.localStorage.length-1;0<=b;--b){var d=window.localStorage.key(b);0===d.indexOf(a)&&window.localStorage.removeItem(d)}};ha.get_key_list=ee;ha.get_keys_soon_to_expire=eg;ha.throttle=function(a,b,d,g){var b=b||3600,d=d||1,f=c.storage.get_storage(a),g=g||"",h=(new Date).getTime(),i=!1;f||(f={});if(!f.first||f.vary!==g||(h-f.first)/1E3>b)f.vary=g,f.first=h,f.count=0;f.count<d&&(h-f.first)/1E3<=b&&(f.last=h,f.count+=1,c.storage.set_storage(a,f),i=!0);return i};pa.prototype.init=function(){if(window.postMessage&&
c.JSON&&window.localStorage){var a=this,b=this._iframe;zb(window).on("message",function(b){a._on_message(b.originalEvent)});b&&(null!=b.nodeType?this._iframe_loaded():b.then?b.then(function(b){a._iframe=b;a._iframe_loaded()}):b=null);b||(b=this._iframe=document.createElement("iframe"),zb(b).on("load",function(){a._iframe_loaded()}).attr({style:"position:absolute;width:1px;height:1px;left:-9999px;",src:this.origin+this.path}),document.body?document.body.appendChild(b):zb(document).ready(function(){document.body.appendChild(b)}))}};
pa.prototype.get=function(a,b){var d={cmd:"get",key:this.normalize_cache_key(a),id:++this._id};this._process_message(d,b)};pa.prototype.get_string=function(a,b){var d={cmd:"get",key:this.normalize_cache_key(a),id:++this._id,string_only:!0};this._process_message(d,b)};pa.prototype.set=function(a,b,d,g){"function"===typeof d&&(g=d,d=null);if(!b._EXPIRES||!b.data)d&&(b={_EXPIRES:bd()+d,data:b});a={cmd:"set",key:this.normalize_cache_key(a),id:++this._id,value:c.JSON.stringify(b)};a.data=a.value;this._process_message(a,
g)};pa.prototype.destroy=function(a,b){var d={cmd:"delete",key:this.normalize_cache_key(a),id:++this._id};this._process_message(d,b)};pa.prototype.normalize_cache_key=function(a){var b=c.load.options.config.publisher_id+"-",a=a||"";0!==a.indexOf(b)&&(a=b+a);return a};pa.prototype._process_message=function(a,b){var d={request:a,callback:b};this._is_iframe_ready?this._send_message(d):this._message_queue.push(d);this._iframe||this.init()};pa.prototype._send_message=function(a){this._message_requests[a.request.id]=
a;this._iframe.contentWindow.postMessage(c.JSON.stringify(a.request),this.origin)};pa.prototype._iframe_loaded=function(){this._is_iframe_ready=!0;if(this._message_queue.length){for(var a=0,b=this._message_queue.length;a<b;a++)this._send_message(this._message_queue[a]);this._message_queue=[]}};pa.prototype._on_message=function(a){if(a.origin==this.origin){var b,d=c.JSON.parse(a.data),g=d.key,f;if(d.string_only)f=d.value;else try{f=c.JSON.parse(d.value)}catch(h){f=d.value}if("object"===typeof f&&null!==
f){b=f&&f._EXPIRES;if(ge(f)){this.destroy(g,zb.proxy(function(){this._message_requests[d.id].callback(g,null);delete this._message_requests[d.id]},this));return}f._EXPIRES&&f.data&&(f=f.data)}this._message_requests[d.id].callback&&this._message_requests[d.id].callback(g,f,b);delete this._message_requests[d.id]}};pa.prototype.throttle=function(a,b,d,c,f){var h=b||3600,i=d||1,j=c||"",k=(new Date).getTime(),T=!1,l=zb.proxy(function(b){b||(b={});if(!b.first||b.vary!==j||(k-b.first)/1E3>h)b.vary=j,b.first=
k,b.count=0;b.count<i&&(k-b.first)/1E3<=h&&(b.last=k,b.count+=1,this.set(a,b),T=!0);zb.isFunction(f)&&f.call(this,T)},this);this.get(a,zb.proxy(function(a,b){l(b)},this))};ha.RemoteStorage=pa;var ia=function(a){this.unmodified_spec=a||{};this.abtest_opts=this.unmodified_spec.abtest||{};this.names_of_all_variants=Cj(this.abtest_opts.variants||{},function(a,d){return d.replace(" ","-")});this.is_abtesting_enabled=1<this.names_of_all_variants.length;this.num_days_per_abtest=this.abtest_opts.num_days_per_abtest||
1825;this.cache_name=this.abtest_opts.cache_name||"bd-abtest";this.storage_cache=void 0;this.test_name=(this.abtest_opts.test_name||"unknowntest").replace(" ","-");this.current_variant=void 0},ja=c.$,Cj=c.map,Dj=c.async;(c.util||{}).ABTest=ia;ia.prototype.init=function(a,b){var d=this;Dj.waterfall([function(a){d._setup_storage_cache(function(){a.call(this,null)},d)},function(a){d.is_abtesting_enabled?d.get_variant_record(function(b){a.call(this,null,b)},d):a.call(d,"disabled",d.unmodified_spec)},
function(a,b){d._setup_or_restore_variant(a,function(a){b.call(this,null,a)},d)}],ja.proxy(function(d,c){ja.isFunction(a)&&a.call(b||this,c||this.unmodified_spec)},d))};ia.prototype._setup_storage_cache=function(a,b){var d;d=document.domain.split(".");for(var g=c.session.remote_storage.CrossDomainState,f=c.session.cookie.StateCookie;2<d.length;)d.shift();d={domain:"."+d.join("."),expires:this.num_days_per_abtest};this.abtest_opts.is_remote_storage_enabled?this.storage_cache=new g(this.cache_name,
d,function(){ja.isFunction(a)&&a.call(b||this,null)},this):(this.storage_cache=new f(this.cache_name,d),ja.isFunction(a)&&a.call(b||this,null))};ia.prototype._setup_or_restore_variant=function(a,b,d){var c,f;this.is_valid_variant(a)&&(this.current_variant=a);c=this.get_variant_override();this.is_valid_variant(c)&&(this.current_variant=c);this.current_variant||(this.current_variant=this.pick_new_variant());f=this.current_variant?this.get_updated_spec():this.unmodified_spec;this.current_variant!==a?
this.set_variant_record(this.current_variant,function(){ja.isFunction(b)&&b.call(d||this,f)},this):ja.isFunction(b)&&b.call(d||this,f)};ia.prototype.get_abtest_name_for_events=function(){return this.test_name+"."+this.current_variant};ia.prototype.get_updated_spec=function(){var a=this.get_spec_for_single_variant(this.current_variant);return ja.extend(!0,{},this.unmodified_spec,a||{})};ia.prototype.get_variant_override=function(){return c.url.params.bd_abvariant};ia.prototype.is_valid_variant=function(a){return-1!==
ja.inArray(a,this.names_of_all_variants)};ia.prototype.set_variant_record=function(a,b,d){this.is_valid_variant(a)&&this.storage_cache.write({variant:a});ja.isFunction(b)&&b.call(d||this,a)};ia.prototype.get_variant_record=function(a,b){var d=this.storage_cache.read("variant");d&&!this.is_valid_variant(d)&&(this.clear_variant_record(),d=void 0);ja.isFunction(a)&&a.call(b||this,d)};ia.prototype.clear_variant_record=function(a,b){this.storage_cache.remove();ja.isFunction(a)&&a.call(b||this)};ia.prototype.pick_new_variant=
function(){var a=this.names_of_all_variants;return a[Math.floor(Math.random()*a.length)]};ia.prototype.get_spec_for_single_variant=function(a){if((a=this.abtest_opts.variants&&this.abtest_opts.variants[a])&&a.bucket)a=ja.extend(!0,{},a),delete a.bucket;return a};var pc=c.util.dates=c.util.dates||{};pc.default_strings={months:"January February March April May June July August September October November December".split(" "),short_months:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),
short_days:"Sun Mon Tue Wed Thu Fri Sat".split(" ")};pc.now=function(){return window._BDTIMESTAMP||new Date};pc.date_to_user_string=c.util.date_to_user_string;pc.format=function(a,b){var d=c.app.current(),g=d?d.vars.dates:pc.default_strings,d=(a.getMonth()+1).toString(),f=g.months[a.getMonth()],h=g.short_months[a.getMonth()],i=a.getDate().toString(),j=g.days[a.getDay()],g=g.short_days[a.getDay()],k=a.getFullYear().toString(),l=k.substr(2,2),m=a.getHours().toString(),e=(a.getHours()%12||12).toString(),
n=a.getMinutes().toString(),A=a.getSeconds().toString(),fa=12>a.getHours()?"am":"pm",o={a:g,A:j,b:h,B:f,d:i,H:m,l:e,m:d,M:n,p:fa,S:A,y:l,Y:k};return b.replace(/%(0)?(.)/g,function(a,b,d){a=d;d in o&&(a=o[d],b&&10>a&&(a=b+a));return a})};var Ma=function(a){this._text=a=a.replace(/^(\s*<script[^>]*>\s*)/,"").replace(/(\s*<\/script>\s*)$/,"");this._data={}},qc=function(a){this.app=a;this.allowTemplateRewriting=!1},fg=c.$,fb=c.ko;fb.extenders.lazy=function(a,b){var d=b.load;"string"==typeof d&&(d=function(){return this[b.load]()});
return fb.computed({read:function(){d.call(this);return a()},write:function(b){a(b)},owner:b.context,deferEvaluation:!0})};fb.observable.fn.when=fb.computed.fn.when=function(a,b,d){var d=d||this,c=this.peek();if(c===a)b.call(d,c);else{var f=this.subscribe(function(c){c===a&&(f.dispose(),b.call(d,c))});return f}};fb.observable.fn.whenever=fb.computed.fn.whenever=function(a,b,d){function c(g){f=!0;g===a&&b.call(d,g)}var d=d||this,f=!1,h=this.subscribe(c);f||c(this.peek());return h};var gg=function(a,
b){var d,c;try{d=new Function("$context","with ($context) { with ($data || {}) { return ("+b+"); } }"),c=d.call(a,a)}catch(f){}return fb.utils.unwrapObservable(c)};Ma.prototype._variableRegex=/\$\{\s*([^}]+)\s*\}/g;Ma.prototype._htmlRegex=/\{\{\s*html\s+([^}]+)\s*\}\}/g;Ma.prototype.text=function(a){arguments.length&&(this._text=a);return this._text};Ma.prototype.data=function(a,b){1<arguments.length&&(this._data[a]=b);return this._data[a]};var Ej=fg(document.createElement("div"));Ma.prototype.render=
function(a){var b=this.text();b&&(b=b.replace(this._htmlRegex,function(b,c){return""+gg(a,c)}),b=b.replace(this._variableRegex,function(b,c){var f=gg(a,c);return null==f?"":Ej.text(""+f).html()}),this.text(b));return this.text()};var ie=fb.nativeTemplateEngine;qc.prototype=new ie;qc.prototype.extendContext=function(a){var a=a.constructor.prototype,b=this.app;b&&!a.$app&&(a.$=fg,a.$app=b,a.$user=b.auth&&b.auth.user,a.$vars=b.spec.vars,a.$coins=b.spec.vars.primary_currency_name,a.$xp=b.spec.vars.primary_level_currency_name,
a.$quest=b.spec.vars.named_level_collection,a.$checkpoint=b.spec.vars.named_level)};qc.prototype.makeTemplateSource=function(a){if("string"===typeof a){var b=this.app.spec.media.templates[a];if(null!=b)return new Ma(b);throw Error("Template not found: "+a);}return a instanceof Ma?a:ie.prototype.makeTemplateSource.apply(this,arguments)};qc.prototype.renderTemplateSource=function(a,b,d){this.extendContext(b);a instanceof Ma&&a.render(b);return ie.prototype.renderTemplateSource.apply(this,arguments)};
c.Template=Ma;c.TemplateEngine=qc;var Tb=c.$,cd=c.ko;Tb.each(["alt","href","id"],function(a,b){cd.bindingHandlers[b]={update:function(a,c,f,h){c=cd.utils.unwrapObservable(c());Tb.isFunction(c)&&(c=c.call(h));Tb(a).attr(b,c)}}});cd.bindingHandlers.src={init:function(a){a=Tb(a);a.data("src.default",a.attr("src"))},update:function(a,b,d,c){a=Tb(a);b=cd.utils.unwrapObservable(b());Tb.isFunction(b)&&(b=b.call(c));"null"===b&&(b=null);a.attr("src",b?b:a.data("src.default"))}};var X=c.$,z=c.ko;z.bindingHandlers.hidden=
{update:function(a,b){var d=z.utils.unwrapObservable(b());X(a).css({visibility:d?"hidden":"visible"})}};z.bindingHandlers.fadeVisible=z.bindingHandlers.visible;z.bindingHandlers.animate={init:function(a,b){var d=z.utils.unwrapObservable(b()),c={duration:0};d.step&&(c.step=d.step,delete d.step);X(a).animate(d,c)},update:function(a,b){var d=z.utils.unwrapObservable(b()),c={queue:!1};"step"in d&&(c.step=d.step,delete d.step);"duration"in d&&(c.duration=d.duration,delete d.duration);"easing"in d&&(c.easing=
d.easing,delete d.easing);X(a).stop().animate(d,c)}};z.bindingHandlers.animatePage={init:function(a,b){var a=X(a),d=z.unwrap(b()),c=1==d?0:a.width();a.animate({left:-c*(d-1)},{duration:0})},update:function(a,b,d){var a=X(a),d=d(),b=z.unwrap(b()),d=z.unwrap(d.duration),c=1==b?0:a.width();a.stop().animate({left:-c*(b-1)},{duration:d})}};z.bindingHandlers.tactile={init:function(a,b){var d=z.utils.unwrapObservable(b()),c=d;X.isPlainObject(d)&&(c=z.utils.unwrapObservable(d.number));X(a).reel(c,0)},update:function(a,
b){var d=z.utils.unwrapObservable(b()),c=d,f,h;X.isPlainObject(d)&&(c=z.utils.unwrapObservable(d.number),f=z.utils.unwrapObservable(d.before),h=z.utils.unwrapObservable(d.after));f&&f.call(X(a));X(a).reel(c,void 0,null,h)}};z.bindingHandlers.progress={update:function(a,b){var d=z.utils.unwrapObservable(b()),c=z.utils.unwrapObservable(d.property)||"width",f=z.utils.unwrapObservable(d.current)||0,d=z.utils.unwrapObservable(d.total)||0,f=100*(d?f/Math.abs(d):1),f=Math.max(0,Math.min(100,f));X(a).css(c,
f+"%")}};z.bindingHandlers.center={update:function(a,b){a=X(a);z.utils.unwrapObservable(b());setTimeout(function(){var b=a.width(),c=a.height();b&&a.css({marginLeft:-parseInt(b/2,10)});c&&a.css({marginTop:-parseInt(c/2,10)})},0)}};z.bindingHandlers.scroll={init:function(a,b){var d=z.utils.unwrapObservable(b()),c=d.start,f=d.stop,h="undefined"===typeof d.timeout?500:d.timeout,i=null,j=!0,k;h&&(k=function(){f&&f.call(a);j=!0});X(window).scroll(function(b){h&&clearTimeout(i);c&&j&&(h&&(j=!1),c.call(a,
b));h&&(i=setTimeout(k,h))})}};z.bindingHandlers.textOverflow={init:function(a){X(a).css("text-overflow","ellipsis")},update:function(a,b){var d=z.utils.unwrapObservable(b());X(a).text(d)}};z.bindingHandlers.swipe={init:function(a,b){function d(a,b){var d=a.style;d&&(d.webkitTransform="translate("+b+"px, 0) translateZ(0)",d.msTransform=d.MozTransform=d.OTransform="translateX("+b+"px)")}var a=X(a),c=z.unwrap(b())||{},f,h,i,j,k,l,m=c.target?a.find(c.target):a;a.on("touchstart",function(a){a=a.originalEvent||
a;a=a.touches[0];f=a.pageX;h=a.pageY;i=+new Date;l=k=j=void 0});a.on("touchmove",function(a){a=a.originalEvent||a;if(!(1<a.touches.length)&&!(a.scale&&1!==a.scale)){var b=a.touches[0];j=b.pageX-f;k=b.pageY-h;null==l&&(l=!!(l||Math.abs(j)<Math.abs(k)));l||(a.preventDefault(),d(m[0],j))}});a.on("touchend",function(){var b=+new Date-i,c=a.width(),g=250>Number(b)&&20<Math.abs(j)||Math.abs(j)>c/2;d(m[0],0);l||("left"===(0>j?"left":"right")?m.animate({left:"-="+Math.abs(j)+"px"},{duration:0,complete:function(){a.trigger(g?
"swipeleft":"swipecancel")}}):m.animate({left:"+="+j+"px"},{duration:0,complete:function(){a.trigger(g?"swiperight":"swipecancel")}}))});if(c.left)a.on("swipeleft",c.left);if(c.right)a.on("swiperight",c.right);if(c.cancel)a.on("swipecancel",c.cancel)}};var R=c.$,v=c.ko;v.bindingHandlers.outsideClick={init:function(a,b,d,c){var f=b();if(R.isFunction(f))R(document).on("click",function(b){var d=R(a).has(b.target).length,j=R(document).has(b.target).length;!d&&j&&(f.call(c,b),b.stopPropagation())})}};
v.bindingHandlers.dynamic={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,c){b=v.utils.unwrapObservable(b());d=b.template;c=b.data||c;R.isFunction(d)&&(d=d.call(c));d&&v.renderTemplate(d,c,{},a,"replaceChildren");R.isFunction(b.after)&&b.after.call(c,a)}};v.bindingHandlers.dynamicForEach={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,c){R(a).empty();var f=v.utils.unwrapObservable(b()),h=v.utils.unwrapObservable(f.template),i=v.utils.unwrapObservable(f.collection);
R.isFunction(h)&&(h=h.call(c));R.isFunction(i)&&(i=i.call(c));i||(i=[c]);b=function(){return{name:h,foreach:i}};return v.bindingHandlers.template.update.apply(this,arguments)}};v.bindingHandlers.widget={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,g){R(a).empty();b=b();null==b.options.context&&(b.options.context=g);b.options.parent=a;a=new c.controller.widget[b.type](b.options);a.owner=g;a.render()}};v.bindingHandlers.static_widget={init:function(){return{controlsDescendantBindings:!0}},
update:function(a,b,d,g){d=R(a);if(!d.data("widget")){d.empty();var f=b(),b=f.options||{};null==b.context&&(b.context=g);b.parent=a;if(a=c.controller.widget[f.type||"Widget"])a=new a(b),a.owner=g,d.data("widget",a),a.render()}}};v.bindingHandlers.dynamicForEachPlus={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,c){R(a).empty();var f=v.utils.unwrapObservable(b()),h=v.utils.unwrapObservable(f.template),f=v.utils.unwrapObservable(f.collection);R.isFunction(h)&&(h=h.call(c));
R.isFunction(f)&&(f=f.call(c));f||(f=[c]);for(var i=[],j=0;j<f.length;j++)i.push({item:f[j],owner:c});b=function(){return{name:h,foreach:i}};return v.bindingHandlers.template.update.apply(this,arguments)}};v.bindingHandlers.bind=v.bindingHandlers["with"];v.bindingHandlers.conditional={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,c,f){var h=v.utils.unwrapObservable(b()),i=h["if"],j=h.then,k=h["else"];"function"===typeof i&&(i=i.call(c));"function"===typeof j&&(j=j.call(c));
"function"===typeof k&&(k=k.call(c));f.condition=i;b=function(){return{name:i?j:k}};return v.bindingHandlers.template.update.apply(this,arguments)}};v.bindingHandlers.render={init:function(){return{controlsDescendantBindings:!0}},update:function(a,b,d,g){b=v.utils.unwrapObservable(b());"string"===typeof b?d=b:(d=v.utils.unwrapObservable(b.string),g=v.utils.unwrapObservable(b.data)||g);d in c.app.current().spec.media.templates||(d=new c.Template(d));v.renderTemplate(d,g,{},a,"replaceChildren")}};v.bindingHandlers.string=
v.bindingHandlers.render;v.bindingHandlers.wait={init:function(a,b,d,c){b=!(c.children&&c.children.length);R(a).data("waiting",b);return{controlsDescendantBindings:b}},update:function(a,b,d,c){if(R(a).data("waiting")&&v.utils.unwrapObservable(b()))return R(a).data("waiting",!1),v.applyBindingsToDescendants(c,a)}};c.pool={};var hg=function(a){this.model=a;this.objects={};this.readonly=!0},Fj=c.pool;hg.prototype.save=function(a){var b=this.model.hash(a),d=this.objects[b];if(d)return this.readonly||
(a=a instanceof this.model?a.data():a,this.model.call(d,a)),d;this.objects[b]=a instanceof this.model?a:new this.model(a);return this.objects[b]};Fj.ModelPool=hg;var ig=c.$;ig.extend(ig.easing,{easeInOutCubic:function(a,b,d,c,f){return 1>(b/=f/2)?c/2*b*b*b+d:c/2*((b-=2)*b*b+2)+d}});var Ub=c.$;Ub.reel={commaize:function(a){return(""+a).replace(/(\d{1,3})(?=(?:\d{3})+$)/g,"$1,")},getDuration:function(a,b){var d=Math.floor(400*Math.log(Math.abs(a)+1));"undefined"!=typeof b&&(d=Math.min(b,d));return d},
update:function(a,b,d){a.text(d(b))},interval:13};Ub.fn.reel=function(a,b,d,c){var f=this.data("reel.value")||0;this.data("reel.value",a);var h=a-f;"undefined"==typeof b&&(b=Ub.reel.getDuration(h,5E3));d=d||Ub.reel.commaize;if(0===h||0===b)this.text(d(a));else{var i=(new Date).getTime(),j=this,k=function(l){var m=(new Date).getTime()-i;b-m>Ub.reel.interval?(m=Math.floor(h*(m/b)),0!==m&&j.text(d(f+m)),j.queue("reel",k)):(j.text(d(a)),c&&c.call(j));setTimeout(l,Ub.reel.interval)};this.queue("reel",
[k]).dequeue("reel")}return this};var U=function(a){if(!(this instanceof U))return new U(a);a=a||{};this.width=a.width||400;this.height=a.height||300;"boolean"===o.type(a.scrolling)&&(a.scrolling={enabled:a.scrolling});this.scrolling=o.extend({enabled:!0,speed:800,easing:"easeInOutCubic"},a.scrolling||{});"boolean"===o.type(a.fading)&&(a.fading={enabled:a.fading});this.fading=o.extend({enabled:!0,speed:150},a.fading||{});this.root=o('<div class="bd-spotlight"><div class="top"/><div class="left"/><div class="right"/><div class="bottom"/></div>');
this.top=o(".top:first",this.root);this.left=o(".left:first",this.root);this.right=o(".right:first",this.root);this.bottom=o(".bottom:first",this.root);this._init_x_pos=this._init_y_pos=0;this._visible_scroll_radius=a.visible_scroll_radius||100;this.on_ready=o.proxy(this.on_ready,this);this.on_click=o.proxy(this.on_click,this);this.on_keyup=o.proxy(this.on_keyup,this);this.on_scroll=o.proxy(this.on_scroll,this);this.is_ready=!1;o(document).ready(this.on_ready)},je=function(a){F||(F=new U(void 0),
je.SPOTLIGHT=F);if(!0===a||!1===a)a={show:a};!1===a.show||!0!==a.show&&F.root.is(":visible")?F.hide(a):F.scroll(function(){F._init_y_pos=F.viewport().top;F._init_x_pos=F.viewport().left;F.show()})},o=c.$;U.prototype.on_ready=function(){this.is_ready||(this.root.hide().appendTo(document.body),this.is_ready=!0)};U.prototype.viewport=function(){var a={},b=o(window);a.top=b.scrollTop();a.left=b.scrollLeft();a.right=b.width()+a.left;a.bottom=b.height()+a.top;return a};U.prototype.is_viewing=function(a,
b){if("number"!==o.type(a)&&!(a instanceof o))try{a=o(a)}catch(d){return!1}if(a instanceof o){if(1>a.length||!a.is(":visible"))return!1;var c=a.offset()||a.position();if(!c)return!1;b=c.top;a=c.left}a="number"===o.type(a)?a:parseInt(a,10);b="number"===o.type(b)?b:parseInt(b,10);if(isNaN(a)||isNaN(b))return!1;c=this.viewport();return a>=c.left&&a<=c.right&&b>=c.top&&b<=c.bottom};U.prototype.scroll=function(a,b){var d=this.target(),c=this.scrolling.speed,f=this.scrolling.easing,f=!o.easing[f]?void 0:
f,b=b||this;!this.scrolling.enabled||this.is_viewing(d)?o.isFunction(a)&&a.call(b):!f||isNaN(c)||1>c?(o("html, body").css({scrollTop:d.offset().top}),o.isFunction(a)&&a.call(b)):o("html, body").animate({scrollTop:d.offset().top},this.scrolling.speed,this.scrolling.easing,function(){d&&o.isFunction(a)&&a.call(b);d=!1})};U.prototype.show=function(a,b){if(!this.is_ready)this.on_ready();b=b||this;if(this.target()){this.center();var d=!1;o(document).bind("click",this.on_click);o(document).bind("keyup",
this.on_keyup);o(document).bind("scroll",this.on_scroll);this.fade({out:!1},function(){!d&&o.isFunction(a)&&a.call(b);this.activating=!1;d=!0})}else o.isFunction(a)&&a.call(b)};U.prototype.center=function(){var a,b;this.target()&&((a=this.target().offset())?(b=parseInt(a.left+this.target().width()/2-this.width/2,10),a=parseInt(a.top+this.target().height()/2-this.height/2-o(window).scrollTop(),10)):(b=parseInt(o(document).width()/2-this.width/2,10),a=parseInt(o(document).height()/2-this.height/2-o(window).scrollTop(),
10)),this.root.css({"background-position":b+"px "+a+"px"}),this.top.height(Math.max(a,0)),this.left.css({top:a,width:Math.max(b,0)}),this.right.css({top:a,left:b+this.width}),this.bottom.css({top:a+this.height}));return this};U.prototype.hide=function(a,b){this.activating?o.isFunction(a)&&a.call(b||this):(this.untarget(),o(document).unbind("click",this.on_click),o(document).unbind("keyup",this.on_keyup),o(document).unbind("scroll",this.on_scroll),this.fade({out:!0},a,b))};U.prototype.fade=function(a,
b,d){o.isFunction(a)&&(d=b,b=a,a=void 0);var d=d||this,a=a||{},c=a.speed;if("number"!==o.type(c)||isNaN(c))c=this.fading.speed;if(!this.fading.enabled||isNaN(c)||1>c)this.root.hide(),o.isFunction(b)&&b.call(d);else{var f=function(){o.isFunction(b)&&b.call(d)};a.out?this.root.fadeOut(c,f):this.root.fadeIn(c,f)}};U.prototype.target=function(a){try{a=o(a)}catch(b){a=void 0}if(a&&a[0]){this.untarget();a=a.first();this._target=a.first();var d=a.css("position"),c=a.css("zIndex");a.data("bd-original-position",
d);a.data("bd-original-zindex",c);"static"===d&&a.css({position:"relative"});d=parseInt(this.root.css("zIndex"),10);isNaN(d)?a.css({zIndex:1}):a.css({zIndex:d+1})}return this._target};U.prototype.untarget=function(){var a;try{a=o(this._target)}catch(b){a=void 0}if(a&&0<a.length){var d=a.data("bd-original-position"),c=a.data("bd-original-zindex");a.css("position","");a.css("zIndex","");a.css("position")!=d&&a.css("position",d);a.css("zIndex")!=c&&a.css("zIndex",d);this._target=void 0}return this};
U.prototype.on_click=function(){this.hide()};U.prototype.on_keyup=function(a){27==a.keyCode&&this.hide()};U.prototype.on_scroll=function(){(Math.abs(this.viewport().top-this._init_y_pos)>this._visible_scroll_radius||Math.abs(this.viewport().left-this._init_x_pos)>this._visible_scroll_radius)&&this.hide()};var F;o.extend({spotlight:je});o.fn.extend({spotlight:function(a){F||(F=new U(void 0),je.SPOTLIGHT=F);if(!0===a||!1===a)a={show:a};!a||a.show?(F.activating=!0,F.target(this),F.scroll(function(){F._init_y_pos=
F.viewport().top;F._init_x_pos=F.viewport().left;F.show()})):F.target()[0]===this&&F.hide(a)}});var ke=function(a){0!==a.indexOf(jg)&&(a=jg+a);return a},le=c.$,me=c,jg="bigdoor.";me.subscribe=function(a,b){a=ke(a);if(b)return le(document).bind(a,b)};me.unsubscribe=function(a,b){a=ke(a);if(b)return le(document).unbind(a,b)};me.trigger=function(a,b){a=ke(a);return le(document).trigger(a,b)};var Ab=function(a,b){this.app=a;this.reporter=new kg(a);this.track(Gj);this.is_remote_store_enabled=b.is_remote_store_enabled||
!1;this._events_queue=[];this._is_tracker_ready=!1;c.subscribe("app.post.bucket_setup",ne(this,this.on_tracker_ready))},oe=function(a){var a=a||c.app.current(),b=a.bucket.is_in_exposed_bucket()||a.bucket.is_in_control_bucket(),d=a.bucket.is_in_exposed_bucket(),g=!a.auth.is_anonymous(),b={tracking:+b,gambit_visible:+d,signed_in:+g,ui:a.mobile()?"mobile":"desktop",bucket:a.bucket.get_bucket()||"NA"};c.abtest.is_abtesting_enabled&&(b.ab_test_variant=c.abtest.get_abtest_name_for_events());a.bucket.is_bucket_debug_mode()&&
(b=Vb.extend(!0,b,{client_timestamp:+(new Date).getTime()||"NA",bucket_config:a.bucket.bucket_config,bd_bucket_cookie:(new c.session.cookie.StateCookie("bd-bucket")).read()||"NA",bd_local_cookie:(new c.session.cookie.StateCookie("bd-local")).read()||"NA",bucket_local_storage:localStorage.getItem("bd-bucket-debug")||"NA"}));c.language&&c.language.active&&(b.lang=c.language.active);return b},kg=function(a){this.app=a},Vb=c.$,ne=c.bind,r=c.subscribe,lg=c.tracker={};Ab.prototype.createEvent=function(a,
b){var d={event_type:a,publisher_app_key:this.app.spec.bigdoor.app_key,current_page:window.location.href,referral_url:window.document.referrer,event_data:b||{}};this.app.auth&&this.app.auth.user&&(d.enduser_login=this.app.auth.user.end_user_login());this.app.spec.site_id&&(d.site_id=this.app.spec.site_id);return d};Ab.prototype.reportEvent=function(a){if(a.enduser_login){var b=this;this._is_tracker_ready?setTimeout(function(){b.reporter.report(a)},0):this._events_queue.push(a)}};Ab.prototype.on_tracker_ready=
function(){var a=this;this._events_queue.length&&(c.each(this._events_queue,function(b){setTimeout(function(){a.reporter.report(b)},0)}),this._events_queue=[]);this._is_tracker_ready=!0};Ab.prototype.track=function(a,b){if("string"===typeof a){var d=ne(this,function(b){b=this.createEvent(a,b);this.reportEvent(b)});b.call(this,d)}else if(1===arguments.length)for(d in a)this.track(d,a[d])};Ab.prototype.reportEventData=function(a,b){this.reportEvent(this.createEvent(a,b))};Ab.prototype.reportUserStateEvent=
function(a,b){b=Vb.extend(oe(this.app),{action:a},b);this.reportEventData("com.bigdoor.gambit.user_state",b)};lg.get_user_state=oe;var Gj={"com.bigdoor.gambit.ntge":function(a){r("user.transact",function(b,d){a(d||{})})},"com.bigdoor.gambit.pageview":function(a){var b=this.app;r("app.post.authorize",function(){var d=b.spec.site_id||"",g=b.auth.user.end_user_login(),d=[d,g].join("-");b.tracker.is_remote_store_enabled?(g=ne(this,function(b){b&&a()}),c.remote_storage.throttle("bd-com.bigdoor.gambit.pageview",
3600,1,d,g)):c.storage.throttle("bd-com.bigdoor.gambit.pageview",3600,1,d)&&a()})},"com.bigdoor.gambit.login":function(a){var b=this.app;r("signin",function(){var d={},c=b.sessions.local.read("last-eul");c&&(d.anonymous_enduser_login=c);a(d)})},"com.bigdoor.gambit.logout":function(a){var b=this.app;r("signout",function(){var d={},c=b.sessions.local.read("last-eul");c&&(d.registered_enduser_login=c);a(d)})},"com.bigdoor.gambit.user_state":function(a){var b=this.app;r("app.post.authorize",function(){b.sessions.local.had_previous_value||
a({action:"first_visit"})});r("signin",function(){a({action:"sign_in"})});r("signout",function(){a({action:"sign_out"})});r("optout",function(){a({action:"opt_out"})})},"com.bigdoor.gambit.acquisition":function(a){r("user.acquisition",function(){a({})})},"com.bigdoor.gambit.onboarding":function(a){r("onboarding.impression",function(b,d){var c={action:"impression"};d&&(c.meta="campaign__"+d);a(c)});r("onboarding.login_click",function(){a({action:"login_click"})});r("onboarding.register_click",function(){a({action:"register_click"})});
r("onboarding.close_click",function(){a({action:"close_click"})});r("onboarding.opt_out_click",function(){a({action:"opt_out_click"})});r("onboarding.decline_click",function(){a({action:"decline_click"})})},"com.bigdoor.gambit.referral":function(a){r("referral.impression",function(b,d){var c={action:"impression"};d&&(c.meta="campaign__"+d);a(c)});r("referral.login_click",function(){a({action:"login_click"})});r("referral.register_click",function(){a({action:"register_click"})});r("referral.close_click",
function(){a({action:"close_click"})});r("referral.opt_out_click",function(){a({action:"opt_out_click"})})},"com.bigdoor.gambit.rewards_center":function(a){r("rewards.redemption_error",function(b,d){var c={action:"redemption_error",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("user.wish.added",function(b,d){var c={action:"wishlist_add",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("user.wish.removed",function(b,d){var c={action:"wishlist_remove",meta:"named_good_id__"+(d&&d.id?
d.id():"na")};a(c)});r("rewards.impression",function(){a({action:"impression"})});r("rewards.close_click",function(){a({action:"close_click"})});r("rewards.redeem_click",function(b,d){var c={action:"redeem_click",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("rewards.facebook_share_click",function(b,d){var c={action:"facebook_share_click",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("rewards.twitter_share_click",function(b,d){var c={action:"twitter_share_click",meta:"named_good_id__"+
(d&&d.id?d.id():"na")};a(c)});r("rewards.place_order_click",function(b,d){var c={action:"place_order_click",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("rewards.view_reward_click",function(b,d){var c={action:"view_reward_click",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("rewards.tou_link_click",function(b,d){var c={action:"tou_link_click",meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)});r("rewards.redemption_cancel_click",function(b,d){var c={action:"redemption_cancel",
meta:"named_good_id__"+(d&&d.id?d.id():"na")};a(c)})},"com.bigdoor.gambit.widget":function(a){r("widget.impression",function(b,d){var c={action:"impression"};Vb.extend(!0,c,d);c.widget_identifier&&a(c)});r("widget.click",function(b,d){var c={action:"click"};Vb.extend(!0,c,d);c.widget_identifier&&a(c)})},"com.bigdoor.gambit.bucket":function(a){r("bucket.transition",function(b,d){a({action:"transition",meta:"type__"+(d||"unknown")})});r("bucket.opt_out_intent_click",function(){a({action:"click",meta:"opt_out_intent"})})},
"com.bigdoor.gambit.leaderboard":function(a){r("leaderboard.impression",function(b,d){a({action:"impression",meta:"leaderboard_id__"+d.leaderboard_id+"%20view__"+d.view})});r("leaderboard.select",function(b,d){a({action:"select",meta:"leaderboard_id__"+d.leaderboard_id+"%20view__"+d.view})});r("leaderboard.paginate",function(b,d){a({action:"paginate",meta:"leaderboard_id__"+d.leaderboard_id+"%20view__"+d.view})})},"com.bigdoor.com.gambit.context_notifier":function(a){r("context_notifier.impression",
function(b,d){a({action:"impression",meta:"context__"+d.context})});r("context_notifier.close_click",function(b,d){a({action:"close_click",meta:"context__"+d.context})});r("context_notifier.cta_click",function(b,d){a({action:"cta_click",meta:"context__"+d.context+"%20id__"+d.id})})},"com.bigdoor.gambit.share":function(a){r("share.facebook.click",function(b,d){var c={action:"click",meta:"type__facebook"};d&&d.ref&&(c.meta+="%20ref__"+d.ref);a(c)});r("share.facebook.success",function(b,d){var c={action:"success",
meta:"type__facebook"};d&&d.ref&&(c.meta+="%20ref__"+d.ref);a(c)})}};kg.prototype.report=function(a){var b=this.app.bucket,b=b.is_in_disregard_bucket()||b.is_in_opted_out_bucket(),d="com.bigdoor.gambit.bucket"===a.event_type;if(!b||d)b=window.location.protocol+"//"+(this.app.spec.bigdoor.event_log_hostname||this.app.bigdoor.hostname)+"/api/publisher/"+this.app.bigdoor.app_key+"/event_log",d=oe(this.app),Vb.extend(!0,a.event_data,d),c.JSON&&c.JSON.stringify&&(a=c.JSON.stringify(a),Vb.ajax({url:b,dataType:"jsonp",
jsonp:!1,data:{event:a}}))};lg.EventTracker=Ab;var dd=function(){},Hj=c.$,Ij=c.session={};dd.prototype.read_type=function(a,b){var d=this.read(a);if(void 0!==d)return b(d)};dd.prototype.read_int=function(a){return this.read_type(a,parseInt)};dd.prototype.resolve=function(a,b){var d;"string"==Hj.type(a)?(d={},void 0!==b&&null!==b&&(d[a]=b)):d=a;return d};Ij.SessionState=dd;var ka=function(a){this.session=a},mg=c.$,ng=c.each,Jj=c.session,rc=ka.defaults={quest:{"quest-active-id":0},checkpoint:{"checkpoint-started":0,
"checkpoint-url":0,"checkpoint-passed":0}};ka.prototype.activate_quest=function(a){this.session.write({"quest-active-id":a.id()});return this};ka.prototype.start_checkpoint=function(a){this.session.write({"checkpoint-started":a.id(),"checkpoint-url":a.link().url()});return this};ka.prototype.pass_checkpoint=function(a,b,d){this.session.write({"checkpoint-passed":a.id()},b,d);return this};ka.prototype.complete_checkpoint=function(){this.session.write(rc.checkpoint);return this};ka.prototype.complete_quest=
function(){this.clear();return this};ka.prototype.active_quest_id=function(){return this.session.read_int("quest-active-id")};ka.prototype.started_checkpoint=function(){return this.session.read_int("checkpoint-started")};ka.prototype.checkpoint_url=function(){return this.session.read("checkpoint-url")};ka.prototype.passed_checkpoint=function(){return this.session.read_int("checkpoint-passed")};ka.prototype.clear=function(){var a=mg.extend({},rc.quest,rc.checkpoint);this.session.write(a);return this};
ka.prototype.write=function(a){var a=this.session.resolve.apply(this,arguments)||{},b={};ng(rc.quest,function(d,c){a[c]&&(b[c]=a[c])},this);ng(rc.checkpoint,function(d,c){a[c]&&(b[c]=decodeURIComponent(a[c]))},this);mg.isEmptyObject(b)||this.session.write(b)};Jj.QuestsSessionState=ka;var pe=function(a){this.session=a},Kj=c.session;pe.prototype.get_state=function(){return this.session.read("minibar-state")};pe.prototype.set_state=function(a){this.session.write({"minibar-state":a})};Kj.MinibarSessionState=
pe;var ed=function(a,b){this.session=a;Lj.extend(this,this.defaults,b)},Lj=c.$,Mj=c.session;ed.prototype.defaults={optout_expire_days:14};ed.prototype.set_optout=function(a){a=a?(new Date).getTime():0;this.session.write({"user-optout":a})};ed.prototype.get_optout=function(){var a=this.session.read("user-optout");return a&&(new Date).getTime()-a<=864E5*this.optout_expire_days?!0:!1};Mj.UserSessionState=ed;var gb=function(a,b,d,g){b=b||{};if(!a)throw"CrossDomainState was created without a name";this.name=
a;this.expires=b.expires||7;b.domain&&(this.domain=b.domain);this.had_previous_value=!1;this._remote_data_cache={};c.remote_storage.get(this.name,Bb.proxy(function(a,b,c){this.had_previous_value=!!b;this._remote_data_cache=b||{};this._expires_timestamp=c;Bb.isFunction(d)&&d.call(g||this,this)},this))},Bb=c.$,Nj=c.each,og=c.util.convert,Oj=c.session.remote_storage={},pg={expires:function(a){return"session"===a?null:1440*a},resolve:function(a,b){var d;"string"==Bb.type(a)?(d={},void 0!==b&&null!==b&&
(d[a]=b)):d=a;return d}};gb.raw=pg;gb.prototype.write=function(a,b,d){var a=Bb.extend(!0,{},this.read(),a),g=null,f=Bb.proxy(function(a,c,g){this._remote_data_cache=c;this._expires_timestamp=g;Bb.isFunction(b)&&b.call(d||this,this)},this);this._expires_timestamp||(g=pg.expires(this.expires),this._expires_timestamp=c.storage.current_time_in_minutes()+g);a._EXPIRES?a._EXPIRES=this._expires_timestamp:a={data:a,_EXPIRES:this._expires_timestamp};this._remote_data_cache=a;c.remote_storage.set(this.name,
a,null,f);return this};gb.prototype.read=function(a){var b=this._remote_data_cache;b._EXPIRES&&b.data&&(b=b.data);return a?b[a]:b};gb.prototype.remove=function(){this._remote_data_cache={};c.remote_storage.destroy(this.name)};gb.prototype.resolve=function(a,b){var d;"string"==Bb.type(a)?(d={},void 0!==b&&null!==b&&(d[a]=b)):d=a;return d};gb.prototype.serialize=function(a){a=this.resolve.apply(this,arguments);Nj(a,function(b,d){(null===b||void 0===b)&&delete a[d]});return og.encode_form(a||{})};gb.prototype.deserialize=
function(a){return og.decode_form(a)};Oj.CrossDomainState=gb;var Na=function(a,b){qg.call(this,b);b=b||{};if(!a)throw"StateCookie was created without a name";this.name=a;this.expires=b.expires||7;b.domain&&(this.domain=b.domain);hb.isFunction(b.serialize)&&(this.serialize=b.serialize);hb.isFunction(b.deserialize)&&(this.deserialize=b.deserialize);this.had_previous_value=!!Na.raw.read(this.name)},hb=c.$,Pj=c.each,rg=c.util.convert,qg=c.session.SessionState,Qj=c.session.cookie={},ca={expires:function(a){if("session"===
a)return"";a="number"==hb.type(a)?a:365;a=(new Date).getTime()+864E5*a;return(new Date(a)).toUTCString()},append:function(a,b,d){d=hb.trim(d||"");a&&b&&(0<d.length&&d.lastIndexOf(";")!=d.length-1&&(d+=";"),d+=a+"="+b);return d},read:function(a){var b=ca.get();if(b&&(a=b.match(ca.extractor(a)))&&a[0])return a[0].slice(a[0].split("=",1)[0].length+1)},write:function(a,b,d,c){a=ca.append(a,b);"number"==hb.type(d)&&(d=ca.expires(d));a=ca.append("expires",d,a);"string"==hb.type(c)&&(a=ca.append("domain",
c,a));a=ca.append("path","/",a);ca.set(a)},remove:function(a,b){ca.write(a," ",-1,b)},extractor:function(a){return RegExp("("+a+")=([^;]*)","gi")},set:function(a){document.cookie=a},get:function(){return document.cookie}};Na.raw=ca;Na.prototype=new qg;Na.prototype.write=function(a,b,d){a=hb.extend(!0,{},this.read(),a);ca.write(this.name,this.serialize(a),ca.expires(this.expires),this.domain);hb.isFunction(b)&&b.call(d||this,this);return this};Na.prototype.read=function(a){var b=this.deserialize(ca.read(this.name));
return a?b&&a in b?b[a]:void 0:b};Na.prototype.remove=function(){ca.remove(this.name,this.domain)};Na.prototype.serialize=function(a){a=this.resolve.apply(this,arguments);Pj(a,function(b,d){(null===b||void 0===b)&&delete a[d]});return rg.encode_form(a||{})};Na.prototype.deserialize=function(a){return rg.decode_form(a)};Qj.StateCookie=Na;var fd=function(a){a=a||{};this.profile=a.profile},Rj=c.session.SessionState,Sj=c.session.profile={};fd.prototype=new Rj;fd.prototype.read=function(a){return a?this.profile.get(a):
this.profile.get()};fd.prototype.write=function(a,b,d){this.profile.set(a,function(){c.trigger("profile.write",[this,a]);b&&b.call(d||this)},this);return this};Sj.ProfileSession=fd;var gd=function(a){a=a||{};a.fields&&this.define(a.fields)},Oa=c.$,hd=c.ko;c.Watchable=c.Class.extend(gd);gd.dependent=gd.computed=function(a,b,d,c){if("string"==Oa.type(a))return b&&!Oa.isFunction(b)&&(Oa.isFunction(b.set)&&(d=b.set),b=b.get),this.prototype[a]=function(){var f={owner:this,read:function(){return Oa.isFunction(b)?
b.call(this,a):b}};if(Oa.isFunction(d))f.write=function(){d.apply(this,arguments);return this[a].evaluate()};this[a]=hd.computed(f).extend(c);return this[a]()},this.prototype[a]};gd.prototype.define=function(a,b){if("string"==Oa.type(a)){var d=a,a={};a[d]=b}if(a&&Oa.isPlainObject(a))for(var c in a)a.hasOwnProperty(c)&&!this.hasOwnProperty(c)&&(this[c]=Oa.isArray(a[c])?hd.observableArray(a[c]):Oa.isFunction(a[c])?hd.computed({read:a[c],owner:this,deferEvaluation:!0}):hd.observable(a[c]));return this};
var Cb=function(a){a?(!1!==a.legacy&&(a=this.translate_legacy_config(a)),a=sc.extend(!0,{},this.defaults,a),this.setup_middleware(a)):(this.middleware_order=[],this.middleware={})},sc=c.$,Tj=c.error.NotImplemented,sg=c.transport={};Cb.prototype.defaults={middleware_order:["abby_normal"],middleware:{abby_normal:{type:"AbbyNormalMiddleware"},pattern_matching:{type:"PatternMatchingMiddleware"},caching:{type:"CachingMiddleware"},cdn:{type:"CDNMiddleware"},translation:{type:"TranslationMiddleware"}}};
Cb.prototype.push=Tj.thrower;Cb.prototype.translate_legacy_config=function(a){var b={middleware_order:["abby_normal"],middleware:{}},d={type:"PatternMatchingMiddleware",options:{}},g={type:"CachingMiddleware",options:{request_settings:{}}},f={type:"CDNMiddleware",options:{request_settings:{}}},h={type:"TranslationMiddleware",options:{}};a.cache_request_patterns&&(d.options.patterns=a.cache_request_patterns,b.middleware_order.push("pattern_matching"),b.middleware.pattern_matching=d);a.cdn_hostnames&&
(f.options.hostnames=a.cdn_hostnames);a.cache_configuration&&(c.each(a.cache_configuration,function(a,b){if(a.cdn){var d={};if(a.cdn_callback)d.callback=a.cdn_callback;if(a.cdn_hostnames)d.hostnames=a.cdn_hostnames;f.options.request_settings[b]=d}d={};if(a.timeout!=null)d.timeout=a.timeout;g.options.request_settings[b]=d}),b.middleware_order.push("caching","cdn"),b.middleware.caching=g,b.middleware.cdn=f);a.middleware?(sc.extend(d,a.middleware.pattern_matching),sc.extend(g,a.middleware.caching),sc.extend(f,
a.middleware.cdn),sc.extend(h,a.middleware.translation),a.middleware.translation&&(b.middleware_order.push("translation"),b.middleware.translation=h)):c.language&&c.language.active&&(b.middleware_order.push("translation"),b.middleware.translation=h);a.middleware_order&&(b.middleware_order=a.middleware_order);return b};Cb.prototype.setup_middleware=function(a){var b=[],d={},g=this;c.each(a.middleware_order,function(c){var h=a.middleware[c];if(h&&h.type){var i=sg.middleware[h.type];i&&(h=new i(h.options),
h.transport=g,d[c]=h,b.push(c))}});this.middleware_order=b;this.middleware=d};Cb.prototype.run_middleware=function(a,b,d,c){function f(){if(i.length){var b=i.shift(),c=(b=h.middleware[b])&&b[a];if(c){var g=Array.prototype.slice.apply(arguments);g.push(f);c.apply(b,g)}else f.apply(this,arguments)}else d.apply(h,arguments)}c||(c=this.middleware_order);var h=this,i=Array.prototype.slice.apply(c);f.apply(h,b)};Cb.prototype.run_middleware_reverse=function(a,b,d){var c=Array.prototype.slice.apply(this.middleware_order);
c.reverse();this.run_middleware(a,b,d,c)};sg.Transport=Cb;var ug=function(a){tg.apply(this,arguments)},vg=c.$,id=c.curry,tg=c.transport.Transport,Uj=c.transport.rest={},Pa=ug.prototype=new tg;Pa.request=function(a,b,d,c,f,h){vg.isFunction(c)?(h=f,f=c,c={}):vg.isFunction(d)&&(h=c,f=d,c={},d={});a=(a||"GET").toUpperCase();"object"!==typeof d&&(d={});return{method:a,uri:b,query:d,payload:c,callback:f,context:h}};Pa.read=id(Pa.push,"GET");Pa.create=id(Pa.push,"POST");Pa.update=id(Pa.push,"PUT");Pa.remove=
id(Pa.push,"DELETE");Uj.RestTransport=ug;var Wb=function(a){wg.apply(this,arguments)},xg=c.$,Vj=c.curry,yg=c.trigger,wg=c.transport.rest.RestTransport,Wj=c.transport.rest;Wb.prototype=new wg;Wb.prototype.push=function(a,b,d,g,f,h){var i=this.request.apply(this,arguments),j=xg.extend({},i.query),k=c.app.current();if(window.BDACWE&&(k.auth.authenticating()||!k.auth.is_anonymous()))j.BDACWE=window.BDACWE;if(i.payload)for(var l in i.payload)i.payload.hasOwnProperty(l)&&(j["$"+l]=i.payload[l]);i.method&&
"GET"!==i.method&&(j.method=i.method);k={url:b,data:j,beforeSend:function(a,b){yg("transport.send",[a,b])},dataType:"jsonp",context:this};this.timeout&&(k.timeout=this.timeout);j=Vj(this.complete,i);k.success=j;k.error=j;this.run_middleware("process_request",[i,k],function(a,b){xg.ajax(b)})};Wb.prototype.complete=function(a,b,d,c){yg("transport.complete",[a,b,c]);if("success"!=d)return this.error(a,c,d);b={code:b.http_status_code,status:b.http_status,headers:b.headers,data:b.content};200>b.code||
299<b.code?this.error(a,b,d):this.success(a,b)};Wb.prototype.error=function(a,b,d){this.run_middleware_reverse("process_error",arguments,function(a,b){a.callback&&a.callback.call(a.context||this,"error",b)})};Wb.prototype.success=function(a,b){this.run_middleware_reverse("process_success",arguments,function(a,b){a.callback&&a.callback.call(a.context||this,"success",b,b.data)})};Wj.JsonRest=Wb;c.transport.middleware={};var qe=function(a){a=Xj.extend({},this.defaults,a);this.abby_normal_url=a.url},
Xj=c.$,Yj=c.transport.middleware;qe.prototype.defaults={url:"//healthy.loyalty.bigdoor.com/abby_normal.gif"};qe.prototype.process_error=function(a,b,d,g){var f=c.app.current(),h="timeout"===d,i="Not Found"==b,j="GET"===a.method,k=a.uri.replace(f.bigdoor.baseuri(),""),l=k.match(/auth\/[^\/]+\/status/),m=k.match(/end_user\/[^\/]+\/profile/),k=k.match(/^\/end_user\/[^\/]+$/),e=!1,n=!1;if(h||i)j&&(n=e=!0);else if(b&&!(302==b.code||k&&404==b.code||m&&404==b.code||l&&401==b.code)&&j)e=n=!0;n&&f.error();
e&&(new c.error.AbbyNormalError({request:a,response:b,endpoint:this.abby_normal_url})).report();g(a,b,d)};Yj.AbbyNormalMiddleware=qe;var tc=function(a){a=Zj.extend(!0,{},this.defaults,a);this.patterns=a.patterns},Zj=c.$,$j=c.transport.middleware;tc.prototype.defaults={patterns:{"publishers/[0-9]+/release/[0-9]+/quests/[a-z_]+[.]js{":"QUEST_TRANSLATED"}};tc.prototype.process_request=function(a,b,d){var c=this.get_request_signature(a),f=this.get_request_id(c);a.pattern_signature=c;a.pattern_id=f;d(a,
b)};tc.prototype.get_request_id=function(a){var b;c.each(this.patterns,function(d,c){if(RegExp(c).test(a))return b=d,!1},this);return b};tc.prototype.get_request_signature=function(a){var b=c.app.current(),b=a.uri.replace(b.bigdoor.baseuri(),""),b=b+c.JSON.stringify(a.query);return b.substring(1)};$j.PatternMatchingMiddleware=tc;var uc=function(a){a=zg.extend({},this.defaults,a);this.timeout=a.timeout;this.request_settings=a.request_settings},zg=c.$;c.transport.middleware.CachingMiddleware=uc;uc.prototype.defaults=
{timeout:0,request_settings:{END_USER_QUESTS_COMPLETE:{timeout:0}}};uc.prototype.get_request_settings=function(a){return zg.extend({timeout:this.timeout},this.request_settings[a.pattern_id])};uc.prototype.process_request=function(a,b,d){var g=a.callback,f=a.context||this.transport;if("GET"===a.method){var h=a.pattern_signature;if(h){c.language&&c.language.active&&(h+=c.language.active);var i=c.storage.get_storage(h,"api");if(i){g&&setTimeout(function(){g.call(f,"success",i,i.data)},0);return}}}d(a,
b)};uc.prototype.process_success=function(a,b,d){d(a,b,status);if("GET"===a.method){var g=a.pattern_signature;if(g){c.language&&c.language.active&&(g+=c.language.active);var f=this.get_request_settings(a);setTimeout(function(){c.storage.set_storage(g,b,f.timeout,"api")},0)}}};var vc=function(a){a=Ag.extend(!0,{},this.defaults,a);this.timeout=a.timeout;this.hostnames=a.hostnames;this.callback=a.callback;this.request_settings=a.request_settings},Ag=c.$,ak=c.transport.middleware;vc.prototype.defaults=
{timeout:8E3,hostnames:["d27wmgjeh13rj8.cloudfront.net"],callback:"BDM_CDN_CALLBACK",request_settings:{REWARD:{callback:"BDM_CDN_REWARD_CALLBACK"},LEADERBOARD_GENERAL:{callback:"BDM_CDN_LEADERBOARD_GENERAL_CALLBACK"},LEADERBOARD_END_USER:{callback:"BDM_CDN_LEADERBOARD_END_USER_CALLBACK"},QUEST_ACTIVE:{callback:"BDM_CDN_QUEST_ACTIVE_CALLBACK"},BADGES:{callback:"BDM_CDN_BADGES_CALLBACK"},QUEST_ONBOARDING:{callback:"BDM_CDN_QUEST_ANONYMOUS_CALLBACK"}}};vc.prototype.process_request=function(a,b,d){var g=
c.app.current();a.query&&a.query.cdn_attempt&&(a.cdn_attempt=a.query.cdn_attempt,delete a.query.cdn_attempt);if("GET"===a.method&&a.pattern_id){var f=this.get_request_settings(a);if(f){a.cdn_attempt||(a.cdn_attempt=0);var h=f.hostnames[a.cdn_attempt],f=f.callback;a.cdn_attempt+=1;b.url=b.url.replace(g.bigdoor.hostname,h);b.jsonpCallback=f;b.cache=!0;b.timeout=this.timeout}}d(a,b)};vc.prototype.get_request_settings=function(a){if(a=this.request_settings[a.pattern_id])return Ag.extend({timeout:this.timeout,
hostnames:this.hostnames,callback:this.callback},a)};vc.prototype.process_error=function(a,b,d,c){if(a.cdn_attempt){var f=this.get_request_settings(a);if(f&&a.cdn_attempt<f.hostnames.length){a.query.cdn_attempt=a.cdn_attempt;this.transport.push(a.method,a.uri,a.query,a.payload,a.callback,a.context);return}}c(a,b,d)};ak.CDNMiddleware=vc;var ib=function(a){a=wc.extend({},this.defaults,a);this.quest_translatable_request_ids=a.quest_translatable_request_ids||["END_USER_QUESTS_INCOMPLETE","END_USER_QUESTS_COMPLETE",
"QUEST_ACTIVE"];this.active_language_code=c.language.active;this.translation_root_url=c.language.translation_root_url;this.translation_deferred=wc.Deferred();this.translation_requested=!1},wc=c.$;c.transport.middleware.TranslationMiddleware=ib;ib.prototype.defaults={};ib.prototype.process_request=function(a,b,d){a.pattern_id&&(b.cache=!1,"QUEST_ONBOARDING"===a.pattern_id?(b.url=this.get_translation_url("quests/anonymous"),b.jsonpCallback="BDM_CDN_QUEST_ANONYMOUS_CALLBACK"):"REWARD"===a.pattern_id?
(b.url=this.get_translation_url("rewards"),b.jsonpCallback="BDM_CDN_REWARD_CALLBACK"):"BADGES"===a.pattern_id?(b.url=this.get_translation_url("badges"),b.jsonpCallback="BDM_CDN_BADGES_CALLBACK"):"QUEST_TRANSLATED"===a.pattern_id?(a.translated=!0,b.jsonpCallback="BDM_CDN_QUEST_CALLBACK"):-1!==wc.inArray(a.pattern_id,this.quest_translatable_request_ids)&&(a.translatable=!0,this.translation_requested||this.fetch_translated_quests()));d(a,b)};ib.prototype.get_translation_url=function(a){return this.translation_root_url+
"/"+a+"/"+this.active_language_code+".js"};ib.prototype.process_success=function(a,b,d){if(a.translatable)this.translation_deferred.done(function(c){b=this.translate_nlc_objects(b,c);d(a,b)});else{if(a.translated){var c=this.build_nlc_id_map(b.data[0]);this.translation_deferred.resolveWith(this,[c])}d(a,b)}};ib.prototype.build_nlc_id_map=function(a){var b={};c.each(a,function(a){"named_level_collection"===a.resource_name&&(b[a.id]=a)});return b};ib.prototype.translate_nlc_objects=function(a,b){var d=
a.data[0];wc.isArray(d)||(d=[d]);c.each(d,function(a){if("named_level_collection"===a.resource_name){var d=b[a.id];d&&wc.extend(!0,a,d)}});return a};ib.prototype.fetch_translated_quests=function(){var a=this.get_translation_url("quests");this.transport.push("GET",a);this.translation_requested=!0};(c.auth={}).Auth=function(){};c.auth.bigdoor={};var y=function(a,b){Bg.call(this);this.app=a;this.api=b;this.sessions=a.sessions;var d=this.app.spec.bigdoor.auth;if(!d||!d.provider_shortname||!d.provider_name)throw new bk("No auth provider defined");
this.is_streamlined_status=d.is_streamlined_status||!1;this.provider_name=d.provider_name;this.provider_shortname=d.provider_shortname;this.provider_cookiename=d.provider_cookiename||"BDACWE";this.login_redirect_url=d.redirect_login_url;this.logout_redirect_url=d.redirect_logout_url;this.redirect_current_url_param=d.redirect_current_url_param;this.sso_modal_trigger=d.sso_modal_trigger;this.is_publisher_auth="publisher"===this.provider_name;this.is_multi_oauth=!this.is_publisher_auth&&-1!==this.provider_name.indexOf(",");
this.is_oauth_redirects_fetched=jb.observable(!0);this.oauth_login_flow=d.oauth_login_flow||"popup";c.testmode.is_in_test_mode()&&(this.provider_shortname=this.provider_name="test",this.logout_redirect_url=this.login_redirect_url=void 0,this.is_publisher_auth=this.is_multi_oauth=!1);if(this.is_multi_oauth){this.multi_auth_provider_names=this.provider_name.replace(" ","").split(",");this.multi_auth_provider_shortnames=this.provider_shortname.replace(" ","").split(",");var d=this.get_session_auth_provider(),
g=c.url.params.bd_multi_oauth,f=window.parent&&window.parent!==window&&window.parent.location.href,f=f&&c.url.get_param("bd_multi_oauth",f);this.provider_name=(g=g||f)?g:d?d:this.multi_auth_provider_names[0];this.provider_shortname=this.get_shortname_for_provider(this.provider_name)}this._curr_eul=jb.observable();d=this.sessions.local.read();g=d[this.provider_shortname+"-id"];this.user_id=jb.observable(g);g&&d["curr-eul"]!==g&&(this._curr_eul(g),this.sessions.local.write({"curr-eul":g}));this.is_anonymous=
jb.observable(!("anonymous"in d)||"true"==d.anonymous||!0===d.anonymous);this.is_anonymous.subscribe(this.on_is_anonymous,this);this.user_id.subscribe(this.on_user_id,this);this.auth_cookie_found=jb.observable(!1);this.force_publisher_login=jb.observable(!1);if(this.is_publisher_auth){this.get_bdacwe_auth_cache();d=c.util.get_cookie_value(this.provider_cookiename);this.auth_cookie_found(!!d);!this.is_anonymous()&&(!this.auth_cookie_found()&&!this.is_auth_string_on_page())&&this.user_id(null);d=s(document.body).hasClass("bd-third-party");
if(this.is_anonymous()&&(d||this.auth_cookie_found()||this.is_auth_string_on_page()))this.is_anonymous(!1),this.force_publisher_login(!0);c.subscribe("app.post.data",s.proxy(function(){if(this.user.is_new()){c.trigger("new.user",this.user);c.trigger("analytics",["new_user"])}if(this._defer_signin_event){c.trigger("signin",this.user);c.trigger("analytics",["login_complete"])}},this))}this.repeat_authenticated_user=jb.observable();this.authenticating=jb.observable(!1);this.profile_modified=void 0},
s=c.$,jb=c.ko,ck=c.async,dk=c.curry,re=c.storage,Bg=c.Watchable,bk=c.error.EconomyConfigurationError;c.auth.bigdoor.BigDoorOAuth=Bg.extend(y);y.create=function(a,b,d,c){return(new y(a,b)).init(d,c)};y.prototype._callbacks=function(a){this.hasOwnProperty("subscriptions")||(this.subscriptions={});var b=this.subscriptions[a];b||(b=this.subscriptions[a]=s.Callbacks("unique"));return b};y.prototype.subscribe=function(a,b){this._callbacks(a).add(b)};y.prototype.unsubscribe=function(a,b){this._callbacks(a).remove(b)};
y.prototype.publish=function(a){var b=this._callbacks(a);b.fire.apply(b,[].slice.call(arguments,1))};y.prototype.on_is_anonymous=function(a){this.write_anonymous(a)};y.prototype.on_user_id=function(a){this.write_id(a)};y.prototype.make_anonymous=function(a){this.remove_bdacwe_auth_cache();a?"string"===typeof a&&(a=c.model.User.anonymous_data(a)):a=c.model.User.anonymous_data();this.update_user(new c.model.User(a),!0)};y.prototype.make_authenticated=function(a){this.update_user(a,!1)};y.prototype.init=
function(a,b){this.authenticating(!0);var d=this.is_anonymous(),g=this.user_id(),b=b||this;this.is_publisher_auth&&this.force_publisher_login()&&(g=null);var f=a,a=s.proxy(function(){this.authenticating(!1);s.isFunction(f)&&f.apply(b||this,arguments)},this);this.user=new c.model.User({});c.url.params.bd_auth_redirect?this.check_authenticated_user(!0,a,b):d&&g?this.check_anonymous_user(g,a,b):!d&&g?this.check_authenticated_user(g,!1,a,b):this.check_authenticated_user(!1,a,b);return this};y.prototype.check_authenticated_user=
function(a,b,d,g){var f=s.proxy(function(a,b){if(b&&b.user)b.profile||(b.profile=new c.model.UserProfile({})),b.profile=new c.model.UserProfile(s.extend({},b.profile.data())),b.user.set_profile(b.profile),this.complete_login(b.user,!1,d,g);else{var f=!1;this.is_publisher_auth&&(!this.is_anonymous()&&!this.auth_cookie_found()&&!this.is_auth_string_on_page())&&(f=!0);this.user&&this.user.data()&&this.user.data().end_user_login?this.make_anonymous(this.user.data()):this.make_anonymous();f&&c.trigger("signout");
s.isFunction(d)&&d.call(g,this,this.user)}},this),h=this,i=window.parent&&window.parent!==window&&window.parent.location.href;if("boolean"===typeof a){g=d;d=b;b=a;if(this.is_publisher_auth&&this.is_anonymous()&&!this.auth_cookie_found()&&!this.is_auth_string_on_page()&&!this.force_publisher_login()){f();return}if(this.is_multi_oauth&&!this.get_session_auth_provider()&&i&&-1===i.indexOf("checkpoint-url")){f();return}this.repeat_authenticated_user(!1)}else this.repeat_authenticated_user(!0);ck.waterfall([function(a){h.status(function(b,
d){b?a(null,b):a(d,null)},h)},function(a,b){h.profile(a.end_user_login(),function(d){b(null,{user:a,profile:d})},h)}],f)};y.prototype.write_id=function(a){var b=this.sessions.local.read("curr-eul")||this._curr_eul(),d={};if((d[this.provider_shortname+"-id"]=a)&&a!==b)this._curr_eul(a),d["curr-eul"]=a,d["last-eul"]=b;this.sessions.local.write(d)};y.prototype.get_shortname_for_provider=function(a){if(!this.is_multi_oauth)return this.provider_shortname;var b;s.each(this.multi_auth_provider_names,s.proxy(function(d,
c){c===a&&(b=d)},this));return this.multi_auth_provider_shortnames[b]};y.prototype.set_session_auth_provider=function(a){var b={};this.provider_name!==a&&(b[this.provider_shortname+"-id"]="",this.provider_name=a,this.provider_shortname=this.get_shortname_for_provider(a));b[this.provider_shortname+"-id"]=this.user_id();b.multiauth=this.provider_name;this.sessions.local.write(b)};y.prototype.get_session_auth_provider=function(){return this.sessions.local.read("multiauth")};y.prototype.write_anonymous=
function(a){this.sessions.local.write({anonymous:!!a})};y.prototype.status=function(a,b){var d={};this.is_publisher_auth&&this.user_id()&&(d.prev_end_user_login=this.user_id());this.is_streamlined_status&&(d.verbosity=5);this.app.bigdoor.fetch("auth/"+this.provider_name+"/status",d,function(d,f,h){this.profile_modified=d&&d.profile_modified;if(d)d=new c.model.User(d);else if(f!=="success"&&h.code!=401){this.app.error();return}s.isFunction(a)&&a.call(b||this,d,f,h)},this)};y.prototype.profile=function(a,
b,d){this.app.bigdoor.end_user_profile.query({end_user_login:a,provider:this.is_publisher_auth?this.app.spec.bigdoor.app_key:"publisher"},function(c,f,h){404===h.code&&!this.is_publisher_auth?this.app.bigdoor.end_user_profile.create({end_user_login:a},{},function(a,c,g){s.isFunction(b)&&b.call(d||this,a,c,g)},this):s.isFunction(b)&&b.call(d||this,c,f,h)},this)};y.prototype.check_anonymous_user=function(a,b,d){this.make_anonymous(a);this.app.providers.economycache?this.app.providers.economycache.set_user_from_cache(b,
d):this.app.bigdoor.end_user.get(a,s.proxy(function(a){a?this.make_anonymous(a.data()):this.make_anonymous(this.user_id());s.isFunction(b)&&b.call(d,this,this.user)},this))};y.prototype.login=function(){if(this.is_anonymous())if(c.trigger("analytics",["login_attempt"]),this.login_redirect_url){var a=this.login_redirect_url;this.redirect_current_url_param&&(a+=-1===a.indexOf("?")?"?":"&",a+=this.redirect_current_url_param+"=",a+=encodeURIComponent(window.location.href));window.location.href=a}else this.is_publisher_auth?
this.is_auth_string_on_page()&&(this.authenticating(!0),this.check_authenticated_user(!1,function(){this.authenticating(false)},this)):this.is_multi_oauth?(a=this.sso_modal_trigger.replace(" ","").split(","),s.each(a,s.proxy(function(a,d){(d="string"==s.type(d)?c.util.walk.callable(d,this):d)&&s.isFunction(d)&&d.call(this)},this))):this.oauth_popup_login(this.provider_name)};y.prototype.oauth_popup_login=function(a){this.is_multi_oauth&&this.set_session_auth_provider(a);var b="single_page"!==this.oauth_login_flow,
d="",c={},d=[this.app.bigdoor.protocol+"/",this.app.bigdoor.hostname,this.app.bigdoor.root,this.app.bigdoor.app_key,"auth",a];this.user_id()&&(d.push("end_user"),d.push(this.user_id()));d=d.join("/");if(b){c.flow="popup";var d=d+("?"+s.param(c)),f=window.open(d,"","height=400,width=640"),h=s.proxy(function(a,b){if(f&&f.closed){this.authenticating(true);s.isFunction(a)&&a.call(b)}else setTimeout(function(){h(a,b)},300)},this);setTimeout(s.proxy(function(){h(s.proxy(dk(this.check_authenticated_user,
true,function(){this.authenticating(false)},this),this))},this),300)}else b=window.location.href.split("#"),a=b[0],a+=-1===a.indexOf("?")?"?":"&",b[0]=a+"bd_auth_redirect=1",a=b.join("#"),a=encodeURIComponent(a),c.flow="single_page",c.final_url=a,window.location.href=d+"?"+s.param(c)};y.prototype.complete_login=function(a,b,d,g){this.make_authenticated(a);s.isFunction(d)&&d.call(g,this,a);this.repeat_authenticated_user()||(this.is_publisher_auth?this._defer_signin_event=!0:(c.trigger("signin",{provider:this.provider_name,
user:this.user,is_manual_login:b}),c.trigger("analytics",["login_complete"])));c.language&&(c.language.active&&this.sessions.remote.read("lang")!==c.language.active)&&this.sessions.remote.write({lang:c.language.active})};y.prototype.update_user=function(a,b){var d=this.user.end_user_login()&&this.user.end_user_login()!==a.end_user_login();d&&this.publish("user_changing",this.user);c.model.User.call(this.user,a.data());this.user_id(this.user.end_user_login());this.is_anonymous(b);if(a.profile()){var g=
a.profile().data();c.model.UserProfile.call(this.app.sessions.remote.profile,g)}else this.app.sessions.remote.profile&&this.app.sessions.remote.profile.clear();this.user.is_new()&&c.trigger("new.user",this.user);d&&this.publish("user_changed",this.user);return this.user};y.prototype.logout=function(a,b){if(this.logout_redirect_url){var d=this.logout_redirect_url;this.redirect_current_url_param&&(d+=-1===d.indexOf("?")?"?":"&",d+=this.redirect_current_url_param+"=",d+=encodeURIComponent(window.location.href));
window.location.href=d}else if(this.is_publisher_auth)this.make_anonymous();else{this.authenticating(!0);var g=a,a=s.proxy(function(){this.authenticating(!1);s.isFunction(g)&&g.apply(b||this,arguments);c.trigger("signout")},this);this.api.fetch("auth/"+this.provider_name+"/logout",function(d,c,g){this.make_anonymous();s.isFunction(a)&&a.call(b||this,d,c,g)},this)}};y.prototype.is_auth_string_on_page=function(){return!(!window.BDACWE||!window.BDACWE.length)};y.prototype.is_multi_auth_provider=function(a){if(a&&
this.is_multi_oauth){for(var b=this.multi_auth_provider_names,d=0;d<b.length;d++)if(a==b[d])return!0;return!1}};y.prototype.get_bdacwe_auth_cache=function(a,b){var d=re.get_storage("BDACWE");d&&(window.BDACWE=d);s.isFunction(a)&&a.call(b||this,d)};y.prototype.set_bdacwe_auth_cache=function(a,b,d){re.set_storage("BDACWE",a);window.BDACWE=a;s.isFunction(b)&&b.call(d||this)};y.prototype.remove_bdacwe_auth_cache=function(a,b){re.destroy_storage("BDACWE");window.BDACWE=void 0;s.isFunction(a)&&a.call(b||
this)};var B=function(a){a&&(!this.hasOwnProperty("app")&&c.app.current()&&(this.app=c.app.current()),this.hasOwnProperty("data")||(this.data=jd.observable()),this.data(a||{}))},Qa=c.$,jd=c.ko,se=c.curry,Cg=c.first,ek=c.filter,fk=c.map,Dg=c.util.walk,gk=c.util.convert,hk=c.pool.ModelPool,Eg=c.Watchable;(c.model={}).Model=Eg.extend(B);B.hash=function(a){return Dg("id",a)};B.save=function(a){return this.pool.save(a)};B.extend=function(a){Eg.extend.call(this,a);a.pool=new hk(a);return a};B.uri=function(a,
b){var d=Qa.type(b),c=[];a&&c.push(a);if(b&&("string"==d||"number"==d))b=b.toString(),"[object Object]"!=b&&c.push(b);return c.join("/")};B.field=function(a,b,d){b=Qa.isFunction(b)?b:gk.value;this.prototype[a]=function(){this[a]=jd.computed({owner:this,read:function(){return b(this.data()[a])},write:function(b){this.data()[a]=b;return this[a].evaluate()}}).extend(d);return this[a]()};return this};B.one=function(a,b,d,c){d=Qa.isFunction(d)?d:this.one.getter;d=se(d,a,b);this.prototype[a]=function(){this[a]=
jd.computed(d,this).extend(c);return this[a]()};return this};B.one.getter=function(a,b){var d=this.data()[a];d&&!(d instanceof b)&&(d=this.data()[a]=b.save(d));return d};B.many=function(a,b,d,c){d=Qa.isFunction(d)?d:B.many.getter;d=se(d,a,b);this.prototype[a]=function(){this[a]=jd.computed(d,this).extend(c);return this[a]()};return this};B.many.getter=function(a,b,d){a=this.data()[a]||[];Qa.isArray(a)||(a=[a]);a[0]instanceof b||(a=fk(a,function(a){if(!Qa.isFunction(d)||d.call(this,a))return b.save(a)},
this));return a};var ik=function(a,b,d){var c=b?b.friendly_id:void 0,c=Qa.isFunction(c)?c.call(b):c;return a&&c===a?d:!1};B.attribute=function(a,b,d){Qa.isFunction(b)||(b=se(ik,b));return Cg(Dg("attributes",a),function(c){return b.call(d,c,a)})};B.handle_by_attribute=function(a,b,d,c){a=a||[];Qa.isArray(a)||(a=[a]);return b.call(this,a,function(a){return B.attribute(a,d,c||this)})};B.filter_by_attribute=function(a,b,d){return B.handle_by_attribute(a,ek,b,d)};B.exclude_by_attribute=function(a,b){for(var d=
[],c=0;c<a.length;c++)B.attribute(a[c],b)||d.push(a[c]);return d};B.get_by_attribute=function(a,b,d){return B.handle_by_attribute(a,Cg,b,d)};var kb=function(a){this.opts=a=a||{};this.transport=a.transport||new jk(a.transport_options);this.hostname=a.hostname||location.hostname;!a.port&&this.hostname==location.hostname&&(this.port=location.port);this.port=a.port||this.port||"80";this.root=a.root||"";this.protocol=a.protocol||location.protocol;this.protocol="file:"==this.protocol?"http":this.protocol;
this.transport.timeout=a.timeout;kb.register(this)},kk=c.$,jk=c.transport.rest.JsonRest,lk=c.api={},mk=c.api;kb.register=function(a){for(var b in this.models)a.register(b,this.models[b])};kb.associate=function(a,b){this.models=this.models||{};1==arguments.length&&a.name&&(b=a,a=b.name);this.models[a]=b;return this};kb.prototype.baseuri=function(){return[this.protocol+"/",this.hostname+("80"==this.port?"":":"+this.port),this.root].join("/")};kb.prototype.uri=function(a){return this.baseuri()+(a?"/"+
a:"")};kb.prototype.request=function(){var a=this.transport.request.apply(this.transport,arguments);a.uri&&(a.uri=this.uri(a.uri));return a};kb.prototype.register=function(a,b){kk.isFunction(b)?this[a]=new lk.bridge.Bridge(this,b):(b=b||{},this[a]=new b.bridge(this,b.model));return this};mk.Api=kb;var qa=function(a){a=a||{};a.transport=a.transport||new Fg(a.transport_options);a.protocol="string"===typeof a.protocol?a.protocol:"http:";a.hostname=a.hostname||"api.bigdoor.com";a.root=a.root||"api/publisher";
Xb.call(this,a);this.app_key=a.app_key;this.verbosity="verbosity"in a?a.verbosity:9;qa.register(this)},Gg=function(a,b){return xc.isFunction(b.save)?b.save(a):a instanceof b?a:new b(a)},xc=c.$,Hg=c.curry,nk=c.error.ValueError,Fg=c.transport.rest.JsonRest,ok=c.model.Model,Xb=c.api.Api,pk=c.api;qa.prototype=new Xb;qa.associate=Xb.associate;qa.register=Xb.register;qa.prototype.baseuri=function(){if(!this.app_key)throw new nk("Could not locate a BigDoor api key.");return Xb.prototype.baseuri.call(this)+
"/"+this.app_key+(this.transport instanceof Fg?"/proxy":"")};qa.prototype.request=function(){var a=Xb.prototype.request.apply(this,arguments);a.method=a.method||"GET";a.query=a.query||{};if("POST"==a.method||"PUT"==a.method)a.query.non_secure=1;!a.query.verbosity&&this.verbosity&&(a.query.verbosity=this.verbosity);return a};qa.prototype.push=function(){var a,b;b=Array.prototype.slice.call(arguments);b[0]&&b[0].prototype instanceof ok&&(a=b.shift());b=this.request.apply(this,b);a&&(b.model=a);this.transport.push(b.method,
b.uri,b.query,b.payload,Hg(this.complete,b),this)};qa.prototype.fetch=Hg(qa.prototype.push,"GET");qa.prototype.complete=function(a,b,d,c){xc.isFunction(a.callback)&&(xc.isArray(c)&&(c=c[0]),a.model&&(c=this.convert(c,a.model)),a.callback.call(a.context||this,c,b,d))};qa.prototype.convert=function(a,b){return xc.isArray(a)?xc.map(a,function(a){return Gg(a,b)}):a?Gg(a,b):a};pk.BigDoor=qa;var yc=function(a,b){this.api=a;this.model=b},qk=c.$,rk=c.api.bridge={};yc.prototype.get=function(a,b,d){this.api.push(this.model,
"GET",this.model.uri(a),b,d)};yc.prototype.query=function(a,b,d,c){qk.isFunction(b)&&(c=d,d=b,b=a,a=void 0);a=this.model.uri(a?a:b);this.api.push(this.model,"GET",a,b,d,c)};yc.prototype.create=function(a,b,d,c){this.api.push(this.model,"POST",this.model.uri(a),{},b,d,c)};yc.prototype.update=function(a,b,d,c){this.api.push(this.model,"PUT",this.model.uri(a),{},b,d,c)};rk.Bridge=yc;var zc=function(){Ig.apply(this,arguments);this.queue=[];this.in_progress=!1;this.verbosity=this.api.opts.ntge_verbosity||
3},te=c.$,Ig=c.api.bridge.Bridge,sk=c.api.bridge;zc.prototype=new Ig;zc.prototype.run=function(){if(!this.in_progress){var a=this.queue.shift();a&&(this.in_progress=!0,a())}};zc.prototype.on_complete=function(a,b){this.in_progress=!1;this.run();te.isFunction(a)&&a.apply(b||this,Array.prototype.slice.call(arguments,2))};zc.prototype.create=function(a,b,d,g){var f={verbosity:this.verbosity};te.isFunction(b)&&(g=d,d=b,b=void 0);b=b||{};this.queue.push(te.proxy(function(){this.api.push(this.model,"POST",
this.model.uri(a),f,b,c.curry(this.on_complete,d,g),this)},this));this.run()};sk.SerializedExecuteBridge=zc;var ve=function(){ue.apply(this,arguments)},tk=c.$,ue=c.api.bridge.Bridge,uk=c.api.bridge;ve.prototype=new ue;ve.prototype.query=function(a,b,d){tk.isFunction(a)&&(d=b,b=a,a=void 0);a=a||{};ue.prototype.query.call(this,a,b,d)};uk.QuestBridge=ve;var Ra=function(){Ac.apply(this,arguments);var a=this.api&&this.api.opts||c.load.options.config.bigdoor;this.is_remote_store_enabled=a.profile_bridge&&
a.profile_bridge.is_remote_store_enabled||!1;this.ignore_cached_data=a.profile_bridge&&a.profile_bridge.ignore_cached_data||!1;c.subscribe("signout",function(){kd.clear_storage("profile")},this)},ra=c.$,Ac=c.api.bridge.Bridge,vk=c.api.bridge,kd=c.storage;Ra.prototype=new Ac;Ra.prototype.create_cache_key=function(a){a=a||{};return this.model.uri(a)};Ra.prototype.convert_response_to_instance=function(a){a=a.data||{};ra.isArray(a)&&(a=a[0]);return a=this.api.convert(a,this.model)};Ra.prototype.sanitize_payload_data=
function(a){a=a||{};a.hasOwnProperty("email")&&0===a.email.length&&delete a.email;return a};Ra.prototype.query=function(a,b,d){ra.isFunction(a)&&(d=b,b=a,a=void 0);var a=a||{},g,f=this.create_cache_key(a),h,i=ra.proxy(function(){var f=h&&h.data&&h.data[0].profile_modified,i=c.app.current().auth.profile_modified;f&&(i&&f!==i)&&(h=null);if(h)if(g=this.convert_response_to_instance(h)){ra.isFunction(b)&&b.call(d||this,g,"success",h);return}Ac.prototype.query.call(this,a,function(c,g,f,h){this.caching_callback_wrapper(c,
g,f,h,a,b,d)},this)},this);this.ignore_cached_data?(h=null,i()):this.is_remote_store_enabled?c.remote_storage.get(f,ra.proxy(function(a,b){h=b;i()},this)):(h=kd.get_storage(f,"profile"),i())};Ra.prototype.update=function(a,b,d,g){var f=this.create_cache_key(a),h,b=this.sanitize_payload_data(b),i=ra.proxy(function(){if(h){var f=this.convert_response_to_instance(h);if(c.util.are_equal_objects(f.data(),b)){ra.isFunction(d)&&d.call(g||this,f,"success",h);return}}Ac.prototype.update.call(this,a,b,function(b,
c,f,e){this.caching_callback_wrapper(b,c,f,e,a,d,g)},this)},this);this.is_remote_store_enabled?c.remote_storage.get(f,ra.proxy(function(a,b){h=b;i()},this)):(h=kd.get_storage(f,"profile"),i())};Ra.prototype.create=function(a,b,d,c){b=this.sanitize_payload_data(b);Ac.prototype.create.call(this,a,b,function(b,h,i,j){this.caching_callback_wrapper(b,h,i,j,a,d,c)},this)};Ra.prototype.caching_callback_wrapper=function(a,b,d,g,f,h,i){g=this.create_cache_key(f);if("success"===b){201===d.code&&!c.app.current().auth.is_publisher_auth&&
(g=this.create_cache_key({end_user_login:f.end_user_login,provider:"publisher"}));if(this.is_remote_store_enabled){c.remote_storage.set(g,d,ra.proxy(function(){ra.isFunction(h)&&h.call(i||this,a,b,d)},this));return}kd.set_storage(g,d,null,"profile")}ra.isFunction(h)&&h.call(i||this,a,b,d)};vk.UserProfileBridge=Ra;var m=function(a){a=a||{};Jg.call(this,a);this.spec=a;this.bigdoor=new wk(a.bigdoor);this.sessions=a.sessions;this.define("mobile",!!c.device.mobile);this.define("is_initialized",!1);this.define("state",
"normal");this.media=G.extend({},this.media,a.media);this.options=G.extend({},this.options,a.options);this.vars=G.extend({},this.vars,a.vars||{});this.providers={};this.widgets={};G.isArray(a.steps)?this.steps=a.steps:a.steps?this.steps=[a.steps]:this.hasOwnProperty("steps")||(this.steps=this.steps.slice(0));this.themes=a.themes||{};a.theme&&(this.themes.index=a.theme);this.options.tracking&&(this.tracker=new xk(this,this.options.tracking));!0!==this.options.disable_facebook&&(a=this.spec.options&&
this.spec.options.facebook_app_id,this.facebook=new yk(this.spec.facebook||{app_id:a}));this.abby_normal_url=this.options.abby_normal_url||"//healthy.loyalty.bigdoor.com/abby_normal.gif"},G=c.$,zk=c.ko,Ak=c.bind,lb=c.each,Bk=c.map,we=c.async,Kg=c.util.walk,yk=c.util.Facebook,Ck=c.auth,Jg=c.Watchable,xk=c.tracker.EventTracker,Lg=c.session.remote_storage.CrossDomainState,Mg=c.session.cookie.StateCookie,Dk=c.session.profile.ProfileSession,wk=c.api.BigDoor,xe=c.app={},ye;xe.current=function(a){if(a||
null===a)ye=a;return ye};xe.current.unset=function(){ye=void 0};m.start=function(a,b,d){var c=this;we.waterfall([function(b){m.setup_sessions(a,b,c)},function(a,b){m.setup_ab_tests(a,b,c)}],G.proxy(function(a,c){return xe.current(new m(c)).init(b,d)},this))};m.setup_sessions=function(a,b,d){for(var g=[],f=document.domain.split(".");2<f.length;)f.shift();var h={remote:new Dk({profile:new c.model.UserProfile({})}),local:{}};a.cross_domain_local_state?g.push(G.proxy(function(b){h.local=new Lg(a.cookie||
"bd-local",{domain:"."+f.join("."),expires:a.cookie_expires_in_days||1825},function(a){h.local=a;b()})},this)):g.push(G.proxy(function(b){h.local=new Mg(a.cookie||"bd-local",{domain:"."+f.join("."),expires:a.cookie_expires_in_days||1825});b()},this));if(a.cookies){var i=G.proxy(function(b){var d=a.cookies[k],c=d.name||"bd-"+k;d.domain=d.domain||"."+f.join(".");var g=new Lg(c,d,G.proxy(function(){h[k]=g;b()},this))},this),j=G.proxy(function(b){var d=a.cookies[k],c=d.name||"bd-"+k;d.domain=d.domain||
"."+f.join(".");d=new Mg(c,d);h[k]=d;b()},this),k;for(k in a.cookies)a.cross_domain_local_state?g.push(i):g.push(j)}we.waterfall(g,G.proxy(function(){a=G.extend(!0,a,{sessions:h});b.call(d||this,null,a)},this))};m.setup_ab_tests=function(a,b,d){c.abtest=new c.util.ABTest(a);c.abtest.init(G.proxy(function(a){b.call(d||this,null,a)},this))};m.init=function(a,b,d){var c=this,f=Bk(a,function(a){return function(b){a.init?a.init(function(){b()}):b()}});we.parallel(f,function(){b.call(d||c,c,a)})};c.Application=
Jg.extend(m);m.prototype.cookie="bd-state";m.prototype.media={};m.prototype.options={};m.prototype.vars={home:location.protocol+"//"+location.host,page:location.protocol+"//"+location.host+location.pathname,dates:c.util.dates.default_strings};m.prototype.steps="include economy_cache authorize bucket_setup construct data render actions".split(" ");m.prototype.is_valid=function(){var a=!1;this.spec.blacklist_regex&&(a=RegExp(this.spec.blacklist_regex).test(window.location.href));return!this.is_initialized()&&
!a&&"bdm_checkpoint_target"!==window.name&&(!this.mobile()||!1!==this.spec.mobile)};m.prototype.subscribe=function(a,b,d){a&&G.isFunction(b)&&c.subscribe("app."+a,Ak(this,function(a,c){c===this&&b.apply(d||this,arguments)}))};m.prototype.init=function(a,b){a=a||function(){};b=b||this;if(this.is_valid()){m.prototype.pre_init();c.testmode.update_test_mode_state();this.steps_remaining=this.steps.slice(0);var d=function(){"error"!==this.state()&&(1>this.steps_remaining.length?(this.post_init(),a.call(b,
this)):this[this.steps_remaining.shift()].call(this,d,this))};d.call(this)}else a.call(b,this)};m.prototype.pre_init=function(){c.performance.start("init");c.trigger("app.pre.init",this)};m.prototype.post_init=function(){this.is_initialized(!0);c.trigger("app.post.init",this);c.performance.stop("init")};m.prototype.include=function(a,b){this.pre_include();this.media.hide_until_styles_ready&&c.load.style&&c.load.style(".bd-gambit-container { display: none; }");this.media.styles&&lb(this.media.styles,
function(a){c.load.css(a)});this.media.theme&&lb(this.media.theme,function(a){c.load.css(a)});this.post_include();a.call(b||this,this)};m.prototype.pre_include=function(){c.trigger("app.pre.include",this)};m.prototype.post_include=function(){c.trigger("app.post.include",this)};m.prototype.restore_state=function(a,b){c.remote_storage&&!window.BDACWE?c.remote_storage.get("BDACWE",function(d,c){c&&(window.BDACWE=c);a.call(b||this,this)}):a.call(b||this,this)};m.prototype.construct=function(a,b){this.pre_construct();
zk.setTemplateEngine(new c.TemplateEngine(this));this.construct_providers();this.construct_widgets();this.post_construct();a.call(b||this,this);return this};m.prototype.pre_construct=function(){c.trigger("app.pre.construct",this)};m.prototype.find_type=function(a,b){var d=Kg.context(a,b);if(!d||!G.isFunction(d.value))d=Kg(a,window);if(d&&G.isFunction(d.value))return d.value};m.prototype.construct_item=function(a,b){b.options=b.options||{};if(a&&(!this.mobile()||!1!==b.options.mobile))return new a(b.options||
{},this)};m.prototype.construct_providers=function(){this.providers=this.providers||{};lb(this.spec.providers||{},function(a,b){if("economycache"!==b){var d=this.find_type(a.type,c.controller.provider);d&&(this.providers[b]=this.construct_item(d,a))}},this)};m.prototype.construct_widgets=function(){lb(this.spec.render||{},function(a){var b=this.spec.widgets[a];if(b){var d=this.find_type(b.type||"Widget",c.controller.widget);b.options.state=b.options.state||d.prototype.init_state;d&&(this.widgets[a]=
this.construct_item(d,b))}},this);lb(this.spec.render,function(a){this.widgets[a].associate()},this)};m.prototype.post_construct=function(){c.trigger("app.post.construct",this)};m.prototype.error=function(){this.state("error");c.trigger("app.error",this)};m.prototype.pre_economy_cache=function(){c.trigger("app.pre.economy_cache",this)};m.prototype.post_economy_cache=function(){c.trigger("app.post.economy_cache",this)};m.prototype.economy_cache=function(a,b){this.pre_economy_cache();this.spec.providers.economycache&&
(this.providers.economycache=this.construct_item(c.controller.provider.EconomyCache,this.spec.providers.economycache));this.post_economy_cache();a.call(b||this,this)};m.prototype.authorize=function(a,b){this.pre_authorize();this.auth=new Ck.bigdoor.BigDoorOAuth(this,this.bigdoor);m.init.call(this,[this.auth],function(){"error"!==this.state()&&(this.post_authorize(),a.call(b||this,this))})};m.prototype.pre_authorize=function(){c.performance.start("authorize");c.trigger("app.pre.authorize",this)};m.prototype.post_authorize=
function(){c.trigger("app.post.authorize",this);c.performance.stop("authorize")};m.prototype.pre_bucket_setup=function(){c.trigger("app.pre.bucket_setup",this)};m.prototype.post_bucket_setup=function(){c.trigger("app.post.bucket_setup",this)};m.prototype.bucket_setup=function(a,b){this.pre_bucket_setup();this.bucket=new c.bucket.BucketManager(this);var d=this,g=function(){d.update_app_with_bucket_state();d.post_bucket_setup();a.call(b||d,d)};if(-1!==window.parent.location.href.indexOf("checkpoint-url"))this.bucket._current_bucket=
"exposed",g();else{var f=function(a){d.bucket.update_bucket_state(a.bucket,a.expiration,a.vary,g,d)};!this.auth.is_anonymous()&&this.bucket.is_api_profile_buckets_enabled()?this.bucket._get_bucket_data_from_api_storage(f,d):this.bucket._get_bucket_data_from_browser_storage(f,d)}};m.prototype.update_app_with_bucket_state=function(){var a=this.bucket.is_in_control_bucket(),b=this.bucket.is_in_opted_out_bucket();if(this.bucket.is_in_disregard_bucket())this.steps_remaining=[];else{if(a||b){var d=this.spec,
g={},f={},h=[];if(a||b)g.OptIn=!0;a&&(g.Checkin=!0);G.each(d.widgets,function(a,b){if(g[b.type||"Widget"]){f[a]=b;h.push(a)}});this.spec.widgets=f;this.spec.render=h;this.spec.render.length||(this.steps_remaining=c.filter(this.steps_remaining,function(a){return a!=="include"}))}b&&(this.spec.providers={},this.steps_remaining=c.filter(this.steps_remaining,function(a){return"data"!==a}))}};m.prototype._render=function(a,b){this.pre_render();lb(this.spec.render,function(a){this.widgets[a].render()},
this);c.trigger("app.render");this.post_render();a.call(b||this,this)};m.prototype.render=function(a,b){document.body?this._render(a,b):G(document).ready(G.proxy(function(){this._render(a,b)},this))};m.prototype.pre_render=function(){c.performance.start("render");c.trigger("app.pre.render",this)};m.prototype.post_render=function(){c.trigger("app.post.render",this);c.performance.stop("render");c.performance.stop("load_and_render")};m.prototype.data=function(a,b){this.pre_data();var d=[];lb(this.providers,
function(a){d.push(a)});m.init.call(this,d,function(){this.post_data();a.call(b||this,this)})};m.prototype.pre_data=function(){c.trigger("app.pre.data",this)};m.prototype.post_data=function(){c.trigger("app.post.data",this)};m.prototype.actions=function(a,b){this.pre_actions();this.run_actions(this.providers,function(){this.run_actions(this.widgets,function(){this.post_actions();a.call(b||this,this)})})};m.prototype.pre_actions=function(){c.trigger("app.pre.actions",this)};m.prototype.run_actions=
function(a,b,d){var c=[];lb(a,function(a){G.isFunction(a.actions)&&c.push(a)});if(0<c.length){var f,h=function(){1>c.length?b&&b.call(d||this):(f=c.shift(),f.actions(h,this))};h.call(this)}else b&&b.call(d||this)};m.prototype.post_actions=function(){c.trigger("app.post.actions",this);this.detect_bd_show_param()};m.prototype.detect_bd_show_param=function(){var a=c.url.params.bd_show;if(a){var b=a.split(":"),d;1<b.length&&(d=b[1],a=b[0]);a=a.toLowerCase();c.trigger(a+".show",d)}};m.prototype.call_abby_normal=
function(a){c._abnormal=!0;var b={app_key:this.spec.bigdoor.app_key,pub_id:this.spec.publisher_id,site_id:this.spec.site_id};this.auth&&this.auth.user&&(b.end_user_login=this.auth.user.end_user_login());a=G.param(G.extend(b,a));a=this.abby_normal_url+"?"+a;G(document.body).append('<img src="'+a+'" width="1" height="1" alt="">')};var Db=function(a){Ng.call(this,a)},Ng=c.model.Model;c.model.Titled=Ng.extend(Db);Db.field("end_user_title");Db.field("end_user_description");Db.field("pub_title");Db.field("pub_description");
Db.dependent("title",function(){return this.data().end_user_title||this.data().pub_title});Db.dependent("description",function(){return this.data().end_user_description||this.data().pub_description});var Sa=function(){return Og.apply(this,arguments)},Ek=c.curry,Pg=c.util.convert,Fk=c.api.BigDoor,Gk=c.model.Model,Og=c.model.Titled;c.model.Attribute=Og.extend(Sa);Sa.uri=Ek(Gk.uri,"attribute");Fk.associate("attribute",Sa);Sa.field("id");Sa.field("created_timestamp",Pg.timestamp);Sa.field("modified_timestamp",
Pg.timestamp);Sa.field("friendly_id");Sa.many("attributes",Sa);var ya=function(a){Qg.call(this,a)},Hk=c.curry,ld=c.util.convert,Ik=c.api.BigDoor,Jk=c.model.Model,Qg=c.model.Titled,Kk=c.model.Attribute;c.model.Url=Qg.extend(ya);ya.field("id");ya.field("created_timestamp",ld.timestamp);ya.field("modified_timestamp",ld.timestamp);ya.field("url");ya.field("is_for_end_user_ui",ld.integer);ya.field("is_media_url",ld.integer);ya.many("attributes",Kk);ya.dependent("is_image",function(){return this.is_for_end_user_ui()&&
this.is_media_url()});ya.uri=Hk(Jk.uri,"url");Ik.associate("url",ya);var la=function(a){Rg.call(this,a);if(a)return this},Lk=c.curry,Yb=c.util.convert,Mk=c.api.BigDoor,Nk=c.model.Model,Rg=c.model.Titled,Ok=c.model.Attribute,Pk=c.model.Url;c.model.Currency=Rg.extend(la);la.uri=Lk(Nk.uri,"currency");la.field("id",Yb.integer);la.field("created_timestamp",Yb.timestamp);la.field("modified_timestamp",Yb.timestamp);la.many("attributes",Ok);la.many("urls",Pk);la.field("exchange_rate",Yb.real);la.field("relative_weight",
Yb.integer);la.field("currency_type_id",Yb.integer);la.field("currency_type_title");Mk.associate("currency",la);var O=function(a){this.data?this.update(a):Zb.call(this,a);a&&this.define({fetching_inventory:!1})},Ta=function(a){Zb.call(this,a)},V=function(a){Zb.call(this,a)},Sg=c.$,Tg=c.curry,Q=c.util.convert,Qk=c.util.walk,Ug=c.api.BigDoor,$b=c.model.Model,Zb=c.model.Titled,ze=c.model.Attribute,Ae=c.model.Url,Be=c.model;Be.NamedGood=Zb.extend(O);O.pool.readonly=!1;O.field("id",Q.integer);O.field("created_timestamp",
Q.timestamp);O.field("modified_timestamp",Q.timestamp);O.field("relative_weight",Q.integer);O.many("attributes",ze);O.many("urls",Ae);O.field("available_start",Q.timestamp);O.field("available_end",Q.timestamp);O.field("total_inventory",Q.integer);O.computed("sold_inventory",function(){var a=this.total_inventory(),b=this.data().sold_inventory;if(null!=a)return Q.integer(b||0)});O.computed("associated_named_transaction_groups",function(){var a=this.data().associated_named_transaction_groups,b=c.model.NamedTransactionGroup;
return!a?[]:c.map(a,function(a){return b.save(a)})});O.uri=Tg($b.uri,"named_good");Ug.associate("named_good",O);O.computed("ntg_association_attributes",function(){return c.filter(this.attributes(),function(a){return 0===a.friendly_id().indexOf("ntg_association_")})});O.prototype.get_ntg_association_attribute=function(a){var b=this.ntg_association_attributes();return null!=a?$b.get_by_attribute(b,a):c.first(b,function(a){a=a.attributes();return!$b.get_by_attribute(a,"bdm-campaign-config")})};O.prototype.get_named_transaction_group=
function(a){if(a=this.get_ntg_association_attribute(a)){var b=a.friendly_id().split("_")[2],b=parseInt(b,10),a=this.associated_named_transaction_groups();return c.first(a,function(a){return a.id()===b})}};O.prototype.as_reward=function(a){var b=c.model.Reward,d=this.get_named_transaction_group(a);if(!d)throw Error("No named transaction group was found for campaign '"+a+"' on named good "+this.id());a=Sg.extend({},this.data(),{named_transaction_group_id:d.id(),currency_id:d.purchase_currency_id(),
default_amount:d.purchase_default_amount(),end_user_cap:d.end_user_cap(),end_user_cap_interval:d.end_user_cap_interval()});b=new b(a);b.provider=this.provider;return b};O.prototype.update=function(a){var b=this.data(),d=b.attributes||[],c=a.attributes||[],f={},b=b.associated_named_transaction_groups||[],h=a.associated_named_transaction_groups||[],i={},j,k;for(k=0;k<c.length;k++)j=c[k],f[j.id]=!0;d=d.slice();d.reverse();for(k=0;k<d.length;k++)j=d[k],f[j.id]||c.unshift(j);for(k=0;k<h.length;k++)d=h[k],
i[d.id]=!0;b=b.slice();b.reverse();for(k=0;k<b.length;k++)d=b[k],i[d.id]||h.unshift(d);this.data(a)};O.prototype.fetch_inventory=function(){if(!this.fetching_inventory()){this.fetching_inventory(!0);var a="named_good/"+(this.variant_named_good_id&&this.variant_named_good_id()||this.named_good_id())+"/inventory";this.app.bigdoor.fetch(a,{verbosity:5},function(a,d){this.fetching_inventory(!1);if("success"===d){var c=this.data();Sg.extend(!0,c,{sold_inventory:a.sold_inventory,total_inventory:a.total_inventory,
available_start:a.available_start,available_end:a.available_end});this.data(c)}},this)}};Be.NamedGoodCollection=Zb.extend(Ta);Ta.field("id",Q.integer);Ta.field("created_timestamp",Q.timestamp);Ta.field("modified_timestamp",Q.timestamp);Ta.field("relative_weight",Q.integer);Ta.many("attributes",ze);Ta.many("urls",Ae);Ta.uri=Tg($b.uri,"named_good_collection");Ug.associate("named_good_collection",Ta);Be.Good=Zb.extend(V);V.hash=function(a){return Qk("named_good_id",a)};V.field("created_timestamp",Q.timestamp);
V.field("modified_timestamp",Q.timestamp);V.field("named_good_id",Q.integer);V.field("relative_weight",Q.integer);V.many("attributes",ze);V.many("urls",Ae);V.field("redemption_code");V.field("named_transaction_group_id",Q.integer);V.field("named_transaction_id",Q.integer);V.field("campaign_id");V.dependent("preview",function(){return $b.get_by_attribute(this.urls(),"7a0670c7e0cb4bc280cc67276fce5754")});V.dependent("full",function(){return $b.get_by_attribute(this.urls(),"86836696b39347c789df0ac06966c724")});
var Ja=function(){return Vg.apply(this,arguments)},Bc=c.util.convert,Wg=c.util.walk,Rk=c.model,Vg=c.model.Titled;c.model.Balance=Vg.extend(Ja);Ja.hash=function(a){var b=Wg("user.end_user_login",a),a=Wg("currency_id",a);return(b?b+"_":"")+a};Ja.pool.readonly=!1;Ja.field("currency_id",Bc.integer);Ja.field("current_balance",Bc.integer);Ja.field("previous_balance",Bc.integer);Ja.field("adjustment_amount",Bc.integer);Ja.field("currency_adjusted",Bc.integer);Ja.one("user",void 0,function(){return Ja.one.getter.call(this,
"user",Rk.User)});var Xg=function(a){md.call(this,a)},Cc=function(a){nd.call(this,a);a&&(this.named_transaction_group=a.named_transaction_group)},Sk=c.$,Yg=c.curry,da=c.util.convert,Ce=c.api.BigDoor,Tk=c.api.bridge.SerializedExecuteBridge,Uk=c.app,Vk=c.error.ValueError,nd=c.model.Model,md=c.model.Titled,Wk=c.model.Attribute,Xk=c.model.Currency,Yk=c.model.NamedGood,Zk=c.model.Url,De=c.model,za=De.NamedTransaction=md.extend(Xg);za.field("id",da.integer);za.field("created_timestamp",da.timestamp);za.field("modified_timestamp",
da.timestamp);za.field("default_amount",da.integer);za.field("variable_amount_allowed",da.integer);za.many("attributes",Wk);za.one("currency",Xk);za.field("currency_id",da.integer);za.one("named_good",Yk);za.uri=Yg(nd.uri,"named_transaction");Ce.associate("named_transaction",za);var Aa=De.NamedTransactionGroup=md.extend(function(a){md.call(this,a)});Aa.field("id",da.integer);Aa.field("created_timestamp",da.timestamp);Aa.field("modified_timestamp",da.timestamp);Aa.field("end_user_cap_interval",da.integer);
Aa.field("end_user_cap",da.integer);Aa.many("named_transactions",Xg);Aa.many("urls",Zk);Aa.field("purchase_currency_id",da.integer);Aa.field("purchase_default_amount",da.integer);Aa.uri=Yg(nd.uri,"named_transaction_group");Ce.associate("named_transaction_group",Aa);Cc.prototype=new nd;Cc.uri=function(a){if(!a||!a.named_transaction_group_id||!a.end_user_login)throw new Vk("NamedTransactionGroupExecute requires that a user id with named_transaction_group_id && end_user_login is passed to the URI function");
return["named_transaction_group",a.named_transaction_group_id,"execute",a.end_user_login].join("/")};Ce.associate("named_transaction_group_execute",{model:Cc,bridge:Tk});Cc.prototype.run=function(a,b,d,c){Sk.isFunction(b)&&(c=d,d=b,b=void 0);var c=c||this,f={};"number"==typeof b&&(f.amount=b);a={named_transaction_group_id:this.named_transaction_group.id(),end_user_login:a.end_user_login()};return Uk.current().bigdoor.named_transaction_group_execute.create(a,f,d,c)};De.NamedTransactionGroupExecute=
Cc;var Ee=function(a){ac.call(this,a)},mb=function(a){ac.call(this,a)},Zg=c.$,ma=c.util.convert,$k=c.util.walk,al=c.app,$g=c.api.BigDoor,bl=c.model,ah=c.model.Model,ac=c.model.Titled,bh=c.model.Attribute,Fe=c.model.Url,cl=c.model.Currency,Ge=c.model,Eb=Ge.NamedLevel=ac.extend(Ee);Eb.uri=function(a){a=a||{};a="object"!=Zg.type(a)?{id:a}:a;return a.collection_id?Ba.uri(a.collection_id)+"/named_level/"+a.id:a.id?"named_level/"+a.id:"named_level"};Eb.field("id",ma.integer);Eb.field("created_timestamp",
ma.timestamp);Eb.field("modified_timestamp",ma.timestamp);Eb.field("threshold",ma.integer);Eb.many("attributes",bh);Eb.many("urls",Fe);$g.associate("named_level",Ee);var Ba=Ge.NamedLevelCollection=ac.extend(function(a){ac.call(this,a)});Ba.uri=function(a){return"object"==Zg.type(a)&&a.completion?bl.User.uri(al.current().auth.user.end_user_login())+"/named_level_collection":ah.uri("named_level_collection",a)};Ba.field("id",ma.integer);Ba.field("created_timestamp",ma.timestamp);Ba.field("modified_timestamp",
ma.timestamp);Ba.field("relative_weight",ma.integer);Ba.one("currency",cl);Ba.many("attributes",bh);Ba.many("urls",Fe);Ba.many("named_levels",Ee,function(a,b,d){return ah.many.getter.apply(this,arguments).sort(function(a,b){return a.threshold()-b.threshold()})});$g.associate("named_level_collection",Ba);Ge.Level=ac.extend(mb);mb.hash=function(a){return $k("named_level_id",a)};mb.field("named_level_id",ma.integer);mb.field("named_level_collection_id",ma.integer);mb.field("created_timestamp",ma.timestamp);
mb.field("modified_timestamp",ma.timestamp);mb.field("threshold",ma.integer);mb.many("urls",Fe);var nb=function(a){ch.call(this,a);if(a)return this.hasOwnProperty("amount")||(this.amount=this.adjustment_amount),this},bc=c.util.convert,ch=c.model.Titled,dl=c.model.Url;c.model.CurrencyAdjustment=ch.extend(nb);nb.field("adjustment_amount",bc.real);nb.field("currency_id",bc.integer);nb.field("current_balance",bc.real);nb.field("previous_balance",bc.real);nb.field("currency_adjusted",bc.real);nb.field("transaction_group_id",
bc.integer);nb.many("urls",dl);(function(){function a(a){o.call(this,a);if(!a)return!0;this.hasOwnProperty("auto")||(this.auto=b.extend({},this.auto||{},a.auto||{}));this.session=d.observable(new j(c.app.current().sessions.remote));this.hasOwnProperty("provider")||(this.provider=this.app.providers.quests);this.hasOwnProperty("active")||(this.active=d.observable());this.hasOwnProperty("named_transaction_group")||(this.named_transaction_group=d.observable());this.hasOwnProperty("sharing_status")||(this.sharing_status=
d.observable("unshared"));this.hasOwnProperty("is_active")||(this.is_active=d.observable(!1));this.on_next_checkpoint=g(this,this.on_next_checkpoint);this.next_checkpoint();this.next_checkpoint.subscribe(this.on_next_checkpoint);this.define("is_notifiable_complete",!1);this.next_notifiable_checkpoint();this.on_next_notifiable=g(this,this.on_next_notifiable);this.next_notifiable_checkpoint.subscribe(this.on_next_notifiable);this.on_complete=g(this,this.on_complete);this.is_complete();this.is_complete.subscribe(this.on_complete);
this.on_next_notifiable(this.next_notifiable_checkpoint());this.on_user_changed=g(this,this.on_user_changed);return this}var b=c.$,d=c.ko,g=c.bind,f=c.filter,h=c.first,i=c.util.convert,j=c.session.QuestsSessionState,k=c.api.BigDoor,l=c.api.bridge.QuestBridge,m=c.model,e=c.model.Model,n=c.model.Attribute,A=c.model.Url,fa=c.model.NamedLevelCollection,o=c.model.Titled;c.model.Quest=o.extend(a);a.uri=fa.uri;k.associate("quest",{model:a,bridge:l});a.prototype.auto={deactivate:!0};a.field("id",i.integer);
a.field("created_timestamp",i.timestamp);a.field("modified_timestamp",i.timestamp);a.field("relative_weight");a.many("urls",A);a.many("attributes",n);a.dependent("is_visible",function(){var a=e.get_by_attribute(this.attributes(),"visibility_rule");this.app.auth.user.end_user_login();if(a){var b,a=a.pub_description()||!1;try{b=!!eval(a)}catch(d){b=!1}return b}return!0});a.dependent("thumbnail",function(){return e.get_by_attribute(this.urls(),"bdm-quest-thumbnail")});a.dependent("is_complete",function(){var a=
this.get_last_checkpoint();return a&&a.is_complete()});a.dependent("checkpoints",function(){var a=this.data().named_levels||[],a=m.checkpoint.Checkpoint.map(a);a.sort(function(a,b){return a.threshold()-b.threshold()});for(var b=0;b<a.length;b++)a[b].quest=this;return a});a.dependent("notifiable_checkpoints",function(){for(var a=e.filter_by_attribute(this.checkpoints(),"bdm-notifiable"),b=0;b<a.length;b++)a[b].notifiable_position=b+1;return a});a.dependent("get_first_checkpoint",function(){return this.checkpoints()[0]});
a.dependent("get_last_checkpoint",function(){return this.checkpoints()[this.checkpoints().length-1]});a.dependent("get_last_completed_notifiable",function(){return h(this.notifiable_checkpoints(),function(a){return!!a.is_complete()})});a.dependent("last_notifiable",function(){var a=this.notifiable_checkpoints()||[];return a[a.length-1]});a.dependent("get_last_completed_checkpoint",function(){var a;h(this.checkpoints(),function(b){b.is_complete()&&(a=b);return!b.is_complete()});return a});a.dependent("checkpoints_completed",
function(){return f(this.checkpoints(),function(a){return a.is_complete()})});a.dependent("num_checkpoints_completed",function(){return this.checkpoints_completed().length});a.dependent("num_checkpoints_total",function(){return this.checkpoints().length});a.dependent("notifiable_checkpoints_completed",function(){return f(this.notifiable_checkpoints(),function(a){return a.is_complete()})});a.dependent("num_notifiable_completed",function(){return this.notifiable_checkpoints_completed().length});a.dependent("num_notifiable_total",
function(){return this.notifiable_checkpoints().length});a.dependent("percent_notifiable_completed",function(){try{return 0<this.num_notifiable_completed()?100*(this.num_notifiable_completed()/this.num_notifiable_total()):0}catch(a){return 0}});a.dependent("notifiable_position",function(){return this.num_notifiable_completed()+1});a.dependent("when_completed",function(){var a=this.get_last_checkpoint();if(a&&this.is_complete())return h(this.app.auth.user.level_summaries(),function(b){if(b.named_level_id()==
a.id())return b.created_timestamp()})});a.dependent("next_checkpoint",function(){return h(this.checkpoints(),function(a){return!a.is_complete()})});a.dependent("next_notifiable_checkpoint",function(){return h(this.notifiable_checkpoints(),function(a){return!a.is_complete()})});a.prototype.on_next_notifiable=function(a){a=!a||a.is_complete();this.is_notifiable_complete()!==a&&this.is_notifiable_complete(a)};a.dependent("is_featured",function(){return!!h(this.attributes(),function(a){return"bdm-featured"===
a.friendly_id()})});a.dependent("is_passive",function(){return!!h(this.attributes(),function(a){return"bdm-passive-quest"===a.friendly_id()})});a.prototype.activate=function(){var a=this.is_active(),b=this.is_passive();if(!a&&(b||this.session().activate_quest(this),this.is_active(!0),!this.user_listener||this.user_listener.isDisposed))this.user_listener=this.app.auth.is_anonymous.subscribe(this.on_user_changed);this.activate_checkpoint(!a);a||(b?c.trigger("quest.passive_activated",this):c.trigger("quest.activated",
this));return this};a.prototype.deactivate=function(){var a=this.is_active(),b=this.is_passive();a&&this.is_active(!1);this.user_listener&&(this.user_listener.dispose(),this.user_listener=void 0);this.deactivate_checkpoint(!0);a&&(b?c.trigger("quest.passive_deactivated",this):c.trigger("quest.deactivated",this));return this};a.prototype.refresh=function(){this.is_active()&&(this.active()&&(this.active().deactivate(),this.active(void 0)),this.next_checkpoint()&&!this.next_checkpoint().is_notifiable()&&
this.next_checkpoint().activate());return this};a.prototype.activate_checkpoint=function(a){if(!this.activating_checkpoint){if(!this.is_active())return this.activate();var b=this.next_checkpoint();b&&(this.activating_checkpoint=!0,this.active()!==b&&(this.deactivate_checkpoint(),this.active(b)),(a||!b.is_notifiable()||this.auto.activate)&&b.activate(),this.activating_checkpoint=!1)}};a.prototype.deactivate_checkpoint=function(a){if(!this.deactivating_checkpoint){var b=this.active();if(b){this.deactivating_checkpoint=
!0;var d=this.active()===b;(a||!b.is_notifiable()||this.auto.deactivate)&&b.deactivate();d&&!this.activating_checkpoint&&this.active(void 0);this.deactivating_checkpoint=!1}}};a.prototype.on_next_checkpoint=function(){if(this.is_active()){var a=this.get_last_completed_checkpoint();a&&this.activate_checkpoint(!a.is_notifiable())}};a.prototype.on_complete=function(a){a&&c.trigger("quest.completed",[this])};a.prototype.on_user_changed=function(){this.activating||(this.is_active(!1),this.activate())}})();
var Fb=function(a){He.call(this,a)},Ca=function(a){Ie.call(this,a);a&&c.util.add_dynamic_properties(this,"urls")},Je=c.first,el=c.max,dh=c.app,eh=c.api.BigDoor,od=c.model.Model,He=c.model.NamedLevelCollection,Ie=c.model.NamedLevel,fh=c.model;fh.BadgeTrack=He.extend(Fb);Fb.uri=He.uri;Fb.dependent("badges",function(){var a=od.many.getter.call(this,"named_levels",Ca),a=Array.prototype.sort.call(a,function(a,b){return a.threshold()-b.threshold()}),b=this;return a=c.map(a,function(a){a.define("track",
b);return a})});Fb.dependent("earned_badges",function(){return c.filter(this.badges(),function(a){return a.earned()&&a.thumbnail()&&a.thumbnail().url()})});Fb.dependent("unearned_badges",function(){return c.filter(this.badges(),function(a){return!a.earned()&&a.thumbnail()&&a.thumbnail().url()})});Fb.dependent("highest_earned_badge",function(){return el(this.earned_badges(),function(a){return a.threshold()})});eh.associate("badge_track",Fb);fh.Badge=Ie.extend(Ca);Ca.uri=Ie.uri;Ca.dependent("thumbnail",
function(){var a=od.get_by_attribute(this.urls(),"bdm-primary-image");a||(a=od.get_by_attribute(this.urls(),"7a0670c7e0cb4bc280cc67276fce5754"));a||(a=Je(this.urls(),function(a){return a.is_image()?a:null},this));return a});Ca.computed("secondary_image",function(){return od.get_by_attribute(this.urls(),"bdm-secondary-image")});Ca.dependent("earned",function(){return null!=this.when_earned()});Ca.dependent("when_earned",function(){var a=Je(dh.current().auth.user.level_summaries(),function(a){return a.named_level_id()===
this.id()},this);if(a)return a.created_timestamp()});Ca.dependent("earned_on_page",function(){var a=Je(dh.current().auth.user.level_summaries(),function(a){return a.named_level_id()===this.id()},this);return a&&a.data().leveled_up});Ca.computed("is_primary_level_badge",function(){return!!c.first(this.attributes(),function(a){return"bdm-primary-level-badge"===a.friendly_id()})});Ca.computed("is_hidden",function(){var a=this.track();if(a)return!!c.first(a.attributes(),function(a){return"bdm-hidden-badge-track"===
a.friendly_id()})});eh.associate("badge",Ca);var gh=c.model.Model,Dc=function(a){gh.apply(this,arguments)};c.model.Video=gh.extend(Dc);Dc.field("notifier");Dc.field("url");Dc.field("width");Dc.field("height");var q=function(a){Ke.apply(this,arguments);if(a&&(this.hasOwnProperty("is_active")||(this.is_active=pd.observable(!1)),this.hasOwnProperty("rewards")||(this.rewards=pd.observable({})),this.hasOwnProperty("is_completing")||(this.is_completing=pd.observable(!1)),!this.hasOwnProperty("amount")))this.amount=
pd.observable(1)},Ua=c.$,pd=c.ko,hh=c.first,fl=c.map,Le=c.util.walk,qd=c.util.convert,Ke=c.model.Titled,gl=c.model.Url,hl=c.model.Attribute;(c.model.checkpoint={}).Checkpoint=Ke.extend(q);q.extend=function(a,b){Ke.extend.call(this,b);return q.registry[a]=b};q.registry={};q.ntg_regex=/^ntg_association_([0-9]+)$/;q.ntg_id=function(a){return hh(Le("attributes",a),function(a){return(q.ntg_regex.exec(Le("friendly_id",a))||[])[1]})};q.get=function(a,b){if(a){var d=q.registry[a];return d&&b?d.save(b):d}};
q.map_re=/^bdm-checkpoint-([A-Za-z0-9\-]+)$/i;q.map=function(a){a=a||[];Ua.isArray(a)||(a=[a]);return a=fl(a,function(a){var d=null,c=null,f=q.attribute(a,function(a){a=Le("friendly_id",a)+"";return(a.match(q.map_re)||[])[1]});if(f){if(d=q.get(f),!d)throw"Unrecognized checkpoint type: "+f;}else!f&&q.ntg_id(a)&&(d=q);d&&(c=d.save(a));return c},this)};q.field("id",qd.integer);q.field("threshold",qd.integer);q.field("created_timestamp",qd.timestamp);q.field("modified_timestamp",qd.timestamp);q.many("urls",
gl);q.many("attributes",hl);q.dependent("ntg_id",function(){return q.ntg_id(this)});q.dependent("is_notifiable",function(){return!!q.attribute(this,"bdm-notifiable")});q.dependent("is_complete",function(){return!!hh(this.app.auth.user.level_summaries(),function(a){return a.named_level_id()===this.id()},this)},null,{notify:"always"});q.dependent("completed_on_page",function(){return"undefined"==typeof this.previously_completed?(this.previously_completed=this.is_complete(),!1):!this.previously_completed&&
this.is_complete()},null,{notify:"always"});q.prototype.page=function(){"_page"in this||(this._page=q.get_by_attribute(this.urls(),"bdm-event-page"));return this._page};q.prototype.is_page=function(){return this.is_target_page()};q.prototype.is_target_page=function(){var a=this.uri(),b=this.page();return!b?!0:(b=b&&Ua.isFunction(b.url)?b.url():b.url)&&0===a.indexOf(b)};q.prototype.is_invalid_page=function(){return this.page()?!this.is_target_page():!1};q.prototype.is_satisfied=function(){return!this.is_complete()&&
this.is_target_page()};q.prototype.uri=function(){return window.location.href||""};q.computed("launch_page",function(){return q.get_by_attribute(this.urls(),"bdm-launch-page")});q.prototype.is_launch_page=function(){var a=this.uri(),b=this.launch_page()&&this.launch_page().url();return b?0===a.indexOf(b):!1};q.prototype.activate=function(a,b){if(!this.activating){if(this.is_active())Ua.isFunction(a)&&(this.activating=!1,a.call(b||this,this));else if(this.activating=!0,this.is_active(!0),c.trigger("checkpoint.activated",
this),this.activating=!1,this.is_notifiable())Ua.isFunction(a)&&a.call(b||this);else{var d=this.app,g=this.quest,f=this;if(g&&d&&d.auth.is_anonymous()){for(var g=g.checkpoints(),h,i=0;i<g.length&&!(h||(h=g[i].requires_login),g[i]===f);i++);if(h){var j=d.auth.is_anonymous.subscribe(function(d){j.dispose();!1===d&&f.complete(a,b)});return}}return this.complete(a,b)}return this}};q.prototype.deactivate=function(a,b){var d=this.is_active();d&&this.is_active(!1);d&&c.trigger("checkpoint.deactivated",this);
Ua.isFunction(a)&&a.call(b||this,this);return this};q.prototype.complete=function(a,b){if(!this.is_completing()&&this.app&&this.app.auth&&this.app.auth.user)if(this.is_satisfied()){this.is_completing(!0);var d=this.ntg_id(),g={},f=this.amount();1!=f&&(g.amount=f);this.app.providers.economycache&&this.app.auth.is_anonymous()?(g=Ua.proxy(function(d){c.trigger("currency.earned",[d,"checkpoint",this]);if(this.is_complete()){c.trigger("checkpoint.completed",this);this.is_notifiable()&&c.trigger("checkpoint.notifiable_completed",
this);this.deactivate()}Ua.isFunction(a)&&a.apply(b||this,arguments);this.is_completing(false)},this),this.app.providers.economycache.transact_checkpoint(this,g,this)):this.app.auth.user.transact(d,g,function(g){c.trigger("currency.earned",[g,"checkpoint",this]);if(g){for(var f={},j=g.data(),k=0;k<j.end_user.currency_balances.length;k++){var l=j.end_user.currency_balances[k];if(l.currency_adjusted){var m=new c.model.CurrencyAdjustment(l);f[l.currency_id]=m}}this.rewards(f);if(this.is_complete()){c.trigger("checkpoint.completed",
this);this.is_notifiable()&&c.trigger("checkpoint.notifiable_completed",this);this.deactivate()}Ua.isFunction(a)&&a.apply(b||this,arguments)}else c.log("A checkpoint transaction failed. (NTG ID: "+d+")");this.is_completing(false)},this)}else Ua.isFunction(a)&&a.apply(b||this)};q.prototype.has_hint=function(){return!1};q.prototype.go=function(){if(!this.is_target_page())if(this.launch_page()&&!this.is_launch_page()){c.trigger("checkpoint.launched");var a=this;window.setTimeout(function(){location.href=
a.launch_page().url()},300)}else this.page().url()&&(location.href=this.page().url())};q.prototype.toggle_hint=function(){};var cc=function(){rd.apply(this,arguments);try{this.config=ih.parseJSON(this.pub_description())||{}}catch(a){throw new Me("Cannot parse JSON in pub_description of CurrencyBalanceCheckpoint");}this.currency_id=this.config.currency_id;this.required_balance=this.config.required_balance;if(!this.currency_id)throw new Me("Could not find currency_id in CurrencyBalanceCheckpoint configuration");
if(!this.required_balance)throw new Me("Could not find required_balance in CurrencyBalanceCheckpoint configuration");},ih=c.$,rd=c.model.checkpoint.Checkpoint,Me=c.error.EconomyConfigurationError;c.model.checkpoint.CurrencyBalanceCheckpoint=rd.extend("balance",cc);cc.prototype.activate=function(a,b){if(!this._subscription){var d=c.app.current().auth.user.currency_balances,g=c.bind(this,this.on_balances_change);this._subscription=d.subscribe(g)}rd.prototype.activate.call(this,this.on_balances_change(a,
b))};cc.prototype.deactivate=function(a,b){this._subscription&&!this._subscription.isDisposed&&this._subscription.dispose();rd.prototype.deactivate.call(this,arguments)};cc.prototype.on_balances_change=function(a,b){this.is_satisfied()?this.complete(a,b):ih.isFunction(a)&&a.apply(b||this,arguments)};cc.prototype.is_satisfied=function(){return this.current_balance()>=this.required_balance};cc.prototype.current_balance=function(){return c.app.current().auth.user.balance(this.currency_id,0)};var ea=
function(a){Ne.call(this,a);if(a)return this.hasOwnProperty("session")||(this.session=new il(Oe.current().sessions.remote)),this.hasOwnProperty("image")||(this.image=jl.observable(kl.get_by_attribute(this.urls(),"bdm-quest-task-image"))),this},jl=c.ko,il=c.session.QuestsSessionState,Oe=c.app,jh=c.util.convert,kh=c.model.Url,kl=c.model.Titled,Ne=c.model.checkpoint.Checkpoint;c.model.checkpoint.PageCheckpoint=Ne.extend("page",ea);ea.prototype.viewer=function(){"_viewer"in this||(this._viewer=ea.get_by_attribute(this.urls(),
"bdm-quest-task-checkpoint-viewer")||new kh({url:Oe.current().providers.quests.viewer()}));return this._viewer};ea.prototype.home=function(){"_home"in this||(this._home=ea.get_by_attribute(this.urls(),"bdm-quest-task-checkpoint-home")||new kh({url:Oe.current().providers.quests.home()}));return this._home};ea.prototype.page=function(){"_page"in this||(this._page=ea.get_by_attribute(this.urls(),"bdm-quest-task-checkpoint"));return this._page};ea.prototype.is_page=function(){var a=this.uri(),b=this.page();
if(!b)return!0;var b=b.url(),d=this.viewer().url(),c=-1<a.indexOf("?")?a.substring(a.indexOf("?")+1):"",c=jh.decode_form(c);return 0===d.indexOf("/")?-1!==a.indexOf(d)&&c["checkpoint-url"]===b:0===a.indexOf(d)&&c["checkpoint-url"]===b};ea.prototype.uri=function(){return top.location.href||""};ea.prototype.activate=function(a,b){Ne.prototype.activate.call(this,function(){this.is_satisfied()?this.complete(a,b):a&&a.call(b||this)},this)};ea.prototype.go=function(a){void 0===a?this.go_to_viewer():top.location=
a};ea.prototype.go_to_viewer=function(){var a={"checkpoint-url":this.page().url()};c.testmode.is_in_test_mode()&&(a.bd_test="1");c.app.current().auth.is_multi_oauth&&(a.bd_multi_oauth=c.app.current().auth.provider_name);c.app.current().auth.is_auth_string_on_page()&&(a.BDACWE=window.BDACWE);c.storage.clear_storage("profile");this.go(this.viewer().url()+"?"+jh.encode_form(a))};ea.prototype.go_home=function(){c.storage.clear_storage("profile");this.go(this.home().url())};ea.prototype.finish=function(a,
b){this.session.pass_checkpoint(this,a,b)};ea.prototype.is_satisfied=function(){return!this.is_complete()&&this.session.passed_checkpoint()===this.id()};var Va=function(a){Pe.call(this,a);this.template="checkpoint-site-visit";this.config=this.get_config();this.is_executing_visit_ntg=dc.observable(!1);this.has_executed_visit_ntg=dc.observable(!1);this.required_visits=dc.observable(this.config.required_visits);this.visit_currency_id=dc.observable(this.config.visit_currency_id);this.visit_ntg_id=dc.observable(this.config.visit_ntg_id);
this.initialization_visits=dc.observable(null==this.config.initialization_visits?1:this.config.initialization_visits)},dc=c.ko,ll=c.$,Pe=c.model.checkpoint.Checkpoint,lh=c.error.EconomyConfigurationError;c.model.checkpoint.SiteVisitCheckpoint=Pe.extend("site-visit",Va);Va.prototype.get_config=function(){var a;try{a=ll.parseJSON(this.pub_description())}catch(b){throw new lh;}if(!a||!a.required_visits||!a.visit_currency_id||!a.visit_ntg_id)throw new lh("Incomplete SiteVisitCheckpoint configuration");
return a};Va.computed("total_visits",function(){var a=this.visit_currency_balance();return 0>a?0:a});Va.computed("counted_visits",function(){var a=this.total_visits()-this.initialization_visits();return 0<a?a:0});Va.computed("remaining_visits",function(){var a=this.required_visits()-this.counted_visits();return 0<a?a:0});Va.computed("visit_currency_balance",function(){var a=c.app.current().auth.user;return!a?0:a.balance(this.visit_currency_id())});Va.prototype.is_satisfied=function(){return this.is_complete()?
!1:this.counted_visits()>=this.required_visits()};Va.prototype.execute_visit_ntg=function(){if(!this.is_executing_visit_ntg()&&!this.has_executed_visit_ntg()){var a=c.app.current().auth.user;a&&(this.is_executing_visit_ntg(!0),a.transact(this.visit_ntg_id(),c.bind(this,function(a){this.has_executed_visit_ntg(!0);this.is_executing_visit_ntg(!1);a&&this.is_satisfied()&&this.complete()})))}};Va.prototype.activate=function(a,b){Pe.prototype.activate.call(this,arguments);this.is_satisfied()?this.is_complete()||
this.complete():this.execute_visit_ntg()};(function(){function a(){b.apply(this,arguments)}var b=c.model.checkpoint.Checkpoint;c.model.checkpoint.EvalCheckpoint=b.extend("eval",a);a.prototype.activate=function(a,c){var f=this;b.prototype.activate.call(this,function(){if(this.is_satisfied())this.complete(a,c);else{var b=!1;this.is_satisfied.subscribe(function(a){a&&!b&&(b=!0,f.complete())});a&&a.call(c||this)}},this)};a.dependent("is_satisfied",function(){var a=this.pub_description();return!0===eval(a)})})();
var Wa=function(){Ec.apply(this,arguments)},mh=c.$,ml=c.first,nh=c.util.walk,nl=c.util.Listener,Ec=c.model.checkpoint.Checkpoint;c.model.checkpoint.EventCheckpoint=Ec.extend("event",Wa);Wa.prototype.listener=function(){if(!this._listener){var a=Wa.attribute(this,function(a){var d=nh("friendly_id",a)+"";return d&&0===d.indexOf("bdm-event")?a:ml(a.attributes(),function(d){return"bdm-event"===d.friendly_id()?a:void 0})}),a=a?nh("pub_description",a):"";this._listener=new nl(a,this.onevent,this)}return this._listener};
Wa.prototype.activate=function(a,b){this.listener().bind();Ec.prototype.activate.call(this,arguments)};Wa.prototype.deactivate=function(a,b){this.listener().unbind();Ec.prototype.deactivate.call(this,arguments)};Wa.prototype.complete=function(a,b){Ec.prototype.complete.call(this,function(){this.listener().unbind();mh.isFunction(a)&&a.apply(b||this,arguments)})};Wa.prototype.onevent=function(){this.complete()};Wa.prototype.has_hint=function(){return!!this.is_page()&&!!this.listener().context.hint};
Wa.prototype.toggle_hint=function(){this.listener().context.hint&&(c.trigger("modals.hide"),mh(this.listener().context.hint).spotlight())};var ph=function(a){if(!a)return!1;oh.call(this,a||{});this.template="checkpoint-quiz";this.user_choice_id=sd.observable();this.user_choice_id.subscribe(c.bind(this,function(a){Number(a)===this.correct_choice_id()?(this.is_wrong_answer(!1),this.complete()):this.is_wrong_answer(!0)}));this.is_wrong_answer=sd.observable(!1);var b;try{b=ol.parseJSON(this.pub_description())}catch(d){throw new Qe;
}if(!b.choices||void 0===b.correct_choice)throw new Qe;this.choices=sd.observableArray(c.map(b.choices,function(a,b){return{text:a,id:b}}));this.correct_choice_id=sd.observable(b.correct_choice);if(0===this.choices().length||void 0===this.correct_choice_id())throw new Qe;},ol=c.$,sd=c.ko,Qe=c.error.EconomyConfigurationError,oh=c.model.checkpoint.Checkpoint;c.model.checkpoint.QuizCheckpoint=oh.extend("quiz",ph);ph.prototype.test=function(){};var sh=function(a){if(!a)return!1;qh.call(this,a||{});this.template=
"checkpoint-facebook-share";try{this.config=rh.parseJSON(this.pub_description())}catch(b){throw new pl;}this.config=rh.extend({},{title:"",description:"",comment:"",shorten_url:!1,complete_delay:5E3,share_image:this.app.media.logo_large},(this.app.options.checkpoints||{}).facebook_share,this.config);a=c.bind(this,this.on_share_click);this.config.share_url&&(this.config.share_url=this.config.share_url.length?this.config.share_url:void 0);this.share_button={type:"FacebookShareButton",options:{title:this.config.title,
description:this.config.description,comment:this.config.comment,picture:this.config.share_image,url:this.config.share_url,shorten_url:this.config.shorten_url,on_click_callback_function:a}}},rh=c.$,pl=c.error.EconomyConfigurationError,qh=c.model.checkpoint.Checkpoint;c.model.checkpoint.FacebookShareCheckpoint=qh.extend("facebook-share",sh);sh.prototype.on_share_click=function(){if(this.config.complete_delay){var a=this;window.setTimeout(function(){a.complete()},this.config.complete_delay)}else this.complete()};
var wh=function(a){if(!a)return!1;th.call(this,a||{});this.template="checkpoint-fill-in-the-blank";this.user_submission=Fc.observable();this.submitted=Fc.observable(!1);this.is_wrong_answer=Fc.observable(!1);var b;try{b=uh.parseJSON(this.pub_description())}catch(d){throw new vh;}if(!b||!b.correct_submission)throw new vh;(a=c.app.current())&&(a.options&&a.options.checkpoints)&&(b=uh.extend({},a.options.checkpoints.fill_in_the_blank,b));this.case_insensitive=Fc.observable(b.case_insensitive||!1);this.correct_submission=
Fc.observable(b.correct_submission)},uh=c.$,Fc=c.ko,vh=c.error.EconomyConfigurationError,th=c.model.checkpoint.Checkpoint;c.model.checkpoint.FillInTheBlankCheckpoint=th.extend("fill-in-the-blank",wh);wh.prototype.check_submission=function(){this.submitted(!0);var a=this.user_submission(),b=this.correct_submission();this.case_insensitive()&&(a=a.toLowerCase(),b=b.toLowerCase());a===b?(this.is_wrong_answer(!1),this.complete()):this.is_wrong_answer(!0)};var ql=function(a){var b=this.app.providers.partners.partners[a.partner];
if(b)return b.get_video(a)},ec=function(a){td.apply(this,arguments);this.template="checkpoint-video";var b=a.video;if(!b)try{b=Re.parseJSON(this.pub_description())}catch(d){}b&&(this.video=Re.isFunction(b)?b:c.bind(this,c.curry(ql,b)));this.on_watched=c.bind(this,this.on_watched)},Re=c.$,td=c.model.checkpoint.Checkpoint;c.model.checkpoint.VideoCheckpoint=td.extend("video",ec);ec.prototype.complete=function(a,b){this.is_active()&&td.prototype.complete.call(this,a,b)};ec.prototype.get_video=function(){Re.isFunction(this.video)&&
(this.video=this.video());return this.video};ec.prototype.activate=function(a,b){td.prototype.activate.call(this,function(){this.get_video()||this.complete(a,b);c.subscribe("video.watched",this.on_watched)},this)};ec.prototype.watch=function(){this.video&&c.trigger("video.watch",this.video)};ec.prototype.on_watched=function(a,b){this.video===b&&this.complete()};var fc=function(){Gc.apply(this,arguments);this.template="checkpoint-facebook-like";this.url=null;if(this.urls()){var a=c.model.Model.get_by_attribute(this.urls(),
"bdm-facebook-like");a&&(this.url=a.data().url)}},rl=c.$,sl=c.util.Listener,Gc=c.model.checkpoint.Checkpoint;c.model.checkpoint.BarFacebookLikeCheckpoint=Gc.extend("bar-facebook-like",fc);fc.prototype.listener=function(){this._listener||(this._listener=new sl({bind:"FB.Event.subscribe",unbind:"FB.Event.unsubscribe",event:"edge.create"},this.onevent,this));return this._listener};fc.prototype.activate=function(a,b){this.listener().bind();Gc.prototype.activate.call(this,arguments)};fc.prototype.deactivate=
function(a,b){this.listener().unbind();Gc.prototype.deactivate.call(this,arguments)};fc.prototype.complete=function(a,b){Gc.prototype.complete.call(this,function(){this.listener().unbind();rl.isFunction(a)&&a.apply(b||this,arguments)})};fc.prototype.onevent=function(a){(!this.url||a==this.url)&&this.complete()};var ud=c.model.checkpoint.EventCheckpoint,xh=c.model.checkpoint;xh.BarFacebookLoginCheckpoint=ud.extend("facebook-login",function(){ud.apply(this,arguments);this.requires_login=!0;this.template=
"checkpoint-facebook-login"});xh.BarLoginCheckpoint=ud.extend("login",function(){ud.apply(this,arguments);this.requires_login=!0;this.template="checkpoint-login"});var vd=function(a){if(!a)return!1;yh.call(this,a||{});this.template=a.template||"checkpoint-profile-select";var b;try{b=tl.parseJSON(this.pub_description())}catch(d){throw new zh("Checkpoint config not defined in pub_description");}this.profile_pub_title_key=b.pub_title_key;this.profile_end_user_title_key=b.end_user_title_key;this.caption=
b.caption;if(!this.profile_pub_title_key&&!this.profile_end_user_title_key)throw new zh("Profile pub_title or end_user_title key not defined");this.caption||(this.caption="Choose a filter to continue...");this.user_choice=Se.observable();this.user_choice.subscribe(c.bind(this,this.on_user_choice_change));this.selected_choice_url=Se.observable();this.profile_updates={};this.choice_urls={};c.each(a.urls,function(a){this.choice_urls[a.pub_title]=a.url},this);this.choices=c.filter(a.attributes,function(a){var b=
c.first(a.attributes,function(a){return a.friendly_id==="bdm-choice"});if(b){if(!a.pub_title&&a.end_user_title)a.pub_title=a.end_user_title;if(!a.end_user_title&&a.pub_title)a.end_user_title=a.pub_title;!a.end_user_title&&!a.pub_title&&(b=false);a.text=a.end_user_title;a.id=a.pub_title}return b});this.choices=Se.observableArray(this.choices)},tl=c.$,Se=c.ko,zh=c.error.EconomyConfigurationError,yh=c.model.checkpoint.Checkpoint;c.model.checkpoint.ProfileSelectionCheckpoint=yh.extend("profile-select",
vd);vd.prototype.go=function(a){top.location=a};vd.prototype.on_user_choice_change=function(a){this.profile_pub_title_key&&(this.profile_updates[this.profile_pub_title_key]=a.id);this.profile_end_user_title_key&&(this.profile_updates[this.profile_end_user_title_key]=a.text);this.selected_choice_url(this.choice_urls[a.id])};vd.prototype.checkpoint_complete=function(){this.user_choice()&&this.app.sessions.remote.write(this.profile_updates,function(){this.complete(function(){this.selected_choice_url()&&
this.go(this.selected_choice_url())},this)},this)};var Hb=function(){Hc.apply(this,arguments);this.template="checkpoint-twitter";var a;try{a=Gb.parseJSON(this.pub_description())}catch(b){throw new Ah("Error parsing JSON in Twitter checkpoint pub_description");}try{this.followee=a.handle}catch(d){throw new Ah("Twitter handle not found in checkpoint pub_description JSON");}},Gb=c.$,ul=c.util.Listener,Hc=c.model.checkpoint.Checkpoint,Ah=c.error.EconomyConfigurationError;c.model.checkpoint.TwitterFollowCheckpoint=
Hc.extend("twitter-follow",Hb);Hb.prototype.listener=function(){this._listener||(this._listener=new ul({bind:"twttr.events.bind",unbind:"twttr.events.unbind",event:"click"},this.on_follow_event,this));return this._listener};Hb.prototype.on_follow_event=function(){setTimeout(Gb.proxy(this.complete,this),5E3)};Hb.prototype.activate=function(){window.twttr?window.twttr&&!window.twttr.ready&&(window.twttr&&(window._twttr=window.twttr),this.load_twttr()):this.load_twttr();window.twttr.ready&&window.twttr.ready(Gb.proxy(function(a){this.listener().bind();
Hc.prototype.activate.call(this,arguments)},this))};Hb.prototype.load_twttr=function(){var a=document.createElement("script");a.type="text/javascript";a.charset="utf-8";a.text="window.twttr = (function (d,s,id) {";a.text+="var t, js, fjs = d.getElementsByTagName(s)[0];";a.text+="if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;";a.text+='js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);';a.text+="return (t = { _e: [], ready: function(f){ t._e.push(f) } });";
a.text+='}(document, "script", "twitter-wjs"));';Gb(document).append(a)};Hb.prototype.deactivate=function(a,b){this.listener().unbind();Hc.prototype.deactivate.call(this,arguments);window._twttr&&(delete window.twttr,window.twttr=window._twttr);var d=Gb("script").filter("#twitter-wjs")[0];d&&Gb(d).remove()};Hb.prototype.complete=function(a,b){Hc.prototype.complete.call(this,function(){this.listener().unbind();Gb.isFunction(a)&&a.apply(b||this,arguments)})};(function(){function a(a,b,d){this.data?
this.update(a):o.call(this,a);if(a)return this.session=new n(this.app.sessions.local),this.hasOwnProperty("profiles")||(this.profiles=k.observableArray([])),g.isArray(a.profiles)&&(this.profiles.remove(function(){return true}),this.profiles(a.profiles)),this.hasOwnProperty("has_opted_out")||(this.has_opted_out=k.observable(this.session.get_optout())),g.isFunction(b)&&b.call(d||this,this),this}function b(a,b,c){var g={},f=[];if(!b.length)return a;if(!a.length)return b;d(g,a,c);d(g,b,c);for(var e in g)f.push(g[e]);
return f}function d(a,b,d){for(var c,g=0;g<b.length;g++)c=b[g][d],a[c]=b[g]}var g=c.$,f=c.trigger,h=c.curry,i=c.first,j=c.util.walk,k=c.ko,l=c.util.convert,m=c.uuid,e=c.error,n=c.session.UserSessionState,A=c.api.BigDoor,fa=c.model.Model,o=c.model.Titled,p=c.model.Balance,q=c.model.Level,r=c.model.Good;c.model.User=o.extend(a);a.field("guid");a.field("created_timestamp",l.timestamp);a.field("modified_timestamp",l.timestamp);a.field("end_user_login");a.field("best_guess_profile_img");a.field("best_guess_name");
a.many("currency_balances",p,function(b,d){return a.many.getter.call(this,b,d,function(a){a.user=this;return a})});a.many("level_summaries",q);a.field("is_new");a.dependent("current_primary_level",function(){var a=this.app.spec.options&&this.app.spec.options.primary_level_collection_id,b,d;if(a)for(var c=this.level_summaries(),g=0;g<c.length;g++)if(d=c[g],d.named_level_collection_id()===a&&(!b||b.threshold()<d.threshold()))b=d;return b},this);a.dependent("publisher_user_profile",function(){return i(this.profiles(),
function(a){return"publisher"==a.provider()})});a.dependent("facebook_profile",function(){return i(this.profiles(),function(a){return"facebook"==a.provider()})});a.dependent("good_summaries",function(){return c.map(this.data().received_good_summaries,function(a){return new r(a)})});a.dependent("sent_good_summaries",function(){return c.map(this.data().sent_good_summaries,function(a){return new r(a)})});a.dependent("profile",function(){return this.profiles()[0]});a.dependent("display_name",function(){var a=
this.best_guess_name();return!this.profile()?a:this.profile().name()||a});a.dependent("first_name",function(){return(this.display_name()||"").split(" ")[0]});a.dependent("image",function(){var a=this.best_guess_profile_img();return!this.profile()?a:this.profile().image()||a});a.anonymous_data=function(a){a||(a="",c.testmode.is_in_test_mode()&&(a="TEST-"),a+=m());return{level_summaries:[],received_good_summaries:[],sent_good_summaries:[],currency_balances:[],best_guess_name:"Anonymous",best_guess_profile_img:void 0,
guid:void 0,end_user_login:a,created_timestamp:void 0,modified_timestamp:void 0}};a.prototype.make_anonymous=function(b){this.data(a.anonymous_data(b));return this};a.prototype.update=function(a){if(a){var d=this.data(),f=d.currency_balances,e=a.currency_balances,h=d.level_summaries,i=a.level_summaries,j,n;if(d.end_user_login===a.end_user_login){if(f&&f.length){var k={};for(n=0;n<e.length;n++)j=e[n].currency_id,k[j]=!0;for(n=0;n<f.length;n++){var l=f[n];j=l.currency_id;k[j]||(l.currency_adjusted=
0,e.push(l))}}f=[];if(h&&h.length)for(n=0;n<h.length;n++)e=h[n],e.from_economy_cache||(e.leveled_up=0,e=g.extend({},e),f.push(e));if(i&&i.length)for(n=0;n<i.length;n++)f.push(i[n]);h=b(d.received_good_summaries||[],a.received_good_summaries||[],"transaction_group_id");d=b(d.sent_good_summaries||[],a.sent_good_summaries||[],"transaction_group_id");a.level_summaries=f;a.received_good_summaries=h;a.sent_good_summaries=d}this.data(a);c.trigger("user.updated",this)}};a.prototype.login=function(){throw new e.NotImplemented;
};a.prototype.logout=function(){for(var a=this.profiles(),b=0;b<a.length;b++)this.profiles[b].logout();this.profiles([]);return this};a.prototype.transact=function(b,d,e,h){g.isFunction(d)&&(h=e,e=d,d={});var h=h||this,d=d||{},i=this.end_user_login();this.app.spec.site_id&&(d.site_id=this.app.spec.site_id);i={named_transaction_group_id:b,end_user_login:i};f("user.transact",g.extend(!0,{},i,d));if(this.app.providers&&this.app.providers.economycache&&this.app.auth.is_anonymous())g.isFunction(e)&&(b=
new c.model.NamedTransactionGroupExecute({end_user:this.data(),named_transaction_group_id:b}),e.call(h||this,b,"success"));else return this.app.bigdoor.named_transaction_group_execute.create(i,d,function(b,d,c){var f=c&&c.data&&c.data[0]&&c.data[0].end_user;d=="success"&&f&&f.end_user_login===this.end_user_login()&&a.call(this,f);g.isFunction(e)&&e.apply(h,arguments)},this),this};a.prototype.balance=function(a,b){2>arguments.length&&(b=0);var d;a&&(d=i(this.currency_balances(),function(b){if(b&&b.currency_id()==
a&&(b=b.current_balance(),void 0!==b&&null!==b))return b}));return d||b};a.prototype.primary_balance=function(a){return this.balance(this.app.spec.options.primary_currency_id,a)};a.prototype.clear=function(){this.level_summaries([]);this.currency_balances([]);this.good_summaries([]);this.created_timestamp(null);this.modified_timestamp(null);this.best_guess_name("");this.best_guess_profile_img("");this.end_user_login("");this.profiles([])};a.prototype.set_profile=function(a){var b=i(this.profiles(),
function(b){return b.profile()===a.profile()});b?c.model.UserProfile.call(b,a.data()):this.profiles.push(a)};a.prototype.opt_out=function(){this.session.set_optout(!0);this.has_opted_out(!0);this.app.bucket.set_bucket("disregard");var a=this.app.widgets.minibar;a&&a.state("hidden");(a=this.app.widgets.container_messenger)&&a.style("hidden");f("optout",[this])};a.prototype.has_named_level=function(a){var b=this.level_summaries(),d;b&&(d=c.first(b,function(b){return b.named_level_id()===a}));return null!=
d};a.uri=h(fa.uri,"end_user");a.hash=function(a){return j("end_user_login",a)};A.associate("end_user",a)})();var Y=c.$,vl=c.each,Bh=c.util.walk,wl=c.api.BigDoor,xl=c.api.bridge.UserProfileBridge,yl=c.session.remote_storage.CrossDomainState,Ch=c.model.Model,K=c.model.UserProfile=Ch.extend(function(a){Ch.call(this,a);if(a){a=this.app||c.app.current();this.is_remote_store_enabled=(a&&a.spec||c.load.options.config).anon_profile_is_remote_store_enabled||!1;for(var b=Y.proxy(function(){this.app&&this.app.auth.is_anonymous()&&
this.data(Y.extend(this.data(),this.local_cache.read()))},this),a=document.domain.split(".");2<a.length;)a.shift();a="."+a.join(".");this.is_remote_store_enabled?this.local_cache=new yl("bd-profile",{domain:a,expires:1825},function(a){this.local_cache=a;b()},this):(this.local_cache=new c.session.cookie.StateCookie("bd-profile",{domain:a,expires:1825}),b());c.app.current()||(c.subscribe("new.user",Y.proxy(this.save_local_cache_to_remote,this)),c.subscribe("signin",Y.proxy(function(){this.local_cache.remove()},
this)),c.subscribe("signout",Y.proxy(function(){this.local_cache.remove()},this)))}});K.pool.readonly=!1;K.hash=function(a){var b=Bh("provider_id",a),a=Bh("user_id",a);return[b,a].join("_")};var Dh=[].concat(["display_name","first_name","last_name","profile_photo"]),wd;for(wd=0;wd<Dh.length;wd++)K.field(Dh[wd]);K.dependent("name",{get:function(){return this.data().name||this.data().display_name},set:function(a){this.data().name=a}});K.dependent("image",function(){return this.data().image||this.data().profile_photo});
K.dependent("provider",function(){var a=this.data().provider_id;return 1==a?"publisher":2==a?"facebook":"unknown"});K.uri=function(a){if("string"==Y.type(a)||"number"==Y.type(a))a={end_user_login:a};var b=["end_user",a.end_user_login,"profile"];a.provider&&b.push(a.provider);return b.join("/")};K.prototype.logout=function(){this.provider.logout()};K.prototype.merge_data_from=function(a){this.data(Y.extend({},this.data(),a.data()))};K.prototype.get=function(a){if(1>arguments.length)return Y.extend({},
this.data());if(1==arguments.length&&"string"==Y.type(a))return this.data()[a];1<arguments.length&&(a=Array.prototype.slice.call(arguments));if(Y.isArray(a)){var b={},d=this.data();vl(a,function(a){a in d&&(b[a]=d[a])});return b}};K.prototype.set=function(a,b,d){Y.extend(this.data(),a);this.save(b,d)};K.prototype.save=function(a,b){var d=Y.extend({},this.data());c.app.current().auth.is_anonymous()?this.save_to_local_cache(d,a,b):this.save_to_remote(d,a,b)};K.prototype.save_to_local_cache=function(a,
b,d){this.local_cache.write(a,function(){this.onsave(this,b,d)},this)};K.prototype.save_to_remote=function(a,b,d){c.app.current().bigdoor.end_user_profile.update({end_user_login:this.app.auth.user.end_user_login(),provider:this.app.auth.is_publisher_auth?this.app.spec.bigdoor.app_key:"publisher"},a,function(a){this.onsave(a,b,d)},this)};K.prototype.onsave=function(a,b,d){a&&Y.isFunction(a.data)&&this.data(a.data());Y.isFunction(b)&&b.call(d||this,this.get())};K.prototype.save_local_cache_to_remote=
function(){var a=this.local_cache.read();this.local_cache.serialize(a).length?(a=Y.extend(this.data(),a),this.save_to_remote(a,function(){this.local_cache.remove()},this)):this.local_cache.remove()};K.prototype.clear=function(){this.data({});K.call(this,{})};wl.associate("end_user_profile",{model:K,bridge:xl});var l=function(a){Eh.apply(this,arguments);a&&(this.define({redemption_code:void 0}),this.cost(),c.util.add_dynamic_properties(this,"urls"))},Fh=c.$,ob=c.util.convert,Gh=c.error.EconomyConfigurationError,
S=c.model.Model,Eh=c.model.NamedGood;c.model.Reward=Eh.extend(l);l.field("variant_named_good_id",ob.integer);l.field("required_named_level_id",ob.integer);l.field("currency_id",ob.integer);l.field("named_transaction_group_id",ob.integer);l.field("default_amount",ob.integer);l.field("end_user_cap",ob.integer);l.field("end_user_cap_interval",ob.integer);l.hash=function(a){return a.id||a.named_good_id};l.uri=function(){return"/reward"};l.from_endpoint=function(a,b){return c.map(a,function(a){a=new l(a);
a.provider=b;return a})};l.computed("named_good_id",function(){var a=this.data();return ob.integer(a.named_good_id||a.id)});l.computed("id",function(){return this.named_good_id()});l.prototype.replace_wishlist=function(){var a=this.provider;a&&!this.is_in_wishlist()&&a.replace_wishlist(this)};l.prototype.add_to_wishlist=function(){var a=this.provider;a&&!this.is_in_wishlist()&&a.add_to_wishlist(this)};l.prototype.remove_from_wishlist=function(){var a=this.provider;a&&this.is_in_wishlist()&&a.remove_from_wishlist(this)};
l.computed("preview",function(){return S.get_by_attribute(this.urls(),"7a0670c7e0cb4bc280cc67276fce5754")});l.computed("full",function(){return S.get_by_attribute(this.urls(),"86836696b39347c789df0ac06966c724")});l.computed("redeem_intro",function(){return S.get_by_attribute(this.attributes(),"bdm-redeem-intro")});l.computed("redeem_success",function(){return S.get_by_attribute(this.attributes(),"bdm-redeem-success")});l.computed("is_inventorized",function(){return!!this.total_inventory()});l.computed("is_available",
function(){var a=this.available_start(),b=this.available_end(),d=c.util.dates.now();return(!a||a<=d)&&(!b||b>=d)});l.computed("is_available_to_user",function(){return this.is_redeemable()&&!this.is_cap_met_for_user()});l.computed("is_cap_met_for_user",function(){var a=this.end_user_cap();return null==a||-1===a?!1:this.num_total_redemptions_by_user()>=a});l.computed("remaining_time",function(){if(this.available_end())return c.util.time_remaining(this.available_end())});l.computed("remaining_inventory",
function(){if(this.is_inventorized())return this.total_inventory()-this.sold_inventory()});l.computed("cost",function(){var a=this.default_amount();if(0<a)throw new Gh("cost must be a negative amount");return-a});l.computed("purchase_transaction_group_id",function(){return this.named_transaction_group_id()});l.computed("is_redeemable",function(){return this.is_available()&&(!this.is_inventorized()||0<this.remaining_inventory())});l.computed("is_redeemable_by_user",function(){var a=this.currency_id();
return this.is_redeemable()&&!this.app.auth.is_anonymous()&&this.app.auth.user.balance(a,0)>=this.cost()&&!this.is_locked()&&!this.is_cap_met_for_user()});l.computed("redeemed_goods",function(){if(this.app&&this.app.auth&&this.app.auth.is_anonymous())return[];var a=this.app.auth.user,b=this.variant_named_good_id()||this.id();return c.filter(a.good_summaries(),function(a){return a.named_good_id()===b})});l.computed("redemption_codes",function(){var a=this.redeemed_goods();return c.map(a,function(a){return a.redemption_code()||
null})});l.computed("num_total_redemptions_by_user",function(){return this.redeemed_goods().length});l.computed("is_redeemed",function(){return 0<this.num_total_redemptions_by_user()});l.computed("is_named_level_required",function(){return!!this.required_named_level_id()});l.computed("is_locked",function(){var a=this.app.auth.user;return this.is_named_level_required()?!a.has_named_level(this.required_named_level_id()):!1});l.computed("locked_message",function(){var a=S.get_by_attribute(this.attributes(),
"bdm-locked-msg");if(a)return a.end_user_description()});l.computed("is_physical_reward",function(){return!!S.get_by_attribute(this,"bdm-reward-physical")});l.computed("is_virtual_reward",function(){return!!S.get_by_attribute(this,"bdm-reward-virtual")});l.computed("is_sweepstakes_reward",function(){return!!S.get_by_attribute(this,"bdm-reward-sweepstakes")});l.computed("is_in_wishlist",function(){var a=this.provider;if(a)return-1!==Fh.inArray(this.id(),a.wishlist_ids())});l.computed("redeem_user_input_name",
function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-name")});l.computed("redeem_user_input_department",function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-department")});l.computed("redeem_user_input_email",function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-email")});l.computed("redeem_user_input_phone",function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-phone")});l.computed("redeem_user_input_twitter",function(){return!!S.get_by_attribute(this,
"bdm-redeem-user-input-twitter")});l.computed("redeem_user_input_country",function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-country")});l.computed("redeem_user_input_mailing",function(){return!!S.get_by_attribute(this,"bdm-redeem-user-input-mailing")});l.computed("redeem_user_input_custom",function(){var a=S.get_by_attribute(this.attributes(),"bdm-redeem-input-custom");if(a)try{return Fh.parseJSON(a.pub_description())}catch(b){throw new Gh("Error parsing JSON in custom choice attribute");
}});l.prototype.as_reward=function(){return this};var pb=function(a){Hh.call(this,a)},Te=c.util.convert,Hh=c.model.Model;c.model.LeaderboardResult=Hh.extend(pb);pb.pool.readonly=!0;pb.dependent("best_guess_name",function(){return(this.data().best_guess_name||"").match("[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}")?"Guest":this.data().best_guess_name||this.data().end_user_login});pb.dependent("best_guess_profile_img",function(){return this.data().best_guess_profile_img||
"//graph.facebook.com/100002047711187/picture"});pb.dependent("curr_balance",function(){return Te.integer(this.data(),"curr_balance")||0});pb.dependent("end_user_login",function(){return this.data().end_user_login});pb.dependent("percentile",function(){return Te.integer(this.data(),"percentile")||0});pb.dependent("rank",function(){return Te.integer(this.data(),"rank")||0});(function(){function a(a){l.apply(this,arguments);var b=j.get_by_attribute(this.attributes(),"bdm-campaign-config");if(!b)throw new m("Loyalty Campaigns must have a configuration attribute");
var d=this.config=this.get_config_from_attribute(b);this.define({campaign_id:b.friendly_id(),group_id:d.group_id,template:d.template||"campaign",reward_attribute:d.reward_attribute,optin_ntg:f.integer(d.optin_ntg),eligible_level_id:f.integer(d.eligible_level_id),ineligible_level_id:f.integer(d.ineligible_level_id),report_segmentation_level_collection_id:f.integer(d.report_segmentation_level_collection_id),referral_good_id:f.integer(d.referral_good_id),_selectable_quests:[],_selected_quests:{}});this._quests_fingerprint=
"";this._transaction_cache={};this._transacting=!1;this.messaging={};var b={about:"bdm-campaign-about-message",anonymous:"bdm-campaign-anonymous-message",opted_in:"bdm-campaign-optedin-message",complete:"bdm-campaign-complete-message",incomplete:"bdm-campaign-incomplete-message",share:"bdm-campaign-share-message",unavailable:"bdm-campaign-unavailable-message"},c;for(c in b)d=b[c],this.messaging[c]=this.get_messaging_from_attribute(d)}function b(a){k.call(this,a);this.campaign=a.campaign;this.define({quest_id:a.quest,
attribute_friendly_id:a.attribute,time_period:a.time_period||"requirement",ntg_id:a.ntg,quest:null})}var d=c.$,g=c.async,f=c.util.convert,h=c.util.dates,i=c.api.BigDoor,j=c.model.Model,k=c.Watchable,l=c.model.NamedLevelCollection,m=c.error.EconomyConfigurationError,e=c.model;e.LoyaltyCampaign=l.extend(a);a.uri=l.uri;i.associate("loyalty_campaign",a);a.prototype.config_defaults={requirements:[]};a.prototype.init=function(){var a=this;this.update_selectable_quests();this.provider._quests_fingerprint.subscribe(function(b){b!==
a._quests_fingerprint&&a.update_selectable_quests()});this.should_transact()&&this._transact();this.should_transact.subscribe(function(b){b&&a._transact()})};a.prototype.get_messaging_from_attribute=function(a){a=j.filter_by_attribute(this.attributes(),a);return!a.length?{}:{header:a[0].end_user_title()||"",body:a[0].end_user_description()||""}};a.prototype.get_config_from_attribute=function(a){a=this.parse_config(a);return d.extend({},this.config_defaults,a)};a.prototype.parse_config=function(a){var a=
a.pub_description(),b;try{b=eval("("+a+")")}catch(c){throw new m("Campaign has a malformed configuration attribute");}if(!d.isPlainObject(b))throw new m("Campaign has an invalid configuration");return b};a.computed("visible_start",function(){return new Date(1E3*+this.config.visible_start)});a.computed("visible_end",function(){return new Date(1E3*+this.config.visible_end)});a.computed("optin_start",function(){var a=this.config.optin_start;return a?new Date(1E3*+a):this.visible_start()});a.computed("optin_end",
function(){var a=this.config.optin_end;return a?new Date(1E3*+a):this.visible_end()});a.computed("requirements_start",function(){var a=this.config.requirements_start;return a?new Date(1E3*+a):this.visible_start()});a.computed("requirements_end",function(){var a=this.config.requirements_end;return a?new Date(1E3*+a):this.visible_end()});a.prototype.create_requirement=function(a){a.campaign=this;var a=new b(a),d=this._selectable_quests(),c=this._selected_quests(),g=a.select_quest(d,c),f;0<=g&&(f=d[g],
c[f.id()]=f);a.quest(f);return a};a.computed("requirements",function(){if(!this.provider)return[];var a=this.config.requirements;return this._selectable_quests().length<a.length?[]:c.map(a,this.create_requirement,this)});a.computed("is_ready",function(){var a=this.num_requirements(),b=this.requirements();if(b.length!==a)return!1;for(a=0;a<b.length;a++)if(!b[a].is_ready())return!1;return!0});a.computed("num_requirements",function(){return this.config.requirements.length});a.computed("completed_requirements",
function(){var a=this.requirements(),a=c.filter(a,function(a){return!!a.when_completed()});a.sort(function(a,b){var d=a.when_completed().getTime(),c=b.when_completed().getTime();if(d!=c)return d-c;d=a.quest().id();c=b.quest().id();return d-c});return a});a.prototype.update_selectable_quests=function(){var a=this.provider.quests(),b=this.provider._quests_fingerprint(),d=this.requirements_start(),a=c.filter(a,function(a){a=a.when_completed();return!a||+a>=+d});this._quests_fingerprint=b;this._selectable_quests(a);
this._selected_quests({})};a.computed("rewards",function(){if(!this.provider)return[];var a=this.provider.rewards(),b=this.reward_attribute(),d=this.campaign_id();b&&(a=j.filter_by_attribute(a,b));return c.map(a,function(a){try{return a.as_reward(d)}catch(b){}})});a.computed("available_rewards",function(){var a=this.rewards();return c.filter(a,function(a){return a.is_available_to_user()})});a.computed("autoredeem_rewards",function(){var a=this.rewards();return j.filter_by_attribute(a,"bdm-autoredeem-reward")});
a.computed("redeemed_rewards",function(){var a=this.rewards();return c.filter(a,function(a){return a.is_redeemed()})});a.computed("referral_code",function(){var a=this.referral_good_id();if(a){var b=this.app.auth.user.good_summaries();return c.first(b,function(b){if(b.named_good_id()===a)return b.redemption_code()})}});a.computed("chosen_reward",function(){var a=this.rewards();return c.first(a,function(a){return this.provider.wishlist.contains(a)},this)});a.prototype.choose_reward=function(a){this.provider.choose_reward(a)};
a.computed("is_user_eligible",function(){var a=this.app.auth.user,b=this.eligible_level_id();return b?a.has_named_level(b):(b=this.ineligible_level_id())?!a.has_named_level(b):!0});a.prototype.is_within_visible_period=function(a){var a=a||h.now(),b=this.visible_start(),d=this.visible_end();return a>=b&&a<d};a.prototype.is_within_requirement_period=function(a){var a=a||h.now(),b=this.requirements_start(),d=this.requirements_end();return a>=b&&a<d};a.prototype.is_within_optin_period=function(a){var a=
a||h.now(),b=this.optin_start(),d=this.optin_end();return a>=b&&a<d};a.prototype.opt_in=function(){var a=this.optin_ntg(),b=this.app.auth.user;a&&b.transact(a)};a.computed("has_user_opted_in",function(){var a=this.currency(),a=this.app.auth.user.balance(a.id(),0),b=this.optin_threshold();return a>=b});a.computed("optin_threshold",function(){var a=this.config.optin_threshold;null==a&&((a=this.named_levels()[0])&&a.threshold(),a=1);return a});a.computed("redeem_threshold",function(){var a=this.named_levels().slice(-1)[0];
return a?a.threshold():this.optin_threshold()+this.num_requirements()+1});a.computed("num_requirements_completed",function(){return this.completed_requirements().length});a.computed("num_requirements_credited",function(){var a=this.currency(),a=this.app.auth.user.balance(a.id(),0),b=this.num_requirements(),d=this.optin_threshold(),c=this.redeem_threshold();return a<=d?0:a>=c?b:a-d});a.computed("should_transact",function(){return!this.has_user_opted_in()||!this.is_ready()?!1:this.num_requirements_credited()<
this.num_requirements_completed()});a.prototype._redeem=function(a,b){if(a.is_redeemable_by_user()&&!a.is_redeemed()){var d=this.app.auth.user,c=d.end_user_login(),g=a.purchase_transaction_group_id();d.transact(g,{good_receiver:c},function(){b()})}else b()};a.prototype._transact=function(){if(!this._transacting){var a=this,b=this.completed_requirements();b.reverse();var d=c.map(b,function(b){if(!b._transacted())return function(d){b.transact(function(b,c){!b&&!a.should_transact()&&(b="done");d(b,c)})}}),
b=this.autoredeem_rewards();c.each(b,function(b){d.push(function(d){a._redeem(b,d)})});this._transacting=!0;g.series(d,function(){a._transacting=!1})}};e.CampaignRequirement=k.extend(b);b.computed("is_complete",function(){var a=this.quest();if(!a)return!1;if(a=a.when_completed()){var b="is_within_"+this.time_period()+"_period";return(this.campaign[b]||this.campaign.is_within_requirement_period).call(this.campaign,a)}return!1});b.computed("when_completed",function(){var a=this.quest();return a?a.when_completed():
null});b.computed("is_ready",function(){return null!=this.quest()});b.prototype.transact=function(a){var b=this.ntg_id(),d=this.campaign;d.app.auth.user.transact(b,function(c,g,f){var e;"success"==g||f&&503==f.code?d._transaction_cache[b]=!0:e="error";a&&a(e,this)},this)};b.computed("_transacted",function(){return!!this.campaign._transaction_cache[this.ntg_id()]});b.prototype.select_quest=function(a,b){var d=this.quest_id(),g=this.attribute_friendly_id(),f,e;d?f=function(a){return a.id()==d}:g&&(f=
function(a){a=a.attributes();return!!c.first(a,function(a){return a.friendly_id()==g})});if(f)for(var h=0;h<a.length;h++)if(e=a[h],!b[e.id()]&&f(e))return h;return-1}})();var Ih=c.Watchable;(c.controller={}).Controller=Ih.extend(function(a,b){Ih.call(this,a);this.app=b||c.app.current()});var qb=function(a){Jh.apply(this,arguments);this.session=a.session;this.name=a.name;this.define("ids",[])},zl=c.$,Jh=c.controller.Controller;c.controller.Wishlist=Jh.extend(qb);qb.prototype.refresh=function(){var a=
this.session.read(this.name),b=[];a&&(b=c.map(a.split(","),function(a){return parseInt(a,10)}));this.ids(b)};qb.prototype.get_id=function(a){var b;"object"===zl.type(a)?(b=a.id,"function"===typeof b&&(b=b.call(a))):b=a;return b};qb.prototype.save=function(){var a=this.ids(),b={};b[this.name]=a.join(",");this.session.write(b)};qb.prototype.replace=function(a){var b=this.get_id(a);this.ids.removeAll();this.ids.push(b);this.save();c.trigger("user.wish.added",a)};qb.prototype.add=function(a){var b=this.get_id(a);
-1===this.ids.indexOf(b)&&(this.ids.push(b),this.save(),c.trigger("user.wish.added",a))};qb.prototype.remove=function(a){var b=this.get_id(a);this.ids.remove(b).length&&(this.save(),c.trigger("user.wish.removed",a))};qb.prototype.contains=function(a){a=this.get_id(a);return-1!==this.ids.indexOf(a)};var t=function(a){a=a||{};Kh.apply(this,arguments);this.owner=a.owner;this.parent=a.parent||"body";this.target_element=a.target_element;this.insert_mode=a.insert_mode||"append";this.empty_parent=a.empty_parent||
!1;this.render_classification=a.render_classification||"embedded";this.templates=a.templates||{};a.template&&(this.templates.index=a.template);this.exclude_robots=a.exclude_robots||!1;a.init_state&&(this.init_state=a.init_state);a.default_state&&(this.default_state=a.default_state);a.show_state&&(this.show_state=a.show_state);a.hidden_state&&(this.hidden_state=a.hidden_state);a.load_state&&(this.load_state=a.load_state);this.define({state:a.state||this.default_state,visible:function(){return this.state()!=
this.hidden_state},is_ready:!1});this.children=a.children||[];a.loading_call&&(this.loading_call=function(){this.state(this.load_state);Lh.walk.callable(a.loading_call,this).apply(this,[function(){this.state(this.default_state)},this])});if(a.loading_call&&a.loading_call_owner_state){var b=a.loading_call_owner_state;this.owner.state.subscribe(xd(this,function(a){a==b&&this.loading_call&&this.loading_call()}))}C.isFunction(this.on_state)&&(this.on_state=xd(this,this.on_state),this.state.subscribe(this.on_state));
this.templates.error&&(this.app&&this.app.state)&&(a.request_signature_regex?(this.request_signature_regex=a.request_signature_regex,c.subscribe("abby_normal",c.bind(this,this.on_abby_normal))):this.app.state.subscribe(xd(this,function(a){if(a==="error"){this.state("error");this.render_error()}})));this._last_state=this.init_state;this.on_state_change_subscription=this.state.subscribe(xd(this,this.on_state_change));this.should_send_impression_event=a.should_send_impression_event||!1;this.should_send_click_events=
a.should_send_click_events||!1;a.css_rules&&(this.css_rules=C.extend({},this.css_rules,a.css_rules));this.render_after=a.render_after||[];this.state_events=a.state_events||{};C.each(this.state_events,c.bind(this,function(a,b){if(b){var f=this;c.subscribe(a,function(a){return function(){f.state(a)}}(b))}}));this.event_namespace=a.event_namespace;this.is_modal=a.is_modal||!1;this.setup_base_events()},C=c.$,xd=c.bind,Al=c.each,Bl=c.map,yd=c.ko,Lh=c.util,Mh=c.error.GamifyConfigurationError,Kh=c.controller.Controller,
Nh=c.controller.widget={};Nh.Widget=Kh.extend(t);t.prototype.init_state="loading";t.prototype.default_state="default";t.prototype.load_state="loading";t.prototype.show_state="default";t.prototype.hidden_state="hidden";t.dependent("view",function(){var a=this.state();return this.templates[a]?this.templates[a]:this.templates.index});t.prototype.css_rules={"bd-widget":{type:"static"}};t.prototype.associate=function(){this.templates.loading&&this.render_loading();var a,b;this.children=Bl(this.children,
function(d){var c;if("string"===C.type(d)){if(this.app.widgets[d])return this.app.widgets[d];c=d;d=this.app.spec.widgets[d];if(null===d||"object"!==C.type(d))throw new Mh("Widget spec must be defined: "+c);}if("object"!==C.type(d))throw new Mh("Expected widget object.");a=this.app.find_type(d.type||"Widget",Nh);if(C.isFunction(a))return b=d.options||{},b.owner=this,b.render_classification=this.render_classification,d=new a(b,this.app),c&&(this.app.widgets[c]=d),d},this);Al(this.children,function(a){a.associate()});
return this};t.prototype.init=function(){C.each(this.children||[],function(a,b){C.isFunction(b.init)&&b.init()})};t.prototype.setup_base_events=function(){this._setup_events_done||(this._setup_events_done=!0,this.event_namespace&&(c.subscribe(this.event_namespace+".show",c.bind(this,this.on_show_event)),c.subscribe(this.event_namespace+".hide",c.bind(this,this.on_hide_event)),c.subscribe(this.event_namespace+".toggle",c.bind(this,this.on_toggle_event))),this.is_modal&&c.subscribe("modals.hide",c.bind(this,
this.on_hide_event)))};t.prototype.template=function(a){return this.templates[a||"index"]};t.prototype.container=function(a){return C(a)};t.prototype.render_loading=function(){var a=this.templates.loading;if(a&&this.parent&&"body"!==this.parent){var b=C(this.parent)[0];b&&yd.renderTemplate(a,this,{},b,"replaceChildren")}};t.prototype.render_error=function(){var a=this.templates.error;if(a&&this.parent&&"body"!==this.parent){var b=C(this.parent)[0];b&&yd.renderTemplate(a,this,{},b,"replaceChildren")}};
t.prototype.render=function(a){var b=c.bind(this,function(){var b=this.target_element,c=this.insert_mode,f=this.empty_parent,h=this.template(),i;if(h){a?(b=C(a),f=!1):this.target_element?(b=C(this.target_element).first(),"append"!==c&&"prepend"!==c&&(f=!1)):(b=C(this.parent).first(),c="append",f="body"!==this.parent);if(b.length){f&&b.empty();var f=document.createComment("bd-widget"),j=c;"replace"===c&&(j="replaceWith");b[j](f);yd.renderTemplate(h,this,{afterRender:function(a){for(var b=0;b<a.length;b++)if(a[b].nodeType===
1){i=C(a[b]);break}}},f,"replaceNode")}if(i)return this.apply_css_rules(i,this.css_rules),this.render_children(i),this.node instanceof C?this.node.add(i):this.node=C(i),this.exclude_robots&&this.apply_robot_exclusion(),this.node}});this.render_after.length?Lh.wait_for(this.render_after).then(b):b()};t.prototype.apply_robot_exclusion=function(){this.node.addClass("robots-nocontent");this.node.before("<\!--googleoff: all--\>","<\!-- google_ad_section_start(weight=ignore) --\>");this.node.after("<\!-- google_ad_section_end --\>",
"<\!--googleon: all--\>")};t.prototype.actions=function(a,b){this.actions_state();this.is_ready(!0);C.isFunction(a)&&a.call(b||this)};t.prototype.actions_state=function(){this.state()!==this.default_state&&this.state(this.default_state)};t.prototype.render_children=function(a){for(var b=this.children||[],d=0;d<b.length;d++)this.render_child(b[d],a)};t.prototype.render_child=function(a,b){a.render(this.container(b))};t.prototype.render_template=function(a,b){var d=document.createElement("div");yd.renderTemplate(a,
b,{},d,"replaceChildren");return C.trim(C(d).text())};t.prototype.show=function(){this.state()!==this.show_state&&this.state(this.show_state);return this.state()};t.prototype.hide=function(){this.state()!==this.hidden_state&&this.state(this.hidden_state);return this.state()};t.prototype.toggle=function(){this.state(this.state()==this.hidden_state?this.show_state:this.hidden_state);return this.state()!=this.hidden_state};t.prototype.animate=function(a,b){C.isPlainObject(a)?this.node&&C(this.node).animate(a):
C(a).animate(b||{});return this};t.prototype.on_state_change=function(a){(this._last_state===this.init_state||this._last_state===this.hidden_state)&&a!==this.hidden_state&&this.report_impression();this._last_state=a};t.prototype.report_impression=function(){if(this.should_send_impression_event){var a=this.get_widget_identifier_for_element(this.node);c.trigger("widget.impression",[a])}};t.prototype.on_click_event=function(a,b){this.report_click_event(b.currentTarget)};t.prototype.report_click_event=
function(a){if(this.should_send_click_events){var b={};a instanceof HTMLElement||a instanceof C?b=this.get_widget_identifier_for_element(a):a instanceof Object&&(b=a);c.trigger("widget.click",[b])}};t.prototype.get_widget_identifier_for_element=function(a){var b=C(a),d=[],g=b.attr("data-bd-identifier"),f=b.attr("data-bd-meta"),a={};g&&d.unshift(g);c.each(b.parents(),function(a){a=C(a);if(a.is("body"))return!1;(g=a.attr("data-bd-identifier"))&&d.unshift(g);f||(f=a.attr("data-bd-meta"))});b=d.join(".").toLowerCase();
b=b.replace(/-| /g,"_");a.widget_identifier=b;f&&(a.meta=f);return a};t.prototype.apply_css_rules=function(a,b){var a=a||this.node,d=this;C.each(b,function(b,c){var h=c.type,i=c.condition;("static"===h||"regex"===h&&d.evaluate_regex_rule(i)||"boolean"===h&&d.evaluate_boolean_rule(i))&&a.addClass(b)})};t.prototype.evaluate_regex_rule=function(a){if(!a)return!1;try{return RegExp(a).test(window.location.href)}catch(b){return!1}};t.prototype.evaluate_boolean_rule=function(a){if(!a)return!1;try{return(new Function("app",
"return ("+a+");")).call(this,this.app)}catch(b){return!1}};t.prototype.on_abby_normal=function(a,b){b.matches_request_signature(RegExp(this.request_signature_regex))&&(this.state("error"),this.render_error())};t.prototype.on_show_event=function(){this.is_modal&&c.trigger("modals.hide",[this]);this.visible()||this.show()};t.prototype.on_hide_event=function(a,b){b!==this&&this.visible()&&this.hide()};t.prototype.on_toggle_event=function(){if(this.visible())this.on_hide_event();else this.on_show_event()};
var Ad=function(a){this.initial_opts=a;this.config_fetched=!1;this.url=a.url;zd.apply(this,arguments);if(!a)return this},Cl=c.$,zd=c.controller.widget.Widget;c.controller.widget.ExternalWidget=zd.extend(Ad);Ad.prototype.render=function(){this.template()||(this.templates.index=new c.Template("<div></div>"));zd.prototype.render.apply(this,arguments);this.url&&!this.config_fetched&&this.fetch_config()};Ad.prototype.fetch_config=function(){c.load.script(this.url);this.config_fetched=!0};Ad.prototype.configure=
function(a){a=Cl.extend(!0,{},this.initial_opts,a);this.node.length&&(a.target_element=this.node,a.insert_mode="replace");this.config_fetched=!0;zd.call(this,a);this.render()};var Ph=function(a){a=a||{};Oh.apply(this,arguments);this.filter=Dl.observable(a.filter||"all")},Dl=c.ko,Oh=c.controller.widget.Widget;c.controller.widget.AssetCollection=Oh.extend(Ph);Ph.prototype.on_item_click=function(a,b){return this.on_click_event(a,b)};var Ib=function(a){a=a||{};Qh.apply(this,arguments);this.hasOwnProperty("model")||
(this.model=El.observable(),this.quest.subscribe||this.quest(),this.on_quest_changed=Rh(this,this.on_quest_changed),this.quest.subscribe(this.on_quest_changed),this.next());this.define("view","active");this.update_view=Rh(this,this.update_view);this.is_quest_complete();this.is_quest_complete.subscribe(this.update_view);this.is_checkpoint_complete();this.is_checkpoint_complete.subscribe(this.update_view)},El=c.ko,Rh=c.bind,Sh=c.util.walk,Qh=c.controller.widget.Widget;c.controller.widget.Checkpoint=
Qh.extend(Ib);Ib.dependent("quest",function(){return this.app.providers.quests.active()});Ib.dependent("is_quest_complete",function(){return!!Sh("quest.is_notifiable_complete",this)});Ib.dependent("is_checkpoint_complete",function(){return!this.model()||!!Sh("model.is_complete",this)});Ib.prototype.next=function(){var a=this.quest();if(a&&(a=a.active())&&this.model()!==a)this.model(a),a.activate();return this.model()};Ib.prototype.update_view=function(){var a="active";this.quest()?this.is_quest_complete()?
a="quest-complete":this.is_checkpoint_complete()&&(a=this.model()===this.quest().last_notifiable()?"quest-complete":"checkpoint-complete"):a="inactive";this.view()!==a&&this.view(a);return this.view()};Ib.prototype.on_quest_changed=function(a){a=a?a.next_notifiable_checkpoint():void 0;this.model()!==a&&this.model(a)};var w=function(a){a=rb.extend(!0,{},w.defaults,a||{});Ic.call(this,a);this.define("active");this.define("vertical",a.vertical||"bottom");this.define("horizontal",a.horizontal||"right");
this.define("persist",a.persist);this.define("push_background",a.push_background);this.define("restore_state",a.restore_state);this.define("change_state_on_quest",a.change_state_on_quest);this.define("is_framed",!1);a.multi_toggle="multi_toggle"in a?a.multi_toggle:!1;this.define("multi_toggle",!!a.multi_toggle);this.positions=rb.extend(w.defaults.positions,a.positions||{});this.position=Jc.observable(this.positions[this.state()]);this.widths=rb.extend(w.defaults.widths,a.widths||{});this.width=Jc.observable(this.widths[this.state()]);
this.heights=rb.extend(w.defaults.heights,a.heights||{});this.height=Jc.observable(this.heights[this.state()]);this.animation=Jc.observable(this.state_animation());this.session=new Fl(this.app.sessions[a.session]);this.app.auth.is_anonymous.subscribe(this.on_is_anonymous,this);this.app.providers.quests.active.subscribe(this.on_active_quest,this);this.chooser_active=Jc.observable(!1);this.chooser_toggled=Bd(this,this.chooser_toggled);this.chooser_active.subscribe(this.chooser_toggled);this.force_inactive_state=
!1;this._view_count_cache_key="bd-minibar-views";this._view_count_cache_vary=a._view_count_cache_vary||"";this.view_count_target=a.view_count_target;this.view_count_target_widget_state=a.view_count_target_widget_state||this.show_state;this.view_count_target_session_state=a.view_count_target_session_state;this.view_count=void 0;this.setup_view_count()},rb=c.$,Jc=c.ko,Bd=c.bind,Fl=c.session.MinibarSessionState,Ic=c.controller.widget.Widget,Gl=c.controller.widget;w.defaults={template:"minibar",container_id:".bd-toolbar:first",
persist:!1,push_background:!1,restore_state:!0,change_state_on_quest:!0,session:"local",widths:{hidden:152,"default":152,active:868},heights:{},positions:{hidden:-132,"default":0,active:0}};Gl.Minibar=Ic.extend(w);w.prototype.show_state="active";w.prototype.hidden_state="default";w.prototype.render=function(){this.is_framed(rb(document.body).hasClass("bd-third-party"));c.page_data&&(c.page_data.app&&c.page_data.app.minimize_quest_bar)&&(this.force_inactive_state=!0,this.change_state_on_quest(!1));
if(this.is_framed())this.state("active");else if(this.restore_state()){var a=this.session.get_state(),b=this.change_state_on_quest(),d=this.app.providers.quests.active();this.force_inactive_state?this.state("default"):a?(b&&("active"===a&&!d)&&(a="default"),this.state(a)):b&&d&&this.state("active")}this.node&&this.node.remove();this.node=Ic.prototype.render.apply(this,arguments)};w.prototype.actions=function(a,b){this.is_ready(!0);rb.isFunction(a)&&a.call(b||this)};w.prototype.activate=function(){};
w.prototype.deactivate=function(){};w.prototype.toggle=function(){};w.prototype.toggle_active=function(){};w.prototype.on_is_anonymous=function(a){a&&this.deactivate_chooser()};w.prototype.on_active_quest=function(a){this.change_state_on_quest()&&(this.is_ready()&&this.latest!==a)&&(a?(this.state("active"),this.deactivate_chooser()):this.state("default"));this.latest=a};w.prototype.state_animation=function(){var a={},b=this.horizontal();"left"===b||"right"===b?a[b]=this.position():"top"===this.vertical()&&
(a.top=this.position());a.width=this.width();b=this.height();void 0!==b&&null!==b&&(a.height=b);return a};w.prototype.activate_chooser=function(){this.chooser_active(!0)};w.prototype.deactivate_chooser=function(){this.chooser_active(!1)};w.prototype.chooser_toggled=function(a){var b=this.app.widgets;a?(b.minibar_onboard&&b.minibar_onboard.hide(),b.minibar_quest_selection&&b.minibar_quest_selection.hide(),b.minibar_checkpoint&&b.minibar_checkpoint.hide(),b.minibar_reward&&b.minibar_reward.hide(),b.minibar_quest_chooser_prompt&&
b.minibar_quest_chooser_prompt.state("active"),b.minibar_quest_chooser&&b.minibar_quest_chooser.state("active"),this.state("active")):(b.minibar_quest_chooser_prompt&&b.minibar_quest_chooser_prompt.hide(),b.minibar_quest_chooser&&b.minibar_quest_chooser.hide(),b.minibar_onboard&&b.minibar_onboard.show(),b.minibar_quest_selection&&b.minibar_quest_selection.show(),b.minibar_checkpoint&&b.minibar_checkpoint.show(),b.minibar_reward&&b.minibar_reward.show(),"active"===this.state()&&!this.app.providers.quests.active()&&
this.state("default"))};w.prototype.on_signout=function(){this.state("default")};w.prototype.on_show_event=function(a,b){var d=this.app.providers.quests;d.lazy_fetch_incomplete(function(){b&&rb.isNumeric(b)&&(b=+b);if(this.app.auth.is_anonymous())b&&d.enqueue_next_quest_id(b),!d.active()&&d.selectable().length&&d.selectable()[0].activate();else{var a=d.get_quest_by_id(b);a?a.activate():d.active()||this.activate_chooser()}Ic.prototype.on_show_event.call(this)},this)};w.prototype.on_hide_event=function(a,
b){if(b!==this){var d=this.app.providers.quests.active();d&&d.deactivate();Ic.prototype.on_hide_event.call(this)}};w.prototype.on_state=function(a){this.app.widgets.minibar_about_tip&&this.app.widgets.minibar_about_tip.hide();this.session.set_state(a);"active"!==a&&this.deactivate_chooser();var a=this.positions[this.state()],b=this.widths[this.state()],d=this.heights[this.state()],c=!1;a!==this.position()&&(this.position(a),c=!0);b!==this.width()&&(this.width(b),c=!0);d!==this.height()&&(this.height(d),
c=!0);c&&this.animation(this.state_animation())};var Hl={"default":"active",hidden:"default"},Th={"default":"hidden",active:"default"},Il={active:"default","default":"hidden",hidden:"default"};w.prototype.alternate=function(){this.state(Il[this.state()])};w.prototype.expand=function(){var a=Hl[this.state()];a&&("default"===a?this.state(a):this.app.providers.quests.active()?this.state(a):(a=this.app.providers.quests.selectable()[0],this.app.providers.quests.active(a)))};w.prototype.collapse=function(){Th[this.state()]&&
this.state(Th[this.state()])};w.prototype.setup_view_count=function(){this.view_count_target&&this.app.bucket.is_in_exposed_bucket()&&(this._view_count_setup_finished=rb.Deferred().then(Bd(this,this.check_view_count_target)),this.render_after.push(this._view_count_setup_finished),this.get_current_view_count(function(a){this.view_count=a;this._view_count_setup_finished.resolve()},this))};w.prototype.check_view_count_target=function(){if(this.view_count_target&&this.view_count===this.view_count_target&&
(this.state(this.view_count_target_widget_state),this.view_count_target_session_state)){var a=Bd(this,function(){this.session.set_state(this.view_count_target_session_state)});setTimeout(a,500)}};w.prototype.get_current_view_count=function(a,b){this.get_cache(function(d,c){if(!c||!c.view_count||c.vary!==this._view_count_cache_vary)c={first_seen:(new Date).getTime(),vary:this._view_count_cache_vary,view_count:0};c.view_count+=1;this.set_cache(c);a&&a.call(b||this,c.view_count)},this)};w.prototype.get_cache=
function(a,b){a&&(a=Bd(b||this,a));c.remote_storage.get(this._view_count_cache_key,a)};w.prototype.set_cache=function(a){c.remote_storage.set(this._view_count_cache_key,a)};w.prototype.destroy_cache=function(){c.remote_storage.destroy(this._view_count_cache_key)};var Fd=function(a){a=Uh.extend({},this.defaults,a);Cd.call(this,a);this.collection=this.app.providers.quests.selectable;this.paginator=new Vh.Paginator(this.collection,{page_size:a.page,loop:a.loop,throttle:a.throttle});this.sent_request=
Dd.observable(!1);this.loading=Dd.observable(!1);this.app.auth.is_anonymous.subscribe(Ed(this,function(){this.sent_request(!1)}));this.state.subscribe(Ed(this,function(a){if("active"==a)this.onactive()}))},Wh=function(a){a=Uh.extend({},this.defaults,a);Cd.call(this,a);this.collection=this.app.providers.quests.all;this.paginator=new Vh.Paginator(this.collection,{page_size:a.page,loop:a.loop,throttle:a.throttle});this.sent_request=Dd.observable(!1);this.loading=Dd.observable(!1);this.app.auth.is_anonymous.subscribe(Ed(this,
function(){this.sent_request(!1)}));this.state.subscribe(Ed(this,function(a){if("active"==a)this.onactive()}))},Uh=c.$,Dd=c.ko,Ed=c.bind,Vh=c.util,Cd=c.controller.widget.Widget,Xh=c.controller.widget;Fd.prototype.defaults={page:3,loop:!0,throttle:13};Fd.prototype.defaults={page:3,loop:!0,throttle:13};Xh.IncompleteQuests=Cd.extend(Fd);Xh.AllQuests=Cd.extend(Wh);Fd.prototype.onactive=function(){this.loading(!0);this.app.providers.quests.lazy_fetch_incomplete(function(){this.loading(!1)},this)};Wh.prototype.onactive=
function(){this.loading(!0);this.app.providers.quests.lazy_fetch_incomplete(function(){this.loading(!1)},this)};var Ue=function(a){Yh.call(this,a);if(!a)return this;this.define({show_progress:a.show_progress||!1,next_primary_level:function(){var a=Zh(this.app.providers.badges.tracks(),function(a){return a.id()==this.app.spec.options.primary_level_collection_id},this);if(a)return Zh(a.badges(),function(a){return!a.earned()})}})},$h=c.ko,Jl=c.bind,Zh=c.first,ai=c.util,Yh=c.controller.widget.Widget,
bi=c.controller.widget;bi.Profile=Yh.extend(Ue);bi.PagedSelection=Ue.extend(function(a){Ue.apply(this,arguments);if(!a)return this;this.items=ai.walk.observable(a.collection,this);if(!this.items)throw"PagedSelection was created with no items. opts.collection: "+a.collection;this.paginator=new ai.Paginator(this.items,{page_size:a.size||4,loop:!0,page_number:a.page_number||1});this.empty_collection=$h.computed({read:function(){return 0===this.paginator.collection().length},owner:this,deferEvaluation:!0});
this.selected=$h.observable();a.autoselect&&this.items.subscribe(Jl(this,function(a){this.selected()||this.selected(a[0])}))});(function(){function a(a){b.call(this,a);if(!a)return this;this.define({is_profile_image_visible:a.is_profile_image_visible||!1,is_display_name_visible:a.is_display_name_visible||!1,is_primary_level_currency_visible:a.is_primary_level_currency_visible||!1,is_primary_redemption_currency_visible:a.is_primary_redemption_currency_visible||!1,is_next_primary_level_badge_visible:a.is_next_primary_level_badge_visible||
!1,is_num_earned_badges_visible:a.is_num_earned_badges_visible||!1,is_rewards_button_visible:a.is_rewards_button_visible||!1,is_quests_button_visible:a.is_quests_button_visible||!1,is_badges_button_visible:a.is_badges_button_visible||!1,is_about_button_visible:a.is_about_button_visible||!1,is_share_container_visible:a.is_share_container_visible||!1,is_rewards_button_notifications_enabled:a.is_rewards_button_notifications_enabled||!1,is_quests_button_notifications_enabled:a.is_quests_button_notifications_enabled||
!1});this.rewards_button_action=a.rewards_button_action||"this.app.widgets.rewards_center.state('default')";this.quests_button_action=a.quests_button_action||"this.app.widgets.dock.chooser_active(true)";this.badges_button_action=a.badges_button_action||"this.app.widgets.profile_modal.state('default')";this.about_button_action=a.about_button_action}var b=c.controller.widget.Widget;c.controller.widget.ProfileView=b.extend(a);a.computed("notifications_provider",function(){return this.app.providers.notifications});
a.prototype.activate_configured_button_action=function(a){try{eval(a)}catch(b){}};a.prototype.on_rewards_button_click=function(){this.activate_configured_button_action(this.rewards_button_action)};a.prototype.on_quests_button_click=function(){this.activate_configured_button_action(this.quests_button_action)};a.prototype.on_badges_button_click=function(){this.activate_configured_button_action(this.badges_button_action)};a.prototype.on_about_button_click=function(){this.activate_configured_button_action(this.about_button_action)}})();
var Da=function(a){Ve.call(this,a);this.queue=We.observableArray([]);this.visible=We.observable(!1);this.on_video_watch_event=c.bind(this,this.on_video_watch_event);this.on_solve_display_event=c.bind(this,this.on_solve_display_event);this.on_solve_solved_event=c.bind(this,this.on_solve_solved_event);this.on_socialvibe_display_event=c.bind(this,this.on_socialvibe_display_event);this.top=We.computed(function(){return this.queue().length?this.queue()[0]:void 0},this)},We=c.ko,Ve=c.controller.widget.Widget;
c.controller.widget.Player=Ve.extend(Da);Da.prototype.render=function(){c.subscribe("video.watch",this.on_video_watch_event);c.subscribe("solve.display",this.on_solve_display_event);c.subscribe("solve.solved",this.on_solve_solved_event);c.subscribe("socialvibe.display",this.on_socialvibe_display_event);Ve.prototype.render.apply(this,arguments)};Da.prototype.show=function(){this.visible(!0)};Da.prototype.hide=function(){this.visible(!1)};Da.prototype.next=function(){this.queue.shift()};Da.prototype.enqueue=
function(a){this.queue.push(a)};Da.prototype.on_video_watch_event=function(a,b,d,c){this.enqueue(b,d,c);this.show()};Da.prototype.on_solve_display_event=function(a,b,d,c){this.enqueue(b,d,c);this.show()};Da.prototype.on_solve_solved_event=function(a,b){this.top()&&b===this.top().model&&this.next()};Da.prototype.on_socialvibe_display_event=function(a,b,d,c){this.enqueue(b,d,c);this.show()};Da.prototype.clear=function(){this.queue([])};var Gd=function(a){a=a||{};this.messenger=a.messenger;this.templates=
a.templates;this.providers_subscription=null;this.subscriptions=[];this.known={}},ci=c.$,Kl=c.Class;(c.controller.notifier={}).Notifier=Kl.extend(Gd);Gd.prototype.watch=function(a,b,d,g,f){this.known[d]=a[b]();this.subscriptions.push(a[b].subscribe(c.curry(ci.proxy(this.on_change,this),d,g,f)))};Gd.prototype.on_change=function(a,b,d,c){c!==this.known[a]&&(this.known[a]=c,b.call(d,c))};Gd.prototype.dispose=function(){this.providers_subscription.dispose();this.providers_subscription=null;ci.each(this.subscriptions,
function(a,b){b.dispose()});this.subscriptions=[]};var Xe=function(a){a=a||{};di.call(this,a);c.subscribe("badges.earned_on_page",Ll.proxy(function(a,d){this.on_earned(d.badge,d.earned_on_page)},this))},Ll=c.$,di=c.controller.notifier.Notifier;c.controller.notifier.Badges=di.extend(Xe);Xe.prototype.on_earned=function(a,b){!c.app.current().auth.authenticating()&&(b&&a.thumbnail()&&!a.is_hidden())&&this.messenger.enqueue(this.templates.badge,a)};Xe.prototype.watch_provider=function(){};var sa=function(a){a=
a||{};ei.call(this,a);this.is_remote_storage_enabled=a.is_remote_storage_enabled||!1;this.contexts=a.contexts||[];this.cache_key="bd-context-notifier";this.cache=null;this.active_context=Ml.observable();a=c.app.current().auth.is_anonymous()?"signin":"app.post.actions";c.subscribe(a,c.bind(this,this.init))},Ml=c.ko,ei=c.controller.notifier.Notifier;c.controller.notifier.ContextNotifier=ei.extend(sa);sa.prototype.init=function(){this.get_cache(c.bind(this,this.evaluate_contexts))};sa.prototype.evaluate_contexts=
function(){if(this.contexts){if(!this.messenger.node)return!1;if(void 0!==this.cache){var a=this,b=c.filter(this.contexts,function(b){if(a.is_condition_true(b.condition))return b});b.length&&(b=c.first(b,function(b){return a.is_context_viewable(b)}))&&this.show_context(b.context)}}};sa.prototype.is_condition_true=function(a){if(!a)return!1;var b=c.app.current();try{return Function("app","return ("+a+")").call(this,b)}catch(d){return!1}};sa.prototype.is_context_viewable=function(a){if(!a)return!1;
if(null===this.cache)return!0;var b=this.cache[a.context];if(!b)return!0;b=b.last_seen;return!b?!0:0===a.days_cache_valid?!0:0<a.days_cache_valid?this.is_timestamp_expired(b,a.days_cache_valid):!1};sa.prototype.is_timestamp_expired=function(a,b){return!a||void 0===b?!1:0===b?!0:this.get_time()>a+86400*b};sa.prototype.show_context=function(a){if(a){var b=this.templates[a]||this.templates.index;this.active_context(a);this.enqueue_template(b);b={context:this.active_context()};c.trigger("context_notifier.impression",
b);this.update_cache_for_context(a)}};sa.prototype.enqueue_template=function(a){a&&this.messenger.enqueue(a)};sa.prototype.update_cache_for_context=function(a){var b={last_seen:this.get_time()};null===this.cache&&(this.cache={});this.cache[a]=b;this.set_cache(this.cache)};sa.prototype.get_cache=function(a,b){var d=this;if(this.is_remote_storage_enabled)c.remote_storage.get(this.cache_key,function(c,g){d.cache=g;a&&a.call(b||this,g)});else{var g=c.storage.get_storage(this.cache_key);this.cache=g;a&&
a.call(b||this,g)}};sa.prototype.set_cache=function(a){this.is_remote_storage_enabled?c.remote_storage.set(this.cache_key,a):c.storage.set_storage(this.cache_key,a);this.cache=a};sa.prototype.get_time=function(){return Math.round(c.util.dates.now().getTime()/1E3)};sa.prototype.watch_provider=function(){};var Hd=function(a){a=a||{};fi.call(this,a);for(var b=this.messenger.app,a=a.currencies||[],d=0;d<a.length;d++){var g=a[d];"string"==typeof g&&(a[d]=b.spec.options.currencies[g]||g)}this.currencies=
Nl.observableArray(a);c.subscribe("currency.earned",Ol.proxy(this.detect_earned,this))},Ol=c.$,Nl=c.ko,fi=c.controller.notifier.Notifier;c.controller.notifier.Currency=fi.extend(Hd);Hd.prototype.detect_earned=function(a,b,d,g){if(b&&b.data&&(!this.app||!this.app.auth.authenticating()))if(a=this.templates[d||"default"]){b=b.data().end_user.currency_balances;for(d=0;d<b.length;d++){var f=b[d];if(f.currency_adjusted&&0<=this.currencies.indexOf(f.currency_id)&&(f=new c.model.CurrencyAdjustment(f),0!==
f.adjustment_amount()))this.on_earned(a,f,g)}}};Hd.prototype.on_earned=function(a,b,d){this.messenger.enqueue(a,{earned:b,context:d})};Hd.prototype.watch_provider=function(){};var Ye=function(a){a=a||{};this.campaigns=a.campaigns||{};gi.call(this,a)},hi=c.$,gi=c.controller.notifier.Notifier;c.controller.notifier.Referral=gi.extend(Ye);Ye.prototype.on_referrer=function(a,b,d){var g,f=this.messenger.app.vars.referral||{};if(a.template)g=a.template;else if(b){var h=this.campaigns[b];h&&(g=h.template);
h={};f.campaigns&&(h=f.campaigns[b]);f=hi.extend(!0,{},f,h)}g=g||this.templates.referral;this.messenger.enqueue(g,hi.extend(a,{is_referral:!0,ref_campaign:b,ref_code:d,vars:f}));c.trigger("referral.impression",[b])};Ye.prototype.watch_provider=function(){var a=this;c.subscribe("user.referred",function(b,d,c,f){a.on_referrer(d,c,f)})};(function(){function a(a){this.label=a.label||"";this.action=a.action;this.target=a.target;this.css_class=a.css_class}var b=c.controller.widget.Widget;c.controller.widget.LinkMenu=
b.extend(function(d){b.apply(this,arguments);if(!d)return this;var g=d.links||[];this.links=[];this.links=c.map(g,function(b){return new a(b)})});a.prototype.handler=function(){var a=this.action,b=this.target;if(a&&b)if("toggle"==this.action)(a=c.app.current().widgets[b])&&a.toggle();else if("redirect"==a)window.location=b;else if("eval"==a)try{eval("("+b+")")}catch(f){}}})();var ta=function(a){a=a||{};Ze.call(this,a);this.define({queue:[],shown:!0,style:this.defaults.style,current:function(){return this.queue()[0]},
latest:null});this.visible=Pl.computed({read:function(){return this.shown()&&this.queue().length},owner:this,deferEvaluation:!0});this.notifiers=Id.map(a.notifiers||[],Id.proxy(function(a){if(Id.isFunction(ii[a.type]))return new ii[a.type](Id.extend({},a.options||{},{messenger:this}))},this));this.on_clear_event=c.bind(this,this.on_clear_event);for(var a=["quest.activated"],b=0;b<a.length;b++)c.subscribe(a[b],this.on_clear_event);this.restore_style=c.bind(this,this.restore_style);c.subscribe("signin",
this.restore_style);this.reset_style=c.bind(this,this.reset_style);c.subscribe("signout",this.reset_style)},Id=c.$,Pl=c.ko,Ql=c.each,Ze=c.controller.widget.Widget,ii=c.controller.notifier;c.controller.widget.Messenger=Ze.extend(ta);ta.prototype.defaults={style:"modal"};ta.prototype.render=function(){var a=this.read_style_setting();a?this.style(a):this.app.auth.is_anonymous()&&this.app.auth.user.has_opted_out()&&this.style("hidden");Ql(this.notifiers,function(a){a.watch_provider(this.app.providers)},
this);Ze.prototype.render.apply(this,arguments)};ta.prototype.read_style_setting=function(){return this.app.sessions.remote.read("messenger-style")};ta.prototype.write_style_setting=function(){this.app.sessions.remote.write({"messenger-style":this.style()})};ta.prototype.restore_style=function(){var a=this.read_style_setting()||this.defaults.style;this.style(a)};ta.prototype.reset_style=function(){this.style(this.defaults.style)};ta.prototype.show=function(){this.shown(!0);return this};ta.prototype.hide=
function(){this.shown(!1);return this};ta.prototype.next=function(){this.queue.shift()};ta.prototype.enqueue=function(a,b){var d={template:a,messenger:this,watchable:b,app:this.app};this.queue.push(d);this.latest(d)};ta.prototype.clear=function(){this.queue([]);this.latest(void 0)};ta.prototype.on_clear_event=function(){this.clear()};var Jb=function(a){a=a||{};a.template=a.template||"share-facebook-button";Jd.apply(this,arguments);a.ntg_pub_title=a.ntg_pub_title||"Share";!a.url&&this.app&&(a.url=
a.is_page_widget?this.app.vars.page:this.app.vars.home);if(!a.is_page_widget){if(!a.comment_template_name&&null==a.comment)throw"FacebookShareButton configuration needs a comment template.";if(!a.title_template_name&&null==a.title)throw"FacebookShareButton configuration needs a title template.";if(!a.description_template_name&&null==a.description)throw"FacebookShareButton configuration needs a description template.";if(!a.ntg_pub_title)throw"FacebookShareButton configuration needs a named transaction group pub_title to know which transaction to run.";
if(!a.url)throw"FacebookShareButton configuration needs a URL to share.";}this.define("url",a.url);this.context=a.context;this.comment=a.comment;this.title=a.title;this.description=a.description;this.comment_template_name=a.comment_template_name;this.title_template_name=a.title_template_name;this.description_template_name=a.description_template_name;this.picture=a.picture;this.shorten_url="shorten_url"in a?a.shorten_url:!0;this.shortener=Kd;Jd.call(this,a);this.share_ntg_id=a.share_ntg||this.app.spec.options.share_ntg||
this.app.providers.quests&&this.app.providers.quests.share_ntg_ids[a.ntg_pub_title];if(!this.share_ntg_id)throw"Could not find share named transaction for FacebookShareButton: "+a.ntg_pub_title;this.influence_ntg_id=a.influence_ntg||this.app.spec.options.influence_ntg||this.app.providers.quests&&this.app.providers.quests.share_ntg_ids["Influence NTG"];if(!a.redirect_uri){var b=this.app.spec.bigdoor.hostname||"loyalty.bigdoor.com";"144260708944401"==this.app.spec.options.facebook_app_id&&(b="loyalty.bigdoor.com");
a.redirect_uri=["http:/",b,"media/gambit/facebook/share/complete.html"].join("/")}this.redirect_uri=a.redirect_uri;this.on_click_callback_function=a.on_click_callback_function;this.campaign_id=a.campaign_id},gc=c.$,Kd=c.awesome,Jd=c.controller.widget.Widget;c.controller.widget.FacebookShareButton=Jd.extend(Jb);Jb.prototype.render=function(a){a=gc(this.parent);if(0===a.length)throw"Parent not rendered yet: "+this.parent;Jd.prototype.render.call(this,a)};Jb.prototype.transact=function(){var a=function(a){c.trigger("currency.earned",
[a,"share"])};this.app.auth.is_anonymous()&&this.app.providers.economycache?this.app.providers.economycache.transact(this.share_ntg_id,{},a):this.app.auth.user.transact(this.share_ntg_id,a)};Jb.prototype.render_templates=function(a){var b={context:a},d;a&&gc.isFunction(a.thumbnail)&&a.thumbnail()?d=a.thumbnail().url():a&&gc.isFunction(a.preview)&&a.preview()?d=a.preview().url():this.picture&&(d=this.picture);d&&0===d.indexOf("//")&&(d=window.location.protocol+d);var a=this.redirect_uri.replace("${host}",
window.location.host),g=null!=this.comment?new c.Template(this.comment):this.comment_template_name,f=null!=this.title?new c.Template(this.title):this.title_template_name,h=null!=this.description?new c.Template(this.description):this.description_template_name;return{comment:this.render_template(g,b),title:this.render_template(f,b),description:this.render_template(h,b),url:this.url(),redirect_uri:a,picture:d}};Jb.prototype.on_click=function(){if(this.context){var a="string"==gc.type(this.context)?c.util.walk(this.context,
this):this.context,a=this.render_templates(a);this.shorten_for_facebook(a.url,a.comment,a.picture,a.title,a.description,a.redirect_uri);this.transact()}else this.shorten_for_facebook(this.url(),this.comment,null,null,null,this.redirect_uri);c.subscribe.bind("facebook_share_complete",gc.proxy(this.on_share_complete,this));gc.isFunction(this.on_click_callback_function)&&this.on_click_callback_function.call(this)};Jb.prototype.on_share_complete=function(){this.transact()};Jb.prototype.shorten_for_facebook=
function(a,b,d,c,f,h){b&&120<b.length&&(b=b.substring(0,117)+"...");b="http://www.facebook.com/dialog/feed?app_id="+this.app.options.facebook_app_id+"&display=popup"+(b?"&message="+encodeURIComponent(b):"")+(d?"&picture="+encodeURIComponent(d):"")+(c?"&name="+encodeURIComponent(c):"")+(f?"&description="+encodeURIComponent(f):"")+"&redirect_uri="+encodeURIComponent(h);a=Kd.sanitize_referral_url(a);this.app.auth.is_anonymous()||(a=Kd.add_referral_to_url(a,this.app.auth.user.end_user_login()));this.campaign_id&&
(a=Kd.add_campaign_to_url(a,this.campaign_id));this.shorten_url?this.shortener.shorten_url(a,"facebook-post-popup",b+"&link=AWESM_TARGET",this.app.auth.user.end_user_login(),this.app.app_key,this.influence_ntg_id,"toolbar=0, status=0, width=650, height=400"):(b+="&link="+encodeURIComponent(a),window.open(b,"_blank","toolbar=0, status=0, width=650, height=400"))};var Ld=function(a){this.opts=a||{};ji.apply(this,arguments);this.selector=".bdm-custom-fb-share";this.success=this.opts.success;this.failure=
this.opts.failure;this.link=this.opts.link;this.picture=this.opts.picture;this.name=this.opts.name;this.caption=this.opts.caption;this.description=this.opts.description;this.transaction=this.opts.transaction;this.ref=this.opts.ref;this.campaign_id=this.opts.campaign_id;this._setup_click_handler()},Kb=c.$,Rl=c.log,$e=c.awesome,ji=c.controller.widget.Widget;c.controller.widget.FacebookShareHandler=ji.extend(Ld);Ld.prototype._setup_click_handler=function(){this.app.facebook.init(function(a){if(a)Kb(document).off("click.bd-facebooksharehandler").on("click.bd-facebooksharehandler",
this.selector,Kb.proxy(this.on_click,this))},this)};Ld.prototype.on_click=function(a){if(a&&a.target){var b=Kb(a.target),d=this.app.auth.user.end_user_login(),g=b.attr("bd-data-link")||this.link||c.url.current,g=$e.sanitize_referral_url(g);this.app.auth.is_anonymous()||(g=$e.add_referral_to_url(g,d));this.campaign_id&&(g=$e.add_campaign_to_url(g,this.campaign_id));var f={link:g,picture:b.attr("bd-data-picture")||this.picture,name:b.attr("bd-data-name")||this.name,caption:b.attr("bd-data-caption")||
this.caption,description:b.attr("bd-data-description")||this.description,transaction:b.attr("bd-data-transaction")||this.transaction,ref:b.attr("bd-data-ref")||this.ref},b=Kb.extend({},f);f.event=a;b.method="feed";b.display="popup";this.app.facebook.FB.ui(b,Kb.proxy(function(a){this.share_callback(a,f)},this));c.trigger("share.facebook.click",f)}};Ld.prototype.share_callback=function(a,b){a&&!a.error_code&&a.post_id?(c.trigger("share.facebook.success",b),b.transaction&&this.app.auth.user.transact(b.transaction),
Kb.isFunction(this.success)&&this.success.call(this,a,b)):(a&&a.error_code&&Rl("Facebook share failed: ("+a.error_code+") "+a.error),Kb.isFunction(this.failure)&&this.failure.call(this,a,b))};var Kc=function(a){a=a||{};a.template=a.template||"share-twitter-button";af.apply(this,arguments);a.ntg_pub_title=a.ntg_pub_title||"Share";!a.url&&this.app&&(a.url=a.is_page_widget?this.app.vars.page:this.app.vars.home);if(a.is_page_widget)!a.comment&&!a.comment_template_name&&(a.comment="");else{if(!a.comment_template_name&&
null==a.comment)throw"TweetButton configuration needs a template.";if(!a.ntg_pub_title)throw"TweetButton configuration needs a named transaction group pub_title to know which transaction to run.";}this.context=a.context;this.define("url",a.url);this.comment=a.comment;this.comment_template_name=a.comment_template_name;this.shorten_url="shorten_url"in a?a.shorten_url:!0;this.shortener=c.awesome;this.share_ntg_id=a.share_ntg||this.app.spec.options.share_ntg||this.app.providers.quests&&this.app.providers.quests.share_ntg_ids[a.ntg_pub_title];
if(!this.share_ntg_id)throw"Could not find share named transaction for TweetButton: "+a.ntg_pub_title;this.influence_ntg_id=a.influence_ntg||this.app.spec.options.influence_ntg||this.app.providers.quests&&this.app.providers.quests.share_ntg_ids["Influence NTG"];this.on_click_callback_function=a.on_click_callback_function;this.campaign_id=a.campaign_id},bf=c.$,cf=c.awesome,af=c.controller.widget.Widget;c.controller.widget.TweetButton=af.extend(Kc);Kc.prototype.render=function(a){a=bf(this.parent);
af.prototype.render.call(this,a)};Kc.prototype.transact=function(){var a=function(a){c.trigger("currency.earned",[a,"share",{network:"twitter"}])};this.app.auth.is_anonymous()&&this.app.providers.economycache?this.app.providers.economycache.transact(this.share_ntg_id,{},a):this.app.auth.user.transact(this.share_ntg_id,a)};Kc.prototype.on_click=function(){var a="string"==bf.type(this.context)?c.util.walk(this.context,this):this.context,b="";a?(b=null!=this.comment?new c.Template(this.comment):this.comment_template_name,
b=this.render_template(b,{context:a})):b=this.comment;a=this.url();this.shorten_for_twitter(b,a);this.transact();bf.isFunction(this.on_click_callback_function)&&this.on_click_callback_function.call(this)};Kc.prototype.shorten_for_twitter=function(a,b){b=cf.sanitize_referral_url(b);this.app.auth.is_anonymous()||(b=cf.add_referral_to_url(b,this.app.auth.user.end_user_login()));this.campaign_id&&(b=cf.add_campaign_to_url(b,this.campaign_id));this.shorten_url?a&&133<a.length&&(a=a.substring(0,114),a+=
"... AWESM_TARGET"):(a=a.replace("AWESM_TARGET",""),a+=b);var d="http://twitter.com/intent/tweet?text="+encodeURIComponent(a);this.shorten_url?this.shortener.shorten_url(b,"twitter",d,this.app.auth.user.end_user_login(),this.app.app_key,this.influence_ntg_id,"toolbar=0, status=0, width=550, height=420"):window.open(d,"_blank","toolbar=0, status=0, width=550, height=420")};var Lc=function(a){this.opts=a||{};a.template=a.template||"share-linkedin-button";Md.apply(this,arguments);!a.url&&this.app&&(a.url=
a.is_page_widget?this.app.vars.page:this.app.vars.home);this.define("url",a.url);Md.call(this,a);this.share_ntg_id=a.share_ntg||this.app.spec.options.share_ntg||this.app.providers.quests&&this.app.providers.quests.share_ntg_ids[a.ntg_pub_title];if(!this.share_ntg_id)throw"Could not find share named transaction for LinkedInShareButton: "+a.ntg_pub_title;this.campaign_id=a.campaign_id},Sl=c.$,df=c.awesome,Md=c.controller.widget.Widget;c.controller.widget.LinkedInShareButton=Md.extend(Lc);Lc.prototype.generate_script_tag=
function(){var a=this.opts.url||window.location.href,a=df.sanitize_referral_url(a);this.app.auth.is_anonymous()||(a=df.add_referral_to_url(a,this.app.auth.user.end_user_login()));this.campaign_id&&(a=df.add_campaign_to_url(a,this.campaign_id));a='<script type="in/share"'+(' data-url="'+a+'"');this.opts.counter&&(a+=' data-counter="'+this.opts.counter+'"');return a+"><\/script>"};Lc.prototype.render=function(a){a=Sl(this.parent);if(0===a.length)throw"Parent not rendered yet: "+this.parent;Md.prototype.render.call(this,
a);a.append('<script type="text/javascript" src="//platform.linkedin.com/in.js"><\/script>');a.append(this.generate_script_tag())};Lc.prototype.transact=function(){var a=function(a){c.trigger("currency.earned",[a,"share",{network:"linkedin"}])};this.app.auth.is_anonymous()&&this.app.providers.economycache?this.app.providers.economycache.transact(this.share_ntg_id,{},a):this.app.auth.user.transact(this.share_ntg_id,a)};Lc.prototype.on_click=function(){this.transact()};var Mc=function(a){a=a||{};a.template=
a.template||"share-mailto-button";a.ntg_pub_title=a.ntg_pub_title||"Share";ef.call(this,a);this.to=a.to||"";this.cc=a.cc||"";this.bcc=a.bcc||"";this.subject=a.subject||"";this.url=a.url||this.app.vars.page||this.app.vars.home;this.body=a.body||"";this.subject_template=a.subject_template||"share-mailto-subject";this.body_template=a.body_template||"share-mailto-body";if(!a.is_page_widget)throw"The mailto button is currently only supported as an on page widget";this.new_window=null==a.new_window?!0:
a.new_window;this.share_ntg_id=a.share_ntg||this.app.spec.options.share_ntg||this.app.providers.quests&&this.app.providers.quests.share_ntg_ids[a.ntg_pub_title];if(!this.share_ntg_id)throw"Could not find share named transaction for MailtoButton: "+a.ntg_pub_title;this.campaign_id=a.campaign_id},ki=c.$,ff=c.awesome,ef=c.controller.widget.Widget;c.controller.widget.MailtoButton=ef.extend(Mc);Mc.prototype.render=function(a){a=ki(this.parent);if(0===a.length)throw"Parent not rendered yet: "+this.parent;
ef.prototype.render.call(this,a)};Mc.prototype.get_mailto_uri=function(){var a=this,b="mailto:%TO%?cc=%CC%&bcc=%BCC%&subject=%SUBJECT%&body=%BODY%",d=this.url,d=ff.sanitize_referral_url(d);this.app.auth.is_anonymous()||(d=ff.add_referral_to_url(d,this.app.auth.user.end_user_login()));this.campaign_id&&(d=ff.add_campaign_to_url(d,this.campaign_id));var c={referral_url:d};!this.body&&this.body_template&&(this.body=this.render_template(this.body_template,c));!this.subject&&this.subject_template&&(this.subject=
this.render_template(this.subject_template,c));ki.each(["to","cc","bcc","subject","body"],function(d,h){c[h]=a[h].replace("%URL%",c.referral_url);b=b.replace("%"+h.toUpperCase()+"%",escape(c[h]))});return b};Mc.prototype.on_click=function(){var a=this.get_mailto_uri();this.transact();this.new_window?window.open(a):window.location.href=a};Mc.prototype.transact=function(){var a=function(a){c.trigger("currency.earned",[a,"share",{network:"email"}])};this.app.auth.is_anonymous()&&this.app.providers.economycache?
this.app.providers.economycache.transact(this.share_ntg_id,{},a):this.app.auth.user.transact(this.share_ntg_id,a)};var Nd=function(a){a=a||{};a.template=a.template||"share-plusone-button";a.ntg_pub_title=a.ntg_pub_title||"Share";this.href=li.observable(a.href||window.location.href);this.size=li.observable(a.size||"");if(!a.is_page_widget)throw"The plus one button is currently only supported as an on page widget";gf.call(this,a);this.share_ntg_id=a.share_ntg||this.app.spec.options.share_ntg||this.app.providers.quests&&
this.app.providers.quests.share_ntg_ids[a.ntg_pub_title];if(!this.share_ntg_id)throw"Could not find share named transaction for PlusOneButton: "+a.ntg_pub_title;void 0===window.BDM_plusone_callback&&(window.BDM_plusone_callback=function(a){c.trigger("google.plus.completed",a)});c.subscribe("google.plus.completed",mi.proxy(this.on_plus_complete,this))},mi=c.$,li=c.ko,gf=c.controller.widget.Widget;c.controller.widget.PlusOneButton=gf.extend(Nd);Nd.prototype.render=function(a){a=mi(this.parent);if(0===
a.length)throw"Parent not rendered yet: "+this.parent;gf.prototype.render.call(this,a);window.gapi.plusone.go(a[0].id)};Nd.prototype.on_plus_complete=function(a,b){"on"===b.state&&(b.href==this.href()||b.href==this.href()+"/")&&this.transact()};Nd.prototype.transact=function(){var a=function(a){c.trigger("currency.earned",[a,"share",{network:"google"}])};this.app.auth.is_anonymous()&&this.app.providers.economycache?this.app.providers.economycache.transact(this.share_ntg_id,{},a):this.app.auth.user.transact(this.share_ntg_id,
a)};var tb=function(a){a=a||{};a.ntg_id=a.ntg_id||a.ntgId;a.template=a.template||"like-button";this.url=a.url||location.href;this.width=a.width;this.layout=a.layout||"button_count";hf.call(this,a);a.ntg_id&&(this.ntg_id=a.ntg_id);this.app.auth.subscribe("user_changed",sb.proxy(this.on_user_changed,this))},sb=c.$,Tl=c.awesome,hf=c.controller.widget.Widget;c.controller.widget.LikeButton=hf.extend(tb);tb.prototype.render=function(a){this.node?sb(this.node).empty():hf.prototype.render.call(this,a);var b=
Tl.sanitize_referral_url(this.url);if(this.is_missing_flash_on_ie())this.node.html("<div>Facebook Like<br/>requires Flash.</div>");else{var a=sb('<div class="bd-fb-like-container" style="display:inline-block;height:20px;overflow:hidden;"></div>'),d=sb("<fb:like></fb:like>"),b={href:b,action:"like",send:"false",show_faces:"false",width:this.width||105,layout:this.layout};this.app.auth.is_anonymous()||(b.ref=this.get_referral_attribute_value());d.attr(b);a.append(d);this.node.append(a);this.render_facebook()}return this.node};
tb.prototype.get_referral_attribute_value=function(){var a=this.app.auth.user.end_user_login(),a=a.replace("@",":AT:");return"BDM:"+a};tb.prototype.is_missing_flash_on_ie=function(){if(sb.browser.msie&&9>parseInt(sb.browser.version,10))try{new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(a){return!0}return!1};tb.prototype.render_facebook=function(){var a=this.app.facebook;a&&a.init(function(a){!a||!a.XFBML?this.node.html("Facebook Like<br/>not available"):(this.node.each(function(){a.XFBML.parse(this)}),
this.listen_for_like(a))},this)};tb.prototype.previously_liked=[];tb.prototype.listen_for_like=function(a){this.ntg_id&&a.Event.subscribe("edge.create",sb.proxy(function(a){-1==sb.inArray(a,this.previously_liked)&&(this.previously_liked.push(a),this.app.auth.user.transact(this.ntg_id,function(a){c.trigger("currency.earned",[a,"like",{network:"facebook"}])}))},this))};tb.prototype.on_user_changed=function(){this.render()};var Nc=function(a){a=a||{};a.template||(a.template="send-button");jf.call(this,
a);this.ntg_id=a.ntg_id;this.url=a.url;this.width=a.width;this.height=a.height;this.campaign_id=a.campaign_id;this._handler=null},ni=c.awesome,jf=c.controller.widget.Widget;c.controller.widget.SendButton=jf.extend(Nc);Nc.prototype.render=function(a){a=a||this.parent||"body";this.node&&this.node.empty().remove();var b=this.url;this.app.auth.is_anonymous()||(b=ni.add_referral_to_url(b,this.app.auth.user.end_user_login()));this.campaign_id&&(b=ni.add_campaign_to_url(b,this.campaign_id));this.share_url=
b;jf.prototype.render.apply(this,arguments);var d=this.app.facebook;d&&d.init(function(a){a.XFBML.parse(this.node[0].parentNode);this.subscribe(a,b)},this);return this.node};Nc.prototype.subscribe=function(a,b){this.unsubscribe(a);this._handler=function(a){if(a===b)this.on_send(b)};a.Event.subscribe("message.send",this._handler)};Nc.prototype.unsubscribe=function(a){this._handler&&(a.Event.unsubscribe("message.send",this._handler),this._handler=null)};Nc.prototype.on_send=function(){this.ntg_id&&
this.app.auth.user.transact(this.ntg_id)};var W=function(a){this.opts=a=a||{};oi.call(this,a);this.ntg_id=this.app.spec.providers.checkin.options.ntg_id;this.is_remote_store_enabled=this.app.spec.providers.checkin.options.is_remote_store_enabled||!1;this.cap_interval=a.cap_interval||18E5;this.countdown_start=a.countdown_start||18E4;this.fade_duration=a.fade_duration||5E3;this.is_auto=kf.observable(a.auto);this.is_dismissed=kf.observable(!1);this.is_auto_checkedin=this.is_transacting=!1;this.redemption_curr_adj=
this.opts.redemption_curr_adj;this.level_curr_adj=this.opts.level_curr_adj;this.cache_key_name="bd-checkin";this.display_time=kf.observable("");c.subscribe("user_changed",Xa.proxy(this.on_user_changed,this));c.subscribe("signin",Xa.proxy(this.destroy_cache_record,this));this.is_analytics_enabled=a.is_analytics_enabled||!1},Xa=c.$,kf=c.ko,oi=c.controller.widget.Widget;c.controller.widget.Checkin=oi.extend(W);W.prototype.actions=function(a,b){Xa.isFunction(a)&&a.call(b||this);this.start()};W.prototype.on_user_changed=
function(){this.start()};W.prototype.destroy_cache_record=function(){c.storage.destroy_storage(this.cache_key_name)};W.prototype.start=function(){this.calc_display_time();this.calc_state();this.timer=new c.util.Timer(1E3,this.get_eligible_date(),Xa.proxy(this.on_tick,this));0<this.get_remaining_time()&&this.timer.start();this.is_auto()&&"eligible"==this.state()&&this.checkin(!0)};W.prototype.get_eligible_date=function(){return!this.app.auth.user||!this.last_checkin()||0>this.cap_interval?this.get_current_time():
new Date(1E3*this.last_checkin()+this.cap_interval)};W.prototype.get_current_time=function(){return new Date};W.prototype.get_remaining_time=function(){var a=this.get_eligible_date()-this.get_current_time();return 0>a?0:a};W.dependent("last_checkin",function(){if(this.app.auth.is_anonymous()&&this.app.providers.economycache){var a=c.storage.get_storage(this.cache_key_name);a||(a={});return a.last?Math.ceil(a.last/1E3):null}var b=this;return(a=c.first(this.app.auth.user.currency_balances(),function(a){return a.currency_id()==
b.app.spec.providers.checkin.options.currency_id}))&&0<a.current_balance()?a.data().modified_timestamp:null});W.prototype.get_since_last_checkin=function(){if(this.last_checkin())return this.get_current_time()-1E3*this.last_checkin()};W.prototype.calc_state=function(){var a=this.get_since_last_checkin();this.is_transacting?this.state("checking_in"):a&&a<this.fade_duration&&!this.is_auto_checkedin?this.state("just_checkedin"):0>=this.get_remaining_time()?this.state("eligible"):this.get_remaining_time()<
this.countdown_start?this.state("countdown"):this.state("ineligible");Xa(".bd-checkin-prompt").show()};W.prototype.format_time=function(a){0>a[0]?a=":00":1>a[2]?(a=a[3].toString(),2>a.length&&(a="0"+a),a=":"+a):a=0>=a[3]?a[2]+"m":a[2]+1+"m";return a};W.prototype.calc_display_time=function(){var a=c.util.time_remaining(this.get_eligible_date()),a=this.format_time(a);this.display_time(a)};W.prototype.on_tick=function(){var a=this.get_remaining_time();this.calc_state();this.calc_display_time();6E4>=
a&&1E3!=this.timer.interval&&this.timer.restart(1E3)};W.prototype.click=function(){"eligible"==this.state()&&this.checkin(!1)};W.prototype.checkin=function(a){var b=Xa.proxy(function(){this.is_transacting=!0;a?this.state("just_auto_checkedin"):this.state("checking_in");var b=Xa.proxy(function(b){c.trigger("currency.earned",[b,"checkin"]);this.is_auto_checkedin=a;0<this.get_remaining_time()?(a||(this.state("just_checkedin"),Xa(".bd-checkin-prompt").fadeOut(this.fade_duration)),this.timer.end_date=
this.get_eligible_date(),this.calc_display_time(),this.timer.start()):this.state("eligible");this.is_transacting=!1},this);this.app.providers&&this.app.providers.economycache&&this.app.auth.is_anonymous()?this.app.providers.economycache.transact(this.ntg_id,{redemption_curr_adj:this.redemption_curr_adj,level_curr_adj:this.level_curr_adj},b):this.app.auth.user.transact(this.ntg_id,{amount:1},b);this.is_analytics_enabled&&c.trigger("analytics",["checkin"])},this);if(this.app.providers&&this.app.providers.economycache&&
this.app.auth.is_anonymous()){var d=this.app.auth.user.end_user_login();if(this.is_remote_store_enabled){var g=Xa.proxy(function(a){a&&b()},this);c.remote_storage.throttle(this.cache_key_name,this.cap_interval/1E3,1,d,g)}else c.storage.throttle(this.cache_key_name,this.cap_interval/1E3,1,d)&&b()}else b()};var Ea=function(a){Oc.apply(this,arguments);if(!a)return this;this.define({reward:null,redemption_error:!1,populate_default_name:null==a.populate_default_name?!0:a.populate_default_name,is_processing_form:!1,
autoselect:a.autoselect||!1,change_state_on_reward:null==a.change_state_on_reward?!0:a.change_state_on_reward,fetch_inventory_on_reward:!!a.fetch_inventory_on_reward});this.reward.subscribe(hc(this,this.on_reward));this.redemption_error.subscribe(hc(this,this.on_redemption_error));this.on_state_change_subscription=this.state.subscribe(hc(this,this.on_state_change));this._last_state=this.state();this.provider=this.app.providers[a.provider||"rewards"];a.page&&(this.provider.max_records&&this.provider.max_records(a.page),
this.paginator=new pi.Paginator(this.provider.all,{page_size:a.page,loop:!0}));this.autoselect()&&this.provider.all.subscribe(hc(this,function(a){a[0]&&!this.reward()&&this.reward(a[0])}));c.subscribe("nav_bar.rewards.click",hc(this,this.load_rewards));c.subscribe("rewards.selected",hc(this,function(a,c){this.reward(c)}));this.bdm_tou_key=a.bdm_tou_key||"bdm_tou_agreed1";this.tou_default_state=a.tou_default_state||!1},ua=c.$,Z=c.ko,hc=c.bind,pi=c.util,Oc=c.controller.widget.Widget,qi=c.controller.widget;
qi.RewardsCenter=Oc.extend(Ea);Ea.prototype.on_show_event=function(a,b){this.provider.fetch_if_unfetched(function(){if(b&&ua.isNumeric(b)){var a=this.provider.get_reward_by_id(b);a&&this.reward(a)}Oc.prototype.on_show_event.call(this)},this)};Ea.prototype.on_reward=function(a){this.redemption_error(!1);this.fetch_inventory_on_reward()&&this.state()!==this.hidden_state&&a&&a.fetch_inventory();this.change_state_on_reward()&&(a=a?"detail":"default",a!==this.state()&&this.state(a))};Ea.prototype.on_state_change=
function(a){(this._last_state===this.init_state||this._last_state===this.hidden_state)&&a!==this.hidden_state&&c.trigger("rewards.impression");this._last_state=a;this.fetch_inventory_on_reward()&&a!==this.hidden_state&&(a=this.reward())&&a.fetch_inventory()};Ea.prototype.on_redemption_error=function(a){a&&c.trigger("rewards.redemption_error",[this.reward()])};Ea.prototype.load_rewards=function(){this.provider.fetch_if_unfetched()};Ea.dependent("can_turn_next_page",function(){return this.provider._fetched_all_api_data()&&
(1===this.paginator.page_count()||!1===this.paginator.opts.loop&&this.paginator.page_number()===this.paginator.page_count())?!1:!0});Ea.prototype.fetch_next_page=function(){this.can_turn_next_page()&&(this.provider.start_record(this.provider.start_record()+this.provider.max_records()),this.provider.fetch(this.paginator.turn_next,this))};Ea.dependent("can_turn_previous_page",function(){if(this.provider._fetched_all_api_data()){if(1===this.paginator.page_count()||!1===this.paginator.opts.loop&&1===
this.paginator.page_number())return!1}else if(1===this.paginator.page_number())return!1;return!0});Ea.prototype.fetch_previous_page=function(){this.can_turn_previous_page()&&this.paginator.turn_previous()};Ea.dependent("redemption_form",function(){var a=this,b={},d=this.app.sessions.remote,g="";this.populate_default_name()&&a.app.auth.user&&(g=d.read("name")||a.app.auth.user.best_guess_name()||"");b.name=Z.observable(g);b.is_name_valid=function(){return a.reward()&&a.reward().redeem_user_input_name()?
!!(this.name()&&0<ua.trim(this.name()).length):!0};b.department=Z.observable(d.read("department")||"");b.is_department_valid=function(){return a.reward()&&a.reward().redeem_user_input_department()?!!(this.department()&&0<ua.trim(this.department()).length):!0};b.custom_choice_identifier=function(){if(a.reward()&&a.reward().redeem_user_input_custom())return a.reward().redeem_user_input_custom().identifier};b.custom_choice_label=function(){if(a.reward()&&a.reward().redeem_user_input_custom())return a.reward().redeem_user_input_custom().label};
b.custom_choice_prompt=function(){if(a.reward()&&a.reward().redeem_user_input_custom())return a.reward().redeem_user_input_custom().prompt};b.custom_choice_choices=function(){if(a.reward()&&a.reward().redeem_user_input_custom())return a.reward().redeem_user_input_custom().choices};b.custom_choice=Z.observable(d.read(b.custom_choice_identifier()||""));b.is_custom_choice_valid=function(){return a.reward()&&a.reward().redeem_user_input_custom()?void 0!==this.custom_choice():!0};b.email=Z.observable(d.read("email")||
"");b.is_email_valid=function(){return a.reward()&&a.reward().redeem_user_input_email()?!(!this.email()||!this.email().match(/[A-Z0-9._%+\-]+@[A-Z0-9.\-]+\.[A-Z]{2,4}/i)):!0};b.phone=Z.observable(d.read("phone")||"");b.is_phone_valid=function(){return a.reward()&&a.reward().redeem_user_input_phone()?!!(this.phone()&&0<ua.trim(this.phone()).length):!0};b.twitter=Z.observable(d.read("twitter")||"");b.is_twitter_valid=function(){return a.reward()&&a.reward().redeem_user_input_twitter()?!!(this.twitter()&&
0<ua.trim(this.twitter()).length):!0};b.address1=Z.observable(d.read("address1")||"");b.is_address1_valid=function(){return a.reward()&&a.reward().redeem_user_input_mailing()?!!(this.address1()&&0<ua.trim(this.address1()).length):!0};b.address2=Z.observable(d.read("address2")||"");b.city=Z.observable(d.read("city")||"");b.is_city_valid=function(){return a.reward()&&a.reward().redeem_user_input_mailing()?!!(this.city()&&0<ua.trim(this.city()).length):!0};b.state=Z.observable(d.read("state")||"");b.is_state_valid=
function(){return a.reward()&&a.reward().redeem_user_input_mailing()?!!(this.state()&&0<ua.trim(this.state()).length):!0};b.zip=Z.observable(d.read("zip")||"");b.is_zip_valid=function(){return a.reward()&&a.reward().redeem_user_input_mailing()?!!(this.zip()&&0<ua.trim(this.zip()).length):!0};b.country=Z.observable(d.read("country")||"");b.is_country_valid=function(){return a.reward()&&a.reward().redeem_user_input_country()?!!(this.country()&&0<ua.trim(this.country()).length):!0};b.tou=Z.observable("1"===
d.read(a.bdm_tou_key)||a.tou_default_state);b.is_tou_valid=function(){return this.tou()};b.is_valid=function(){return this.is_name_valid()&&this.is_email_valid()&&this.is_department_valid()&&this.is_custom_choice_valid()&&this.is_phone_valid()&&this.is_twitter_valid()&&this.is_address1_valid()&&this.is_city_valid()&&this.is_state_valid()&&this.is_zip_valid()&&this.is_country_valid()&&this.is_tou_valid()};b.submit_form=function(f,g){var i={},j=a.reward();if(j){j.redeem_user_input_name()&&b.name()&&
(i.name=b.name());j.redeem_user_input_department()&&b.department()&&(i.department=b.department());j.redeem_user_input_custom()&&b.custom_choice()&&(i[b.custom_choice_identifier()]=b.custom_choice());j.redeem_user_input_email()&&b.email()&&(i.email=b.email());j.redeem_user_input_phone()&&b.phone()&&(i.phone=b.phone());j.redeem_user_input_twitter()&&b.twitter()&&(i.twitter=b.twitter());j.redeem_user_input_country()&&b.country()&&(i.country=b.country());if(j.redeem_user_input_mailing()&&(b.address1()&&
(i.address1=b.address1()),b.address1()&&(i.address2=b.address2()),b.city()&&(i.city=b.city()),b.state()&&(i.state=b.state()),b.zip()))i.zip=b.zip();i[a.bdm_tou_key]=b.is_tou_valid()?"1":"";a.is_processing_form(!0);d.write(i,function(){var d,l=a.app.auth.user.end_user_login();d=j.product_variants?j.product_variants()[0].purchase_transaction_group_id():j.purchase_transaction_group_id();l=ua.extend({},{good_receiver:l},i);if(b.campaign)l.campaign_id=b.campaign;delete l[a.bdm_tou_key];a.app.auth.user.transact(d,
l,function(b,d){if(d==="success"){a.redemption_error(false);var i=b.data(),k=i.transaction_group_id,i=c.first(i.end_user.received_good_summaries,function(a){if(k==a.transaction_group_id)return a});c.trigger("currency.spent",[b,"reward",i]);i.redemption_code&&j.redemption_code(i.redemption_code)}else a.redemption_error(true);a.is_processing_form(false);ua.isFunction(f)&&f.call(g||a)})})}};b.intro_message=Z.computed({read:function(){var b=a.reward();if(!b||!b.redeem_intro())return!1;b=b.redeem_intro().end_user_description();
return(new c.Template(b)).render({})},owner:a,deferEvaluation:!0});b.success_message=Z.computed({read:function(){var d=a.reward();if(!d||!d.redeem_success())return!1;var g=d.redeem_success().end_user_description(),i={end_user_title:d.title(),end_user_description:d.description()};d.redeem_user_input_name()&&(i.name=b.name());d.redeem_user_input_department()&&(i.department=b.department());d.redeem_user_input_custom()&&(i.size=b.custom_choice());d.redeem_user_input_email()&&(i.email=b.email());d.redeem_user_input_phone()&&
(i.phone=b.phone());d.redeem_user_input_twitter()&&(i.twitter=b.twitter());d.redeem_user_input_mailing()&&(i.address_1=b.address1(),i.address_2=b.address2(),i.city=b.city(),i.state=b.state(),i.zip=b.zip());d.redeem_user_input_country()&&(i.country=b.country());d.redemption_code()&&(i.redemption_code=d.redemption_code());return(new c.Template(g)).render(i)},owner:a,deferEvaluation:!0});return b});qi.Wishlist=Oc.extend(function(a){Oc.apply(this,arguments);if(!a)return this;this.provider=this.app.providers[a.provider||
"rewards"];this.wishlist_items=this.provider.wishlist;this.paginator=new pi.Paginator(this.wishlist_items,{page_size:a.page||1,loop:!0})});var ri=c.$,Ul=c.ko,si=c.controller.widget.Widget;c.controller.widget.TabbedMenu=si.extend(function(a){si.call(this,a);this.tab=Ul.observable("default");a.toggle_event&&c.subscribe(a.toggle_event,ri.proxy(function(){"default"==this.state()?(this.tab("default"),this.state("visible")):this.state("default")},this));a.hide_event&&c.subscribe(a.hide_event,ri.proxy(function(){this.state("default")},
this))});var Lb=function(a){a=a||{};lf.call(this,a);(this.provider=mf.walk.observable(a.provider,this)||this.app.providers.leaderboard)?(this.global_results=mf.walk.observable(a.global_results,this)||this.app.providers.leaderboard.results,this.user_results=mf.walk.observable(a.user_results,this)||this.app.providers.leaderboard.end_user_result):(this.global_results=Pc.observableArray([]),this.user_results=Pc.observable());this.max_pages=a.max_pages||10;this.provider_names=a.providers||[];this.context=
Pc.observable(a.default_context||"absolute");this.current_provider_name=Pc.observable();this.current_provider=Pc.observable();this.provider_names.length&&this.set_provider(this.provider_names[0])},ti=c.$,mf=c.util,Pc=c.ko,lf=c.controller.widget.Widget;c.controller.widget.Leaderboard=lf.extend(Lb);Lb.prototype.render=function(){if(this.provider)return lf.prototype.render.apply(this,arguments)};Lb.prototype.has_next_global_page=function(){var a=this.provider.max_records();if(this.provider._global_start_record+
a<=(this.max_pages-1)*a){var b=this.global_results().length;return!(!b||0<b%a)}return!1};Lb.prototype.next_global_page=function(a,b){this.has_next_global_page()?(this.provider._global_start_record+=this.provider.max_records(),this.provider._global_leaderboard_fetched(!1),this.provider.fetch_global_leaderboard(a,b)):ti.isFunction(a)&&a.call(b||this)};Lb.prototype.has_previous_global_page=function(){return 0<=this.provider._global_start_record-this.provider.max_records()};Lb.prototype.previous_global_page=
function(a,b){if(this.has_previous_global_page()){var d=this.provider._global_start_record-this.provider.max_records();this.provider._global_start_record=this.has_previous_global_page()?d:0;this.provider._global_leaderboard_fetched(!1);this.provider.fetch_global_leaderboard(a,b)}else ti.isFunction(a)&&a.call(b||this)};Lb.prototype.set_provider=function(a){var b=c.app.current().providers[a];b&&(this.current_provider(b),this.current_provider_name(a))};var of=function(a){a=a||{};nf.apply(this,arguments);
this.provider=this.app.providers.access},nf=c.controller.widget.Widget;c.controller.widget.ContentLock=nf.extend(of);of.prototype.render=function(){this.provider&&nf.prototype.render.apply(this,arguments)};of.prototype.open_rewards_center=function(){this.app.widgets.minibar.state("active");setTimeout(function(){c.trigger("nav_bar.rewards.click")},250)};var qf=function(a){a=a||{};a.ntg_id=a.ntg_id||a.ntgId;a.template=a.template||"twitter-follow-button";this.followee=a.followee||"";this.show_count=
a.show_count||!1;this.size=a.size;pf.call(this,a);a.ntg_id&&(this.ntg_id=a.ntg_id)},ui=c.$,pf=c.controller.widget.Widget;c.controller.widget.TwitterFollowButton=pf.extend(qf);qf.prototype.render=function(a){this.node?ui(this.node).empty():pf.prototype.render.call(this,a);this.render_button();return this.node};qf.prototype.render_button=function(){var a=ui('<a class="twitter-follow-button"></a>');a.attr({href:"https://twitter.com/"+this.followee,"data-show-count":""+this.show_count,"data-lang":"en"});
this.size&&a.attr("data-size",this.size);a.text("Loading...");this.node.empty();this.node.append(a);window.twttr&&window.twttr.widgets&&window.twttr.widgets.load()};var Ka=function(a){rf.apply(this,arguments);if(!a)return this;this.opt_in_redirect_url=a.opt_in_redirect_url;this.opt_out_redirect_url=a.opt_out_redirect_url;this.vars=this.app.spec.vars.opt_in||{};this._events_initialized=!1},ic=c.$,Vl=c.awesome,rf=c.controller.widget.Widget;c.controller.widget.OptIn=rf.extend(Ka);Ka.prototype.render=
function(){rf.prototype.render.apply(this,arguments);this.initialize_events()};Ka.prototype.opt_in_user=function(){this.set_bucket_query_string_and_redirect("exposed",this.opt_in_redirect_url||window.location.href)};Ka.prototype.opt_out_user=function(){this.set_bucket_query_string_and_redirect("opted_out",this.opt_out_redirect_url||window.location.href)};Ka.prototype.show_overlay=function(){this.state("overlay")};Ka.prototype.hide_overlay=function(){this.state("default")};Ka.prototype.is_overlay_visible=
function(){return"overlay"===this.state()};Ka.prototype.set_bucket_query_string_and_redirect=function(a,b){b=Vl.add_param_to_url(b||window.location.href,"bd_bucket",a);window.location=b};Ka.prototype.validate_bucket=function(){var a=this.app.bucket._bucket_override;if(a){var b=a.old_bucket,a=a.new_bucket,d=this.app.bucket._current_bucket;"opted_out"===b&&"exposed"===a&&"exposed"!==d?c.app.current().call_abby_normal({type:"opt_in_error"}):"exposed"===b&&("opted_out"===a&&"opted_out"!==d)&&c.app.current().call_abby_normal({type:"opt_out_error"})}};
Ka.prototype.initialize_events=function(){if(!this._events_initialized){var a=c.app.current().tracker,b=c.tracker.get_user_state;if(a){a.track("com.bigdoor.gambit.opt_in_widget",function(a){c.subscribe("opt_in_widget.impression",function(){var c=b();ic.extend(c,{action:"impression"});a(c)});c.subscribe("opt_in_widget.opt_out_intent_click",function(){var c=b();ic.extend(c,{action:"opt_out_intent_click"});a(c)});c.subscribe("opt_in_widget.opt_out_click",function(){var c=b();ic.extend(c,{action:"opt_out"});
a(c)});c.subscribe("opt_in_widget.opt_in_click",function(){var c=b();ic.extend(c,{action:"opt_in_click"});a(c)});c.subscribe("opt_in_widget.overlay_close",function(){var c=b();ic.extend(c,{action:"overlay_close"});a(c)});c.subscribe("opt_in_widget.overlay_cancel",function(){var c=b();ic.extend(c,{action:"overlay_cancel"});a(c)})});this.node&&c.trigger("opt_in_widget.impression");if(a=this.app.bucket._bucket_override)c.subscribe("app.post.init",this.validate_bucket()),"exposed"===a.new_bucket&&c.trigger("opt_in_widget.opt_in_click");
this._events_initialized=!0}}};var Od=function(a){a=a||{};sf.call(this,a);this.provider=this.app.providers[a.provider||"street_team"]},sf=c.controller.widget.Widget;c.controller.widget.StreetTeam=sf.extend(Od);Od.prototype.twitter_share=function(){if(this.provider.is_active()||this.provider.is_complete()){var a=this.provider.twitter_share_url();a&&(window.open(a,"_blank","toolbar=0, status=0, width=550, height=420"),this.provider.transact())}};Od.prototype.facebook_share=function(){if(this.provider.is_active()||
this.provider.is_complete()){var a=this.provider.facebook_share_url();a&&(window.open(a,"_blank","toolbar=0, status=0, width=650, height=400"),this.provider.transact())}};Od.prototype.render=function(){this.provider&&(sf.prototype.render.apply(this,arguments),this.provider.fetch_the_tweet())};var Fa=function(a){vi.apply(this,arguments);if(!this.asset_collection)throw new c.error.GamifyConfigurationError("Must define a collection to feature");},wi=function(a){this.asset_collection="app.providers.quests.all";
Fa.apply(this,arguments)},xi=function(a){this.asset_collection="app.providers.badges.all_possible_badges";Fa.apply(this,arguments)},yi=function(a){this.asset_collection="app.providers.rewards.all";Fa.apply(this,arguments)},Wl=c.util,Xl=c.model.Model,vi=c.controller.widget.Widget,Pd=c.controller.widget;Pd.FeaturedAsset=vi.extend(Fa);Fa.computed("featured_assets",function(){if(!this.asset_collection)return[];var a;a=Wl.walk.observable(this.asset_collection,this);a=c.filter(a(),function(a){return this.can_asset_be_featured(a)},
this);return a=a.sort(function(a,c){return c.relative_weight()-a.relative_weight()})});Fa.prototype.can_asset_be_featured=function(a){if(!a)return!1;var b=!!c.first(a.attributes(),function(a){return"bdm-featured"===a.friendly_id()});a.featured_image_url||(a.featured_image_url=this.get_featured_image_url(a));return b&&!!a.featured_image_url};Fa.prototype.get_featured_image_url=function(a){if(a)return Xl.get_by_attribute(a.urls(),"bdm-featured")};Fa.prototype.activate_asset=function(){throw c.error.NotImplemented("Must define activate_asset function");
};Pd.QuestFeaturedAsset=Fa.extend(wi);wi.prototype.activate_asset=function(){};Pd.BadgeFeaturedAsset=Fa.extend(xi);xi.prototype.activate_asset=function(){};Pd.RewardFeaturedAsset=Fa.extend(yi);yi.prototype.activate_asset=function(){};var zi=function(a){Qc.apply(this,arguments);this.provider_name=a.provider||"campaigns";this.provider=this.app.providers[this.provider_name];this.define({group_id:a.group_id,campaigns:function(){return this.provider.get_group(this.group_id())}})},tf=function(a){Qc.apply(this,
arguments);var b=a.campaign.campaign_id(),c=this.app.vars.campaigns||{};this.group=a.group;this.campaign=a.campaign;this.provider=this.group.provider;this.templates.index=this.campaign.template();this.vars=c[b]||{}},Qc=c.controller.widget.Widget,Ai=c.controller.widget;Ai.LoyaltyCampaignGroup=Qc.extend(zi);zi.computed("primary_campaign",function(){var a=this.campaigns();if(a.length){if(1==a.length)return a[0];a.sort(function(a,c){var g=a.relative_weight(),f=c.relative_weight();if(g!=f)return f-g;g=
a.created_timestamp();f=c.created_timestamp();if(g!=f)return f-g;g=a.id();f=c.id();return g-f});return a[0]}});Ai.LoyaltyCampaign=Qc.extend(tf);tf.prototype.render=function(){var a=this.app.tracker;a&&!a._tracking_campaigns&&(a._tracking_campaigns=!0,a.track("com.bigdoor.gambit.campaign",function(a){c.subscribe("campaign.impression",function(d,g,f){d=c.tracker.get_user_state();g=g.campaign;d.action="impression";d.meta="campaign__"+g.campaign_id();f&&(d.meta+="%20campaign_view_state__"+f);a(d)})}));
Qc.prototype.render.apply(this,arguments)};tf.prototype.send_impression_event=function(a){this._sent_impression||(this._sent_impression=!0,c.trigger("campaign.impression",[this,a]))};var Ci=function(a){Bi.apply(this,arguments);this.define({state:"idle",is_idle:function(){return"idle"==this.state()},loading:function(){return"loading"==this.state()}})},Bi=c.controller.Controller;(c.controller.provider={}).Provider=Bi.extend(Ci);Ci.prototype.init=function(a,b){a&&a.call(b||this)};var uf=function(a){Di.apply(this,
arguments);if(!a)return this;a=a||{};this.events=a.events||[]},Ei=c.$,Yl=c.map,Zl=c.each,Fi=c.util.Listener,Di=c.controller.provider.Provider;c.controller.provider.Events=Di.extend(uf);uf.prototype.init=function(a,b){this.events=Yl(this.events,function(a){if(a instanceof Fi)return a;if(a)return new Fi(a)});Ei.isFunction(a)&&a.call(b)};uf.prototype.actions=function(a,b){Zl(this.events,function(a){a.bind()});Ei.isFunction(a)&&a.call(b)};var D=function(a){a=a||{};Gi.apply(this,arguments);this.queries=
L.extend({},$l,a.queries);this.session=am.observable(new bm(c.app.current().sessions.remote));if(c.testmode.is_in_test_mode()){var b=c.url.params.bd_quests_num,d=c.url.params.bd_quests_attr;if(b||d)b=isNaN(b)?30:b,c.each(this.queries,function(a){b&&(a.max_records=b);d&&(a.attribute_friendly_id=d)})}a.fields&&a.fields.share_ntg_ids&&(this.share_ntg_ids=a.fields.share_ntg_ids);this.strict_enforce_active_quest=a.strict_enforce_active_quest||!1;this.sort_incomplete_first=a.sort_incomplete_first||!1;this.auto_fetch_complete_for_authenticated=
"undefined"!==typeof a.auto_fetch_complete_for_authenticated?a.auto_fetch_complete_for_authenticated:!0;this.auto_fetch_incomplete_for_authenticated=a.auto_fetch_incomplete_for_authenticated||!1;this.auto_fetch_incomplete_for_anonymous=a.auto_fetch_incomplete_for_anonymous||!1;this.define({all:[],completed:[],selectable:function(){return this.sort(c.filter(this.all(),function(a){return!a.is_passive()&&a.is_visible()&&!a.is_complete()}))},passive:function(){return c.filter(this.all(),function(a){return a.is_passive()&&
a.is_visible()&&!a.is_complete()})},visible:function(){return this.sort(c.filter(this.all(),function(a){return!a.is_passive()&&(a.is_visible()||a.is_complete())}))},active:null});this.on_quest_activated=Ga(this,this.on_quest_activated);this.on_quest_completed=Ga(this,this.on_quest_completed);this.on_quest_deactivated=Ga(this,this.on_quest_deactivated);c.subscribe("quest.activated",this.on_quest_activated);c.subscribe("quest.completed",this.on_quest_completed);c.subscribe("quest.deactivated",this.on_quest_deactivated);
this.on_passive_changed=Ga(this,this.on_passive_changed);this.anonymous_serial_questing=a.anonymous_serial_questing||!1;this.auto_activate_quest_on_signin=a.auto_activate_quest_on_signin||!1;this.incomplete_ready=L.Deferred();this.complete_ready=L.Deferred();this.active_ready=L.Deferred()},Hi=function(a,b,c){L.isFunction(a)&&(c=b,b=a,a=void 0);a=L.extend({},a||this.queries.generic);c=c||this;this.app.bigdoor.quest.query(a,function(a,f,h){a=a||[];L.isArray(a)||(a=[a]);b&&b.call(c,a,f,h)},this)},L=
c.$,am=c.ko,Ga=c.bind,bm=c.session.QuestsSessionState,Gi=c.controller.provider.Provider,$l={generic:{attribute_friendly_id:"bdm-quest-active",max_records:5,order_by:"-created"},anonymous:{attribute_friendly_id:"bdm-quest-active",max_records:1,order_by:"-relative_weight"},featured:{attribute_friendly_id:"bdm-quest-featured",max_records:15,completion:"partial,notstarted",order_by:"-relative_weight"},incomplete:{attribute_friendly_id:"bdm-quest-active",max_records:15,completion:"partial,notstarted",
order_by:"-relative_weight,-created"},complete:{attribute_friendly_id:"bdm-quest",max_records:15,completion:"complete",order_by:"-granted"}};c.controller.provider.Quests=Gi.extend(D);D.prototype.sort=function(a){return a.sort(function(a,c){var g=a.relative_weight(),f=c.relative_weight();if(g!=f)return f-g;g=a.created_timestamp();f=c.created_timestamp();return g-f})};D.prototype.init=function(a,b){this.app.auth.subscribe("user_changing",Ga(this,this.on_user_changing));this.app.auth.subscribe("user_changed",
Ga(this,this.on_user_changed));c.subscribe("signin",Ga(this,this.on_signin));c.subscribe("signout",Ga(this,this.on_signout));this.app.providers.economycache&&c.subscribe("signin",Ga(this,function(){this.active()&&this.active().refresh();this.refresh_passive()}));this.app.auth.user.quests_completed=this.completed;c.subscribe("app.post.data",Ga(this,function(){this.on_user_changed(this.app.auth.user)}));c.subscribe("checkpoint.completed",Ga(this,this.on_checkpoint_complete));L.isFunction(a)&&a.call(b||
this)};D.prototype.on_checkpoint_complete=function(a,b){this.anonymous_serial_questing&&(this.app.auth.is_anonymous()&&this.active().last_notifiable()===b&&b.is_complete()&&2>this.selectable().length)&&this.fetch_incomplete({max_records:1,completion:"notstarted"})};D.prototype.actions=function(a,b){this.activate();this.activate_passive();L.isFunction(a)&&a.call(b||this)};D.prototype.on_passive_changed=function(a){c.each(a,function(a){a.is_active()||a.activate()})};D.prototype.activate_passive=function(){var a=
this.passive();if(a.length)this.on_passive_changed(a);this.passive.subscribe(this.on_passive_changed)};D.prototype.refresh_passive=function(){var a=this.passive();c.each(a,function(a){a.refresh()})};D.prototype.activate=function(a){if(!this.is_activating&&(a=a||this.active()||this.anonymous_quest)){this.is_activating=!0;var b=this.active();this.anonymous_quest&&a!==this.anonymous_quest&&this.anonymous_quest.deactivate();b&&b!==a&&b.deactivate();a.activate();this.active()!==a&&this.active(a);this.is_activating=
!1;return this}};D.prototype.deactivate=function(a){if(!this.is_deactivating&&(a=a||this.active()))return this.is_deactivating=!0,this.active()===a&&(a.deactivate(),this.is_activating||(this.session().clear(),this.active(void 0))),this.is_deactivating=!1,this};D.prototype.on_user_changing=function(){this.app.auth.is_anonymous()?this.anonymous_quest=this.active():this.deactivate();this.all([]);this.completed([])};D.prototype.on_signin=function(){this._fetch_incomplete_called=!1;this.session().active_quest_id()||
this.lazy_fetch_incomplete(function(){var a=this.get_next_queued_quest_id();(a=a&&this.get_quest_by_id(a))?a.activate():this.auto_activate_quest_on_signin&&this.selectable().length&&this.activate(this.selectable()[0])},this)};D.prototype.on_signout=function(){this.app.auth.is_anonymous()&&this.session().clear()};D.prototype.on_user_changed=function(a,b,c){this._fetch_incomplete_called=this._fetch_complete_called=!1;if(this.session().active_quest_id()){var g=b,b=L.proxy(function(){this.session().active_quest_id()?
L.isFunction(g)&&g.apply(c||this,arguments):this.lazy_fetch_incomplete(g,c)},this);this.fetch_active(b,c)}else this.app.auth.is_anonymous()&&this.lazy_fetch_incomplete(b,c);!this.app.auth.is_anonymous()&&this.auto_fetch_complete_for_authenticated&&this.lazy_fetch_complete();!this.app.auth.is_anonymous()&&this.auto_fetch_incomplete_for_authenticated&&this.lazy_fetch_incomplete();this.app.auth.is_anonymous()&&this.auto_fetch_incomplete_for_anonymous&&this.lazy_fetch_incomplete()};D.prototype.on_quest_activated=
function(a,b){this.activate(b)};D.prototype.on_quest_completed=function(a,b){var c=this.completed();-1===L.inArray(b,c)&&0<=L.inArray(b,this.all())&&(this.active()===b&&this.session().clear(),this.completed.push(b));if(!this.app.auth.is_anonymous()){var g=this.get_next_queued_quest_id();g&&this.lazy_fetch_incomplete(function(){var a=this.get_quest_by_id(g);a&&a.activate()},this)}};D.prototype.on_quest_deactivated=function(a,b){this.deactivate(b)};D.prototype.fetch_active=function(a,b){var d=this.session().active_quest_id();
this.app.bigdoor.quest.get(d,function(d){d?(c.first(this.all(),function(a){return a.id()===d.id()})||this.all.push(d),this.strict_enforce_active_quest?this.quest_expected_from_query(d,this.queries.incomplete)&&d.is_visible()?this.activate(d):this.session().clear():this.activate(d),this.active_ready.resolve()):this.session().clear();a&&a.call(b||this,d)},this)};D.prototype.quest_expected_from_query=function(a,b){if(!a||!b)throw new c.error.GamifyConfigurationError("requires a quest and a search query");
var d=b.attribute_friendly_id.split("|"),g=c.map(a.attributes(),function(a){return a.friendly_id()});return 0<c.map(g,function(a){return c.filter(d,function(b){return a===b})}).length};D.prototype.lazy_fetch_incomplete=function(a,b){function c(){this._fetch_incomplete_called=!0;this._fetching_incomplete_quests=!1;L.isFunction(a)&&a.call(b||this)}!this._fetch_incomplete_called&&!this._fetching_incomplete_quests?(this._fetching_incomplete_quests=!0,this.fetch_incomplete(c,this)):a&&this.incomplete_ready.done(function(){a.call(b||
this)})};D.prototype.fetch_incomplete=function(a,b,c){L.isFunction(a)&&(c=b,b=a,a=void 0);var g;g=this.app.auth.is_anonymous()?this.queries.anonymous:this.queries.incomplete;this.state("loading");a=L.extend({},g,a||{});Hi.call(this,a,function(a){if(this.sort_incomplete_first){for(var g=[],i=[],j=0;j<a.length;j++){var k=a[j];k.is_complete()?g.push(k):i.push(k)}a=i.concat(g)}this.all(a);this.state("idle");this.incomplete_ready.resolve();b&&b.call(c||this,a)},this)};D.prototype.lazy_fetch_complete=function(a,
b){function c(){this._fetch_complete_called=!0;this._fetching_complete_quests=!1;L.isFunction(a)&&a.call(b||this)}!this._fetch_complete_called&&!this._fetching_complete_quests?(this._fetching_complete_quests=!0,this.fetch_complete(c,this)):a&&a.call(b||this)};D.prototype.fetch_complete=function(a,b,c){L.isFunction(a)&&(c=b,b=a,a=void 0);a=L.extend({},this.queries.complete,a||{});Hi.call(this,a,function(a){this.completed(a);this._fetch_complete_called=true;this.complete_ready.resolve();L.isFunction(b)&&
b.call(c||this,a)})};D.prototype.get_quest_by_id=function(a,b){a=+a;b=b||this.selectable();return c.first(b,function(b){return b.id()===a})};D.prototype.get_next_quest_queue=function(){var a=this.app.sessions.local.read("next-auth-quest-id")||"";return c.map(a.split(","),function(a){return a?+a:void 0},this)};D.prototype.enqueue_next_quest_id=function(a){var b=this.app.sessions.local,c=this.get_next_quest_queue();-1===L.inArray(a,c)&&(c=[a],c=c.join(","),b.write({"next-auth-quest-id":c}))};D.prototype.get_next_queued_quest_id=
function(){var a=this.app.sessions.local,b=this.get_next_quest_queue(),c=0<b.length?b.shift():void 0,b=b.join(",");a.write({"next-auth-quest-id":b});return c};var ub=function(a){a=a||{};Ii.apply(this,arguments);this.query={attribute_friendly_id:a.attribute_filter||"bdm-badge-track",max_records:a.max_records||100,order_by:a.order_by||"-created"};this.tracks=Ji.observableArray([]).extend({lazy:{load:function(){this.lazy_fetch()},context:this}});this.define({highest_badges:function(){for(var a=this.tracks(),
c=[],g=0;g<a.length;g++){var f=a[g].highest_earned_badge();f&&c.push(f)}return c},all_earned_badges:function(){return c.map(this.tracks(),function(a){return c.map(a.earned_badges(),function(a){return a})})},all_unearned_badges:function(){return c.map(this.tracks(),function(a){return c.map(a.unearned_badges(),function(a){return a})})},most_recently_earned_badges:function(){return this.all_earned_badges().sort(function(a,c){return c.when_earned()-a.when_earned()})},all_possible_badges:function(){return c.map(this.tracks(),
function(a){return c.map(a.badges(),function(a){return a})})},all_primary_badges:function(){if(this.primary_level_track())return this.primary_level_track().badges()},all_earned_primary_badges:function(){if(this.primary_level_track())return this.primary_level_track().earned_badges()},all_unearned_primary_badges:function(){if(this.primary_level_track())return this.primary_level_track().unearned_badges()},all_badges_not_primary:function(){return c.map(this.tracks_not_primary(),function(a){return c.map(a.badges(),
function(a){return a})})},tracks_not_special:function(){return c.filter(this.tracks(),function(a){return 1!==a.badges().length})},special_tracks:function(){return c.filter(this.tracks(),function(a){return 1===a.badges().length}).sort(function(a,c){return a.created_timestamp()-c.created_timestamp()})},special_track:function(){return{app:this.app,title:Ji.observable("Special Badges"),badges:this.special_badges,earned_badges:this.earned_special_badges}},special_badges:function(){return c.map(this.special_tracks(),
function(a){return a.badges()[0]})},earned_special_badges:function(){return c.map(this.special_tracks(),function(a){return c.map(a.earned_badges(),function(a){return a})}).sort(function(a,c){return a.when_earned()-c.when_earned()})},tracks_not_primary:function(){return c.filter(this.tracks(),function(a){return a.id()!=a.app.spec.options.primary_level_collection_id})},primary_level_track:function(){return c.first(this.tracks(),function(a){return a.id()==a.app.spec.options.primary_level_collection_id})},
primary_level_badge:function(){return c.first(this.highest_badges(),function(a){return a.data().named_level_collection_id==a.app.spec.options.primary_level_collection_id})},next_primary_level_badge:function(){var a=this.primary_level_track();if(a)return c.first(a.badges(),function(a){return!1===a.earned()})}});this._fetching=this._fetch_called=!1;this.app.auth.subscribe("user_changed",cm(this,this.on_user_changed));this.badges_ready=vf.Deferred()},vf=c.$,Ji=c.ko,cm=c.bind,dm=c.filter,Ii=c.controller.provider.Provider;
c.controller.provider.Badges=Ii.extend(ub);ub.prototype.init=function(a,b){this.app.auth.is_anonymous()?a.call(b||this):this.lazy_fetch(a,b)};ub.prototype.on_user_changed=function(){this.app.auth.is_anonymous()||this.lazy_fetch()};ub.prototype.on_level_summaries_changed=function(a){if(!(0===a.length||this.app.providers.economycache&&this.app.auth.is_anonymous())){var b=dm(a,function(a){return 1===a.data().leveled_up});0!==b.length&&c.app.current().providers.badges.lazy_fetch(function(){var a=this.provider;
c.each(b,function(b){var f=c.first(a.tracks(),function(a){return b.named_level_collection_id()===a.id()});f&&(f=c.first(f.badges(),function(a){return a.id()===b.named_level_id()}))&&c.trigger("badges.earned_on_page",{badge:f,earned_on_page:!0})},this)},{new_levels:b,provider:c.app.current().providers.badges})}};ub.prototype.set_tracks=function(a){if(!vf.isArray(a))throw Error();this.tracks(a)};ub.prototype.lazy_fetch=function(a,b){!this._fetch_called&&!this._fetching?this.fetch(a,b):a&&a.call(b||
this)};ub.prototype.fetch=function(a,b){this._fetching=!0;this.state("loading");this.app.bigdoor.badge_track.query(this.query,function(c,g,f){c=c||[];this.set_tracks(c);this._fetching=!1;this._fetch_called=!0;this.state("idle");this.badges_ready.resolve();a&&a.call(b||this,c,g,f)},this)};ub.prototype.actions=function(a,b){this.app.auth.user.level_summaries();this.app.auth.user.level_summaries.subscribe(this.on_level_summaries_changed,this);vf.isFunction(a)&&a.call(b||this)};var va=function(a){Ki.call(this,
a);this.session=this.app.sessions.remote;this.all=em.observableArray([]).extend({lazy:{load:"fetch_if_unfetched",context:this}});this.wishlist_name=a.wishlist||"wishlist";this._current_position=0;this._fetched_offsets=[];this.define({start_record:0,attribute_friendly_id:a.attribute_friendly_id||"bdm-network-active",max_records:a.max_records||10,order_by:a.order_by||"-relative_weight,created",fetched:!1,_fetching:!1,_fetched_all_api_data:!1,wishlist_ids:[],query:function(){return{attribute_friendly_id:this.attribute_friendly_id(),
order_by:this.order_by(),max_records:this.max_records(),start_record:this.start_record()}},redeemed:function(){var a=this.app.auth.user;return!this.app.auth.authenticating()&&!this.app.auth.is_anonymous()&&a?a.good_summaries():[]},redeemed_as_rewards:function(){return 0<this.redeemed().length?c.filter(this.all(),function(a){return a.is_redeemed()}):[]},displayed:function(){return this.wishlist().length?fm(this.wishlist(),function(a){return a.cost()}):null},wishlist:function(){var a=this.wishlist_ids();
if(!a.length)return[];var d=this.all();return c.filter(d,function(c){return-1!==Ya.inArray(c.named_good_id(),a)})}});this.app.auth.subscribe("user_changed",Ya.proxy(this.on_user_changed,this));this.show_unavailable_rewards=a.show_unavailable_rewards||!1;this.ready=Ya.Deferred()},Ya=c.$,em=c.ko,fm=c.min,gm=c.map,hm=c.model.Reward,Ki=c.controller.provider.Provider;c.controller.provider.Rewards=Ki.extend(va);va.prototype.init=function(a,b){Ya.isFunction(a)&&a.call(b||this)};va.prototype.on_user_changed=
function(){this.refresh_wishlist()};va.prototype.is_offset_already_fetched=function(a){return-1!==Ya.inArray(a,this._fetched_offsets)};va.prototype.fetch=function(a,b){this._fetched_all_api_data()||this.is_offset_already_fetched(this.start_record())?Ya.isFunction(a)&&a.call(b||this):(this._fetching(!0),this.state("loading"),this.app.bigdoor.fetch("reward",this.query(),function(d){d=hm.from_endpoint(d,this);d.length<this.max_records()&&this._fetched_all_api_data(!0);this.show_unavailable_rewards||
(d=c.filter(d,function(a){return a.is_available()}));this.all((this.all()||[]).concat(d));this.ready.resolve();this.fetched(!0);this._fetching(!1);this.state("idle");this.refresh_wishlist();this._fetched_offsets.push(this.start_record());this._current_position=this.start_record();Ya.isFunction(a)&&a.call(b||this)},this))};va.prototype.fetch_if_unfetched=function(a,b){!this.fetched()&&!this._fetching()?this.fetch(a,b):Ya.isFunction(a)&&this.ready.done(function(){a.call(b||this)})};va.prototype.actions=
function(a,b){this.refresh_wishlist();Ya.isFunction(a)&&a.call(b||this)};va.prototype.refresh_wishlist=function(){this._fetched_wishlist=!1;var a=this.session.read(this.wishlist_name),a=a?gm(a.split(","),function(a){return parseInt(a,10)}):[];this.wishlist_ids(a)};va.prototype.replace_wishlist=function(a){var b=a.named_good_id();this.wishlist_ids.removeAll();this.wishlist_ids.push(b);b={};b[this.wishlist_name]=this.wishlist_ids().join(",");this.session.write(b);c.trigger("user.wish.added",a)};va.prototype.add_to_wishlist=
function(a){var b=a.named_good_id();-1===this.wishlist_ids.indexOf(b)&&(this.wishlist_ids.push(b),b={},b[this.wishlist_name]=this.wishlist_ids().join(","),this.session.write(b),c.trigger("user.wish.added",a))};va.prototype.remove_from_wishlist=function(a){var b=a.named_good_id();this.wishlist_ids.remove(b).length&&(b={},b[this.wishlist_name]=this.wishlist_ids().join(","),this.session.write(b),c.trigger("user.wish.removed",a))};va.prototype.get_reward_by_id=function(a){a=+a;return c.first(this.all(),
function(b){return b.id()===a})};var La=function(a){Li.call(this,a);this.fetched_campaigns={};this.fetching_campaigns={};this.wishlist_name=a.wishlist||"wishlist";this.session=this.app.sessions.remote;this._wishlist=new im({session:this.session,name:this.wishlist_name});this.define({all:[],attribute_friendly_id:a.attribute_friendly_id||"bdm-network-active",max_records:a.max_records||10,order_by:a.order_by||"-relative_weight,created",named_good_collection_id:a.named_good_collection_id});this.ready=
Mi.Deferred()},Mi=c.$,jm=c.model.NamedGood,im=c.controller.Wishlist,Li=c.controller.provider.Provider;c.controller.provider.NamedGoods=Li.extend(La);La.prototype.actions=function(a,b){this._wishlist.refresh();a&&a.call(b||this)};La.prototype.fetch_if_unfetched=function(a){if(!a||!a.length)a=[""];a=c.filter(a,function(a){return!this.fetched_campaigns[a]&&!this.fetching_campaigns[a]},this);a.length&&this.fetch(a)};La.prototype.fetch=function(a){if(!a||0===a.length)a=[""];c.each(a,function(a){this.fetching_campaigns[a]=
!0},this);var b=Mi.extend({},{attribute_friendly_id:this.attribute_friendly_id(),max_records:this.max_records(),order_by:this.order_by(),verbosity:5,campaign_id:a.join(",")||void 0}),d=this.named_good_collection_id();this.app.bigdoor.fetch(d?"named_good_collection/"+d+"/named_good":"named_good",b,function(b,d){c.each(a,function(a){this.fetching_campaigns[a]=!1},this);"success"===d&&(c.each(a,function(a){this.fetched_campaigns[a]=!0},this),this.update(b))},this)};La.prototype.update=function(a){var a=
c.map(a,function(a){a=jm.save(a);a.provider=this;return a},this),b=[],d;if(this.all().length)for(var g=0;g<a.length;g++)d=a[g],-1===this.all.indexOf(d)&&b.push(d);else b=a;b.length&&this.all.push.apply(this.all,b)};La.computed("wishlist_ids",function(){return this._wishlist.ids()});La.computed("wishlist",function(){var a=this.wishlist_ids();if(!a.length)return[];var b=this.all();return c.map(a,function(a){return c.first(b,function(b){return b.id()===a})})});La.prototype.add_to_wishlist=function(a){this._wishlist.add(a)};
La.prototype.remove_from_wishlist=function(a){this._wishlist.remove(a)};La.prototype.replace_wishlist=function(a){this._wishlist.replace(a)};var wf=function(a){a=a||{};Ni.call(this,a);if(!a.ntg_id)throw new c.error.GamifyConfigurationError;this.ntg=a.ntg_id;this.ref_user_login=km.get_referrer(window.location.href);this.ref_user=null},Oi=c.$,km=c.awesome,Ni=c.controller.provider.Provider;c.controller.provider.Influence=Ni.extend(wf);wf.prototype.init=function(a,b){Oi.isFunction(a)&&a.call(b||this)};
wf.prototype.actions=function(a,b){this.ref_user_login&&this.ref_user_login!==this.app.auth.user.end_user_login()&&this.app.auth.user.transact(this.ntg,{passive_end_user:this.ref_user_login},function(a){c.trigger("currency.earned",[a,"influence"])},this);Oi.isFunction(a)&&a.call(b||this)};var Mb=function(a){Pi.apply(this,arguments);if(a){if(!a.ntg_id)throw new c.error.GamifyConfigurationError;this.opts=a;this.session=this.app.sessions.remote;this.ntg_id=a.ntg_id;this.ref_user=null;this.ready=Rc.Deferred();
this.is_remote_store_enabled=a.is_remote_store_enabled||!1;this.campaigns=a.campaigns||{}}},Rc=c.$,Pi=c.controller.provider.Provider,lm=c.session.remote_storage.CrossDomainState;c.controller.provider.Referrals=Pi.extend(Mb);Mb.prototype.init=function(a,b){var d=this.ready;a&&d.then(Rc.proxy(a,b||this));var g=Rc.proxy(function(){this.ref_user_login=c.awesome.get_referrer(c.url.current)||this.recruiter_cookie.read("ref_user");this.ref_campaign_id=c.url.params.bd_ref_campaign||this.recruiter_cookie.read("ref_campaign");
this.ref_code=c.url.params.bd_ref_code||this.recruiter_cookie.read("ref_code");this.ref_site={};this.opts.ref_site&&(this.opts.ref_site.ntg_id&&this.opts.ref_site.param)&&(this.ref_site=this.opts.ref_site,this.ref_site.param_value=c.url.params[this.opts.ref_site.param]||this.recruiter_cookie.read("ref_site"));if(this.ref_user_login)this.app.bigdoor.end_user.get(this.ref_user_login,function(a){if(a){var b={};b.ref_user=this.ref_user_login;if(this.ref_campaign_id)b.ref_campaign=this.ref_campaign_id;
if(this.ref_code)b.ref_code=this.ref_code;this.recruiter_cookie.write(b);this.ref_user=a;this.app.auth.is_anonymous.whenever(false,this.check_new_user,this)}else{this.ref_code=this.ref_campaign_id=this.ref_user_login=this.ref_user=null;this.delete_recruiter_cookie()}d.resolve()},this);else{if(this.ref_site&&this.ref_site.param_value){var a={};a.ref_site=this.param_value;this.ref_campaign_id&&(a.ref_campaign=this.ref_campaign_id);this.ref_code&&(a.ref_code=this.ref_code);this.recruiter_cookie.write(a);
this.app.auth.is_anonymous.whenever(!1,this.check_new_user,this)}d.resolve()}c.subscribe("signin",Rc.proxy(this.delete_recruiter_cookie,this))},this);if(this.is_remote_store_enabled){var f=this;this.recruiter_cookie=new lm("bd-recruiter",{domain:this.app.sessions.local.domain,expires:7},function(a){f.recruiter_cookie=a;g()})}else this.recruiter_cookie=this.get_recruiter_cookie(),g()};Mb.prototype.actions=function(a,b){this.recruiter_cookie.had_previous_value||(this.ref_user&&this.ref_user.end_user_login()!==
this.app.auth.user.end_user_login()&&this.app.auth.is_anonymous()?c.trigger("user.referred",[this.ref_user,this.ref_campaign_id,this.ref_code]):this.ref_site.param_value&&c.trigger("site.referred",[this.ref_site,this.ref_campaign_id,this.ref_code]));Rc.isFunction(a)&&a.call(b||this)};Mb.prototype.get_recruiter_cookie=function(){return new c.session.cookie.StateCookie("bd-recruiter",{domain:this.app.sessions.local.domain})};Mb.prototype.delete_recruiter_cookie=function(){this.recruiter_cookie.read()&&
this.recruiter_cookie.remove()};Mb.prototype.check_new_user=function(){var a=this.app.providers.economycache&&this.app.providers.economycache.new_user_currency_id,b=this.app.auth.user.is_new();a&&(b=0===this.app.auth.user.balance(a));if(b)this.on_new_user()};Mb.prototype.on_new_user=function(){var a=this.ref_user&&this.ref_user.end_user_login();if(a&&a!==this.app.auth.user.end_user_login()){var b=this.ntg_id,d;if(this.ref_campaign_id&&(d=this.campaigns[this.ref_campaign_id])&&d.ntg_id)b=d.ntg_id;
this.app.auth.user.transact(b,{passive_end_user:a,good_receiver:a},function(b){c.trigger("currency.earned",[b,"referral"]);b&&(this.session.write({recruiter:a}),c.trigger("user.referral.completed",[this.ref_user,this.ref_campaign_id,this.ref_code]))},this)}else this.ref_site.param_value&&this.app.auth.user.transact(this.ref_site.ntg_id,{},function(a){c.trigger("currency.earned",[a,"referral"]);a&&(this.ref_site.name&&this.session.write({recruiter:this.ref_site.name}),c.trigger("site.referral.completed",
[this.ref_site]))},this)};var Ri=function(a){Qi.apply(this,arguments)},Qi=c.Watchable;(c.controller.provider.partner={}).Partner=Qi.extend(Ri);Ri.prototype.init=function(){};var xf=function(a){a=a||{};Si.call(this,a)},Si=c.controller.provider.partner.Partner;(c.controller.provider.partner.video={}).VideoPartner=Si.extend(xf);xf.prototype.init=function(){};xf.prototype.get_video=function(){};var Nb=function(a){a=a||{};Ti.call(this,a);this.define({installed:!1,ready:!1});this.players={};this.use_flash=
a.use_flash||!1},mm=c.$,nm=c.model.Video,Ti=c.controller.provider.partner.video.VideoPartner;c.controller.provider.partner.video.YouTubePartner=Ti.extend(Nb);Nb.prototype.on_youtube_api_ready=function(){this.ready(!0)};Nb.prototype.install=function(a,b){this.installed()||(this.use_flash?this.install_flash_api(a,b):this.install_iframe_api(a,b))};Nb.prototype.install_iframe_api=function(a,b){window.YT&&!mm.isEmptyObject(window.YT)?(this.installed(!0),this.on_youtube_api_ready(),a&&a.call(b||this)):
(window.onYouTubeIframeAPIReady=c.bind(this,this.on_youtube_api_ready),this.installed(!0),c.load.script("https://www.youtube.com/player_api",a,b||this))};Nb.prototype.install_flash_api=function(a,b){window.swfobject&&"function"===typeof window.swfobject.embedSWF?(this.installed(!0),a&&a.call(b||this)):(this.installed(!0),c.load.script("//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js",function(){this.on_youtube_api_ready();a&&a.call(b||this)},this))};Nb.prototype.init=function(a,b){a&&a.call(b||
this)};Nb.prototype.get_video=function(a){function b(){new window.YT.Player(h.notifier().id,{width:h.width(),height:h.height(),videoId:a.youtube_id,events:{onStateChange:function(a){0===a.data&&c.trigger("video.watched",h)}}})}function d(){var b=h.notifier().id,d={id:b},f=window.location.protocol+"//www.youtube.com/v/"+a.youtube_id+"?enablejsapi=1&playerapiid=bigdoorplayer&version=3",g=window.onYouTubePlayerReady;window.onYouTubePlayerReady=function(a){if("bigdoorplayer"===a){var d=document.getElementById(b);
window.BD_VIDEO_STATE_CHANGE=function(a){0===a&&c.trigger("video.watched",h)};d.addEventListener("onStateChange","BD_VIDEO_STATE_CHANGE")}else"function"===typeof g&&g.apply(this,arguments)};window.swfobject.embedSWF(f,b,h.width(),h.height(),"8",null,null,{allowScriptAccess:"always"},d)}var g=this,f=this.use_flash,h=new nm({width:a.width,height:a.height,notifier:{id:"ytvideoplayer",template:"youtube",post_render:function(){g.players[this.notifier().id]={video:this};g.install();g.ready()?f?d():b():
g.ready.subscribe(function(a){a&&(f?d():b())})}},url:a.url});return h};var Sc=function(a){Ui.apply(this,arguments);a=a||{};this.partners=this.construct_partners(a.partners||{})},om=c.$,Ui=c.controller.provider.Provider;c.controller.provider.Partner=Ui.extend(Sc);Sc.prototype.construct_partners=function(a){var b={};c.each(a,function(a,g){if(a instanceof Sc)b[g]=a;else if(a.type){var f=this.app.find_type(a.type,c.controller.provider.partner);f&&(b[g]=new f(a.options))}},this);return b};Sc.prototype.init=
function(a,b){var d={};c.each(this.partners,function(a,b){d[b]=c.bind(a,a.init)});c.async.parallel(d,function(){a.call(b||this)})};Sc.prototype.actions=function(a,b){om.isFunction(a)&&a.call(b||this)};var jc=function(a){a=a||{};if(!a.leaderboard_id&&!a.currency_id)throw new c.error.GamifyConfigurationError("Leaderboard provider requires a leaderboard_id or currency_id");Qd.apply(this,arguments);this.opts=a;this.fetch_for_anon_user=a.fetch_for_anon_user||!1;a.leaderboard_id?this.define("leaderboard_id",
a.leaderboard_id):this.define("currency_id",a.currency_id);this.define("max_records",a.max_records||10);this.define("global_leader",null);this.define("precount",a.precount||5);this.define({meta_filter_key:a.meta_filter_key,meta_filter_value:a.meta_filter_value});this.meta_filter_key()&&c.subscribe("profile.write",pm(this,function(a,c,g){this.meta_filter_value()!==g[this.meta_filter_key()]&&this.meta_filter_value(g[this.meta_filter_key()])}));this.define("query",function(){var a={max_records:this.max_records()};
this.currency_id&&(a.filter_value=this.currency_id(),a.type="currency");this.meta_filter_key()&&this.meta_filter_value()&&(a.meta_filter=this.meta_filter_key()+"="+this.meta_filter_value());return a});this.results=Rd.observableArray([]).extend({lazy:{load:"fetch_global_leaderboard",context:this}});this.define({active_sum:null,max_rank:null});this.end_user_result=Rd.observable().extend({lazy:{load:function(){this.app.auth&&this.app.auth.is_anonymous()?this.fetch_for_anon_user&&this.fetch_user_leaderboard():
this.fetch_user_leaderboard()},context:this}});this.relative_results=Rd.observableArray([]).extend({lazy:{load:function(){this.app.auth&&this.app.auth.is_anonymous()?this.fetch_for_anon_user&&this.fetch_relative_leaderboard():this.fetch_relative_leaderboard()},context:this}});this.define({_global_leaderboard_fetched:!1,_global_fetching:!1,_user_leaderboard_fetched:!1,_user_fetching:!1,_relative_leaderboard_fetched:!1,_relative_fetching:!1});this._global_start_record=0;this.app.auth.subscribe("user_changed",
na.proxy(this.on_user_changed,this));this.end_user_results_ready=na.Deferred();this.relative_results_ready=na.Deferred();this.global_results_ready=na.Deferred()},Vi=function(a){a=a||{};Qd.apply(this,arguments);this._fetched=this._fetching=!1;this.define("max_records",a.max_records||10);this.define("meta_key",a.meta_key);this.define("sort_key","active_sum");this._leaderboards=Rd.observableArray([]).extend({lazy:{load:this.fetch,context:this}});this.define("leaderboards",function(){var a=this._leaderboards().slice(0),
c=this.sort_key();a.sort(function(a,b){return b[c]-a[c]||b.active_sum-a.active_sum});for(var g=0;g<a.length;g++)a[g].rank=g+1;return a});this.define("leaderboard",function(){return this._leaderboards()[0]});this.define("leader_by_active_sum",function(){for(var a=this._leaderboards(),c=a[0],g=1;g<a.length;g++){var f=a[g];f.active_sum>c.active_sum&&(c=f)}return c});this.define("leader_by_max_rank",function(){for(var a=this._leaderboards(),c=a[0],g=1;g<a.length;g++){var f=a[g];f.max_rank>c.max_rank&&
(c=f)}return c});this.define("leader_by_avg_balance",function(){for(var a=this._leaderboards(),c=a[0],g=1;g<a.length;g++){var f=a[g];f.avg_balance>c.avg_balance&&(c=f)}return c});this.define("user_leaderboards",function(){var a=this.app.sessions.remote;return c.filter(this.leaderboards(),function(c){return c.meta_key&&c.meta_value&&a.read(c.meta_key)==c.meta_value})});this.define("user_leaderboard",function(){return this.user_leaderboards()[0]})},na=c.$,Rd=c.ko,pm=c.bind,yf=c.model.LeaderboardResult,
Qd=c.controller.provider.Provider,Wi=c.controller.provider;Wi.Leaderboard=Qd.extend(jc);jc.prototype.init=function(a,b){this.meta_filter_key()&&!this.meta_filter_value()&&this.meta_filter_value(this.app.sessions.remote.read(this.meta_filter_key()));a.call(b)};jc.prototype.on_user_changed=function(){this.end_user_result(null);this._user_leaderboard_fetched(!1)};jc.prototype.fetch_global_leaderboard=function(a,b){if(this._global_leaderboard_fetched()||this._global_fetching())na.isFunction(a)&&a.call(b||
this);else{this._global_fetching(!0);var d=na.extend(!0,{start_record:this._global_start_record},this.query()),g="leaderboard/execute";this.leaderboard_id&&(g="leaderboard/"+this.leaderboard_id()+"/execute");this.app.bigdoor.fetch(g,d,function(d,g){if("success"===g){var i=c.map(d.results,function(a){return new yf(a)})||[];this.results(i);this.active_sum(d.active_sum);this.max_rank(d.max_rank);this._global_leaderboard_fetched(!0);this._global_fetching(!1);0===this._global_start_record&&i[0]&&this.global_leader(i[0]);
this.global_results_ready.resolve()}na.isFunction(a)&&a.call(b||this)},this)}};jc.prototype.fetch_user_leaderboard=function(a,b){if(this._user_leaderboard_fetched()||this._user_fetching())na.isFunction(a)&&a.call(b||this);else{this._user_fetching(!0);this.end_user_result(null);var c=this.app.auth.user.end_user_login(),c=na.extend({},this.query(),{end_user:c}),g="leaderboard/execute";this.leaderboard_id&&(g="leaderboard/"+this.leaderboard_id()+"/execute");this.app.bigdoor.fetch(g,c,function(c,d){"success"===
d&&(c.results&&c.results.rank&&this.end_user_result(new yf(c.results)),this.active_sum(c.active_sum),this.max_rank(c.max_rank),this._user_leaderboard_fetched(!0),this._user_fetching(!1),this.end_user_results_ready.resolve());na.isFunction(a)&&a.call(b||this)},this)}};jc.prototype.fetch_relative_leaderboard=function(a,b){if(this._relative_leaderboard_fetched()||this._relative_fetching())na.isFunction(a)&&a.call(b||this);else{this._relative_fetching(!0);var d={relative_to:this.app.auth.user.end_user_login(),
precount:this.precount},d=na.extend(!0,d,this.query());this.app.bigdoor.fetch("leaderboard/"+this.leaderboard_id()+"/execute",d,function(d,f){if("success"===f){var h=c.map(d.results,function(a){return new yf(a)});this.relative_results(h||[]);this.active_sum(d.active_sum);this.max_rank(d.max_rank);this._relative_leaderboard_fetched(!0);this._relative_fetching(!1);this.relative_results_ready.resolve()}na.isFunction(a)&&a.call(b||this)},this)}};Wi.LeaderboardSummary=Qd.extend(Vi);Vi.prototype.fetch=
function(a,b){if(!this._fetching&&!this._fetched){var d=this.meta_key(),g={max_records:this.max_records()};this._fetching=!0;this.state("loading");this.app.bigdoor.fetch("leaderboard",g,function(f,g){this._fetching=!1;this.state("idle");if("success"===g){this._fetched=!0;d&&(f=c.filter(f,function(a){return a.meta_key==d}));for(var i=0;i<f.length;i++)f[i].active_sum=parseFloat(f[i].active_sum),f[i].max_rank=f[i].max_rank||0,f[i].avg_balance=f[i].active_sum/(f[i].max_rank||1);this._leaderboards(f)}a&&
a.call(b||this)},this)}};var Ob=function(a){Xi.apply(this,arguments);if(!a)return this;a=a||{};this.pages=a.pages||[]},zf=c.first,Xi=c.controller.provider.Provider;c.controller.provider.ContentAccess=Xi.extend(Ob);Ob.prototype.get_page_url=function(){return document.location.href};Ob.prototype.access_requirements=function(a){a=a||this.get_page_url();return zf(this.pages,function(b){return b.url?a===b.url:b.url_regex?RegExp(b.url_regex).test(a):!1})};Ob.prototype.required_good=function(a){return(a=
this.access_requirements(a))&&a.good};Ob.prototype.required_level=function(a){return(a=this.access_requirements(a))&&a.level};Ob.prototype.is_locked_page=function(a){return null!=this.access_requirements(a)};Ob.dependent("user_has_access",function(){var a=this.access_requirements();if(a){if(a.good){var b=this.app.auth.user.good_summaries();return!!zf(b,function(b){return b.named_good_id()==a.good.id})}if(a.level)return b=this.app.auth.user.level_summaries(),!!zf(b,function(b){return b.named_level_id()==
a.level.id})}return!0});var E=function(a){Yi.apply(this,arguments);if(!a)return this;a=M.extend({},a||{});if(!a.max_redemption_balance||!a.max_level_balance)throw new c.error.GamifyConfigurationError("EconomyCache: max_redemption_balance or max_level_balance is not defined");this.is_remote_store_enabled=a.is_remote_store_enabled||!1;this.max_redemption_balance=a.max_redemption_balance;this.max_level_balance=a.max_level_balance;this.new_user_ntg_id=a.new_user_ntg_id;this.new_user_currency_id=a.new_user_currency_id;
this.redemption_currency_id=this.app.spec.options.primary_currency_id;this.level_currency_id=this.app.spec.options.primary_level_currency_id;this.default_redemption_curr_adj=a.default_redemption_curr_adj||5;this.default_level_curr_adj=a.default_level_curr_adj||10;this.economy_loaded=Af.observable(!1);this.checkpoint_transacting=Af.observable(!1);this.checkpoint_transacting.subscribe(M.proxy(this.on_checkpoint_transacting,this));this.checkpoint_transaction_queue=Af.observableArray([]);this.cache_key_name=
"bd-cache";this._remote_data_cache=null},M=c.$,Af=c.ko,Tc=c.first,Bf=c.each,qm=c.util.convert,Cf=c.storage,rm=c.uuid,sm=c.async,Sd=c.model,Yi=c.controller.provider.Provider;c.controller.provider.EconomyCache=Yi.extend(E);E.prototype.currency_balance_default_data={adjustment_amount:0,created_timestamp:null,currency_adjusted:0,currency_id:0,current_balance:0,end_user_description:"",end_user_title:"",modified_timestamp:null,previous_balance:0,pub_description:"",pub_title:"",transaction_group_id:"",urls:[],
user:null};E.prototype.level_default_data={collection_uri:"",created_timestamp:null,end_user_description:"",end_user_title:"",latest_named_level_id:3122036,level_id:3550103,leveled_up:0,modified_timestamp:null,named_level_collection_id:3122008,named_level_id:3122036,pub_description:"",pub_title:"",threshold:0,transaction_group_id:"",urls:[]};E.prototype.default_checkpoint_settings={first:{redemption_curr_adj:0,level_curr_adj:0},checkpoint:{redemption_curr_adj:20,level_curr_adj:10},last:{redemption_curr_adj:20,
level_curr_adj:40}};E.prototype.init=function(a,b){c.subscribe("signin",M.proxy(function(){this.destroy_cache_store()},this));this.new_user_ntg_id&&(this.new_user_currency_id?this.app.auth.is_anonymous.whenever(!1,this.check_new_user,this):c.subscribe("new.user",M.proxy(this.check_new_user,this)));this.app.auth.is_anonymous()&&(this.redemption_balance(),this.level_balance());M.isFunction(a)&&a.call(b||this)};E.prototype.current_user=function(){return this.app.auth.user};E.dependent("redemption_balance",
function(){var a=this.current_user(),b;a&&this.redemption_currency_id&&((b=Tc(a.currency_balances(),function(a){return a.currency_id()===this.redemption_currency_id},this))||(b=this.create_currency_balance(this.redemption_currency_id,"coins")));return b});E.dependent("level_balance",function(){var a=this.current_user(),b;a&&this.level_currency_id&&((b=Tc(a.currency_balances(),function(a){return a.currency_id()===this.level_currency_id},this))||(b=this.create_currency_balance(this.level_currency_id,
"xp")));return b});E.prototype.create_currency_balance=function(a,b){var d,g,f,h=this.current_user();if(!a||!b)throw new c.error.GamifyConfigurationError("EconomyCache: create_currency_balance requires currency_id and currency_title");(d=Tc(h.currency_balances(),function(b){return b.currency_id()===a},this))?f=d:(d={currency_id:a,pub_title:b,end_user_title:b},g=M.extend(!0,{},this.currency_balance_default_data,d),f=new Sd.Balance(g),d=M.extend(!0,{},h.data()),d.currency_balances.push(g),Sd.User.call(h,
d));return f};E.prototype.get_cache_store=function(){var a;(a=this.is_remote_store_enabled?this._remote_data_cache:Cf.get_storage(this.cache_key_name))||(a={});return a};E.prototype.set_cache_store=function(a){this.is_remote_store_enabled?(this._remote_data_cache=a,c.remote_storage.set(this.cache_key_name,a)):Cf.set_storage(this.cache_key_name,a)};E.prototype.destroy_cache_store=function(){this.is_remote_store_enabled?(this._remote_data_cache=null,c.remote_storage.destroy(this.cache_key_name)):Cf.destroy_storage(this.cache_key_name)};
E.prototype.set_user_from_user_state=function(a,b,c,g){if(!a||!a.currencies||!a.quests)M.isFunction(c)&&c.call(g||this,a);else{var f=this.app.providers.quests,h=this.current_user(),i=[];i.push(M.proxy(function(c){this.set_redemption_balance(a.currencies.redeem||0,b);this.set_level_balance(a.currencies.level||0,b);c()},this));a.quests&&f&&Bf(a.quests,function(a,b){i.push(M.proxy(function(c){this.set_quest_completed_checkpoints(b,a,function(){c()},this)},this))},this);f=M.proxy(function(){this.economy_loaded(!0);
Sd.User.call(h,h.data(),c,g)},this);sm.parallel(i,f)}};E.prototype.set_user_from_cache=function(a,b){var d;this.economy_loaded()?M.isFunction(a)&&(d=this.is_remote_store_enabled?this._remote_data_cache:this.get_user_state_from_cache(),a.call(b||this,d)):this.is_remote_store_enabled?c.remote_storage.get(this.cache_key_name,M.proxy(function(c,d){this._remote_data_cache=d||null;this.set_user_from_user_state(this._remote_data_cache,null,a,b)},this)):(d=this.get_user_state_from_cache(),this.set_user_from_user_state(d,
null,a,b))};E.prototype.set_cache_from_user_state=function(a){this.app.auth.is_anonymous()&&a&&(a.end_user_login=this.app.auth.user.end_user_login(),this.set_cache_store(a))};E.prototype.get_user_state_from_cache=function(){var a=this.get_cache_store();a&&(a.end_user_login&&a.end_user_login!==this.app.auth.user.end_user_login())&&(this.destroy_cache_store(),a={});return a||{}};E.prototype.get_user_state_from_user=function(){var a=this.app.auth.user,b=this.redemption_balance(),c=this.level_balance(),
g=this.app.providers.quests,f={currencies:{redeem:b.current_balance(),level:c.current_balance()},quests:{}};g&&Bf(a.level_summaries(),function(a){f.quests[a.named_level_collection_id()]?f.quests[a.named_level_collection_id()].push(a.named_level_id()):f.quests[a.named_level_collection_id()]=[a.named_level_id()]},this);return f};E.prototype.set_redemption_balance=function(a,b){var c=this.redemption_balance();c&&(c=this.set_currency_balance(c,b,a));return c};E.prototype.set_level_balance=function(a,
b){var c=this.level_balance();c&&(c=this.set_currency_balance(c,b,a));return c};E.prototype.set_currency_balance=function(a,b,c){if(this.app.auth.is_anonymous()&&a){var g=a.data(),f=qm.real(g.current_balance),c={currency_adjusted:f!==c&&b?1:0,current_balance:c,previous_balance:f,adjustment_amount:c-f};b&&(c.transaction_group_id=b);a.data(M.extend(!0,g,c))}return a};E.prototype.set_quest_completed_checkpoints=function(a,b,c,g){if(a&&b&&b.length){var f,h,i,j=this.current_user();Bf(b,function(b){f=Tc(j.level_summaries(),
function(a){return a.named_level_id()===b},this);f||(h={named_level_id:b,named_level_collection_id:a,leveled_up:1,pub_title:"Named Level "+b},h=M.extend(!0,{},this.level_default_data,h),i=new Sd.Level(h),i.from_economy_cache=!0,j.data().level_summaries.push(i))},this)}M.isFunction(c)&&c.call(g,this)};E.prototype.on_checkpoint_transacting=function(a){!a&&this.checkpoint_transaction_queue().length&&(a=this.checkpoint_transaction_queue.pop(),this.transact_checkpoint(a.checkpoint,a.callback,a.context))};
E.prototype.transact=function(a,b,c,g){var f=this.get_user_state_from_user(),h=this.current_user(),i=rm().replace(/-/g,"").toLowerCase();f.currencies.redeem+=void 0!==b.redemption_curr_adj?b.redemption_curr_adj:this.default_redemption_curr_adj;f.currencies.level+=void 0!==b.level_curr_adj?b.level_curr_adj:this.default_level_curr_adj;f.currencies.redeem>this.max_redemption_balance&&(f.currencies.redeem=this.max_redemption_balance);f.currencies.level>this.max_level_balance&&(f.currencies.level=this.max_level_balance);
b.quest_id&&b.completed_checkpoint_id&&(f.quests[b.quest_id]?f.quests[b.quest_id].push(b.completed_checkpoint_id):f.quests[b.quest_id]=[b.completed_checkpoint_id]);this.set_cache_from_user_state(f);b=M.proxy(function(a){this.set_user_from_user_state(f,i,M.proxy(function(){M.isFunction(c)&&c.call(g||this,a)},this))},this);h.transact(a,{},b,this)};E.prototype.transact_checkpoint=function(a,b,d){var g=this.app.providers.quests,f=M.extend(!0,this.default_checkpoint_settings,this.app.spec.providers.quests.options.anonymous_quests),
h=a.data().named_level_collection_id,i;if(!g)throw new c.error.GamifyConfigurationError("EconomyCache: quest provider not found for transact_checkpoint");if(this.checkpoint_transacting())this.checkpoint_transaction_queue.push({checkpoint:a,callback:b,context:d});else{this.checkpoint_transacting(!0);i={redemption_curr_adj:f.checkpoint.redemption_curr_adj,level_curr_adj:f.checkpoint.level_curr_adj,quest_id:h,completed_checkpoint_id:a.id()};if((g=Tc(g.all(),function(a){return a.id()===h},this))&&g.get_first_checkpoint()===
a){if(void 0!==f.first.redemption_curr_adj&&(i.redemption_curr_adj=f.first.redemption_curr_adj),void 0!==f.first.level_curr_adj)i.level_curr_adj=f.first.level_curr_adj}else if(g&&g.get_last_checkpoint()===a&&(f.last.redemption_curr_adj&&(i.redemption_curr_adj=f.last.redemption_curr_adj),f.last.level_curr_adj))i.level_curr_adj=f.last.level_curr_adj;f=M.proxy(function(){this.checkpoint_transacting(!1);M.isFunction(b)&&b.call(d||this)},this);this.transact(a.ntg_id(),i,f)}};E.prototype.check_new_user=
function(){var a=this.current_user(),b=a.is_new();this.new_user_currency_id&&(b=0===a.balance(this.new_user_currency_id));if(b)this.on_new_user({},a)};E.prototype.on_new_user=function(a,b){function d(){b.transact(g,function(a,b){"success"===b&&c.trigger("currency.earned",[a,"new_user_bonus"])})}var g=this.new_user_ntg_id;if(g){var f=this.app.providers.referrals;f?f.ready.then(function(){f.ref_user||f.ref_site&&f.ref_site.param_value||d()}):d()}};var P=function(a){Zi.apply(this,arguments);if(!a)return this;
this.opts=a=Za.extend({},a||{});this.ready=Za.Deferred();this.referrals_ready=!1;this.is_remote_store_enabled=a.is_remote_store_enabled||!1;this.show_after_num_views="undefined"!==typeof a.show_after_num_views?a.show_after_num_views:void 0;this.show_at_curr_bal_amount=a.show_at_curr_bal_amount;this.show_at_curr_bal_currency_id=a.show_at_curr_bal_currency_id||this.app.spec.options.primary_currency_id;void 0===this.show_after_num_views&&void 0===this.show_at_curr_bal_amount&&(this.show_after_num_views=
1);this.messenger_template=this.messenger=void 0;this.show_onboarding=tm.observable(!1);this.show_onboarding.subscribe(Za.proxy(this.on_show_onboarding,this));this.wait_for_quests="undefined"!==typeof a.wait_for_quests?a.wait_for_quests:!0;this.preserve_state=a.preserve_state||!1;this.whitelist_regex=a.whitelist_regex?RegExp(a.whitelist_regex):void 0;this.blacklist_regex=a.blacklist_regex?RegExp(a.blacklist_regex):void 0;this.onboarding_cache_key=a.onboarding_cache_key||"bd-onboarding";this._onboarding_remote_cache=
null;this._cache={};this.campaign_configs=a.campaigns||{};this.campaigns_provider_name=a.campaigns_provider_name||"campaigns"},Za=c.$,tm=c.ko,um=c.util,Df=c.storage,Zi=c.controller.provider.Provider;c.controller.provider.Onboarding=Zi.extend(P);P.prototype.init=function(a,b){var d=this.ready;a&&d.then(Za.proxy(a,b||this));this.referrals_ready=(this.referrals_provider=this.app.providers.referrals)?!1:!0;this.messenger=um.walk.observable(this.opts.messenger,this);this.messenger_template=this.opts.messenger_template;
c.subscribe("signin",Za.proxy(function(){this.hide();this.preserve_state||(this.destroy_cache(this.onboarding_cache_key),this.campaign_cache_key&&this.destroy_cache(this.campaign_cache_key))},this));c.subscribe("signout",Za.proxy(function(){this.hide();this.preserve_state||(this.destroy_cache(this.onboarding_cache_key),this.show_notification_if_valid(),this.campaign_cache_key&&this.destroy_cache(this.campaign_cache_key))},this));this.show_at_curr_bal_amount&&c.subscribe("user.updated",Za.proxy(this.on_currency_balance_change,
this));var g=c.bind(this,function(){this.campaign_ref=c.url.params.bd_ref_campaign;var a=!!this.campaign_configs[this.campaign_ref];if(this.campaign_ref&&a){var a=this.app.providers[this.campaigns_provider_name],b=a.visible();if(a.fetched())this.on_campaigns_fetched(b);else b=c.bind(this,this.on_campaigns_fetched),this._campaigns_subscription||(this._campaigns_subscription=a.visible.subscribe(b))}else this.show_notification_if_valid();d.resolve()});this.get_cache(this.onboarding_cache_key,function(){g()},
this)};P.prototype.on_campaigns_fetched=function(a){this._campaigns_subscription&&this._campaigns_subscription.dispose();var b=this.campaign_ref;(a=c.first(a,function(a){return a.campaign_id()===b}))?(this.campaign=a,this.campaign_cache_key="bd-campaign-"+this.campaign_ref,this.get_cache(this.campaign_cache_key,this.set_up_campaign_notification,this)):this.show_notification_if_valid()};P.prototype.on_currency_balance_change=function(a,b){this.app.auth.is_anonymous()&&this.is_valid_page()&&c.first(b.currency_balances(),
Za.proxy(function(a){if(a&&a.currency_adjusted()&&a.currency_id()==this.show_at_curr_bal_currency_id&&a.previous_balance()<this.show_at_curr_bal_amount&&a.current_balance()>=this.show_at_curr_bal_amount)return a},this))&&this.show()};P.prototype.show_notification_if_valid=function(){var a=this;if(this.wait_for_quests&&!this.selectable_quests_loaded()){var b=c.bind(this,function(a){a.length&&(this._quests_subscription.dispose(),this.show_notification_if_valid())});this._quests_subscription||(this._quests_subscription=
this.app.providers.quests.selectable.subscribe(b))}else if(this.referrals_ready){if(this.app.auth.is_anonymous()||this.is_valid_campaign_referral)this.is_valid_page()&&this.is_valid_view_count()&&(this.is_recruiting()||this.show())}else this.referrals_provider.ready.then(function(){a.referrals_ready=!0;a.show_notification_if_valid()})};P.prototype.get_initialized_cache=function(){return{first_seen:(new Date).getTime(),view_count:0}};P.prototype.is_valid_view_count=function(){var a=this.get_view_count_for_cache(this.onboarding_cache_key);
this.is_valid_campaign_referral&&(a=this.get_view_count_for_cache(this.campaign_cache_key));return!this.show_after_num_views||a===this.show_after_num_views?!0:!1};P.prototype.get_view_count_for_cache=function(a){var b=this.get_cache(a);if(!b||!b.view_count)b=this.get_initialized_cache();b.view_count+=1;this.set_cache(a,b);return b.view_count};P.prototype.set_up_campaign_notification=function(){var a=Za.extend({show_after_num_views:1,wait_for_quests:!1,whitelist_regex:void 0,blacklist_regex:void 0},
this.campaign_configs[this.campaign_ref]);a&&(this.show_after_num_views=a.show_after_num_views,this.wait_for_quests=a.wait_for_quests,this.whitelist_regex=a.whitelist_regex?RegExp(a.whitelist_regex):void 0,this.blacklist_regex=a.blacklist_regex?RegExp(a.blacklist_regex):void 0,this.messenger_template=this.app.auth.is_anonymous()?a.templates["logged-out"]:a.templates["logged-in"],this.is_valid_campaign_referral=!0,this.show_notification_if_valid())};P.prototype.is_valid_page=function(){var a=c.url.current;
return this.whitelist_regex?this.whitelist_regex.test(a):this.blacklist_regex?!this.blacklist_regex.test(a):!0};P.dependent("selectable_quests_loaded",function(){return 0<this.app.providers.quests.selectable().length});P.dependent("is_recruiting",function(){var a=this.referrals_provider;if(a){if(!a.ref_user_login)return!1;if(a.ref_user||a.ref_site.param_value)return!0}return!1});P.prototype.get_cache=function(a,b,d){var g;if(this._cache[a])if(g=this._cache[a],b)b.call(d||this,g);else return g;else if(this.is_remote_store_enabled){var f=
this;c.remote_storage.get(a,function(c,g){f._cache[a]=g;b&&b.call(d||this,g)})}else g=Df.get_storage(this.onboarding_cache_key),this._cache[a]=g,b&&b.call(d||this,g)};P.prototype.set_cache=function(a,b){this.is_remote_store_enabled?c.remote_storage.set(a,b):Df.set_storage(a,b);this._cache[a]=b};P.prototype.destroy_cache=function(a){this.is_remote_store_enabled?c.remote_storage.destroy(a):Df.destroy_storage(a);this._cache[a]=void 0};P.prototype.clear_onboarding=function(){this.hide(!1)};P.prototype.show=
function(){c.trigger("onboarding.show");this.show_onboarding(!0)};P.prototype.hide=function(){c.trigger("onboarding.hide");this.show_onboarding(!1)};P.prototype.on_show_onboarding=function(a){!this.app.bucket.is_in_control_bucket()&&a&&(a=this.app.vars.onboard,this.campaign_ref&&(a=this.app.vars.campaigns[this.campaign_ref]),this.messenger&&this.messenger_template&&this.messenger.enqueue(this.messenger_template,{is_onboarding:!0,campaign:this.campaign,vars:a}),c.trigger("analytics",["onboard_impression"]),
c.trigger("onboarding.impression",[this.campaign_ref]))};var N=function(a){$i.apply(this,arguments);if(!a)return this;this.opts=a||{};this.is_remote_store_enabled=a.is_remote_store_enabled||!1;this._remote_data_cache=null;this.num_days_till_old=a.num_days_till_old||10;this.cache_name=a.cache_name||"bd-notifications";this.cache=Td.computed({read:function(){if(this.app.auth.is_anonymous())return this.get_empty_cache();var a;(a=this.is_remote_store_enabled?this._remote_data_cache:Ud.get_storage(this.cache_name))||
(a={});a.ignore_before||(a=this.get_empty_cache(),this.is_remote_store_enabled?(this._remote_data_cache=a,c.remote_storage.set(this.cache_name,a)):Ud.set_storage(this.cache_name,a));return a},write:function(a){if(this.app.auth.is_anonymous())return this.get_empty_cache();this.is_remote_store_enabled?(this._remote_data_cache=a,c.remote_storage.set(this.cache_name,a)):Ud.set_storage(this.cache_name,a);(0<a.dismissed.quests.length||0<a.dismissed.rewards.length)&&this.cache.notifySubscribers(a);return a},
deferEvaluation:!0},this);this.is_quests_enabled=a.quests_enabled||!0;this.is_rewards_enabled=a.rewards_enabled||!0},$a=c.$,Td=c.ko,aj=c.each,$i=c.controller.provider.Provider,bj=c.util,Ud=c.storage,cj=c.filter;c.controller.provider.Notifications=$i.extend(N);N.prototype.init=function(a,b){this.quest_source=this.is_quests_enabled?bj.walk.observable(this.opts.quest_source,this)||this.app.providers.quests.all:Td.observable([]);this.rewards_source=this.is_rewards_enabled?bj.walk.observable(this.opts.rewards_source,
this)||this.app.providers.rewards.all:Td.observable([]);this.get_new_items_count=Td.computed(function(){return this.get_new_quests_count()+this.get_new_rewards_count()},this).extend({throttle:500});this.get_new_items_count.subscribe($a.proxy(this.on_get_new_items_count_change,this));this.get_new_quests_count.subscribe($a.proxy(function(a){c.trigger("notifications.new_quests_count.updated",a)},this));this.get_new_rewards_count.subscribe($a.proxy(function(a){c.trigger("notifications.new_rewards_count.updated",
a)},this));c.subscribe("signout",$a.proxy(this.destroy_cache,this));this.is_remote_store_enabled&&!this._remote_data_cache?c.remote_storage.get(this.cache_name,$a.proxy(function(c,g){this._remote_data_cache=g||null;$a.isFunction(a)&&a.call(b||this)},this)):$a.isFunction(a)&&a.call(b||this)};N.prototype.get_empty_cache=function(){return{ignore_before:(new Date).getTime()-864E5*this.num_days_till_old,dismissed:{quests:[],rewards:[]}}};N.prototype.on_get_new_items_count_change=function(a){c.trigger("notifications.new_items_count.updated",
a);var b=this.cache();if(0===a&&this.quest_source().length&&this.rewards_source().length&&(0<b.dismissed.quests.length||0<b.dismissed.rewards.length))b=this.get_empty_cache(),b.ignore_before=(new Date).getTime(),this.cache(b)};N.prototype.dismiss_quest=function(a){if(!this.is_quest_dismissed(a)){var b=this.cache();b.dismissed.quests.push(a.id());this.cache(b)}};N.prototype.dismiss_reward=function(a){if(!this.is_reward_dismissed(a)){var b=this.cache();b.dismissed.rewards.push(a.named_good_id());this.cache(b)}};
N.prototype.destroy_cache=function(){this.is_remote_store_enabled?(this._remote_data_cache=null,c.remote_storage.destroy(this.cache_name)):Ud.destroy_storage(this.cache_name)};N.prototype.dismiss_all_quests=function(){aj(this.get_new_quests(),function(a){this.dismiss_quest(a)},this)};N.prototype.dismiss_all_rewards=function(){aj(this.get_new_rewards(),function(a){this.dismiss_reward(a)},this)};N.prototype.dismiss_all=function(){this.dismiss_all_quests();this.dismiss_all_rewards()};N.prototype.is_new_item=
function(a){return a>this.cache().ignore_before&&((new Date).getTime()-a)/1E3/60/60/24<this.num_days_till_old};N.prototype.is_quest_dismissed=function(a){return-1!==$a.inArray(a.id(),this.cache().dismissed.quests)};N.prototype.is_reward_dismissed=function(a){return-1!==$a.inArray(a.named_good_id(),this.cache().dismissed.rewards)};N.dependent("get_new_quests",function(){return this.app.auth.is_anonymous()?[]:cj(this.quest_source(),function(a){return this.is_new_item(a.created_timestamp().getTime())&&
0===a.num_checkpoints_completed()&&!this.is_quest_dismissed(a)},this)});N.dependent("get_new_rewards",function(){return this.app.auth.is_anonymous()?[]:cj(this.rewards_source(),function(a){return this.is_new_item(a.created_timestamp().getTime())&&!this.is_reward_dismissed(a)},this)});N.dependent("get_all_new_items",function(){return this.get_new_quests().concat(this.get_new_rewards()).sort(function(a,b){return b.created_timestamp().getTime()-a.created_timestamp().getTime()})});N.dependent("get_new_quests_count",
function(){return this.get_new_quests().length});N.dependent("get_new_rewards_count",function(){return this.get_new_rewards().length});var Ha=function(a){dj.apply(this,arguments);if(!a)return this;a=a||{};if(!a.twitter_handle)throw new Ef("Street Team provider was created without a twitter_handle");if(!a.hashtag)throw new Ef("Street Team provider was created without a hashtag");if(!a.ntg_id)throw new Ef("Street Team provider was created without a ntg_id");this.timer=null;this.session=this.app.sessions.remote;
this.define({twitter_handle:a.twitter_handle,hashtag:a.hashtag,bonus_amount:a.bonus_amount||0,duration_hours:a.duration_hours||24,interval_hours:a.interval_hours||a.duration_hours||24,fetch_count:a.fetch_count||10,exclude_replies:null==a.exclude_replies?!0:a.exclude_replies,ntg_id:a.ntg_id,ntge_result:null,the_tweet:null,full_name:function(){var b=this.the_tweet();return b?b.user.name||a.full_name:a.full_name},avatar_url:function(){var b=this.the_tweet();return b?b.user.profile_image_url||a.avatar_url:
a.avatar_url},message:function(){var a=this.the_tweet();return a?a.text:""},end_date:function(){var a=this.the_tweet();if(a){var a=this.parse_twitter_date(a.created_at),c=36E5*this.duration_hours();return new Date(+a+c)}return null},seconds_remaining:0,share_time:null,formatted_time:function(){this.seconds_remaining();return this.format_time()},is_active:function(){return this.the_tweet()&&0<this.seconds_remaining()},is_complete:function(){return this.the_tweet()&&(this.ntge_result()||this.shared_within_interval())},
shared_within_interval:function(){var a=this.share_time();if(a){var a=new Date-a,c=36E5*this.interval_hours();return a<c}return!1},facebook_share_url:function(){var a=this.the_tweet();if(a)return this.get_facebook_url(a)},twitter_share_url:function(){var a=this.the_tweet();if(a)return this.get_twitter_url(a)}});this.restore_share_time=vm(this,this.restore_share_time);this.app.subscribe("post.data",this.restore_share_time);this.app.auth.subscribe("user_changed",this.restore_share_time)},ej=c.$,vm=
c.bind,dj=c.controller.provider.Provider,fj=c.awesome,Ef=c.error.GamifyConfigurationError;c.controller.provider.StreetTeam=dj.extend(Ha);Ha.prototype.get_share_time=function(){var a=this.session.read("street-team-share");if(a)return new Date(+a)};Ha.prototype.restore_share_time=function(){var a=this.get_share_time();this.share_time(a)};Ha.prototype.record_share_time=function(a){a||(a=new Date);this.share_time(a);this.session.write({"street-team-share":+a})};Ha.prototype.transact=function(){if(!this.ntge_result()&&
!this.shared_within_interval()){var a=this.ntg_id(),b=this;this.record_share_time(new Date);var c=function(a){b.ntge_result(a)};this.app.auth.is_anonymous()&&this.app.providers.economycache?this.app.providers.economycache.transact(a,{redemption_curr_adj:this.bonus_amount()},c):this.app.auth.user.transact(a,c)}};Ha.prototype.get_twitter_url=function(a){return"http://twitter.com/intent/retweet?tweet_id="+a.id_str};Ha.prototype.get_facebook_url=function(a){var b=a.text,c=a.user.profile_image_url,g=this.app.spec.bigdoor.hostname||
"loyalty.bigdoor.com",f=this.app.spec.options.facebook_app_id;"144260708944401"==f&&(g="loyalty.bigdoor.com");var g=["http:/",g,"media/gambit/facebook/share/complete.html"].join("/"),h=a.user.url;a.entities.urls.length&&(h=a.entities.urls[0].expanded_url);a="http://www.facebook.com/dialog/feed?app_id="+f+"&link="+h+"&display=popup&redirect_uri="+g;b&&(a+="&message="+encodeURIComponent(b));c&&(a+="&picture="+encodeURIComponent(c));a=fj.sanitize_referral_url(a);this.app.auth.is_anonymous()||(a=fj.add_referral_to_url(a,
this.app.auth.user.end_user_login()));return a};Ha.prototype.fetch_the_tweet=function(){var a="https://api.twitter.com/1/statuses/user_timeline.json?include_entities=true&include_rts=false&count="+this.fetch_count()+"&screen_name="+this.twitter_handle()+"&exclude_replies="+!!this.exclude_replies()+"&callback=?",b=this,c=null;ej.getJSON(a,function(a){ej.each(a,function(a,g){for(var i=0;i<g.entities.hashtags.length;i++)g.entities.hashtags[i].text.toLowerCase()===b.hashtag().toLowerCase()&&(c=g);if(c)return!1});
c&&(b.the_tweet(c),b.start_timer())})};Ha.prototype.start_timer=function(){var a=this.end_date(),b=this;a>new Date&&(this.timer=new c.util.Timer(1E3,a,function(){b.seconds_remaining((+a-+new Date)/1E3)}),this.timer.start())};Ha.prototype.format_time=function(){if(this.is_active()&&!this.is_complete()){var a=this.end_date(),b=c.util.time_remaining(a),a=24*b[0]+b[1],d=b[2],b=b[3];return""+(10>a?"0"+a:a)+":"+(10>d?"0"+d:d)+":"+(10>b?"0"+b:b)}return"00:00:00"};Ha.prototype.parse_twitter_date=function(a){return new Date(a.replace(/^\w+ (\w+) (\d+) ([\d:]+) \+0000 (\d+)$/,
"$1 $2 $4 $3 UTC"))};var Ia=function(a){gj.apply(this,arguments);this.bp_session_key_name="bp_channel"},Ff=c.$,gj=c.controller.provider.Provider;c.controller.provider.Backplane=gj.extend(Ia);Ia.prototype.init=function(a,b){if(this.bp_lib_is_initialized()){this.bp_version=this.bp_lib().version;this.bp_config=this.bp_lib().config;this.bp_bus_name=this.bp_config.busName;this.bp_channel_name=this.bp_config.channelName;this.bp_server_base_url=this.bp_config.serverBaseURL;if(this.has_bp_channel_changed()&&
(this.set_bp_channel_name_cache(this.bp_channel_name),!this.app.auth.is_anonymous()))this.on_bp_logout();this.bp_lib().subscribe(Ff.proxy(this.on_bp_message,this))}Ff.isFunction(a)&&a.call(b||this)};Ia.prototype.bp_lib=function(){return window.Backplane};Ia.prototype.bp_lib_exists=function(){return!!this.bp_lib()};Ia.prototype.bp_lib_is_initialized=function(){return this.bp_lib_exists()&&this.bp_lib().initialized};Ia.prototype.on_bp_login=function(){this.app.auth.is_anonymous()&&this.app.bigdoor.fetch("backplane/v1.2/bus/"+
this.bp_bus_name+"/channel/"+this.bp_channel_name+"/login",{bp_version:this.bp_version,bp_server_base_url:this.bp_server_base_url},function(a,b){"success"===b&&a&&a.BDACWE&&c.app.current().auth.set_bdacwe_auth_cache(a.BDACWE,function(){c.app.current().auth.login()})},window)};Ia.prototype.has_bp_channel_changed=function(){return this.get_bp_channel_name_cache()!==this.bp_channel_name};Ia.prototype.on_bp_logout=function(){this.app.auth.is_anonymous()||(this.set_bp_channel_name_cache(""),this.app.auth.remove_bdacwe_auth_cache(Ff.proxy(function(){this.app.auth.logout()},
this)))};Ia.prototype.on_bp_message=function(a){a.type||(a=a.message);if("1"===this.bp_version.split(".")[0]&&"identity/logout"!==a.type&&"identity/login"===a.type)this.on_bp_login(a)};Ia.prototype.get_bp_channel_name_cache=function(){return this.app.sessions.local.read(this.bp_session_key_name)};Ia.prototype.set_bp_channel_name_cache=function(a){var b={};b[this.bp_session_key_name]=a;this.app.sessions.local.write(b)};var Vd=function(a){hj.apply(this,arguments);a=a||{};this.current_url=window.location.href;
if(!a.events)throw new c.error.GamifyConfigurationError("URLTrigger provider requires at least one event");this.bdm_events=a.events;c.each(this.bdm_events,function(a){if(!a.event)throw new c.error.GamifyConfigurationError("Event does not have an associated JS event.");if(!a.regex)throw new c.error.GamifyConfigurationError("Event does not have an associated regex.");try{RegExp(a.regex)}catch(d){throw new c.error.GamifyConfigurationError("Event does not have a valid regex.");}a.fire_delay||(a.fire_delay=
0);if(isNaN(a.fire_delay))throw new c.error.GamifyConfigurationError("Event does not have a numerical fire delay.");if(0>a.fire_delay)throw new c.error.GamifyConfigurationError("Fire delay must be positive.");if(0!==a.fire_delay%1)throw new c.error.GamifyConfigurationError("Fire delay must be an integer.");},this)},wm=c.$,hj=c.controller.provider.Provider;c.controller.provider.URLTrigger=hj.extend(Vd);Vd.prototype.actions=function(a,b){c.each(this.bdm_events,function(a){this.is_valid_url(a.regex,
this.current_url)&&this.fire_event(a.event,a.fire_delay)},this);wm.isFunction(a)&&a.call(b||this)};Vd.prototype.is_valid_url=function(a,b){return RegExp(a).test(b)};Vd.prototype.fire_event=function(a,b){setTimeout(function(){c.trigger(a)},b)};var $=function(a){ij.apply(this,arguments);this.rewards_provider_name=a.rewards_provider||"rewards";this.quests_provider_name=a.quests_provider||"quests";this.reward_profile_key=a.reward_profile_key||"campaign-reward";this.attribute_friendly_id=a.attribute_friendly_id||
"bdm-campaign";this.max_records=a.max_records||10;this.order_by=a.order_by||"-relative_weight";this.define({fetched:!1,fetching:!1,_campaigns:[]});this.ready=xm.Deferred()},xm=c.$,ym=c.controller.Wishlist,ij=c.controller.provider.Provider;c.controller.provider.LoyaltyCampaigns=ij.extend($);$.prototype.init=function(a,b){this.rewards_provider=this.app.providers[this.rewards_provider_name];this.quests_provider=this.app.providers[this.quests_provider_name];this.session=this.app.sessions.remote;this.wishlist=
new ym({session:this.session,name:this.reward_profile_key});a&&a.call(b||this)};$.prototype.actions=function(a,b){this.wishlist.refresh();a&&a.call(b||this)};$.computed("all",function(){!this.fetched()&&!this.fetching()&&this.fetch();return this._campaigns()});$.computed("rewards",function(){var a=this.rewards_provider;if(!a)return[];var b=this.all();if(!b.length)return[];b=c.map(b,function(a){return a.campaign_id()});a.fetch_if_unfetched(b);return a.all()});$.prototype.choose_reward=function(a){this.wishlist.add(a)};
$.computed("quests",function(){var a=this.app.auth.is_anonymous(),b=this.quests_provider.selectable(),d=a?[]:this.quests_provider.completed(),g=this.quests_provider.passive?this.quests_provider.passive():[],b=[].concat(b,d,g);this.quests_provider.lazy_fetch_incomplete();a||this.quests_provider.lazy_fetch_complete();a=c.filter(b,function(a){return a.is_visible()||a.is_complete()});a.sort(function(a,b){var c=a.relative_weight(),d=b.relative_weight();if(c!=d)return d-c;c=a.created_timestamp();d=b.created_timestamp();
if(c!=d)return c-d;c=a.id();d=b.id();return c-d});for(b=0;b<a.length;)a[b]===a[b+1]?a.splice(b,1):b+=1;return a});$.computed("_quests_fingerprint",function(){var a=this.quests();return c.map(a,function(a){return""+a.id()}).join("__")});$.prototype.fetch=function(a,b){this.fetching(!0);this.app.bigdoor.loyalty_campaign.query({attribute_friendly_id:this.attribute_friendly_id,max_records:this.max_records,order_by:this.order_by},function(d){c.each(d,function(a){a.provider=this;a.init()},this);this._campaigns(d);
this.fetched(!0);this.fetching(!1);this.ready.resolve();a&&a.call(b||this,d)},this)};$.computed("available",function(){var a=this.all();return c.filter(a,function(a){return a.is_user_eligible()})});$.computed("visible",function(){var a=this.available();return c.filter(a,function(a){return a.is_within_visible_period()})});$.prototype.get_group=function(a){var b=this.visible();return c.filter(b,function(b){return b.group_id()==a})};$.prototype.get_campaign_by_id=function(a){var b=this.all();if(b.length)return c.first(b,
function(b){return b.campaign_id()===a})};var kc=function(a){a=jj.extend(!0,this.defaults,a);Gf.call(this,a);this.transactions=a.transactions;this.redirect_delay=a.redirect_delay||0},jj=c.$,Gf=c.controller.provider.Provider;c.controller.provider.AuthlessTransaction=Gf.extend(kc);kc.prototype.defaults={transactions:{},redirect_delay:300};kc.prototype.init=function(a,b){var d=this.app.tracker;d&&d.track("com.bigdoor.authless_ntge",function(a){c.subscribe("user.authless_transact",function(b,c){a(c)})});
Gf.prototype.init.apply(this,arguments)};kc.prototype.actions=function(a,b){var d=c.url.params.bd_transact,g=c.url.params.bd_transact_user;if(d&&g){var f=this.transactions[d];f&&f.ntg_id&&this.transact({friendly_id:d,end_user_login:g,config:f})}a&&a.call(b||this)};kc.prototype.transact=function(a){var b={named_transaction_group_id:a.config.ntg_id,end_user_login:a.end_user_login},d=jj.extend({},b,{site_id:this.app.spec.site_id,named_transaction_group_friendly_id:a.friendly_id,campaign_id:a.config.campaign_id});
c.trigger("user.authless_transact",d);var g=this;this.app.bigdoor.named_transaction_group_execute.create(b,{},function(b,c,d){b="error"===c&&503==d.code&&3==d.data;("success"===c||b)&&g.transaction_complete(a)})};kc.prototype.transaction_complete=function(a){var b=a.config.redirect_url;b&&setTimeout(function(){c.url.redirect(b)},this.redirect_delay)};return c}var c=window.BDM;c&&c.define?c.define("bigdoor",["jquery"],lc):lc.call(window)})();
