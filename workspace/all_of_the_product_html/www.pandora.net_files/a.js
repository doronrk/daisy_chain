var WidgetService={},PropertyAccessor,WidgetsEnvironmentClass,WidgetsDatabase;WidgetService.GetWidgets=function(n,t){var i=$("#filter-init"),r=i.length==0?"/Services/Widgets/WidgetsService.svc/":i.attr("data-widgetservice-url");$.ajax({type:"GET",url:r,success:n,error:t})};PropertyAccessor=function(){var n=log4javascriptFactory.getLogger("property accessor");n.setLevel(log4javascript.Level.WARN);this.GetProperty=function(t){if(t==null)throw new Error("propertyName cannot be null");if(!this.hasOwnProperty(t)){n.error("Property ["+t+"] is not defined on current object",this);throw new Error("Property ["+t+"] is not defined on current object");}return this[t]}};WidgetsEnvironmentClass=function(n,t){var f=log4javascriptFactory.getLogger("widgets environment"),i,r,u;if(f.setLevel(log4javascript.Level.WARN),f.trace("initializing environment"),n==null){if(i=$("#widget-init"),i.length==0)throw new Error("Data is not specified explicitly and page does not contain widgets data");n=i[0]}if(t==null){if(r=$("#filter-init"),r.length==0)throw new Error("List filters are not specified explicitly and page does not contain list filters");t=r[0]}var o=this,e=function(n){if(n==null)throw new Error("dataContainer cannot be null");var t=new PropertyAccessor,i=$(n).dataset();return $(Object.getPropertyNames(i)).each(function(){t[this]=i[this]}),t},s=function(n,t){var i,r;if(n==null)throw new Error("dest cannot be null");if(t==null)throw new Error("dataContainer cannot be null");if(i=$(t).attr("id"),i==null||i=="")throw new Error("invalid property name on node ["+t.outerHTML+"]");r=e(t);n[i]=r};$($(n).children()).each(function(){s(o,this)});u=[];this["list-filters"]=u;$($(t).children()).each(function(){u.push(e(this))});this.widetsAllowed=$(n).attr("data-widgets-allowed")=="true"};WidgetsEnvironmentClass.prototype=new PropertyAccessor;Object.getPropertyNames=function(n){if(n==null)throw new Error("obj cannot be null");var t=[];for(key in n)t.push(key);return t};WidgetsDatabase=function(n,t){var r=log4javascriptFactory.getLogger("widget database");r.setLevel(log4javascript.Level.WARN);r.trace("creating widgets database");var u=[],i=function(n,t,i,r,u){if(n==null)throw new Error("widget cannot be null");if(t==null)throw new Error("filterProperty cannot be null");if(i==null)throw new Error("appliesTo cannot be null");if(r==null)throw new Error("property cannot be null");if(u==null)throw new Error("filterContainer cannot be null");var f=$(".filter",n).attr(t);f!=null&&f!=""&&u.push(new WidgetsDatabase.WidgetFilter(i,r,"==",f,1))},f=function(n){if(n==null)throw new Error("serverOperator cannot be null");switch(parseInt(n)){case 0:return"==";case 1:return"!=";case 2:return">";case 3:return">=";case 4:return"<";case 5:return"<=";default:throw new Error("Unknown server-side operator: ["+n+"]");}},e=function(n){if(n==null)throw new Error("dimension cannot be null");switch(parseInt(n)){case 0:return"cat";case 1:return"col";case 2:return"color";case 3:return"subcat";case 4:return"release";case 5:return"metal";case 6:return"material";case 7:return"stone";default:throw new Error("Unknown dimension: ["+n+"]");}},o=function(n,t,i){var r=[],u=$(".filter li",n);u.length<1||(r=[],$(u).each(function(){r.push(new WidgetsDatabase.WidgetFilter("list-filters",e($(this).attr("dimension")),f($(this).attr("operator")),$(this).attr("keys").split(";"),2))}),i.push(new WidgetsDatabase.WidgetFilterGroup(r)))},s=function(n){var t=new WidgetsDatabase.Widget(n.attr("widgetid"),n.attr("width"),n.attr("height"),$("script",n).html(),[]);return $(["Gender","HasDesign","HasFavouriteStore","HasWishlist","IsEcommerce","IsMember","IsSubscribed","ProductFilters"]).each(function(r,u){switch(u){case"ProductFilters":o(n,u,t.filters);break;case"Gender":i(n,u,"segment","gender",t.filters);break;case"HasDesign":i(n,u,"segment","has-design",t.filters);break;case"HasFavouriteStore":i(n,u,"segment","has-favourite-store",t.filters);break;case"HasWishlist":i(n,u,"segment","has-wishlist",t.filters);break;case"IsEcommerce":i(n,u,"market","is-ecommerce",t.filters);break;case"IsMember":i(n,u,"segment","is-member",t.filters);break;case"IsSubscribed":i(n,u,"segment","is-subscribed",t.filters);break;default:throw new Error("Widget property is not recognized: ["+u+"]");}}),t},h=function(){r.trace("initializing widgets");var i=function(){r.trace("initialization done, "+u.length+" widget(s) are in database");t&&t()};n!=null?(u=n,i()):setTimeout(function(){$("#widget-collection .widget-control").each(function(){u.push(s($(this)));$("#widget-collection").remove()});i()},0)};this.GetWidgets=function(){return u.slice(0)};h()};WidgetsDatabase.Widget=function(n,t,i,r,u){if(n==null)throw new Error("id cannot be null or empty");if(t==null)throw new Error("width cannot be null or empty");if(i==null)throw new Error("height cannot be null or empty");if(r==null)throw new Error("html cannot be null or empty");if(u==null)throw new Error("filters cannot be null or empty");this.id=n;this.width=parseInt(t);this.height=parseInt(i);this.filters=u;this.html=htmlDecode(r)};WidgetsDatabase.WidgetFilter=function(n,t,i,r,u){if(n==null)throw new Error("appliesTo cannot be null or empty");if(t==null)throw new Error("property cannot be null or empty");if(i==null)throw new Error("condition cannot be null or empty");if(r==null)throw new Error("value cannot be null or empty");(u==null||u<0)&&(u=0);this.appliesTo=n;this.property=t;this.condition=i;this.value=r;this.getWeight=function(){return u}};WidgetsDatabase.WidgetFilterGroup=function(n){if(n==null)throw new Error("filters cannot be null or empty");this.filters=n;this.getWeight=function(){return this.filters.length==0?0:$.Enumerable.From(this.filters).Sum("$.getWeight()")}};
/* Provides widgets for JS client */
var WidgetsManagerClass = function (widgetsDatabase, onReadyCallback)
{
    var _log = log4javascriptFactory.getLogger('widget manager');
    _log.setLevel(log4javascript.Level.WARN);

    _log.trace('creating widget manager');

    var self = this;
    this.name = "WidgetsManagerClass";

    this.onLoadEvent = new pandora.utils.Event(this);

    /* Performs manager initialization */
    var initManager = function() {
        if (onReadyCallback)
            onReadyCallback(self);
    };

    this.before = function() {
        // NOOP
    };

    this.done = function () {
        // NOOP
    };

    /* Returns widgets */
    this.GetWidgets = function (environment, userFilters)
    {
        _log.trace('retrieving widgets');

        if (!environment.widetsAllowed)
        {
            this.onLoadEvent.notify({ widgets: [] });
            return [];
        }

        var environmentCopy = $.extend(true, {}, environment);

        if (userFilters != null)
        {
            for (var filter in userFilters)
            {
                if (userFilters.hasOwnProperty(filter))
                {
                    var values = [];

                    if (userFilters[filter].length < 1)
                        throw new Error('Invalid user filters length');

                    var comparison = userFilters[filter][0].comparison;

                    for (var i = 0; i < userFilters[filter].length; i++)
                    {
                        values.push(userFilters[filter][i].value);
                    }

                    environmentCopy['list-filters'].push({
                        'filter-field': filter,
                        'filter-compare': comparison,
                        'filter-value': values
                    })
                }
            }
        }

        var availableWidgets = _widgetsDatabase.GetWidgets();
        var widgetsWeights = {};

        var result = $.Enumerable.From(availableWidgets)
            .Where(function (widget)
            {
                widgetsWeights[widget.id] = 0;

                return $.Enumerable.From(widget.filters)
                    .All(function (filter)
                    {
                        var result = false;

                        if (filter instanceof WidgetsDatabase.WidgetFilterGroup)
                        {
                            if (filter.filters.length == 0)
                                result = true;
                            else
                                $(filter.filters).each(function (index, filter)
                                {
                                    var filterResult = WidgetsManagerClass.IsFilterOk(filter, environmentCopy);

                                    if (filterResult)
                                    {
                                        result = true;
                                        widgetsWeights[widget.id] += filter.getWeight();
                                    }
                                })
                        }
                        else
                        {
                            result = WidgetsManagerClass.IsFilterOk(filter, environmentCopy);

                            if (result)
                                widgetsWeights[widget.id] += filter.getWeight();
                        }

                        return result;
                    });
            })
            .OrderByDescending(function (widget)
            {
                return widgetsWeights[widget.id];
            })
            .ToArray();

        _log.info(result.length + ' widgets are returned');
        /*
        $(result).each(function ()
        {
        _log.info(this);

        $(this.filters).each(function ()
        {
        _log.info(this);
        })
        });
        */
        //        $(result).each(function ()
        //        {
        //            _log.debug(this);
        //        })

        this.onLoadEvent.notify({ widgets: result, before: this.before, done: this.done });

        return result;
    }

    // widgets database
    var _widgetsDatabase = widgetsDatabase || new WidgetsDatabase(null, initManager);
}

WidgetsManagerClass.IsFilterOk = function (filter, environment)
{
    var _log = log4javascriptFactory.getLogger('widget manager');
    _log.setLevel(log4javascript.Level.WARN);

    try
    {
        if (filter == null)
            throw new Error("filter cannot be null");

        if (environment == null)
            throw new Error("environment cannot be null");

        if (filter instanceof WidgetsDatabase.WidgetFilterGroup)
            return filter.filters.length == 0 ? true : $.Enumerable.From(filter.filters).Any(function (t) { return WidgetsManagerClass.IsFilterOk(t, environment) });

        var target = environment.GetProperty(filter.appliesTo);

        if (filter.appliesTo == 'list-filters')
        {
            // check if required list filter is set
            var filterIsSet = $.Enumerable.From(target).Any(function (t) { return t['filter-field'] == filter.property });

            // if filter is not set - we consider it to pass
            if (!filterIsSet)
                return false;

            // at least one list filter should pass

            var result = $.Enumerable.From(target).Any(function (t)
            {
                if (t['filter-field'] != filter.property)
                    return false;

                var data = [];

                if (t['filter-value'] instanceof Array)
                    data = t['filter-value'];
                else
                    data.push(t['filter-value']);

                var shouldBeEqual = t['filter-compare'] == 'equal';
                var result = $.Enumerable.From(filter.value).Any(function (k) { return $.inArray(k, data) > -1 });

                return shouldBeEqual ? result : !result;
            });

            return result;
        }

        var property = target.GetProperty(filter.property);

        var evalLine = property == 'true' || property == 'false' 
            ? '"' + property + '" ' + filter.condition + ' filter.value.toLowerCase()'
            : 'property ' + filter.condition + ' filter.value'
        
        var result = eval(evalLine);

        return result;
    }
    catch (error)
    {
        _log.error(error);
        throw error;
    }
}
;
function WidgetView(){var n=function(n,t,i,r,u){return $("<div/>").append($("<li/>").attr("id",n).addClass("box widget").addClass("width-"+u).addClass("row-"+i).addClass("col-"+t).attr("data-list-row",i).attr("data-list-column",t).html(r)).html()};this.createTwoTwoWidget=function(t,i,r,u){return n(t,i,r,u,"50")};this.createOneOneWidget=function(t,i,r,u){return n(t,i,r,u,"25")};this.createTwoOneWidget=function(t,i,r,u){return n(t,i,r,u,"50")}}function _scrollTo(n){var i,r,t;if(n==null)throw new Error("element cannot be null");i=$(n).offset().top;r=window.innerHeight;r==null&&(r=document.body.clientHeight);t=window.pageYOffset;t==null&&(t=document.body.offsetTop);i>t+r?pageScroll(i-(t+r),10):i<t&&pageScroll(i-t,-10)}function _pageScroll(n,t,i){n-t<0?(window.scrollBy(0,t),scrolldelay=setTimeout("pageScroll("+(n-t)+", "+t+", "+i+")",10)):typeof i=="function"&&i.call()}function CollectionController(n,t,i,r){function vt(n,t,i,r,u){var f,e;for(u||(u=[{first:{min:0,max:0},spacing:{min:2,max:5}},{first:{min:4,max:6},spacing:{min:100,max:100}}]),f=pt(n,t,i,r,u),e=0;e<i-1;++e)yt(n,t,i,r,u,f);return f.numPages}function yt(n,t,i,r,u,f){var h=n[n.length-1],c=-1,o,s,e,l;if(f.usedWidgets>0&&t[f.usedWidgets-1].page==n[n.length-1].page&&(o=t[f.usedWidgets-1],c=o.y+o.h-1==h.y?o.x+o.w:-1),s=Math.max(h.x+1,c),s!=i)for(e=f.usedWidgets;e<t.length;++e)if(t[e].h==1&&t[e].w<=i-s){t[e].y=n[n.length-1].y;t[e].x=s;t[e].page=f.numPages-1;l=t[e];t[e]=t[f.usedWidgets];t[f.usedWidgets]=l;f.usedWidgets++;break}}function et(n){return Math.floor(Math.random()*(n.max-n.min+1)+n.min)}function pt(n,t,i,r,u){for(var w,y,e,h,a,c=0;c<t.length;++c)if(t[c].h>2||t[c].w>i)throw new"widget size not supported";for(var o=0,f=0,l=0,v=0;;){for(var s=[],e=et(u[Math.min(u.length-1,o)].first),p=l+e*i;f<t.length&&e+t[f].h<=r;){if(w=(i-t[f].w)*t[f].h,p+w>n.length)break;t[f].y=e;t[f].x=v*(i-t[f].w);t[f].page=o;s[e]=t[f];t[f].h==2&&(s[e+1]=t[f]);y=t[f].h+et(u[Math.min(u.length-1,o)].spacing);p+=y*i-t[f].w*t[f].h;e+=y;v=v?0:1;++f}for(e=0;e<r;++e)for(h=0;h<i;++h)if((!s[e]||!(s[e].x<=h)||!(s[e].x+s[e].w-1>=h))&&(n[l].x=h,n[l].y=e,n[l].page=o,++l>=n.length)){for(a=f;a<t.length;++a)t[a].page=-1;return{numPages:o+1,usedWidgets:f}}++o}}function b(n,t,i){var r=t.parent(),f=t.offset().top-r.offset().top+t.outerHeight(!0),e=parseInt(t.attr("data-list-row"),10),o=r.find("li").filter(function(){return parseInt($(this).attr("data-list-row"),10)>e}),s=$(y.createProductPlaceholder()).css({top:f,height:0}).appendTo(r);return u.createProduct(n,s,o,null,i)}var o,u,e,s,h,ft,ht,tt;$("html").addClass("page-with-collection");(Utils.isAndroid||Utils.isIpad)&&$("#collection-container").addClass("tabletDevice");menuFixInterval!==null&&clearInterval(menuFixInterval);o=log4javascriptFactory.getLogger("collection controller");o.setLevel(log4javascript.Level.WARN);o.trace("initialized");u=this;u.numRows=n;u.numColumns=t;var k=500,it=44,d=$("#filter-init");this.shownProductsChangedEvent=new pandora.utils.Event(this);var v="active",l,c,a,p,g,ct=new WidgetsEnvironmentClass,y,f,nt=new CollectionModel,rt;u._sortBy=null;ignoreHistoryEvent=!1;e=new FilterController;h=function(){var n=!1;return{trylock:function(){return n?!1:(n=!0,!0)},unlock:function(){n=!1},islocked:function(){return n}}}();$("#collection-container").undelegate("a.p-link","click").delegate("a.p-link","click",function(){ignoreHistoryEvent=!0;$.when(window.SmartCatalogueLinks.parseHash(/(#.+)/m.exec($(this).attr("href"))[1])).done(function(n){_productId=n.productId;o.info("current product id",_productId)})});var lt=function(){var t=document.location.pathname,n=/([\w-]+)\/?$/im.exec(t);return n===null?"":n[1]},ut=new $.Deferred,at=function(n,t){var i=[],r;return n.getExclusionFilters&&(r=n.getExclusionFilters(),r!==null&&(i=r.filterCollection(c))),i.length<1?t.filterCollection(c):t.filterCollection(i)},w=function(n,t){var ft,tt,it,ot,ht,ct,et;if(o.trace("onDataLoad"),!t.collection||(nt.onLoadEvent.detach(w),c=t.collection),!t.widgets||(a=t.widgets,rt.onLoadEvent.detach(w)),!t.categories||(p=t.categories),!t.filterDataSettings||(g=t.filterDataSettings,ut.resolve()),o.debug("collection",c?"resolved":"null","widgets",a?"resolved":"null","categories",p?"resolved":"null"),c!==undefined&&a!==undefined&&p!==undefined&&!e.dontFilter){if(o.trace("onDataLoad begin"),!t.before||t.before(),y=new CollectionView(d,g),y.registerHoverFunctions($("#collection-container")),o.trace("filtering collection"),ft=e.getFilters(),$(ft.get()).each(function(n,t){if(t.occasion){var i=e.getOccasionFilter(t.occasion[0].values);$(i).each(function(n,i){var r=i.get();t.occasion[0].field=r.id[0].field;t.occasion[0].value=r.id[0].value;t.occasion[0].values=r.id[0].values})}}),f=at(e,ft),tt=$("#promotion-init").attr("data-max-products"),tt&&tt!="all"&&(tt=parseInt(tt),it=$('#filter-init [data-filter-field="cat"]').attr("data-filter-value"),it!=undefined)){it=$.Enumerable.From(it.split("|"));ot=$("select.ddl-sortby").attr("data-filter-sort-mode");e.getFilters().sortCollection(f,ot);var st=$.Enumerable.From(f).GroupBy('$["@cat"]',"$").Where(function(n){return it.Contains(n.Key())}),k=[],vt=Math.ceil(tt/it.Count());st.ForEach(function(n){if(k.length!=tt){var t=Math.min(vt,tt-k.length);k=k.concat(n.Take(t).ToArray())}});k=$.Enumerable.From(k);k.Count()<tt&&(ht=st.SelectMany("$").Where(function(n){return!k.Any(function(t){return t["@id"]==n["@id"]})}).ToArray(),ct=k.Count(),k=k.Concat($.Enumerable.From(ht).Take(tt-ct)));c={};k.ForEach(function(n){c[n["@id"]]=n});f=e.getFilters().filterCollection(c)}o.trace("collection is filtered, contains ",f.length,"elements");et=lt();$.when(window.SmartCatalogueLinks.parseHash(document.location.hash||"#"+et)).done(function(n){var a;if(n.productId=n.productId||et,n.productId!==null&&(n.productId=n.productId.toUpperCase()),n.sortBy!=null){var y=$("#sortby-dropdown-1 option").removeAttr("selected"),p=y.filter('[data-filter-sort-mode="'+n.sortBy+'"]').attr("selected","selected"),w=p.text();w!=""&&(u._sortBy=n.sortBy,e.getFilters().sortCollection(f,n.sortBy))}else e.getFilters().sortCollection(f,e.getDefaultSortOrder());!n.productId||(_productId=n.productId,$.Enumerable.From(f).Any(function(t){return t["@id"]==n.productId})||(a=$.Enumerable.From(c).FirstOrDefault(null,function(t){return t.Key==n.productId}),a!=null&&f.push(a.Value)),f=$.Enumerable.From(f).OrderBy(function(t){return t["@id"]==n.productId?-1:0}).ToArray());u.numRows&&typeof u.numRows=="function"&&(u.numRows=u.numRows(f));$.when(u.loadCollectionProductsWithWidgets(!0,u.numRows,u.numColumns)).done(function(){var y,p,w,a;!!n.productId&&f&&f.length>0&&f[0]["@id"]==n.productId&&h.trylock()&&(s=f[0],y=$("#collection-container li[data-product-id="+n.productId+"]"),y.addClass(v),l=b(s,y,function(){h.unlock()}));!t.done||t.done();o.trace("onDataLoad end");i&&r&&(p=$.Enumerable.From(f).OrderBy(function(){return Math.random()}).FirstOrDefault(),r.children().remove(),u.createProduct(p,r,null,null,null),$("#id"+p["@id"]).css("display","block"),w=$("#productContainer").data("filterplacement")==="product",f.length>1?($("#giftcollectionpage").show(),w||$("#giftfinder_result").show()):$("#giftfinder_result, #giftcollectionpage").hide());a=$.Event("collectionFiltered");a.filteredCollection=f;a.Collection=c;$(document).trigger(a);e.dontFilter=!1})})}};nt.onLoadEvent.attach(w);nt.getCollection(d.attr("data-catalog"));rt=new WidgetsManagerClass(null,function(n){n.before=function(){$("div.filters-loading").show()};n.done=function(){$("div.filters-loading").delay(500).hide(1)};n.onLoadEvent.attach(w);n.GetWidgets(ct)});ft=function(n,t){o.trace("sorting updated");var i=null;t&&(i=t.sortOrder);u._sortBy=i;st()};this.closeProductDetail=function(n){$(".collection li").remove("#"+n);$(".collection li.active").removeClass("active")};this.loadCollectionProductsWithWidgets=function(n,t,i,r,c){var b,k,v,l,rt,g;if(f==null)throw new Error("filteredCollection cannot be null");!r||e.getFilters().sortCollection(f,r);n!==!1&&$("#collection-container").empty();(t==null||t<0)&&(t=10);(i==null||i<0)&&(i=4);var a=t*i,ut=Math.ceil(f.length/a),p=f.length+this.calculateTotalWidgetsCount(ut),nt=Math.ceil(p/a),w=$("#collection-container ul.page").length,ft=c?nt:w+1;for(o.debug("loadCollectionProductsWithWidgets, collection contains",f.length,"elements"),b=new $.Deferred,k=[],v=w;v<ft;v++)if(l=v+1,f.length==0)$("#collection-container").append(y.createEmptyResult()),$(".more-products:visible").fadeOut(200,function(){footer.setFooter()});else if(p>w*a){var it="page-"+l,et=y.createProductPageShell(it,l),d=$("<div class='paging'/>");l==1?d.addClass("disabled"):$("#collection-container .paging:first").removeClass("disabled");rt=window.Utils.StringFormat(window.DictionaryItems.P.PageXofY,l,nt);d.append("<span> - "+rt+" - <\/span>");$("#collection-container").append(d);$("#collection-container").append(et);g=u.getPageItems(f,l,i,t);k.push(g);$.when(g).done(function(n){$("#"+it).append(n)});(l-1)*a==0?footer.setFooter():$(".more-products").fadeIn(200,function(){footer.setFooter()})}return $.when.apply($,k).done(function(){var i,o,v,y,r,w;$(".more-products .more-products-button").show();$(".more-products .all-products-button").show();p<=l*a?$(".more-products").hasClass("newFilterType")?($(".more-products").hide(),footer.setFooter()):$(".more-products:visible").fadeOut(200,function(){footer.setFooter()}):($(".more-products").show(),footer.setFooter());var t="page-"+l,n=$("#collection-container #"+t+" li.list-product"),u=n.first().outerHeight(!0),d=n.first().outerWidth(!0),e=$("#collection-container #"+t+" > li.widget"),f=0;for(i=0,o=e.length;i<o;i++){var c=$(e[i]),g=c.outerWidth(!0),nt=c.outerHeight(!0);f=f+Math.round(g/d*nt/u)}for(v=Math.ceil((n.length+f)/4),y=v*u,r=40,w=n.length;r<w;r++){var k=$(n[r]),it=k.data("list-row")-1,rt=u*it;k.css("top",rt)}$("#"+t).height(y);footer.setFooter();tt(!1);h.unlock();s=undefined;$(this).trigger("new-page-added",[$("#"+t),l]);$(document).trigger("widgets-loaded");$("#collection-container img.lazy").pandoraLazyload({forceUpdate:!0});b.resolve()}),b.promise()};this.calculateTotalWidgetsCount=function(n){var t;return a?n>0?n>1?n- -2:3:(t=$.Enumerable.From($("#collection-container .widget")).Select(function(n){return $(n)[0].id}).ToArray(),t.length==0)?a.length:$.Enumerable.From(t).Sum(function(n){var t=$.Enumerable.From(a).Where(function(t){return t.id==n}).FirstOrDefault();return t?t.width*t.height:0}):0};this.getPageItems=function(n,t,i,r){var s,h,f;t=t-1;var c=new WidgetView,o=[];for(f=0;f<a.length;++f)o.push({data:a[f],w:a[f].width,h:a[f].height});for(s=[],f=0;f<n.length;++f)s.push({data:n[f]});for(vt(s,o,i,r,[{first:{min:2,max:3},spacing:{min:1,max:2}},{first:{min:3,max:7},spacing:{min:100,max:100}}]),h=[],f=0;f<o.length;++f)if(o[f].page==t){var l=o[f].w,v=o[f].h,p=o[f].data.id,w=o[f].x+1,b=o[f].y+1;v==2&&l==2?h.push(c.createTwoTwoWidget(p,w,b,o[f].data.html)):v==1&&l==2&&h.push(c.createTwoOneWidget(p,w,b,o[f].data.html));v==1&&l==1&&h.push(c.createOneOneWidget(p,w,b,o[f].data.html))}var k=$.Deferred(),nt=e.getVisibleFilters(),d=[],g=[];for(f=0;f<s.length;++f)s[f].page==t&&(g.push(y.createPageProduct(s[f].data,s[f].x+1,s[f].y+1,nt,u._sortBy)),d.push(s[f].data["@id"]));return $.when.apply($,g).done(function(){for(var n=0;n<arguments.length;n++)h.push(arguments[n]);u.shownProductsChangedEvent.notify({items:d});k.resolve(h.join(""))}),k.promise()};this.createProduct=function(n,t,i,r,u,f){var e=t.parent();return new ProductController({product:n,productID:n["@id"],setSingleTopViewID:f,container:t,effectTime:k,collection:c,updateHashOnProductClose:!1,onClose:function(n){ot(t,t.height(),0,e,i,n)},productClosedItself:function(){$("#collection-container li[data-product-id="+s["@id"]+"]").removeClass(v);s=undefined},adjustContainerHeight:function(n,r){t.hasClass("placeholder")?ot(t,t.height(),n,e,i,function(){typeof r=="function"&&r();h.unlock()}):t.animate({height:(n>t.height()?"+=":"-=")+Math.abs(n-t.height())},k,function(){typeof r=="function"&&r();h.unlock()})},onOpenAndFadeinCompleted:function(){u!==undefined&&typeof u=="function"&&u()},clickLock:h,categories:p,filtersData:d,filterDataSettings:g})};var ot=function(n,t,i,r,u,f){var l=i-t,e=[];u.each(function(){e.push(parseInt($(this).css("top"),10))});var o=$(window),s=o.scrollTop(),a=n.offset().top-it-$("#filter-container").outerHeight(!0)-s,h=r.height(),c=0;r.animate({height:(i>t?"+=":"-=")+Math.abs(l)},{step:function(r,f){var l=r-h,v,y,p;u.each(function(n){e[n]+=l;$(this).css("top",e[n])});t+=l;n.height(t);h=r;v=f.end-f.start;i>0&&v>0&&(y=l/v,p=Math.round(a*y),c+=p,o.scrollTop(c+s))},duration:k,complete:function(){i===0&&n.remove();f&&f()}})},st=function(){_productId=null;$.when(window.SmartCatalogueLinks.buildHash(e.getVisibleFilters(),_productId,u._sortBy)).done(function(n){o.debug("visible filters",e.getVisibleFilters(),"new smart catalogue url",n);location.hash!=n&&$.History.go(n)})},wt=function(n,t){o.trace("filter updated");t.hasOwnProperty("sortOrder")&&(u._sortBy=t.sortOrder);st()};e.onSortOrderChanged.attach(ft);e.onFilterChanged.attach(wt);$(window).off("scroll").scroll(function(){tt(!0)});ht=function(n){var t=$("#menu-container #menu"),l=$(".list-before .list-menu-item",t),w=l.css("z-index"),a,h,e,o,c,s,y,p;l.css("z-index",w=="auto"?"100":"auto");a=$("#filter-container");h=$("#menu-container").offset().top;n||t.removeAttr("style");var i=t.height(),f=$(window).scrollTop(),v=$("#collection-container");typeof r!="undefined"&&r.data("filterplacement")==="product"&&(v=r);e=v.offset().top;o=a.height();u.fullMenuHeight||(u.fullMenuHeight=i);f>h?(t.addClass("fixed"),$("#menu .container .menu .list-after li .boxed").addClass("small")):f<=h&&(t.removeClass("fixed"),$("#menu .container .menu .list-after li .boxed").removeClass("small"));c=function(){var r;if($.browser.msie&&!(parseInt($.browser.version)>7)){var n=t.height(),i=t.find(".list-menu-item.wishlist"),u=i.children(":visible"),e=$.Enumerable.From(u).Sum("jQuery($).height()"),f=(n-e)/2+(u==1?2:0);i.css({"padding-top":f,height:n-f});i.parent().height(n);r=t.find(".list-menu-item").filter(".giftcards, .shopping");r.css("padding-top",function(){var t=(n-r.height())/2;return $(this).is(".shopping")&&(t+=6),t})}};f+u.fullMenuHeight>e-o?(i=Math.max(it,e-o-f),t.height(i),t.find(".container .menu").height(i),t.find(".container .menu .logo").css({top:i/2-19}),s=$("#filter-container .filter"),y=s.is(".fixed"),s.addClass("fixed"),s.css({top:i}),y||$(document).trigger("collection:filters:sticked:to:window:top"),(!$.browser.msie||$.browser.msie&&parseInt($.browser.version)>"8")&&t.height(i-5),c()):f+u.fullMenuHeight<=e-o&&(t.height(u.fullMenuHeight),t.find(".container .menu").height(u.fullMenuHeight),t.find(".container .menu .logo").css({top:u.fullMenuHeight/2-19}),$("#filter-container .filter").removeClass("fixed").css({top:0}),$(document).trigger("collection:filters:unsticked:from:window:top"),(!$.browser.msie||$.browser.msie&&parseInt($.browser.version)>"8")&&t.find(".container .menu").height(u.fullMenuHeight+5),c());p=$("#footer");p.hasClass("footerAbsolute")&&(t.removeClass("fixed"),t.height(u.fullMenuHeight),$("#filter-container .filter").removeClass("fixed").css({top:0}),$(document).trigger("collection:filters:unsticked:from:window:top"))};tt=_.throttle(ht,100);$(".more-products a").unbind("click").click(function(n){n.preventDefault();o.trace("more products button clicked");var i=n.currentTarget.rel,t=!1;i&&(t=i==="allProducts");$(".more-products .more-products-button").hide();$(".more-products .all-products-button").hide();$(".more-products .spinner").removeClass("hide");setTimeout(function(){return h.trylock()&&(s?($("#collection-container li[data-product-id="+s["@id"]+"]").removeClass(v),l.closeProduct(function(){h.unlock();u.loadCollectionProductsWithWidgets(!1,u.numRows,u.numColumns,null,t)})):u.loadCollectionProductsWithWidgets(!1,u.numRows,u.numColumns,null,t),s=undefined),$(".more-products .spinner").addClass("hide"),$(".more-products a").removeClass("hide"),!1},200)});$.when(ut.promise()).then(function(){(o.trace("allDataLoaded"),historyPluginAttached)||(historyPluginAttached=!0,$.History.bind(function(u){if((u===null||u.length===0)&&(u="#"),u[0]!="#"&&(u="#"+u),o.debug("hash updated",u),ignoreHistoryEvent){ignoreHistoryEvent=!1;o.debug("history event is ignored");return}e.onFilterChanged.clear();e.onSortOrderChanged.clear();var f=new CollectionController(n,t,i,r)}))});$("#collection-container").off("click","li.list-product").on("click","li.list-product",function(){var n,t,o,i,a,y,e,k;if(h.trylock())if(n=$(this),t=c[n.attr("data-product-id")],s&&s["@id"]==t["@id"])l.closeProduct(function(){h.unlock()}),$("#collection-container li[data-product-id="+s["@id"]+"]").removeClass(v),s=undefined;else{if(n.addClass(v),s)if(o=parseInt(n.attr("data-list-row"),10),i=$("#collection-container li[data-product-id="+s["@id"]+"]"),i.removeClass(v),a=parseInt(i.attr("data-list-row"),10),o==a)y=n.parent().find("li").filter(function(){return parseInt($(this).attr("data-list-row"),10)>o}),l.onClose=function(){l=u.createProduct(t,n.parent().find("li.placeholder"),y,n.parent().find("li.placeholder").outerHeight(!0),function(){h.unlock()});l.onPlaceholderInitDone()},l.closeProduct();else{var r=$(window).scrollTop(),d=r+$(window).height(),p=$(".placeholder").offset().top,f=$(".placeholder").height(),w=p+f;d<p||r>w?(r>w&&$(window).scrollTo(r-f),$(".placeholder").remove(),e=i.parent(),k=e.height()-f,e.height(k),e.find("li").filter(function(){return parseInt($(this).attr("data-list-row"),10)>a}).each(function(){var n=parseInt($(this).css("top"),10);$(this).css("top",n-f)}),l=b(t,n,function(){h.unlock()})):l.closeProduct(function(){l=b(t,n,function(){h.unlock()})})}else l=b(t,n,function(){h.unlock()});s=t}});window.generateSmartCatalogueUrlForProductID=function(n){var t=e.getVisibleFilters();return window.SmartCatalogueLinks.buildHash(t,n,u._sortBy)}}function ProductModel(n){var t=this;this.name="CollectionModel";this.onLoadEvent=new pandora.utils.Event(this);$.ajax({url:n,dataType:"jsonp",jsonpCallback:"dataProduct",cache:"true",success:function(n){t.onLoadEvent.notify({product:n.data.product})}})}function ProductController(n){var i=this,s,u,r,t,f=n.productID,e,o;this.categories=n.categories;this.filtersData=n.filtersData;this.filterDataSettings=n.filterDataSettings;this.setSingleTopViewID=n.setSingleTopViewID;this.effectTime=n.effectTime;this.container=n.container;this.onClose=n.onClose;this.onOpenAndFadeinCompleted=n.onOpenAndFadeinCompleted;this.adjustContainerHeight=n.adjustContainerHeight;this.clickLock=n.clickLock;this.productClosedItself=n.productClosedItself;this.collection=n.collection;this.updateHashOnProductClose=n.updateHashOnProductClose===null?!0:n.updateHashOnProductClose;this.closeProduct=function(n){t&&t.fadeOut(this.effectTime,function(){t.unbind("renderDone");t.unbind("changedHeight");t.unbind("close");t.remove();i.onClose(n)})};e=function(){t!==undefined&&t!==null&&t.fadeIn(i.effectTime,function(){i.onOpenAndFadeinCompleted&&i.onOpenAndFadeinCompleted()})};o=function(n,f){(!f.product||(r=f.product),r!==undefined)&&(t=new ProductViewApp.ProductView({model:new ProductViewApp.ProductModel}),t.setElement($("<div><\/div>").appendTo(i.container)),t.bind("renderDone",function(n){i.setSingleTopViewID&&t.$el.attr("id","top-singleview-product");i.adjustContainerHeight(n)}),t.bind("changedHeight",function(n,t,r){i.adjustContainerHeight(t,r)}),t.bind("close",function(){i.closeProduct(function(){i.clickLock.unlock()});i.productClosedItself();i.updateHashOnProductClose&&$.when(window.generateSmartCatalogueUrlForProductID(null)).done(function(n){document.location.hash=n})}),t.model.set({id:r["@id"]}),u=!0)};this.onPlaceholderInitDone=function(){s=!0;u&&e()};this.showProduct=function(n){t&&t.fadeOut(this.effectTime,function(){t.remove()});f=n;r=undefined;var u=i.collection[n];o(this,{product:u})};this.showProduct(f)}function ProductVariantsService(n,t,i){var u=this,f=log4javascriptFactory.getLogger("Product Variants Service"),e,r;if(f.trace("Creating Product Categories Service"),e="/Services/ProductInfoService/ProductInfoService.svc/GetProductVariants/"+n,this.name="ProductVariantsService",this.onLoadEvent=new pandora.utils.Event(this),t!=null&&this.onLoadEvent.attach(t),!!i)for(r=0;r<i.length;r++)if(i[r].ProductNo==n){u.onLoadEvent.notify({productVariants:i});return}$.get(e,function(n){f.trace("Categories data retrieved");u.onLoadEvent.notify({productVariants:n})})}function CountriesService(){var t=this,n=log4javascriptFactory.getLogger("Countries Service");n.trace("Creating Countries Service");this.name="CountriesService";this.onLoadEvent=new pandora.utils.Event(this);this.getCountriesData=function(i){n.trace("Starting to retrieve countries data");$.get(i,function(i){n.trace("Countries data retrieved");t.onLoadEvent.notify({countriesData:i})})}}function FilterController(){var u,t,s,l,a,nt,ft,p,w,b,k,d,g;(window.Utils.isAndroid||window.Utils.isIpad)&&$("#filter-container").addClass("tabletDevice");u=window.log4javascriptFactory.getLogger("filter controller");u.setLevel(window.log4javascript.Level.WARN);var i=this,f=$("#filter-container"),e=f.find(".filter"),c=e.find(".filter-tabs"),et=e.find("#filter-init li"),o=e.find("#normal-options-menu"),ot=$("#sortby-dropdown-1 select").attr("data-filter-sort-mode"),st=$("#normal-options-menu.dropdown").length>0;$("#sortby-dropdown-1 select option").length==1&&$("#sortby-dropdown-1").hide();t=[];s=function(){window.scrollTo(0,f.offset().top-43)};this.onFilterChanged=new window.pandora.utils.Event(this);this.onSortOrderChanged=new window.pandora.utils.Event(this);l=new DropdownComponent2("#sortby-dropdown-1",["data-filter-sort-mode"]);l.clickedEvent.attach(function(n,t){i.onSortOrderChanged.notify({sortOrder:t["data-filter-sort-mode"]});s()});t.push(l);a=new DropdownComponent("#sortby-dropdown-2",["data-filter-sort-mode"]);a.clickedEvent.attach(function(n,t){i.onSortOrderChanged.notify({sortOrder:t["data-filter-sort-mode"]});s()});t.push(a);nt=function(){var n,u,t,f,o,r;if($("#browse-by, #filter-browseby-dropdown").remove(),n=$("#filter-browseby-init"),u=$("#normal-options-menu"),n.length!=0){t=$("#filter-container");u.addClass("browse-by-style").children(".filter-select",t).appendTo($(".more-filters .divider",t));f=$(".sortby",t);f.add(f.parent()).css("float","left");$(".reset-container",t).insertAfter(".more-less-container");var l=n.children('[data-filter-primary="true"]'),a=n.attr("data-title"),e=$("<p>{0}<\/p>".format(a)),i=$('<ul class="filter-param" id="browse-by"><\/ul>');if(l.each(function(){var n=$(this),t=n.text(),r=n.attr("data-filter-value"),u=n.attr("data-filter-field"),f=n.attr("data-filter-compare"),e=$('<li><a class="button white filter-button" href="#" data-filter-value="{0}" data-filter-field="{1}" data-filter-compare="{2}"><span class="l">&nbsp;<\/span><span class="c">{3}<\/span><span class="r">&nbsp;<\/span><\/a><\/li>'.format(r,u,f,t));e.appendTo(i)}),u.prepend(i),o=new RadioComponent("#browse-by"),o.clickedEvent.attach(tt),r=n.children('[data-filter-primary="false"]'),r.length){var s=n.attr("data-select-text"),h=$('<div class="select filter-select dropdown" id="filter-browseby-dropdown" defaulttext="{0}"><a href="#select" class="button white filter-dropdown select-button-drop"><span class="l">&nbsp;<\/span><span class="c"><span class="text"><\/span><span class="bullet">&nbsp;<\/span><\/span><span class="r">&nbsp;<\/span><\/a><div class="select-dropdown" style="display: none;"><div class="top"><\/div><div class="middle"><ul/><\/div><div class="bottom"><\/div><\/div><\/div>'.format(s)),c=$("ul",h),v=$("<li/>").appendTo(c);$('<a class="filter-button"/>').appendTo(v).attr({"data-filter-value":"","data-filter-field":"","data-filter-compare":"","data-filter-default":!0}).text(s);r.each(function(){var n=$(this),t=$("<li/>").appendTo(c);$('<a class="filter-button"/>').appendTo(t).attr({"data-filter-value":n.attr("data-filter-value"),"data-filter-field":n.attr("data-filter-field"),"data-filter-compare":n.attr("data-filter-compare")}).text(n.text())});h.insertAfter(i)}window.Pandora.Country.isRightToLeft&&r.length?e.prependTo("#filter-browseby-dropdown"):i.prepend(e)}};nt();$(".filter-select.dropdown").each(function(u,f){var e=new DropdownComponent("#"+f.id,["data-filter-value","data-filter-field","data-filter-compare"]),o=$(".filter-button",f);e.clickedEvent.attach(function(t,u){var f=n;o.each(function(n,t){var i=$(t);f.removeFilter(i.data("filter-field"))});f.createFilter(u["data-filter-field"],u["data-filter-value"],u["data-filter-compare"]);i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:f.get()})});t.push(e)});var ht=$(".filter-reset-button"),v="normal",y="active",h=new window.FilterImplementation,r=new window.FilterImplementation,n=new window.FilterImplementation;e.fadeIn(250);$(".filter-button.default-reset").each(function(){var t=$(this),n=t.parent().siblings().find(".filter-button").toArray();if(n.length>0){var i=$.Enumerable.From(n).SelectMany(function(n){return $(n).attr("data-filter-value").split("|")}).Distinct().Concat().ToArray().join("|"),r=$(n[0]).attr("data-filter-field"),u=$(n[0]).attr("data-filter-compare");t.attr({"data-filter-field":r,"data-filter-compare":u,"data-filter-value":i})}});$(".more-less-container > .button").off("click").click(function(n){n.preventDefault();var t=$(n.currentTarget).is(".active");rt(!t)});var tt=function(t,f){if(u.trace("filter radio button clicked"),f.down)if(f.clicked.closest(".filter-tabs").length==1)if(f.clicked.hasClass("default-reset")){h.clear();u.trace("filter tabs cleared");var e=n;e.createFilter(f.clicked.attr("data-filter-field"),f.clicked.attr("data-filter-value"),f.clicked.attr("data-filter-compare"))}else h.createFilter(f.clicked.attr("data-filter-field"),f.clicked.attr("data-filter-value"),f.clicked.attr("data-filter-compare")),u.trace("filter tabs created");else p.createFilter(f.clicked.attr("data-filter-field"),f.clicked.attr("data-filter-value"),f.clicked.attr("data-filter-compare")),u.trace("filter created");else p.removeFilter(f.clicked.attr("data-filter-field")),u.trace("filter removed");i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()});s()},ct=function(n,t){var i,r,u;return t=$(t),i=t.attr("data-filter-field")==n.dimension&&t.attr("data-filter-compare")==n.operator,i&&(r=$.Enumerable.From(t.attr("data-filter-value").split("|")),u=$.Enumerable.From(n.value.split("|")),i=r.Count()==u.Count()&&r.All(function(n){return u.Contains(n)})),i},it=function(n){return $.Enumerable.From($(".filter-button")).Where(function(t){return ct(n,t)})},rt=function(n){var t=$(".filters.more-filters"),i=$(".more-less-container > .button");if(f.removeAttr("style"),n){f.removeClass("lessfilters").addClass("morefilters");t.show();i.removeClass("filter-more-button").addClass("active filter-less-button").find(".text").text(window.DictionaryItems.L.Less);return}f.addClass("lessfilters").removeClass("morefilters");t.hide();i.addClass("filter-more-button").removeClass("active filter-less-button").find(".text").text(window.DictionaryItems.M.More)},ut=function(){var t=n;t.clear();$.when(window.SmartCatalogueLinks.parseHash(document.location.hash||"#")).done(function(n){for(var l,s,a,r,e=!1,i=0;i<n.filters.length;i++)l=it(n.filters[i]),l.ForEach(function(r){u.debug("url filter matched page filter",n.filters[i]);var f=$(r);f.closest(".filter-param").find(".filter-button").attr("data-filter-default","false").removeClass("active");f.attr("data-filter-default","true").addClass("active");st&&(f.closest(".filter-select").find(".filter-dropdown .text").text($.trim(f.text())),e=e||f.closest(".more-filters").length>0);t.createFilter(n.filters[i].dimension,n.filters[i].value,n.filters[i].operator)});rt(e);$(".select.sortby").each(function(t,i){var r=$(i),u;r.find("select option[data-filter-sort-mode='none']").remove();u=n.sortBy!==null?n.sortBy:$("select",r).data("filter-sort-mode");$(".text",r).text($('option[data-filter-sort-mode = "'+u+'"]',r).text())});o.addClass(y);s=$(".filters.more-filters");a=c.outerHeight(!0)+o.outerHeight(!0)+(s.is(":visible")?s.outerHeight(!0):0);f.height(a);r=c.find(".filter-param .filter-button[data-filter-default=true]").addClass(y);r.length!=1||r.hasClass("default-reset")||h.createFilter(r.attr("data-filter-field"),r.attr("data-filter-value"),r.attr("data-filter-compare"))})};this.getFilterHeight=function(){return parseInt(c.outerHeight(!0))+parseInt(o.outerHeight(!0))};this.getFilters=function(){return new window.FilterImplementation(h,r,n)};this.getVisibleFilters=function(){for(var r,i=[],t=this.getFilters().getFilters(),n=0;n<t.length;n++)r=it({dimension:t[n].field,operator:t[n].operator,value:t[n].value}),r.Any()&&i.push(t[n]);return i};this.getDefaultSortOrder=function(){return ot};this.toggleFilters=function(){v=v=="normal"?"extended":"normal";ut()};ht.unbind("click").click(function(u){u.preventDefault();n.clear();o.find("ul.filter-param a.filter-button").removeClass(y);for(var f=0;f<t.length;++f)t[f].resetSelection();i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get(),sortOrder:null})});et.each(function(){try{r.createFilter($(this).attr("data-filter-field"),$(this).attr("data-filter-value"),$(this).attr("data-filter-compare"))}catch(n){}});ft=new RadioComponent(".filter-param");p=n;ft.clickedEvent.attach(tt);w=new DropdownComponent("#filter-collections-dropdown",["data-filter-value","data-filter-field","data-filter-compare"]);w.clickedEvent.attach(function(){i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()})});t.push(w);b=new DropdownComponent("#filter-categories-dropdown",["data-filter-value","data-filter-field","data-filter-compare"]);b.clickedEvent.attach(function(){i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()})});t.push(b);k=new DropdownComponent("#filter-stones-dropdown",["data-filter-value","data-filter-field","data-filter-compare"]);k.clickedEvent.attach(function(){i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()})});t.push(k);d=new DropdownComponent("#filter-materials-dropdown",["data-filter-value","data-filter-field","data-filter-compare"]);d.clickedEvent.attach(function(){i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()})});t.push(d);g=new DropdownComponent("#filter-colors-dropdown",["data-filter-value","data-filter-field","data-filter-compare"]);g.clickedEvent.attach(function(){i.onFilterChanged.notify({listFilters:r.get(),environmentFilters:n.get()})});t.push(g);ut();window.setTimeout("alignFilterParam()",50)}function DropdownComponent2(n,t){var r=$(n+" .PandoraDropDown").removeClass("active"),u=r.find(".text"),i=u.text(),f;$(n).attr("defaultText")==null?$(n).attr("defaultText",i):i=$(n).attr("defaultText");f=this;this.clickedEvent=new window.pandora.utils.Event(this);r.unbind("change").change(function(n){var i;n.preventDefault();var e={},o=$("*[id$='filterDropDown']"),r=$(o).find("option:selected");for(r.val()!="none"&&$(o).find("option[data-filter-sort-mode='none']").remove(),i=0;i<t.length;++i)e[t[i]]=r.attr(t[i]);f.clickedEvent.notify(e);u.text(r.text())});this.resetSelection=function(){var t=$("*[id$='filterDropDown']"),n;$(t).find("option[data-filter-sort-mode=none]").length==0&&t.prepend("<option data-filter-sort-mode='none' value='none'>"+i+"<\/option>");t.find("option:first-child").attr("selected","selected");n="ddl-sortby";t.parent().find("a.button.PandoraDropDown."+n).remove();$("div.options.PandoraDropDown."+n).remove();$("select.PandoraDropDown."+n).removeClass("styled");$("select.PandoraDropDown."+n).styleSelect()}}function DropdownComponent(n,t){var i="active",o=$(n+" .select-button-drop").removeClass(i),f=$(n+" .select-dropdown"),s=$(n+" .select-dropdown ul li a"),r=o.find(".text"),u=r.text(),h,e;$(n).attr("defaultText")==null?$(n).attr("defaultText",u):u=$(n).attr("defaultText");r.empty().text(u);h=this;this.clickedEvent=new window.pandora.utils.Event(this);e=function(n){var c,u,o,f;if(n.preventDefault(),c=$(n.target),c.hasClass("select-dropdown"))n.stopPropagation();else if($(".select-dropdown").slideUp(200),$(document).unbind("mousedown",e),u=$(n.target).closest(".select-dropdown ul li a"),u.length==1){for(s.removeClass(i),u.addClass(i),o={},f=0;f<t.length;++f)o[t[f]]=u.attr(t[f]);h.clickedEvent.notify(o);r.text(u.text())}};o.unbind("click").bind("click",function(n){n.preventDefault();f.is(":visible")||(f.slideDown(200),f.css("z-index",9e5),$(document).bind("mousedown",e))});this.resetSelection=function(){s.removeClass(i);r.text(u)}}function RadioComponent(n){var t="active",r=$(n+" li a").removeClass(t),i=this;this.tagid=n;this.buttons=r;this.clickedEvent=new window.pandora.utils.Event(this);r.unbind("click").bind("click",function(n){var r,u;n.preventDefault();r=$(this);r.hasClass(t)?!r.closest(".filter-tabs").length==1&&(r.removeClass(t),i.clickedEvent.notify({clicked:r,down:!1})):(u=r.parent().parent().find("a."+t),u.length&&(u.removeClass(t),i.clickedEvent.notify({clicked:u,down:!1})),r.addClass(t),i.clickedEvent.notify({clicked:r,down:!0}))})}function alignFilterParam(){var n=$("#filter-container .filter-tabs ul");n.css("margin-left",-(n.width()/2))}var HowToBuyApp,ProductViewApp;(function(n){n(function(){var i=function(){n(".wishlist-empty-curtain, .wishlist-items-curtain").length&&(window.User.Authenticated?Wishlist.Count(function(t){if(n('[data-user-logged="0"]').css("display","none"),t){n('.wishlist-empty-curtain[data-user-logged="1"]').css("display","none");n('.wishlist-items-curtain[data-user-logged="1"]').removeAttr("style");n("span.wishlist-item-counter").text(t);var i=n("span[data-singular]");i.text(i.data(t>1?"plural":"singular"))}else n('.wishlist-empty-curtain[data-user-logged="1"]').removeAttr("style"),n('.wishlist-items-curtain[data-user-logged="1"]').css("display","none")}):(n('[data-user-logged="1"]').css("display","none"),n('[data-user-logged="0"]').removeAttr("style")))},r=function(){_.defer(function(){Pandora.Base.execute("process:prerendered:videos")})},t;n(document).on("widgets-loaded",i).on("widgets-loaded",r);Wishlist.wishlistChangedEvent(i);t=window.PANDORA.Tracking.Netminers;n(document).on("click",".signup-button",function(n){n.preventDefault();t.trackPageView(t.standardBreadcrumbsAtTheEnd("Wishlist/Widget/Login"),null,!0);window.LoginOverlay.Show(null,"login",null,"WishlistDropDown",null,"WishlistDropDown")});n(document).on("click",".goto-wishlist",function(n){n.preventDefault();t.trackPageView(t.standardBreadcrumbsAtTheEnd("Wishlist/Widget/Go to wishlist"),null,!0,function(){window.location.href="/{0}/pandora-club/wishlist".format(Utils.SiteLanguage().toLowerCase())})});n(document).on("click",".share-button",function(i){i.preventDefault();t.trackPageView(t.standardBreadcrumbsAtTheEnd("Wishlist/Widget/Share"),null,!0);var r=n(i.currentTarget),u=r.offset();window.WishlistShareDropDownControl.showShareOptionsDropDown(u.top+r.height()+12,u.left+r.width()-315,"overlay")})})})(jQuery);$(document).ready(function(){collectionController=new CollectionController}),function(n){n.fn.lazyGallery=function(t,i){return this.each(function(){function o(i){var f;f=u+i<0?t.length-1:u+i>=t.length?0:u+i;n(r.find(".image").get(f)).fadeIn();n(r.find(".image").get(u)).fadeOut();u=f}var r=n(this),u=0,s=0,h=5,f,e;for(i!=undefined&&(h=i),r.append('<div class="next"><a href="#">next<\/a><\/div><div class="previous"><a href="#">previous<\/a><\/div>'),r.find(".next a").bind("click",function(){return o(1),!1}),r.find(".previous a").bind("click",function(){return o(-1),!1}),f=0;f<t.length;f++)e=new Image,n(e).appendTo(r).wrap('<div class="image" />').load(function(){r.find(".image").index(n(this).parent())==0&&n(this).parent().fadeIn();s++}).error(function(){alert("fejl")}).attr("src",t[f])})}}(jQuery);var historyPluginAttached=!1,ignoreHistoryEvent=!1,_productId=null,menuFixInterval=null;$("body.browserModern #normal-options-menu.tabletDevice ul.filter-param li a.button.filter-button").click(function(){}),function(n){var t=window.PANDORA.Tracking.Netminers,o={tab:{values:{charms:"chm","clips_fixed charms":"clp","charm dangl":"pen","charm spacer":"spc",safetychain:"sfc","earring hanging":"pen","earring hoop":"hup","earring stud":"pin",watch:"wat",strap:"str",bezel:"bzl","new-collection":"nco",popular:"pop",pave:"pve","gift-sets":"gse"}},cat:{values:{bracelets:"brc",charms:"chm",earrings:"ear","necklaces and pendants":"nec",rings:"rin",watch:"wat",strap:"str",bezel:"bzl"}},price:{key:"pri",values:{pricerange1:"pr1",pricerange2:"pr2",pricerange3:"pr3",pricerange4:"pr4",pricerange5:"pr5"}},occasion:{key:"occ",values:{christmas:"chr",birthday:"bir",anniversary:"ann",justbecause:"jus",friendship:"fri","self-gifting":"mys"}},metal:{key:"met",values:{gold:"gld",silver:"slv",watchsteel:"stl",duotone:"duo"}},color:{key:"col",values:{black:"bla",blue:"blu",brown:"bro",green:"grn",grey:"gry","multi color":"mul",orange:"ora","purple pink":"pur",red:"red",white:"whi",yellow:"yel"}},stone:{key:"stn",values:{"with stone":"stn","without stone":"nst"}},subcol:{key:"stn",values:{pave:"pve"}},material:{key:"mat",values:{murano:"gls",wood:"wod",enamel:"enm",leather:"lth"}},subcat:{key:"pen",values:{"necklace with pendant":"wpn","necklace only":"npn"}},theme:{key:"oth",values:{"alphabet and numbers":"aan",animals:"anm","cause and awereness":"caw",decorative:"dec",fairytale:"fyt","family and friends":"fam",floral:"flo",glamour:"glm",glass:"gls",hobbies:"hob",love:"lve",nature:"nat",occasions:"occ",occupation:"ocp",symbols:"smb",travel:"trv"}},sor:{values:{n:"new",r:"new",po:"pop",ph:"high",pl:"low"}}},i=function(n,t,i){t=(t||"").toLowerCase();i=(i||"").toLowerCase();var r=o[t];r&&(t=r.key||t,i=r.values[i]||i);i==="all"?delete n[t]:n[t]=i},r=function(n,t){for(var r in t)t.hasOwnProperty(r)&&i(n,r,t[r]);return n},u=function(i){var r;return n(i).each(function(){r=n.extend(r,t.stringToObject(n(this).data("tracking-vars")))}),r},s=function(n){return n.vars=r({},u('.active[data-tracking="Netminers"][data-tracking-handler="gaHandler"], .active > [data-tracking="Netminers"][data-tracking-handler="gaHandler"]')),n},f=!1,e=function(){var t=r({},u('.active[data-tracking="Netminers"][data-tracking-handler="jfHandler"]')),e=n("select.filter-dropdown").val();return i(t,"sor",e==="none"||f?e:"all"),t},h=function(t){return t.vars=e(),n.inArray("Show more",t.bcs)!==-1||n.inArray("Show all",t.bcs)!==-1?t:null};n(function(){t.setHandler("gaHandler",s);t.setHandler("jfHandler",h);var i=function(){var i=e();i.sor!=="none"&&n.when(window.SmartCatalogueLinks.parseHash(window.location.hash)).done(function(n){var r=[];n.productId&&(i[t.getStandardNames().productId]=n.productId,r.push("Show Product"));t.trackPageView(r,i,!1)})};n(document).on("change.netminers","select.filter-dropdown",function(){f=!0});n.History.bind(i)})}(jQuery);HowToBuyApp={};HowToBuyApp.HowToBuyAppView=Backbone.View.extend({events:{"click #HowToBuyCloseDialogMenuButton":"closeDialogMenuButton_OnClick"},render:function(){var n=this,t=_.template($("#HowToBuyAppViewTemplate").html(),this.model.toJSON());$(this.el).html(t);this.theDialog=$(this.el).dialog({modal:!0,resizable:!1,show:{effect:"fade",speed:400},hide:{effect:"fade",speed:400},draggable:!1,width:"auto",height:"auto",position:"center",open:function(n){$(n.target).parent().first().first().find(".ui-dialog-titlebar").remove()},close:$.proxy(this.dialog_OnClose,n)})},dialog_OnClose:function(){this.remove()},closeDialogMenuButton_OnClick:function(n){n.preventDefault();this.close()},close:function(){$(this.theDialog).dialog("close")}});ProductViewApp=ProductViewApp||{};ProductViewApp.ProductModel=Backbone.Model.extend({defaults:{id:"",product:null,eStoreLinkTemplate:"",storeFinderUrl:"",currency:null,imageurl:null,sizeGuideUrl:null,SwissTitle:null,SwissDescription:null,SapphireTitle:null,SaphireDescription:null,BlackCrownDiamondTitle:null,BlackCrownDiamondDescription:null,BlackCrownDiamondGuideUrl:null,createAndCombineEnabled:!0,subcollection:{title:null,description:null,imageUrl:null},facebookComments:!1},initialize:function(){this.listenTo(this,"change:id",this.fetch);this.productProvider=window.injector.getValue("productProvider");this.productRelationsProvider=window.injector.getValue("productRelationsProvider")},fetch:function(){var n=this,t=$("#static-data-init"),i,r;if(t.length===0)throw"Could not find element with id = 'static-data-init'. This element must be present for the ProductViewApp.ProductView to work.";i=$("#collection-container");i.length>0&&this.set({createAndCombineEnabled:i.data("showcustomizable")});this.set({storeFinderUrl:t.data("storefinder-url")});r=function(n,t){return _.filter(t,function(t){return n.rawData["@col"]==="04"?t["@col"]==="04":t["@col"]!=="04"})};$.when(n.productProvider.ready(),n.productRelationsProvider.ready()).done(function(){var u=n.get("id"),i=typeof u=="number"?u.toString():u,f=n.productProvider.getProductByItemNumber(i),e=n.productRelationsProvider.getNeededItems(i),o=r(f,$.Enumerable.From(n.productRelationsProvider.getGoesWellWithItems(i)).SelectMany(function(n){return n.ToArray()}).ToArray()),s=$.Enumerable.From(n.productRelationsProvider.getSameStyleDifferentLookItems(i)).SelectMany(function(n){return n.ToArray()}).ToArray(),h=$.Enumerable.From(e).SelectMany(function(n){return n.ToArray()}).ToArray(),c=t.data("size-guides"),l=$.Enumerable.From(c).Where('$.CategoryKey == "{0}"'.format(f.rawData["@cat"])).Select("$.Url").FirstOrDefault(null);n.set({product:f,allRelatedProducts:_.union(h,o,s),neededItems:e,goesWellWith:o,sameStyle:s,imageurl:n.productProvider.productMetaData["@imageurl"],currency:n.productProvider.productMetaData["@currency"],sizeGuideUrl:l})})}});ProductViewApp=ProductViewApp||{};ProductViewApp.NecklaceWithStoryView=Backbone.View.extend({tagName:"div",className:"product",initialize:function(){this._templates={imageWithStory:_.template($('[data-template-for = "product-view-image-with-story"]').html()),image:_.template($('[data-template-for = "product-view-image"]').html()),info:_.template($('[data-template-for = "product-view-moreinfo-general"]').html())}},render:function(){var i=this,n=$("#necklace-data-init"),t;i.model.set({subcollection:{title:n.data("title"),description:n.data("description"),imageUrl:n.data("image-url")}});t=jQuery.extend(this.model.attributes,this.options);this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.info(t));this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.imageWithStory(t))}});ProductViewApp=ProductViewApp||{};ProductViewApp.BezelView=Backbone.View.extend({tagName:"div",className:"product",initialize:function(){this._templates={moreinfo:_.template($('[data-template-for = "product-view-moreinfo-bezel"]').html()),image:_.template($('[data-template-for = "product-view-image"]').html())}},render:function(){this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.moreinfo(this.model.attributes));this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.image(this.model.attributes))}});ProductViewApp=ProductViewApp||{};ProductViewApp.StrapView=Backbone.View.extend({tagName:"div",className:"product",initialize:function(){this._templates={moreinfo:_.template($('[data-template-for = "product-view-moreinfo-strap"]').html()),image:_.template($('[data-template-for = "product-view-image"]').html())}},render:function(){this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.moreinfo(this.model.attributes));this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.image(this.model.attributes))}});ProductViewApp=ProductViewApp||{};ProductViewApp.WatchView=Backbone.View.extend({tagName:"div",className:"product",initialize:function(){this._templates={watches:_.template($('[data-template-for = "product-view-moreinfo-watches"]').html()),imageWithStory:_.template($('[data-template-for = "product-view-watch-with-story"]').html()),image:_.template($('[data-template-for = "product-view-image"]').html())};var n=$("#watch-data-init");if(n.length===0)throw"Could not find element with id = 'watch-data-init'. This element must be present for the ProductViewApp.ProductView to work.";this.model.set({SwissTitle:n.data("swiss-title")});this.model.set({SwissDescription:n.data("swiss-description")});this.model.set({SapphireTitle:n.data("sapphire-title")});this.model.set({SaphireDescription:n.data("sapphire-description")});this.model.set({BlackCrownDiamondTitle:n.data("diamond-title")});this.model.set({BlackCrownDiamondDescription:n.data("diamond-description")})},render:function(){var n=this,r=$("#subcollections"),t,u=this.model.get("product")["@subcol"].split("|"),i;this._hasInterChangables(this.model.get("product"))&&this.model.set({hasInterChangables:!0,interchangeables:{strap:this.model.get("product")["@interchangeable"].indexOf("4")>=0,bezel:this.model.get("product")["@interchangeable"].indexOf("8")>=0}});this.model.set({hasInterChangables:this._hasInterChangables(this.model.get("product"))});_.each(u,function(i){t=r.children("li[data-key='"+i+"']");t.length>0&&n.model.set({subcollection:{title:t.data("title"),description:t.data("description"),imageUrl:t.data("image-url")}})});i=jQuery.extend(this.model.attributes,this.options);this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.watches(i));this.model.get("subcollection").title!==null?this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.imageWithStory(i)):this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.image(i));n.$(".overlay-content-dimensions .spec-img").each(function(n,t){var i=$(t),r=i.attr("imagesrc"),u=new Image;$(u).load(function(){i.append('<img src="'+r+'"/>')});u.src=r});n._setLastClassOnElements(n.$(".overlay-content-features dl"));n._setLastClassOnElements(n.$(".overlay-content-dimensions dl"))},_hasInterChangables:function(n){return n["@interchangeable"]!==undefined&&(n["@interchangeable"].indexOf("4")>=0||n["@interchangeable"].indexOf("8")>=0)},_setLastClassOnElements:function(n){n.last().addClass("last");n.length%2==0&&n.last().prev().addClass("last")}});ProductViewApp=ProductViewApp||{};ProductViewApp.ProductView=Backbone.View.extend({options:{formatSettings:null,effectDuration:400},productTypes:{WATCH:{category:11,subCategory:101},NECKLACEWITHSTORY:{category:3,subCollection:6},BEZEL:{category:11,subCategory:102},STRAP:{category:11,subCategory:103}},tagName:"div",events:{"click .close a":"_closeView","click .SendHintButtonContainer a":"_sendHintClick","click .summary .read-more":"_showMoreInfo","click .summary .read-less":"_showLessInfo","click .saveButton":"_toggleSaveBox","click .saveAndShare .saveToWishlistButton":"_saveToWishlist","click .saveAndShare .removeFromWishlistButton":"_removeFromWishlist","click .saveAndShare .saveToJewelryButton":"_saveToMyJewelery","click .saveAndShare .removeFromJewelryButton":"_removeFromMembersJewellery","click .shareButton":"_toggleShareBox","click .add-to-wish-list a":"_saveToWishlist","click .related-item-wrapper .filters a":"_relatedFilterClick"},initialize:function(){this.listenTo(this.model,"change:product",this._productChanged);this._templates={general:_.template($('[data-template-for = "product-view-general"]').html()),moreInfo:_.template($('[data-template-for = "product-view-moreinfo-general"]').html()),moreInfoEssence:_.template($('[data-template-for = "product-view-moreinfo-general-essence"]').html()),image:_.template($('[data-template-for = "product-view-image"]').html()),imageEssence:_.template($('[data-template-for = "product-view-image-essence"]').html()),info:_.template($('[data-template-for = "product-view-info"]').html()),sizes:_.template($('[data-template-for = "product-view-sizes"]').html()),sizesEssence:_.template($('[data-template-for = "product-view-sizes-essence"]').html()),relatedProducts:_.template($('[data-template-for = "product-view-related-products"]').html())};this.subView=null;this.viewData={sendHintEnabled:$("#SendHintControlContainer").length>0,sendHintButtonText:$("#SendHintControlContainer").data("sendhintheader"),sendHintButtonIsWhite:$("#SendHintControlContainer").data("buttoniswhite"),howToBuyEnabled:$("#SendHintControlContainer").data("howtobuyenabled")};User.ListenToEvent($.proxy(this._userStateChanged,this))},_productChanged:function(){var n=this;User.Authenticated?n._updateWishlistStatus($.proxy(n.render,n)):n.render()},render:function(){var t,n,i;this.subView=null;t=this.model.get("product");(window.Pandora.Country.eStoreSettings.GoToEStoreLinkEnabled&&window.Pandora.Country.eStoreSettings.EStoreLinkTemplate&&t.rawData["@col"]!="04"||window.Pandora.Country.eStoreSettings.GoToEStoreLinkEnabled&&window.Pandora.Country.eStoreSettings.EStoreLinkTemplate&&window.Pandora.Country.eStoreSettings.HasEssenceProducts&&t.rawData["@col"]=="04")&&this.model.set({eStoreLinkTemplate:window.Pandora.Country.eStoreSettings.EStoreLinkTemplate});t.rawData["@col"]!="04"&&(this.options.createAndCombineEnabled=this.model.get("createAndCombineEnabled"));n=jQuery.extend(this.model.attributes,this.options,this.viewData);this.$el.html(this._templates.general(n));this.model.get("product").sizes!==undefined&&this.model.get("product").sizes.size!==undefined&&this.model.get("product").sizes.size.length>0&&(t.rawData["@col"]=="04"?this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.sizesEssence(n)):this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.sizes(n)),this.$(".overlay-content-sizes dl").each($.proxy(this._setClassesOnSizes,this)));i=this._getProductType(t);switch(i){case this.productTypes.WATCH:this.subView=new ProductViewApp.WatchView({options:this.options,model:this.model,el:this.el});break;case this.productTypes.BEZEL:this.subView=new ProductViewApp.BezelView({options:this.options,model:this.model,el:this.el});break;case this.productTypes.STRAP:this.subView=new ProductViewApp.StrapView({options:this.options,model:this.model,el:this.el});break;case this.productTypes.NECKLACEWITHSTORY:this.subView=new ProductViewApp.NecklaceWithStoryView({options:this.options,model:this.model,el:this.el});break;default:t.rawData["@col"]=="04"?(this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.moreInfoEssence(n)),this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.imageEssence(n))):(this.$('[data-placeholder-for = "general-info"]').replaceWith(this._templates.moreInfo(n)),this.$('[data-placeholder-for = "image"]').replaceWith(this._templates.image(n)))}return this.$('[data-placeholder-for = "info"]').replaceWith(this._templates.info(n)),this.subView!==null&&this.subView.render(),User.Authenticated?(this.$(".loggedInTrue").show(),this.$(".loggedInFalse").hide(),this._configureWishlistButtons(),this._configureMembersJewelleryButtons()):(this.$(".loggedInTrue").hide(),this.$(".loggedInFalse").show()),this.$(".saveOptions .textBubble").hide(),this._configureHowToBuyLink(),this.model.get("sameStyle").length>0?(this._showRelatedGroup(),this.$('.filter-button[data-collection="sameStyle"]').addClass("active"),this.$(".related-item-wrapper").show()):this.model.get("goesWellWith").length>0&&(this._showRelatedGroup(NaN,"goesWellWith"),this.$('.filter-button[data-collection="goesWellWith"]').addClass("active"),this.$(".related-item-wrapper").show()),this.model.get("neededItems").length===0&&this.$(".filters.variations").addClass("noneededitems"),this.$(".product").show(),this._initializeMagicZoom(),this._loadAddThisToolbox(),this._loadFacebookLike(),this.trigger("renderDone",this.$el.height()),_.defer(function(){$(window).trigger("resize")}),this},fadeIn:function(n,t){this.$el.fadeIn(n,t)},fadeOut:function(n,t){this.$el.fadeOut(n,t)},getHeight:function(){return this.$(".product").outerHeight(!0)},_initializeMagicZoom:function(){this.$(".image img").MagicZoom()},_closeView:function(n){n.preventDefault();this.$(".product").fadeOut(this.options.effectDuration,$.proxy(function(){this.trigger("close")},this))},_sendHintClick:function(n){n.preventDefault();var t=new SendHintApp.SendHintAppView({el:$("#SendHintDialog").clone(!0),product:this.model.get("product"),currency:this.model.get("currency")})},_showMoreInfo:function(n){var t=this,r,i;n.preventDefault();r=t.getHeight();i=t.$(".essence-product-info-wrapper");i.length===0&&(i=t.$(".images"));i.fadeOut(t.options.effectDuration,function(){t.$(".read-more").text(DictionaryItems.L.LessInfo).removeClass("read-more").addClass("read-less").data("tracking-parameters","read less");var i=t.$(".about-overlay-container").show().css("height","auto"),n=function(){i.hide().css("visibility","visible").fadeIn(t.options.effectDuration)};r!==t.getHeight()?t.trigger("changedHeight",r,t.getHeight(),n):n()});$(".about-essence-product-info").length>0&&t.$(".about-essence-product-info").fadeOut(t.options.effectDuration)},_showLessInfo:function(n){var t=this,i;n.preventDefault();i=t.getHeight();t.$(".about-overlay-container").fadeOut(t.options.effectDuration,function(){var n,r;t.$(".read-less").text(DictionaryItems.R.ReadMore).removeClass("read-less").addClass("read-more").data("tracking-parameters","read more");n=t.$(".essence-product-info-wrapper");n.length===0&&(n=t.$(".images"));r=function(){n.fadeIn(t.options.effectDuration);$(".about-essence-product-info").length>0&&t.$(".about-essence-product-info").fadeIn(t.options.effectDuration)};i!==t.getHeight()?t.trigger("changedHeight",i,t.getHeight(),r):r()})},_loadAddThisToolbox:function(){AddThisToolboxApp.remove();AddThisToolboxApp.show({el:this.$el.find(".shareOptions .textBubbleWrapper"),product:this.model.get("product"),currency:this.model.get("currency"),imageRoot:this.model.get("imageurl")})},_loadFacebookLike:function(){var t=this,i=$("#static-data-init");if(i.length===0)throw"Could not find element with id = 'static-data-init'. This element must be present for the ProductViewApp.ProductView to work.";var n=220,r=i.data("facebook-locale"),u=t.model.get("product")["@url"];t.$el.find(".shareOptions .textBubbleWrapper").prepend('<iframe src="http://www.facebook.com/plugins/like.php?action=like&amp;api_key=187699144604345&amp;width='+n+"&amp;stream=false&amp;header=false&amp;height=21&amp;href="+encodeURI(u)+"&amp;layout=button_count&amp;locale="+r+'&amp;node_type=link&amp;sdk=joey&amp;show_faces=false" scrolling="no" frameborder="0" style="border: none; overflow: hidden; width: '+n+'" allowtransparency="true" height="21" width="'+n+'"><\/iframe>')},_setClassesOnSizes:function(n,t){var i=$(t);n%2?(i.addClass("odd"),n===this.model.get("product").sizes.size.length-1&&i.addClass("last")):(i.addClass("even"),n===this.model.get("product").sizes.size.length-2&&i.addClass("last"))},_saveToWishlist:function(n){var t=this,r,i;if(n.preventDefault(),n.stopPropagation(),window.PANDORA.Tracking.Netminers.trackPageView(function(n){return["Wishlist","Add to wishlist"].concat(n)},null,!0),this.model.get("isInWishlist"))throw"Product with id "+this.model.get("id")+" is already in user's wishlist. This method should not be called!";r=function(n){_.each(n,function(n){i(n.ProductNumber)})};i=function(n){Wishlist.addToWishlist(n,function(){t.model.set({isInWishlist:!0});t._configureWishlistButtons();t._hideSaveBox()});window.WishlistShareDropDownControl.addToWishlistConfirmationDlg()};User.Authenticated?this.model.get("product").sizes!==undefined&&this.model.get("product").sizes.size.length>0?t._showSizeSelector(t.model.get("id"),r):i(this.model.get("id")):LoginOverlay.Show(function(){t.model.get("product").sizes!==undefined&&t.model.get("product").sizes.size.length>0?t._showSizeSelector(t.model.get("id"),r):i(t.model.get("id"))})},_removeFromWishlist:function(n){var t=this;n.preventDefault();n.stopPropagation();Wishlist.removeFromWishlist(t.model.get("id"),!0,function(){t.model.set({isInWishlist:!1});t._configureWishlistButtons();t._hideSaveBox()})},_saveToMyJewelery:function(n){var t=this,r,i;if(n.preventDefault(),n.stopPropagation(),window.PANDORA.Tracking.Netminers.trackOther("add to my jewelry"),t.model.get("isInMembersJewellery"))throw"Product with id "+this.model.get("id")+" is already in member's jewellery. This method should not be called!";r=function(n){_.each(n,function(n){i(n.ProductNumber)})};i=function(n){JewelryService.Add(n,function(){t.model.set({isInMembersJewellery:!0});t._configureMembersJewelleryButtons();t._hideSaveBox()})};this.model.get("product").sizes!==undefined&&this.model.get("product").sizes.size.length>0?t._showSizeSelector(t.model.get("id"),r):i(this.model.get("id"))},_removeFromMembersJewellery:function(n){var t=this;n.preventDefault();n.stopPropagation();JewelryService.Remove(t.model.get("id"),function(){t.model.set({isInMembersJewellery:!1});t._configureMembersJewelleryButtons();t._hideSaveBox()})},_showSizeSelector:function(n,t){ProductInfoClass.GetProducts(n,function(n){ProductSizeSelectorOverlay.Show(n,!1,t,null,ProductSizeSelectorType.AddToWishlist)})},_toggleSaveBox:function(n){var t=this,i;n.preventDefault();n.stopPropagation();t.$(".saveOptions .textBubble").toggle();t.$(".saveOptions .textBubble:visible").length>0&&(i=function(n){var r=$(n.target);r.closest(".textBubble").length===0&&r.closest(".ui-dialog").length===0&&r.closest(".ui-widget-overlay").length===0&&(t.$(".saveOptions .textBubble").hide(),$("html").unbind("click",i))},$("html").click(i));this._hideShareBox()},_toggleShareBox:function(n){var t=this,i;n.preventDefault();n.stopPropagation();window.PANDORA.Tracking.Netminers.trackOther("share");t.$(".shareOptions").toggle();t.$(".shareOptions .textBubble:visible").length>0&&(t.$(".shareOptions").css({"z-index":"9999"}),i=function(n){var r=$(n.target);r.closest(".textBubble").length===0&&(t.$(".shareOptions").hide(),$("html").unbind("click",i))},$("html").click(i));this._hideSaveBox()},_hideShareBox:function(){this.$(".shareOptions").css({"z-index":"-100"});this.$(".shareOptions").hide()},_hideSaveBox:function(){this.$(".saveOptions .textBubble").hide()},_configureWishlistButtons:function(){this.model.get("isInWishlist")?(this.$(".saveToWishlistButton").hide(),this.$(".removeFromWishlistButton").show()):(this.$(".removeFromWishlistButton").hide(),this.$(".saveToWishlistButton").show())},_configureMembersJewelleryButtons:function(){this.model.get("isInMembersJewellery")?(this.$(".saveToJewelryButton").hide(),this.$(".removeFromJewelryButton").show()):(this.$(".removeFromJewelryButton").hide(),this.$(".saveToJewelryButton").show())},_configureHowToBuyLink:function(){var t=this,n=$("#HowToBuyDialog");if(this.$(".buyArea a span").text($("#HowToBuyControlContainer").data("linktitle")),n.length===0)this.$(".buyArea a").hide();else this.$el.on("click",".buyArea a",function(i){i.preventDefault();var r=t.model.get("product").rawData["@col"]=="04",u=n.clone(!0),f=new HowToBuyApp.HowToBuyAppView({el:u,model:new Backbone.Model({storesUrlQs:r?"?type=essence-collection":""})});f.render()})},_updateWishlistStatus:function(n){var t=this,i=[],r=function(){var n=new $.Deferred;return Wishlist.isProductInWishlist(t.model.get("id"),function(i){t.model.set({isInWishlist:i});n.resolve()}),n.promise()},u=function(){var n=new $.Deferred;return Wishlist.productIsInMembersJewellery(t.model.get("id"),function(i){t.model.set({isInMembersJewellery:i});n.resolve()}),n.promise()};i.push(r());i.push(u());$.when.apply($,i).done(function(){n()})},_userStateChanged:function(){var n=this;User.Authenticated&&n.$(".loggedInFalse").fadeOut(n.options.effectDuration,$.proxy(function(){var t=$.proxy(function(){n._configureWishlistButtons();n._configureMembersJewelleryButtons();n.$(".loggedInTrue").show()},n);n._updateWishlistStatus(t)},n))},_getProductType:function(n){var t=parseInt(n.rawData["@cat"],10),i=parseInt(n.rawData["@subcat"],10),r=parseInt(n.rawData["@subcol"],10);return t===this.productTypes.WATCH.category&&i===this.productTypes.WATCH.subCategory?this.productTypes.WATCH:t===this.productTypes.STRAP.category&&i===this.productTypes.STRAP.subCategory?this.productTypes.STRAP:t===this.productTypes.BEZEL.category&&i===this.productTypes.BEZEL.subCategory?this.productTypes.BEZEL:t===this.productTypes.NECKLACEWITHSTORY.category&&r===this.productTypes.NECKLACEWITHSTORY.subCollection?this.productTypes.NECKLACEWITHSTORY:void 0},_relatedFilterClick:function(n){var i,t,r;n.preventDefault();t=$(n.target).closest(".filter-button");i=parseInt(t.data("value"),10);r=t.data("collection");t.closest(".related-item-wrapper").find(".filter-button").removeClass("active");t.addClass("active");this._showRelatedGroup(i,r)},_showRelatedGroup:function(n,t){var i,f,h,e,c,r,o,u,s;e=parseInt(this.$(".related-item-wrapper .scroll-panel").data("page-size"));c=this.model.get("product");r=this._getProductType(c);t===undefined?i=this.model.get("sameStyle"):t==="goesWellWith"&&r!==this.productTypes.WATCH&&r!==this.productTypes.BEZEL&&r!==this.productTypes.STRAP?i=_.filter(this.model.get(t),function(n){var t=parseInt(n["@subcat"],10);return t<101||t>103}):n===null||isNaN(n)?i=$.Enumerable.From(this.model.get(t)).ToArray():(o=$.Enumerable.From(this.model.get(t)).FirstOrDefault(null,function(t){return parseInt(t.groupvalue,10)===n}),i=o==null?[]:o.ToArray());this.$(".related-item-wrapper .scroll-wrapper ul").html(this._templates.relatedProducts({imageurl:this.model.get("imageurl"),items:i}));f=this.$(".related-item-wrapper .scroll-wrapper li.item").outerWidth(!0);h=i.length>e?f*e:i.length*f;u=this.$(".related-item-wrapper .scroll-wrapper");s=0;u.scrollWrap({scrollValue:h,maxNumberOfSlides:10,animationDoneCallback:function(n){n!=s&&(s=n,window.PANDORA.Tracking.Netminers.trackPageView("Product recommender/Page {0}".format(n+1)))}});u.find("img.lazy").pandoraLazyload({container:u});$("body").hasClass("righttoleft")||this.$(".related-item-wrapper .scroll-panel").css("left","0")}});
/*

*/
(function ($)
{
    $.fn.MagicZoom = function (options)
    {
        this.each(function ()
        {
            $(this).load(function ()
            {
                var opts;
                eval('var a = {' + $(this).attr('rel') + '}');
                opts = $.extend({}, $.fn.MagicZoom.defaults, options);
                opts = $.extend({}, opts, a);
                $(this).data('zoom', new MagicZoom($(this), opts));
            });

        });
        return this;
    };

    $.fn.MagicZoom.defaults =
	{
	    ZoomImageSrc: '',
	    lensOpacity: 0.5,
	    smoothMove: 3,
	    cursorHeight: 170,
	    cursorWidth: 170
	};


    function MagicZoom(img, opts)
    {
        var sImg = $(img);
        var zoomImage = null;
        var zoomImageLoaded = false;
        var $mouseTrap = null;
        var cursor = null;
        var controlTimer = 0;
        var mx, my;
        var ctx = this;
        var zw;

        // Removes cursor, blur layer etc.
        this.removeCursor = function ()
        {
            if (cursor)
            {
                cursor.remove();
                cursor = null;
            }
        };

        this.destroy = function ()
        {
            sImg.data('zoom', null);

            if ($mouseTrap)
            {
                $mouseTrap.unbind();
                $mouseTrap.remove();
                $mouseTrap = null;
            }
            this.removeCursor();
        };


        this.controlLoop = function ()
        {
            var offsetx = (mx - sImg.offset().left) >> 0;
            var offsety = (my - sImg.offset().top) >> 0;
            var x = offsetx - (opts.cursorWidth * 0.5);
            var y = offsety - (opts.cursorHeight * 0.5);

            if (x < 0)
                x = 0;
            else if (x > (sImg.outerWidth() - opts.cursorWidth))
                x = (sImg.outerWidth() - opts.cursorWidth);
            if (y < 0)
                y = 0;
            else if (y > (sImg.outerHeight() - opts.cursorHeight))
                y = (sImg.outerHeight() - opts.cursorHeight);

            if (cursor == null)
            {
                cursor = ctx.createCursor(sImg.parent()).show();
            }

            cursor.css({ left: x, top: y });

            // calculate background position
            var bgX = x;
            var bgY = y;
            if (zoomImageLoaded)
            {
                bgX = (offsetx * zoomImage.width / sImg.outerWidth() - (opts.cursorWidth * 0.5)) >> 0;
                bgY = (offsety * zoomImage.height / sImg.outerHeight() - (opts.cursorHeight * 0.5)) >> 0;
            }
            cursor.css('background-position', (-bgX) + 'px ' + (-bgY) + 'px');

            controlTimer = setTimeout(function () { ctx.controlLoop(); }, 30);
        };

        this.createImage = function (imgSrc, callback)
        {
            img = new Image();
            $(img).load(callback);
            img.src = imgSrc;

            return img;
        };

        this.createCursor = function (container)
        {
            var lens = $("<div class='zoom-magic-lens' />")
						.css({ 'width': opts.cursorWidth + 'px', 'height': opts.cursorHeight + 'px' });
            if (zoomImageLoaded)
            {
                lens.css({ 'background-image': "url('" + zoomImage.src + "')" });
            }
            else
            {
                zoomImage = this.createImage(opts.ZoomImageSrc, function () { zoomImageLoaded = true; ctx.removeCursor(); });
                lens.css({ 'opacity': opts.lensOpacity })
                .append($('<img src="//www.pandora.net/design/consumer/images/ajax-loader.gif"/>')
                            .css(
                            {
                                position: 'absolute',
                                width: '15px',
                                height: '15px',
                                left: ((opts.cursorWidth * 0.5) - 8) >> 0,
                                top: ((opts.cursorHeight * 0.5) - 8) >> 0
                            })
                );

            }

            container.append(lens);
            // return cursor
            return lens;
        }

        /* Init function start.  */
        this.Init = function ()
        {
            $mouseTrap = sImg
				.parent()
				.append(
					$('<div class="mousetrap" style="z-index:999;position:absolute;" />')
						//.css('background-image', 'url(".")')
						.css('width', sImg.outerWidth() + 'px')
						.css('height', sImg.outerHeight() + 'px')
						.css('left', '0px')
						.css('top', '0px')
				)
				.find(':last');

            $mouseTrap
				.bind('mousemove', this, function (event)
				{
				    mx = event.pageX;
				    my = event.pageY;
				})
				.bind('mouseleave', this, function (event)
				{
				    clearTimeout(controlTimer);
				    ctx.removeCursor();

				    return false;
				})
				.bind('mouseenter', this, function (event)
				{
				    var container = sImg.parent();
				    mx = event.pageX;
				    my = event.pageY;
				    zw = event.data;

				    ctx.removeCursor();
				    cursor = ctx.createCursor(container);
				    cursor.fadeIn(0);

				    $mouseTrap.css('cursor', cursor.css('cursor'));

				    // Start processing. 
				    zw.controlLoop();

				    // Don't return false here otherwise opera will not detect change of the mouse pointer type.
				    return;
				})
                .css('background-color', 'white')
                .fadeTo('fast', 0.0001);
        };

        ctx.Init();
    }


})(jQuery);;
/*! http://mths.be/placeholder v2.0.7 by @mathias */
var SendHintApp,SimpleMathApp;(function(n,t,i){function l(n){var t={},r=/^jQuery\d+$/;return i.each(n.attributes,function(n,i){i.specified&&!r.test(i.name)&&(t[i.name]=i.value)}),t}function f(n,r){var f=this,u=i(f);if(f.value==u.attr("placeholder")&&u.hasClass("placeholder"))if(u.data("placeholder-password")){if(u=u.hide().next().show().attr("id",u.removeAttr("id").data("placeholder-id")),n===!0)return u[0].value=r;u.focus()}else f.value="",u.removeClass("placeholder"),f==t.activeElement&&f.select()}function s(){var t,r=this,n=i(r),e=n,u=this.id;if(r.value==""){if(r.type=="password"){if(!n.data("placeholder-textinput")){try{t=n.clone().attr({type:"text"})}catch(o){t=i("<input>").attr(i.extend(l(this),{type:"text"}))}t.removeAttr("name").data({"placeholder-password":!0,"placeholder-id":u}).bind("focus.placeholder",f);n.data({"placeholder-textinput":t,"placeholder-id":u}).before(t)}n=n.removeAttr("id").hide().prev().attr("id",u).show()}n.addClass("placeholder");n[0].value=n.attr("placeholder")}else n.removeClass("placeholder")}var u="placeholder"in t.createElement("input"),e="placeholder"in t.createElement("textarea"),h=i.fn,c=i.valHooks,o,r;u&&e?(r=h.placeholder=function(){return this},r.input=r.textarea=!0):(r=h.placeholder=function(){var n=this;return n.filter((u?"textarea":":input")+"[placeholder]").not(".placeholder").bind({"focus.placeholder":f,"blur.placeholder":s}).data("placeholder-enabled",!0).trigger("blur.placeholder"),n},r.input=u,r.textarea=e,o={get:function(n){var t=i(n);return t.data("placeholder-enabled")&&t.hasClass("placeholder")?"":n.value},set:function(n,r){var u=i(n);return u.data("placeholder-enabled")?(r==""?(n.value=r,n!=t.activeElement&&s.call(n)):u.hasClass("placeholder")?f.call(n,!0,r)||(n.value=r):n.value=r,u):n.value=r}},u||(c.input=o),e||(c.textarea=o),i(function(){i(t).delegate("form","submit.placeholder",function(){var n=i(".placeholder",this).each(f);setTimeout(function(){n.each(s)},10)})}),i(n).bind("beforeunload.placeholder",function(){i(".placeholder").each(function(){this.value=""})}))})(this,document,jQuery);SendHintApp={};SendHintApp.SendHintAppView=Backbone.View.extend({initialize:function(){this.product=this.options.product;this.currency=this.options.currency;this.options.trackingRoot&&(this.options.trackingRoot=this.options.trackingRoot.replace("/"," > "));var n={trackingRoot:" > Explore > Campaigns > Gift hint",shareUrl:window.location.href,sendHintServiceUrl:"/services/social/sendhint/sendhintservice.svc/SendHint"};this.options=$.extend(n,this.options);this.render()},events:{"click #CloseDialogMenuButton":"closeDialogMenuButton_OnClick"},render:function(){var n=window._.template($("#SendHintAppViewTemplate").html());$(this.el).html(n);this.theDialog=$(this.el).dialog({modal:!0,resizable:!1,title:"Send a hint",show:{effect:"fade",speed:400},hide:{effect:"fade",speed:400},draggable:!1,width:"790px",height:"auto",position:"center",open:function(n){$(n.target).parent().first().first().find(".ui-dialog-titlebar").remove()},close:this.dialog_OnClose});this.gotoStep2()},dialog_OnClose:function(){$(this).parent().empty();$(this).remove()},closeDialogMenuButton_OnClick:function(n){var t=this;n.preventDefault();this.sendHintStep3View?document.netminersPush(function(n){var i=window.NetminersTracker.GetStandardBreadcrumbs(n);return i+t.options.trackingRoot+" > 01 Start > 02 Yes Give a hint > 03 Gift hint sent > 04 Return to Christmas Collection"}):this.sendHintStep2View?document.netminersPush(function(n){var i=window.NetminersTracker.GetStandardBreadcrumbs(n);return i+t.options.trackingRoot+" > 01 Start > 02 Yes Give a hint > 03 Cancel"}):document.netminersPush(function(n){var i=window.NetminersTracker.GetStandardBreadcrumbs(n);return i+t.options.trackingRoot+" > 01 Start > 02 Cancel"});this.close()},gotoStep2:function(){var n=this;n.sendHintStep2View=new SendHintApp.SendHintStep2View({el:$(n.el).find("#SendHintAppContainer"),product:n.product,currency:n.currency,model:new SendHintApp.SendHintModel,serviceUrl:n.options.serviceUrl,shareUrl:n.options.shareUrl,trackingRoot:n.options.trackingRoot});n.sendHintStep2View.model.setUrlRoot(n.options.sendHintServiceUrl);n.sendHintStep2View.render();n.sendHintStep2View.on("CancelClicked",n.close,n);if(this.options.showStep3==!1)n.sendHintStep2View.on("OkClicked",n.close,n);else n.sendHintStep2View.on("OkClicked",n.gotoStep3,n);$(n.sendHintStep2View.el).show();$(n.el).dialog("option","position","center");$(n.theDialog).parent().fadeIn(400)},gotoStep3:function(n){var t=this,i=n.getRecieverName();$(this.theDialog).parent().fadeOut(200,function(){n.close();t.sendHintStep3View=new SendHintApp.SendHintStep3View({el:$(t.el).find("#SendHintAppContainer"),product:t.product,recieverName:i,trackingRoot:t.options.trackingRoot});t.sendHintStep3View.render();t.sendHintStep3View.on("OkClicked",t.close,t);$(t.sendHintStep2View.el).show();$(t.el).dialog("option","position","center");$(t.el).dialog("option","width","631px");$(t.theDialog).parent().fadeIn(400)})},close:function(){_(this.childViews).each(function(n){n.close()});this.undelegateEvents();$(this.theDialog).dialog("close")}});String.prototype.format=function(){for(var i,t=this,n=0;n<arguments.length;n++)i=new RegExp("\\{"+n+"\\}","gm"),t=t.replace(i,arguments[n]);return t};String.prototype.escapeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};SendHintApp.SendHintStep1View=Backbone.View.extend({initialize:function(){this.product=this.options.product;this.options=$.extend({trackingRoot:" > Explore > Campaigns > Gift hint"},this.options)},render:function(){var n="//static.pandora.net/consumer/jewellery/"+this.product["@col"]+"/290x290/"+this.product["@id"]+".jpg",t={data:{imageUrl:n}};this.template=_.template($("#SendHintStep1Template").html());$(this.el).html(this.template(t))},events:{"click #SendHintStep1OkButton":"okClicked","click #SendHintStep1CancelButton":"cancelClicked"},okClicked:function(){var n=this;document.netminersPush(function(t){var i=window.NetminersTracker.GetStandardBreadcrumbs(t);return i+n.options.trackingRoot+" > 01 Start> 02 Yes Give a hint"});this.trigger("OkClicked",this)},cancelClicked:function(){var n=this;document.netminersPush(function(t){var i=window.NetminersTracker.GetStandardBreadcrumbs(t);return i+n.options.trackingRoot+" > 01 Start> 02 Cancel"});this.trigger("CancelClicked",this)},close:function(){_(this.childViews).each(function(n){n.close()});$(this.el).empty();this.undelegateEvents()}});SendHintApp.SendHintStep2View=Backbone.View.extend({initialize:function(){this.product=this.options.product;this.currency=this.options.currency;this.emailHeaderFormatString="";this.model.set({itemNumberId:this.product["@id"]});this.options.serviceUrl&&this.options.serviceUrl!=""&&(this.model.urlRoot=this.options.serviceUrl);this.options=$.extend({trackingRoot:" > Explore > Campaigns > Gift hint"},this.options);this.model.on("change:message",this.formatMessage,this)},events:{"click #SendHintStep2OkButton":"okClicked","click #SendHintStep2CancelButton":"cancelClicked","keyup #recieverName:input":"inputfieldRecieverName_OnKeyUp","blur #recieverName:input":"inputfieldRecieverName_OnBlur","blur #recieverEmail:input":"inputfieldRecieverEmail_OnBlur","keyup #senderName:input":"inputfieldSenderName_OnKeyUp","blur #senderName:input":"inputfieldSenderName_OnBlur","blur #senderEmail:input":"inputfieldSenderEmail_OnBlur","focus #message:input":"inputfieldMessage_OnFocus","blur #message:input":"inputfieldMessage_OnBlur","keyup #message:input":"inputfieldMessage_OnKeyUp"},inputfieldRecieverName_OnKeyUp:function(){this.formatEmailHeader()},inputfieldMessage_OnKeyUp:function(){this.model.set("message",this.$el.find("#message").val())},inputfieldSenderName_OnKeyUp:function(){this.formatEmailHeader();this.formatEmailSignatureName()},inputfieldRecieverName_OnBlur:function(){this.model.set({recieverName:this.$el.find("#recieverName").val()});this.renderValidation("recieverName")},inputfieldSenderName_OnBlur:function(){this.model.set({senderName:this.$el.find("#senderName").val()});this.renderValidation("senderName")},inputfieldRecieverEmail_OnBlur:function(){this.model.set({recieverEmail:this.$el.find("#recieverEmail").val()});this.renderValidation("recieverEmail")},inputfieldSenderEmail_OnBlur:function(){this.model.set({senderEmail:this.$el.find("#senderEmail").val()});this.renderValidation("senderEmail")},inputfieldMessage_OnFocus:function(){var n=this.$el.find("#message").val();n==""&&this.$el.find("#message").attr("placeholder","");this.model.set({message:n})},inputfieldMessage_OnBlur:function(){var n=this.$el.find("#message").val();n.length==0&&(n=this.$el.find("#message").data("original-placeholder"),this.$el.find("#message").attr("placeholder",n));this.model.set({message:n})},okClicked:function(n){if(!this.$el.find("#SendHintStep2OkButton").hasClass("anchor-disabled"))if(this.model.isValid()){var t=this;this.model.get("message")||this.model.set({message:this.$el.find("#message").attr("placeholder")});this.$el.find("#SendHintStep2OkButton").addClass("anchor-disabled");window.Pandora.User.Authenticated==0?this.model.set({shareUrl:t.options.shareUrl+"&name="+t.model.get("senderName")}):this.model.set({shareUrl:t.options.shareUrl});this.model.save({},{success:function(){if(t.model.get("SimpleMathSuccess")==!0)if(document.netminersPush(function(n){var i=window.NetminersTracker.GetStandardBreadcrumbs(n);return i+t.options.trackingRoot+" > 01 Start> 02 Yes Give a hint > 03 Gift hint sent"}),t.isFlashAvailable()==!0){t.renderFlashAnimation();var i=setTimeout(function(){clearTimeout(i);t.trigger("OkClicked",t);n.preventDefault()},3e3)}else t.trigger("OkClicked",t),n.preventDefault();else t.simpleMathView.invalidateAnswer(),t.model.set({simpleMathResult:null}),t.$el.find("#SendHintStep2OkButton").removeClass("anchor-disabled")}})}else this.renderValidation()},isFlashAvailable:function(){var n=swfobject.getFlashPlayerVersion();return n.major!=0},renderValidation:function(n){n&&n!="senderName"||(this.model.isValid("senderName")?this.$el.find("#senderName").removeClass("invalid"):this.$el.find("#senderName").addClass("invalid"));n&&n!="senderEmail"||(this.model.isValid("senderEmail")?this.$el.find("#senderEmail").removeClass("invalid"):this.$el.find("#senderEmail").addClass("invalid"));n&&n!="recieverEmail"||(this.model.isValid("recieverEmail")?this.$el.find("#recieverEmail").removeClass("invalid"):this.$el.find("#recieverEmail").addClass("invalid"));n&&n!="recieverName"||(this.model.isValid("recieverName")?this.$el.find("#recieverName").removeClass("invalid"):this.$el.find("#recieverName").addClass("invalid"));n&&n!="simpleMath"||this.simpleMathView.validateField()},cancelClicked:function(){var n=this;document.netminersPush(function(t){var i=window.NetminersTracker.GetStandardBreadcrumbs(t);return i+n.options.trackingRoot+" > 01 Start > 02 Yes Give a hint > 03 Cancel"});this.trigger("CancelClicked",this)},render:function(){var i=window._.template($("#SendHintStep2Template").html()),n,t;this.$el.html(i);this.simpleMathView=new SimpleMathApp.SimpleMathView({el:$("#SimpleMathContainer"),model:new SimpleMathApp.SimpleMathModel});this.simpleMathView.on("simpleMathAnswerChanged",this.updateSimpleMathAnswer,this);this.emailHeaderFormatString==""&&(this.emailHeaderFormatString=this.$el.find("#Step2EmailHeader").html());n=typeof this.product.rawData=="undefined"?this.product["@col"]:this.product.rawData["@col"];t="//static.pandora.net/consumer/jewellery/"+n+"/135x135/"+this.product["@id"]+".jpg";$(this.el).find("#Step2EmailProductInfoContainer").css("background-image","url('"+t+"')");$(this.el).find("#StepEmailProductName").html(this.product["@name"]);this.product["@state"]!="discontinued"&&this.product["@price"]!="0"&&this.$el.find("#StepEmailProductPrice").html(this.formatPrice(this.product["@price"]));this.model.set({message:this.$el.find("#message").val()});this.formatEmailHeader();this.formatEmailSignatureName()},renderFlashAnimation:function(){var n=this.$el.find("#SendHintStep2Container").attr("data-flashanimationurl");this.flashAnimationObject=swfobject.embedSWF(n,"SendHintStep2EmailPreviewFlash","393","100%","10.2",null,{},{allowfullscreen:"false",allowScriptAccess:"always",scale:"exactFit",quality:"high",wmode:"transparent",play:"true",loop:"false"})},updateSimpleMathAnswer:function(n){return n.UserResult==""?(this.simpleMathView.invalidateField(),!1):(this.model.set({simpleMathResult:n}),!0)},close:function(){_(this.childViews).each(function(n){n.close()});this.$el.empty();this.undelegateEvents()},formatPrice:function(n){return window.Utils.isNullOrEmpty(n)||n==0?"":n},formatEmailHeader:function(){var n=this.$el.find("#senderName").val().escapeHTML(),t=this.$el.find("#recieverName").val().escapeHTML(),i;n=n!=""?n:this.$el.find("#senderNameLabel").html();t=t!=""?t:this.$el.find("#recieverNameLabel").html();i=this.emailHeaderFormatString.format(t,n);this.$el.find("#Step2EmailHeader").html(i)},formatEmailSignatureName:function(){var n=this.$el.find("#senderName").val();n=n!=""?n:this.$el.find("#senderNameLabel").html().escapeHTML();this.$el.find("#Step2EmailSignatureName").html(n)},formatMessage:function(){this.$el.find("#Step2EmailBody").html(this.model.get("message").escapeHTML().replace(/\n\r?/g,"<br />"))},getRecieverName:function(){return this.model.get("recieverName")}});SendHintApp.SendHintStep3View=Backbone.View.extend({initialize:function(){this.product=this.options.product;this.recieverName=this.options.recieverName;this.options=$.extend({trackingRoot:" > Explore > Campaigns > Gift hint"},this.options)},render:function(){var t=typeof this.product.rawData=="undefined"?this.product["@col"]:this.product.rawData["@col"],i="//static.pandora.net/consumer/jewellery/"+t+"/236x190/"+this.product["@id"]+".jpg",r={data:{imageUrl:i}},n;this.template=_.template($("#SendHintStep3Template").html());$(this.el).html(this.template(r));n=$(this.el).find("#SendHintStep3Body").html();$(this.el).find("#SendHintStep3Body").html(n.format(this.recieverName))},events:{"click #SendHintStep3OkButton":"okClicked"},okClicked:function(){var n=this;document.netminersPush(function(t){var i=window.NetminersTracker.GetStandardBreadcrumbs(t);return i+n.options.trackingRoot+" > 01 Start> 02 Yes Give a hint > 03 Gift hint sent > 04 Return to Christmas Collection"});this.trigger("OkClicked",this)},close:function(){_(this.childViews).each(function(n){n.close()});$(this.el).empty();this.undelegateEvents()}});SimpleMathApp={};SimpleMathApp.SimpleMathView=Backbone.View.extend({initialize:function(){this.model.on("change:Id",this.simplemathModel_OnChange,this);this.getNewQuestion()},render:function(){this.template=_.template($("#SimpleMathTemplate").html());$(this.el).html(this.template(this.model.toJSON()));this.isValid==!1&&this.validateField()},events:{"click #SimpleMathGetNewQuestion":"getNewQuestion","blur #simpleMathAnswer:input":"inputfieldsimpleMathAnswer_OnBlur"},inputfieldsimpleMathAnswer_OnBlur:function(){var n={Id:this.model.get("Id"),Question:this.model.get("Question"),UserResult:$(this.el).find("#simpleMathAnswer").val(),OperationState:!1};this.trigger("simpleMathAnswerChanged",n);this.validateField()},invalidateAnswer:function(){this.isValid=!1;this.getNewQuestion()},invalidateField:function(n){n==!0?$(this.el).find("#simpleMathAnswer").addClass("invalid"):$(this.el).find("#simpleMathAnswer").removeClass("invalid")},validateField:function(){return $(this.el).find("#simpleMathAnswer").val()==""?(this.isValid=!1,this.invalidateField(!0),!1):(this.isValid=!0,this.invalidateField(!1),!0)},getNewQuestion:function(n,t){n&&n.preventDefault();this.model.fetch({cache:!1},{success:function(){t&&t()}})},simplemathModel_OnChange:function(){this.render()},close:function(){_(this.childViews).each(function(n){n.close()});$(this.el).empty();this.model.off("change:Id",this.render,this);this.undelegateEvents()}});SimpleMathApp.SimpleMathModel=Backbone.Model.extend({defaults:{Id:"1",Question:"",UserResult:"",OperationState:!1},urlRoot:"/services/authentication/authenticationservice.svc/getsimplemath"});SendHintApp.LoggingEnabled=!0;SendHintApp.SendHintModel=Backbone.Model.extend({defaults:{senderName:"",senderEmail:"",recieverName:"",recieverEmail:"",itemNumberId:"",success:!1,message:"",SimpleMathSuccess:!1,simpleMathResult:null,shareUrl:""},isValid:function(n){var i=this,t=!0;return n?n.indexOf("Name")>-1?this.attributes[n]==""&&(t=!1):n.indexOf("Email")>-1&&(i.isEmail(this.attributes[n])||(t=!1)):($.each(i.attributes,function(n,r){n.indexOf("Name")>-1?r==""&&(t=!1):n.indexOf("Email")>-1&&(i.isEmail(r)||(t=!1))}),this.attributes.simpleMathResult||(t=!1)),t},isEmail:function(n){var t=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);return t.test(n)},setUrlRoot:function(n){this.urlRoot=n},urlRoot:"/services/social/sendhint/sendhintservice.svc/SendHint"})