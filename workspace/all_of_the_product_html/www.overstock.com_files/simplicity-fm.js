os.Simplicity.FarmersMarket=function(a){var b={$addToCartForm:jQuery("#addToCartForm"),fmZipInputButtonSelector:"#fmZipInputButton",fmZipInputButtonTextSelector:".fmZipInputButtonText",fmZipInputSelector:"#fmZipInput",fmZipInteractionSelector:".fm-zip-interaction",fmMainRightSelector:"#mainRight_farmersMarket",fmZipErrorSelector:"#mainRight_farmersMarket .fm-error",fmZipMessageSelector:"#mainRight_farmersMarket .fm-message",monthNames:["Jan.","Feb.","Mar.","Apr.","May","June","July","Aug.","Sept.","Oct.","Nov.","Dec."],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],qtySelector:"#addqty"+os.Simplicity.productId,optionSelector:"[name=addid"+os.Simplicity.productId+"]",optionDropdownSelector:"#addid"+os.Simplicity.productId,estDelLinkSelector:"#mainRight_wishListSaveLater .fm-mainRight-delivery",estDelDateSelector:"#est-delivery-estimate-link",estDelLBSelector:"#fm-est-delivery-lightbox-container",estDelFormSelector:".est-delivery-form",estDelResultsSelector:".est-delivery-results",estDelTableOptionsSelector:"#delivery-options-list",estDelZipSpanSelector:".est-delivery-zip",estDelEfErrorSelector:".ef-error",estDelEfErrorInnerSelector:".ef-error-inner",zipSubmitFrom:"",IE10canSubmit:!1};return{init:function(c){var d=this;jQuery.extend(b,c),a(b.optionDropdownSelector).length>0&&a(b.optionDropdownSelector+' option[value="'+os.Simplicity.fmDeliveryInfo.productOptionId+'"]').prop("selected",!0);var e=[];_.each(os.Simplicity.fmDeliveryInfo.errors,function(a){e.push(a.type)}),os.Simplicity.fmDeliveryInfo.errors=e,jQuery('<div class="shop-addCart-hide">&nbsp;</div>').appendTo("#mainRight_addCartWrap"),d.buildFmZipArea("page_load"),d.buildDelEstLink("page_load"),d.buildDelEstLb("page_load"),d.setupHandlers(),d.bindFmToolTip()},returnExactDate:function(a){var c=a.exactDate.split("T")[0],d=c.split("-"),e=new Date(d[0],d[1]-1,d[2]),f=b.dayNames[e.getUTCDay()],g=b.monthNames[e.getUTCMonth()],h=e.getDate();return f+", "+g+" "+h},setupHandlers:function(){var c=this;a(document).on("keypress",function(c){45==c.which?a(b.fmZipInputSelector).focus():43==c.which&&a("input[name=zip_code]").focus()});var d="click";os.isTouchDevice&&(d="touchstart"),b.$addToCartForm.on("click touchstart",b.fmZipInputButtonSelector,function(d){d.preventDefault(),b.zipSubmitFrom="fm",c.handleZipSubmit(a(b.fmZipInputSelector))}),b.$addToCartForm.on("keypress",b.fmZipInputSelector,function(d){13==d.keyCode&&(d.preventDefault(),b.zipSubmitFrom="fm",c.handleZipSubmit(a(this)))}),b.$addToCartForm.on("keyup",b.fmZipInputSelector,function(b){c.zipValidate(c,a(this),b)}),a("input[name=zip_code]").on("keypress",function(d){13==d.keyCode&&(d.preventDefault(),b.zipSubmitFrom=a(this).closest("#prodShipTab").length>0?"stab":"lb",c.handleZipSubmit(a(this)))}),a("input[name=zip_code]").on("keyup",function(b){c.zipValidate(c,a(this),b)}),a(".est-delivery-go-trigger").on("click",function(){b.zipSubmitFrom=a(this).closest("#prodShipTab").length>0?"stab":"lb",c.handleZipSubmit(a("input[name=zip_code]"))}),a(".auto-clear-field").on("focus click touchstart",function(){jQuery(this).val(""),jQuery(this).hasClass("ef-fieldError")&&jQuery(this).prev().hide()}),a(".auto-clear-field").on("blur",function(){""==jQuery(this).val()&&jQuery(this).val("Enter Zip"),jQuery(this).is(":visible")&&a(b.estDelEfErrorSelector).hide()}),a(".est-delivery-lightbox-trigger").bindColorbox({inline:"true",title:'<i id="est-delivery-lightbox-icon"></i>Estimated Delivery Date',width:532,scrolling:!1,onComplete:function(){c.clearDelEstErrors(),a.colorbox.resize()},onClosed:function(){a(b.estDelEfErrorSelector).hide(),a("input[name=zip_code]").val("Enter Zip")}}),a("#addid"+os.Simplicity.fmDeliveryInfo.productId).on("change",function(){function d(){var a="/api2/products/options/"+g+"/deliveryestimates?zipCode="+currentZip+"&qty="+f;c.doAjax(a,c.handleProdOptChangeSuccess,c.handleProdOptChangeError)}var e=jQuery(b.fmZipErrorSelector),f=jQuery(b.qtySelector).val(),g=a(this).val();currentZip=os.Simplicity.fmDeliveryInfo.zipCode||"",e.hide(),d()}),document.getElementById("fmZipInput").setSelectionRange&&a(b.fmZipInputSelector).on("click",function(){document.getElementById("fmZipInput").setSelectionRange(0,document.getElementById("fmZipInput").value.length)}),a.browser&&a.browser.msie&&"10.0"==a.browser.version&&b.$addToCartForm.on("click","#addCartMain_addCartButton",function(){if(b.IE10canSubmit)if(a(b.optionDropdownSelector).length){var c=toggleErrorDisplay(b.optionDropdownSelector.replace("#",""),"option_message");c&&b.$addToCartForm.submit()}else b.$addToCartForm.submit()})},doAjax:function(b,c,d){var e=this;a.ajax({url:b,type:"GET",dataType:"json"}).success(function(a){c(a,e)}).error(function(a){d(a,e)})},sendTrackingRequest:function(a){_.isEmpty(a)||s.tl(!0,"o","FM Delivery Tracking",a)},zipValidate:function(a,b){var c=b.val(),d=/^\d+$/;d.test(c)||(b.val(b.val().replace(/[^\d]/g,"")),a.enforceMaxlengthOnTextInput(b))},enforceMaxlengthOnTextInput:function(a){var b=a.val(),c=a.attr("maxlength");if(b.length>c){b=b.slice(0,c),a.val(b);var d=a.createTextRange();d.collapse(!1),d.select()}},handleProdOptChangeSuccess:function(a,b){os.Simplicity.fmDeliveryInfo=a;var c=[];_.each(os.Simplicity.fmDeliveryInfo.errors,function(a){c.push(a.type)}),os.Simplicity.fmDeliveryInfo.errors=c,b.buildFmZipArea("option_change"),b.buildDelEstLink("option_change"),b.buildDelEstLb("option_change")},handleProdOptChangeError:function(a){console.log("handleProdOptChangeError:",a)},handleZipSubmit:function(c){function d(){var a=jQuery(b.optionSelector).val()||jQuery(b.optionDropdownSelector).val()||os.Simplicity.fmDeliveryInfo.productOptionId,c="/api2/products/options/"+a+"/deliveryestimates?zipCode="+f+"&qty="+i;e.doAjax(c,e.handleZipSuccess,e.handleZipError)}var e=this,f=c.val()||parseInt(a("input[name=zip_code]").eq(0).val())||parseInt(a("input[name=zip_code]").eq(1).val()),g=/(^\d{5}$)/.test(f),h=jQuery(b.fmZipErrorSelector),i=jQuery(b.qtySelector).val();return"fm"==b.zipSubmitFrom?a(b.fmZipInteractionSelector).addClass("loading fm-zip-disabled"):("lb"==b.zipSubmitFrom||"stab"==b.zipSubmitFrom)&&(a(b.estDelLBSelector).addClass("loading"),e.clearDelEstErrors()),g?(h.hide(),void d()):void setTimeout(function(){e.handleInvalidZip(e,"Invalid zip code")},200)},handleZipSuccess:function(c,d){os.Simplicity.fmDeliveryInfo=c;var e=[];_.each(os.Simplicity.fmDeliveryInfo.errors,function(a){e.push(a.type)}),os.Simplicity.fmDeliveryInfo.errors=e,d.buildFmZipArea("zip_change"),d.buildDelEstLink("zip_change"),d.buildDelEstLb("zip_change"),"fm"==b.zipSubmitFrom?a(b.fmZipInteractionSelector).removeClass("loading fm-zip-disabled"):("lb"==b.zipSubmitFrom||"stab"==b.zipSubmitFrom)&&a(b.estDelLBSelector).removeClass("loading")},handleZipError:function(a,b){var c=JSON.parse(a.responseText);400==c.httpStatusCode?b.handleInvalidZip(b,"Invalid zip code"):b.handleInvalidZip(b,"Service currently unavailable")},handleInvalidZip:function(c,d){if("fm"==b.zipSubmitFrom)a(b.fmZipInteractionSelector).removeClass("loading fm-zip-disabled"),a(b.fmZipErrorSelector).text(d).show(),c.setFmMessage("unknown_zip","zip_change"),c.disableAtcInputs(),a("#mainRight_addCartWrap").show(),a(b.estDelLinkSelector).hide(),a(b.fmZipInputSelector).css("border-color","#f00");else{if("lb"==b.zipSubmitFrom){var e={};e.linkTrackVars="eVar4",e.eVar4="PP:DelivEstLB:Zip:Invalid",os.Simplicity.fmDeliveryInfo.isZipRestricted&&(e.linkTrackVars+=",eVar68",e.eVar68="Product Page:Farmers Zip Restriction"),c.sendTrackingRequest(e)}else if("stab"==b.zipSubmitFrom){var e={};e.linkTrackVars="eVar4",e.eVar4="PP:DelivEstTab:Zip:Invalid",os.Simplicity.fmDeliveryInfo.isZipRestricted&&(e.linkTrackVars+=",eVar68",e.eVar68="Product Page:Farmers Zip Restriction"),c.sendTrackingRequest(e)}a(b.estDelLBSelector).removeClass("loading"),a(b.estDelEfErrorInnerSelector).html('<span class="unr-zip">'+d+"</span>"),a(b.estDelEfErrorSelector).show(),jQuery.colorbox.resize()}},bindFmToolTip:function(){os.ToolTips(".fm-message-tt",{offset:{x:-134,y:4},hideTimer:1e4,toolTipContent:function(){return'<div class="tooltip">This is a perishable product that can only be delivered to certain areas. This ensures that the item maintains its freshness while in transit.<div class="tooltip-arrow-shadow"></div><div class="tooltip-arrow"></div></div>'}})},disableAtcInputs:function(){b.IE10canSubmit=!1,a("#addToCartForm").addClass("fm-atc-disabled"),document.getElementById("addCartMain_addCartButton").setAttribute("disabled","disabled");var c=document.getElementById(b.qtySelector.replace("#",""));c&&c.setAttribute("disabled","disabled");var d=document.getElementById(b.optionDropdownSelector.replace("#",""));d&&d.setAttribute("disabled","disabled")},enableAtcInputs:function(){b.IE10canSubmit=!0,a("#addToCartForm").removeClass("fm-atc-disabled"),document.getElementById("addCartMain_addCartButton").removeAttribute("disabled");var c=document.getElementById(b.qtySelector.replace("#",""));c&&c.removeAttribute("disabled");var d=document.getElementById(b.optionDropdownSelector.replace("#",""));d&&d.removeAttribute("disabled")},setFmMessage:function(c,d){var e="No message.",f=this;if("unknown_zip"==c){if(e='<span class="fm-message-tt"><span class="fm-message-head">Tell us where you are!</span> <span class="os-icon-info" style="cursor: pointer;"></span></span><br> Enter your zip code to see if this product is available in your area.',"page_load"==d.toLowerCase()?a(b.fmZipInputSelector).css("border-color","#000"):a(b.fmZipInputSelector).css("border-color","#f00"),"page_load"==d){var g={};g.linkTrackVars="events,eVar68",g.linkTrackEvents="event35",g.events="event35",g.eVar68="Product Page:UnkownZip",f.sendTrackingRequest(g)}}else if("success_zip"==c){if(e='<span class="fm-message-head">Good news!</span><br>This item is available for  delivery in your area.',a(b.fmZipInputSelector).css("border-color","#415925"),a("#mainRight_addCartWrap").show(),"zip_change"==d&&"fm"==b.zipSubmitFrom){var g={};g.linkTrackVars="events,eVar68,prop65",g.linkTrackEvents="event36",g.events="event36",g.eVar68="Product Page:DeliveryAvailable",g.prop65=os.Simplicity.fmDeliveryInfo.zipCode,f.sendTrackingRequest(g)}else if("page_load"==d){var g={};g.linkTrackVars="events,eVar68,prop65",g.linkTrackEvents="event35",g.events="event35",g.eVar68="Product Page:DeliveryAvailable",g.prop65=os.Simplicity.fmDeliveryInfo.zipCode,f.sendTrackingRequest(g)}}else if("noship_zip"==c){var h="?";if(os.Simplicity.fmLandingUrl.indexOf("?")>0&&(h="&"),e='<span class="fm-message-head">Sorry!</span><br>This product cannot be delivered to your area.<br><br><div class="fm-continue-shopping"><a href="'+os.Simplicity.fmLandingUrl+h+'TID=PP:Farmers:Continue" class="os-button btn-sm btn-action">Continue Shopping</a></div><br>',a("#mainRight_addCartWrap").hide(),a(b.fmZipInputSelector).css("border-color","#415925"),"zip_change"==d&&"fm"==b.zipSubmitFrom){var g={};g.linkTrackVars="events,eVar68,prop65",g.linkTrackEvents="event36",g.events="event36",g.eVar68="Product Page:DeliveryUnavailable",g.prop65=os.Simplicity.fmDeliveryInfo.zipCode,f.sendTrackingRequest(g)}else if("page_load"==d){var g={};g.linkTrackVars="events,eVar68,prop65",g.linkTrackEvents="event35",g.events="event35",g.eVar68="Product Page:DeliveryUnavailable",g.prop65=os.Simplicity.fmDeliveryInfo.zipCode,f.sendTrackingRequest(g)}}else console.log("Unhandled messageCode in setFmMessage");a(b.fmZipMessageSelector).html(e),f.bindFmToolTip()},buildFmZipArea:function(c){var d=this;os.Simplicity.fmDeliveryInfo.isZipRestricted?(a("#addToWishlist, #addToRegistry").hide(),d.disableAtcInputs(),a(b.fmMainRightSelector).show(),os.Simplicity.fmDeliveryInfo.zipCode?(a(b.fmZipInputSelector).val(os.Simplicity.fmDeliveryInfo.zipCode),a(b.fmZipInputButtonTextSelector).text("Update"),os.Simplicity.fmDeliveryInfo.errors.indexOf("SHIP_TO_ZIP_ERROR")>=0?d.setFmMessage("noship_zip",c):os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&(d.setFmMessage("success_zip",c),d.enableAtcInputs())):(d.setFmMessage("unknown_zip",c),a(b.fmMainRightSelector).show())):d.enableAtcInputs()},buildDelEstLink:function(){var c=this;a(b.estDelLinkSelector).hide(),a(b.estDelDateSelector).html(""),os.Simplicity.fmDeliveryInfo.isZipRestricted?0==os.Simplicity.fmDeliveryInfo.errors.length&&os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&"exact_date"==os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.type.toLowerCase()&&(a(b.estDelLinkSelector).show(),a(b.estDelDateSelector).html("<b>:</b> "+c.returnExactDate(os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate))):os.Simplicity.fmDeliveryInfo.isEstimable&&(a(b.estDelLinkSelector).show(),0==os.Simplicity.fmDeliveryInfo.errors.length&&os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&"exact_date"==os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.type.toLowerCase()&&a(b.estDelDateSelector).html("<b>:</b> "+c.returnExactDate(os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate)))},buildDelEstLb:function(c){var d=this;a(b.estDelLBSelector).hide(),a(b.estDelFormSelector).hide(),a(b.estDelResultsSelector).hide();var e={};if(e.linkTrackVars="eVar4",os.Simplicity.fmDeliveryInfo.isZipRestricted)if(e.linkTrackVars+=",eVar68",0==os.Simplicity.fmDeliveryInfo.errors.length&&os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&"exact_date"==os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.type.toLowerCase()){a(b.estDelLBSelector).show(),a(b.estDelResultsSelector).show(),d.fmDeliveryOptionsDisplay();var f=d.formatTrackingExactDate(os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.exactDate);"zip_change"==c&&("lb"==b.zipSubmitFrom?(e.eVar4="PP:DelivEstLB:Zip:success:"+f,e.eVar68="Product Page:Farmers Zip Restriction",d.sendTrackingRequest(e)):"stab"==b.zipSubmitFrom&&(e.eVar4="PP:DelivEstTab:Zip:success:"+f,e.eVar68="Product Page:Farmers Zip Restriction",d.sendTrackingRequest(e)))}else"zip_change"==c&&("lb"==b.zipSubmitFrom?(e.eVar4="PP:DelivEstLB:NoEst",e.eVar68="Product Page:Farmers Zip Restriction",d.sendTrackingRequest(e)):"stab"==b.zipSubmitFrom&&(e.eVar4="PP:DelivEstTab:Zip:NoEst",e.eVar68="Product Page:Farmers Zip Restriction",d.sendTrackingRequest(e))),a(b.estDelLBSelector).hide(),a(b.estDelFormSelector).show(),a(b.estDelResultsSelector).hide(),a.colorbox.close();else if(os.Simplicity.fmDeliveryInfo.isEstimable)if(a(b.estDelLBSelector).show(),os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&"exact_date"==os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.type.toLowerCase()){a(b.estDelResultsSelector).show(),d.fmDeliveryOptionsDisplay();var f=d.formatTrackingExactDate(os.Simplicity.fmDeliveryInfo.shipOptions[0].deliveryTimeEstimate.exactDate);"zip_change"==c&&("lb"==b.zipSubmitFrom?(e.eVar4="PP:DelivEstLB:Zip:success:"+f,d.sendTrackingRequest(e)):"stab"==b.zipSubmitFrom&&(e.eVar4="PP:DelivEstTab:Zip:success:"+f,d.sendTrackingRequest(e)))}else a(b.estDelFormSelector).show(),"zip_change"==c&&("lb"==b.zipSubmitFrom?(e.eVar4="PP:DelivEstLB:NoEst",d.sendTrackingRequest(e)):"stab"==b.zipSubmitFrom&&(e.eVar4="PP:DelivEstTab:Zip:NoEst",d.sendTrackingRequest(e)),d.fmDeliveryDateRequestFailure("Delivery estimates not available for this zip."))},fmDeliveryOptionsDisplay:function(){var c=this;if(a(b.estDelZipSpanSelector).text(os.Simplicity.fmDeliveryInfo.zipCode),os.Simplicity.fmDeliveryInfo){var d=jQuery("#delivery-options-list");os.Simplicity.fmDeliveryInfo.shipOptions.length>0&&(a("input[name=zip_code]").val("Enter Zip"),d.find(".del-option-tr").remove(),c.fmBuildDeliveryDateTable(os.Simplicity.fmDeliveryInfo.shipOptions,d)),jQuery("#delivery-options-list").find("tr:nth-child(even)").addClass("delivery-options-even")}jQuery.colorbox.resize()},fmBuildDeliveryDateTable:function(a,b){var c=this;b.find("tbody").empty(),_.each(a,function(a){b.append('<tr class="del-option-tr"><td class="first">'+a.shortMsg+"</td><td>"+c.returnExactDate(a.deliveryTimeEstimate)+"</td></tr>")})},fmDeliveryDateRequestFailure:function(c){a(b.estDelEfErrorInnerSelector).html('<span class="unr-zip">'+c+"</span>"),a(b.estDelEfErrorSelector).show(),jQuery.colorbox.resize()},clearDelEstErrors:function(){a(b.estDelEfErrorInnerSelector).html(""),a(b.estDelEfErrorSelector).hide()},formatTrackingExactDate:function(a){var b=a.split("T")[0],c=b.split("-"),d=(new Date).getTime(),e=new Date(c[0],c[1]-1,c[2]).getTime(),f=Math.ceil((e-d)/864e5);return f+="Days"}}}(jQuery);