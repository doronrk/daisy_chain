(function($j){$j.EndecaSearchSuggestor=function(ele,opts){this._active=true;this._options=opts;this._lastValue="";this._element=ele;this._container=$j('<div class="'+this._options.containerClass+'"></>');this._timeOutId;this._hideTimeOutId;this._selectedIndex=-1;var suggestor=this;var nullResultsPage=false;
if(this._options.page=="nullSearchResultsPage"){$j(".header_null_search").append(this._container);nullResultsPage=true;}else{$j(".header_search").append(this._container);}ele.keydown(function(e){switch(e.keyCode){case 38:if(suggestor._active){suggestor.moveToPrev();if($j(".dimResult",suggestor._container)!=undefined&&$j(".dimResult",suggestor._container)!=null&&$j(".dimResult",suggestor._container).size()!=0){if($j(".dimResult",suggestor._container).get(suggestor._selectedIndex)!=undefined&&$j(".dimResult",suggestor._container).get(suggestor._selectedIndex)!=null){var selectedSrhTerm=$j("a",$j(".dimResult",suggestor._container).get(suggestor._selectedIndex));
if(suggestor._options.page=="nullSearchResultsPage"){$("#SearchTermInResultsPage").val(selectedSrhTerm.text().trim());}else{$("#searchTerm").val(selectedSrhTerm.text().trim());}}}}else{suggestor.show();}break;case 40:if(suggestor._active){suggestor.moveToNext();if($j(".dimResult",suggestor._container)!=undefined&&$j(".dimResult",suggestor._container)!=null&&$j(".dimResult",suggestor._container).size()!=0){if($j(".dimResult",suggestor._container).get(suggestor._selectedIndex)!=undefined&&$j(".dimResult",suggestor._container).get(suggestor._selectedIndex)!=null){var selectedSrhTerm=$j("a",$j(".dimResult",suggestor._container).get(suggestor._selectedIndex));
if(suggestor._options.page=="nullSearchResultsPage"){$("#SearchTermInResultsPage").val(selectedSrhTerm.text().trim());}else{$("#searchTerm").val(selectedSrhTerm.text().trim());}}}}else{suggestor.show();}break;case 9:suggestor.hide();break;case 13:if(suggestor._active&&suggestor._selectedIndex!=-1){e.preventDefault();
suggestor.selectItem();return false;}else{if(nullResultsPage!=true){submitForm();}else{return true;}return false;}break;case 27:if(suggestor._active){suggestor.hide();}break;default:suggestor.handleRequest();}});ele.blur(function(e){var hideFunction=function(){suggestor.hide();};suggestor._hideTimeOutId=setTimeout(hideFunction,200);
});};$j.EndecaSearchSuggestor.prototype.moveToPrev=function(){if(this._selectedIndex==-1){this._selectedIndex=0;}else{if(this._selectedIndex==0){return;}this._selectedIndex--;}$j(".dimResult",this._container).removeClass("selected");$j($j(".dimResult",this._container).get(this._selectedIndex)).addClass("selected");
};$j.EndecaSearchSuggestor.prototype.moveToNext=function(){if(this._selectedIndex==-1){this._selectedIndex=0;}else{if(this._selectedIndex==$j(".dimResult",this._container).size()-1){return;}this._selectedIndex++;}$j(".dimResult",this._container).removeClass("selected");$j($j(".dimResult",this._container).get(this._selectedIndex)).addClass("selected");
};$j.EndecaSearchSuggestor.prototype.selectItem=function(){if(this._selectedIndex==-1){return;}var urlElement=$j("a",$j(".dimResult",this._container).get(this._selectedIndex));if(urlElement.attr("href")==null||urlElement.attr("href").length==0){var searchTermText=urlElement.text();if(this._options.page=="nullSearchResultsPage"){$j(".nullSearchT").val(searchTermText);
submitSearchNull();}else{$j(".searchT").val(searchTermText);submitForm();}}else{var ahrefText=urlElement.attr("href");window.location=ahrefText;}};$j.EndecaSearchSuggestor.prototype.hide=function(){this._container.hide();this._active=false;};$j.EndecaSearchSuggestor.prototype.show=function(){if(this._container.is(":hidden")){this.setPosition();
this._container.show();this._active=true;this._selectedIndex=-1;}};$j.EndecaSearchSuggestor.prototype.handleRequest=function(){var suggestor=this;var callback=function(){var text=$j.trim(suggestor._element.val());if(text!=suggestor._lastValue){if(text.length>=suggestor._options.minAutoSuggestInputLength&&text.length<=suggestor._options.maxAutoSuggestInputLength){suggestor.requestData();
}else{suggestor.hide();}}suggestor._lastValue=text;};if(this._timeOutId){clearTimeout(this._timeOutId);}this._timeOutId=setTimeout(callback,this._options.delay);};$j.EndecaSearchSuggestor.prototype.requestData=function(){var suggestor=this;var response=$j.ajax({url:suggestor.composeUrl(),dataType:"html",async:true,success:function(data){suggestor.showSearchResult(data);
}});};$j.EndecaSearchSuggestor.prototype.composeUrl=function(){var url=this._options.autoSuggestServiceUrl;var searchTerm=this._element.val();searchTerm=searchTerm.replace(/[`~!@#$%^*()_|+\-=?;:",.<>\{\}\[\]\\\/]/gi,"");searchTerm=escape($j.trim(searchTerm));if(url.indexOf("?")==-1){url+="?";}else{url+="&";
}url+="term="+searchTerm;return url;};$j.EndecaSearchSuggestor.prototype.showSearchResult=function(data){var htmlResult=data;if(!$j.trim(htmlResult).length){this.hide();}else{this._container.html(htmlResult);this.bindEventHandler();this.show();}};$j.EndecaSearchSuggestor.prototype.processSearchResult=function(data){var dimSearchResult=null;
var autoSuggestCartridges=data.contents[0].autoSuggest;if(autoSuggestCartridges==null||autoSuggestCartridges.length==0){return null;}for(var j=0;j<autoSuggestCartridges.length;j++){var cartridge=autoSuggestCartridges[j];if(cartridge["@type"]=="DimensionSearchAutoSuggestItem"){dimSearchResult=cartridge;
break;}}if(dimSearchResult!=null){return this.generateHtmlContent(dimSearchResult);}return null;};$j.EndecaSearchSuggestor.prototype.generateHtmlContent=function(dimSearchResult){var newContent=null;if(dimSearchResult!=null&&dimSearchResult.dimensionSearchGroups.length>0){newContent=$j("<div></div>");
if(dimSearchResult.title&&$j.trim(dimSearchResult.title)!=""){newContent.append('<div class="title">'+dimSearchResult.title+"</div>");}var dimSearchGroupList=dimSearchResult.dimensionSearchGroups;for(var i=0;i<dimSearchGroupList.length;i++){var dimResultGroup=dimSearchGroupList[i];var displayName=dimResultGroup.displayName;
newContent.append('<div class="dimRoots">'+displayName+"</div>");for(var j=0;j<dimResultGroup.dimensionSearchValues.length;j++){var dimResult=dimResultGroup.dimensionSearchValues[j];var action=dimResult.contentPath+dimResult.navigationState;var text=dimResult.label;var ancestors=dimResult.ancestors;var ancestorsStr="";
if(ancestors!=null&&ancestors.length>0){for(var n=0;n<ancestors.length;n++){ancestorsStr+=ancestors[n].label+" > ";}}if(dimSearchResult.displayImage){var imageUrl="";var count=dimResult.count==null?"":"&nbsp;("+dimResult.count+")";if($j.trim(dimResult.properties.img_url_thumbnail)!=""){imageUrl=dimResult.properties.img_url_thumbnail;
}else{imageUrl=this._options.defaultImage;}newContent.append('<div class="dimResult"><table><tr><td width="36"><img src="'+imageUrl+'"/></td><td><div class="link"><a href="'+this._options.searchUrl+action+'">'+ancestorsStr+this.highlightMatched(text)+"</a>"+count+"<div></td></tr></table></div>");}else{newContent.append('<div class="dimResult"><div class="link"><a href="'+this._options.searchUrl+action+'">'+ancestorsStr+this.highlightMatched(text)+"</a>"+count+"<div></div>");
}}}}if(newContent!=null){return newContent[0];}return null;};$j.EndecaSearchSuggestor.prototype.highlightMatched=function(text){var inputText=$j.trim(this._element.val()).toLowerCase();var highlighted=text.toLowerCase();if(highlighted.indexOf(inputText)!=-1){var index=highlighted.indexOf(inputText);var prefix=text.substring(0,index);
var suffix=text.substring(index+inputText.length);inputText=text.substr(index,inputText.length);highlighted=prefix+"<span>"+inputText+"</span>"+suffix;}return highlighted;};$j.EndecaSearchSuggestor.prototype.bindEventHandler=function(){var suggestor=this;$j(".dimResult",this._container).mouseover(function(e){$j(".dimResult",suggestor._container).removeClass("selected");
$j(this).addClass("selected");suggestor._selectedIndex=$j(".dimResult",suggestor._container).index($j(this));});$j(".dimResult",this._container).click(function(e){suggestor.selectItem();});$j("a",$j(".dimResult",this._container)).click(function(e){e.preventDefault();suggestor.selectItem();});$j(".dimRoots",this._container).click(function(){clearTimeout(suggestor._hideTimeOutId);
suggestor._element.focus();});};$j.EndecaSearchSuggestor.prototype.setPosition=function(){var offset=this._element.offset();this._container.css({width:this._element.width()});};$j.fn.endecaSearchSuggest=function(options){var opts=$j.extend({},$j.fn.endecaSearchSuggest.defaults,options);this.each(function(){var element=$j(this);
new $j.EndecaSearchSuggestor(element,opts);});};$j.fn.endecaSearchSuggest.defaults={minAutoSuggestInputLength:3,maxAutoSuggestInputLength:10,displayImage:false,delay:250,autoSuggestServiceUrl:"",collection:"",searchUrl:"",containerClass:"dimSearchSuggContainer",defaultImage:"no_image.gif"};})(jQuery);
