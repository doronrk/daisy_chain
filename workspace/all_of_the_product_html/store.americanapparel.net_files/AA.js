var AA=AA||{};AA.Modules.Slider=(function($,AA,M,window){'use strict';var BEFORE_SLIDE="slider.beforeslide",loadCss=AA.Utils.LoadCss,cssThemePath=window.CDN_URL+'/css/themes/',SLIDE_CLICK="slider.slideclick",defaults={targetDiv:null,sliderType:null,dataUrl:null,s7Data:null,preload:true,renderSlide:undefined,onSlideBefore:function(){},gridView:false,slideClass:'slide',imgPropName:'ImagePath',linkPropName:'Link',bxSlider:{pager:false,prevText:'<span class="aa-slider-prev"></span>',nextText:'<span class="aa-slider-next"></span>',auto:true,speed:250,pause:4000,useCSS:false,randomStart:false,onSlideBefore:function(slideEl,oldIndex,newIndex){$.publish(BEFORE_SLIDE,{curSlideNum:oldIndex,nextSlideIndex:newIndex});}}};function getSlideshowConfigs(){return{giftcard:{preload:false,bxSlider:{auto:false,speed:400,minSlides:4,maxSlides:4,slideWidth:71,moveSlides:3,slideMargin:8,onSliderLoad:function(){var $gallery=$("#giftcardGallery"),$imageUrl=$("#imageURL"),img;if($imageUrl.val()!==""){img=$imageUrl.val();img=img.substring(0,img.lastIndexOf("?")+ 1)+"$thumbnail_small$";$gallery.find(".slide[data-image=\""+ img+"\"]").addClass('slide-selected');}else{$gallery.find('.slide').removeClass('slide-selected');var $firstSlide=$gallery.find('.slide').not('.bx-clone').first().addClass('slide-selected');img=$firstSlide.attr('data-image');$imageUrl.val(img.substring(0,img.lastIndexOf("?")+ 1)+"$EGiftCard$");}}},renderSlide:function(slidedata,preload,defaultconfig){return Mustache.render($("#tml-giftcardgallery").html(),{"list":slidedata});}},playpause:{cssThemeFile:'playpause',onSlideBefore:function(data){loadImg(data.localSlides[data.nextSlideIndex]);},bxSlider:{autoControls:true,pager:true}}};}
function loadImg(slideEl){var slide=$(slideEl);if(slide.attr('data-image')&&!Number(slide.attr('data-loaded'))){slide.find('div').append('<img style="display:none;" hidefocus="true" src="'+ slide.attr('data-image')+'" alt="'+(slide.attr('data-alt')||'')+'" useMap="'+(slide.attr('data-map')||'')+'" />');slide.find('img').load(function(){$(this).fadeIn();});slide.attr('data-loaded',1);}}
function getData(url,callback){if(url!==null||url!==""){var dataUrl=url+"&region="+ AA.Config.COUNTRY+"&lang="+ AA.Config.LANGUAGE+"&callback=?";$.getJSON(dataUrl,callback);}}
function preloadSlides(slideList,index){var prev=slideList[index- 1]||slideList[slideList.length- 1],next=slideList[index+ 1]||slideList[0],list=[prev,next],len=list.length;while(len--){loadImg(list[len]);}}
function sliceList(list,chunk,offset){var end=offset+ chunk,out=list.slice(offset,end);if(list.length<end){out=out.concat(list.slice(0,end- list.length));}
return out;}
function beforeSlide(event,data){preloadSlides(data.localSlides,data.nextSlideIndex);data.slider.getConfig().onSlideBefore(data);}
function scrollTo(id){if($(id).length>0){$('html,body').animate({scrollTop:$(id).offset().top},'slow');}}
function appendImgDomain(slides){var slideList=slides,len=slideList.length,i;for(i=0;i<len;i++){slideList[i].ImagePath='http://i.americanapparel.net'+ slideList[i].ImagePath;}
return slideList;}
function formatImageUrls(data){if(data&&$.isArray(data)){if(data[0].ImagePath&&data[0].ImagePath.lastIndexOf('http')===-1){return appendImgDomain(data);}else{return data;}}else if(data&&!$.isArray(data)){return data.data;}}
function buildSliderHTML(slides,preload){slides={'slides':slides,'Preload':preload,'encodeURL':function(){return function(text,render){var text=render(text);return encodeURIComponent(text+"&type=.jpg");};}}
return M.render("{{#slides}}"+"<div class='"+defaults.slideClass+"' {{#Preload}}data-loaded='0' data-image='{{{ImagePath}}}' {{^Link}}{{#Map}}data-map='#{{{Name}}}'{{/Map}}{{/Link}}{{/Preload}}>"+"{{^VideoPath}}"+"{{#Link}}<a href='{{{Link}}}'>{{/Link}}"+"<div>{{^Preload}}<img src='{{{ImagePath}}}' {{^Link}}{{#Map}}useMap='#{{{Name}}}'{{/Map}} hidefocus='true'{{/Link}} alt='{{{Title}}}' title='{{{Title}}}' />{{/Preload}}</div>"+"{{#Link}}</a>{{/Link}}"+"{{^Link}}"+"{{#Map}}"+"<map name='{{{Name}}}'>"+"{{#Areas}}<area shape='{{{Shape}}}' coords='{{{Coords}}}' href='{{{Href}}}' />{{/Areas}}"+"</map>"+"{{/Map}}"+"{{/Link}}"+"{{/VideoPath}}"+"{{#VideoPath}}"+"<video controls='controls' poster='{{{ImagePath}}}' width='100%'>"+"<source src='{{{VideoPath}}}' type='video/mp4' />"+"<object type='application/x-shockwave-flash' data='http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf' width='640' height='360'>"+"<param name='movie' value='http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf' />"+"<param name='allowFullScreen' value='true' />"+"<param name='wmode' value='transparent' />"+"<param name='flashVars' value=\"config={'playlist':['{{#encodeURL}}{{{ImagePath}}}{{/encodeURL}}',{'url':'{{{VideoPath}}}','autoPlay':false}]}\" />"+"<img alt='Big Buck Bunny' src='http://sandbox.thewikies.com/vfe-generator/images/big-buck-bunny_poster.jpg' width='640' height='360' title='No video playback capabilities, please download the video below' />"+"</object>"+"</video>"+"{{/VideoPath}}"+"</div>"+"{{/slides}}",slides);}
function cloudZoomHTML(slides,preload,defaults){var htmlStr='';$.each(slides,function(i){var image=this['ImagePath'],zoomImg=image.replace('$RotatorXLarge$','$RotatorXLargeZoom$');htmlStr+='<div class="'+ defaults.slideClass+'"><a class="cloud-zoom" href="'+ zoomImg+'"><img src="'+ image+'" alt="" width="'+(defaults.bxSlider.slideWidth||'')+'" height="'+(defaults.bxSlider.slideHeight||'')+'" /></a></div>';});return htmlStr;}
function slideDragHTML(slides,preload,defaults){return M.render("<div class='innerSlideDrag'>{{#slides}}<img src='{{{ImagePath}}}' {{#Map}}useMap='#{{Name}}'{{/Map}} />{{#Map}}<map name='{{Name}}'>{{#Areas}}<area shape='{{{Shape}}}' coords='{{{Coords}}}' href='{{{Href}}}' />{{/Areas}}</map>{{/Map}}{{/slides}}</div><a href='javascript:void(0);' class='bx-prev'><img src='http://store.americanapparel.net/media/bxSlider/left.png'></a><a href='javascript:void(0);' class='bx-next'><img src='http://store.americanapparel.net/media/bxSlider/right.png'></a>",{'slides':slides});}
function Slideshow(config){Slideshow.defaultConfig=$.extend(true,{},defaults);if(config){this.config=$.extend(true,Slideshow.defaultConfig,config);}else{this.config=Slideshow.defaults;}
this.el=$(this.config.targetDiv);this.bxSlider=null;this.slides=null;this.json=null;}
Slideshow.prototype={getData:function(){if(this.json!==null&&this.json.data){return this.json.data;}else{return this.json;}},setData:function(data){this.json=data;},getEl:function(){return this.el;},setSlides:function(slides){this.slides=slides;},getSlides:function(slides){return this.slides;},getConfig:function(){return this.config;},setBxSlider:function(bxslider){this.bxSlider=bxslider;},getBxSlider:function(){return this.bxSlider;},renderTemplate:function(templateData){var slideData=templateData,$targetDiv=this.getEl(),defaults=this.getConfig();if(slideData.length===1){$targetDiv.html(buildSliderHTML(slideData,false));return;}
if(defaults.renderSlide&&typeof defaults.renderSlide==='function'){$targetDiv.html(defaults.renderSlide(slideData,(defaults.preload&&slideData.length>5&&!defaults.gridView),defaults));}else{$targetDiv.html(buildSliderHTML(slideData,(defaults.preload&&slideData.length>5&&!defaults.gridView)));}},start:function(){var $targetDiv=this.getEl(),defaults=this.getConfig(),data=this.getData(),bxSlider,localSlides;$targetDiv.delegate('.'+ defaults.slideClass,'click',$.proxy(function(e){$.publish(SLIDE_CLICK,{target:e.target,bxSlider:this.getBxSlider()});},this));$targetDiv.on('click','map area',function(e){var id=$(this).attr('href');if(id.indexOf('#')===0){e.preventDefault();scrollTo(id);}});if(defaults.gridView||this.getData.length===1){return;}
if(typeof defaults.cssThemeFile!=='undefined'){loadCss(cssThemePath+ defaults.cssThemeFile+'.css');}
if(defaults.preload&&data!==null&&data.length>5){this.setSlides($.makeArray($targetDiv.find('div.'+ defaults.slideClass)));localSlides=this.getSlides();loadImg(localSlides[0]);loadImg(localSlides[data.length-1]);preloadSlides(localSlides,0);$.subscribe(BEFORE_SLIDE,$.proxy(function(event,data){data.localSlides=this.getSlides();data.slider=this;beforeSlide(event,data);},this));}else{$targetDiv.css('display','none').fadeIn();}
this.setBxSlider($targetDiv.bxSlider(defaults.bxSlider));bxSlider=this.getBxSlider();this.el.on("click",function(){bxSlider.stopAuto();});}};function init(options){var slideshow=new Slideshow(options),config=slideshow.getConfig();if(slideshow.getEl().length===0){return;}
if(config.dataUrl!==null&&config.dataUrl!==""){getData(config.dataUrl,function(data){if(typeof data!=='undefined'&&data.length===0){var loadingDiv=slideshow.getEl().find('.aa-slider-loading');loadingDiv.addClass('aa-slider-failedtoload').html(":(").css("line-height",loadingDiv.height()+"px");return;}
if(typeof data.slideShowSpeed!=='undefined'){defaults.bxSlider.pause=Number(data.slideShowSpeed);}
slideshow.setData(formatImageUrls(data));slideshow.renderTemplate(slideshow.getData());slideshow.start();});}else if(config.s7Data!==null){if(typeof config.s7Data.slideShowSpeed!=='undefined'){defaults.bxSlider.pause=Number(config.s7Data.slideShowSpeed);}
slideshow.setData(formatImageUrls(config.s7Data));slideshow.renderTemplate(slideshow.getData());slideshow.start();}else{slideshow.start();}}
return{init:init,preload:preloadSlides,renderCloudZoom:cloudZoomHTML,renderSlideDrag:slideDragHTML,events:{beforeSlide:BEFORE_SLIDE,slideClick:SLIDE_CLICK},config:getSlideshowConfigs()};}(jQuery,AA,Mustache,window));