define(["jquery","backbone","clientSideStorage","contextFramework","security","googleConfig","commonjs/models/Store"],function(e,t,s,r,i,o,a){var n=false;return t.Collection.extend({SDP_URL:"/api/store/v2/stores",ON_STORES_DATA:"storesCollectionsOnStoresDataEvent",ON_STORES_ERROR:"storesCollectionsOnStoresErrorEvent",GEOCODE_ERROR:"storesCollectionOnGeoCodeErrorEvent",VALID_LOCATION:"storesCollectionValidLocationEvent",QUERY_BY_ID:0,QUERY_BY_GEO:1,useSDPService:false,STORAGE_KEY:"locations",GOOGLE_SEARCH_BY_STORE_ID:false,MAX_STORES:10,STORE_ID:-1,storeLatitude:0,storeLongitude:0,METERS_PER_MILE:1609.344,model:a,currentSearchTerm:"",currentFilters:{},hasFilters:false,distance:0,searchIsExpanded:false,searchExpandDistance:100,searchRadius:null,google:null,radiusCommon:200,dataType:"json",excludeOutlets:false,maxStores:false,getSearchRadius:function(){if(!this.useSDPService){return this.radiusCommon*this.METERS_PER_MILE}else{return"M"+this.radiusCommon}},initialize:function(e){this.listenTo(this,"reset",this.query);this.useSDPService=o.gmeToSdpEnabled||false;if(!this.useSDPService){this.dataType="jsonp"}this.STORE_ID=typeof e!=="undefined"&&typeof e.storeId!=="undefined"?e.storeId:this.STORE_ID;this.GOOGLE_MAX_STORES=typeof e!=="undefined"&&typeof e.maxStores!=="undefined"?e.maxStores:o.maxStoresReturn},query:function(){var t=0,s=[],i=this.toJSON();if(i.length===1&&e.isEmptyObject(i[0])){i.pop()}if(!n&&i.length>0){n=true;r.user.setStores(i,this.currentSearchTerm)}if(this.hasFilters){i=[];s=this.where(this.currentFilters);for(t=0;t<s.length;t+=1){i.push(s[t].attributes)}}if(this.excludeOutlets){for(t=0;t<i.length;t+=1){if(i[t].storeTypeDescription==="OUT"){i.splice(t--,1)}}}if(this.distance){for(t=0;t<i.length;t+=1){if(i[t].distance>this.distance){i.splice(t--,1)}}}var o=this.maxStores||this.MAX_STORES;i=i.splice(0,o);for(t=0;t<i.length;t+=1){i[t].storeIndex=t+1}this.trigger(this.ON_STORES_DATA,{stores:i,searchTerm:this.currentSearchTerm,filters:this.currentFilters,distance:this.distance,excludeOutlets:this.excludeOutlets})},setFilters:function(e){this.hasFilters=false;this.currentFilters={};for(var t in e){this.hasFilters=true;this.currentFilters[t]=e[t]}},handleFilterRequest:function(e){this.setFilters(e.filters);this.distance=e.distance||false;this.excludeOutlets=e.excludeOutlets||false;this.query()},handleSearchRequest:function(e){this.setFilters(e.filters);this.excludeOutlets=e.excludeOutlets||false;this.distance=e.distance||false;this.maxStores=e.maxStores||this.MAX_STORES;if(e.searchTerm&&i.attemptedScript(e.searchTerm)){throw new Error("security warning, attempted script injection.")}var t=this;this.currentSearchTerm=e.searchTerm=i.preventXss(e.searchTerm);if(e.lat&&e.lng){this.storeLatitude=e.lat;this.storeLongitude=e.lng;this.doFetch(e)}else if(r.user.hasLocationWithLatLng(e.searchTerm)){var s=r.user.getLocation(e.searchTerm);this.storeLatitude=s.lat;this.storeLongitude=s.lng;this.doFetch(e)}else{require(["googleMaps!"],function(){if(window.google){this.google=window.google}var s=new this.google.maps.Geocoder;s.geocode({address:e.searchTerm},function(s,i){if(i===this.google.maps.GeocoderStatus.OK){t.storeLatitude=s[0].geometry.location.lat();t.storeLongitude=s[0].geometry.location.lng();var o=r.user.getLocation(e.searchTerm);o.searchTerm=e.searchTerm;o.lat=t.storeLatitude;o.lng=t.storeLongitude;o.geocodeData=s[0];r.user.setLocation(o,e.searchTerm);var a=true;if(e.doNotSetPreferred&&e.doNotSetPreferred===true){a=false}if(a){r.user.setPreferred(e.searchTerm)}t.doFetch(e)}else{t.trigger(t.GEOCODE_ERROR,{message:i})}})})}},doFetch:function(e){var t=this;this.trigger(this.VALID_LOCATION,e);var s=r.user.getStores(e.searchTerm);if(s.length>0){this.reset(s)}else{n=false;this.fetch({reset:true,dataType:this.dataType,error:function(e,s){t.trigger(t.ON_STORES_ERROR,{message:s})}})}},getGoogleMapUrl:function(){var e="&select=StoreId,LocationNumber,StoreType,StoreNumber,StoreName,Description,AddressLine1,AddressLine2,OperationDate,BopsEligible,Mattress,Furniture,Visitor,Shopper,Restaurant,Bridal,Day1,Day2,Day3,Day4,Day5,Day6,Day7,Day8,City,State,Zip,PhoneNumber,TimeZone,GMTOffset,geometry",t="&where=",s="",r=this.STORE_ID>-1?",0":",ST_DISTANCE(geometry,ST_POINT("+this.storeLongitude+","+this.storeLatitude+"))";e+=r+" as distance";t+=this.STORE_ID>-1?"StoreId="+this.STORE_ID:"ST_DISTANCE(geometry,ST_POINT("+this.storeLongitude+","+this.storeLatitude+"))<"+this.getSearchRadius();var i=o.googleMapsEngine+e+t+s+"&orderBy=distance ASC&limit=50"+"&intersects=CIRCLE("+this.storeLongitude+" "+this.storeLatitude+", "+o.gmeIntersectsRadius+")";return i},url:function(){if(!this.useSDPService){return this.getGoogleMapUrl()}else{return this.SDP_URL+"?latitude="+Number(this.storeLatitude).toFixed(o.numberOfDecimal)+"&longitude="+Number(this.storeLongitude).toFixed(o.numberOfDecimal)}},parse:function(e){if(e.hasOwnProperty("features")){if(e.features.length>0){return e.features}}if(e.hasOwnProperty("stores")){if(e.stores.store){if(e.stores.store.length>0){return e.stores.store}}else{return e}}}})});