(function($){$.fn.imgviewer=function(spinEnabled,options){var opts={zoomImageWidth:1000,zoomImageHeight:750,zoomPopWidth:250,zoomPopHeight:250,delay:80,frames:12};if(typeof options=="object"){$.each(options,function(k,v){opts[k]=v})}var context=this;var imgCache=[];var zoomimgCache=[];var curFrame=12;var stopFrame=0;var spinMode=false;var zoomMode=false;var rotating=false;var direction;var timer;if(spinEnabled!=true){spinEnabled=false}initialize();function initialize(){$(context).wrap('<div id="imgviewer" />');$('#imgviewer').css({'position':'relative'});$('img',context).wrap('<div id="imgviewer_spin" />');$(context).append('<div id="imgviewer_zoomLens"><img /></div>');$(context).after('<div id="imgviewer_controls"><a href="#" class="zoom"></a><a href="#" class="spin"></a></div><div id="imgviewer_zoomPop"><img /></div>');if(spinEnabled){$('#imgviewer_controls a.spin').click(function(e){e.preventDefault();if(spinMode==true){initializeSpin();stopFrame=curFrame;rotate()}else{initializeSpin()}})}else{$('#imgviewer_controls a.spin').click(function(e){if(!$('div.notice',context).is('*')){$(context).append('<div class="notice"><p>360&deg;-spin view is not available for this product.</p></div>')}$('div.notice',context).hide().fadeIn(500).delay(1000).fadeOut(1000);e.preventDefault()})}$('#imgviewer_zoomLens, #imgviewer_zoomPop').hide();$('#imgviewer_controls a.zoom').click(function(e){e.preventDefault();initializeZoom()});imgCache[0]=true;initializeSpin();$('#altviews img').click(function(e){e.preventDefault();if(zoomMode==true){destroyZoom();initializeSpin()}if($(this).hasClass('spin')){stopFrame=curFrame;rotate()}else{re=/(.*c\[)([0-9]{1,2})(\].*)/i.exec($(this).attr('src'));if(re[2]<11){if(re[2]==2||re[2]==3||re[2]==4||re[2]==6||re[2]==7){var csrc=$('#imgviewer_spin img',context).attr('src');var nsrc=csrc.replace(/c\[([0-9]{1,2})\]/,'c['+re[2]+']');$('#imgviewer_spin img',context).attr('src',nsrc)}}else{stopFrame=re[2]-10;if(stopFrame>0&&rotating==false){if(stopFrame>curFrame){if((stopFrame-curFrame)>7){direction="L"}else{direction="R"}}else{if((curFrame-stopFrame)>7){direction="R"}else{direction="L"}}rotate()}}}}).css({'cursor':'pointer'});$('#zoom').click(function(e){e.preventDefault();initializeZoom()}).css({'cursor':'pointer'})}function bindControls(){if(zoomMode==true){$(document).unbind('keyup').keyup(function(e){if(e.keyCode==27){destroyZoom();initializeSpin()}});$(context).unbind('click').bind('click',function(e){e.preventDefault();destroyZoom();initializeSpin()});$(context).unbind('mousedown').bind('mousedown',function(e){e.preventDefault()});$(context).unbind('mouseleave').bind('mouseleave',function(e){$('#imgviewer_zoomLens, #imgviewer_zoomPop').hide();$('#imgviewer_spin img',context).css({'opacity':'1'})});$(context).unbind('mouseenter').bind('mouseenter',function(e){$('#imgviewer_zoomLens, #imgviewer_zoomPop').show();$('#imgviewer_spin img',context).css({'opacity':'.3'})});var isrc=$('#imgviewer_spin img',context).attr('src').replace(/w\[([0-9]{1,3})\]/,'w['+opts.zoomImageWidth+']').replace(/h\[([0-9]{1,3})\]/,'h['+opts.zoomImageHeight+']');if(!zoomimgCache[curFrame]){if(!$('div.loading',context).is('*')){$(context).append('<div class="loading"></div>')}$('div.loading',context).show();var img=new Image();$(function(){$(img).load(function(){$('div.loading',context).hide();zoomimgCache[curFrame]=true;zoom()}).error(function(){}).attr('src',isrc)})}else{zoom()}}else{if(spinEnabled){$(context).unbind('dblclick').dblclick(function(e){e.preventDefault();initializeZoom()});$(context).unbind('mousedown').mousedown(function(e){e.preventDefault();$(this).css('cursor','e-resize');var mpos=e.pageX;$(this).mouseleave(function(){$(window).mouseup(function(){$(this).unbind();destroySpin();initializeSpin()});$(this).mouseenter(function(){$(this).unbind('mouseenter');$(window).unbind('mouseup');if(rotating==false){rotate()}})});$(this).mousemove(function(me){me.preventDefault();if(me.pageX<(mpos-10)){mpos=me.pageX;direction="L";if(rotating==false){rotate()}}else if(me.pageX>(mpos+10)){mpos=me.pageX;direction="R";if(rotating==false){rotate()}}})});$(context).unbind('click').click(function(e){destroySpin();initializeSpin()})}else{$(context).unbind('click dblclick').bind('click dblclick',function(e){initializeZoom()})}}}function destroySpin(){$(context).unbind().css('cursor','default');spinMode=false}function destroyZoom(){$(document).unbind('keyup');$(context).unbind();$('#imgviewer_spin img',context).css({'opacity':'1'});$('#imgviewer_zoomLens, #imgviewer_zoomPop').hide();zoomMode=false}function initializeSpin(){if(spinMode==true){return}destroyZoom();spinMode=true;rotating=false;clearTimeout(timer);$('#imgviewer_controls a.zoom').removeClass('active');if(spinEnabled){$('#imgviewer_controls a.spin').addClass('active')}bindControls()}function initializeZoom(){if(zoomMode==true){return}destroySpin();zoomMode=true;$('#imgviewer_controls a.spin').removeClass('active');$('#imgviewer_controls a.zoom').addClass('active');bindControls()}function cacheImages(){if(!$('div.loading',context).is('*')){$(context).append('<div class="loading"></div>')}$('div.loading',context).show();var csrc=$('#imgviewer_spin img',context).attr('src');var img=[];for(i=1;i<=opts.frames;i++){img[i]=new Image();var nsrc=csrc.replace(/c\[([0-9]{1,2})\]/,'c['+(i+10)+']');$(function(){$(img[i]).load(function(){imgCache[(imgCache.length+1)]=true;cacheComplete()}).error(function(){}).attr('src',nsrc)})}}function cacheComplete(){if(imgCache.length>=opts.frames){rotating=false;$('div.loading',context).hide();rotate()}}function rotate(){rotating=true;clearTimeout(timer);if(spinEnabled){if(imgCache.length<opts.frames){cacheImages();return}if(direction=="L"){if(curFrame==1){curFrame=12}else{curFrame=curFrame-1}}else{if(curFrame==opts.frames){curFrame=1}else{curFrame=curFrame+1}}if(!stopFrame){stopFrame=curFrame}}else{if(!stopFrame){stopFrame=2}curFrame=stopFrame}var csrc=$('#imgviewer_spin img',context).attr('src');var nsrc=csrc.replace(/c\[([0-9]{1,2})\]/,'c['+(curFrame+10)+']');$('#imgviewer_spin img',context).attr('src',nsrc);if(stopFrame==curFrame){stopFrame=0;rotating=false}else{timer=setTimeout(rotate,opts.delay)}}function zoom(){var img=$('#imgviewer_spin img',context);var isrc=img.attr('src').replace(/w\[([0-9]{1,3})\]/,'w['+opts.zoomImageWidth+']').replace(/h\[([0-9]{1,3})\]/,'h['+opts.zoomImageHeight+']');$('#imgviewer_zoomLens, #imgviewer_zoomPop').show();$('#imgviewer_spin img',context).css({'opacity':'.3'});var imageW=img.width();var imageH=img.height();var boundT=$(context).offset().top;var boundL=$(context).offset().left;var scaleX=opts.zoomImageWidth/imageW;var scaleY=opts.zoomImageHeight/imageH;var zoomLensWidth=Math.ceil(opts.zoomPopWidth/scaleX);var zoomLensHeight=Math.ceil(opts.zoomPopHeight/scaleY);var zoomPop=$('#imgviewer_zoomPop');var zoomLens=$('#imgviewer_zoomLens',context);zoomPop.css({'overflow':'hidden','position':'absolute','top':'0','left':'100%','width':opts.zoomPopWidth+'px','height':opts.zoomPopHeight+'px'});$('img',zoomPop).attr({'src':isrc,'width':opts.zoomImageWidth,'height':opts.zoomImageHeight}).css({'position':'absolute','top':'0','left':'0'});zoomLens.css({'overflow':'hidden','position':'absolute','top':'0','left':'0','margin':'0','cursor':'crosshair','width':zoomLensWidth+'px','height':zoomLensHeight+'px'});$('img',zoomLens).attr({'src':img.attr('src'),'width':imageW,'height':imageH}).css({'position':'absolute','top':'0','left':'0'});$(context).unbind('mousemove').bind('mousemove',function(e){if((e.pageX-((zoomLensWidth+2)/2))<boundL){var zLl=1;var zPl=1}else if((e.pageX+((zoomLensWidth+2)/2))>(imageW+boundL)){var zLl=imageW-(zoomLensWidth+2);var zPl=opts.zoomImageWidth-opts.zoomPopWidth}else{var zLl=Math.ceil(Math.abs(e.pageX-boundL)-(zoomLensWidth/2));var zPl=Math.ceil(Math.abs((e.pageX-boundL)*scaleX)-(opts.zoomPopWidth/2))}if((e.pageY-((zoomLensHeight+2)/2))<boundT){var zLt=1;var zPt=1}else if((e.pageY+((zoomLensHeight+2)/2))>(imageH+boundT)){var zLt=imageH-(zoomLensHeight+2);var zPt=opts.zoomImageHeight-opts.zoomPopHeight}else{var zLt=Math.ceil(Math.abs(e.pageY-boundT)-(zoomLensHeight/2));var zPt=Math.ceil(Math.abs((e.pageY-boundT)*scaleY)-(opts.zoomPopHeight/2))}zoomLens.css({'top':zLt+'px','left':zLl+'px'});$('img',zoomLens).css({'top':'-'+(zLt+1)+'px','left':'-'+(zLl+1)+'px'});$('img',zoomPop).css({'top':'-'+zPt+'px','left':'-'+zPl+'px'})})}}}(jQuery));