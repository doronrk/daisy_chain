BLOOMIES.namespace("BLOOMIES.addToRegistry");BLOOMIES.namespace("BLOOMIES.atb");BLOOMIES.addToRegistry.weddingAddToRegistryUrl="/registry/wedding/addtoregistry";BLOOMIES.addToRegistry.viewRegistryUrl="/registry/wedding/registrant";BLOOMIES.addToRegistry.registrySignIn="/registry/wedding/registrysignin";BLOOMIES.addToRegistry.registryClaim="";BLOOMIES.addToRegistry.quantityAdded=0;BLOOMIES.addToRegistry.brightTagEnabled=false;BLOOMIES.addToRegistry.buttonClick=function(a){BLOOMIES.addToRegistry.registryClaim="";BLOOMIES.loading.show();BLOOMIES.addToRegistry.validateMember(a)};BLOOMIES.addToRegistry.validateMember=function(g){var d=YAHOO.util.Dom,b=YAHOO.util.Event,e={},c,h;c=g.id.replace("ADDTOREG_BUTTON","");BLOOMIES.addToRegistry.atr_productId=c;var a;if(BLOOMIES.pdp&&BLOOMIES.pdp.pageType==="MASTER"){a=d.getAncestorByClassName(g,"memberProducts");e=this._getProduct(a);h=d.get("productName"+c);e.name=h?h.innerHTML:"";e.price=d.getElementsByClassName("netPrice","input",a)[0].value}else{a=d.get("productContainer");e=this._getProduct(a);e.name=d.get("productTitle").innerHTML;e.price=d.getElementsByClassName("netPrice","input","PriceDisplay")[0].value}e.price=e.price?e.price.match(/[\d.]+/):null;e.price=e.price?e.price[0]:null;e.ID=c;var f=[e];if(e){BLOOMIES.coremetrics.cmCreateConversionEventTag(e.ID,CONVERSION_INITIATE,"Item added to Registry",0,"-_--_-"+e.price.replace(",","")+"-_-"+BLOOMIES.pdp.CMCategoryId+"-_-"+e.name+"-_-"+e.price.replace(",","")*e.quantity);YAHOO.util.Connect.asyncRequest("POST",BLOOMIES.addToRegistry.weddingAddToRegistryUrl+BLOOMIES.addToRegistry.registryClaim,{success:function(i){this.handleJsonResponse(i,g)},failure:function(i){BLOOMIES.loading.hide();BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"Error occurred while processing your request.")},scope:this,argument:f},this.buildProductPost(f))}else{BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"Error occurred while processing your request.")}};BLOOMIES.addToRegistry._getProduct=function(h){var f={},g={},e={},b={},d=YAHOO.util.Dom,a=YAHOO.util.Event;try{f.size="NA";f.color="NA";if(h){g=d.getElementsByClassName("pdpColorDesc","span",h)[0];e=d.getElementsByClassName("productSize","span",h)[0];b=d.getElementsByClassName("pdp_dropdown_qty","select",h)[0];if(g){f.color=g.innerHTML}f.quantity=b.value;if(e){f.size=e.innerHTML}}}catch(c){return}return f};BLOOMIES.addToRegistry.buildProductPost=function(g){var c=[],f=[],h=[],e=[],d,a;for(d=0,a=g.length;d<a;d++){c.push(g[d].color);f.push(g[d].size);h.push(g[d].quantity);e.push(g[d].ID)}var b="productId="+e.join(",")+"&color="+c.join(",")+"&size="+f.join(",")+"&quantity="+h.join(",");return b};BLOOMIES.addToRegistry.handleJsonResponse=function(f){BLOOMIES.loading.hide();var g=BLOOMIES.addToRegistry.overlay;var d={};try{d=YAHOO.lang.JSON.parse(f.responseText);if(d&&d.HAS_REGISTRY){if(d.HAS_REGISTRY==="NO"){BLOOMIES.addToRegistry.overlayClaim.show();return}}else{if(d&&d.REDIRECT){window.location=secureServer+d.REDIRECT;return}}if(d.ERROR_MSG){BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,d.ERROR_MSG);BLOOMIES.resetForm();return}if(!d.nonRegistrableUPCs&&(!d.registrantInfo||!d.imgMap)){BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"Unknown error occurred while processing your request");BLOOMIES.resetForm();return}else{if(d.nonRegistrableUPCs&&(!d.registrantInfo||!d.imgMap)){this.handleNonRegUPCResponse(d);return}}g.setRegistryId(d.registrantInfo.registryId);var c=YAHOO.util.Dom.getElementsByClassName("itemRow")[0];if(c){c.innerHTML=""}var b=0;var e=f.argument.length;BLOOMIES.coremetrics.cmCreatePageviewTag(cmAddToRegistryPageID,CMcategoryID,"","");for(var h=0;h<f.argument.length;h++){var l=f.argument[h].ID;if(d.imgMap[l]){addedProduct=f.argument[h];BLOOMIES.coremetrics.cmCreateConversionEventTag(addedProduct.ID,CONVERSION_COMPLETE,"Item added to Registry",addedProduct.quantity,"-_--_-"+addedProduct.price.replace(",","")+"-_-"+BLOOMIES.pdp.CMCategoryId+"-_-"+addedProduct.name+"-_-"+addedProduct.price.replace(",","")*addedProduct.quantity);b+=parseInt(addedProduct.quantity);BLOOMIES.addToRegistry.overlay.dialog=BLOOMIES.globalWidgets.Panel.create("addToRegOvelay",{effect:{effect:YAHOO.widget.ContainerEffect.FADE,duration:0.2},context:["ADDTOREG_BUTTON"+l,"tl","tl",["beforeShow","windowResize"],[-180,-130]],fixedcenter:false,modal:true,close:true,monitorresize:false,draggable:false});if(d.registryItemsCount){var k=d.quantityMap[l];var a=d.registryItemsCount;YAHOO.util.Dom.get("addedQty").innerHTML=(k>1?k+" items have":"1 item has")}if(BLOOMIES.pdp&&BLOOMIES.pdp.pageType!=="MASTER"){g.addProduct(d.imgMap[l],addedProduct)}}}if(d.nonRegistrableUPCs&&d.nonRegistrableCount>0){g.setAddedCount(b,d.nonRegistrableCount);this.handleNonRegUPCResponse(d)}else{g.setAddedCount(b,0)}if(b){g.setAnalytics(b);g.show()}else{BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"Error occurred while processing your request")}BLOOMIES.resetForm()}catch(j){BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"Error occurred while processing your request");BLOOMIES.resetForm();return}};BLOOMIES.addToRegistry.handleNonRegUPCResponse=function(c){var b=new Array();var a=new Array();for(var f=0;f<c.nonRegistrableUPCs.length;f++){var h=c.nonRegistrableUPCs[f];var g=h.substring(0,h.indexOf(","));var e=h.substring(h.indexOf(",")+1);b.push(g);a.push(e)}if(b.length!==0&&a.length!==0){if(c&&c.nonRegistrableCount===1){BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,"We're sorry. 1 item has not been added to your registry because it is not available for registry.")}else{if(c&&c.nonRegistrableCount>1){var d="We're sorry."+c.nonRegistrableCount+" items have not been added to your registry because they are not available for registry.";BLOOMIES.atb.sizeColorManager.validationPanel.show(BLOOMIES.atb.targetBtn,d)}}}BLOOMIES.resetForm()};BLOOMIES.resetForm=function(){var a=document.getElementsByTagName("form");for(var b=0;b<a.length;b++){a[b].reset()}};BLOOMIES.addToRegistry.overlay=(function(){var a={};if(BLOOMIES.pdp&&BLOOMIES.pdp.pageType!=="MASTER"){this.dialog=BLOOMIES.globalWidgets.Panel.create("addToRegOvelay",{effect:{effect:YAHOO.widget.ContainerEffect.FADE,duration:0.2},context:["productContainer","tl","tl",["beforeShow","windowResize"],[0,0]],fixedcenter:false,modal:true,close:true,monitorresize:false,draggable:false});a.addProduct=function(f,e){var b=YAHOO.util.Dom.getElementsByClassName("itemRow","div")[0];var d=parseFloat(e.price.replace(",",""));var c=document.createElement("div");YAHOO.util.Dom.addClass(c,"regItemsSeperator");c.innerHTML='<div class="itemContent"><div class="floatLeft"><img border="1" width="60" src="'+pdpAssetServer+""+f+'?wid=60"/></div><div class="floatLeft pdp_atb_itemContainer"><div class="pdp_atb_item_desc">'+e.name+"</div>"+(e.color!=="NA"||e.size!=="NA"?'<div class="pdp_atb_item_attrs"><div class="pdp_atb_itemAttributes">'+(e.color!=="NA"&&e.size!=="NA"?'<span class="itemColor"><strong>Color:</strong> '+e.color+"</span>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<span ><strong>Size:</strong> "+e.size+'</span></div><div class="clear"></div></div>':"")+(e.color!=="NA"&&e.size==="NA"?'<span class="itemColor"><strong>Color:</strong> '+e.color+'</span></div><div class="clear"></div></div>':"")+(e.size!=="NA"&&e.color==="NA"?"<span ><strong>Size:</strong> <span>"+e.size+'</span></div><div class="clear"></div></div>':""):"")+'<br/><strong>Price: </strong><span id="unitPrice">$'+e.price+'</span>&nbsp;&nbsp;|&nbsp;&nbsp;<strong>Qty: </strong><span id="qty">'+e.quantity+'</span>&nbsp;&nbsp;|&nbsp;&nbsp;<strong>Total: </strong><span id="total">$'+(d*e.quantity).toFixed(2).replace(/\d\d\d\d\./,function(g){return g.charAt(0)+","+g.substring(1,5)})+'</span></div><div class="clearBoth"></div></div><div class="clearBoth"></div>';return b.appendChild(c)}}a.show=function(){this.dialog.setBody(document.getElementById("addToRegistryModal").innerHTML);this.dialog.render(document.body);this.dialog.show();this.dialog.subscribe("hide",a.hide);YAHOO.util.Event.addListener("continueShopping","click",a.hide);YAHOO.util.Event.addListener("viewRegistry","click",a.goToRegistry);YAHOO.util.Event.on(document,"click",function(d){var b=YAHOO.util.Dom.get("addToRegOvelay");if(b){var c=YAHOO.util.Event.getTarget(d);if(!(c===b||YAHOO.util.Dom.isAncestor("addToRegOvelay",c))){a.hide()}}})};a.hide=function(){a.dialog.destroy();BLOOMIES.resetForm()};a.goToRegistry=function(b){if(a.registryId){window.location=BLOOMIES.addToRegistry.viewRegistryUrl}a.hide();BLOOMIES.loading.show()};a.setAddedCount=function(e,f){var c=YAHOO.util.Dom.getElementsByClassName("totalQtyInfo","span");if(f>0){var b=YAHOO.util.Dom.getElementsByClassName("nonRegQtyInfoDiv","div")[0];if(b){YAHOO.util.Dom.removeClass(b,"hiddenNonReg");var d=YAHOO.util.Dom.getElementsByClassName("nonRegQtyInfoSpan","span")[0];if(d){d.innerHTML=(f===1?"1 item has not been added to your registry because it is not available for registry.":f+" items have not been added to your registry because they are not available for registry.")}}}else{c=YAHOO.util.Dom.getElementsByClassName("nonRegQtyInfoDiv","div")[0];if(c){YAHOO.util.Dom.addClass(c,"hiddenNonReg")}}};a.setAnalytics=function(c){var b=document.getElementById("regAnalytics");if(b){b.innerHTML="<img src='https://e.bloomingdalesbridal.com/a/r392917834/bloombridal.gif?orderid="+a.registryId+"&amount=null&items="+c+"&page=ProductAddition'  />"}};a.setRegistryId=function(b){this.registryId=b};return a})();BLOOMIES.addToRegistry.overlayClaim=(function(){var a={};a.init=function(){YAHOO.util.Dom.removeClass(YAHOO.util.Dom.get("registryClaim"),"hiddenClaim");this.panel=new YAHOO.widget.Panel("registryClaim",{effect:{effect:YAHOO.widget.ContainerEffect.FADE,duration:0.2},modal:true,fixedcenter:true,underlay:"shadow",draggable:false,monitorresize:false,close:false})};a.show=function(){a.init();
this.panel.render();this.panel.show();YAHOO.util.Event.addListener(YAHOO.util.Dom.getElementsByClassName("registryClaimClose","a",this.panel.element),"click",this.hide,this,true);YAHOO.util.Event.addListener("accessRegistryButton","click",this.goToClaim,this,true);YAHOO.util.Event.addListener("createRegistryButton","click",this.goToCreate,this,true)};a.hide=function(b){if(b){YAHOO.util.Event.preventDefault(b)}this.panel.hide();BLOOMIES.resetForm()};a.goToClaim=function(c){if(c){YAHOO.util.Event.preventDefault(c)}a.hide();var b=YAHOO.util.Dom.get("registryClaimForm");if(b){b.action=secureServer+BLOOMIES.addToRegistry.weddingAddToRegistryUrl+"?registryClaim=YES";b.submit()}return};a.goToCreate=function(c){if(c){YAHOO.util.Event.preventDefault(c)}this.hide();var b=YAHOO.util.Dom.get("registryClaimForm");if(b){b.action=secureServer+BLOOMIES.addToRegistry.weddingAddToRegistryUrl+"?registryClaim=NO";b.submit()}return};return a})();BLOOMIES.loading={show:function(){loadingWheelOverlay=new YAHOO.widget.Panel("loading",{fixedcenter:true,modal:true,close:false,underlay:"none",monitorresize:false,draggable:true});loadingWheelOverlay.setBody('<img src="'+assetsServer+'/web20/assets/img/ajax-loader.gif" />');loadingWheelOverlay.render(document.body);loadingWheelOverlay.show()},hide:function(){loadingWheelOverlay.destroy()}};
