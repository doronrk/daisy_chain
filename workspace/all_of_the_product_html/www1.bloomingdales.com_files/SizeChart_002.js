define(["jquery","underscore","backbone","bcomPanel","logger","cookie","bcomCoremetrics","commonjs/models/SizeChart","bcomTemplates/features/pdp/SizeChart","bcomPDP/hbsHelpers/pdpHelpers"],function(e,t,a,n,r,i,o,s,l,c){function d(t){var a=t.closest(".memberProducts");return(a.length?a.find("[name=memberProductId]"):e("#productId")).val()}var u=a.View.extend({el:"body",events:{"click #pdp_main img.newSizeChartLink":"showChart","click #new_panel_overlay_size":"clickPanel","click #new_panel_overlay_size .button-group .button":"changeMeasurementUnit","click #new_panel_overlay_size .newSizePrintBtn":"clickPrintGuide","click #new_panel_overlay_size .newSizeLabel":"toggleLocaleDropdown","click #new_panel_overlay_size .newSizeInput":"toggleLocaleDropdown","click #new_panel_overlay_size .newSizeDropdown .ui-menu-item":"setLocale","click #new_panel_overlay_size .tabHeaderItem":"changeTab","change #new_panel_overlay_size .newSizeDropdown":"changeLocale"},template:l,sizeChartPanel:"",clickPanel:function(t){e(t.currentTarget).find(".newSizeDropdown").hide()},setLocale:function(t){var a=this,n=e(t.currentTarget),r=n.closest(".newSizeSelect"),i=r.closest(".stepContainer"),s=n.data("value");if(t.type){t.stopPropagation();var l="international_sizes-",c=o.attributes({29:a.productId});o.elementTag({elementId:l+s,categoryId:"PDP_size_chart",attributes:c});if(a.model.stepsEnabled){var d=(i.data("step-num")|0)+1;o.elementTag({elementId:l+"step"+d+"-"+s,categoryId:"PDP_size_chart",attributes:c})}}if(r.find(".ui-menu-item.selected").data("value")===s){a.toggleLocaleDropdown({currentTarget:i.find(".newSizeLabel")});return}r.find(".ui-menu-item").removeClass("selected");n.addClass("selected");r.find(".newSizeInput").val(n.find(".suggestion").text().trim());a.toggleLocaleDropdown({currentTarget:i.find(".newSizeLabel")});a.changeLocale({currentTarget:n.closest(".newSizeDropdown")})},_dropdownIsOutScreen:function(e){return e.parent().offset().top+e.height()>jQuery(window).scrollTop()+window.innerHeight},toggleLocaleDropdown:function(t){var a=e(t.currentTarget).closest(".stepContainer").find(".newSizeDropdown").removeClass("upwards downwards");if(a.is(":visible")){a.hide()}else{a.addClass(this._dropdownIsOutScreen(a)?"upwards":"downwards");a.show()}return false},changeLocale:function(t){var a=e(t.currentTarget),n=a.closest(".stepContainer"),r=n.find(".button-group .button"),i=n.find(".newSizeLocaleCol:not(.newSizeCol_US)"),o=a.find(".selected").data("value"),s=i.length;i.fadeOut({complete:function(){s--;if(!s){if(o.toUpperCase()!=="INTERNATIONAL SIZES"){r.filter("[value=cm]").click();n.find(".newSizeCol_"+o).fadeIn()}else{r.filter("[value=in]").click()}}}})},changeMeasurementUnit:function(t){var a=e(t.currentTarget),n=a.closest(".stepContainer"),r=n.find(".active"),i=r[0].value,s=a[0].value;if(t.type){o.elementTag({elementId:"convert_to_"+(s.toLowerCase()==="cm"?"centimeters":"inches"),categoryId:"PDP_size_chart",attributes:o.attributes({29:this.productId})})}if(s===i){return}n.find(".newSizeTable").removeClass(i).addClass(s);a.addClass("active");r.removeClass("active")},clickPrintGuide:function(){o.elementTag({elementId:"print_guide",categoryId:"PDP_size_chart",attributes:o.attributes({29:this.productId})})},changeTab:function(t){t.stopPropagation();var a=this,n=e(t.currentTarget),r=n.data("tab")|0;if(r===a.model.get("currentTab")){return}if(t.type){o.elementTag({elementId:"size_chart-"+n.text(),categoryId:"PDP_size_chart",attributes:o.attributes({29:a.productId})})}a.model.set("currentTab",r);a.model.set("currentSizeChartData",[a.model.get("sizeChartData")[r]]);a.render();a.resetChart(true);e(".tabBody",this.sizeChartPanel.body).fadeIn(200)},render:function(){var t=this.model.get("brandName")+": "+this.model.get("categoryName");this.sizeChartPanel.setHeader(t);this.sizeChartPanel.setBody(this.template(this.model.toJSON()));var a=e(this.sizeChartPanel.body);a.find(".newSizeLocaleCol:not(.newSizeCol_US)").hide();a.find(".button-group .button").removeClass("active").filter("[value='in']").addClass("active");return this},resetChart:function(t){var a=this,n=e(a.sizeChartPanel.body),r=function(){},i=!a.autoInternetional||a.autoInternetional.toUpperCase()==="US",o="INTERNATIONAL SIZES",s=i?o:a.autoInternetional,l=i?"in":"cm",c=n.find(".tabHeaderItem");if(c.length&&!t){a.changeTab({stopPropagation:r,currentTarget:c.get(0)})}n.find(".stepContainer").each(function(){var e=jQuery(this),t=e.find('.newSizeDropdown .ui-menu-item[data-value="'+s+'"]'),n=e.find(".button-group .button[value='"+l+"']");if(!t.length&&s!==o){t=e.find('.newSizeDropdown .ui-menu-item[data-value="'+o+'"]')}if(t.length){a.setLocale({stopPropagation:r,currentTarget:t})}if(n.length){a.changeMeasurementUnit({stopPropagation:r,currentTarget:n})}e.find(".newSizeDropdown").hide()})},initChart:function(e){var t=this;t.sizeChartPanel=n.create("new_panel_overlay_size",{fixedcenter:true,modal:true,draggable:false,closeOnClick:true,overlayClass:"bl_overlayNew sizeChartNew",width:725,close:function(){t.resetChart()}})},showChart:function(t){var a=this,n=e(t.currentTarget),r=n.closest(".pdp_master_size, .pdp_member_size").find("#sizeChartCanvasId").val();a.productId=d(n);if(a.currentCanvasId!==r){a.currentCanvasId=r;a.model=new s(r,true);a.model.fetch({success:function(){if(!a.sizeChartPanel){a.initChart(t)}a.render();a.sizeChartPanel.render(document.body);e(".tabBody",a.sizeChartPanel.body).show();a.autoInternetional=i.get("shippingCountry")||"US";if(a.autoInternetional.toUpperCase()==="GB"){a.autoInternetional="UK"}a.resetChart();o.pageViewTag({pageId:e("#pageId").val(),categoryId:"PDP_size_chart",attributes:o.attributes({3:a.productId})});t.stopPropagation();a.sizeChartPanel.show()}});return}o.pageViewTag({pageId:e("#pageId").val(),categoryId:"PDP_size_chart",attributes:o.attributes({3:a.productId})});t.stopPropagation();a.sizeChartPanel.show()}});return u});