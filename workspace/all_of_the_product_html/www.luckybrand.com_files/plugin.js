;var NetotiateWindow=(function(myNetotiateWindow){var privateVars={},privateMethods={};privateMethods.construct=function(){myNetotiateWindow.postMessage=myNetotiateWindow.postMessage||function(target,type,message){pm({target:target,type:type,data:message});}
myNetotiateWindow.bind=myNetotiateWindow.bind||function(type,handler){pm.bind(type,handler);};myNetotiateWindow.createClient=function(){var privateVars={},privateMethods={};privateVars.server={};var myClient={};myClient.events={};myClient.events.broadcast=function(type,message,callback){myNetotiateWindow.postMessage(privateVars.server,'netotiate_window_server.dispatch',{type:type,message:message});myNetotiateWindow.bind(type+'.result',function(data){if(typeof callback=='function')
callback(data);});}
myClient.events.subscribe=function(type,handler){myNetotiateWindow.bind(type,function(message){var result=handler(message.message);if(result)
myNetotiateWindow.postMessage(privateVars.server,type+'.window.'+message.wid+'.result',result);});}
privateVars.server=window.parent;return myClient;};return myNetotiateWindow;}
return privateMethods.construct();}(NetotiateWindow||{}));;var NetotiateWindow=(function(myNetotiateWindow){var privateMethods={},privateVars={};privateMethods.construct=function(){myNetotiateWindow.postMessage=myNetotiateWindow.postMessage||function(target,type,message){pm({target:target,type:type,data:message});}
myNetotiateWindow.bind=myNetotiateWindow.bind||function(type,handler){myNetotiateWindow.pm.bind(type,handler);};myNetotiateWindow.createServer=function(){var privateVars={},privateMethods={};var myServer={};privateVars.windows=[];privateMethods.construct=function(){privateVars.windows[0]=window;privateMethods.bindDispatch();return myServer;}
privateMethods.dispatch=function(type,message){for(wid in privateVars.windows){var w=privateVars.windows[wid];myNetotiateWindow.postMessage(w,type,{message:message,wid:wid});myNetotiateWindow.bind(type+'.window.'+wid+'.result',function(message){privateMethods.dispatch(type+'.result',message);});}};privateMethods.bindDispatch=function(){myNetotiateWindow.bind('netotiate_window_server.dispatch',function(message){privateMethods.dispatch(message.type,message.message);});}
myServer.registerAllWindows=function(){var iframes=document.getElementsByClassName('netotiate-window-client');var start=privateVars.windows.length;for(var iid=start;iid<start+iframes.length;iid++){privateVars.windows[iid]=iframes[iid].contentWindow;}}
myServer.registerWindow=function(id){var iframe=document.getElementById(id);var start=privateVars.windows.length;privateVars.windows[start]=iframe.contentWindow;}
return privateMethods.construct();}
return myNetotiateWindow;}
return privateMethods.construct();}(NetotiateWindow||{}));;var Netotiate=Netotiate||{};Netotiate.Plugin=Netotiate.Plugin||{};Netotiate.Plugin.Validator={};Netotiate.Plugin.Validator.isAuthorizedRetailer=function(retailerId){for(var i=0;i<Netotiate.Plugin.authorizedRetailers.length;i++){if(retailerId==Netotiate.Plugin.authorizedRetailers[i].id)
return true;}
return false;};Netotiate.Plugin.Validator.isNumber=function(number){return!isNaN(number);};Netotiate.Plugin.Validator.isBoolean=function(booleanVar){return(((booleanVar!==undefined)&&(booleanVar!==null))&&(booleanVar==0||booleanVar==1));};Netotiate.Plugin.Validator.isJsonObject=function(str){try{if("object"===typeof Netotiate.Plugin.JSON.parse(str))
return true;else
return false;}
catch(e){return false;}};Netotiate.Plugin.Validator.isAlphaNumeric=function(str){return str!=null&&str.match("^[a-zA-Z0-9]+$");};Netotiate.Plugin.Validator.isPositiveNumber=function(positiveNnumber){return Netotiate.Plugin.Validator.isNumber(positiveNnumber)&&positiveNnumber>0;};Netotiate.Plugin.Validator.isMonetary=function(monetaryValue){var asStr=''+monetaryValue;asStr=parseFloat(asStr.replace(/[^0-9\.]+/g,""));return Netotiate.Plugin.Validator.isNumber(asStr)&&asStr>0;};Netotiate.Plugin.Validator.isUrl=function(url){return Netotiate.Plugin.Validator.NetotiateElement.isExist(url)&&(url.match(/^((ht|f)tps?:)?\/\/[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/)!==null||decodeURIComponent(url).match(/^((ht|f)tps?:)?\/\/[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/)!==null);};Netotiate.Plugin.Validator.isNonEmptyString=function(str){return((typeof str=="string")&&(str.length>0));};Netotiate.Plugin.Validator.NetotiateElement={};Netotiate.Plugin.Validator.NetotiateElement.isExist=function(param){return(param!==undefined&&param!=null&&param!='');};Netotiate.Plugin.Validator.NetotiateElement.isEmail=function(param){var pattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i;if(param.length!==0&&!pattern.test(param))
return false;return true;};Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams=function(parameters){var paramsToValidate=Netotiate.$.extend(true,{},parameters);var isValid=true;if(paramsToValidate===null||paramsToValidate===undefined){Netotiate.Plugin.Logger.error('wrong object given, could not read parameters. object given for validation is: ['+paramsToValidate+']');return false;}
Netotiate.$.each(paramsToValidate,function(key,value){if(!Netotiate.Plugin.Validator.NetotiateElement.isExist(paramsToValidate)){isValid=false;Netotiate.Plugin.Logger.warn(key+' is missing, input: '+value);}});if(!Netotiate.Plugin.Validator.isNonEmptyString(paramsToValidate.sku)){isValid=false;Netotiate.Plugin.Logger.warn('sku is not a non-empty string, input: '+paramsToValidate.sku);}
if(!Netotiate.Plugin.Validator.isMonetary(paramsToValidate.productPrice)){isValid=false;Netotiate.Plugin.Logger.warn('productPrice is not a valid positive number, input: '+paramsToValidate.productPrice);}
if(!Netotiate.Plugin.Validator.isNonEmptyString(paramsToValidate.productTitle)){isValid=false;Netotiate.Plugin.Logger.warn('productTitle is not a non-empty string, input: '+paramsToValidate.productTitle);}
return isValid;};Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams=function(parameters){var paramsToValidate=Netotiate.$.extend(true,{},parameters);var isValid=true;var isExist=Netotiate.Plugin.Validator.NetotiateElement.isExist;if(paramsToValidate===null||paramsToValidate===undefined){try{var stringParams=Netotiate.Plugin.JSON.stringify(paramsToValidate);}catch(e){stringParams=paramsToValidate;}
Netotiate.Plugin.Logger.warn('Could not read parameters. object given for validation is: ['+stringParams+']');return false;}
if(isExist(paramsToValidate.cartUrl)){if(!Netotiate.Plugin.Validator.isUrl(paramsToValidate.cartUrl)){isValid=false;Netotiate.Plugin.Logger.warn('cartUrl is not a valid URL, input: '+paramsToValidate.cartUrl);}}
if(isExist(paramsToValidate.productBrand)){if(!Netotiate.Plugin.Validator.isNonEmptyString(paramsToValidate.productBrand)){isValid=false;Netotiate.Plugin.Logger.warn('productBrand is not a non-empty string, input: '+paramsToValidate.productBrand);}}
if(isExist(paramsToValidate.cartParams)){if(!Netotiate.Plugin.Validator.isJsonObject(paramsToValidate.cartParams)){isValid=false;Netotiate.Plugin.Logger.warn('cartParams is not a valid JSON object, input: '+paramsToValidate.cartParams);}}
if(isExist(paramsToValidate.productImgUrl)){if(!Netotiate.Plugin.Validator.isUrl(paramsToValidate.productImgUrl)){isValid=false;Netotiate.Plugin.Logger.warn('productImgUrl is not a valid URL, input: '+paramsToValidate.productImgUrl);}}
if(isExist(paramsToValidate.productDesc)){if(!Netotiate.Plugin.Validator.isNonEmptyString(paramsToValidate.productDesc)){isValid=false;Netotiate.Plugin.Logger.warn('productDesc is not a non-empty string, input: '+paramsToValidate.productDesc);}}
if(isExist(paramsToValidate.productShipping)){if(!Netotiate.Plugin.Validator.isMonetary(paramsToValidate.productShipping)&&!Netotiate.Plugin.Validator.isNumber(paramsToValidate.productShipping)){isValid=false;Netotiate.Plugin.Logger.warn('productShipping is not a valid number, input: '+paramsToValidate.productShipping);}}
if(isExist(paramsToValidate.productAmp)){if(!Netotiate.Plugin.Validator.isNumber(paramsToValidate.productAmp)){isValid=false;Netotiate.Plugin.Logger.warn('productAmp is not a valid number, input: '+paramsToValidate.productAmp);}}
if(isExist(paramsToValidate.productTax)){if(!Netotiate.Plugin.Validator.isMonetary(paramsToValidate.productTax)&&!Netotiate.Plugin.Validator.isNumber(paramsToValidate.productTax)){isValid=false;Netotiate.Plugin.Logger.warn('productTax is not a valid number, input: '+paramsToValidate.productTax);}}
if(isExist(paramsToValidate.freeShipping)){if(!Netotiate.Plugin.Validator.isBoolean(paramsToValidate.freeShipping)){isValid=false;Netotiate.Plugin.Logger.warn('freeShipping is not a valid boolean (0 or 1), input: '+paramsToValidate.freeShipping);}}
if(isExist(paramsToValidate.categoryId)){if(!Netotiate.Plugin.Validator.isNonEmptyString(paramsToValidate.categoryId)){isValid=false;Netotiate.Plugin.Logger.warn('categoryId is not a valid non-empty string, input: '+paramsToValidate.categoryId);}}
if(isExist(paramsToValidate.email)){if(!Netotiate.Plugin.Validator.NetotiateElement.isEmail(paramsToValidate.email)){isValid=false;Netotiate.Plugin.Logger.warn('email is not a valid email, input: '+paramsToValidate.email);}}
if(isExist(paramsToValidate.waitFor)){var isArray=false;try{isArray=((eval(paramsToValidate.waitFor))instanceof Array);if(isArray&&Netotiate.Plugin.Validator.NetotiateElement.isExist(Netotiate.Plugin.displayConfig.tab)){Netotiate.Plugin.Logger.warn('waitFor is currently not supported for tab display, input: '+paramsToValidate.waitFor);isValid=false;}}catch(e){isArray=false;}
if(!isArray){isValid=false;Netotiate.Plugin.Logger.warn('waitFor is not a valid JS Array, input: '+paramsToValidate.waitFor);}}
return isValid;};;var Netotiate=Netotiate||{};Netotiate.Plugin=Netotiate.Plugin||{};Netotiate.Plugin.Mouse={};Netotiate.Plugin.Mouse.diffY=0;Netotiate.Plugin.Mouse.lastY=0;Netotiate.Plugin.Mouse.nextY=0;Netotiate.Plugin.Mouse.diffX=0;Netotiate.Plugin.Mouse.lastX=0;Netotiate.Plugin.Mouse.nextX=0;Netotiate.Plugin.hookOnMouseLeave=function(){if(Netotiate.ArenaElementSet.length<1){return;}
this.hook=function(){Netotiate.$(window).bind("mousemove",function(e){if(!Netotiate.Plugin.Impressions.isEligible)
return;var y=e.clientY;var x=e.clientX;Netotiate.Plugin.Mouse.diffY=(Netotiate.Plugin.Mouse.diffY)*(1/3)+(y-Netotiate.Plugin.Mouse.lastY)*(2/3);Netotiate.Plugin.Mouse.diffX=(Netotiate.Plugin.Mouse.diffX)*(1/3)+(x-Netotiate.Plugin.Mouse.lastX)*(2/3);Netotiate.Plugin.Mouse.nextX=x+Netotiate.Plugin.Mouse.diffX;Netotiate.Plugin.Mouse.nextY=y+Netotiate.Plugin.Mouse.diffY;Netotiate.Plugin.Mouse.lastX=x;Netotiate.Plugin.Mouse.lastY=y;if(Netotiate.Plugin.Mouse.nextY<0&&Netotiate.Plugin.Mouse.nextX>100){Netotiate.Plugin.Mouse.diffY=0;Netotiate.Plugin.Mouse.lastY=0;Netotiate.Plugin.Mouse.diffX=0;Netotiate.Plugin.Mouse.lastX=0;if(Netotiate.ArenaElementSet.length==1){Netotiate.ArenaElementSet[0].action();NetotiateWindow.client.events.broadcast('netotiate.plugin.trigger_on_exit.prompt',{affiliateId:Netotiate.Plugin.affiliateId,sg:Netotiate.Plugin.SampleGroup.name,sku:Netotiate.ArenaElementSet[0].params.sku,cid:Netotiate.ArenaElementSet[0].params.categoryId,price:Netotiate.ArenaElementSet[0].params.productPrice*100});Netotiate.Plugin.ABtests.triggerCapping.increaseCounter();}
else if(Netotiate.ArenaElementSet.length>1){Netotiate.Plugin.showIncentive();Netotiate.Plugin.ABtests.triggerCapping.increaseCounter();}
Netotiate.Plugin.unHookOnMouseLeave();}});};this.hook();};Netotiate.Plugin.unHookOnMouseLeave=function(){this.unHook=function(){Netotiate.$(window).unbind("mousemove");};this.unHook();};;var Netotiate=Netotiate||{};Netotiate.Plugin=Netotiate.Plugin||{};Netotiate.Plugin.Logger={};Netotiate.Plugin.Logger.log=function(msg,level){if(typeof console!=="undefined"&&msg!==""){if(Netotiate.Plugin.debug){if(level===undefined||level===null||level===''){level='DEBUG';}
console.log('['+level.toUpperCase()+'] : '+msg);}}};Netotiate.Plugin.Logger.warn=function(warnMsg){Netotiate.Plugin.Logger.log(warnMsg,'WARN');};Netotiate.Plugin.Logger.debug=function(debugMsg){Netotiate.Plugin.Logger.log(debugMsg,'DEBUG');};Netotiate.Plugin.Logger.error=function(errorMsg){Netotiate.Plugin.Logger.log(errorMsg,'ERROR');};;var Netotiate=Netotiate||{};Netotiate.Plugin=Netotiate.Plugin||{};Netotiate.Plugin.callBacks={};Netotiate.Plugin.displayConfig={};Netotiate.Plugin.ABtests={};Netotiate.Plugin.ABtests.triggerCapping={};Netotiate.Plugin.ABtests.triggerCapping.counter=1;Netotiate.Plugin.ABtests.triggerCapping.increaseCounter=function(){pm({target:Netotiate.Plugin.Arena,type:'storage_update',data:{db:'ntcrs',key:'troe',ttl:1,data:Netotiate.Plugin.ABtests.triggerCapping.counter+''}});};Netotiate.Plugin.ABtests.triggerCapping.start=function(maxTriggers){Netotiate.Plugin.callBacks['triggerCounter']=function(value){if(value!=null&&!isNaN(value))
Netotiate.Plugin.ABtests.triggerCapping.counter=parseInt(value)+1;if(Netotiate.Plugin.ABtests.triggerCapping.counter>maxTriggers)
return;Netotiate.Plugin.hookOnMouseLeave();};pm({target:Netotiate.Plugin.Arena,type:'storage_get_value_callback',data:{db:'ntcrs',key:'troe',ttl:1,callback:'triggerCounter'}});};Netotiate.Plugin.triggerButtonShow=function(){try{Netotiate.Events.trigger('netotiate.events.button_show');Netotiate.Events.trigger('netotiate.plugin.initiator.show');return true;}
catch(e){return false;}};Netotiate.Plugin.dialogWidth=628;Netotiate.Plugin.dialogHeight=440;Netotiate.Plugin.autoScrollOn=function(){Netotiate.$(window).bind("scroll.arena resize.arena",function(event){Netotiate.$('#netotiate_iframe').stop().animate({top:Netotiate.$(document).scrollTop()+(window.innerHeight||document.documentElement.clientHeight)/2-Netotiate.Plugin.dialogHeight/2+'px',left:Netotiate.$(document).scrollLeft()+(window.innerWidth||document.documentElement.clientWidth)/2-Netotiate.Plugin.dialogWidth/2+'px'},900);});};Netotiate.Plugin.autoScrollOff=function(){Netotiate.$(window).unbind("scroll.arena resize.arena");};Netotiate.Plugin.scrollToFirstButtonAndClose=function(){function scrollToFirsButton(){$('html, body').animate({scrollTop:$(".netotiate-button-iframe").offset().top-250},2000);}
Netotiate.Plugin.hide(scrollToFirsButton);}
Netotiate.API={};Netotiate.API.GenericResponse=function(response){if(!response||!response.header||response.header=="undefined"||!response.header.code||response.header.code=="undefined"||response.header.code!='success')
return null;return response;};Netotiate.Plugin.options=Netotiate.Plugin.options||{};Netotiate.Plugin.ver='1.0';Netotiate.Plugin.cacheIdentifier='1411041447';Netotiate.Plugin.Env={};Netotiate.Plugin.Env.siteBaseUrl='//www.netotiate.com';Netotiate.Plugin.Env.apiBaseUrl='//api.netotiate.com';Netotiate.Plugin.Env.pluginBaseUrl='//plugin.netotiate.com';Netotiate.Plugin.Env.reportBaseUrl='//report.netotiate.com';Netotiate.Plugin.Env.staticCdnBaseUrl='//static.netotiate.com';Netotiate.Plugin.authKey=null;Netotiate.Plugin.retailerName=null;Netotiate.Plugin.merchantLogoUrl='';Netotiate.Plugin.merchantPhone='';Netotiate.Plugin.getCurrentUrl=function(){return window.location.href;};Netotiate.Plugin.isRetarget=function(){return Netotiate.Plugin.getCurrentUrl().indexOf('_ntr=1')>-1?1:0;};Netotiate.Plugin.Actions={};Netotiate.Plugin.Actions.getFacts=function(){var facts=[];var isRetarget=Netotiate.Plugin.isRetarget();Netotiate.$.each(Netotiate.ArenaElementSet,function(key,value){var item={};item.ownerId=value.getUniqueId();item.retarget=isRetarget;item.affiliateId=Netotiate.Plugin.affiliateId;item.platform=Netotiate.Plugin.device+'Web';item.facts={};item.facts.productPrice=encodeURIComponent(value.params.productPrice);item.facts.brand=encodeURIComponent(value.params.productBrand);item.facts.sku=value.params.sku;item.facts.category=encodeURIComponent(value.params.categoryId);if(Netotiate.Plugin.SampleGroup.name)
item.facts.group=Netotiate.Plugin.SampleGroup.name;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(value.params.productAmp))
item.facts.productAmp=encodeURIComponent(value.params.productAmp);if(Netotiate.Plugin.Validator.NetotiateElement.isExist(value.params.flex1))
item.facts.flex1=encodeURIComponent(value.params.flex1);if(Netotiate.Plugin.Validator.NetotiateElement.isExist(value.params.flex2))
item.facts.flex2=encodeURIComponent(value.params.flex2);if(Netotiate.Plugin.Validator.NetotiateElement.isExist(value.params.flex3))
item.facts.flex3=encodeURIComponent(value.params.flex3);if(Netotiate.Plugin.Validator.NetotiateElement.isExist(value.params.flex4))
item.facts.flex4=encodeURIComponent(value.params.flex4);facts.push(item);});return facts;};Netotiate.Plugin.Actions.tasks=new Array();Netotiate.Plugin.Actions.isEligibleTask=function(task){if(task.actionType==="show"&&task.additionalData.eligible==="true")
return true;return false;};Netotiate.Plugin.Actions.doTask=function(task,targetElement,altDelay){var attributes=task.additionalData;var rules=task.rules;var actionType=task.actionType;var executed=false;delay=typeof altDelay=="number"?altDelay:attributes.delayTime;var showElement=function(){if(Netotiate.Plugin.Validator.NetotiateElement.isExist(Netotiate.Plugin.displayConfig.button)){targetElement.show();return;}
if(Netotiate.Plugin.Validator.NetotiateElement.isExist(Netotiate.Plugin.displayConfig.tab)){if('open'===Netotiate.Plugin.displayConfig.tab.defaultState){Netotiate.SideWidget.action.open();}else{Netotiate.SideWidget.action.show();}};};if(actionType=="show"){if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.high))
targetElement.params.barHigh=attributes.high;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.max))
targetElement.params.barMin=attributes.max;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.show)){if(attributes.eligible!=null&&attributes.eligible=="true"){Netotiate.Plugin.Impressions.isEligible=true;}
if(attributes.show=="true"){Netotiate.Plugin.Impressions.isVisible=true;executed=true;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.delayTime))
setTimeout(showElement,delay*1000);else
showElement(delay);};};};if(executed&&rules)
Netotiate.Plugin.Logger.log("Decision for displaying the element with SKU "+targetElement.params.sku+" was based on the following display rules: "+rules.join(", "));else
Netotiate.Plugin.Logger.log("Netotiating was disabled for element with SKU : "+targetElement.params.sku);};Netotiate.Plugin.SampleGroup={};Netotiate.Plugin.SampleGroup.name='';Netotiate.Plugin.SampleGroup.ttl='';Netotiate.Plugin.SampleGroup.contains=function(string){return Netotiate.Plugin.SampleGroup.name.indexOf(string)>-1;}
Netotiate.Plugin.SampleGroup.load=function(tasks){if(tasks.length==0)
return;var task=tasks[0];var attributes=task.additionalData;if(task.actionType!="show")
return;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.group)){Netotiate.Plugin.SampleGroup.name=attributes.group;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(attributes.days)){Netotiate.Plugin.SampleGroup.ttl=attributes.days;};};};Netotiate.Plugin.SampleGroup.report=function(){if(Netotiate.Plugin.SampleGroup.name!=''){pm({target:Netotiate.Plugin.Arena,type:"sg_set",data:{ttl:parseInt(Netotiate.Plugin.SampleGroup.ttl),gn:Netotiate.Plugin.SampleGroup.name}});}};Netotiate.Plugin.affiliateId=null;Netotiate.Plugin.affiliateName='';Netotiate.Plugin.iframeReady=false;Netotiate.Plugin.debug=false;Netotiate.Plugin.initializing=false;Netotiate.Plugin.isAuthenticated=null;Netotiate.Plugin.Arena=null;Netotiate.Plugin.Impressions={};Netotiate.Plugin.Impressions.collectPageImpressions=function(){pm({target:Netotiate.Plugin.Arena,type:"storage_get_value",data:{"db":"nudb","key":"imp","ttl":5}});pm.bind("storage_value",function(data){var impressions=new Array();if(data!=""&&data!=null){impressions=Netotiate.Plugin.JSON.parse(data);}
Netotiate.$.each(Netotiate.ArenaElementSet,function(key,value){impressions.push(value.params.sku);});impressions=Netotiate.$.grep(impressions,function(el,index){return index==$.inArray(el,impressions);});NetotiateWindow.client.events.broadcast('netotiate.plugin.impressions.collection',{affiliateId:Netotiate.Plugin.affiliateId,impressions:impressions});Netotiate.Plugin.Storage.update("nudb","imp",5,Netotiate.Plugin.JSON.stringify(impressions));});pm.bind("storage_value_callback",function(data){if(data.callback&&typeof Netotiate.Plugin.callBacks[data.callback]=="function")
Netotiate.Plugin.callBacks[data.callback](data.value);});};Netotiate.Plugin.Impressions.isVisible=false;Netotiate.Plugin.Impressions.isEligible=false;Netotiate.Plugin.Impressions.isReported=false;Netotiate.Plugin.Storage={};Netotiate.Plugin.Storage.update=function(storageDb,storageKey,ttl,storageData){pm({target:Netotiate.Plugin.Arena,type:"storage_update",data:{"db":storageDb,"key":storageKey,"data":storageData,"ttl":ttl}});};Netotiate.Plugin.Impressions.report=function(){var skus=new Array();Netotiate.$.each(Netotiate.ArenaElementSet,function(key,value){skus.push(value.params.sku);});if(!Netotiate.Plugin.Impressions.isReported){NetotiateWindow.client.events.broadcast('netotiate.plugin.impressions.view',{affiliateId:Netotiate.Plugin.affiliateId,sg:Netotiate.Plugin.SampleGroup.name,cid:Netotiate.Plugin.options.categoryId,skus:skus.join(';'),eligibility:Netotiate.Plugin.Impressions.isEligible?"eligible":"noneligible",impression:Netotiate.Plugin.Impressions.isVisible?"True":"False"});Netotiate.Plugin.Impressions.isReported=true;}};Netotiate.Plugin.onArenaReadyState=function(){NetotiateWindow.server.registerWindow('netotiate_iframe');Netotiate.Plugin.Impressions.collectPageImpressions();Netotiate.Plugin.Impressions.report();Netotiate.Plugin.SampleGroup.report();if(Netotiate.Plugin.Actions.tasks[0]&&Netotiate.Plugin.Actions.tasks[0].additionalData.triggerOnExit=='true'){var match=/.*exit([1-9]+[0-9]*).*/g.exec(Netotiate.Plugin.SampleGroup.name);if(match!=null)
Netotiate.Plugin.ABtests.triggerCapping.start(parseInt(match[1]));}};Netotiate.Plugin.onHubReadyState=function(){NetotiateWindow.server.registerWindow('netotiate-hub');var onConnectEnd=function(){try{Netotiate.Plugin.validateNetotiableElementsSetup();var elem=null;Netotiate.$.each(Netotiate.Plugin.Actions.tasks,function(key,task){elem=Netotiate.ArenaElement.findBId(task.ownerId);if(elem&&!Netotiate.Plugin.Actions.isEligibleTask(task))
Netotiate.ArenaElementSet=Netotiate.ArenaElement.deleteById(task.ownerId);});Netotiate.Plugin.options.categoryId=elem?elem.params.categoryId:'';Netotiate.Plugin.options.context=window.location.href;Netotiate.Plugin.options.lc=Netotiate.Plugin.locale;Netotiate.Plugin.options.merchantName=Netotiate.Plugin.affiliateName;Netotiate.Plugin.options.merchantLogoUrl=Netotiate.Plugin.merchantLogoUrl;Netotiate.Plugin.options.merchantPhone=Netotiate.Plugin.merchantPhone;Netotiate.Plugin.options.merchantId=Netotiate.Plugin.merchantId;if(Netotiate.Plugin.displayConfig)
Netotiate.Plugin.options.displayConfig=Netotiate.Plugin.displayConfig;Netotiate.Plugin.SampleGroup.load(Netotiate.Plugin.Actions.tasks);Netotiate.Plugin.options.sampleGroup=Netotiate.Plugin.SampleGroup.name;Netotiate.Plugin.initializeIframe();Netotiate.$.each(Netotiate.ArenaElementSet,function(key,arenaElement){var isMandatoryValid=Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams(arenaElement.params);var isOptionalValid=Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams(arenaElement.params);if(isMandatoryValid&&isOptionalValid&&Netotiate.Plugin.displayConfig.button)
arenaElement.create();});if(Netotiate.Plugin.displayConfig.tab){Netotiate.Plugin.loadWidget();}
else{Netotiate.Plugin.drawElements();Netotiate.Plugin.bindExternalEvents();Netotiate.Plugin.loadCustomCode(Netotiate.Plugin.options.affiliateId);if(window.onNetotiateReadyState!=null&&typeof window.onNetotiateReadyState=='function')
window.onNetotiateReadyState();}}catch(e){Netotiate.Plugin.Logger.error('Netotiate plugin initializing failed, could not parse parameters due to exception: '+e.message);return false;}};Netotiate.Plugin.connect(Netotiate.Plugin.options.affiliateId,Netotiate.Plugin.ver,Netotiate.Plugin.authKey,Netotiate.Plugin.JSON.stringify(Netotiate.Plugin.Actions.getFacts()),Netotiate.Plugin.debug?1:0,onConnectEnd);};Netotiate.ArenaElementSet=[];Netotiate.ArenaElement=function(type,domElement,rawParams){this.getUniqueId=function(){if(this.id===null){var uniqueId='neto-btn-'+Math.floor(Math.random()*99999);this.id=uniqueId;}
return this.id;};this.create=function(){var parentNode=Netotiate.$(this.domElement).parent();var originalDomElem=Netotiate.$(this.domElement);var uniqueId=this.getUniqueId();var netoButtonIframe=Netotiate.$("<iframe scrolling='no' class='netotiate-button-iframe' allowTransparency='true' frameborder='0'/>").css("cssText","width:"+Netotiate.Plugin.displayConfig.button.width+";height:"+Netotiate.Plugin.displayConfig.button.height).attr('id',uniqueId);var iframeSrc=Netotiate.Plugin.Env.pluginBaseUrl+'/index/button?v='+Netotiate.Plugin.cacheIdentifier+'&affiliateId='+Netotiate.Plugin.affiliateId+'&w='+Netotiate.Plugin.displayConfig.button.width+'&h='+Netotiate.Plugin.displayConfig.button.height+'&bg='+encodeURIComponent(Netotiate.Plugin.displayConfig.button.background)+'&lc='+Netotiate.Plugin.locale+'#'+this.id;Netotiate.$(netoButtonIframe).attr('src',iframeSrc);netoButtonIframe.hide();Netotiate.$(this.domElement).replaceWith(netoButtonIframe);this.domElement=netoButtonIframe;};this.show=function(){if(Netotiate.$(this.domElement).is(":visible"))
return;Netotiate.$(this.domElement).slideDown({complete:function(){Netotiate.$(this).css({'display':'inline-block'});Netotiate.Plugin.triggerButtonShow();},step:function(){Netotiate.$(this).css({'display':'inline-block'});},duration:1000});this.reportImpressions();};this.runtimeValidation=function(){var isValid=true;var currentParameters=this.params;if(Netotiate.Plugin.Validator.NetotiateElement.isExist(currentParameters.waitFor)){try{var waitFor=eval(currentParameters.waitFor);if(!(waitFor instanceof Array))
return false;Netotiate.$.each(waitFor,function(key,value){if(!Netotiate.Plugin.Validator.NetotiateElement.isExist(currentParameters[value])){isValid=false;return false;}});}catch(e){return false;}}
return isValid;};this.action=function(){if(this.runtimeValidation()&&Netotiate.Plugin.Arena!==null&&Netotiate.Plugin.Arena!==undefined){pm({target:Netotiate.Plugin.Arena,type:"initialize_arena",data:this.params});Netotiate.Plugin.showArena();}};this.getStatus=function(){var status='';var isMandatoryValid=Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams(this.params);var isOptionalValid=Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams(this.params);if(isMandatoryValid&&isOptionalValid)
status='enabled';if(!this.runtimeValidation())
status='disabled';return status;};this.isImpressionsReported=false;this.reportImpressions=function(){if(Netotiate.ArenaElement.isButtonImpressionsReported===true)
return false;Netotiate.ArenaElement.isButtonImpressionsReported=true;if(Netotiate.Plugin.displayConfig.button&&Netotiate.ArenaElement.getTotalLoadedButtons()>0){NetotiateWindow.client.events.broadcast('netotiate.plugin.button.view',{affiliateId:Netotiate.Plugin.affiliateId,sg:Netotiate.Plugin.SampleGroup.name,cid:Netotiate.ArenaElementSet[0].getCategoryId()});}};this.getCategoryId=function(){return this.params.categoryId;};this.getSku=function(){return this.params.sku;};this.getDomElement=function(){return this.domElement;};this.id=null;this.type=type;this.domElement=domElement;this.params={};for(var key in rawParams){try{this.params[key]=decodeURIComponent(rawParams[key]);}catch(e){this.params[key]=unescape(rawParams[key]);}}
this.params.categoryId=this.params.categoryId?this.params.categoryId:'';this.getUniqueId();};Netotiate.ArenaElement.isButtonImpressionsReported=false;Netotiate.ArenaElement.findByExternalId=function(id){var elem;Netotiate.$.each(Netotiate.ArenaElementSet,function(key,value){if(value.params.externalId==id){elem=value;return false;}});return elem;};Netotiate.ArenaElement.findBId=function(id){var elem;Netotiate.$.each(Netotiate.ArenaElementSet,function(key,value){if(value.id==id){elem=value;return false;}});return elem;};Netotiate.ArenaElement.deleteById=function(id){return Netotiate.$.grep(Netotiate.ArenaElementSet,function(el,i){if(el.id==id){return false;}
return true;});};Netotiate.ArenaElement.getTotalLoadedButtons=function(){return Netotiate.ArenaElementSet.length;};Netotiate.Plugin.loadWidget=function(){widgetLibrary=document.createElement('script');widgetLibrary.src=Netotiate.Plugin.Env.staticCdnBaseUrl+"/scripts/plugin/plugin.library.widget.min.js.jgz?cb="+Netotiate.Plugin.cacheIdentifier;(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(widgetLibrary);};Netotiate.Plugin.drawElements=function(altDelay){if(Netotiate.ArenaElement.getTotalLoadedButtons()==1&&Netotiate.ArenaElementSet[0].runtimeValidation()){if(Netotiate.Plugin.Validator.NetotiateElement.isExist(Netotiate.Plugin.displayConfig.tab)){Netotiate.Plugin.Logger.log('Netotiate plugin initializing started');Netotiate.SideWidget.initializeIframe();}}
Netotiate.$.each(Netotiate.Plugin.Actions.tasks,function(key,task){var arenaElement=Netotiate.ArenaElement.findBId(task.ownerId);if(arenaElement)
Netotiate.Plugin.Actions.doTask(task,arenaElement,altDelay);});};Netotiate.Plugin.init=function(options){function tryInit(options){if(!Netotiate.Plugin.setupConfiguration(options))
return;Netotiate.Plugin.options=options;NetotiateWindow.client=NetotiateWindow.createClient();NetotiateWindow.server=NetotiateWindow.createServer();Netotiate.Plugin.collectNetotiableElements();if(!Netotiate.ArenaElement.getTotalLoadedButtons())
return;Netotiate.Plugin.injectHub();}
Netotiate.$(document).ready(function(){try{tryInit(options);}
catch(e){Netotiate.Plugin.reportOnCrash(e);}});};Netotiate.Events={};Netotiate.Events.publish=Netotiate.Events.trigger=function(eventType,options,externalIds){var combinedOptions=Array();if(typeof options==='object')
combinedOptions.push(options);else
combinedOptions.push({});if(externalIds instanceof Array)
combinedOptions.push(externalIds);Netotiate.$("body").trigger(eventType,combinedOptions);};Netotiate.Events.subscribe=Netotiate.Events.bind=function(eventType,handler){Netotiate.$('body').bind(eventType,handler);};Netotiate.Plugin.bindExternalEvents=function(){if($&&Netotiate.$!=$&&$('body')&&typeof $('body').bind=="function"){$('body').bind('netotiate.plugin.options.update',function(e,updatedParams){Netotiate.$("body").trigger("netotiate.plugin.options.update",updatedParams);});}
Netotiate.$('body').bind('netotiate.plugin.arena.show',function(e){Netotiate.ArenaElementSet[0].action();});if(Netotiate.Plugin.Validator.NetotiateElement.isExist(Netotiate.Plugin.displayConfig.tab)){Netotiate.$('body').bind('netotiate.plugin.options.update',function(e,updatedParams){var reOpenWidget=false;if(Netotiate.SideWidget.isVisible&&Netotiate.SideWidget.isOpen){reOpenWidget=true;}
var currentParams=Netotiate.ArenaElementSet[0].params;var updatedSet=Netotiate.$.extend(currentParams,updatedParams);Netotiate.ArenaElementSet[0].params=updatedSet;var isMandatoryValid=Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams(Netotiate.ArenaElementSet[0].params);var isOptionalValid=Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams(Netotiate.ArenaElementSet[0].params);if(isMandatoryValid===false||isOptionalValid===false){Netotiate.Plugin.Logger.error('Netotiate plugin - dynamic parameters received did not pass validation. Disabling the plugin functionlity');Netotiate.ArenaElementSet[0].params=currentParams;Netotiate.ArenaElementSet[0].params.productPrice='N/A';}
pm({target:Netotiate.SideWidget.Widget,type:"initialize_arena",data:Netotiate.ArenaElementSet[0].params});if(reOpenWidget){setTimeout(Netotiate.SideWidget.action.open,1000);}});}else{Netotiate.$('body').bind("netotiate.plugin.options.update",function(e,updatedParams,externalIds){var arenaElements=new Array();if(externalIds instanceof Array){if(externalIds.length>=1){Netotiate.$.each(externalIds,function(key,externalId){var element=Netotiate.ArenaElement.findByExternalId(externalId);if(element){arenaElements.push(element);}});}}else if("undefined"==externalIds||null==externalIds){Netotiate.$.each(Netotiate.ArenaElementSet,function(key,arenaElement){arenaElements.push(arenaElement);});}
if(arenaElements instanceof Array&&arenaElements.length>=1){Netotiate.$.each(arenaElements,function(key,element){if(!element)
return;var originalParameters=Netotiate.$.extend({},element.params);var updatedSet=Netotiate.$.extend(element.params,updatedParams);element.params=updatedSet;var isMandatoryValid=Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams(element.params);var isOptionalValid=Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams(element.params);if(isMandatoryValid===false||isOptionalValid===false){Netotiate.Plugin.Logger.error('Netotiate plugin - dynamic parameters received for buttonExternalId: '+externalId+' did not pass validation. Update will be reverted');element.params=originalParameters;};});};});}
pm.bind("netotiate_site_redirect",function(url){var RegExp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(null!=url&&''!=url&&RegExp.test(url))
window.location.href=url;else
return false;});pm.bind("netotiate_arena_scroll",function(data){switch(data.eventType){case"start":Netotiate.Plugin.autoScrollOn();break;case"stop":Netotiate.Plugin.autoScrollOff();break;}});pm.bind("netotiate_plugin_events_publish",function(data){if(data.eventType)
Netotiate.Events.publish(data.eventType,data.options);});pm.bind("arena_pm_button",function(data){Netotiate.$.each(Netotiate.ArenaElementSet,function(id,element){if(data.button==element.getSku()){pm({target:element.getDomElement()[0].contentWindow,type:data.type,data:data.data});return;}});});pm.bind("netotiate_arena_scroll_to_first_button",function(){Netotiate.Plugin.scrollToFirstButtonAndClose();});};Netotiate.Plugin.validateNetotiableElementsSetup=function(){Netotiate.$.each(Netotiate.ArenaElementSet,function(key,arenaElement){var isMandatoryValid=Netotiate.Plugin.Validator.NetotiateElement.validateMandatoryParams(arenaElement.params);var isOptionalValid=Netotiate.Plugin.Validator.NetotiateElement.validateOptionalParams(arenaElement.params);if(!isMandatoryValid||!isOptionalValid)
Netotiate.Plugin.Logger.warn('validation failed, current element will not be rendered.');});};Netotiate.Plugin.collectNetotiableElements=function(){Netotiate.$.each(Netotiate.$("body *[onClick*='Netotiate.Plugin'][onclick*='Netotiate.Plugin']"),function(key,value){try{var onclick=(this!=null&&this.attributes!=null)?this.attributes.onclick.nodeValue:null;if(onclick!=undefined&&onclick!=null){onclick=onclick.toString().replace(/[\n]/g,'').replace(/[\r]/g,'').replace(/[\']/g,'\"').replace(/\\t/g,'').replace(/\\n/g,'').replace(/\t/g,'');var type='button';var matchDraw=onclick.match(/Netotiate.Plugin.draw\(\s*(\{.+\})\);/m);if((matchDraw!=null)&&(matchDraw[1]!=undefined)){var keyValueParams=Netotiate.Plugin.JSON.parse(matchDraw[1]);Netotiate.ArenaElementSet.push(new Netotiate.ArenaElement(type,value,keyValueParams));}}}
catch(e){Netotiate.Plugin.Logger.warn('failed to collect netotiate draw element: '+e);Netotiate.Plugin.reportOnCrash(e);}});};Netotiate.Plugin.initializeIframe=function(){Netotiate.Plugin.prepareContainer();if(!Netotiate.Plugin.iframeReady)
window.setTimeout(function(){Netotiate.Plugin.initializeIframe();},300);};Netotiate.Plugin.loadCustomCode=function(affiliateId){var sanitizedName=Netotiate.Plugin.affiliateName.replace(/\W/g,'').toLowerCase();var hookUrl=Netotiate.Plugin.Env.staticCdnBaseUrl+'/scripts/custom/'+sanitizedName+'/code.js'+'?cb='+Netotiate.Plugin.cacheIdentifier;try{Netotiate.$.ajax({dataType:'jsonp',async:true,cache:true,jsonpCallback:'cb',url:hookUrl,error:function(e,a){}});}catch(e){}};Netotiate.Plugin.connect=function(affiliateId,version,authKey,connectFacts,isDebug,onConnectEnd){var logError=Netotiate.Plugin.Logger.error;if((null===affiliateId)||(affiliateId===undefined)){logError('Could not authenticate the plugin, missing affiliateId in parameters sent, aborting');Netotiate.Plugin.isAuthenticated=false;return;}
if((null===version)||(version===undefined)){logError('Could not authenticate the plugin, missing version in parameters sent, aborting');Netotiate.Plugin.isAuthenticated=false;return;}
if((null===authKey)||(authKey===undefined)){logError('Could not authenticate the plugin, missing authenticationKey in parameters sent, aborting');Netotiate.Plugin.isAuthenticated=false;return;}
if(Netotiate.Plugin.isAuthenticated===null){Netotiate.Plugin.isAuthenticated='authenticating';var connectErrorCallback=function(){logError('Could not authenticate the plugin for affiliate ID: '+affiliateId+', aborting');};var connectSuccessCallback=function(data){var genericResponse=Netotiate.API.GenericResponse(data);if(!genericResponse){connectErrorCallback();return;}
Netotiate.Plugin.affiliateName=genericResponse.body.Publisher.retailerName;Netotiate.Plugin.Actions.tasks=genericResponse.body.actions;Netotiate.Plugin.displayConfig=Netotiate.Plugin.JSON.parse(genericResponse.body.Publisher.displayConfig);Netotiate.Plugin.merchantPhone=genericResponse.body.Publisher.phone;Netotiate.Plugin.merchantLogoUrl=genericResponse.body.Publisher.retailerLogoUrl;Netotiate.Plugin.merchantId=genericResponse.body.Publisher.retailerId;Netotiate.Plugin.locale=genericResponse.body.Publisher.locale;Netotiate.Plugin.Logger.log('Netotiate plugin authentication successfull');onConnectEnd();};var connectData=Netotiate.Plugin.JSON.stringify({'affiliateId':affiliateId,'version':version,'affiliateKey':authKey,'debug':isDebug,'factItems':connectFacts});Netotiate.$.support.cors=true;var connectIE=function(){if(window.XDomainRequest){var xhr=new XDomainRequest();xhr.open('POST',Netotiate.Plugin.Env.apiBaseUrl+'/api/display/connect/v2');xhr.onload=function(){if(xhr.responseText!=null&&xhr.responseText!=''){var parsedResponse=Netotiate.Plugin.JSON.parse(xhr.responseText);connectSuccessCallback(parsedResponse);}else{connectErrorCallback();}};xhr.onprogress=function(){};xhr.timeout=5000;xhr.onerror=function(){connectErrorCallback();};connectData={'affiliateId':affiliateId,'version':version,'affiliateKey':authKey,'debug':isDebug,'factItems':connectFacts};var param='';Netotiate.$.each(connectData,function(key,p){param+=encodeURIComponent(key)+"="+encodeURIComponent(p)+"&";});xhr.send(param);}}
var connect=function(){Netotiate.$.ajax({type:'POST',url:Netotiate.Plugin.Env.apiBaseUrl+'/api/display/connect',data:connectData,cache:false,dataType:'json',contentType:"application/json; charset=utf-8",crossDomain:true,success:connectSuccessCallback,error:Netotiate.Plugin.connectErrorHandler});};var xhr=new XMLHttpRequest();if("withCredentials"in xhr)
connect();else
connectIE();}};Netotiate.Plugin.setupConfiguration=function(config){var isValid=true;if(config.debug||window.location.hash=="#NETO_DEBUG")
Netotiate.Plugin.debug=config.debug=true;if(config.affiliateId){if(!Netotiate.Plugin.Validator.isNumber(config.affiliateId)){isValid=false;Netotiate.Plugin.Logger.error('affiliateId supplied in INIT method is not a valid number, input: '+config.affiliateId+' - aborting');}else{Netotiate.Plugin.affiliateId=config.affiliateId;}}
if(config.authenticationKey){if(!Netotiate.Plugin.Validator.isNonEmptyString(config.authenticationKey)){isValid=false;Netotiate.Plugin.Logger.error('authenticationKey supplied in INIT method is not a valid number, input: '+config.authenticationKey+' - aborting');}else{Netotiate.Plugin.authKey=config.authenticationKey;}}
config.baseUrl=Netotiate.Plugin.Env.pluginBaseUrl;config.cseBaseUrl=Netotiate.Plugin.Env.siteBaseUrl;return isValid;};Netotiate.Plugin.injectHub=function(){var hub=Netotiate.$('#netotiate-hub-container');if(hub.length>0){Netotiate.Plugin.onHubReadyState();return;}
Netotiate.$("<div id = 'netotiate-hub-container'></div>").appendTo('body');hub=Netotiate.$('#netotiate-hub-container');hub.removeClass();hub.attr('style','');var iframeSrc=Netotiate.Plugin.Env.pluginBaseUrl+'/index/hub/?cb='+Netotiate.Plugin.cacheIdentifier+'&affiliateId='+Netotiate.Plugin.options.affiliateId;var iframe=Netotiate.$("<iframe id='netotiate-hub' src='"+iframeSrc+"' frameborder='0' class='netotiate-window-client'>");iframe.appendTo(hub);iframe.load(function(){Netotiate.Plugin.onHubReadyState();});};Netotiate.Plugin.prepareContainer=function(){if(Netotiate.Plugin.iframeReady||Netotiate.Plugin.initializing)
return;Netotiate.Plugin.initializing=true;var pluginContainer=Netotiate.$('#netotiate_plugin');if(pluginContainer.length===0){Netotiate.$("<div id='netotiate_plugin'></div>").appendTo('body');pluginContainer=Netotiate.$('#netotiate_plugin');}else{if(Netotiate.$("#netotiate_iframe").length>0){Netotiate.Plugin.Arena=Netotiate.$("#netotiate_iframe")[0].contentWindow;Netotiate.Plugin.iframeReady=true;Netotiate.Plugin.onArenaReadyState();return;}}
pluginContainer.removeClass();pluginContainer.attr('style','');if(pluginContainer.length>0){pluginContainer.hide();var iframeSrcParams={};iframeSrcParams.affiliateId=Netotiate.Plugin.options.affiliateId;iframeSrcParams.v=Netotiate.Plugin.cacheIdentifier;iframeSrcParams.logoUrl=Netotiate.Plugin.merchantLogoUrl;iframeSrcParams.retailerName=Netotiate.Plugin.affiliateName.replace(/\W/g,'').toLowerCase();iframeSrcParams.lc=Netotiate.Plugin.locale;var iframeSrc=Netotiate.Plugin.Env.pluginBaseUrl+'/index/arena/?'+Netotiate.$.param(iframeSrcParams);Netotiate.$("<iframe id='netotiate_iframe' name='netotiate_iframe' scrolling='no' allowtransparency='true' src='"+iframeSrc+"' frameborder='0' class='netotiate-window-client'/>").appendTo("#netotiate_plugin");pm.bind("arena_close",function(data){Netotiate.Plugin.hide();});pm.bind("arena_close",function(data){Netotiate.Plugin.hide();});pm.bind("arena_show",function(data){Netotiate.Plugin.showArena();});pm.bind("netotiate_button_click",function(data){var e=Netotiate.ArenaElement.findBId(data);NetotiateWindow.client.events.broadcast('netotiate.plugin.button.click',{affiliateId:Netotiate.Plugin.affiliateId,sg:Netotiate.Plugin.SampleGroup.name,sku:e.params.sku,cid:e.getCategoryId(),price:parseInt(e.params.productPrice*100)});Netotiate.$("body").trigger("netotiate.plugin.initiator.onclick",[{sku:e.params.sku,status:e.getStatus()}]);if(e)
e.action();});Netotiate.$('#netotiate_iframe').load(function(){Netotiate.Plugin.iframeReady=true;Netotiate.$('#netotiate_iframe').css({width:'628px',height:'440px',visibility:'visible',overflow:'hidden'});var arena=document.getElementById('netotiate_iframe').contentWindow;Netotiate.Plugin.Arena=arena;pm({target:arena,type:"setup",data:Netotiate.Plugin.options});Netotiate.Plugin.onArenaReadyState();});}
else{Netotiate.Plugin.Logger.error('div element with id [netotiate_plugin] is missing in the body tag, aborting.');}};Netotiate.Plugin.doOverlay=function(){var isOverlayed=Netotiate.$('body').find('#arena-overlay').length>0;var body=Netotiate.$('body');var overlay=Netotiate.$('<span id="arena-overlay"></span>');var pluginHolder=Netotiate.$('#netotiate_plugin');if(!isOverlayed){overlay.css({width:'0',height:'0','line-height':'0'});body.append(overlay);overlay.hide();overlay.css({background:'#000000',position:'absolute',display:'inline',top:'0',left:'0',bottom:'0','z-index':'99998',opacity:'0.4',filter:'alpha(opacity=40)',width:'100%',height:Netotiate.$(document).height()}).fadeIn();overlay.click(function(){return false;});}};Netotiate.Plugin.removeOverlay=function(onFinish){var overlay=Netotiate.$('#arena-overlay');overlay.fadeOut('fast',function(){overlay.remove();if(typeof onFinish=='function')
onFinish();});};Netotiate.Plugin.isActive=function(){return Netotiate.$('#netotiate_plugin').is(':visible');};Netotiate.Plugin.show=function(){Netotiate.Plugin.unHookOnMouseLeave();Netotiate.Plugin.doOverlay();Netotiate.Plugin.autoScrollOn();Netotiate.$('#netotiate_plugin').show();Netotiate.$('#netotiate_iframe').fadeIn();Netotiate.$('#netotiate_iframe').css({top:Netotiate.$(document).scrollTop()+(window.innerHeight||document.documentElement.clientHeight)/2-Netotiate.Plugin.dialogHeight/2+'px',left:Netotiate.$(document).scrollLeft()+(window.innerWidth||document.documentElement.clientWidth)/2-Netotiate.Plugin.dialogWidth/2+'px',position:'absolute','z-index':'99999'});};Netotiate.Plugin.showArena=function(){pm({target:Netotiate.Plugin.Arena,type:"show_arena"});Netotiate.Plugin.show();};Netotiate.Plugin.showIncentive=function(){pm({target:Netotiate.Plugin.Arena,type:"show_incentive"});Netotiate.Plugin.show();Netotiate.Plugin.drawElements(0);};Netotiate.Plugin.hide=function(onFinish){Netotiate.$('#netotiate_iframe').fadeOut(function(){Netotiate.$('#netotiate_plugin').hide();Netotiate.Plugin.removeOverlay(onFinish);});};Netotiate.Plugin.reportOnCrash=function(e){var imgTag=document.createElement("img");imgTag.src=Netotiate.Plugin.Env.reportBaseUrl+"/reporting/image?e=PluginCrash&a=report&d="+encodeURIComponent(Netotiate.Plugin.getCurrentUrl()).substring(0,255)+"&d2="+encodeURIComponent(e).substring(0,255)+"&affiliateId="+Netotiate.Plugin.affiliateId;(document.getElementsByTagName("body")[0]).appendChild(imgTag);};;(function(scope){try{var jQuery;var acceptedVersion='1.8.1';if(window.jQuery===undefined||window.jQuery.fn.jquery!=acceptedVersion){var script_tag=document.createElement('script');script_tag.setAttribute("type","text/javascript");script_tag.setAttribute("src","//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js");if(script_tag.readyState){script_tag.onreadystatechange=function(){if(this.readyState=='complete'||this.readyState=='loaded'){scriptLoadHandler();}};}else{script_tag.onload=scriptLoadHandler;}
(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(script_tag);}else{jQuery=window.jQuery;main();}}
catch(e){Netotiate.Plugin.reportOnCrash(e);}
function scriptLoadHandler(){if(window.jQuery!=undefined)
jQuery=window.jQuery.noConflict(true);main();}
function main(){jQuery(document).ready(function($){Netotiate.$=$;function IsIE7Browser(){try{return navigator.appVersion.indexOf("MSIE 7.")!=-1;}catch(e){return false;}}
if(IsIE7Browser())
return;loadPostMessageLibrary();if(typeof window.netotiateInitScript=='function')
window.netotiateInitScript();else
Netotiate.Plugin.Logger.error('Method - netotiateInitScript missing in containing page body tag, aborting');},scope);}
function loadPostMessageLibrary(){(function(window,$,undefined){if(!("console"in window)){var c=window.console={};c.log=c.warn=c.error=c.debug=function(){};}
$.fn.pm=function(){console.log("usage: \nto send:    $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])");return this;};$.pm=window.pm=function(options){pm.send(options);};$.pm.bind=window.pm.bind=function(type,fn,origin,hash){pm.bind(type,fn,origin,hash);};$.pm.unbind=window.pm.unbind=function(type,fn){pm.unbind(type,fn);};$.pm.origin=window.pm.origin=null;$.pm.poll=window.pm.poll=200;var pm={send:function(options){var o=$.extend({},pm.defaults,options),target=o.target;if(!o.target){return;}
if(!o.type){return;}
var msg={data:o.data,type:o.type};if(o.success){msg.callback=pm._callback(o.success);}
if(o.error){msg.errback=pm._callback(o.error);}
if(("postMessage"in target)&&!o.hash){pm._bind();target.postMessage(Netotiate.Plugin.JSON.stringify(msg),o.origin||'*');}else{pm.hash._bind();pm.hash.send(o,msg);}},bind:function(type,fn,origin,hash){if(("postMessage"in window)&&!hash){pm._bind();}else{pm.hash._bind();}
var l=pm.data("listeners.postmessage");if(!l){l={};pm.data("listeners.postmessage",l);}
var fns=l[type];if(!fns){fns=[];l[type]=fns;}
fns.push({fn:fn,origin:origin||$.pm.origin});},unbind:function(type,fn){var l=pm.data("listeners.postmessage");if(l){if(type){if(fn){var fns=l[type];if(fns){var m=[];for(var i=0,len=fns.length;i<len;i++){var o=fns[i];if(o.fn!==fn){m.push(o);}}
l[type]=m;}}else{delete l[type];}}else{l={};}}},data:function(k,v){if(v===undefined){return pm._data[k];}
pm._data[k]=v;return v;},_data:{},_CHARS:'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split(''),_random:function(){var r=[];for(var i=0;i<32;i++){r[i]=pm._CHARS[0|Math.random()*32];}
return r.join("");},_callback:function(fn){var cbs=pm.data("callbacks.postmessage");if(!cbs){cbs={};pm.data("callbacks.postmessage",cbs);}
var r=pm._random();cbs[r]=fn;return r;},_bind:function(){if(!pm.data("listening.postmessage")){if(window.addEventListener){window.addEventListener("message",pm._dispatch,false);}else if(window.attachEvent){window.attachEvent("onmessage",pm._dispatch);}
pm.data("listening.postmessage",1);}},_dispatch:function(e){try{var msg=Netotiate.Plugin.JSON.parse(e.data);}catch(ex){return;}
if(!msg.type){return;}
var cbs=pm.data("callbacks.postmessage")||{},cb=cbs[msg.type];if(cb){cb(msg.data);}else{var l=pm.data("listeners.postmessage")||{};var fns=l[msg.type]||[];for(var i=0,len=fns.length;i<len;i++){var o=fns[i];if(o.origin&&e.origin!==o.origin){if(msg.errback){var error={message:"postmessage origin mismatch",origin:[e.origin,o.origin]};pm.send({target:e.source,data:error,type:msg.errback});}
continue;}
try{var r=o.fn(msg.data);if(msg.callback){pm.send({target:e.source,data:r,type:msg.callback});}}catch(ex){if(msg.errback){pm.send({target:e.source,data:ex,type:msg.errback});}}}}}};pm.hash={send:function(options,msg){var target_window=options.target,target_url=options.url;if(!target_url){console.warn("postmessage target window url is required");return;}
target_url=pm.hash._url(target_url);var source_window,source_url=pm.hash._url(window.location.href);if(window==target_window.parent){source_window="parent";}else{try{for(var i=0,len=parent.frames.length;i<len;i++){var f=parent.frames[i];if(f==window){source_window=i;break;}}}catch(ex){source_window=window.name;}}
if(source_window==null){console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list");return;}
var hashmessage={"x-requested-with":"postmessage",source:{name:source_window,url:source_url},postmessage:msg};var hash_id="#x-postmessage-id="+pm._random();target_window.location=target_url+hash_id+encodeURIComponent(Netotiate.Plugin.JSON.stringify(hashmessage));},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:"#x-postmessage-id=".length+32,_bind:function(){if(!pm.data("polling.postmessage")){setInterval(function(){var hash=""+window.location.hash,m=pm.hash._regex.exec(hash);if(m){var id=m[1];if(pm.hash._last!==id){pm.hash._last=id;pm.hash._dispatch(hash.substring(pm.hash._regex_len));}}},$.pm.poll||200);pm.data("polling.postmessage",1);}},_dispatch:function(hash){if(!hash){return;}
try{hash=Netotiate.Plugin.JSON.parse(decodeURIComponent(hash));if(!(hash['x-requested-with']==='postmessage'&&hash.source&&hash.source.name!=null&&hash.source.url&&hash.postmessage)){return;}}catch(ex){return;}
var msg=hash.postmessage,cbs=pm.data("callbacks.postmessage")||{},cb=cbs[msg.type];if(cb){cb(msg.data);}else{var source_window;if(hash.source.name==="parent"){source_window=window.parent;}else{source_window=window.frames[hash.source.name];}
var l=pm.data("listeners.postmessage")||{};var fns=l[msg.type]||[];for(var i=0,len=fns.length;i<len;i++){var o=fns[i];if(o.origin){var origin=/https?\:\/\/[^\/]*/.exec(hash.source.url)[0];if(origin!==o.origin){console.warn("postmessage message origin mismatch",origin,o.origin);if(msg.errback){var error={message:"postmessage origin mismatch",origin:[origin,o.origin]};pm.send({target:source_window,data:error,type:msg.errback,hash:true,url:hash.source.url});}
continue;}}
try{var r=o.fn(msg.data);if(msg.callback){pm.send({target:source_window,data:r,type:msg.callback,hash:true,url:hash.source.url});}}catch(ex){if(msg.errback){pm.send({target:source_window,data:ex,type:msg.errback,hash:true,url:hash.source.url});}}}}},_url:function(url){return(""+url).replace(/#.*$/,"");}};$.extend(pm,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:false}});})(this,typeof Netotiate.$==="undefined"?null:Netotiate.$);jQuery.extend({stringify:function stringify(obj){var t=typeof(obj);if(t!="object"||obj===null){if(t=="string")obj='"'+obj.replace(/\"/g,'\\"')+'"';return String(obj);}else{var n,v,json=[],arr=(obj&&obj.constructor==Array);for(n in obj){v=obj[n];t=typeof(v);if(obj.hasOwnProperty(n)){if(t=="string")v='"'+v.replace(/\"/g,'\\"')+'"';else if(t=="object"&&v!==null)v=jQuery.stringify(v);json.push((arr?"":'"'+n+'":')+String(v));}}
return(arr?"[":"{")+String(json)+(arr?"]":"}");}}});if(!("JSON"in Netotiate.Plugin&&Netotiate.Plugin.JSON)){Netotiate.Plugin.JSON={};Netotiate.Plugin.JSON.parse=Netotiate.$.parseJSON;Netotiate.Plugin.JSON.stringify=Netotiate.$.stringify;}}})(Netotiate);