/* begin pageRefreshJS/pageRefresh.js */
var Twister={};Twister.Enums={generic:{},landingPrefetchStates:{"TRIGGER_ON_CF":0,"TRIGGER_ON_PAGE_LOAD":1,"TRIGGER_ON_INTERACTION":2,"TRIGGER_ON_HOVER":3,"DISABLE":4}}
Twister.isIEBrowser=function($){return $.browser.msie||!!(navigator.userAgent.match(/Trident/));};var DetailPageFramework={callbacks:{}};DetailPageStateController=function(){this.state={};this.getState=function(){return this.state;}
this.setState=function(attribute,val){if(attribute&&val){this.state[attribute]=val;}}}
DetailPageFramework.registerCallback=function(pageEvent,twisterFeatureName,callbackfunction){if((pageEvent!="after_redraw"&&pageEvent!="asin_select")||(twisterFeatureName!="sims-widget"&&twisterFeatureName!="session-similarities"&&twisterFeatureName!="purchase-similarities"&&twisterFeatureName!="buyxgety")){return;}
this.callbacks[twisterFeatureName+'_feature_div']=callbackfunction;}
DetailPageFramework.registerFeature=function(){}
DetailPageFramework.registerFeatureConfig=function(){}
Twister.State=function(){this.parentASIN='';this.currentASIN='';this.dimensionSelectionData={};this.unselectedDimCount=-1;this.hoveredReactId='';this.master='';this.setMaster=function(master){this.master=master;}
this.getMaster=function(){return this.master;}
this.getCurrentASIN=function(){return this.currentASIN;}
this.setCurrentASIN=function(asin){if(asin){this.currentASIN=asin;}}
this.getCurrentDimCombID=function(){return this.currentDimCombID;}
this.setCurrentDimCombID=function(newDimCombID){if(newDimCombID){this.currentDimCombID=newDimCombID;}}
this.getSelectionState=function(divMetaData){if(divMetaData!=null){var dimIndex=divMetaData["dimIndex"];var dimSelection=this.dimensionSelectionData[dimIndex];if((dimSelection["isRequired"]==1||Twister.isInstaTwisterEnabled)&&(dimSelection["isSelected"]==0)&&(divMetaData["dimValueIndex"]!=-1)){dimSelection["isSelected"]=1;this.unselectedDimCount--;if(this.unselectedDimCount<0){this.unselectedDimCount=0;}}}
return this.unselectedDimCount;}
this.isDimSelected=function(dimIndex){var dimSelection=this.dimensionSelectionData[dimIndex];return dimSelection["isSelected"]==1;}
this.setPartialState=function(exceptionDimIndex,newDimCombID){var newDimCombIDArray=newDimCombID.split("_");for(var dimCount in this.dimensionSelectionData){var dimSelection=this.dimensionSelectionData[dimCount];if(newDimCombIDArray[dimCount]=="X"){if(dimSelection["isSelected"]==1){dimSelection["isSelected"]=0;this.unselectedDimCount++;}}}}
this.getMatchingDimIndex=function(currIndex,reqVal){for(var pos=currIndex+1;pos<this.dimensionSelectionData.length;pos++){if(this.dimensionSelectionData[pos]["isRequired"]==reqVal)return pos;}
return-1;}
this.init=function(data){if(data){DetailPage.StateController=new DetailPageStateController();for(var p in data){DetailPage.StateController.setState(p,data[p]);}
this.storeID=data['storeId'];this.productGroupID=data['productGroupId'];this.currentASIN=data["current_asin"];this.parentASIN=data["parent_asin"];this.dimensionSelectionData=data["dimensionSelectionData"];this.unselectedDimCount=data["unselectedDimCount"];this.currentDimCombID=data["currentDimCombID"];this.reactId=data["reactId"];}}}
Twister.VariationsData=function(){this.dimensionValuesDisplay={};this.dimAvailabilityCache={};this.asinToRenderCache={};this.intermediateAsinToRenderCache={};this.isUpdateCacheReq=false;this.init=function(data){this.dimensionValuesDisplay=data["dimensionValuesDisplayData"];this.deletedLandingAsinInfo=data["deletedLandingAsinInfo"];this.dimToAsinMapData=data["dimToAsinMapData"];this.dimensionValuesData=data["dimensionValuesData"];this.asinToDimIndexMapData=data["asinToDimIndexMapData"];this.dimensionsDisplayType=data["dimensionsDisplayType"];this.displayConfigStylesData=data["displayConfigStylesData"];this.useMS=data["useMS"];this.hoverMS=data["hoverMS"];this.childPrefetchRankData=data["childPrefetchRankData"];this.enablePrefetchRankingWeblab=data["enablePrefetchRankingWeblab"];this.rankThreshold=data["rankThreshold"];}
this.getAsinData=function(dimCombID){var startTime=new Date().getTime();var styleData=[];var dimCombIDArray=dimCombID.split("_");var noOfDims=this.dimensionValuesData.length;for(var dimCount=0;dimCount<noOfDims;dimCount++){var displayType=this.dimensionsDisplayType[dimCount];var noOfDimValues=this.dimensionValuesData[dimCount].length;var perDimStyleData=[];var dimCombIDArrayCopy=dimCombIDArray.slice(0);for(var dimValCount=0;dimValCount<noOfDimValues;dimValCount++){var dimValHash={};var styleClassType;if(dimCombIDArray[dimCount]==dimValCount.toString()){styleClassType="selected";}
else{dimCombIDArrayCopy[dimCount]=dimValCount;var newDimCombID=dimCombIDArrayCopy.join("_");var isAvailable=this.isDimCombinationAvailable(newDimCombID);styleClassType=isAvailable?"available":"invalid";}
var dimStyle=this.displayConfigStylesData[displayType][styleClassType];if(this.useMS&&!Twister.useBeaconizedEVDD){if(styleClassType=="invalid"){dimStyle="etddHidden";}else{dimStyle="etdd";}
if(styleClassType=="selected"){dimStyle="etddSelected";}}
dimValHash["style"]=dimStyle;perDimStyleData[dimValCount]=dimValHash;}
styleData[dimCount]=perDimStyleData;}
var endTime=new Date().getTime();return styleData;}
this.getDimensionValuesDisplayData=function(asin){var result=this.dimensionValuesDisplay[asin];if(!result&&asin==this.deletedLandingAsinInfo['asin']){result=this.deletedLandingAsinInfo['dimValues'];}
return result;}
this.getAsinFromDiv=function(asin,divMetaData,dimensionSelectionData,dimCombID){var startTime=new Date().getTime();var dimIndex=divMetaData["dimIndex"];var dimValueIndex=divMetaData["dimValueIndex"];var dimCombIDArray=dimCombID.split("_");dimCombIDArray[dimIndex]=(dimValueIndex==-1)?"X":dimValueIndex;var newDimCombID=dimCombIDArray.join("_");var returnAsin=this.gAsinToRender(newDimCombID,dimIndex);var endTime=new Date().getTime();return returnAsin;}
this.getNewDimCombID=function(asin,dimensionSelectionData,dimCombID,divMetaData){var dimCombIDArray=dimCombID.split("_");var noOfDims=dimCombIDArray.length;var intermediateStateRef=this.asinToDimIndexMapData[asin];var intermediateState;if(intermediateStateRef){var intermediateState=intermediateStateRef.slice(0);}
else{intermediateState=[];for(var iter=0;iter<noOfDims;iter++){intermediateState[iter]="X";}}
var exceptionIndex=-1;if(divMetaData!=null){exceptionIndex=divMetaData["dimIndex"];}
var isDimReq;for(var pos=0;pos<noOfDims;pos++){isDimReq=dimensionSelectionData[pos]["isRequired"];if(isDimReq&&(pos!=exceptionIndex)&&(intermediateState[pos]!=dimCombIDArray[pos])){intermediateState[pos]="X";}}
if(exceptionIndex!=-1&&parseInt(divMetaData["dimValueIndex"])==-1){intermediateState[exceptionIndex]="X";}
var newDimCombID=intermediateState.join("_");return newDimCombID;}
this.isDimCombinationAvailable=function(dimCombID){if(this.dimAvailabilityCache[dimCombID]!=null){return this.dimAvailabilityCache[dimCombID];}
var dimArray=dimCombID.split("_");var noOfDims=dimArray.length;var firstXDimPos=-1;var isAvailable;for(var pos=0;pos<noOfDims;pos++){if(dimArray[pos]=="X"){firstXDimPos=pos;break;}}
if(firstXDimPos==-1){isAvailable=false;if(this.dimToAsinMapData[dimCombID]!=null){isAvailable=true;}
this.dimAvailabilityCache[dimCombID]=isAvailable;return isAvailable;}
var dimValsInXDim=this.dimensionValuesData[firstXDimPos].length;for(var dimIdx=0;dimIdx<dimValsInXDim;dimIdx++){dimArray[firstXDimPos]=dimIdx;var newDimCombID=dimArray.join("_");if(this.dimAvailabilityCache[newDimCombID]!=null){isAvailable=this.dimAvailabilityCache[newDimCombID];}
else{isAvailable=this.isDimCombinationAvailable(newDimCombID);this.dimAvailabilityCache[newDimCombID]=isAvailable;}
if(isAvailable){break;}}
this.dimAvailabilityCache[dimCombID]=isAvailable;return isAvailable;}
this.updateAsinToRenderCache=function(asinToRender){for(var dimCombIDKey in this.intermediateAsinToRenderCache){if(this.asinToRenderCache[dimCombIDKey]!=null){}
this.asinToRenderCache[dimCombIDKey]=asinToRender;delete this.intermediateAsinToRenderCache[dimCombIDKey];}
this.intermediateAsinToRenderCache={};}
this.gAsinAvailable=function(dimCombID,constantDimPos){var dimCombIDKey=dimCombID+":"+constantDimPos;if(this.asinToRenderCache[dimCombIDKey]!=null){return this.asinToRenderCache[dimCombIDKey];}
this.intermediateAsinToRenderCache[dimCombIDKey]=true;var dimArray=dimCombID.split("_");var noOfDims=dimArray.length;var firstXDimPos=-1;var asinToRender;for(var pos=0;pos<noOfDims;pos++){if(dimArray[pos]=="X"){firstXDimPos=pos;break;}}
if(firstXDimPos==-1){asinToRender=null;if(this.dimToAsinMapData[dimCombID]!=null){asinToRender=this.dimToAsinMapData[dimCombID];}
return asinToRender;}
var dimValsInXDim=this.dimensionValuesData[firstXDimPos].length;for(var dimIdx=0;dimIdx<dimValsInXDim;dimIdx++){dimArray[firstXDimPos]=dimIdx;var newDimCombID=dimArray.join("_");var newDimCombIDKey=newDimCombID+":"+constantDimPos;if(this.intermediateAsinToRenderCache.hasOwnProperty(newDimCombIDKey)){continue;}
else{asinToRender=this.gAsinAvailable(newDimCombID,constantDimPos);}
if(asinToRender!=null){break;}}
return asinToRender;}
this.gAsinToRender=function(dimCombID,constantDimPos){var dimCombIDKey=dimCombID+":"+constantDimPos;if(this.asinToRenderCache[dimCombIDKey]!=null){if(this.isUpdateCacheReq){this.updateAsinToRenderCache(this.asinToRenderCache[dimCombIDKey]);this.isUpdateCacheReq=false;}
return this.asinToRenderCache[dimCombIDKey];}
if(!this.isUpdateCacheReq){this.isUpdateCacheReq=true;}
var asinToRender=null;if(!this.intermediateAsinToRenderCache.hasOwnProperty(dimCombIDKey)){asinToRender=this.gAsinAvailable(dimCombID,constantDimPos);}
if(asinToRender!=null){if(this.isUpdateCacheReq){this.updateAsinToRenderCache(asinToRender);this.isUpdateCacheReq=false;}
return asinToRender;}
var dimArray=dimCombID.split("_");var noOfDimensions=dimArray.length;for(var pos=0;pos<noOfDimensions;pos++){if(pos==constantDimPos||dimArray[pos]=="X"){continue;}
var preValAtPos=dimArray[pos];dimArray[pos]="X";var newDimCombID=dimArray.join("_");var newDimCombIDKey=newDimCombID+":"+constantDimPos;dimArray[pos]=preValAtPos;if(this.intermediateAsinToRenderCache.hasOwnProperty(newDimCombIDKey)){continue;}
asinToRender=this.gAsinAvailable(newDimCombID,constantDimPos);if(asinToRender!=null){if(this.isUpdateCacheReq){this.updateAsinToRenderCache(asinToRender);this.isUpdateCacheReq=false;}
return asinToRender;}}
var firstNonXDimPos=-1;for(var pos=0;pos<noOfDimensions;pos++){if(dimArray[pos]!="X"&&pos!=constantDimPos){firstNonXDimPos=pos;break;}}
if(firstNonXDimPos==-1){return'';}
dimArray[firstNonXDimPos]="X";var newDimCombID=dimArray.join("_");return this.gAsinToRender(newDimCombID,constantDimPos);}}
Twister.Model=function(handle,pageRefresh){var self=this;this.pageRefresh=pageRefresh;this.viewHandle=handle.view;this.state=new Twister.State();this.variationsData=new Twister.VariationsData();this.preHoverClass='';this.prefetchParentIDList={"type":"parent","data":[]};this.prefetchPartialIDList={"type":"partial","data":[]};this.prefetchFullIDList={"type":"full","data":[]};this.prefetchMasterIDList={"type":"master","data":[]};this.idsList={};this.prefetchCount=0;this.smartPrefetchWeblab=0;this.prefetchFixWeblab=0;this.prioritizeReqPrefetch=0;this.ajaxFetchesStarted=false;this.clearFetchList=function(){this.prefetchParentIDList["data"]=[];this.prefetchPartialIDList["data"]=[];this.prefetchFullIDList["data"]=[];this.prefetchMasterIDList["data"]=[];this.idsList={};this.prefetchCount=0;}
this.addToPrefetchList=function(list,id,asin,prefetch,isHover)
{if(!isHover)isHover=0;if(this.idsList[id]==1)return;if(!(id&&asin))return;if(this.prefetchFixWeblab){if((asin==this.state.parentASIN)&&(list["type"]=="full"))return;if((prefetch==1)&&(this.prefetchCount>=this.MAX_PREFETCH_COUNT)&&(list["type"]!=="master")){return;}}
if(twisterController.model.variationsData.enablePrefetchRankingWeblab&&prefetch&&(id==asin)){if(twisterController.model.variationsData.childPrefetchRankData!=null&&asin in twisterController.model.variationsData.childPrefetchRankData){if(twisterController.model.variationsData.childPrefetchRankData[asin]>twisterController.model.variationsData.rankThreshold){return;}}}
if(prefetch&&this.smartPrefetchWeblab){var cacheStatus=this.pageRefresh.model[list["type"]].cache.getValue(id,"cacheStatus");if(cacheStatus&&((cacheStatus=="preFetched")||(cacheStatus=="completeFetched")||(cacheStatus=="hotFeaturesFetching"))){return;}}
if(list){this.idsList[id]=1;if(prefetch==1)this.prefetchCount++;list["data"].push({"id":id,"asin":asin,"isPrefetch":prefetch,"isHover":isHover});}}
this.doReact=function(isHover,refreshDone){if(!isHover)isHover=0;var reactList=[];if(this.prefetchParentIDList["data"].length>0)reactList.push({"type":"parent","idList":this.prefetchParentIDList["data"]});if(this.prefetchPartialIDList["data"].length>0)reactList.push({"type":"partial","idList":this.prefetchPartialIDList["data"]});if(this.prefetchFullIDList["data"].length>0)reactList.push({"type":"full","idList":this.prefetchFullIDList["data"]});if(this.prefetchMasterIDList["data"].length>0)reactList.push({"type":"master","idList":this.prefetchMasterIDList["data"]});if(reactList.length>0){if(!isHover){this.pageRefresh.measurement.stampCustomMetrics("ns",this.state.getCurrentASIN());}
this.pageRefresh.react(reactList,isHover,refreshDone);}
this.clearFetchList();}
this.init=function(data){if(data){if(window.twisterInitPrefetchMode!=2){this.MAX_PREFETCH_COUNT=data["prefetchCount"];}else{this.MAX_PREFETCH_COUNT=0;var twisterModel=this;var origPreFetchCount=data["prefetchCount"];Twister.$(window).load(function(){twisterModel.MAX_PREFETCH_COUNT=origPreFetchCount;});}
this.prioritizeReqPrefetch=data["prioritizeReqPrefetch"];this.hidePopover=data["hidePopover"];this.unavailablePopOverStringValue=data["unavailablePopOverStringValue"];this.showDimSecondUnavailablePopover=data["showDimSecondUnavailablePopover"];this.smartPrefetchWeblab=data["smartPrefetchWeblab"];this.prefetchFixWeblab=data["prefetchFixWeblab"];var stateData=data["stateData"];var variationsData=data["variationsData"];var viewData=data["viewData"];this.state.init(stateData);this.variationsData.init(variationsData);var currentAsin=stateData["current_asin"];if(twisterController.model.variationsData.useMS&&twisterController.model.state.currentASIN&&twisterController.model.variationsData.asinToDimIndexMapData[twisterController.model.state.currentASIN])twisterController.model.state.setMaster(twisterController.model.variationsData.asinToDimIndexMapData[twisterController.model.state.currentASIN][0]);var asinData=this.variationsData.getAsinData(this.state.getCurrentDimCombID());var dimensionValuesData=this.variationsData.getDimensionValuesDisplayData(currentAsin);this.viewHandle.init(viewData,asinData,dimensionValuesData,this.state.dimensionSelectionData,this.variationsData.dimensionValuesData);this.updateInteractedVariations("selected",dimensionValuesData);this.updateInteractedVariations("hovered",dimensionValuesData);}
this.pageRefresh.init(stateData.storeID,stateData.productGroupID);}
this.setSelectionState=function(divMetaData,newDimCombID){var dimIndex=divMetaData["dimIndex"];var dimSelection=this.state.dimensionSelectionData[dimIndex];if((typeof(this.preHoverClass)!=='undefined'&&(this.preHoverClass.indexOf('swatchUnavailable')!==-1||this.preHoverClass.indexOf('dropdownUnavailable')!==-1))||divMetaData["dimValueIndex"]===-1){this.state.setPartialState(dimIndex,newDimCombID);}}
this.setPreHoverData=function(divMetaData){if(!this.variationsData.useMS){this.preHoverClass=this.getAttachedClass(divMetaData);}}
this.getAttachedClass=function(divMetaData){var dimIndex=divMetaData["dimIndex"];var dimValueIndex=divMetaData["dimValueIndex"];var dimName=this.viewHandle.dimensionsMap[dimIndex];var divToFetch="#"+dimName+"_"+dimValueIndex;var isSwatch=Twister.$(divToFetch).is("li");if(Twister.useAui&&Twister.useNativeDD){if(!isSwatch){divToFetch="#native_"+dimName+"_"+dimValueIndex;}
return Twister.$(divToFetch).attr('class');}else{return Twister.$(divToFetch).get(0).className;}}
this.prefetchInitialContent=function(){var asin=this.state.currentASIN;var parentAsin=this.state.parentASIN;var dimIndex=this.variationsData.asinToDimIndexMapData[asin];if(this.ajaxFetchesStarted){return;}
this.ajaxFetchesStarted=true;if(window.twisterInitPrefetchMode){return;}
if(this.variationsData.useMS&&dimIndex&&asin)this.addToPrefetchList(this.prefetchMasterIDList,"m"+dimIndex[0],asin,1);if(Twister.hasOwnProperty("prefetchRelatedAttrs")&&Twister.prefetchRelatedAttrs.performLandingAsinPrefetch){if(this.state.unselectedDimCount==0){this.addToPrefetchList(this.prefetchFullIDList,asin,asin,1);}
else{var reactID=this.getReactID(this.state.currentDimCombID,1);if(reactID!='X')this.addToPrefetchList(this.prefetchPartialIDList,reactID,asin,1);else this.addToPrefetchList(this.prefetchFullIDList,asin,asin,1);}}
else{this.prefetchCount++;}
if(this.state.getMatchingDimIndex(-1,1)!=-1){if(Twister.hasOwnProperty("prefetchRelatedAttrs")&&Twister.prefetchRelatedAttrs.performParentPrefetch){this.addToPrefetchList(this.prefetchParentIDList,parentAsin,parentAsin,1);}
else{this.prefetchCount++;}}
var matchingDimIndex=this.state.getMatchingDimIndex(-1,this.prioritizeReqPrefetch);var currCombIDArray=this.state.currentDimCombID.split("_");var divMetaData;if(this.state.currentDimCombID.search(/[^X_]/)<0||matchingDimIndex<0)divMetaData=null;else divMetaData={"dimIndex":matchingDimIndex,"dimValueIndex":currCombIDArray[matchingDimIndex]};this.fetchContent(this.state.currentDimCombID,0,divMetaData);}
this.getReactID=function(newDimCombID,partialState){var newReactIDArray=newDimCombID.split("_");var dimSelectionData=this.state.dimensionSelectionData;for(var pos=0;pos<dimSelectionData.length;pos++){if(dimSelectionData[pos]["isRequired"]==1&&partialState!=0){newReactIDArray[pos]="X";}}
var newReactID=newReactIDArray.join("_");return newReactID;}
this.fetchImmediateIds=function(currReactId,newReactId,currPartial,newPartial,newAsin,parentAsin,isHover){var prefetchId=0;var dimIndex=this.variationsData.asinToDimIndexMapData[newAsin];if(this.variationsData.useMS&&dimIndex&&newAsin)this.addToPrefetchList(this.prefetchMasterIDList,"m"+dimIndex[0],newAsin,prefetchId,isHover);if(newPartial==0){this.addToPrefetchList(this.prefetchFullIDList,newAsin,newAsin,prefetchId,isHover);this.prioritizeReqPrefetch=0;}
else{if(currPartial==0){this.addToPrefetchList(this.prefetchPartialIDList,newReactId,newAsin,prefetchId,isHover);this.addToPrefetchList(this.prefetchParentIDList,parentAsin,parentAsin,prefetchId,isHover);this.prioritizeReqPrefetch=1;}
else{if(currReactId!=newReactId){this.addToPrefetchList(this.prefetchPartialIDList,newReactId,newAsin,prefetchId,isHover);}}}}
this.fetchContent=function(dimCombID,isHover,divMetaData,refreshDone){var partial=(dimCombID.search(/X/)>=0);if(Twister.hasOwnProperty("prefetchRelatedAttrs")&&Twister.prefetchRelatedAttrs.performPrefetches&&!isHover){var matchingDimIndex=-1;var dimCombIDArray=dimCombID.split('_');var dimSelectionData=this.state.dimensionSelectionData;var dimensionValuesData=this.variationsData.dimensionValuesData;var newDivMetaData;var reqVal=this.prioritizeReqPrefetch;var checkedReqNonReq=0;var nrSelectionFirstLoop=false;var visitedNrDimIndex=-1;var prefetchStartPos;if(divMetaData&&dimSelectionData[divMetaData["dimIndex"]]["isRequired"]!=1){matchingDimIndex=divMetaData["dimIndex"];nrSelectionFirstLoop=true;visitedNrDimIndex=divMetaData["dimIndex"];}
while(this.prefetchCount<this.MAX_PREFETCH_COUNT){if(nrSelectionFirstLoop==true){newDivMetaData=divMetaData;prefetchStartPos=(newDivMetaData["dimValueIndex"]!="X")?parseInt(newDivMetaData["dimValueIndex"]):-1;nrSelectionFirstLoop=false;matchingDimIndex=-1;}else{matchingDimIndex=this.state.getMatchingDimIndex(matchingDimIndex,reqVal);if(matchingDimIndex<0){if(checkedReqNonReq==1)break;if(!partial&&reqVal==0){if(Twister.hasOwnProperty("prefetchRelatedAttrs")&&!Twister.prefetchRelatedAttrs.prefetchOtherReqDimensions){break;}}
reqVal=reqVal?0:1;checkedReqNonReq=1;continue;}else{if(matchingDimIndex==visitedNrDimIndex)continue;var currCombIDArray=this.state.currentDimCombID.split("_");prefetchStartPos=(currCombIDArray[matchingDimIndex]!='X')?parseInt(currCombIDArray[matchingDimIndex]):-1;newDivMetaData={"dimIndex":matchingDimIndex,"dimValueIndex":currCombIDArray[matchingDimIndex]};}}
if(newDivMetaData!=null){var direction=1;var offSet=1;var dimValues=dimensionValuesData[newDivMetaData["dimIndex"]];var len=dimValues.length;var newPos=prefetchStartPos;var currPos=newPos;var singleDir=0;var prefetchAsin;var prefetchID;var prefetchPartial;while(len>=1){currPos=newPos;newPos=currPos+(offSet*direction);if(newPos<0||newPos>=dimValues.length){direction=-1*direction;offSet=1;newPos=currPos+(offSet*direction);singleDir=1;}else{if(singleDir!=1)direction=-1*direction;}
var currArray=dimCombIDArray;currArray[newDivMetaData["dimIndex"]]=newPos;var newID=currArray.join('_');if(singleDir!=1)offSet++;len--;prefetchAsin=this.variationsData.gAsinToRender(newID,newDivMetaData["dimIndex"]);prefetchID=this.variationsData.getNewDimCombID(prefetchAsin,this.state.dimensionSelectionData,this.state.getCurrentDimCombID(),newDivMetaData);prefetchPartial=(prefetchID.search(/X/)>=0);if(prefetchPartial){if(!Twister.hasOwnProperty("prefetchRelatedAttrs")||!Twister.prefetchRelatedAttrs.performPartialPrefetch){continue;}
var prefetchReactID=this.getReactID(prefetchID,1);this.addToPrefetchList(this.prefetchPartialIDList,prefetchReactID,prefetchAsin,1);}else{this.addToPrefetchList(this.prefetchFullIDList,prefetchAsin,prefetchAsin,1);}
if(this.prefetchCount>=this.MAX_PREFETCH_COUNT)break;}}}}
this.doReact(isHover,refreshDone);}
var getReqDimChangedEventData=function(dimensionSelectionData,currentDimCombId,newDimCombId){var currentDimCombIdArray=currentDimCombId.split("_");var newDimCombIdArray=newDimCombId.split("_");var reqDimChangedEventData=null;Twister.$.each(dimensionSelectionData,function(index,selectionData){if(selectionData["isRequired"]===1&&currentDimCombIdArray[index]!==newDimCombIdArray[index]){reqDimChangedEventData={"oldReqDimValueIndex":currentDimCombIdArray[index],"newReqDimValueIndex":newDimCombIdArray[index]};return false;}});return reqDimChangedEventData;}
this.handleClick=function(divMetaData,asin,isHover,requestedOn){var self=this;if(!isHover&&requestedOn=="swatchClick"&&Twister.predictivePrefetch){var prefetchContextData=TwisterPrefetch.getPrefetchContext(divMetaData);Twister.CPMetrics.record(prefetchContextData.newDimCombID,"clicked",new Date().getTime());}
if(!isHover)isHover=0;if(asin==null){if(divMetaData==null){return;}
var current=this.state.getCurrentASIN();asin=this.variationsData.getAsinFromDiv(current,divMetaData,this.state.dimensionSelectionData,this.state.currentDimCombID);}
var EVDDreturn=0;if(twisterController.model.variationsData.useMS&&divMetaData&&this.isSwatchSelected(divMetaData))EVDDreturn=1;if(divMetaData&&divMetaData["dimIndex"]&&divMetaData["dimIndex"]=='0'){this.state.setMaster(divMetaData["dimValueIndex"]);}
if(!isHover)this.ajaxFetchesStarted=true;var currPartialState=-1;currPartialState=this.state.getSelectionState();if(asin==''){if(currPartialState<=0){return;}
asin=current;}
var newDimCombID=this.variationsData.getNewDimCombID(asin,this.state.dimensionSelectionData,this.state.getCurrentDimCombID(),divMetaData);var partialState=-1,reactId;if(!isHover){this.setSelectionState(divMetaData,newDimCombID);partialState=this.state.getSelectionState(divMetaData);if(current!=asin&&!partialState){if(DetailPageFramework.callbacks["sims-widget_feature_div"]){DetailPageFramework.callbacks["sims-widget_feature_div"](DetailPage.StateController.getState());}}
reactId=this.state.reactId;if(Twister.isLoggingEnabled){try{var changedRequiredDim=getReqDimChangedEventData(this.state.dimensionSelectionData,this.state.getCurrentDimCombID(),newDimCombID);if(changedRequiredDim){twisterController.logger.logImpression(twisterController.logger.eventTypes.REQ_DIM_CHANGED,changedRequiredDim);}}
catch(e){}}}
else{partialState=(newDimCombID.search(/X/)>=0)?1:0;reactId=this.state.hoveredReactId;}
if(!partialState&&!isHover)this.pageRefresh.measurement.start(asin,requestedOn);var newReactId=this.getReactID(newDimCombID,partialState);this.state.setCurrentASIN(asin);this.state.setCurrentDimCombID(newDimCombID);this.state.reactId=newReactId;var asinData=this.variationsData.getAsinData(newDimCombID);var dimensionValuesData=this.variationsData.getDimensionValuesDisplayData(asin);DetailPage.StateController.setState('current_asin',asin);var variationLabelOrder=DetailPage.StateController.getState()['variation_label_order'];this.updateInteractedVariations("selected",dimensionValuesData);this.updateInteractedVariations("hovered",dimensionValuesData);if(!partialState&&!isHover){this.pageRefresh.measurement.stampCustomMetrics("bb",asin);}
this.viewHandle.update(asinData,dimensionValuesData,this.state.dimensionSelectionData,this.variationsData.dimensionValuesData,isHover,this.unavailablePopOverStringValue,this.showDimSecondUnavailablePopover);if(!partialState&&!isHover){this.pageRefresh.measurement.stampCustomMetrics("be",asin);}
if(EVDDreturn==1){EVDDreturn=0;return;}
var matchingDimIndex=this.state.getMatchingDimIndex(-1,this.prioritizeReqPrefetch);var newDimCombIDArray=newDimCombID.split("_");var newDivMetaData;if(matchingDimIndex<0)newDivMetaData=null;else newDivMetaData={"dimIndex":matchingDimIndex,"dimValueIndex":newDimCombIDArray[matchingDimIndex]};var pStatus,noFetchContent;if(!isHover&&requestedOn=="swatchClick"&&Twister.predictivePrefetch){TwisterPrefetch.prioritizeThisRequest(prefetchContextData);pStatus=TwisterPrefetch.getPrefetchStatus(prefetchContextData);if(Twister.printConsoleLogs)console.log("Processing for click event, request status: "+pStatus,prefetchContextData);if(pStatus&&pStatus!=="completeFetched"){var refreshDone=true;TwisterPrefetch.addClickCallbacks(prefetchContextData,this,function(){if(Twister.printConsoleLogs)console.log("Prefetch callback from addClickCallbacks , eventdata:  newDimCombID",newDimCombID," isHover: ",isHover," newDivMetaData: ",newDivMetaData);var prefetching=true;self.fetchImmediateIds(reactId,newReactId,currPartialState,partialState,asin,self.state.parentASIN,isHover);self.fetchContent(newDimCombID,isHover,newDivMetaData,prefetching);TwisterPrefetch.recordImpression(prefetchContextData);});noFetchContent=true;}}
if(!noFetchContent){if(Twister.printConsoleLogs)console.log("Calling fetchContent without prefetching or prefetching completed");this.fetchImmediateIds(reactId,newReactId,currPartialState,partialState,asin,this.state.parentASIN,isHover);this.fetchContent(newDimCombID,isHover,newDivMetaData);}
if(requestedOn=="swatchClick"&&Twister.predictivePrefetch&&pStatus=="completeFetched"){TwisterPrefetch.recordImpression(prefetchContextData);}}
this.updateInteractedVariations=function(updateType,dimensionValuesData){var interactedVariations={};var interactedDim='';for(var dimIdx=0;dimIdx<dimensionValuesData.length;dimIdx++){interactedDim=null;if(this.state.isDimSelected(dimIdx)){interactedDim=dimensionValuesData[dimIdx];if(interactedDim=='(Please Select)'){interactedDim=null;}}
if(window.isTwisterAUI&&interactedDim!==null){interactedDim=htmlUnescape(interactedDim);}
interactedVariations[this.viewHandle.dimensionsMap[dimIdx]]=interactedDim;}
DetailPage.StateController.setState(updateType+'_variations',interactedVariations);}
function htmlUnescape(value){return String(value)
.replace(/&quot;/g,'"')
.replace(/&#39;/g,"'")
.replace(/&lt;/g,'<')
.replace(/&gt;/g,'>')
.replace(/&amp;/g,'&');}
this.isSwatchSelected=function(divMetaData){var divToModify='#'+this.viewHandle.dimensionsMap[divMetaData["dimIndex"]]+"_"+divMetaData["dimValueIndex"];var myClass=Twister.$(divToModify).get(0).className;if(myClass=='swatchUnavailableHover'||myClass=="swatchUnavailable"){Twister.$("#twisterPopover.twisterPopoverSkin").hide();}
return(myClass=='swatchSelect');}
this.handleMouseOver=function(divMetaData){if(divMetaData==null){return;}
if(divMetaData&&divMetaData["dimIndex"]=='0'){this.state.setMaster(divMetaData["dimValueIndex"]);}
if(this.isSwatchSelected(divMetaData)&&!twisterController.model.variationsData.useMS)return;var current=this.state.getCurrentASIN();var asin=this.variationsData.getAsinFromDiv(current,divMetaData,this.state.dimensionSelectionData,this.state.currentDimCombID);var currPartialState=this.state.getSelectionState();if(asin==''){if(currPartialState<=0){return;}
asin=current;}
var reactId=this.state.reactId;var newDimCombID=this.variationsData.getNewDimCombID(asin,this.state.dimensionSelectionData,this.state.getCurrentDimCombID(),divMetaData);var partialState=(newDimCombID.search(/X/)>=0)?1:0;var newReactId=this.getReactID(newDimCombID,partialState);this.state.hoveredReactId=newReactId;this.setPreHoverData(divMetaData);var dimensionValuesData=this.variationsData.getDimensionValuesDisplayData(asin);if(!twisterController.model.variationsData.useMS)this.updateInteractedVariations("hovered",dimensionValuesData);var asinData=this.variationsData.getAsinData(newDimCombID);var dimNameC=this.viewHandle.dimensionsMap[divMetaData['dimIndex']];var dimValCountIndex=divMetaData['dimValueIndex'];var modifiedDiv='#'+dimNameC+"_"+dimValCountIndex;if(!(this.variationsData.useMS))var oldClassName=Twister.$(modifiedDiv).get(0).className;this.viewHandle.updateMouseOver(asinData,dimensionValuesData,oldClassName,divMetaData,this.variationsData.dimensionValuesData,this.state.dimensionSelectionData,this.hidePopover,this.unavailablePopOverStringValue,this.showDimSecondUnavailablePopover);this.fetchImmediateIds(reactId,newReactId,currPartialState,partialState,asin,this.state.parentASIN,1);var matchingDimIndex=this.state.getMatchingDimIndex(-1,this.prioritizeReqPrefetch);var newDimCombIDArray=newDimCombID.split("_");var newDivMetaData;if(matchingDimIndex<0)newDivMetaData=null;else newDivMetaData={"dimIndex":matchingDimIndex,"dimValueIndex":newDimCombIDArray[matchingDimIndex]};this.fetchContent(newDimCombID,1,newDivMetaData);}
this.handleMouseOut=function(divMetaData,dimIndex,dimValue){var current=this.state.getCurrentASIN();if(!twisterController.model.variationsData.useMS&&this.isSwatchSelected(divMetaData))return;this.handleClick(null,current,1);}}
Twister.View=function(){this.dimensionsMap={};this.dimensionDisplayMap={};this.dimensionDisplayTypeMap={};this.dimensionViewHandlersMap={};this.isToggleSwatches=0;this.masterDimIndex=0;this.slaveDimIndex=1;this.dimensionViewsFactory=new Twister.DimensionViews.Factory();this.suppressEventMap={};this.shouldSuppressEvent=function(dimIndex,optionValue){var key=dimIndex+':'+optionValue;var retVal=0;if(dimIndex>=0&&optionValue>=-1&&this.suppressEventMap[key]!=null){retVal=this.suppressEventMap[key];this.clearEventForSuppress(dimIndex,optionValue);}
return retVal;}
this.markEventForSuppress=function(dimIndex,optionValue){var key=dimIndex+':'+optionValue;if(dimIndex>=0&&optionValue>=-1){this.suppressEventMap[key]=1;}}
this.clearEventForSuppress=function(dimIndex,optionValue){var key=dimIndex+':'+optionValue;if(dimIndex>=0&&optionValue>=-1){this.suppressEventMap[key]=0;}}
this.triggerDropdownChange=function(dropDownDiv,dimIndex,optionValue){this.markEventForSuppress(dimIndex,optionValue);Twister.$(dropDownDiv).trigger("change");}
this.initEvents=function(asinData,dimensionValuesData,dimensionSelectionData,dimensionValuesDataGlobal){var hasSwatchDim=false;var dimensionViewHandler;for(var dimCount in asinData){var dimData=asinData[dimCount];var dimName=this.dimensionsMap[dimCount];var dimDisplayType=this.dimensionDisplayTypeMap[dimCount];if(dimDisplayType==="etdd"){var EVDDConstructorFunction=this.dimensionViewsFactory.getEVDDConstructorFunction();dimensionViewHandler=new EVDDConstructorFunction(Twister.$,dimCount,dimName,dimData,this.dimensionsMap,this.dimensionDisplayMap[dimCount],dimensionValuesDataGlobal[dimCount]);this.dimensionViewHandlersMap[dimCount]=dimensionViewHandler;continue;}
if(dimDisplayType=='singleton'){continue;}
else if(dimDisplayType=='swatch'){hasSwatchDim=true;}
if(dimDisplayType=='dropdown'){var divName="dropdown_selected_"+dimName;var divToModify="#"+((Twister.useAui&&Twister.useNativeDD)?"native_":"")+divName;var nativeDivToModify="#native_"+divName;var divMetaData={"dimIndex":dimCount};(function(divMetaDataLocal,divNameLocal){if(Twister.useAui){var callBackFn=function(event){if(twisterController){twisterController.handleDropdownOnChange(event,divMetaDataLocal);}}
P.when("A").execute(function(A){A.on("a:dropdown:selected:"+divNameLocal,callBackFn);});}else{Twister.$(divToModify).removeAttr('onchange');Twister.$(divToModify).change(function(event){if(twisterController){twisterController.handleDropdownOnChange(event,divMetaDataLocal);}});}})(divMetaData,divName);continue;}
var initialPrefetchTime;for(var dimValCount in dimData){var divToModify="#"+dimName+"_"+dimValCount;var divMetaData={"dimIndex":dimCount,"dimValueIndex":dimValCount};var myClass=Twister.$(divToModify).get(0).className;var dimValueData=dimData[dimValCount];var classToAttach=dimValueData["style"];if(myClass!=classToAttach){Twister.$(divToModify).removeClass().addClass(classToAttach);}
if(dimDisplayType=='dropdown'){continue;}
if(!(dimDisplayType=='swatch'&&this.isToggleSwatches))
{(function(divMetaDataLocal){Twister.$(divToModify).click(function(){if(twisterController){twisterController.handleClick(divMetaDataLocal);}});Twister.$(divToModify).mouseover(function(){if(twisterController){if(!initialPrefetchTime)initialPrefetchTime=window.setTimeout(prefetchOnMouseOver,100);twisterController.handleMouseOver(divMetaDataLocal);}});Twister.$(divToModify).mouseout(function(){if(twisterController){window.clearTimeout(initialPrefetchTime);initialPrefetchTime=null;twisterController.handleMouseOut(divMetaDataLocal);}});})(divMetaData);}}
var prefetchOnMouseOver=function(){if(!twisterController.model.ajaxFetchesStarted){if(Twister.printConsoleLogs){console.log("calling prefetchInitialContent after MouseOver");}
twisterController.model.prefetchInitialContent(twisterController);}};Twister.$('#dropdown_selected_'+dimName).mouseover(function(){if(!initialPrefetchTime)initialPrefetchTime=window.setTimeout(prefetchOnMouseOver,100);});Twister.$('#dropdown_selected_'+dimName).mouseout(function(){window.clearTimeout(initialPrefetchTime);initialPrefetchTime=null;});Twister.$('#'+dimName+'_DonsBox_DonsBox').mouseover(function(){if(!initialPrefetchTime)initialPrefetchTime=window.setTimeout(prefetchOnMouseOver,100);});Twister.$('#'+dimName+'_DonsBox_DonsBox').mouseout(function(){window.clearTimeout(initialPrefetchTime);initialPrefetchTime=null;});}
if(hasSwatchDim&&this.isToggleSwatches)
{this.initSwatchToggleActions();}
Twister.$('#nonJSEVDD').hide();Twister.$('#newTwisterEVDD').show();}
this.getPopoverContent=function(currDimIndex,dimensionSelectionData,unavailablePopOverStringValue,showDimSecondUnavailablePopover)
{var popoverContent=twisterController.useDpx?unavailablePopOverStringValue:'<span class="twisterPopoverContent"> '+unavailablePopOverStringValue+' </span>';var dimContent='';var dimensionDisplayMap=this.dimensionDisplayMap;for(var dimIndex=0;dimIndex<dimensionSelectionData.length;dimIndex++){if(dimIndex!=currDimIndex){if(dimensionSelectionData[dimIndex]["isSelected"]==1){if(dimContent){dimContent=dimContent+', '+dimensionDisplayMap[dimIndex];}else{dimContent=dimensionDisplayMap[dimIndex];}}}}
if(twisterController.useDpx){dimContent='<strong>'+dimContent+'</strong>';if(showDimSecondUnavailablePopover)
{popoverContent=popoverContent+'&nbsp;'+dimContent;}
else
{popoverContent=dimContent+'&nbsp;'+popoverContent;}}
else{dimContent='<span class="twisterPopoverContent twisterPopoverDim">'+dimContent+'</span>';if(showDimSecondUnavailablePopover)
{popoverContent=popoverContent+dimContent;}
else
{popoverContent=dimContent+popoverContent;}}
return popoverContent;}
this.triggerPopover=function(currDimIndex,dimValueIndex,dimensionValuesDataGlobal,dimensionValuesData,dimensionSelectionData,unavailablePopOverStringValue,showDimSecondUnavailablePopover){if(typeof(touchDeviceDetected)!="undefined"&&touchDeviceDetected)return;var popoverContent=this.getPopoverContent(currDimIndex,dimensionSelectionData,unavailablePopOverStringValue,showDimSecondUnavailablePopover);var dimName=this.dimensionsMap[currDimIndex];var divToFetch=dimName+"_"+dimValueIndex;var dimensionDisplay=this.dimensionDisplayMap[currDimIndex];var popoverClass='ap_body';var skinStyles="<div id='twisterPopover' class='ap_popover twisterPopoverSkin'>";var locationOffsetToUse=[0,-5];if(twisterController.useDpx){skinStyles="<div id='twisterPopover' class='ap_popover twisterPopoverSkin a-text-color-white'>";locationOffsetToUse=[2,22];}
if(Twister.$.browser.msie)popoverClass+=' styleIE';var popoverTrigger;if(!Twister.useAui){popoverTrigger=Twister.$('#'+divToFetch);}
Twister.$.AmazonPopover.displayPopover({modal:false,showOnHover:true,draggable:false,showCloseButton:false,hoverShowDelay:50,hoverHideDelay:0,width:null,closeEventInclude:"CLICK_TRIGGER",literalContent:popoverContent,skin:skinStyles+
"<div class='ap_header'>"+
"</div>"+
"<div class='"+popoverClass+"'>"+
"<div class='ap_content'></div>"+
"</div>"+
"<div class='ap_footer'>"+
"<div class='ap_middle'></div>"+
"</div>"+
"</div>",location:"top",locationElement:Twister.$('#'+divToFetch),align:"center",attached:false,group:"TwisterPopover",locationOffset:locationOffsetToUse,paddingLeft:5,paddingRight:5,paddingBottom:5,onShow:function(){var widthToUse=Twister.$('#twisterPopover').width();if(Twister.$.browser.msie){Twister.$("#twisterPopover").find(".ap_footer").find(".ap_middle").addClass("twisterPopoverArrow").css({top:"16px",width:widthToUse-68+"px"});}else{Twister.$("#twisterPopover").find(".ap_footer").find(".ap_middle").addClass("twisterPopoverArrow").css({width:widthToUse-68+"px"});}}},popoverTrigger);Twister.$('#'+divToFetch).trigger('mouseover.amzPopover');}
this.tapDetection=function(eventName,touch,newTouch){var TAP_MOVE_THRESHOLD=20;if(!(touch&&touch.$event&&newTouch.$event&&newTouch.$event.originalEvent))return false;if(Twister.printConsoleLogs)
console.log(eventName,": swatchID: ",newTouch.data.dimIndex,", ",newTouch.data.dimValueIndex,"  X, Y",newTouch.$event.pageX,", ",newTouch.$event.pageY);if(Twister.A.equals(touch.data,newTouch.data)){if(typeof touch.deltaX==="undefined")touch.deltaX=0;if(typeof touch.deltaY==="undefined")touch.deltaY=0;touch.deltaX=newTouch.$event.pageX&&touch.$event.pageX?Math.abs(newTouch.$event.pageX-touch.$event.pageX):touch.deltaX;touch.deltaY=newTouch.$event.pageY&&touch.$event.pageY?Math.abs(newTouch.$event.pageY-touch.$event.pageY):touch.deltaY;touch.multi=touch.multi||newTouch.$event.originalEvent.targetTouches.length>1;var tapThreshold=(touch.deltaX<TAP_MOVE_THRESHOLD&&touch.deltaY<TAP_MOVE_THRESHOLD);if(!touch.multi&&(eventName==="touchend"||eventName==="touchcancel")&&tapThreshold){if(Twister.printConsoleLogs)console.log(" TAP detected: with delta: X, Y",touch.deltaX,", ",touch.deltaY);return true;}}
return false;}
this.initSwatchToggleActions=function(){var self=this;var touchStart,touchEnd;var eventList=['click','mouseenter','mouseleave','mousedown','touchstart','touchend','touchcancel','touchmove'];var eventMetrics={};function logCounter(name,value){if(ue&&ue.count)ue.count(name,value);if(Twister.printConsoleLogs)console.log(name," : ",value);}
function measureAndReportEventData(swatch,eventName){if(typeof swatch.dimValueIndex==="undefined"||typeof swatch.dimIndex==="undefined"||!Twister.A.capabilities.touch)return;var prefix="dpSwatch",swatchId=swatch.dimValueIndex+'_'+swatch.dimIndex,timeDiff;if(eventMetrics["swatch"]!==swatchId){eventMetrics["tap"]=0;eventMetrics["mouseenter"]=0;}
eventMetrics["swatch"]=swatchId;eventMetrics[eventName]=new Date().getTime();if(eventMetrics["tap"]&&eventMetrics["mouseenter"]){timeDiff=eventMetrics["mouseenter"]-eventMetrics["tap"];if(timeDiff<0){logCounter(prefix+"NegativeTap",1);logCounter(prefix+"NegativeTapValue",Math.abs(timeDiff));}else{logCounter(prefix+"PositiveTap",1);logCounter(prefix+"PositiveTapValue",timeDiff);}
delete eventMetrics;eventMetrics={};}
logCounter(prefix+eventName,1);}
Twister.A.declarative('swatchthumb-action',eventList,function(event){try{var initialPrefetchTime;var doPredictivePrefetch=false;var prefetchOnMouseOver=function(){if(!twisterController.model.ajaxFetchesStarted){if(Twister.printConsoleLogs){console.log("calling prefetchInitialContent after MouseOver");}
twisterController.model.prefetchInitialContent(twisterController);}};if(twisterController){if(event.type=='click'){twisterController.handleClick(event.data,"swatchClick");}else if(event.type=='mouseenter'){if(Twister.tapEnabled){measureAndReportEventData(event.data,event.type);}
if(!initialPrefetchTime)initialPrefetchTime=window.setTimeout(prefetchOnMouseOver,100);twisterController.handleMouseOver(event.data);}else if(event.type=='mouseleave'){window.clearTimeout(initialPrefetchTime);initialPrefetchTime=null;twisterController.handleMouseOut(event.data,event.data['dimIndex'],event.data['dimValueIndex']);}else if(event.type==="mousedown"){doPredictivePrefetch=true;}else if(event.type==="touchstart"){if(Twister.printConsoleLogs)console.log(" touchstart: swatch: ",event.data.dimIndex,", ",event.data.dimValueIndex,"  X, Y",event.$event.pageX,", ",event.$event.pageY);doPredictivePrefetch=true;touchStart=event;}else if(Twister.tapEnabled){if(event.type==="touchmove"){twisterController.view.tapDetection(event.type,touchStart,event);}else if(event.type==="touchend"||event.type==="touchcancel"){touchEnd=event;if(twisterController.view.tapDetection(event.type,touchStart,touchEnd)){measureAndReportEventData(event.data,"tap");var handleClickStartTime=new Date().getTime();twisterController.handleClick(event.data,"swatchClick");logCounter("dpSwatchHandleClick",new Date().getTime()-handleClickStartTime);}}}}
if(doPredictivePrefetch&&Twister.predictivePrefetch==="T1"){var context=TwisterPrefetch.getPrefetchContext(event.data);Twister.CPMetrics.record(context.newDimCombID,"predicted",new Date().getTime());TwisterPrefetch.prefetchContent(context);}}catch(err){if(Twister.printConsoleLogs)console.log(err);}});}
this._constructEventInfoObject=function _constructEventInfoObject(eventType,dimData,divMetaData){var eventInfo={},eventData={};eventInfo["eventType"]=eventType;eventData["dimData"]=dimData;eventData["divMetaData"]=divMetaData;eventInfo["eventData"]=eventData;return eventInfo;}
this.update=function(asinData,dimensionValuesData,dimensionSelectionData,dimensionValuesDataGlobal,isHover,unavailablePopOverStringValue,showDimSecondUnavailablePopover){var eventInfo,eventType;eventType=(isHover)?"mouseOut":"click";for(var dimCount in asinData){var dimData=asinData[dimCount];var dimName=this.dimensionsMap[dimCount];var dimDisplayType=this.dimensionDisplayTypeMap[dimCount];if(dimDisplayType==="etdd"){eventInfo=this._constructEventInfoObject(eventType,dimData,{});this.dimensionViewHandlersMap[dimCount].updateView(eventInfo);continue;}else if(dimDisplayType=='singleton'){continue;}
var dimensionValueDisplay=dimensionValuesData[dimCount];var dimensionDisplay=this.dimensionDisplayMap[dimCount];var dimensionValueDiv="#selected_"+dimName;var displayString='<b class=variationDefault> '+dimensionDisplay+': </b><b class=variationLabel> '+dimensionValueDisplay+' </b>';if(dimDisplayType!='dropdown'){Twister.$(dimensionValueDiv).html(displayString);if(twisterController.useDpx){Twister.$("#variation_"+dimName+" .selection").html(dimensionValueDisplay).removeClass("hover");}}
if(dimDisplayType=='dropdown'){var defaultDivToModify="#"+dimName+"_"+"-1";var dropDownDiv="#dropdown_selected_"+dimName;if(Twister.useAui){dropDownDiv="#native_dropdown_selected_"+dimName;}
var selectedOptionValue=Twister.$(dropDownDiv).val().split(",")[0];if((dimensionSelectionData[dimCount]["isSelected"]==0)&&(selectedOptionValue!="-1")){if(typeof(Twister.AuiDropdownHandle)!='undefined'){Twister.AuiDropdownHandle.getSelect(dropDownDiv).val("-1");}
else{Twister.$(dropDownDiv).val("-1");if(Twister.useAui){this.triggerDropdownChange(dropDownDiv,dimCount,-1);}}}
if(!isHover&&dimensionSelectionData[dimCount]["isRequired"]==0&&dimensionSelectionData[dimCount]["isSelected"]==1){Twister.$(defaultDivToModify).remove();}}
var dimCounter=dimensionSelectionData[dimCount]["isRequired"]?1:0;for(var dimValCount in dimData){var dimValueData=dimData[dimValCount];var classToAttach=dimValueData["style"];if((dimensionSelectionData[dimCount]["isSelected"]==0)&&(classToAttach=='swatchSelect')){classToAttach='swatchAvailable';}
var asinToAttach=dimValueData["event"];var divToModify="#"+dimName+"_"+dimValCount;var nativeDivToModify="#native_"+dimName+"_"+dimValCount;var setDataAttr=0;var optionValueDivToUse=divToModify;if(Twister.useAui&&dimDisplayType==='dropdown'){if(typeof(Twister.AuiDropdownHandle)!='undefined'){divToModify=nativeDivToModify;}
else if(!Twister.$(divToModify).get(0)){divToModify=nativeDivToModify;setDataAttr=1;}
optionValueDivToUse=nativeDivToModify;}
var myClass=Twister.$(divToModify).get(0).className;if(classToAttach=='dropdownSelect'){var optionValue=Twister.$(optionValueDivToUse).attr('value');if(Twister.$(dropDownDiv).val()!=optionValue){if(typeof(Twister.AuiDropdownHandle)!='undefined'){Twister.AuiDropdownHandle.getSelect(dropDownDiv).val(optionValue);}
else{Twister.$(dropDownDiv).val(optionValue);if(Twister.useAui){this.triggerDropdownChange(dropDownDiv,dimCount,optionValue.split(",")[0]);}}}}
var priceDivSelector=divToModify+"_price";var priceClassToAttach="a-color-secondary";if(classToAttach=='swatchSelect'){priceClassToAttach="a-color-price";}
if(myClass!=classToAttach){try{var parentDivName="dropdown_selected_"+dimName;if(dimDisplayType=='dropdown'&&!Twister.useAui){if(classToAttach=='dropdownUnavailable'){document.getElementById(parentDivName).options[dimCounter].style.color="#BBBBBB";}
if(classToAttach=='dropdownAvailable'||classToAttach=='dropdownSelect'){document.getElementById(parentDivName).options[dimCounter].style.color="#006699";}}
if(!setDataAttr){if(dimDisplayType==='dropdown'&&typeof(Twister.AuiDropdownHandle)!='undefined'){Twister.AuiDropdownHandle.updateOption(divToModify,{'css_class':classToAttach,'native_css_class':classToAttach});}
else{Twister.$(divToModify).removeClass().addClass(classToAttach);var priceDivToModify=Twister.$(priceDivSelector);if(priceDivToModify){priceDivToModify.removeClass().addClass(priceClassToAttach);}}}else{Twister.$(divToModify).attr("data-a-css-class",classToAttach);}}catch(e){}}dimCounter++;if(this.isToggleSwatches&&false)
{if((!(myClass=="swatchUnavailable"||myClass=="swatchUnavailableHover"))&&classToAttach=="swatchUnavailable")
{var popoverContent=this.getPopoverContent(dimCount,dimensionSelectionData,unavailablePopOverStringValue,showDimSecondUnavailablePopover);Twister.$(divToModify).find(".tooltip").addClass("a-declarative");Twister.$(divToModify).find(".tooltip").attr("data-action","a-tooltip");Twister.$(divToModify).find(".tooltip").attr("data-a-tooltip",'{"type":"html", "content":"'+popoverContent+'"}');}
else if((myClass=="swatchUnavailable"||myClass=="swatchUnavailableHover")&&(classToAttach!="swatchUnavailable"))
{if(myClass=="swatchUnavailableHover"&&classToAttach=="swatchSelect")
{Twister.$(divToModify).find(".tooltip").trigger('mouseleave');}
Twister.$(divToModify).find(".tooltip").removeClass("a-declarative");Twister.$(divToModify).find(".tooltip").removeAttr("data-action");Twister.$(divToModify).find(".tooltip").removeAttr("data-a-tooltip");}}}
if(dimDisplayType==="dropdown"&&typeof(this.thumbnailHandle)!=='undefined'){this.thumbnailHandle.update(dimName);}}}
this.initThumbnail=function(asinData){var self=this;P.when('twister-thumbnailModule').execute(function(thumbnailHandle){self.thumbnailHandle=thumbnailHandle;for(var dimCount in asinData){var dimName=self.dimensionsMap[dimCount];self.thumbnailHandle.attach(dimName);self.thumbnailHandle.preloadAllThumbnails(dimName);}});}
this.updateMouseOver=function(asinData,dimensionValuesData,oldClassName,divMetaData,dimensionValuesDataGlobal,dimensionSelectionData,hidePopover,unavailablePopOverStringValue,showDimSecondUnavailablePopover){var eventInfo,selectedVariations=DetailPage.StateController.getState()['selected_variations'],eventType="mouseOver";if(oldClassName=='swatchUnavailable'&&!hidePopover)
{this.triggerPopover(divMetaData["dimIndex"],divMetaData["dimValueIndex"],dimensionValuesDataGlobal,dimensionValuesData,dimensionSelectionData,unavailablePopOverStringValue,showDimSecondUnavailablePopover);}
for(var dimCount in asinData){var dimData=asinData[dimCount];var dimName=this.dimensionsMap[dimCount];var dimDisplayType=this.dimensionDisplayTypeMap[dimCount];if(dimDisplayType==="etdd"){eventInfo=this._constructEventInfoObject(eventType,dimData,divMetaData);this.dimensionViewHandlersMap[dimCount].updateView(eventInfo);continue;}else if(dimDisplayType=='singleton'){continue;}
var dimensionValueDisplay=dimensionValuesData[dimCount];var dimensionDisplay=this.dimensionDisplayMap[dimCount];var dimensionValueDiv="#selected_"+dimName;var displayString='<b class=variationDefault> '+dimensionDisplay+': </b><b class=variationLabelHovered> '+dimensionValueDisplay+' </b>';if(dimDisplayType=='dropdown'){continue;}
if(selectedVariations[dimName]!=dimensionValueDisplay){Twister.$(dimensionValueDiv).html(displayString);if(twisterController.useDpx){Twister.$("#variation_"+dimName+" .selection").html(dimensionValueDisplay).addClass("hover");}}
if(dimCount==divMetaData["dimIndex"]){for(var dimValCount in dimData){var dimValueData=dimData[dimValCount];var classToAttach=dimValueData["style"];var divToModify='#'+dimName+"_"+dimValCount;var priceDivSelector=divToModify+"_price";var myClass=Twister.$(divToModify).get(0).className;if((myClass!='swatchSelect')&&((oldClassName!='swatchUnavailable')||(divMetaData['dimIndex']==dimCount&&divMetaData['dimValueIndex']==dimValCount))){if(classToAttach=='swatchSelect'){if(myClass=='swatchUnavailable'){classToAttach='swatchUnavailableHover';}
else{classToAttach='swatchHover';}
var priceDivToModify=Twister.$(priceDivSelector);if(priceDivToModify){priceDivToModify.removeClass().addClass('a-color-price');}}
Twister.$(divToModify).removeClass().addClass(classToAttach);}}}}}
this.init=function(viewData,asinData,dimensionValuesData,dimensionSelectionData,dimensionValuesDataGlobal){this.isToggleSwatches=viewData["toggleSwatchesWeblab"];this.dimensionsMap=viewData["dimensions"];this.dimensionDisplayMap=viewData["dimensionsDisplay"];this.dimensionDisplayTypeMap=viewData["dimensionsDisplayType"];DetailPage.StateController.setState("variation_display_labels",viewData["variationDisplayLabels"]);DetailPage.StateController.setState("variation_label_order",this.dimensionsMap);this.initEvents(asinData,dimensionValuesData,dimensionSelectionData,dimensionValuesDataGlobal);if(Twister.useDropdownThumbnail){this.initThumbnail(asinData);}}}
Twister.DimensionViews={};Twister.DimensionViews.Factory=function(){var self=this;self.getEVDDConstructorFunction=function(){var EVDDConstructorFunction;if(Twister.useBeaconizedEVDD){if(Twister.$("html").hasClass("a-lt-ie8")){EVDDConstructorFunction=Twister.DimensionViews.NativeEVDD;}else{EVDDConstructorFunction=Twister.DimensionViews.BeaconizedEVDD;}}else{EVDDConstructorFunction=Twister.DimensionViews.EVDD;}
return EVDDConstructorFunction;}}
Twister.DimensionViews.BeaconizedEVDD=function($,dimOrder,dimName,dimData,dimensionsMap,dimNameDisplayString,dimValuesDisplayData){var self=this,ID_EVDD_BUTTON,ID_EVDD_TABLE_WRAPPER,ID_EVDD_SINGLETON,CLASS_EVDD_HIDDEN="evdd-hidden",CLASS_EVDD_ROW_HOVERED="evdd-row-hovered",CLASS_EVDD_ROW_HIDDEN="evdd-row-hidden",CLASS_EVDD_ROW_DEFAULT="evdd-row-default",CLASS_EVDD_ROW_SELECTED="evdd-row-selected",CLASS_EVDD_ROW_SNAKE="evdd-row-snake-wrapper",CLASS_EVDD_ROW_PRICE_WRAPPER="evdd-row-price-info-wrapper",CLASS_EVDD_ROW_PRIME_BADGE_WRAPPER="evdd-row-prime-badge-wrapper",STRING_CLASSES_TO_REMOVE,STRING_STATE_INVALID="invalid",STRING_STATE_AVAILABLE="available",STRING_STATE_SELECTED="selected",EVENT_TYPE_CLICK="click",EVENT_TYPE_MOUSEENTER="mouseenter",EVENT_TYPE_MOUSELEAVE="mouseleave",EVENT_TYPE_TOUCHEND="touchend",EVENT_TYPE_TOUCHSTART="touchstart",popoverHandle,classNameMap={};self.dimType="evdd";self.dimNameDisplayString;self.dimName;self.dimOrder;self.isMasterDim=false;function init(){self.dimOrder=dimOrder;self.dimName=dimName;self.isMasterDim=false;if(dimOrder==="0"){self.isMasterDim=true;}
self.dimNameDisplayString=dimNameDisplayString;setDynamicConstants();attachEventHandlers();}
function setDynamicConstants(){ID_EVDD_BUTTON="#evdd-button-"+self.dimName;ID_EVDD_TABLE_WRAPPER="#evdd-table-wrapper-"+self.dimName;ID_EVDD_SINGLETON="#evdd-singleton-"+self.dimName;classNameMap[STRING_STATE_INVALID]=(self.isMasterDim?CLASS_EVDD_ROW_DEFAULT:CLASS_EVDD_ROW_HIDDEN);classNameMap[STRING_STATE_AVAILABLE]=CLASS_EVDD_ROW_DEFAULT;classNameMap[STRING_STATE_SELECTED]=CLASS_EVDD_ROW_SELECTED;STRING_CLASSES_TO_REMOVE=[CLASS_EVDD_HIDDEN,CLASS_EVDD_ROW_HOVERED,CLASS_EVDD_ROW_HIDDEN,CLASS_EVDD_ROW_DEFAULT,CLASS_EVDD_ROW_SELECTED].join(" ");}
function attachPopoverToEvddButton(){var evddButtonHeight=$(ID_EVDD_BUTTON).height(),heightOffset=8+evddButtonHeight,popoverOptions;popoverOptions={localContent:ID_EVDD_TABLE_WRAPPER,location:"bottom",showOnHover:false,showCloseButton:false,skin:null,clone:false,controlCallbacks:true,locationOffset:[-2,-heightOffset],closeEventInclude:"CLICK_OUTSIDE",forceAlignment:true,group:"DonsBoxDropDowns",width:null};amznJQ.available("popover",function(){popoverHandle=$(ID_EVDD_BUTTON).amazonPopoverTrigger(popoverOptions);});$(document).bind('touchend click',function(){popoverHandle.amznPopoverHide();});}
function handleEVDDRowClick($eventObject){var targetElementId=$eventObject.currentTarget.id,idArray=targetElementId.split("_"),rowIndex=idArray[idArray.length-1],divMetaData;divMetaData={dimIndex:self.dimOrder,dimValueIndex:rowIndex};twisterController.handleClick(divMetaData);return false;}
function handleEVDDRowMouseEnter($eventObject){var $targetElement=$($eventObject.currentTarget);$targetElement.addClass(CLASS_EVDD_ROW_HOVERED);}
function handleEVDDRowMouseLeave($eventObject){var $targetElement=$($eventObject.currentTarget);$targetElement.removeClass(CLASS_EVDD_ROW_HOVERED);return false;}
function handleEVDDRowTouchEnd($eventObject){var $targetElement=$($eventObject.currentTarget);$targetElement.removeClass(CLASS_EVDD_ROW_HOVERED);handleEVDDRowClick($eventObject);return false;}
function attachEventHandlers(){var rowId,rowIndex;attachPopoverToEvddButton();for(rowIndex in dimData){rowId="#"+self.dimName+"_"+rowIndex;$(rowId).bind(EVENT_TYPE_CLICK,handleEVDDRowClick)
.bind(EVENT_TYPE_TOUCHEND,handleEVDDRowTouchEnd)
.bind(EVENT_TYPE_TOUCHSTART,handleEVDDRowMouseEnter)
.bind(EVENT_TYPE_MOUSEENTER,handleEVDDRowMouseEnter)
.bind(EVENT_TYPE_MOUSELEAVE,handleEVDDRowMouseLeave);}}
function shouldShowSingleton(noOfDimValuesInAvailableState){var showSingleton=false;if(!self.isMasterDim&&noOfDimValuesInAvailableState===1){showSingleton=true;}
return showSingleton;}
self.updateView=function updateView(eventInfo){var eventData=eventInfo["eventData"],dimData=eventData["dimData"],rowIndex,rowData,classToAttach,rowId,selectedRowIndex=-1,showSingleton,noOfDimValuesInAvailableState=0,selectedRowDisplayText="";popoverHandle.amznPopoverHide();for(rowIndex in dimData){rowData=dimData[rowIndex];classToAttach=classNameMap[rowData["style"]];rowId="#"+self.dimName+"_"+rowIndex;if(classToAttach===CLASS_EVDD_ROW_SELECTED){selectedRowIndex=rowIndex;selectedRowDisplayText=dimValuesDisplayData[selectedRowIndex];}
if(rowData["style"]===STRING_STATE_AVAILABLE||rowData["style"]===STRING_STATE_SELECTED){noOfDimValuesInAvailableState++;}
$rowElement=$(rowId);$rowElement.removeClass(STRING_CLASSES_TO_REMOVE)
.addClass(classToAttach);$rowElement.find("."+CLASS_EVDD_ROW_SNAKE).show();$rowElement.find("."+CLASS_EVDD_ROW_PRICE_WRAPPER).html('');$rowElement.find("."+CLASS_EVDD_ROW_PRIME_BADGE_WRAPPER).html('');}
showSingleton=shouldShowSingleton(noOfDimValuesInAvailableState);$(ID_EVDD_BUTTON).find("button").text(selectedRowDisplayText);$(ID_EVDD_SINGLETON).text(selectedRowDisplayText);if(showSingleton){$(ID_EVDD_BUTTON).addClass(CLASS_EVDD_HIDDEN);$(ID_EVDD_SINGLETON).removeClass(CLASS_EVDD_HIDDEN);}else{$(ID_EVDD_SINGLETON).addClass(CLASS_EVDD_HIDDEN);$(ID_EVDD_BUTTON).removeClass(CLASS_EVDD_HIDDEN);}}
self.updateViewWithPriceInfo=function updateViewWithPriceInfo(priceInfoMap){var rowIndex,rowData,rowId,$rowElement;for(rowIndex in priceInfoMap){rowData=priceInfoMap[rowIndex];rowId="#"+self.dimName+"_"+rowIndex;$rowElement=$(rowId);$rowElement.find("."+CLASS_EVDD_ROW_SNAKE).hide();$rowElement.find("."+CLASS_EVDD_ROW_PRICE_WRAPPER).html(rowData[2]);$rowElement.find("."+CLASS_EVDD_ROW_PRIME_BADGE_WRAPPER).html(rowData[3]);}}
init();}
Twister.DimensionViews.BeaconizedEVDD.populateEVDDWithPriceInfoData=function(priceInfoData,viewHandle,asinToDimIndexMapData,selectedMasterDimValIndex){var masterDimIndex=viewHandle.masterDimIndex,slaveDimIndex=viewHandle.slaveDimIndex,slaveDimValIndexToPriceInfoMap={},asin,dimValIndexesForAsin;for(asin in priceInfoData){dimValIndexesForAsin=asinToDimIndexMapData[asin];masterDimValIndex=dimValIndexesForAsin[masterDimIndex];slaveDimValIndex=dimValIndexesForAsin[slaveDimIndex];if(selectedMasterDimValIndex!=masterDimValIndex){continue;}
slaveDimValIndexToPriceInfoMap[slaveDimValIndex]=priceInfoData[asin];}
if(typeof(viewHandle.dimensionViewHandlersMap[slaveDimIndex].updateViewWithPriceInfo)==="function"){viewHandle.dimensionViewHandlersMap[slaveDimIndex].updateViewWithPriceInfo(slaveDimValIndexToPriceInfoMap);}}
Twister.DimensionViews.EVDD=function($,dimOrder,dimName,dimData,dimensionsMap,dimNameDisplayString){this.dimType="evdd";this.dimNameDisplayString;this.dimName;this.dimOrder;this.isMasterDim=false;this._init=function _init(dimOrder,dimName,dimData,dimensionsMap,dimNameDisplayString){this.dimOrder=dimOrder;this.dimName=dimName;this.isMasterDim=false;if(dimOrder==="0"){this.isMasterDim=true;}
this.dimNameDisplayString=dimNameDisplayString;this._attachHandlerEvents(dimData);this._initializeCssStyles(dimData);}
this._attachHandlerEvents=function _attachHandlerEvents(dimData){var dimValCount,divMetaData;(function(dimNameLocal){$("#"+dimNameLocal+"_DonsBox_DonsBoxSelectedRowPreview").click(function(){if(twisterController){twisterController.handleEVDDClick(dimNameLocal);}});})(this.dimName);(function(dimNameLocal){$("#"+dimNameLocal+"_DonsBox_DonsBoxButton").click(function(){if(twisterController){twisterController.handleEVDDClick(dimNameLocal);}});})(this.dimName);for(dimValCount in dimData){divMetaData={"dimIndex":this.dimOrder,"dimValueIndex":dimValCount};(function(divMetaDataLocal,dimNameLocal){$("#"+dimNameLocal+"_DonsBox_DonsBoxRow_"+dimValCount).click(function(){if(twisterController){twisterController.handleClick(divMetaDataLocal);}});})(divMetaData,this.dimName);(function(divMetaDataLocal,dimNameLocal){$("#"+dimNameLocal+"_DonsBox_DonsBoxRow_"+dimValCount).mouseover(function(){if(twisterController){twisterController.handleMouseOver(divMetaDataLocal);}});})(divMetaData,this.dimName);}}
this._initializeCssStyles=function _initializeCssStyles(dimData){var singleton=0,parentMerchant=0,width3,dimValCount,divToModify,divMetaData,myClass,dimValueData,classToAttach;$("<style type='text/css'> #handleBuy hr {visibility:hidden;} </style>").appendTo("head");width3=$('#'+this.dimName+'table').width();$('#'+this.dimName+'table').width((width3>110?width3:108)+"px");$("#"+this.dimName+"_DonsBox_DonsBoxRows").show();$('#'+this.dimName+'_DonsBox_DonsBox').width($('#'+this.dimName+'_DonsBox_DonsBox').width()>108?$('#'+this.dimName+'_DonsBox_DonsBox').width()+"px":'108px');$("#"+this.dimName+"_DonsBox_DonsBoxRows").hide();for(dimValCount in dimData){divToModify="#"+this.dimName+"_"+dimValCount;divMetaData={"dimIndex":this.dimOrder,"dimValueIndex":dimValCount};myClass=Twister.$(divToModify).get(0).className;dimValueData=dimData[dimValCount];classToAttach=dimValueData["style"];if(classToAttach=="etdd"||classToAttach=="etddHidden"||classToAttach=="DonsBoxSelectedRowPreview"||classToAttach=="etddSelected"){if(classToAttach=="etdd"||classToAttach=="DonsBoxSelectedRowPreview"){$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).show();singleton++;}
if(classToAttach=="etddHidden"&&!this.isMasterDim){$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).hide();}
if(classToAttach=="etddSelected"){$("#"+this.dimName+"_DonsBox_DonsBoxSelectedRowSelected")
.text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());singleton++;parentMerchant++;$('#'+this.dimName+"_single").text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());$('#'+this.dimName+"_single",'#newTwisterEVDD').text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());$('#'+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","#B5D6EF");$('#'+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount,'#newTwisterEVDD').css("background-color","#B5D6EF");}
if(singleton==1&&this.dimOrder==1){$("#"+this.dimName+"_singleton").show();$("#"+this.dimName+"_DonsBox_DonsBox").hide();}
else if(this.dimOrder==1){$("#"+this.dimName+"_singleton").hide();$("#"+this.dimName+"_DonsBox_DonsBox").show();}
if(this.dimOrder==0&&dimData.length==1){$("#"+this.dimName+"_singleton").show();$("#"+this.dimName+"_DonsBox_DonsBox").hide();}
else if(this.dimOrder==0){$("#"+this.dimName+"_singleton").hide();$("#"+this.dimName+"_DonsBox_DonsBox").show();}}}
if(!parentMerchant){$("#"+this.dimName+"_DonsBox_DonsBoxSelectedRowSelected").text(twisterController.model.variationsData.deletedLandingAsinInfo["dimValues"][this.dimOrder]);}}
this._updateViewOnHover=function _updateViewOnHover(dimData,divMetaData){var highlight=-1,currentlySelected,currentSelected,dimValueData,classToAttach,divToModify,bgcolor,dimValCount;for(dimValCount in dimData){dimValueData=dimData[dimValCount];currentlySelected=0;currentSelected=0;classToAttach=dimValueData["style"];divToModify='#'+dimName+"_"+dimValCount;bgcolor=$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color");if(bgcolor=="rgb(181, 214, 239)"||bgcolor=="#B5D6EF"||bgcolor=="#b5d6ef"||bgcolor=="rgb(208, 229, 245)"||bgcolor=="#D0E5F5"||bgcolor=="#d0e5f5"){currentlySelected=1;if((this.dimOrder==divMetaData["dimIndex"])&&(dimValCount==divMetaData["dimValueIndex"])){$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","#D0E5F5");}else{$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","#B5D6EF");}}
if((this.dimOrder==divMetaData["dimIndex"])&&(dimValCount==divMetaData["dimValueIndex"])&&currentlySelected==0){$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","#CFE4F4");}else if(currentlySelected==0&&((this.dimOrder==divMetaData["dimIndex"]))){$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","white");}}}
this._updateViewOnClick=function _updateViewOnClick(dimData,divMetaData){var singleton=0,dimValCount,dimValueData,classToAttach,divToModify;$("#"+this.dimName+"_DonsBox_DonsBoxRows").hide();for(dimValCount in dimData){dimValueData=dimData[dimValCount];classToAttach=dimValueData["style"];divToModify="#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount;if(classToAttach=="etdd"||classToAttach=="etddSelected"||classToAttach=="DonsBoxSelectedRowPreview"){$(divToModify).show();singleton++;}
if(classToAttach=="etddSelected"){$("#"+this.dimName+"_DonsBox_DonsBoxSelectedRowSelected").text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","#B5D6EF");$("#"+this.dimName+"_DonsBox_DonsBoxSelectedRowSelected",'#newTwisterEVDD').text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount,'#newTwisterEVDD').css("background-color","#B5D6EF");$("#"+this.dimName+"_single").text($("#"+this.dimName+"_DonsBox_Row_"+dimValCount).text());}else{$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount).css("background-color","white");$("#"+this.dimName+"_DonsBox_DonsBoxRow_"+dimValCount,'#newTwisterEVDD').css("background-color","white");}
if(classToAttach=="etddHidden"&&!this.isMasterDim){$(divToModify).hide();$(divToModify,'#newTwisterEVDD').hide();}}
if(singleton==1&&this.dimOrder==1){$("#"+this.dimName+"_singleton").show();$("#"+this.dimName+"_DonsBox_DonsBox").hide();}else if(this.dimOrder==1){$("#"+this.dimName+"_singleton").hide();$("#"+this.dimName+"_DonsBox_DonsBox").show();}}
this.updateView=function updateView(eventInfo){var eventType=eventInfo["eventType"],eventData=eventInfo["eventData"],dimData=eventData["dimData"],divMetaData=eventData["divMetaData"];if(eventType==="mouseOver"){this._updateViewOnHover(dimData,divMetaData);}else if(eventType==="click"||eventType==="mouseOut"){this._updateViewOnClick(dimData,divMetaData);}}
this._init(dimOrder,dimName,dimData,dimensionsMap,dimNameDisplayString);}
Twister.DimensionViews.EVDD.showEVDD=function showEVDD(divMetaData){twisterController.populateEVDD();if(Twister.$('#'+divMetaData+'_DonsBox_DonsBoxRows').css('display')!='none'){}else{amznJQ.available("popover",function(){twisterController.EVDDPr=Twister.$("#"+divMetaData+"DonsBoxParent"+" div.DonsBox")
.removeAmazonPopoverTrigger()
.amazonPopoverTrigger({localContent:'#'+divMetaData+"_DonsBox"+'_DonsBoxRows',location:"bottom",showOnHover:false,showCloseButton:false,skin:null,clone:true,controlCallbacks:true,locationOffset:[0,-6],closeEventInclude:"CLICK_OUTSIDE",forceAlignment:true,group:"DonsBoxDropDowns",width:null}).css("cursor","pointer");});}}
Twister.DimensionViews.EVDD.populateEVDDWithPriceInfoData=function(EVDDPrice,dimensionsMap,asinToDimIndexMapData,master,dimensionValuesDisplay){if(EVDDPrice.hasOwnProperty(master)){for(var key in EVDDPrice[master]){Twister.$("#"+dimensionsMap[1]+"_"+asinToDimIndexMapData[key][1]+"_ExtendedPriceInfo")
.html(EVDDPrice[master][key]);Twister.$('#'+dimensionsMap[1]+"_snake_"+asinToDimIndexMapData[key][1]).hide();}}
else{for(var key in dimensionValuesDisplay){if(asinToDimIndexMapData[key][0]==master){Twister.$("#"+dimensionsMap[1]+"_"+asinToDimIndexMapData[key][1]+"_ExtendedPriceInfo").html('');Twister.$('#'+dimensionsMap[1]+"_snake_"+asinToDimIndexMapData[key][1]).show();}}}}
Twister.DimensionViews.NativeEVDD=function($,dimOrder,dimName,dimData,dimensionsMap,dimNameDisplayString,dimValuesDisplayData){var self=this,ID_EVDD_SELECT,ID_PREFIX_NATIVE_OPTION="native-",STRING_STATE_INVALID="invalid",STRING_STATE_AVAILABLE="available",STRING_STATE_SELECTED="selected";self.dimType="evdd";self.dimNameDisplayString;self.dimName;self.dimOrder;self.isMasterDim=false;function init(){self.dimOrder=dimOrder;self.dimName=dimName;self.isMasterDim=false;if(dimOrder==="0"){self.isMasterDim=true;}
self.dimNameDisplayString=dimNameDisplayString;initDynamicConstants();attachEventHandlers();}
function initDynamicConstants(){ID_EVDD_SELECT="#evdd-select-"+self.dimName;}
function handleSelectOnChange(){var selectedOptionValue=$(ID_EVDD_SELECT).val(),rowIndex=parseInt(selectedOptionValue.split(",")[0]),divMetaData;divMetaData={dimIndex:self.dimOrder,dimValueIndex:rowIndex};twisterController.handleClick(divMetaData);}
function attachEventHandlers(){$(ID_EVDD_SELECT).change(handleSelectOnChange);}
self.updateView=function updateView(eventInfo){var eventData=eventInfo["eventData"],dimData=eventData["dimData"],rowIndex,stateToAttach,selectedAttrHTML,selectHTML="",optionHTML;$(ID_EVDD_SELECT).empty();for(rowIndex in dimData){rowData=dimData[rowIndex];stateToAttach=rowData["style"];if(stateToAttach===STRING_STATE_INVALID&&!self.isMasterDim){continue;}
selectedAttrHTML=(stateToAttach===STRING_STATE_SELECTED)?"selected":"";rowId="#"+ID_PREFIX_NATIVE_OPTION+self.dimName+"_"+rowIndex;optionHTML='<option id="'+rowId+'" value="'+rowIndex+'," '+selectedAttrHTML+'>'+dimValuesDisplayData[rowIndex]+'</option>';selectHTML=selectHTML+optionHTML;}
$(ID_EVDD_SELECT).html(selectHTML);}
init();}
Twister.CPMetrics=new function(){var A,t,log,data={},lookAhead=0,lookAheadCount=0,PREDICTED="predicted",CLICKED="clicked",LOOKAHEAD="lookahead";var counter={ns:undefined,get:function(k){return(ue.count(this.ns+k)||0);},increment:function(k){ue.count(this.ns+k,(ue.count(this.ns+k)||0)+1);if(log.console)console.log(this.ns+k+" : "+ue.count(this.ns+k));},set:function(k,v){ue.count(this.ns+k,v);if(log.console)console.log(this.ns+k+" : "+ue.count(this.ns+k));}};this.set=function(k,v){counter.set(k,v);};this.record=function(link,action,value){if(!data[link])data[link]={};if(data[link][action])return;data[link][action]=value;if(action==PREDICTED){counter.increment("Predicted");}else if(action==CLICKED&&data[link][PREDICTED]){var la=value-data[link][PREDICTED];data[link][LOOKAHEAD]=la;counter.increment("Correct");counter.set("Lookahead"+counter.get("Correct"),la);counter.set("Lookahead",la);lookAhead=lookAhead+la;lookAheadCount=lookAheadCount+1;counter.set("AvgLookahead",lookAhead/lookAheadCount);counter.set("Click",1);}else if(action==CLICKED&&!data[link][PREDICTED]){counter.increment("Incorrect");counter.set("Click",1);}};this.setup=function(localA,treatment,localLog){A=localA;t=treatment;log=localLog;counter.ns="dpTwister"+t;counter.set("Hit",1);if(A.capabilities.touch){counter.set("TouchHit",1);}};};TwisterPrefetch=new function(){var self=this,$,A;var ALL_FEATURES=0,PREFETCHABLE_FEATURES=1,HOT_FEATURES=2,PREFETCHING="preFetching",PREFETCHED="preFetched",HOT_FEATURES_FETCHING="hotFeaturesFetching",COMPLETE_FETCHED="completeFetched";var log={console:false,jsFatal:function(e,attributionSufix,messagePrefix){attributionSufix=attributionSufix||"";messagePrefix=messagePrefix||"";if(window.ueLogError){window.ueLogError(e,{attribution:"Twister"+attributionSufix,message:"Twister "+messagePrefix});}}};var metaCache={twisterCacheWrapper:undefined,data:{},init:function(twisterCacheWrapper){this.twisterCacheWrapper=twisterCacheWrapper;},set:function(c,value){var k=this.getKey(c);return k?this.data[k]=value:undefined;},get:function(c){var k=this.getKey(c);return k?this.data[k]:undefined;},getAll:function(){return this.data;},clearKey:function(k){return k?delete this.data[k]:undefined;},getKey:function(c){return c&&c.asin?(c.mType==="parent"?c.mType+c.asin:c.mType+c.asin+c.reactID):undefined;},syncFromTwisterCache:function(c){var md,twisterCacheData=this.twisterCacheWrapper.getCachedData(c);if(twisterCacheData&&twisterCacheData.cacheStatus===COMPLETE_FETCHED){md={mType:c.mType,reactID:c.reactID,twisterCacheID:c.twisterCacheID,prefetchStartTime:new Date().getTime(),relatedContext:c.relatedContext,status:COMPLETE_FETCHED,syncedFromTwisterCache:true};md=this.set(c,md);}
return md;}};self.metaCache=metaCache;var twisterCacheWrapper={pageRefreshModel:undefined,init:function(pageRefreshModel){this.pageRefreshModel=pageRefreshModel;},update:function(mType,id,key,value,callbackParams){var cachedData=this.pageRefreshModel[mType].cache.data;cachedData[id]=cachedData[id]||{};cachedData[id][key]=value;},getCachedData:function(context){return this.pageRefreshModel[context.mType].cache.data[context.twisterCacheID];},clear:function(mType,twisterCacheID){delete this.pageRefreshModel[mType].cache.data[twisterCacheID];}};var page={measurement:undefined,config:{"partial":{},"full":{},"parent":{},"master":{}},data:{"partial":{},"full":{},"parent":{},"master":{}},init:function(pageRefreshModel,measurement){var self=this;self.measurement=measurement;$.each(pageRefreshModel,function(mType,value){var el=value.elementList,elems=[],len,customFeatures={};if(el){len=el.length;for(var i=0;i<len;i++){elems.push("#"+el[i].divToUpdate);var $elem=$("#"+el[i].divToUpdate);if($elem.length&&el[i]["customClientFunction"]){customFeatures[el[i].divToUpdate]=$elem.attr("customfunctionname");}}
self.config[mType]["affectedFeatures"]=elems.join(",");self.config[mType]["clientFeatures"]=customFeatures;}});},executeClientFeatures:function(context){var self=this;$.each(this.config[context.mType]["clientFeatures"],function(feature,customFunction){if(log.console)console.log("addClickCallbacks: custom function for: "+feature," function is: ",customFunction);try{var imageStampFunction=function(){self.measurement.stampImageLoad(context.asin);};eval("var twisterCustomFunction = "+customFunction+";");twisterCustomFunction(context.reactID,DetailPage.StateController,imageStampFunction);}catch(e){log.jsFatal(e,feature);}});},fadeInFeatures:function(context){$(this.config[context.mType]["affectedFeatures"]).css({opacity:0.5});},clearFeatureData:function(mType,twisterCacheID){delete this.data[mType][twisterCacheID];},refreshFeature:function(asin,featureName,value){var $elem,content;try{if(featureName&&value&&value["content"]){content=value["content"][featureName];if(typeof content!=="undefined"){$elem=$("#"+featureName);$elem.html(content);$elem.css({opacity:""});}}}catch(e){log.jsFatal(e,featureName);}
this.measurement.stampFeature(featureName,asin);},refreshFeatureList:function(context,fallbackToTwisterCache){this.fadeInFeatures(context);this.executeClientFeatures(context);var localData=this.data[context.mType][context.twisterCacheID]||{};var features={},twisterCacheData,canUseTwisterCache=$.isEmptyObject(localData);if(log.console)console.log("canUseTwisterCache ?, ",canUseTwisterCache," fallbackToTwisterCache:",fallbackToTwisterCache);if(canUseTwisterCache&&fallbackToTwisterCache){twisterCacheData=twisterCacheWrapper.getCachedData(context);if(twisterCacheData&&twisterCacheData.cacheStatus===COMPLETE_FETCHED){features=twisterCacheData;}}else{features=localData;}
for(var featureName in features){var featureValue=features[featureName];if(featureValue){this.refreshFeature(context.asin,featureName,featureValue);}}},cacheFeatureData:function(mType,twisterCacheID,asin,key,value){this.data[mType][twisterCacheID]=this.data[mType][twisterCacheID]||{};this.data[mType][twisterCacheID][key]=value;}};self.page=page;function TwisterAjax(context){var self=this;self.hiddenFeatures={intermediateEOS:1,EOS:1};var chunkHandler=function(data){var asin=data["ASIN"],value=data["Value"],featureName=data["FeatureName"];if(self.hiddenFeatures[featureName])return;var md=metaCache.get(context);if(featureName==="twister-request-metadata"){md.impressionCallbackData=value["content"][featureName];metaCache.set(context,md);return;}
twisterCacheWrapper.update(context.mType,context.twisterCacheID,featureName,value,null);page.cacheFeatureData(context.mType,context.twisterCacheID,asin,featureName,value);if(md&&md.takeClickActions){page.refreshFeature(asin,featureName,value);}};var errorHandler=function(xhr,statusText,errorThrown){log.jsFatal({message:"Ajax Failed "+errorThrown},"Ajax");twisterCacheWrapper.clear(context.mType,context.twisterCacheID);metaCache.clearKey(metaCache.getKey(context));};this.call=function(ajaxUrl,successHandler){return A.ajax(ajaxUrl,{method:'get',chunk:chunkHandler,success:function(){successHandler(context,true);},error:errorHandler,timeout:40000});}}
self.updateAjaxRequestStatus=function(context,fromSuccessHandler){var callback,callbackContext,md=metaCache.get(context),shouldGetHotFeatures=context.hotFeaturesEnabled&&!self.data[context.mType].fullyPrefetchable;if(log.console)console.log("self.updateAjaxRequestStatus called, ",md?md.status:"undefined"," fromAjax: ",fromSuccessHandler);if(!md){md={mType:context.mType,reactID:context.reactID,twisterCacheID:context.twisterCacheID,prefetchStartTime:new Date().getTime(),relatedContext:context.relatedContext,status:PREFETCHING};}else if(fromSuccessHandler&&shouldGetHotFeatures&&md.status===PREFETCHING){md.status=PREFETCHED;callback=md.hotFeatureCallback;callbackContext=md.hotFeatureCallbackContext;}else if(md.status===PREFETCHED){md.status=HOT_FEATURES_FETCHING;}else if(fromSuccessHandler&&(md.status===HOT_FEATURES_FETCHING||md.status===PREFETCHING)){md.status=COMPLETE_FETCHED;var relatedRequest=metaCache.get(context.relatedContext);if(relatedRequest){if(relatedRequest.status===COMPLETE_FETCHED){callback=md.fetchCompleteCallback;callbackContext=md.fetchCompleteCallbackContext;}}else{callback=md.fetchCompleteCallback;callbackContext=md.fetchCompleteCallbackContext;}}else{throw new Error("updateAjaxRequestStatus called with wrong twister request status, current status: "+md.status);}
twisterCacheWrapper.update(context.mType,context.twisterCacheID,"cacheStatus",md.status);metaCache.set(context,md);if(callbackContext&&typeof callbackContext==="object"&&typeof callback==="function"){callback.call(callbackContext);}
if(md.status===COMPLETE_FETCHED){page.clearFeatureData(context.mType,context.twisterCacheID);}
return md;};self.sendAjaxRequest=function(context,prefetchParam){var md=metaCache.get(context);if((!md&&prefetchParam===HOT_FEATURES)){throw new Error("Calling sendAjaxRequest with wrong parameters");}
if(!md){md=metaCache.syncFromTwisterCache(context);}
if(md&&md.status!==PREFETCHED){if(context.relatedContext){md.relatedContext=context.relatedContext;metaCache.set(context,md);}
return md;}
md=self.updateAjaxRequestStatus(context);var ajaxUrl=self.pageRefreshModel[context.mType].AJAXUrl+context.asin+"&isFlushing=2&predictivePrefetch=1&id="+context.id+"&prefetchParam="+prefetchParam+"&mType="+context.mType;if(Twister.isInstaTwisterEnabled){ajaxUrl+="&dpEnvironment="+Twister.dpEnvironment;}
var twisterAjax=new TwisterAjax(context);md.ajaxRequestHandler=twisterAjax.call(ajaxUrl,self.updateAjaxRequestStatus);metaCache.set(context,md);return md.ajaxRequestHandler?md:undefined;};self.prefetchContent=function(context){if(!context)return undefined;if(context.currentDimCombID===context.newDimCombID)return undefined;var status;try{var prefetchParam=self.hotFeaturesEnabled&&!self.data[context.mType].fullyPrefetchable?PREFETCHABLE_FEATURES:ALL_FEATURES;var partialRequest,defaultRequest=self.sendAjaxRequest(context,prefetchParam);Twister.CPMetrics.set(context.mType,1);if(context.relatedContext){prefetchParam=self.hotFeaturesEnabled&&!self.data[context.relatedContext.mType].fullyPrefetchable?PREFETCHABLE_FEATURES:ALL_FEATURES;partialRequest=self.sendAjaxRequest(context.relatedContext,prefetchParam);Twister.CPMetrics.set(context.relatedContext.mType,1);}
var status=context.relatedContext?partialRequest&&defaultRequest:defaultRequest;}catch(e){log.jsFatal(e,"PredictivePrefetch");}
return status;};self.prefetch=function(divMetaData){return this.prefetchContent(this.getPrefetchContext(divMetaData));};self.getHotFeatures=function(context){if(self.data[context.mType].fullyPrefetchable){return;}
var md=metaCache.get(context);if(md.status===PREFETCHED){if(log.console)console.log(" sending ajax call for prefetched ");self.sendAjaxRequest(context,HOT_FEATURES);}else if(md.status===PREFETCHING){if(log.console)console.log("added hotfeature callback");md.hotFeatureCallback=function(){self.sendAjaxRequest(context,HOT_FEATURES);};md.hotFeatureCallbackContext=self;metaCache.set(context,md);}};self.executeWithContexts=function(rawContext,callbackArgs,callback){callbackArgs=callbackArgs||[];var contexts=[rawContext];if(rawContext.relatedContext){contexts.push(rawContext.relatedContext);}
$.each(contexts,function(i,context){var args=$.merge([context],callbackArgs);callback.apply(self,args);});};self.setCallbacks=function(context,callback,callbackContext){var md=metaCache.get(context);if(!md)return 0;md.fetchCompleteCallback=callback;md.fetchCompleteCallbackContext=callbackContext;md.takeClickActions=true;metaCache.set(context,md);return true;};self.addClickCallbacks=function(rawContext,fetchCompleteCallbackContext,fetchCompleteCallback){self.executeWithContexts(rawContext,undefined,function(context){self.setCallbacks(context,fetchCompleteCallback,fetchCompleteCallbackContext)
if(self.hotFeaturesEnabled){self.getHotFeatures(context);}
if(log.console)console.log("Calling refreshFeatureList for context: ",context);page.refreshFeatureList(context,true);});};self.getPrefetchStatus=function(context){var status,md=metaCache.get(context);if(!md){md=metaCache.syncFromTwisterCache(context);}
if(md){if(context.relatedContext){var relatedRequest=metaCache.get(context.relatedContext);if(!relatedRequest){relatedRequest=metaCache.syncFromTwisterCache(context.relatedContext);}
if(relatedRequest){if(relatedRequest.status===COMPLETE_FETCHED&&md.status===COMPLETE_FETCHED){status=COMPLETE_FETCHED;}else{status=PREFETCHING;}}
}else{status=md.status;}}
return status;};self.prioritizeThisRequest=function(context){var status=this.getPrefetchStatus(context);var currentRequestKey=metaCache.getKey(context);var relatedRequestKey=metaCache.getKey(context.relatedContext);if(status===PREFETCHING){var aborted,data=metaCache.getAll();$.each(data,function(key,md){if(key!==currentRequestKey&&key!==relatedRequestKey&&md.status===PREFETCHING&&md.ajaxRequestHandler){var timeToAbort=new Date().getTime()-md.prefetchStartTime;md.ajaxRequestHandler.abort();Twister.CPMetrics.set("Abort",timeToAbort);twisterCacheWrapper.clear(md.mType,md.twisterCacheID);metaCache.clearKey(key);aborted=true;}});if(aborted)Twister.CPMetrics.set("AbortInitiated",1);for(var mType in self.pageRefreshModel){if(self.pageRefreshModel[mType]&&self.pageRefreshModel[mType].abortAllAjaxCalls()){Twister.CPMetrics.set("TwisterAjaxAbort",1);}}}};self.recordImpression=function(rawContext){self.executeWithContexts(rawContext,undefined,function(context){var md=metaCache.get(context);var d=md&&A.parseJSON(md.impressionCallbackData);if(d&&d.relatedRequestID&&d.subPageType){A.delay(function(){Twister.A.ajax("/gp/twister/impression.html/?relatedRequestID="+d.relatedRequestID+"&subPageType="+d.subPageType,{method:"get",success:function(data){ue.count("dpTwisterImpression",1);},timeout:40000,error:function(xhr,statusText,errorThrown){ue.count("dpTwisterImpressionFailed",1);}});},800);md.impressionCallbackData="1";metaCache.set(context,md);}else if(d!==1){ue.count("dpTwisterImpressionFailed",1);}});};self.setup=function(pageRefresh,treatment){if(this.alreadySetup)return;this.alreadySetup=true;var self=this;$=Twister.$;A=Twister.A;log.console=Twister.printConsoleLogs;self.pageRefreshModel=pageRefresh.model;self.data={};if(treatment==="T1"&&!A.capabilities.touch){self.hotFeaturesEnabled=false;}else{self.hotFeaturesEnabled=true;}
Twister.CPMetrics.setup(A,treatment,log);if($("#native_dropdown_selected_size_name").length)Twister.CPMetrics.set("DropdownExists",1);if($("#twister select").length>1)Twister.CPMetrics.set("MultipleDropdownExists",1);twisterCacheWrapper.init(pageRefresh.model);metaCache.init(twisterCacheWrapper);page.init(pageRefresh.model,pageRefresh.measurement);$.each(self.pageRefreshModel,function(mType,value){if(value.elementList){var len=value.elementList.length,fullyPrefetchable=true;for(var i=0;i<len;i++){if(!value.elementList[i].isPrefetchable)fullyPrefetchable=false;}
if(!self.data[mType])self.data[mType]={};self.data[mType]["fullyPrefetchable"]=fullyPrefetchable;}});A.on("dp:twister:prefetch",function(data){self.prefetch(data);});};self.getPrefetchContext=function(divMetaData){if(divMetaData==null||!twisterController||!twisterController.model){return undefined;}
var model=twisterController.model;var current=model.state.getCurrentASIN();var parentAsin=model.state.parentASIN;var asin=model.variationsData.getAsinFromDiv(current,divMetaData,model.state.dimensionSelectionData,model.state.currentDimCombID);if(asin===''){asin=current;}
var currentDimCombID=model.state.getCurrentDimCombID();var newDimCombID=model.variationsData.getNewDimCombID(asin,model.state.dimensionSelectionData,currentDimCombID,divMetaData);var newState=(newDimCombID.search(/X/)>=0)?1:0;var currentState=(currentDimCombID.search(/X/)>=0)?1:0;var mType;if(currentState==0&&newState==1){mType="parent";}else if(currentState==1&&newState==1){mType="partial";}else{mType="full";}
var partialState=mType!=="full"?1:0;var reactID=model.getReactID(newDimCombID,partialState);var relatedContext,context={hotFeaturesEnabled:self.hotFeaturesEnabled,divMetaData:divMetaData,currentAsin:current,asin:asin,currentDimCombID:currentDimCombID,newDimCombID:newDimCombID,twisterCacheID:(reactID.search(/X/)>=0)?reactID:asin,reactID:reactID,partialState:partialState,mType:mType,id:(reactID.search(/X/)>=0)?reactID:asin};if(mType=="parent"){relatedContext=$.extend(true,{},context);relatedContext.mType="partial";relatedContext.relatedContext=context;context.relatedContext=relatedContext;context.id=parentAsin;context.asin=parentAsin;context.twisterCacheID=parentAsin;}
if(log.console)console.log("Prefetch context data",context);return context;};};Twister.Controller=function($,pageRefresh){Twister.$=$;this.view=new Twister.View();this.EVDDPrice={};this.model=new Twister.Model(this,pageRefresh);this.twisterModel=this.model;this.enableMouseOut=0;this.useDpx=0;this.divMetaData;this.dropdownHistory={};this.populateEVDD=function(priceInfoData){var viewHandle=this.view,asinToDimIndexMapData=this.model.variationsData.asinToDimIndexMapData,selectedMasterDimValIndex=this.model.state.getMaster(),dimensionsMap=this.view.dimensionsMap,dimensionValuesDisplay=this.model.variationsData.dimensionValuesDisplay;if(Twister.useBeaconizedEVDD){if(!priceInfoData)return;Twister.DimensionViews.BeaconizedEVDD.populateEVDDWithPriceInfoData(priceInfoData,viewHandle,asinToDimIndexMapData,selectedMasterDimValIndex);}else{Twister.DimensionViews.EVDD.populateEVDDWithPriceInfoData(this.EVDDPrice,dimensionsMap,asinToDimIndexMapData,selectedMasterDimValIndex,dimensionValuesDisplay);}}
var performLandingPrefetches=function(self){var landingPrefetchState=Twister.Enums.landingPrefetchStates[Twister.prefetchRelatedAttrs.landingPrefetchState];switch(landingPrefetchState){case Twister.Enums.landingPrefetchStates.TRIGGER_ON_CF:if(Twister.printConsoleLogs){console.log("calling prefetchInitialContent after cf");}
self.model.prefetchInitialContent();break;case Twister.Enums.landingPrefetchStates.TRIGGER_ON_PAGE_LOAD:Twister.$(window).load(function(){if(Twister.printConsoleLogs){console.log("calling prefetchInitialContent after load");}
self.model.prefetchInitialContent();});break;case Twister.Enums.landingPrefetchStates.TRIGGER_ON_INTERACTION:var triggerPrefetchOnInteraction=function(){Twister.$(window).unbind("mousemove",triggerPrefetchOnInteraction);if(Twister.printConsoleLogs){console.log("calling prefetchInitialContent after interaction");}
self.model.prefetchInitialContent();};Twister.$(window).mousemove(triggerPrefetchOnInteraction);};}
this.init=function(data){var self=this;if(data){if(Twister.isLoggingEnabled){this.logger=new Twister.Logger($);this.logger.init();}
this.model.init(data);this.useDpx=data.useDpx;this.oPageAjaxRef={};this.oPageAjaxRef["full"]=this.model.pageRefresh.model["full"].oPageAjax;this.oPageAjaxRef["parent"]=this.model.pageRefresh.model["parent"].oPageAjax;this.oPageAjaxRef["partial"]=this.model.pageRefresh.model["partial"].oPageAjax;this.oPageAjaxRef["master"]=this.model.pageRefresh.model["master"].oPageAjax;performLandingPrefetches(self);}
Twister.$('.variations .swatchOuter a').each(function(){var anchorInnerHTML=jQuery(this).contents();Twister.$(this).replaceWith(anchorInnerHTML);});if(twisterController.useDpx){if(typeof(TwisterNonJs)!='undefined'){var totalDropDownHandlers=TwisterNonJs.handleDropDown.length;for(dropDownPosition=0;dropDownPosition<totalDropDownHandlers;dropDownPosition++){TwisterNonJs.handleDropDown[dropDownPosition]=function(){};}}
Twister.$('#twister .swatches a').remove();}
Twister.$("#twisterNonJsData").html("");Twister["jsInteractivityEnabledTime"]=new Date().getTime();}
this.handleClick=function(divMetaData,requestedOn){this.divMetaData=divMetaData;var interactionDate=new Date();window.newTwisterInteractionStartTime=interactionDate;if(window.ue&&ue.tag){ue.tag("twisterSwatchClick");}
if(Twister.isLoggingEnabled){var eventData=computeInteractionEventData(interactionDate,divMetaData,"swatchSelect");twisterController.logger.logImpression(twisterController.logger.eventTypes.CLICK,eventData);}
if(!(this.model.variationsData.useMS)){if(this.model.isSwatchSelected(divMetaData))return;var classAttached=this.model.getAttachedClass(divMetaData);if(classAttached!='swatchHover'&&classAttached!='swatchUnavailableHover'){this.model.setPreHoverData(divMetaData);}}
this.enableMouseOut=0;this.model.handleClick(divMetaData,undefined,undefined,requestedOn);}
this.handleEVDDClick=function(divMetaData){this.divMetaData=divMetaData;Twister.DimensionViews.EVDD.showEVDD(divMetaData);}
this.handleMouseOver=function(divMetaData){if(typeof(touchDeviceDetected)!="undefined"&&touchDeviceDetected){this.handleClick(divMetaData,"swatchClick");return true;}
this.enableMouseOut=1;if(Twister.isLoggingEnabled){var interactionDate=new Date();var eventData=computeInteractionEventData(interactionDate,divMetaData,"swatchHover");twisterController.logger.logImpression(twisterController.logger.eventTypes.HOVER,eventData);}
this.model.handleMouseOver(divMetaData);return true;}
this.handleMouseOut=function(divMetaData,dimIndex,dimValue){if(this.enableMouseOut==1){this.model.handleMouseOut(divMetaData,dimIndex,dimValue);}}
this.handleDropdownOnChange=function(event,divMetaData){var selectedOptionValue;if(Twister.useAui){selectedOptionValue=event.value;}
else{selectedOptionValue=event.target.options[event.target.selectedIndex].value;}
if(Twister.predictivePrefetch){Twister.CPMetrics.set("DropdownChanged",1);var metricName;if(this.dropdownHistory[selectedOptionValue]){metricName="dpTwisterSameDropdownValue";}else{this.dropdownHistory[selectedOptionValue]=true;metricName="dpTwisterNewDropdownValue";}
if(ue&&ue.count&&metricName)ue.count(metricName,1);}
divMetaData["dimValueIndex"]=parseInt(selectedOptionValue.split(",")[0]);if(Twister.useAui&&this.view.shouldSuppressEvent(divMetaData["dimIndex"],divMetaData["dimValueIndex"])){return;}
var interactionDate=new Date();window.newTwisterInteractionStartTime=interactionDate;if(window.ue&&ue.tag){ue.tag("twisterDDClick");}
this.model.setPreHoverData(divMetaData);if(Twister.isLoggingEnabled){var eventData=computeInteractionEventData(interactionDate,divMetaData,"dropDownSelect");twisterController.logger.logImpression(twisterController.logger.eventTypes.CLICK,eventData);}
this.model.handleClick(divMetaData,undefined,undefined,"dropdownChange");}
this.performManualSelect=function(dimLabel,selectedValueIndex){try{var divMetaData={};divMetaData["dimIndex"]=-1;var dimensionsMap=this.view.dimensionsMap;for(var i=0;i<dimensionsMap.length;i++){if(dimensionsMap[i]==dimLabel){divMetaData["dimIndex"]=i;break;}}
if(divMetaData["dimIndex"]==-1)return;if(this.model.variationsData.dimensionValuesData[i].length<=0)return;if(selectedValueIndex>=this.model.variationsData.dimensionValuesData[i].length)return;if(this.view.dimensionDisplayTypeMap[i]=='singleton')return;divMetaData["dimValueIndex"]=selectedValueIndex;if(this.view.dimensionDisplayTypeMap[i]=='dropdown')Twister.$('#dropdown_selected_'+dimLabel).val(Twister.$('#'+dimLabel+'_'+selectedValueIndex).attr('value'));this.handleClick(divMetaData);}catch(e){}}
var computeInteractionEventData=function(interactionDate,divMetaData,interactionType){var eventData={};eventData["time"]=interactionDate.getTime();var eventType="";switch(interactionType){case"dropDownSelect":case"swatchClick":eventType="click";break;case"swatchHover":eventType="hover";break;default:eventType="undefinedEvent";}
eventData["eventType"]=eventType;eventData["divMetaData"]=divMetaData;return eventData;}}
var PageRefresh={};PageRefresh.requestKeyCounter=0;PageRefresh.Cache=function(){this.data={};this.getValue=function(ASIN,key){if(this.data[ASIN]==null){return null;}
if(key){return this.data[ASIN][key];}else{return this.data[ASIN];}}
this.setValue=function(ASIN,key,value){if(this.data[ASIN]==null||this.data[ASIN]["pending"]){this.data[ASIN]={};}
this.data[ASIN][key]=value;}
this.clear=function(ASIN){this.data[ASIN]=null;}}
PageRefresh.Model=function($,AJAXUrl,elementList,modelType){this.$=$;this.pendingCallBacks={};this.pendingCallBacksASIN='';this.cache=new PageRefresh.Cache();this.oPageAjax;this.AJAXUrl=AJAXUrl;this.AJAXRequests={};this.requestIdHash={};this.elementList=elementList;this.currentRequestId=null;this.pendingCallbacksList={};this.immediateCallbacksList=[];this.elementsToRefresh=[];this.modelType=modelType;this.init=function(){flushAjaxJS($);flushUtilsJS($);this.oPageAjax=new window.PageAjax({pageTimeout:40000,streamDelimiter:'&&&',retries:5});}
this.getNewRequestId=function(){for(var i=0;i<100;i++){iStr=i.toString();if(!this.requestIdHash.hasOwnProperty(iStr)){this.requestIdHash[iStr]=true;return iStr;}}
}
this.removeRequestId=function(requestId){if(typeof requestId!="string"){requestId=requestId.toString();}
if(this.requestIdHash.hasOwnProperty(requestId)){delete this.requestIdHash[requestId];}}
this.executeActionItems=function(actionsToTake,id,elementHash,managerHandler,elementsToRefresh){var elementToUpdate=elementHash["divToUpdate"];for(var actionIter=0,noOfActions=actionsToTake.length;actionIter<noOfActions;actionIter++){var actionItem=actionsToTake[actionIter];if(actionItem=="addToImmediate"){var callbackContext={};callbackContext["id"]=id;callbackContext["key"]=elementToUpdate;this.immediateCallbacksList.push(callbackContext);}
else if(actionItem=="addToElementsRefresh"||actionItem=="addToElementsRefreshWithLoading"){var loadingBarString=(actionItem=="addToElementsRefreshWithLoading")?",loadingBar":"";elementsToRefresh.push(elementToUpdate+loadingBarString);}
else if(actionItem=="updateCache"){var callbackArgs={};callbackArgs["handler"]=this;callbackArgs["callbackType"]="updateCache";this.addToPendingCallbacksList(id,elementToUpdate,callbackArgs);}
else if(actionItem=="customClientFunction"){var callbackArgs={};callbackArgs["handler"]=this;callbackArgs["callbackType"]="customClientFunction";var callbackParams={};callbackParams["refreshHandler"]=managerHandler;callbackArgs["callbackParams"]=callbackParams;this.addToPendingCallbacksList(id,elementToUpdate,callbackArgs);}
else if(actionItem=="doRefreshAndFinish"||actionItem=="doRefresh"){var callbackArgs={};callbackArgs["handler"]=managerHandler;callbackArgs["callbackType"]="doRefresh";var callbackParams={};callbackParams["isFinishRefreshReq"]=1;callbackArgs["callbackParams"]=callbackParams;this.addToPendingCallbacksList(id,elementToUpdate,callbackArgs);}}}
this.getAjaxCallContext=function(id,repAsin,isPrefetchId,managerHandler,requiredDivs,isHover){var elementsToRefresh=[];var isAjaxCallReq=0;var ajaxParams={};var hasNonPrefetchableElement=0;var idCacheStatus="notFetched";if(this.cache.getValue(id,"cacheStatus")){idCacheStatus=this.cache.getValue(id,"cacheStatus");}
for(var elementIdx=0,noOfElements=this.elementList.length;elementIdx<noOfElements;elementIdx++){var elementHash=this.elementList[elementIdx];var elementToUpdate=elementHash["divToUpdate"];var actionsToTake=[];var isPrefetchable=1;var customClientFunction=0;var updateOnHover=0;var loadingBar=0;if(elementHash["isPrefetchable"]=="0"){isPrefetchable=0;hasNonPrefetchableElement=1;}
if(elementHash["customClientFunction"]=="1"){customClientFunction=1;isPrefetchable=0;}
if(elementHash["updateOnHover"]=="1"){updateOnHover=1;}
if(elementHash["loadingBar"]=="1")loadingBar=1;if(isHover&&!updateOnHover){continue;}
if(!isPrefetchId){if(customClientFunction){actionsToTake.push("customClientFunction");actionsToTake.push("addToImmediate");}
else if(this.cache.getValue(id,elementToUpdate)){actionsToTake.push("doRefresh");actionsToTake.push("addToImmediate");}
else{actionsToTake.push("updateCache");actionsToTake.push("doRefreshAndFinish");loadingBar?actionsToTake.push("addToElementsRefreshWithLoading"):actionsToTake.push("addToElementsRefresh");if(!isAjaxCallReq){isAjaxCallReq=1;}
}}
else{if(customClientFunction||!isPrefetchable||this.cache.getValue(id,elementToUpdate)){continue;}
else{actionsToTake.push("updateCache");if(!isAjaxCallReq){isAjaxCallReq=1;}
}}
if(((isPrefetchId==1&&idCacheStatus=="preFetched")||(isPrefetchId==0&&idCacheStatus=="completeFetched")||(isPrefetchId==1&&idCacheStatus=="completeFetched"))&&(isAjaxCallReq==1)){isAjaxCallReq=0;}
this.executeActionItems(actionsToTake,id,elementHash,managerHandler,elementsToRefresh);}
if(((isPrefetchId==1&&idCacheStatus=="preFetched")||(isPrefetchId==0&&idCacheStatus=="completeFetched")||(isPrefetchId==1&&idCacheStatus=="completeFetched"))&&(isAjaxCallReq==1)){isAjaxCallReq=0;}
if(isHover&&isAjaxCallReq){isAjaxCallReq=0;}
if(isAjaxCallReq){var newIdCacheStatus=isPrefetchId?(hasNonPrefetchableElement?"preFetching":"completeFetching"):(idCacheStatus=="preFetched"?"hotFeaturesFetching":"completeFetching");this.cache.setValue(id,"cacheStatus",newIdCacheStatus);}
var ajaxCallContext={};ajaxCallContext["isAjaxCallReq"]=isAjaxCallReq;ajaxCallContext["elementsToRefresh"]=elementsToRefresh;return ajaxCallContext;}
this.getUpdateData=function(managerHandler,context){var idList=context["idList"];var prefetchParamArray=[];var idArray=[];var repAsinArray=[];var elementsToRefresh=[];var isAjaxCallReq=0;var ajaxCallContext,id,repAsin,isPrefetchId,requiredDivs,perIdElementsToRefresh;var containsOnlyPrefetches=1;var logClientMetrics=(this.modelType==='full')?1:0;for(var idIter=0,noOfIds=idList.length;idIter<noOfIds;idIter++){id=idList[idIter]["id"];repAsin=idList[idIter]["asin"];isPrefetchId=idList[idIter]["isPrefetch"];requiredDivs=idList[idIter]["requiredDivs"];isHover=idList[idIter]["isHover"];var eventData={"id":id};ajaxCallContext=this.getAjaxCallContext(id,repAsin,isPrefetchId,managerHandler,requiredDivs,isHover);perIdElementsToRefresh=ajaxCallContext["elementsToRefresh"];for(var elementIter=0,noOfElements=perIdElementsToRefresh.length;elementIter<noOfElements;elementIter++){elementsToRefresh.push(perIdElementsToRefresh[elementIter]);}
if(!ajaxCallContext["isAjaxCallReq"]){if(Twister.isLoggingEnabled&&!isPrefetchId&&!isHover&&logClientMetrics){twisterController.logger.logImpression(twisterController.logger.eventTypes.CACHE_HIT,eventData);}
continue;}
isAjaxCallReq=1;var prefetchParam=(isPrefetchId)?1:(this.cache.getValue(id,"cacheStatus")=="hotFeaturesFetching"?2:0);if(prefetchParam==0||prefetchParam==2){containsOnlyPrefetches=0;if(Twister.isLoggingEnabled&&logClientMetrics){var eventType=(prefetchParam==0)?twisterController.logger.eventTypes.CACHE_MISS:twisterController.logger.eventTypes.CACHE_HIT;twisterController.logger.logImpression(eventType,eventData);}}
idArray.push(id);repAsinArray.push(repAsin);prefetchParamArray.push(prefetchParam);}
if(isAjaxCallReq){var ajaxCallParams={};ajaxCallParams["asinList"]=repAsinArray.join(",");ajaxCallParams["id"]=idArray.join(",");ajaxCallParams["prefetchParam"]=prefetchParamArray.join(",");ajaxCallParams["managerHandler"]=managerHandler;ajaxCallParams["modelType"]=this.modelType;ajaxCallParams["containsOnlyPrefetches"]=containsOnlyPrefetches;try{this.doAjaxCall(ajaxCallParams);}
catch(e){}}
this.elementsToRefresh=elementsToRefresh.slice();return elementsToRefresh;}
this.makeCallback=function(id,key,callbackArgs,data,refreshDone){var handler=callbackArgs["handler"];var callbackType=callbackArgs["callbackType"];var callbackParams=callbackArgs["callbackParams"];if(data==null){data=this.cache.getValue(id,key);}
if(typeof handler=='function'){handler(id,key,callbackParams,data);return;}
if(callbackType=="doRefresh"){handler.pageRefreshHandler(id,key,callbackParams,data,refreshDone);}
else if(callbackType=="customClientFunction"){try{handler.callCustomClientFunction(id,key,callbackParams,data,refreshDone);}
catch(e){}}
else if(callbackType=="updateCache"){handler.updateCache(id,key,callbackParams,data);}}
this.makePendingCallBacks=function(id,key,data,refreshDone){var perKeyPendingCallbacks;if(id){if(typeof this.pendingCallbacksList[id]!=='object'){return;}
if(key){perKeyPendingCallbacks=this.pendingCallbacksList[id][key];if(!perKeyPendingCallbacks){perKeyPendingCallbacks=[];var callbackArgs={};callbackArgs["handler"]=this;callbackArgs["callbackType"]="updateCache";perKeyPendingCallbacks.push(callbackArgs);}
for(var callbackIdx=0,noOfCallbacks=perKeyPendingCallbacks.length;callbackIdx<noOfCallbacks;callbackIdx++){var callbackArgs=perKeyPendingCallbacks[callbackIdx];try{this.makeCallback(id,key,callbackArgs,data,refreshDone);}
catch(e){}}
if(this.pendingCallbacksList[id][key]){delete this.pendingCallbacksList[id][key];}}
else{for(var keyIter in this.pendingCallbacksList[id]){perKeyPendingCallbacks=this.pendingCallbacksList[id][keyIter];for(var callbackIdx=0,noOfCallbacks=perKeyPendingCallbacks.length;callbackIdx<noOfCallbacks;callbackIdx++){var callbackArgs=perKeyPendingCallbacks[callbackIdx];this.makeCallback(id,key,callbackargs,data,refreshDone);}}
delete this.pendingCallbacksList[id];}
return;}
for(var callbackIter=0,noOfCallbacks=this.immediateCallbacksList.length;callbackIter<noOfCallbacks;callbackIter++){var callbackContext=this.immediateCallbacksList[callbackIter];this.makePendingCallBacks(callbackContext.id,callbackContext.key,null,refreshDone);}
this.immediateCallbacksList=[];}
this.addToPendingCallbacksList=function(id,key,callbackArgs){if(!this.pendingCallbacksList.hasOwnProperty(id)){this.pendingCallbacksList[id]={};}
if(!this.pendingCallbacksList[id].hasOwnProperty(key)){this.pendingCallbacksList[id][key]=[];}
this.pendingCallbacksList[id][key].push(callbackArgs);}
this.doAjaxCall=function(ajaxCallParams){if(Twister.useVariationsOverlay&&Twister.remainingAjaxCalls===0){Twister.$('#variations-overlay').show();}
Twister.remainingAjaxCalls=Twister.remainingAjaxCalls+1;var useIframe=false;if($.browser.msie){useIframe=true;;}
var requestId=this.getNewRequestId();this.currentRequestId=requestId;var asinList=ajaxCallParams["asinList"];var id=ajaxCallParams["id"];var mType=ajaxCallParams["modelType"];var prefetchParam=ajaxCallParams["prefetchParam"];var managerHandler=ajaxCallParams["managerHandler"];var ajaxUrl=this.AJAXUrl+asinList+"&isFlushing=2&id="+id+"&prefetchParam="+prefetchParam+"&mType="+mType;if(Twister.isInstaTwisterEnabled){ajaxUrl+="&dpEnvironment="+Twister.dpEnvironment;}
var ajaxCallContext={};var streamingXhrRef;if(Twister.useAuiAjax){var self=this;var ajaxChunkHandler=function(data){self.AJAXHandler(null,data,AJAXFlushUtils.ajaxReadyState.LOADING);};var ajaxSuccessHandler=function(){self.AJAXHandler(null,null,AJAXFlushUtils.ajaxReadyState.DONE);Twister.remainingAjaxCalls=Twister.remainingAjaxCalls-1;if(Twister.remainingAjaxCalls===0){Twister.$('#variations-overlay').hide();}};var ajaxErrorHandler=function(){Twister.$('#variations-overlay').hide();Twister.remainingAjaxCalls=Twister.remainingAjaxCalls-1;if(Twister.showErrorMessageOnFailure){alert(Twister.errorMessageOnFailure);location.reload();}
if(Twister.printConsoleLogs){console.log("ajax call failed");}};var ajaxOptions={};ajaxOptions['method']='get';ajaxOptions['chunk']=ajaxChunkHandler;ajaxOptions['success']=ajaxSuccessHandler;ajaxOptions['error']=ajaxErrorHandler;ajaxOptions['timeout']=40000;streamingXhrRef=Twister.A.ajax(ajaxUrl,ajaxOptions);ajaxCallContext["streamingXhrRef"]=streamingXhrRef;}else{streamingXhrRef=this.oPageAjax.loadStreaming(useIframe,this.AJAXUrl+asinList+"&isFlushing=2&id="+id+"&prefetchParam="+prefetchParam+"&mType="+mType+"&requestId="+requestId,"",this,this,requestId);ajaxCallContext["streamingXhrRef"]=streamingXhrRef;}
ajaxCallContext["ajaxParams"]=ajaxCallParams;ajaxCallContext["managerHandler"]=managerHandler;this.AJAXRequests[requestId]=ajaxCallContext;}
this.abortAllAjaxCalls=function(){var ajaxCallAborted=false;for(requestId in this.requestIdHash){if(this.finishAjaxCall(requestId,true)){ajaxCallAborted=true;}}
return ajaxCallAborted;}
this.finishAjaxCall=function(requestId,isAbort){var ajaxCallAborted=false;if(!requestId)
return ajaxCallAborted;var ajaxCallContext=this.AJAXRequests[requestId];var streamingXhrRef=ajaxCallContext["streamingXhrRef"];var ajaxParams=ajaxCallContext["ajaxParams"];var idList=ajaxParams["id"];var idListArray=idList.split(",");var managerHandler=ajaxCallContext["managerHandler"];var containsOnlyPrefetches=ajaxParams["containsOnlyPrefetches"];if(isAbort==1&&containsOnlyPrefetches)return;this.pendingCallbacksList={};this.immediateCallbacksList=[];if(isAbort){if(streamingXhrRef&&typeof(streamingXhrRef.abort)==='function'){streamingXhrRef.abort(AJAXFlushUtils.ajaxHandlerCode.ABORT);ajaxCallAborted=true;}
for(var idIter=0,noOfIds=idListArray.length;idIter<noOfIds;idIter++){if(!this.cache.getValue(idListArray[idIter])){continue;}
var cacheStatus=this.cache.getValue(idListArray[idIter],"cacheStatus");if(cacheStatus=="preFetching"||cacheStatus=="completeFetching"){if(isAbort)
this.cache.clear(idListArray[idIter]);else
this.cache.setValue(idListArray[idIter],"cacheStatus",(cacheStatus=="preFetching")?"preFetched":"completeFetched");}
else if(cacheStatus=="hotFeaturesFetching"){this.cache.setValue(idListArray[idIter],"cacheStatus",isAbort?"preFetched":"completeFetched");}}}
this.elementsToRefresh=[];this.removeRequestId(requestId);delete this.AJAXRequests[requestId];this.currentRequestId=null;return ajaxCallAborted;}
this.updateCache=function(id,key,callbackParams,data){if(key=="intermediateEOS"||key=="EOS"){var cacheStatus=this.cache.getValue(id,"cacheStatus");if(cacheStatus=="preFetching"){this.cache.setValue(id,"cacheStatus","preFetched");}
else if(cacheStatus=="completeFetching"||cacheStatus=="hotFeaturesFetching"){this.cache.setValue(id,"cacheStatus","completeFetched");}
else{}}
else{this.cache.setValue(id,key,data);}}
this.callCustomClientFunction=function(id,key,callbackParams,data,refreshDone){var customFunctionName=$("#"+key).attr("customFunctionName");if(!customFunctionName){return;}
var refreshHandler=callbackParams["refreshHandler"];var currentASIN=DetailPage.StateController.getState()['current_asin'];var imageStampFunction=function(){refreshHandler.measurement.stampImageLoad(currentASIN);}
var customFunctionReturnData;var imageStampFunctionToPass=(Twister.useAui)?imageStampFunction:null;if(Twister.useAui){if(!refreshDone){if(Twister.printConsoleLogs)console.log("From pageRefresh args: id:",id," key:",key," callbackParams:",callbackParams," data:",data,"  customFunction: ",customFunctionName);eval("var customFunction = "+customFunctionName+";");customFunctionReturnData=customFunction(id,DetailPage.StateController,imageStampFunctionToPass);}}else{customFunctionReturnData=eval(customFunctionName)(id,DetailPage.StateController,imageStampFunctionToPass);}
if(!customFunctionReturnData){return;}
var callbackParams={};callbackParams["isFinishRefreshReq"]=0;if(!Twister.useAui){var mainImage;if(key=='twister-main-image'&&currentASIN){mainImage=document.getElementById('main-image');if(!mainImage){var mainImageDiv=document.getElementById('main_image_0');if(mainImageDiv){var mainImages=mainImageDiv.getElementsByTagName('img');mainImage=mainImages?mainImages[0]:null;}}
if(mainImage){mainImage.onload=imageStampFunction;}
}}
refreshHandler.pageRefreshHandler(id,key,callbackParams,customFunctionReturnData,refreshDone);if(Twister.useAui){return;}
var isChrome=navigator.userAgent.toLowerCase().indexOf('chrome')>-1;if(isChrome&&mainImage&&mainImage.complete){imageStampFunction();}}
this.AJAXHandler=function(callBackContext,data,xhrReadyState,refreshDone){if(xhrReadyState==AJAXFlushUtils.ajaxReadyState.DONE){this.finishAjaxCall(this.currentRequestId,0);return AJAXFlushUtils.ajaxHandlerCode.OK;}
for(var j=0;j<1;j++){var featureData=data;var id=featureData["ASIN"];var data=featureData["Value"];var key=featureData["FeatureName"];if(key=="intermediateEOS"||key=="EOS")
this.updateCache(id,key,null,data);else
this.makePendingCallBacks(id,key,data,refreshDone);}
return AJAXFlushUtils.ajaxHandlerCode.OK;}
this.AJAXErrorHandler=function(callbackContext,dataObj,errState){var xhrErrorState=callbackContext["xhrStatus"];if(!xhrErrorState)
xhrErrorState=errState;return xhrErrorState;}}
customFunctionCount=0;defaultCustomClientFunction=function(key,stateControllerHandler){var newHtml="<div>added sample data</div>";customFunctionCount++;var dataToBeReturned={};dataToBeReturned["content"]={};dataToBeReturned["content"][key]=newHtml;return dataToBeReturned;}
PageRefresh.Refresh=function($,loadingBarHtml,loadingBarHtml2){this.$=$;this.loadingBarHtml=loadingBarHtml;this.loadingBarHtml2=loadingBarHtml2;this.doRefresh=function(div,value,refreshDone){if(!refreshDone){$('#'+div).html(value);}}
this.startRefresh=function(elementList){if(elementList){for(var element in elementList){var elementInfoArray=elementList[element].split(",");var div=elementInfoArray[0];var doRefresh=true,appendLoadingBar=false;if(div=='buy-box_feature_div'||div=='more-buying-choices_feature_div'||(div=='session-similarities_feature_div'&&$.browser.msie)){doRefresh=false;}
if(elementInfoArray.length>1&&elementInfoArray[1]=="loadingBar")appendLoadingBar=true;if(doRefresh&&!Twister.useVariationsOverlay)$('#'+div).css('opacity','0.5');if(appendLoadingBar)this.appendLoadingBar(div);}}}
this.appendLoadingBar=function(div){$divToModify=$('#'+div);if(div=='moreBuyingChoices_feature_div')return;if(!$divToModify.attr('loadingBarSet')){$divToModify.attr('loadingBarSet','1');if(div=='more-buying-choices_feature_div'){$divToModify=$('#'+'more-buying-choice-content-div');$divToModify.html(this.loadingBarHtml2);return;}
var headerDiv=$divToModify.find('h2, h1, b');if(headerDiv.length>0){headerDiv=$(headerDiv[0]);headerDiv.css({display:'inline',padding:'0px'});headerDiv.after($(this.loadingBarHtml));}}}
this.finishRefresh=function(div){var finishRefresh=true,removeLoadingBar=true;if(div=='buy-box_feature_div'){finishRefresh=false;removeLoadingBar=false;}
if((div=='session-similarities_feature_div'&&$.browser.msie)||div=='more-buying-choices_feature_div'){finishRefresh=false;}
var zoomVal='0';if(div=='more-buying-choices_feature_div')zoomVal='1';if(finishRefresh)$('#'+div).css({opacity:'',zoom:zoomVal});if(removeLoadingBar)$('#'+div).removeAttr('loadingBarSet');}}
PageRefresh.Manager=function($,contextMetaData,config,loadingBarHtml,loadingBarHtml2){this.$=$;this.model={};this.refresh=new PageRefresh.Refresh($,loadingBarHtml,loadingBarHtml2);this.contextMetaData=contextMetaData;this.measurement=new PageRefresh.Measurement($,config["atfMarker"],config["cfMarker"]);this.init=function(storeID,productGroupID){for(var type in this.contextMetaData){this.model[type]=new PageRefresh.Model($,this.contextMetaData[type].AJAXUrl,this.contextMetaData[type].elementList,type.toString());this.model[type].init();}
this.measurement.init(storeID,productGroupID);}
this.getModelCacheSize=function(modelType){var cacheSize=0;if(this.model.hasOwnProperty(modelType)){$.each(this.model[modelType].cache.data,function(k,v){if(!v.hasOwnProperty("cacheStatus")){return;}
if(v["cacheStatus"]==="preFetched"||v["cacheStatus"]==="completeFetched"){cacheSize++}});}
return cacheSize;}
this.react=function(contextList,isHover,refreshDone){for(var mod in this.model){if(!isHover)this.model[mod].finishAjaxCall(this.model[mod].currentRequestId,1);}
for(var con in contextList){var context=contextList[con];if(!isHover){this.model[context.type].finishAjaxCall(this.model[context.type].currentRequestId,2);}
var elementsToRefresh=this.model[context.type].getUpdateData(this,context);this.refresh.startRefresh(elementsToRefresh);this.model[context.type].makePendingCallBacks(undefined,undefined,undefined,refreshDone);}}
this.pageRefreshHandler=function(ASIN,key,callbackParams,data,refreshDone){if(data.noRefresh){return;}
for(var value in data.content){try{this.refresh.doRefresh(value,data.content[value],refreshDone);var isFinishRefreshReq=callbackParams["isFinishRefreshReq"];if(isFinishRefreshReq){this.refresh.finishRefresh(value);if(value=='session-similarities_feature_div'||value=='purchase-similarities_feature_div'||value=='buyxgety_feature_div'){if(DetailPageFramework.callbacks[value]){DetailPageFramework.callbacks[value]();}}
else if(value==='zeroes-buy-box_feature_div'&&Twister.isIEBrowser($)){$('#'+value).css({opacity:'',zoom:1});}}
if(!refreshDone)this.measurement.stampFeature(key,ASIN);}catch(e){}}}}
Twister.LoggerService=function($,loggerClient,channel,programGroup,featureName){var constructUploadUrl=function(data){var protocol=location.protocol=="https:"?"https://":"http://";var countMetricsUri="";var timeMetricsUri="";var isTimeMetricsPresent=false;$.each(data,function(metric,metricObject){var uri=metricObject.name+"@v="+metricObject.value+",";if(metricObject.unit=="ms"){timeMetricsUri+=uri;isTimeMetricsPresent=true;}
else{countMetricsUri+=uri;}});countMetricsUri=featureName+":"+countMetricsUri.slice(0,countMetricsUri.length-1);if(isTimeMetricsPresent){timeMetricsUri=featureName+":"+timeMetricsUri.slice(0,timeMetricsUri.length-1)+":u=ms";}
var url=protocol+ue.furl+"/1/"+channel+"/1/OP/"+programGroup+"/action/"+countMetricsUri+"/"+timeMetricsUri+"?marketplaceId="+ue.mid+"&requestId="+ue.rid+"&session="+ue.sid+"&_="+(new Date()).getTime();return url;};this.init=function(){var self=this;$(window).unload(function(){self.uploadData()});}
this.uploadData=function(){var uploadData=loggerClient.getDataToUploadOnUnload();var url=constructUploadUrl(uploadData);if(Twister.printConsoleLogs){console.log("url is "+url);}
(new Image()).src=url;}}
Twister.Logger=function($){var self=this;var channel="action-impressions";var programGroup="dpbxvariations";var featureName="twister";this.eventTypes={"CLICK":{metricList:["M_CLICK_COUNT","M_FIRST_CLICK"]},"HOVER":{metricList:["M_HOVER_COUNT","M_FIRST_HOVER"]},"HOVER_OUT":[],"CACHE_HIT":{metricList:["M_CACHE_HIT","M_CACHE_USED"]},"CACHE_MISS":{metricList:["M_CACHE_MISS","M_CACHE_USED"]},"PAGE_UNLOAD":{metricList:["M_CACHE_UNUSED","M_CACHE_HIT_RATIO","M_CACHE_USED_RATIO"]},"REQ_DIM_CHANGED":{metricList:["M_OTHER_REQ_DIM_SELECTED_COUNT","M_REQ_DIM_CHANGE_COUNT"]}};var metricInfoMap={"M_CACHE_HIT":{"stringVal":"CacheHit","unit":"","initValue":0,"updateFunction":function(eventData){this.currentValue=(this.currentValue>0)?(this.currentValue+1):1;if(Twister.printConsoleLogs){console.log("incrementing cacheHit count to "+this.currentValue);}}},"M_CACHE_MISS":{"stringVal":"CacheMiss","unit":"","initValue":0,"updateFunction":function(eventData){this.currentValue=(this.currentValue>0)?(this.currentValue+1):1;}},"M_CACHE_HIT_RATIO":{"stringVal":"CacheHitRatio","unit":"","initValue":NaN,"updateFunction":function(eventData){var cacheHit=self.getMetricCurrentValue("M_CACHE_HIT");var cacheMiss=self.getMetricCurrentValue("M_CACHE_MISS");if(!cacheHit&&!cacheMiss)return;var cacheHitRatio=Math.round(cacheHit/(cacheHit+cacheMiss)*100);this.currentValue=cacheHitRatio;}},"M_CACHE_USED":{"stringVal":"CacheUsed","unit":"","initValue":0,"updateFunction":function(eventData){if(!this.currentValue){this.currentValue=this.initValue;this.usedIdCache={};}
var id=eventData["id"];if(!this.usedIdCache.hasOwnProperty(id)){this.currentValue++;this.usedIdCache[id]=true;}}},"M_CACHE_UNUSED":{"stringVal":"CacheUnused","unit":"","initValue":0,"updateFunction":function(eventData){var cacheSize=twisterController.model.pageRefresh.getModelCacheSize("full");var cacheUnused=cacheSize-self.getMetricCurrentValue("M_CACHE_USED");this.currentValue=(cacheUnused<0)?0:cacheUnused;}},"M_CACHE_USED_RATIO":{"stringVal":"CacheUsedRatio","unit":"","initValue":NaN,"updateFunction":function(eventData){var cacheUsed=self.getMetricCurrentValue("M_CACHE_USED");var cacheUnused=self.getMetricCurrentValue("M_CACHE_UNUSED");if(!cacheUsed&&!cacheUnused)return;var cacheUsedRatio=Math.round(cacheUsed/(cacheUsed+cacheUnused)*100);this.currentValue=cacheUsedRatio;}},"M_CLICK_COUNT":{"stringVal":"ClickCount","unit":"","initValue":0,"updateFunction":function(eventData){this.currentValue=(this.currentValue>0)?(this.currentValue+1):1;if(Twister.printConsoleLogs){console.log("incrementing click count to "+this.currentValue);}}},"M_FIRST_CLICK":{"stringVal":"FirstClick","unit":"ms","initValue":NaN,"updateFunction":function(eventData){if(this.firstClickLogged)return;this.currentValue=(eventData["time"]-Twister["jsInteractivityEnabledTime"]);if(Twister.printConsoleLogs){console.log("first click = "+this.currentValue);}
this.firstClickLogged=true;}},"M_HOVER_COUNT":{"stringVal":"HoverCount","unit":"","initValue":0,"updateFunction":function(eventData){var divMetaData=eventData["divMetaData"];if(this.lastHoveredDivMetaData&&divMetaData){if(this.lastHoveredDivMetaData["dimIndex"]===divMetaData["dimIndex"]&&this.lastHoveredDivMetaData["dimValueIndex"]===divMetaData["dimValueIndex"]){return;}}
this.lastHoveredDivMetaData=divMetaData;this.currentValue=(this.currentValue>0)?(this.currentValue+1):1;if(Twister.printConsoleLogs){console.log("incrementing hover count to "+this.currentValue);}}},"M_FIRST_HOVER":{"stringVal":"FirstHover","unit":"ms","initValue":NaN,"updateFunction":function(eventData){if(this.firstHoverLogged)return;this.currentValue=(eventData["time"]-Twister["jsInteractivityEnabledTime"]);if(Twister.printConsoleLogs){console.log("first hover = "+this.currentValue);}
this.firstHoverLogged=true;}},"M_OTHER_REQ_DIM_SELECTED_COUNT":{"stringVal":"OtherReqDimSelectedCount","unit":"","initValue":NaN,"updateFunction":function(eventData){var newReqDimValueIndex=eventData["newReqDimValueIndex"];var oldReqDimValueIndex=eventData["oldReqDimValueIndex"];if(newReqDimValueIndex==="X"){if(!this.currentValue){this.lastReqDimValueIndex=oldReqDimValueIndex;this.currentValue=0;}
return;}
if(this.lastReqDimValueIndex===newReqDimValueIndex){return;}
this.lastReqDimValueIndex=newReqDimValueIndex;if(!this.currentValue&&this.currentValue!==0){(oldReqDimValueIndex==="X")?this.currentValue=0:this.currentValue=1;}
else{this.currentValue++;}
if(Twister.printConsoleLogs){console.log("OtherReqDimSelectedCount incremented to : "+this.currentValue);}}},"M_REQ_DIM_CHANGE_COUNT":{"stringVal":"ReqDimChangeCount","unit":"","initValue":0,"updateFunction":function(eventData){if(!this.currentValue){this.currentValue=1;return;}
this.currentValue++;if(Twister.printConsoleLogs){console.log("ReqDimChangeCount incremented to : "+this.currentValue);}}}};this.init=function(){loggerService=new Twister.LoggerService($,this,channel,programGroup,featureName);loggerService.init();}
this.logImpression=function(eventType,eventData){try{var metricList=eventType["metricList"];$.each(metricList,function(index,metricName){try{metricInfoMap[metricName].updateFunction(eventData);}
catch(e){if(Twister.printConsoleLogs){console.log("metricUpdate failing for metric = "+metricName);}}});}
catch(e){if(Twister.printConsoleLogs){console.log("logImpression failed");}}}
this.getDataToUploadOnUnload=function(){this.logImpression(this.eventTypes.PAGE_UNLOAD);var dataToUpload={};$.each(metricInfoMap,function(k,v){try{var mName=v.stringVal;var mUnit=v.unit;var mValue;if(v.hasOwnProperty("getUploadValue")){mValue=v.getUploadValue();}
else if(v.hasOwnProperty("currentValue")){mValue=v.currentValue;}
else{mValue=v.initValue;}
if(isNaN(mValue))return;dataToUpload[k]={"unit":mUnit,"value":mValue,"name":mName};}
catch(e){}});return dataToUpload;}
this.getMetricCurrentValue=function(metricName){try{return(metricInfoMap[metricName].hasOwnProperty("currentValue"))?metricInfoMap[metricName].currentValue:metricInfoMap[metricName].initValue;}
catch(e){return metricInfoMap[metricName].initValue;}}}
PageRefresh.ajaxScope=function($,scopeName,url){this.scopeName=scopeName;this.url=url;var new_t0=window.newTwisterInteractionStartTime;ues("t0",scopeName,new_t0);ues("ctb",scopeName,"1");this.signalMarker=function(name){if(!this.markers[name]||this.markers[name].conditions<=0){return;}
if(--this.markers[name].conditions===0){if(typeof this.markers[name].handler=="function"){this.markers[name].handler();}}}
this.addlongPoleTag=function(marker,customtag){marker=marker.toLowerCase();if(!this.markers[marker]||this.markers[marker].conditions!=0){return;}
if(this.markers[marker].conditions==0){if(window.ue&&typeof ue.tag==='function'){ue.tag(customtag);}}}
this.postData=function(){var lScopeName=this.scopeName;$.ajax({url:this.url,dataType:'text',timeout:40000,error:function(){},success:function(data,status,xhr){ues("id",lScopeName,data);uex("ld",lScopeName);}});}
var refreshScope=this;this.markers={image:{conditions:1,handler:function(){uet("ne",scopeName);refreshScope.signalMarker("af");}},af:{conditions:Twister.atfMarkerCount?Twister.atfMarkerCount:2,handler:function(){uet("af",scopeName);uet("cf",scopeName);refreshScope.signalMarker("cf");}},cf:{conditions:Twister.cfMarkerCount?Twister.cfMarkerCount:2,handler:function(){uet("cf",scopeName);refreshScope.postData();}}};}
PageRefresh.Measurement=function($,atfMarker,cfMarker){this.atfMarker=atfMarker;this.cfMarker=cfMarker;this.scopeCount={};this.ajaxScopes={};this.url="";this.init=function(storeID,productGroupID){this.url="/gp/twister/dynamic-update/ajax-measurement.html/?s="+storeID+"&pgid="+productGroupID+"&deviceType="+Twister.deviceType+"&useAui="+Twister.useAui+"&tapEnabled="+Twister.tapEnabled;if(Twister.isInstaTwisterEnabled){this.url+="&ptd="+Twister.productTypeName;}}
this.start=function(ASIN,requestedOn){if(window.ue){if(!this.scopeCount[ASIN]){this.scopeCount[ASIN]=0;}
var scopeName=ASIN+(this.scopeCount[ASIN]+1);this.scopeCount[ASIN]++;var newUrl=requestedOn?this.url+"&requestedOn="+requestedOn:this.url;this.ajaxScopes[ASIN]=new PageRefresh.ajaxScope($,scopeName,newUrl);}}
this.stampImageLoad=function(ASIN){if(!this.ajaxScopes[ASIN]){return;}
if(Twister.printConsoleLogs)console.log("In stampImageLoad: "+ASIN);this.ajaxScopes[ASIN].signalMarker("image");if(Twister.cfImageLongPollTag){this.ajaxScopes[ASIN].addlongPoleTag("cf",Twister.cfImageLongPollTag);}}
this.stampFeature=function(feature,ASIN){if(!this.ajaxScopes[ASIN]){return;}
if(feature===this.atfMarker){this.ajaxScopes[ASIN].signalMarker("af");}
if(feature===this.cfMarker){this.ajaxScopes[ASIN].signalMarker("cf");if(Twister.cfHtmlLongPollTag){this.ajaxScopes[ASIN].addlongPoleTag("cf",Twister.cfHtmlLongPollTag);}}}
this.stampCustomMetrics=function(customMetric,ASIN){if(!this.ajaxScopes[ASIN]){return;}
var lscopeName=this.ajaxScopes[ASIN].scopeName;uet(customMetric,lscopeName);}}
var flushAjaxJS=function($){window.PageAjax=function(oParams){var oPageAJAX={};var delimiter;var reload=0;var scripttokenreg=new RegExp("<<<SCRIPT_END>>>",'g');var requestLog=[];function requestEntry(reqKey){return requestLog[reqKey];}
var cleanUpRequest=function(requestKey,tryInx,xhrTimeoutId){oPageAJAX.removeRequest(requestKey,tryInx);clearTimeout(xhrTimeoutId);};var retry=function(ajaxLoad,useIframe,ajaxUrl,pageUrl,ok,err,requestKey,status,streamingXhr){if(oPageAJAX.getRequestTries(requestKey)<oPageAJAX.options.retries){if(streamingXhr){status=status?status:AJAXFlushUtils.ajaxHandlerCode.RETRY;streamingXhr.abort(status);}
oPageAJAX.resetDataInx(requestKey);if(typeof ajaxLoad=='function'){ajaxLoad(useIframe,ajaxUrl,pageUrl,ok,err,requestKey,oPageAJAX.getRequestTries(requestKey)+1);}}else if(streamingXhr){streamingXhr.abort(AJAXFlushUtils.ajaxHandlerCode.ABORT);}};var StreamingXhr=function(ajaxUrl,pageUrl,useIFrame,requestKey,tryInx){var requestKey=requestKey,tryInx=tryInx,abortCode,xhr,iframe,iFrameElem,eos;if(useIFrame){var frmUrl=ajaxUrl+
'&asScript=1'+
'&reqKey='+encodeURIComponent(requestKey)+
'&try='+tryInx;iFrameElem='<iframe style="width:0px; height:0px; border: 0px" src="'+frmUrl+'"></iframe>';}else{if(window.XMLHttpRequest){xhr=new XMLHttpRequest();}else{xhr=new ActiveXObject("Microsoft.XMLHTTP");}}
this.getAbortCode=function(){return abortCode;};this.usingXhr=function(){return xhr?true:false;};this.getXhrImpl=function(){return xhr?xhr:iframe;};this.open=function(){if(xhr){xhr.open("GET",ajaxUrl,true);}};this.send=function(){if(xhr){xhr.send(null);}else if(iFrameElem){iframe=$(iFrameElem).appendTo("body")[0];}};this.abort=function(code){abortCode=code;if(xhr){xhr.abort();}else if(iframe){$(iframe).remove();}
try{var callbacks=oPageAJAX.getCallbacks(requestKey,tryInx);callComplete=callbacks['callComplete'],success_callback=callbacks['onSuccess'],error_callback=callbacks['onError'],statusHandler=callbacks['statusHandler'],appStatus=callComplete(success_callback,error_callback,{},AJAXFlushUtils.ajaxReadyState.LOADING,abortCode?abortCode:AJAXFlushUtils.serverCode.ERROR);statusHandler(appStatus,AJAXFlushUtils.ajaxReadyState.LOADING);}
catch(e){}};this.errorReload=function(){oPageAJAX.resetRequestLoading(requestKey,tryInx);retry(null,!this.usingXhr,null,pageUrl,null,null,requestKey,AJAXFlushUtils.ajaxHandlerCode.FATAL);};this.isRunning=function(){return oPageAJAX.isRequestLoading(requestKey,ajaxUrl,tryInx);};};var chunkNewData=function(responseText,requestKey){var startInx=oPageAJAX.getDataInx(requestKey),lastDelimInx=responseText.lastIndexOf(delimiter),chunks=[];if(lastDelimInx>startInx){chunks=responseText.substr(startInx,lastDelimInx-startInx);oPageAJAX.putDataInx(requestKey,lastDelimInx+delimiter.length);}else{return chunks;}
if(chunks.length>0){chunks=chunks.split(delimiter);}
return chunks;};$.extend(oPageAJAX,{defaultOptions:{'timeout':40000,'retries':1},options:{},initialize:function(oParams){oPageAJAX.options=$.extend(oPageAJAX.defaultOptions,oParams);delimiter=oPageAJAX.options.streamDelimiter.replace(/-/g,'');},update:function(oParams){$.extend(oPageAJAX.options,oParams);},printStats:function(){},newRequest:function(reqKey,url){requestLog[reqKey]={loading:[url],tryCount:1,dataInx:0,xhrs:[],callbacks:[]};},removeRequest:function(reqKey,tryInx){if(requestEntry(reqKey)){var outstandingTry=0,rl=requestLog[reqKey];for(var i in rl.loading){if(i!=tryInx&&rl.loading[i]){outstandingTry=1;break;}}
if(!outstandingTry){var xhr=rl.xhrs[tryInx];if(xhr&&!xhr.usingXhr()){$(xhr.getXhrImpl()).remove();}
delete requestLog[reqKey];}}},isRequestLoading:function(reqKey,url,tryInx){var e=requestEntry(reqKey);return e&&e.loading[tryInx]==url;},resetRequestLoading:function(reqKey,tryInx){var e=requestEntry(reqKey);if(e){e.loading[tryInx]=0;}},incrRequestTries:function(reqKey,url){var e=requestEntry(reqKey);if(e){e.loading[e.tryCount++]=url;}},getRequestTries:function(reqKey){var e=requestEntry(reqKey);return e?e.tryCount:0;},resetDataInx:function(reqKey){var e=requestEntry(reqKey);if(e){e.dataInx=0;}},getDataInx:function(reqKey){var e=requestEntry(reqKey);return e?e.dataInx:0;},putDataInx:function(reqKey,inx){var e=requestEntry(reqKey);if(e){e.dataInx=inx;}},putXhr:function(reqKey,xhr,tryInx){var e=requestEntry(reqKey);if(e){e.xhrs[tryInx]=xhr;}},getXhr:function(reqKey,tryInx){var e=requestEntry(reqKey);if(e){return e.xhrs[tryInx];}},putCallbacks:function(reqKey,tryInx,callbackMap){var e=requestEntry(reqKey);if(e){e.callbacks[tryInx]=callbackMap;}},getCallbacks:function(reqKey,tryInx){var e=requestEntry(reqKey);return e?e.callbacks[tryInx]:[];},pageReload:function(url,status){window.location=url;},handleDataChunk:function(data,encodedReqKey,tryInx){if(data){var reqKey=decodeURIComponent(encodedReqKey),callbacks=oPageAJAX.getCallbacks(reqKey,tryInx);if(!callbacks||callbacks.length==0){return;}
var callComplete=callbacks['callComplete'],success_callback=callbacks['onSuccess'],error_callback=callbacks['onError'],statusHandler=callbacks['statusHandler'],dataName=data.FeatureName,loadingStatus=AJAXFlushUtils.ajaxReadyState.LOADING;if(dataName=='EOS'){loadingStatus=AJAXFlushUtils.ajaxReadyState.DONE;}
try{var d=data,v,content,elementDataCopy;v=d.Value;content=v.content;for(var element in content){elementDataCopy=content[element];content[element]=elementDataCopy.replace(scripttokenreg,"</script>");}}
catch(e){}
try{var appStatus=callComplete(success_callback,error_callback,d,loadingStatus,AJAXFlushUtils.serverCode.OK);statusHandler(appStatus,loadingStatus);}
catch(e){}}},loadStreaming:function(useIframe,ajaxUrl,pageUrl,success_callback,error_callback,requestKey,tryCount){var startTime=new Date(),tryInx=tryCount===undefined?0:tryCount-1;if(requestEntry(requestKey)){oPageAJAX.incrRequestTries(requestKey,ajaxUrl);}else{oPageAJAX.newRequest(requestKey,ajaxUrl);}
var callComplete=function(success_callback,error_callback,data,xhrReadyState,xhrStatus,streamingXhr){var timeElapsed=new Date()-startTime;clearTimeout(xhrTimeoutId);if(oPageAJAX.isRequestLoading(requestKey,ajaxUrl,tryInx)){var callBackContext={timeElapsed:timeElapsed,xhrStatus:xhrStatus,requestKey:requestKey},dataObj={};if(xhrStatus==AJAXFlushUtils.serverCode.OK){if((typeof data)=='string'){try{dataObj=eval('('+data+')');}catch(e){return error_callback.AJAXErrorHandler(callBackContext,data,AJAXFlushUtils.ajaxHandlerCode.INVALID_RESP);};}else{dataObj=data;}
if(streamingXhr&&"EOS"==dataObj.ContentId){streamingXhr.eos=1;}
if(oPageAJAX.options.enforceEOS&&xhrReadyState==AJAXFlushUtils.ajaxReadyState.DONE&&streamingXhr&&!streamingXhr.eos){return error_callback.AJAXErrorHandler(callBackContext,dataObj,AJAXFlushUtils.ajaxHandlerCode.INCOMPLETE_RESP);}
return success_callback.AJAXHandler(callBackContext,dataObj,xhrReadyState);}else{var errStat=AJAXFlushUtils.ajaxHandlerCode.FATAL;if(xhrStatus==AJAXFlushUtils.serverCode.TIMEOUT){errStat=AJAXFlushUtils.ajaxHandlerCode.TIMEOUT;}
return error_callback.AJAXErrorHandler(callBackContext,{},errStat);}}else{oPageAJAX.resetDataInx(requestKey);return AJAXFlushUtils.ajaxHandlerCode.IGNORE;}};var statusHandler=function(appStatus,xhrReadyState){if(AJAXFlushUtils.shouldReload(appStatus)||appStatus==AJAXFlushUtils.ajaxHandlerCode.RETRY){retry(oPageAJAX.loadStreaming,useIframe,ajaxUrl,pageUrl,success_callback,error_callback,requestKey,appStatus);}else if(appStatus==AJAXFlushUtils.ajaxHandlerCode.ABORT){cleanUpRequest(requestKey,tryInx,xhrTimeoutId);}else if(appStatus==AJAXFlushUtils.ajaxHandlerCode.OK||appStatus==AJAXFlushUtils.ajaxHandlerCode.IGNORE){if(xhrReadyState==AJAXFlushUtils.ajaxReadyState.DONE){cleanUpRequest(requestKey,tryInx,xhrTimeoutId);}}};var streamingXhr=new StreamingXhr(ajaxUrl,pageUrl,useIframe,requestKey,tryInx);oPageAJAX.putXhr(requestKey,streamingXhr,tryInx);oPageAJAX.putCallbacks(requestKey,tryInx,{"callComplete":callComplete,"statusHandler":statusHandler,"onSuccess":success_callback,"onError":error_callback});if(streamingXhr.usingXhr()){var xhr=streamingXhr.getXhrImpl();xhr.onreadystatechange=function(){if(xhr.readyState==AJAXFlushUtils.ajaxReadyState.LOADING||xhr.readyState==AJAXFlushUtils.ajaxReadyState.DONE){var firstChunkTime=new Date().getTime();var appStatus=AJAXFlushUtils.ajaxHandlerCode.OK,responseText,status;try{status=xhr.status;if(!status)return;responseText=xhr.responseText;}catch(e){if(xhr.readyState==AJAXFlushUtils.ajaxReadyState.LOADING){return;}else{status=AJAXFlushUtils.serverCode.ERROR;}}
if(status==AJAXFlushUtils.serverCode.OK){var chunks=chunkNewData(responseText,requestKey);if(chunks.length>0){for(var i=0;i<chunks.length;i++){var loadingStatus=AJAXFlushUtils.ajaxReadyState.LOADING;if(xhr.readyState==AJAXFlushUtils.ajaxReadyState.DONE&&i==chunks.length-1){loadingStatus=AJAXFlushUtils.ajaxReadyState.DONE;}
try{appStatus=callComplete(success_callback,error_callback,chunks[i],loadingStatus,status,streamingXhr);}catch(e){}}}else if(xhr.readyState==AJAXFlushUtils.ajaxReadyState.DONE){try{appStatus=callComplete(success_callback,error_callback,"{}",AJAXFlushUtils.ajaxReadyState.DONE,status,streamingXhr);}
catch(e){}}}else{var abortCode=streamingXhr.getAbortCode();try{appStatus=callComplete(success_callback,error_callback,responseText,xhr.readyState,abortCode||status);}
catch(e){}}
statusHandler(appStatus,xhr.readyState);}};}
streamingXhr.open();streamingXhr.send();var streamingXhrTimeout=function(){retry(oPageAJAX.loadStreaming,useIframe,ajaxUrl,pageUrl,success_callback,error_callback,requestKey,AJAXFlushUtils.serverCode.TIMEOUT,streamingXhr);};var xhrTimeoutId=setTimeout(streamingXhrTimeout,oPageAJAX.options.pageTimeout);return streamingXhr;}});oPageAJAX.initialize(oParams);return oPageAJAX;};};var flushUtilsJS=function($){var oAJAXFlushUtils={};$.extend(oAJAXFlushUtils,{ajaxReadyState:{"NONE":-1,"UNSENT":0,"OPENED":1,"HEADERS_RECEIVED":2,"LOADING":3,"DONE":4},ajaxHandlerCode:{"OK":0,"IGNORE":1,"RETRY":2,"RELOAD":3,"TIMEOUT":4,"ABORT":5,"FATAL":6,"INVALID_RESP":7,"INCOMPLETE_RESP":8,"PAGELET_FATAL":9,"DEBUG_NOAJAX":10},serverCode:{"ERROR":-1,"OK":200,"TIMEOUT":408},shouldReload:function(status){return false;}});window.AJAXFlushUtils=oAJAXFlushUtils;};function initThumbnailModule(){P.when('jQuery').register('twister-thumbnailModule',function($){var THUMBNAIL_IMAGE_ID_PREFIX="#dropdown_selected_thumbnail_",DIMENSION_DROPDOWN_ID_PREFIX="#dropdown_selected_",NATIVE_DIMENSION_DROPDOWN_ID_PREFIX="#native_dropdown_selected_",IMAGE_SOURCE_ATTRIBUTE_NAME="data-a-image-source",DROPDOWN_BUTTON_CLASSNAME="a-button-inner";DROPDOWN_DATA_CLASS="data-a-class";IMAGE_DROPDOWN_CLASS="twister-image-dropdown";var thumbnailHandle={attach:function(dimKey){var $thumbnail=$(THUMBNAIL_IMAGE_ID_PREFIX+dimKey);var $dropdownButton=$(DIMENSION_DROPDOWN_ID_PREFIX+dimKey+" ."+DROPDOWN_BUTTON_CLASSNAME);if($thumbnail.length>0&&$dropdownButton.length>0){$thumbnail.detach();$dropdownButton.append($thumbnail);if($thumbnail.attr("src")!=="#"){$thumbnail.show();}}},update:function(dimKey){var selectedOptionInd=$(NATIVE_DIMENSION_DROPDOWN_ID_PREFIX+dimKey).val().split(",")[0];if(typeof(selectedOptionInd)!=='undefined'&&selectedOptionInd!=="-1"){var $nativeOption=$("#native_"+dimKey+"_"+selectedOptionInd);var $imageSource=$nativeOption.length>0?$nativeOption.attr(IMAGE_SOURCE_ATTRIBUTE_NAME):"";var $thumbnail=$(THUMBNAIL_IMAGE_ID_PREFIX+dimKey);if($thumbnail.length>0&&$imageSource!==""){$thumbnail.attr("src",$imageSource);$thumbnail.show();}else{$thumbnail.hide();}}},preloadAllThumbnails:function(dimKey){if(dimKey){var $nativeSelectOptions=$(NATIVE_DIMENSION_DROPDOWN_ID_PREFIX+dimKey+" option");var dataClass=$(DIMENSION_DROPDOWN_ID_PREFIX+dimKey).attr(DROPDOWN_DATA_CLASS);if($nativeSelectOptions&&dataClass&&dataClass.indexOf(IMAGE_DROPDOWN_CLASS)!==-1){$.each($nativeSelectOptions,function(index,option){var imageSource=option.getAttribute(IMAGE_SOURCE_ATTRIBUTE_NAME);if(imageSource){var dummyImage=new Image();dummyImage.src=imageSource;}});}}}}
return thumbnailHandle;});}
if(window.isTwisterAUI){P.when("A","a-state","jQuery","cf","a-dropdown").execute(function(A,events,$,cf,dropdown){var twisterJsInitDpxData={};function newTwisterAvailableOnPage(){if(typeof amznJQ!='undefined')amznJQ.declareAvailable('newTwister');P.register("twisterModule",function(){var twisterModule={getState:function(){return DetailPage.StateController.getState();}
};return twisterModule;});if(typeof amznJQ!='undefined'){amznJQ.declareAvailable('pageRefreshJS');amznJQ.declareAvailable('dpf');}}
function initializeTwister(){Twister.A=A;var data=A.state("twisterData");glueTwisterDpxData(data,twisterJsInitDpxData);var isTablet=data["isTablet"];Twister.useDropdownThumbnail=isTablet;Twister.useVariationsOverlay=isTablet;Twister.showErrorMessageOnFailure=isTablet;Twister.remainingAjaxCalls=0;Twister.errorMessageOnFailure="We are sorry.  Amazon has encountered an error.  Please try again.";Twister.AuiDropdownHandle=dropdown;window.twisterInitPrefetchMode=data["twisterInitPrefetchMode"];window.jqupgrade=data['jqupgrade'];Twister["prefetchRelatedAttrs"]=data['prefetchRelatedAttrs'];Twister["isLoggingEnabled"]=data['isLoggingEnabled'];Twister["printConsoleLogs"]=data['printConsoleLogs'];Twister["useAui"]=data['useAui'];Twister["tapEnabled"]=data['tapEnabled'];Twister["predictivePrefetch"]=A.capabilities.touch&&data['cpDisabledOnTouch']?false:data['predictivePrefetch'];Twister["useBeaconizedEVDD"]=data["useBeaconizedEVDD"];Twister["useNativeDD"]=data['useNativeDD'];Twister["useAuiAjax"]=data["useAuiAjax"];Twister["deviceType"]=data["data"]["deviceType"];var atfMarkerFeature=data["measurement"]["atf"]["marker"];Twister["atfMarkerCount"]=data["measurement"]["atf"]["count"];var cfMarkerFeature=data["measurement"]["cf"]["marker"];Twister["cfMarkerCount"]=data["measurement"]["cf"]["count"];Twister["cfImageLongPollTag"]=data["measurement"]["cf"]["longPollImageTag"];Twister["cfHtmlLongPollTag"]=data["measurement"]["cf"]["longPollHtmlTag"];var tm=new PageRefresh.Manager($,data["data"]["contextMetaData"],{"atfMarker":atfMarkerFeature,"cfMarker":cfMarkerFeature,"logChannel":"twister"},data["loadingBarHtml"],data["loadingBarHtml2"]);window.twisterController=new Twister.Controller($,tm);window.twisterController.init(data["data"]);if(Twister.predictivePrefetch){TwisterPrefetch.setup(twisterController.model.pageRefresh,Twister.predictivePrefetch);}
newTwisterAvailableOnPage();initThumbnailModule();};function glueTwisterDpxData(twisterData,twisterDpxData){if($.isEmptyObject(twisterDpxData)){return;}
var dpxDivLists=twisterDpxData['updateDivLists'];Twister['dpEnvironment']=twisterDpxData['dpEnvironment'];Twister['isInstaTwisterEnabled']=true;Twister['productTypeName']=twisterData['productTypeName'];var data=twisterData['data'];var contextMetaData=data['contextMetaData'];var fullData=contextMetaData['full'];var masterData=contextMetaData['master'];var parentData=contextMetaData['parent'];var partialData=contextMetaData['partial'];data['stateData']['dimensionSelectionData']=twisterDpxData['dimensionSelectionData'];data['viewData']['dimensionsDisplayType']=twisterDpxData['dimensionsDisplayType'];data['variationsData']['dimensionsDisplayType']=twisterDpxData['dimensionsDisplayType'];if(twisterDpxData['shouldUseDPXTwisterData']){data['variationsData']['dimToAsinMapData']=twisterDpxData['dimensionToAsinMap'];data['variationsData']['asinToDimIndexMapData']=twisterDpxData['asinToDimensionIndexMap'];data['variationsData']['dimensionValuesData']=twisterDpxData['dimensionValuesData'];data['stateData']['variation_values']=twisterDpxData['variationValues'];data['stateData']['asin_variation_values']=twisterDpxData['asinVariationValues'];data['stateData']['reactId']=twisterDpxData['reactId'];data['stateData']['currentDimCombID']=twisterDpxData['currentDimensionCombinationId'];data['stateData']['selected_variation_values']=twisterDpxData['selectedVariationValues'];}
if(dpxDivLists['full']!=null){if(fullData['elementList']!=null){fullData['elementList']=dpxDivLists['full'].concat(fullData['elementList']);}
else{fullData['elementList']=dpxDivLists['full'];}}
if(dpxDivLists['master']!=null){if(masterData['elementList']!=null){masterData['elementList']=dpxDivLists['master'].concat(masterData['elementList']);}
else{masterData['elementList']=dpxDivLists['master'];}}
if(dpxDivLists['parent']!=null){if(parentData['elementList']!=null){parentData['elementList']=dpxDivLists['parent'].concat(parentData['elementList']);}
else{parentData['elementList']=dpxDivLists['parent'];}}
if(dpxDivLists['partial']!=null){if(partialData['elementList']!=null){partialData['elementList']=dpxDivLists['partial'].concat(partialData['elementList']);}
else{partialData['elementList']=dpxDivLists['partial'];}}}
if(window.DetailPage.useTwisterJsInitFromDPXPartially){P.when('twister-js-init-dpx-data').execute(function(data){twisterJsInitDpxData=data;A.on.ready(initializeTwister);});}else{A.on.ready(initializeTwister);}});}
else{if(typeof amznJQ!='undefined'){amznJQ.declareAvailable('pageRefreshJS');amznJQ.declareAvailable('dpf');}}
/* end pageRefreshJS/pageRefresh.js */
