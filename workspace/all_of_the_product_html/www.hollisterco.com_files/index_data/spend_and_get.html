<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html webdriver="true" xmlns="http://www.w3.org/1999/xhtml"><head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!--[if lte IE 8]>
		<script src="/pik_testing/connectors/json.js"></script>
		<![endif]-->
		<script>

(function() {
	
	// generate a random integer from 0 to n-1.
	function rand(n) {
		return Math.floor(Math.random() * n);
	}
	
	// reads a single URL parameter.
	function gup(name) {
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regexS = "[\\?&]" + name + "=([^&#]*)";
		var regex = new RegExp(regexS);
		var results = regex.exec(window.location.href);
	
		if(!results)
			return false;
		else
			return results[1];
	}
	
	// helper functions for local storage access.
	function setStoredGroup(g) {
		window.localStorage["sr_exp_" + exp_id] = g;
	}
	function getStoredGroup() {
		return window.localStorage["sr_exp_" + exp_id];
	}
	
	var exp_id = "spend_and_get";
	var hardcode_version = gup("v");
	var partner = gup("rID").toUpperCase();
	var content = function() {};
	var group;
	
	function get_content() {
		
		// figure out the path for experiment files.
		var path = "/pikcm/files/export/helpers/experiments/";
		if(window.location.hostname == "staging-content.shoprunner.com") {
			path = "https://staging-content.shoprunner.com/staging/helpers/experiments/";
		}
		else if(window.location.hostname == "content.shoprunner.com") {
			path = "https://content.shoprunner.com/helpers/experiments/";
		}
		
		// this code just sets the spend and get parameters and
		// loads a JS file that'll do the rest.
		var code =
			'function(){' +
				'sr_$.model.spendAndGet = {group: ' + group + '};' +
				'var script = document.createElement("script");' +
				'script.src = "' + path + 'spend_and_get.js";' +
				'document.head.appendChild(script);' +
			'}';
		
		return code;
	}
	
	// figure out what group the user is in.
	
	// if we've provided a group in the URL, use that.
	if(hardcode_version) {
		group = parseInt(hardcode_version);
		
		// remember their group.
		setStoredGroup(group);
	}
	else {
		group = getStoredGroup();
		
		// spend and get is 100% now, so make anyone who wasn't
		// in it pick again.
		if(group == "false") {
			group = "";
		}
		
		// if they didn't have an assigned group, pick one.
		if(!group) {
			var r = rand(100);
			
			// a 50/50 chance for groups 1 and 2.
			if(r < 50) {
				group = 1;
			}
			else {
				group = 2;
			}
			
			// remember their group.
			setStoredGroup(group);
		}
	}
	
	// if they're not in the experiement, we can stop here.
	if(group == "false") {
		return;
	}
	
	var cache_bust = 1;
	var sr_postMessage = function(message) {
		target_url = gup("purl");
		target = parent;
		
		if(!target_url) {
			return;
		}
		
		if(window.postMessage) {
			target.postMessage(message, target_url.replace(/([^:]+:\/\/[^\/]+).*/, "$1"));
		}
		else if(target_url) {
			target.location = target_url.replace(/#.*$/, "") + "#" + (+new Date) + (cache_bust++) + "&" + message;
		}
		
		return true;
	};
	
	var params = {};
	params.exp_id = exp_id;
	params.exp_version = group;
	params.content = get_content();
	
	// provide the experiment's content to the parent window.
	sr_postMessage('{"sr_dyn_exp":' + JSON.stringify(params) + '}');

}());
		</script>
	</head>
	<body>
</body></html>