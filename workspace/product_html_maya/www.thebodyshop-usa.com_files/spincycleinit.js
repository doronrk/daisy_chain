if(!Array.prototype.indexOf){Array.prototype.indexOf=function(obj,fromIndex){var i,j;if(fromIndex===null){fromIndex=0}else if(fromIndex<0){fromIndex=Math.max(0,this.length+fromIndex)}for(i=fromIndex,j=this.length;i<j;i++){if(this[i]===obj){return i}}return-1}}var CBWA_={events:(CBWA_)?CBWA_.events||[]:[],messages:{},options:{},settings:{cid:null,host:window.location.protocol+"//conversion.buddymedia.com",resUrl:window.location.protocol+"//cdn-cwa.buddymedia.com",campaigns:null,oShareTypes:{pinterest:{},facebook:true,like:{},link:true,email:true,twitter:{count:"none"}},st:{'fb':'facebook','tw':'twitter','em':'email','ln':'link','li':'linkedin','gp':'google','pt':'pinterest'},assistedNetworks:{'twitter':'twitter','plus':'google','wall':'facebook'},appID:"314656568573075",objHash:[],guids:{puid:null,impression:null,clickback:null,button_click:null,share:null,share_cancel:null,purchase:null,conversion:null},blfbook:false,ga_id:null,bltwitter:false,totalmatch:0,linkqueue:[],eventIncrement:0,statusCheck:false,facebook_caption:"http://www.thebodyshop-usa.com/",facebookCanvasUrl:"http://apps.facebook.com/thebodyshopshare",default_pi:"",default_plp:"",dafault_pd:"",twitterAccount:"thebodyshopusa",twitterAdditionalAccounts:"tbsfoundation,tradewithheart",actionLinkText:"",actionLinkUrl:"",environment:"",version:"2014102810"},addEvent:function(obj,type,fn){if(obj.addEventListener){obj.addEventListener(type,fn,false)}else if(obj.attachEvent){obj["e"+type+fn]=fn;obj[type+fn]=function(){obj["e"+type+fn](window.event)};obj.attachEvent("on"+type,obj[type+fn])}},gat:function(s,share){var pageTracker={},propertyId=this.settings.ga_id;if(propertyId){if(typeof(window._gat)==="object"&&_gat._getTracker){pageTracker=_gat._createTracker(propertyId)}else{if(typeof(window._gaq)==="object"&&_gaq._getAsyncTracker){pageTracker=_gaq._getAsyncTracker(propertyId)}else{if(typeof(window._gaq)==="array"){_gaq.push([function(){CBWA_.gat(s,share)}])}}}}if(pageTracker&&typeof(pageTracker)==="string"){pageTracker=window[pageTracker]}if(pageTracker&&typeof(pageTracker)==="object"){var gaUrl=location.href;if(gaUrl.toLowerCase().replace("https","http").indexOf("http%3a%2f%2f")===0){gaUrl=_duc(gaUrl)}try{pageTracker._trackEvent("spinback",s,share,gaUrl)}catch(e){try{pageTracker._initData();pageTracker._trackEvent("spinback",s,share,gaUrl)}catch(f){}}}},pageLoaded:{readyBound:false,ready:function(){if(CBWA_.pageLoaded.readyBound){return}CBWA_.pageLoaded.readyBound=true;CBWA_.pageReady()},init:function(){if(document.addEventListener){DOMContentLoaded=function(){document.removeEventListener("DOMContentLoaded",DOMContentLoaded,false);CBWA_.pageLoaded.ready()}}else if(document.attachEvent){DOMContentLoaded=function(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",DOMContentLoaded);CBWA_.pageLoaded.ready()}}}if(document.readyState==="complete"){setTimeout(CBWA_.pageLoaded.ready,1)}if(document.addEventListener){document.addEventListener("DOMContentLoaded",DOMContentLoaded,false);window.addEventListener("load",CBWA_.pageLoaded.ready,false)}else if(document.attachEvent){document.attachEvent("onreadystatechange",DOMContentLoaded);window.attachEvent("onload",CBWA_.pageLoaded.ready)}}},init:function(){if(this.util.getQueryVariable('cb_test',document.location.href)){this.settings.statusCheck=true;var messageScript=this.util.loadResource('script','postMessage',this.settings.resUrl+'/v/'+this.settings.version+'/scripts/postMessage_min.js')}if(!document.getElementById('spinback-spincycle')){this.logError('error','Script tag is missing required "spinback-spincycle" id');return false}this.settings.cid=this.util.getQueryVariable('cid',this.util.parseAttributes(document.getElementById('spinback-spincycle')).src);if(this.settings.default_pi!==''){this.options.pi=this.settings.default_pi}if(this.settings.default_plp!==''){this.options.plp=this.settings.default_plp}if(this.settings.dafault_pd!==''){this.options.pd=this.settings.dafault_pd}if(this.settings.facebook_caption!==''){this.options.fc=this.settings.facebook_caption}var oParams=this.util.parse(this.util.trim(document.getElementById('spinback-spincycle').innerHTML),/(\r\n|\n|\r)/gm);if(oParams){this.options=this.util.merge_options(this.options,oParams)}else if(document.getElementById('spinback-spincycle').attributes.getNamedItem('sb_options')){this.logError('warning','Using sb_options attribute in script tag is deprecated, use instead script tag contents.');this.options=this.util.merge_options(this.options,this.util.parse(document.getElementById('spinback-spincycle').attributes.getNamedItem('sb_options').value,','))}if(this.settings.cid===null){this.logError('error','Script tag is missing required cid parameter');return false}if(this.settings.plp&&this.settings.plp.indexOf('http')===-1){this.settings.plp=CBWA_.util.qualifyURL(this.settings.plp);this.logError('warning','plp (Product Landing Page) parameter is not a fully qualified URL, attempting to fix it with this new URL \''+this.settings.plp+'\'.')}if(this.settings.pi&&this.settings.pi.indexOf('http')===-1){this.settings.pi=CBWA_.util.qualifyURL(this.settings.pi);this.logError('warning','pi (Product Image) parameter is not a fully qualified URL, attempting to fix it with this new URL \''+this.settings.pi+'\'.')}this.pageLoaded.init()},pageReady:function(){if(CBWA_.settings.oShareTypes.pinterest){CBWA_.settings.oShareTypes.pinterest.count=null}if(this.options.fblike&&this.options.fblike!==false){if(!this.settings.oShareTypes.like){this.settings.oShareTypes.like={}}try{delete this.options.fblike}catch(e){}}if(this.options.campaign&&this.options.campaign!==false){this.settings.oShareTypes.campaign=true;try{delete this.options.campaign}catch(e){}}if(this.options.ga_id){this.settings.ga_id=this.options.ga_id;try{delete this.options.ga_id}catch(e){}}if(this.options.container){this.settings.container=this.options.container;try{delete this.options.container}catch(e){}}if(this.options.parsetags){this.settings.parsetags=this.options.parsetags;try{delete this.options.parsetags}catch(e){}}else{this.settings.parsetags='onload'}if(this.settings.oShareTypes.link&&(typeof swfobject=='undefined')){this.util.loadResource('script','swfObject',window.location.protocol+'//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js')}this.util.loadResource('css','sbCSS',this.settings.resUrl+'/v/'+this.settings.version+'/styles/sharewidget.css');this.options.cid=this.settings.cid;if(this.settings.campaigns!==null){CBWA_.campaigns()}var resharePage=(this.options.opts&&this.options.opts.indexOf('reshare')>-1);var postPurchase=(this.options.opts&&this.options.opts.indexOf('pp')>-1);var purchaseEvent=(this.options.purchase&&this.options.purchase!=='false');var campaignEvent=(this.options.campaign&&this.options.campaign!=='false');var clickback=(window.location.search.indexOf('fb_ref')>-1||window.location.search.indexOf('guid')>-1||window.location.search.indexOf('puid')>-1);if(!this.settings.statusCheck){if((postPurchase||campaignEvent)||(!postPurchase&&!campaignEvent)){this.util.loadResource('script','sbSpinCycle',this.settings.resUrl+'/v/'+this.settings.version+'/scripts/spincycle_min.js')}}if(clickback){this.settings.guids.puid=this.util.getQueryVariable('fb_ref',window.location.search.substring(1))||this.util.getQueryVariable('guid',window.location.search.substring(1))||this.util.getQueryVariable('puid',window.location.search.substring(1));var addtlParams={};if(window.location.search.indexOf('fb_ref')>-1){addtlParams.network='fblike'}if(window.location.search.indexOf('st')>-1){addtlParams.network=this.settings.st[this.util.getQueryVariable('st',window.location.search.substring(1))]}}if(window.location.search.indexOf('app_data')>-1){var app_data=CBWA_.util.parse(decodeURIComponent(this.util.getQueryVariable('app_data',window.location.search.substring(1))),',');if(app_data.pi){clickback=true;this.settings.guids.puid=app_data.pi;var addtlParams={assisted_post_id:app_data.pi,assisted_post_type:app_data.pt,network:this.settings.assistedNetworks[app_data.pt],is_assisted:'1'}}}if(clickback){if(!resharePage){var clickbackObj=this.util.merge_options(this.options,addtlParams);for(var key2 in clickbackObj){if(clickbackObj.hasOwnProperty(key2)){clickbackObj[key2]=encodeURIComponent(CBWA_.util.cleanString(clickbackObj[key2]))}}this.logEvent('clickback',clickbackObj,null,'CBWA_.checkCbC')}}if(!resharePage){var loc=encodeURIComponent(window.location.toString()),cbval='';if(window.location.search.indexOf('cbid')>-1){cbval=this.util.getQueryVariable('cbid',window.location.search.substring(1))};var impressionObj=this.util.merge_options(this.options,{'loc':loc,'cbid':cbval});for(var key in impressionObj){if(impressionObj.hasOwnProperty(key)){impressionObj[key]=encodeURIComponent(CBWA_.util.cleanString(impressionObj[key]))}}if(window.location.search.indexOf('cbid')>-1){this.logEvent('impression',impressionObj,null,'CBWA_.cbc_check')}else{this.logEvent('impression',impressionObj)}}if(CBWA_.util.readCookie('cbid'+this.settings.environment)){this.options.cbid=CBWA_.util.readCookie('cbid'+this.settings.environment)}if(purchaseEvent){var returnParams={order_total:this.options.order_total,order_id:this.options.order_id,cid:this.options.cid,cbid:this.options.cbid};this.logEvent('purchase',returnParams)}},checkCbC:function(data){if(data&&data.cbid){var d='&d='+new Date().valueOf();CBWA_.util.loadResource('script','clickback',this.settings.host+'/event/cbc_check?cid='+this.settings.cid+'&cbid='+data.cbid+d,'CBWA_.cbc_check')}},cbc_check:function(data){if(data&&!data.exp_date){CBWA_.util.createCookie('cbid'+this.settings.environment,data.cbid,30);this.options.cbid=data.cbid}},logEvent:function(event,params,guid,callback){if(this.settings.statusCheck){return}callback=callback||'CBWA_.eventCallback';params.guid=guid||this.util.guid();this.settings.guids[event]=params.guid;switch(event){case'impression':params.puid=this.settings.guids.clickback;break;case'clickback':params.puid=this.settings.guids.puid;break;case'campaign':params.puid=this.settings.guids.impression;break;case'button_click':params.chain=(!params.chain||params.chain===null||params.chain==='')?this.util.guid():params.chain;params.puid=this.settings.guids.impression;break;case'email':case'share':if(!guid||guid===null||guid===''){params.guid=params.chain||params.guid}if(params.opts&&params.opts.indexOf('like')>-1){params.puid=this.settings.guids.impression}else{params.puid=this.settings.guids.button_click}break;case'share_cancel':params.puid=this.settings.guids.button_click;try{delete params.chain}catch(e){params.chain=''};break}this.logError('event','type: '+params.network+' '+event+', guid: '+params.guid+', puid: '+params.puid);tempParams=this.util.merge_options(params,{});try{delete tempParams.url}catch(e){tempParams.url=''};try{delete tempParams.short_url}catch(e){tempParams.short_url=''};var d='&d='+new Date().valueOf(),s_params=CBWA_.util.serialize(tempParams);CBWA_.util.loadResource('script',event,this.settings.host+'/event/'+event+'?'+s_params+d,callback)},logError:function(type,message,id){id=(id)?id:this.settings.eventIncrement+=1;if(!this.messages[type]){this.messages[type]={}};this.messages[type][id]=message},eventCallback:function(data){this.logError('event','type: '+data.type.replace('spinback.','')+' response, success:'+data.success)},campaigns:function(){var data={};var key,s_params,elemObj,locUrl=document.URL;data.campaigns=this.settings.campaigns;for(key in data.campaigns){if(data.campaigns.hasOwnProperty(key)){if((locUrl.indexOf(data.campaigns[key].url)>-1)||(data.campaigns[key].url.indexOf(locUrl)>-1)){s_params=this.util.merge_options(this.options,data.campaigns[key].value);if(data.campaigns[key].type==='impression'){CBWA_.logError('campaigns','impression event: '+this.util.serialize(data.campaigns[key].value));CBWA_.logEvent('campaign',s_params);if(CBWA_.settings.ga_id!==null){CBWA_.gat(data.campaigns[key].value.cp,data.campaigns[key].value.cn)}}if(data.campaigns[key].type==='click'){elemObj=null;if(data.campaigns[key].html_id){elemObj=document.getElementById(data.campaigns[key].html_id);if(elemObj){var z=document.createAttribute('sb_campaign_key');z.value=key;elemObj.setAttributeNode(z);CBWA_.addEvent(elemObj,'click',function(e){var keyId=this.attributes.getNamedItem('sb_campaign_key').value;CBWA_.logError('campaigns',keyId+' click event: '+CBWA_.util.serialize(CBWA_.settings.campaigns[keyId].value));CBWA_.logEvent('campaign',CBWA_.util.merge_options(CBWA_.options,CBWA_.settings.campaigns[keyId].value));if(CBWA_.settings.ga_id!==null){CBWA_.gat(CBWA_.settings.campaigns[keyId].value.cp,CBWA_.settings.campaigns[keyId].value.cn)}})}}else if(data.campaigns[key].html_class){elemObj=CBWA_.util.getElementsByClassName(document,'*',data.campaigns[key].html_class);if(elemObj){for(var i=0;i<elemObj.length;i=i+1){var z=document.createAttribute('sb_campaign_key');z.value=key;elemObj[i].setAttributeNode(z);CBWA_.addEvent(elemObj[i],'click',function(e){var keyId=this.attributes.getNamedItem('sb_campaign_key').value;CBWA_.logError('campaigns',keyId+' click event: '+CBWA_.util.serialize(CBWA_.settings.campaigns[keyId].value));CBWA_.logEvent('campaign',CBWA_.util.merge_options(CBWA_.options,CBWA_.settings.campaigns[keyId].value));if(CBWA_.settings.ga_id!==null){CBWA_.gat(CBWA_.settings.campaigns[keyId].value.cp,CBWA_.settings.campaigns[keyId].value.cn)}})}}}}}}}},util:{parse:function(str,delimiter){if(!str||!delimiter){return null}var aParamsDirty=str.replace(/^\{?(.*?)\}?$/,function(str,group1){return group1}).split(delimiter);if(aParamsDirty.length>0){var oParams={},q,tmp,len=aParamsDirty.length,patt=/([^:]*)\:(.*)/;for(q=0;q<len;q++){tmp=CBWA_.util.trim(aParamsDirty[q]);if(patt.test(tmp)){tmp=tmp.match(patt);tmp.shift();if(tmp.length>0){tmp[1]=CBWA_.util.trim(tmp[1]);tmp[1]=(tmp[1].charAt(tmp[1].length-1)===',')?tmp[1].slice(0,tmp[1].length-1):tmp[1];tmp[1]=(tmp[1].indexOf('document.location')>-1)?document.location.href:tmp[1];oParams[CBWA_.util.trim(CBWA_.util.trimQuotes(tmp[0]))]=CBWA_.util.trimQuotes(tmp[1])}}else if(tmp!==''){CBWA_.logError('warning','Parameter passed without colon. \''+tmp+'\'')}}}return oParams},createCookie:function(name,value,days){var expires="";if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString()}document.cookie=name+"="+value+expires+"; path=/; domain=."+/[^\.]+.[^\.]+$/.exec(location.hostname)},readCookie:function(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' '){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)==0){return c.substring(nameEQ.length,c.length)}}return null},getQueryVariable:function(n,h){var q=(h.indexOf("?")>-1)?h.split("?")[1]:h;var vs=q.split("&"),i,l;for(i=0,l=vs.length;i<l;i++){var p=vs[i].split("=");if(p[0]===n){return p[1]}}return null},qualifyURL:function(url){var str=document.location.href.substring(0,document.location.href.lastIndexOf("/"));if(/^(\/|\.\/|(\.\.\/)+)/g.test(url)){var relativeTest=url.match(/\.\.\//g);if(CBWA_.util.isArray(relativeTest)){for(var x=0;x<relativeTest.length;x++){str=str.substring(0,str.lastIndexOf("/"))}}else{if(url.indexOf('./')===-1){str=location.protocol+'//'+location.hostname}}return str+"/"+url.replace(/^(\/|\.\/|(\.\.\/)+)/g,'')}return(url.indexOf('http')>-1)?url:location.protocol+'//'+url},parseAttributes:function(el,prefix){var key,attr=[],rv={},i,aLen=el.attributes.length;prefix=prefix+':'||null;for(i=0;i<aLen;i++){key=el.attributes[i];attr=key.name.split(prefix);if(CBWA_.util.isArray(attr)&&attr.length===2){rv[attr.pop()]=key.value}else{rv[attr]=key.value}}return rv},trim:function(str){if(!str){return''}var str=str.replace(/^\s\s*/,''),ws=/\s/,i=str.length;while(ws.test(str.charAt(--i)));return str.slice(0,i+1)},trimQuotes:function(str){return str.replace(/^["']?(.*?)["']?$/,function(str,group1){return group1})},serialize:function(obj){var key,ro=[],val;for(key in obj){val=encodeURIComponent(decodeURIComponent(obj[key]));ro.push(key+'='+val)}return ro.join('&')},isFunction:function(obj){return Object.prototype.toString.call(obj)==="[object Function]"},isArray:function(obj){return Object.prototype.toString.call(obj)==="[object Array]"},getElementsByClassName:function(oElm,strTagName,strClassName){strClassName=strClassName.replace(/\-/g,"\\-");var arrElements=(strTagName==="*"&&oElm.all)?oElm.all:oElm.getElementsByTagName(strTagName);return this.collectionToArray(arrElements,[],strClassName)},collectionToArray:function(col,arr,strClassName){var oRegExp=new RegExp("(^|\\s)"+strClassName+"(\\s|$)"),colLen=col.length,x;for(x=0;x<colLen;x++){if(strClassName){if(oRegExp.test(col[x].className)){arr.push(col[x])}}else{arr.push(col[x])}}return arr},loadResource:function(type,id,url,callback,location,content){var sbr,q=(url.indexOf('?')>-1)?'&':'?';switch(type){case'script':elType='text/javascript';break;case'css':elType='text/css';type='link';break}sbr=document.createElement(type);if(type==='link'){sbr.rel='stylesheet';sbr.href=url}if(type==='script'){sbr.async=true;sbr.defer=true;sbr.src=(callback)?url+q+'callback='+callback:url}sbr.id=id;sbr.type=elType;if(content){sbr.innerHTML=content}if(location){document.getElementsByTagName(location)[0].appendChild(sbr)}else{document.getElementsByTagName('head')[0].appendChild(sbr)}return sbr},S4:function(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1)},guid:function(){var d=new Date().valueOf();return(d+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4())},merge_options:function(obj1,obj2){var obj3={},attrname;for(attrname in obj1){if(obj1.hasOwnProperty(attrname)){obj3[attrname]=obj1[attrname]}}for(attrname in obj2){if(obj2.hasOwnProperty(attrname)){obj3[attrname]=obj2[attrname]}}return obj3},cleanString:function(s){if(!s||s==='undefined'){return''}var o='',arr=s.split(''),i,sl;for(i=0,sl=s.length;i<sl;i++){var n=s.charCodeAt(i);if(n===8217||n===8216){o+=""}else if(n===8220||n===8221){o+='"'}else{if(n<=255){o+=arr[i]}}}return o},quoteString:function(string){var _escapeable=/["\\\x00-\x1f\x7f-\x9f]/g,_meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'};if(string.match(_escapeable)){return'"'+string.replace(_escapeable,function(a){var c=_meta[a];if(typeof c==='string'){return c}c=a.charCodeAt();return'\\u00'+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"'}return'"'+string+'"'}}};CBWA_.init();