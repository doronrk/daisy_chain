define(["jquery","backbone","underscore","storeCollection","userLocation","logger","contextFramework","commonjs/collections/Stores"],function(e,r,t,o,a,i,n,s){var l,c;function u(r){var t={models:[]};e.each(r.models,function(){t.models.push({attributes:this.attributes})});return t}function f(e){return e}var d=function(t,o){var a=o||{};if(t===undefined||!(t.success&&t.failure)){i.log("Error in StoresFactory: callback cannot be undefined.");return}if(e.isEmptyObject(a)){t.failure.call(t.context,{error:"options parameter are required."},t.arg);return}if(!(o.lat&&o.lng||o.address||o.locationNumber)){i.log("Error in StoresFactory: location parameters are required ( {options.lat, options.lng} or options.address )");t.failure.call(t.context,{error:"location parameters are required."},t.arg);return}if(a.fromSDP){a.address=n.user.getPreferred()===""?n.geoIpLocation.getPostalCode():n.user.getPreferred()}if(!a.filters){a.filters={}}if(a.storeId){a.filters["storeId"]=Number(a.storeId)}if(a.excludeOutlets){a.excludeOutlets=true}if(a.bopsStore){if(a.bopsStore===true){a.filters["bopsEligible"]=1}else if(a.bopsStore===false){a.filters["bopsEligible"]=0}}if(a.lat&&a.lng&&(!a.address||a==="")){a.address="lat"+a.lat+"_lng"+a.lng}e.each(a.filters,function(e,r){if(!isNaN(r)){a.filters[e]=Number(r)}});var l=new r.View,c=new s;l.listenTo(c,c.ON_STORES_DATA,function(e){var r=f(e),o=n.user.getLocation(n.user.getPreferred());t.arg=t.arg||{};t.arg["location"]=o;r.useNewApproach=true;t.success.call(t.context,r,t.arg)});l.listenTo(c,c.GEOCODE_ERROR,function(e){t.failure.call(t.context,e,t.arg)});l.listenTo(c,c.ON_STORES_ERROR,function(e){t.failure.call(t.context,e,t.arg)});var u={searchTerm:a.address,lat:a.lat,lng:a.lng,filters:a.filters,excludeOutlets:a.excludeOutlets,doNotSetPreferred:a.doNotSetPreferred};if(a.radius){u.distance=a.radius}if(a.distance){u.distance=a.distance}c.handleSearchRequest(u)};var g=function(r,t){var a,i=o;a=new i([],t);if(!t.fromSDP&&(navigator.appVersion.indexOf("MSIE 9.")!==-1||navigator.appVersion.indexOf("MSIE 8.")!==-1)){e.extend(r,{dataType:"jsonp"})}a.fetch(r)};return{getStoreCollection:d}});