define(["jquery","logger","sideBySideImageZoomer","imageUtils","hbsCommonTemplates/util/ZoomRegionBox","hbsCommonTemplates/features/zoomer/Zoomer","mcomZoomer/PDPZoomViewer","mcomZoomer/PDPVideo","globals","pubsub"],function(e,t,o,i,a,n,r,m,s,l){var d,g,f=330,c=404,u=[],I,p=4,v="pdpMainImageChangeEvent",h={HOVER_ON:0,CLICK:1,HOVER_OFF:2},z=59,w=72,y="&fit=fit,1&$filtersm$",V="#videoDiv";function b(e){if(typeof e!=="undefined"){u=e}}function E(t,o,i){var a,n,r=new o.AlternateImages({altImageGridID:"altZoomerImages",altViewEvents:i});n=r.listToAlternateImagesList(t,z,w,y);r.pubSubEventName=v;r.pubSubEventTypes=h;a=e(".features-zoomer");r.verticalScrollList(a);r.loadScroller();a.prepend(e("#"+r.altImageGridContainerID));r.attachAltImageEvents();I=r}function L(t,r,m,l){var g,u,I=true,v="mainViewHolder_1",h="mainView_1";g={};if(e("#mainView_1").length<=0){I=false;g.containerID=v;g.mainImageID=h;g.mainImageURL=r;g.zoomAltText=typeof m!=="undefined"?m:""}g.zoomContainerID="zoomerContainer";g.zoomImageID=undefined;g.zoomImageURL=typeof l!=="undefined"?l:"";g.zoomerLargerButton="zoomerLargerButton";g.zoomerLargerButtonImage=s.getValue("props.assetsHost")+"/web20/assets/img/scene7/largerView.png";u=i.getElement(t);u.append(n(g));e("#"+g.containerID).css({width:f,height:c});e("#"+g.mainImageID).css({width:f,height:c});d=new o.SideBySideImageZoomer(v,h,g.zoomContainerID,{zoomHTML:a({zoomRegionBoxID:"zoomRegionBox"}),zoomRegionBoxDivisor:1/p,zoomFactor:p,heightWidthEqual:false,widthEqualsHeight:true,opacity:{opacity:.5,"-ms-filter":'"progid:DXImageTransform.Microsoft.Alpha" ( Opacity = 50 )'},zoomRegionBoxBorderAdjustment:2});d.defaultWidth=f;d.defaultHeight=c;if(I){g.containerID=v;g.mainImageID=h;g.mainImageURL=r;g.zoomAltText=typeof m!=="undefined"?m:""}return g}function S(t){var o,a,n,s,g,u=0,h=e("meta[itemprop='image']");if(!h.length){return}o=h.attr("content").replace("$filtersm$","$filterlrg$");a=L("zoomViewerWrapper",i.updateScene7ImageURL(o,f,c));e("#imageZoomer").append(i.getElement(a.zoomerLargerButton));d.zoomContainer.css({left:d.container.width()+d.container.position().left+"px"});d.zoomImage.css({"max-width":d.defaultWidth*p+"px","max-height":d.defaultHeight*p+"px"});s=i.updateScene7ImageURL(o,d.defaultWidth*p,d.defaultHeight*p).replace("filtersm","filterxlrg");d.setZoomImageSrc(s);d.zoomRegionBox.css({backgroundImage:"url"+d.image.attr("src")+")"});d.defaultMainImage=d.getImageSrc();d.lastType="image";if(typeof I!=="undefined"){d.container.css({left:e("#"+I.altImagesContainerID).width()+"px"});d.viewOffset=d.container.offset()}l.observe(v).subscribe(D);d.imageZoomer=t.imageZoomer;d.zoomViewer=new r({altImageModel:I,altImagesWidth:z,altImagesHeight:w,altImagesFilters:y,imageList:t.imageZoomer.imgList,swatchModifier:t.swatchModifier,zoomerContainer:d.container});d.video=new m(t.productId);e(document).on("click",e("#"+a.zoomerLargerButton),x);e(d.container).on("mouseenter touchstart",d.container,B);e(d.container).on("mouseleave touchend",d.container,T);e(d.container).on("mousemove",H);e(d.container).on("touchmove",A);e(window).on("resize",function(){d.viewOffset=d.container.offset()});e(document).on("unload",O);return d}function D(e){var t,o,i;t=e["imageSrc"];o=e["videoID"];i=e["selectedAltImg"];if(e.type===h.HOVER_ON){R(t,o)}else if(e.type===h.HOVER_OFF){C(o)}else if(e.type===h.CLICK){Z(t,o,i)}}function R(t,o){var a,n=o+"_v";if(d.lastType==="video"){if(n===d.lastVideo&&d.video.isPlaying(n)){return}e(V).removeClass("active");d.video.pause(d.lastVideo)}if(t){a=i.updateScene7ImageURL(t,d.defaultWidth,d.defaultHeight);d.setImageSrc(a)}else if(o){e(V).addClass("active")}}function C(t){if(t&&t!==d.lastVideo){e(V).removeClass("active")}if(d.lastType==="image"){d.setImageSrc(d.defaultMainImage)}else if(d.lastType==="video"){e(V).addClass("active")}}function Z(e,o,a){var n,r,m;d.imageZoomer.selectedAltImg=a;if(e){n=i.updateScene7ImageURL(e,d.defaultWidth,d.defaultHeight);d.setImageSrc(n);t.log(n+" "+d.defaultWidth+" - "+d.zoomFactor+" = "+d.defaultHeight);r=i.updateScene7ImageURL(n,d.defaultWidth*d.zoomFactor,d.defaultHeight*d.zoomFactor).replace("filtersm","filterxlrg");d.defaultMainImage=d.getImageSrc();d.setZoomImageSrc(r);d.zoomRegionBox.css({"background-image":"url("+n+")"});d.defaultZoomedImage=d.getZoomImageSrc();d.lastType="image";d.lastVideo=null}else if(o){d.lastVideo=o+"_v";d.lastType="video";if(!d.video.isPlaying(d.lastVideo)){d.video.play(d.lastVideo)}}}function x(e){if(!d.zoomViewer.isEnabled){return}var t=["mcomZoomer/PDPOverlayZoomer"];if(e.target.id==="zoomerLargerButton"){if(I){t.push("alternateImages")}require(t,function(e,t){if(typeof t!=="undefined"){e.setAlternateImages(t);e.setAltImagesList(I.originalImageList)}e.start(d.imageZoomer.selectedAltImg)})}}function B(e){if(!d.zoomViewer.isEnabled){return}d.startEvent();d.container.addClass("hovered")}function T(e){if(!d.zoomViewer.isEnabled){return}d.endEvent();d.container.removeClass("hovered")}function H(e){if(!d.zoomViewer.isEnabled){return}if(e.target.id===d.image.attr("id")||e.target.id===d.zoomRegionBox.attr("id")){d.processEvent(e)}}function A(e){if(!d.zoomViewer.isEnabled){return}e.preventDefault();if(event.target.id===d.image.attr("id")||event.target.id===d.zoomRegionBox.attr("id")){event.clientX=event.changedTouches[0].clientX;event.clientY=event.changedTouches[0].clientY;d.processEvent(event)}}function O(){e(d.container).off("mousemove",d.container);e(d.container).off("mouseenter",d.container);e(document).off("mouseleave",d.container);e(window).off("resize",d.container)}return{buildAlternateImageGrid:E,start:S,setAltImageList:b,pubSubEventName:v,pubSubEventTypes:h}});